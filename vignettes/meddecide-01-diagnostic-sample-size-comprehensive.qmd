---
title: "Diagnostic Test Sample Size Planning (Bujang 2023)"
subtitle: "Clopper-Pearson Precision-Based Approach"
author: "ClinicoPath Team"
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: false
    df-print: paged
bibliography: references.bib
---

## Overview

The Diagnostic Test Sample Size Calculator implements the precision-based sample size planning method described by Bujang [-@bujang2023elaboration]. This approach uses **Clopper-Pearson exact binomial confidence intervals** to determine the minimum sample size needed to achieve a specified level of precision (CI width) for sensitivity and specificity estimates.

### Why Precision-Based Planning?

Traditional power-based sample size calculations focus on detecting differences between groups. For diagnostic test accuracy studies, **precision-based planning** is more appropriate because:

1. **Direct clinical interpretation**: CI width directly reflects estimation uncertainty
2. **No comparison needed**: Single-sample diagnostic studies don't compare groups
3. **Better for planning**: Ensures sufficient precision regardless of statistical significance
4. **Transparent**: Target precision is easier to justify than arbitrary power levels

### When to Use This Module

Use this calculator when planning:

- Diagnostic test accuracy studies (single new test vs. gold standard)
- Screening test validation studies
- Biomarker discovery and validation
- Medical device diagnostic performance studies
- Clinical prediction rule validation

**Not appropriate for:**
- Comparing two diagnostic tests (use paired/unpaired comparison methods)
- ROC curve analysis with multiple thresholds (use ROC-based sample size methods)
- Agreement studies (use kappa sample size calculators)

---

## Key Concepts

### Study Purpose Types

#### 1. Diagnostic Purpose (High Sensitivity AND Specificity)

**Goal**: Replace or confirm gold standard diagnosis

**Requirements**:
- Both sensitivity ≥ 0.70 (preferably ≥ 0.80)
- Both specificity ≥ 0.70 (preferably ≥ 0.80)
- Sample size = **maximum** of sensitivity and specificity requirements

**Example**: Blood-based biomarker to diagnose colorectal cancer (replacing colonoscopy)

#### 2. Screening Purpose - Emphasize Sensitivity

**Goal**: Rule out disease (minimize false negatives)

**Requirements**:
- Sensitivity ≥ 0.70 (preferably ≥ 0.90)
- Specificity ≥ 0.50 (acceptable to sacrifice)
- Sample size = sensitivity requirement only

**Example**: COVID-19 rapid antigen test for population screening

#### 3. Screening Purpose - Emphasize Specificity

**Goal**: Rule in disease (minimize false positives)

**Requirements**:
- Specificity ≥ 0.70 (preferably ≥ 0.90)
- Sensitivity ≥ 0.50 (acceptable to sacrifice)
- Sample size = specificity requirement only

**Example**: Lung cancer CT screening (avoid unnecessary follow-up procedures)

### Factors Affecting Sample Size

| Factor | Effect on Sample Size | Recommendation |
|--------|----------------------|----------------|
| **Target Sens/Spec** | Lower targets → Larger N | Aim for ≥0.80 (good), ≥0.90 (excellent) |
| **Prevalence** | Low prev → Larger N for sensitivity | Use population-specific prevalence |
| | High prev → Larger N for specificity | |
| **CI Width** | Narrower width → Larger N | 0.10 (±5%) for diagnostic, 0.20 (±10%) for screening |
| **Non-response** | Expected dropout → Inflate N | Add 10-25% buffer |

### Clopper-Pearson Method

The **Clopper-Pearson exact binomial confidence interval** is based on cumulative probabilities of the binomial distribution, not normal approximation. This makes it:

- ✅ **Exact** for all sample sizes (no large-sample assumption)
- ✅ **Conservative** (coverage ≥ nominal level)
- ✅ **Appropriate** for extreme values (sensitivity/specificity near 0 or 1)

**Formula**:
For x successes in n trials, the exact 95% CI uses beta distribution quantiles:

- Lower limit: `qbeta(0.025, x, n - x + 1)`
- Upper limit: `qbeta(0.975, x + 1, n - x)`

Sample size is the minimum n such that CI width ≤ target width.

---

## Practical Examples

### Example 1: Colorectal Cancer Blood Test (Diagnostic Purpose)

**Scenario**: A new blood-based biomarker is being evaluated as a potential diagnostic test for colorectal cancer in high-risk patients (age >50, family history). We want to determine if it can replace colonoscopy.

**Study Parameters**:
- **Population**: High-risk patients referred for screening
- **Prevalence**: 10% (estimated from previous studies in high-risk population)
- **Target Accuracy**: Sensitivity 95%, Specificity 95% (need excellent performance to replace gold standard)
- **Desired Precision**: 95% CI width = 0.10 (±5% precision)
- **Non-response**: 20% (accounting for dropouts, inadequate samples)

**Calculation**:
1. Sample size for sensitivity: N = 940 (to get 940 × 0.10 = 94 diseased cases)
2. Sample size for specificity: N = 105 (to get 105 × 0.90 = 94 non-diseased cases)
3. **Required N = max(940, 105) = 940** (limited by sensitivity)
4. Adjusted for 20% non-response: N = ceiling(940 / 0.8) = **1,175 subjects**

**Interpretation**:
- Low prevalence (10%) drives large sample size for sensitivity estimation
- Need 940 total subjects to obtain sufficient diseased cases (n=94)
- Specificity estimation needs far fewer subjects (only 105) due to high prevalence of non-diseased

**Sample Size Statement** (from module output):

> This study aims to evaluate a diagnostic marker with high sensitivity AND specificity. Sample size calculation based on Clopper-Pearson exact binomial confidence intervals for sensitivity and specificity (Bujang, 2023). In the target population, the estimated disease prevalence is 10.0%. The target sensitivity is 95.0% and target specificity is 95.0%, with a desired 95% CI width of 0.10. Based on these specifications: For sensitivity estimation: 940 total subjects required (to obtain 94 diseased cases). For specificity estimation: 105 total subjects required (to obtain 95 non-diseased cases). Minimum required sample size: 940 subjects (limited by Sensitivity). Final sample size adjusted for 20% non-response: 1,175 subjects.

---

### Example 2: COVID-19 Rapid Antigen Test (Screening - Sensitivity Emphasis)

**Scenario**: A new rapid antigen test for COVID-19 is being developed for asymptomatic population screening. Sensitivity is critical to avoid missing cases; specificity can be sacrificed.

**Study Parameters**:
- **Population**: General population during outbreak (asymptomatic screening)
- **Prevalence**: 5% (community transmission rate)
- **Target Accuracy**: Sensitivity 95% (must catch cases), Specificity 50% (false positives acceptable)
- **Desired Precision**: 95% CI width = 0.10
- **Non-response**: 15%

**Calculation**:
1. Sample size for sensitivity: N = 1,880
2. Sample size for specificity: N = 424 (not limiting factor for screening)
3. **Required N = 1,880** (sensitivity drives sample size)
4. Adjusted for 15% non-response: N = ceiling(1880 / 0.85) = **2,212 subjects**

**Interpretation**:
- Very low prevalence (5%) requires large sample size to obtain diseased cases
- Screening purpose focuses on sensitivity only
- Specificity of 50% is acceptable because follow-up confirmatory testing is available

---

### Example 3: Diabetic Retinopathy AI Screening (Moderate Precision)

**Scenario**: An AI-based fundus photography analysis tool for diabetic retinopathy screening in diabetic patients.

**Study Parameters**:
- **Population**: Patients with type 2 diabetes
- **Prevalence**: 30% (typical DR prevalence in diabetic population)
- **Target Accuracy**: Sensitivity 90%, Specificity 90%
- **Desired Precision**: 95% CI width = 0.20 (moderate precision acceptable for screening)
- **Non-response**: 10%

**Calculation**:
1. Sample size for sensitivity: N = 147
2. Sample size for specificity: N = 116
3. **Required N = max(147, 116) = 147**
4. Adjusted for 10% non-response: N = ceiling(147 / 0.90) = **164 subjects**

**Interpretation**:
- Moderate prevalence (30%) balances sensitivity and specificity requirements
- Wider CI (0.20) reduces sample size significantly compared to narrow CI (0.10)
- Both sensitivity and specificity are well-balanced at moderate prevalence

---

### Example 4: Rare Disease Biomarker (Low Prevalence Challenge)

**Scenario**: Discovery of a novel biomarker for Fabry disease (a rare lysosomal storage disorder) in patients referred to genetics clinic.

**Study Parameters**:
- **Population**: Patients with suspected Fabry disease
- **Prevalence**: 2% (very rare, even in referred population)
- **Target Accuracy**: Sensitivity 90%, Specificity 90%
- **Desired Precision**: 95% CI width = 0.10
- **Non-response**: 25% (multi-center recruitment needed)

**Calculation**:
1. Sample size for sensitivity: N = **7,900** (need 7,900 × 0.02 = 158 diseased cases)
2. Sample size for specificity: N = 176
3. **Required N = max(7,900, 176) = 7,900** (limited by sensitivity due to low prevalence)
4. Adjusted for 25% non-response: N = ceiling(7900 / 0.75) = **10,534 subjects**

**Interpretation**:
- **Very low prevalence (2%) creates enormous sample size requirement**
- May require multi-center collaboration or case-control enrichment design
- Alternative approach: Enrich prevalence by testing only high-risk subgroups
- Demonstrates why rare disease studies are so challenging

---

## Using the Module

### Step-by-Step Guide

#### 1. Select Study Purpose

```
Study Design → Study Purpose:
- ☑ Diagnostic (high Sens AND Spec)
- ☐ Screening (emphasize Sensitivity)
- ☐ Screening (emphasize Specificity)
```

#### 2. Set Target Diagnostic Accuracy

```
Target Diagnostic Accuracy:
- Target Sensitivity: 0.90 (0.50-0.99)
- Target Specificity: 0.90 (0.50-0.99)
```

**Guidance**:
- 0.95 = Excellent accuracy
- 0.90 = Nearly excellent
- 0.80 = Good accuracy
- 0.70 = Fair accuracy (minimum for diagnostic)

#### 3. Specify Study Parameters

```
Study Parameters:
- Disease Prevalence: 0.10 (10%)
- Desired 95% CI Width: 0.10 (±5% precision)
- Significance Level (α): 0.05 (two-sided)
```

**Prevalence Considerations**:
- Use population-specific estimate, not general population
- Low prevalence → Larger N for sensitivity
- High prevalence → Larger N for specificity
- Prevalence 0.50 balances both requirements

#### 4. Add Non-Response Adjustment

```
Adjustments:
- Non-Response Rate (%): 20
```

**Recommendations**:
- Prospective studies: 10-15%
- Retrospective studies: 5-10%
- Multi-center studies: 20-25%
- Longitudinal studies: 25-30%

#### 5. Configure Display Options

```
Display Options:
- ☑ Generate Sample Size Statement (publication-ready)
- ☑ Show Methodology (detailed explanation)
- ☐ Show References (citations)

Comparison Table Options:
- ☐ Show Comparison Table
- Comparison Prevalences: "0.05, 0.10, 0.20, 0.30, 0.50"
```

---

## Interpreting Results

### Sample Size Calculation Results Table

| Parameter | Target Value | N (Cases/Controls) | Total N Required |
|-----------|--------------|-------------------|------------------|
| Sensitivity | 0.90 | 316 | 3,160 |
| Specificity | 0.90 | 316 | 352 |
| Required N (Sensitivity) | — | — | **3,160** |
| Adjusted for 20% Non-Response | — | — | **3,950** |

**Interpretation**:
- **Sensitivity estimation** requires 316 diseased cases
  - With 10% prevalence, need 316 / 0.10 = 3,160 total subjects
- **Specificity estimation** requires 316 non-diseased cases
  - With 90% non-diseased, need 316 / 0.90 = 352 total subjects
- **Final N = 3,160** (limited by sensitivity due to low prevalence)
- **Adjusted N = 3,950** (inflated for 20% dropout)

### Sample Size Justification Statement

The module generates a publication-ready statement that can be copied directly into your Methods section. It includes:

1. ✅ Study objective
2. ✅ Methodology (Clopper-Pearson exact binomial CI)
3. ✅ Parameters (prevalence, targets, CI width, alpha)
4. ✅ Sample size calculations (sensitivity and specificity)
5. ✅ Justification (which parameter limits sample size)
6. ✅ Non-response adjustment
7. ✅ Reference citation with DOI

### Prevalence Sensitivity Table

When enabled, this table shows how sample size changes across different prevalence values:

| Prevalence | N for Sensitivity | N for Specificity | Required N (Max) |
|------------|-------------------|-------------------|------------------|
| 0.05 | 6,320 | 352 | **6,320** |
| 0.10 | 3,160 | 352 | **3,160** |
| 0.20 | 1,580 | 447 | **1,580** |
| 0.30 | 1,053 | 575 | **1,053** |
| 0.50 | 632 | 1,005 | **1,005** |

**Key Insights**:
- At low prevalence (5%), sensitivity drives sample size (N=6,320)
- At high prevalence (50%), specificity drives sample size (N=1,005)
- Crossover point depends on target Sens/Spec values

---

## Validation Against Bujang 2023 Tables

The implementation has been validated against published values from Bujang (2023) Table 2.

### Validation Test Cases

```{r}
#| echo: true
#| eval: false

# Load validation data
data(bujang_table2_validation)

# Test Case 1: Low prevalence, high targets, narrow CI
test1 <- bujang_table2_validation[1, ]
# Prevalence: 5%, Sens/Spec: 95%, CI width: 0.10
# Expected N: 940 ✓

# Test Case 2: Moderate prevalence, moderate targets, wide CI
test5 <- bujang_table2_validation[5, ]
# Prevalence: 20%, Sens/Spec: 90%, CI width: 0.20
# Expected N: 220 ✓

# Test Case 3: High prevalence, high targets, wide CI
test8 <- bujang_table2_validation[8, ]
# Prevalence: 90%, Sens/Spec: 95%, CI width: 0.20
# Expected N: 941 ✓
```

All test cases match published values within rounding tolerance.

---

## Common Scenarios and Recommendations

### Scenario Selection Guide

| Clinical Context | Study Purpose | Sens Target | Spec Target | CI Width | Typical N |
|------------------|---------------|-------------|-------------|----------|-----------|
| **Diagnostic marker (replace gold standard)** | Diagnostic | ≥0.90 | ≥0.90 | 0.10 | 500-5,000 |
| **Population screening (rule out)** | Screening-Sens | ≥0.90 | ≥0.50 | 0.10 | 1,000-10,000 |
| **Confirmatory test (rule in)** | Screening-Spec | ≥0.50 | ≥0.90 | 0.10 | 500-5,000 |
| **AI/ML validation** | Diagnostic | ≥0.80 | ≥0.80 | 0.20 | 100-500 |
| **Point-of-care test** | Screening-Sens | ≥0.95 | ≥0.70 | 0.10 | 1,000-5,000 |
| **Rare disease biomarker** | Diagnostic | ≥0.90 | ≥0.90 | 0.10 | 5,000-20,000 |

### Prevalence Estimation Tips

**Do:**
- ✅ Use population-specific prevalence (not general population)
- ✅ Consider referral bias (referred populations have higher prevalence)
- ✅ Conduct pilot studies if prevalence uncertain
- ✅ Report prevalence source in Methods

**Don't:**
- ❌ Use general population prevalence for high-risk/referred populations
- ❌ Assume 50% prevalence without justification
- ❌ Ignore seasonal/geographic variations

**Example**:
- Colorectal cancer in general population: 0.5-1%
- Colorectal cancer in high-risk population (age >50, family history): 5-15%
- Colorectal cancer in patients with symptoms/positive FOBT: 30-50%

### CI Width Selection

| CI Width | Precision | Use Case |
|----------|-----------|----------|
| **0.05** | Very high (±2.5%) | Regulatory approval studies |
| **0.10** | High (±5%) | **Recommended for diagnostic** |
| **0.15** | Moderate (±7.5%) | Exploratory validation |
| **0.20** | Moderate-low (±10%) | **Recommended for screening** |

**Trade-off**: Narrower CI width → Higher precision → Larger sample size

---

## Comparison with Other Methods

### Precision-Based vs. Power-Based

| Aspect | Precision-Based (Bujang 2023) | Power-Based (Hypothesis Test) |
|--------|-------------------------------|-------------------------------|
| **Primary Goal** | Estimate sensitivity/specificity with precision | Detect difference from hypothesized value |
| **Input** | Target value + CI width | Null hypothesis + alternative + power |
| **Output** | Minimum N for specified precision | Minimum N for specified power |
| **Interpretation** | Direct (CI width = uncertainty) | Indirect (power = probability of rejecting H0) |
| **Clinical Relevance** | High (precision matters for decisions) | Lower (significance testing less relevant) |
| **Recommended For** | Diagnostic accuracy studies | Comparative studies |

### Alternative Sample Size Methods

1. **Buderer (1996)** - Prevalence-adjusted method (similar results to Bujang)
2. **Obuchowski & McClish (1997)** - ROC-based (for multiple thresholds)
3. **Flahault et al. (2005)** - Case-control designs
4. **Dendukuri et al. (2004)** - Bayesian (when no gold standard)
5. **Hajian-Tilaki (2014)** - Comprehensive review of methods

**Bujang 2023 advantages**:
- ✅ Exact Clopper-Pearson CI (not normal approximation)
- ✅ Comprehensive tables for quick lookup
- ✅ Clear guidance for diagnostic vs. screening
- ✅ Explicit prevalence stratification

---

## Frequently Asked Questions

### Q1: Can I use this for comparing two diagnostic tests?

**No.** This module is for **one-sample** sensitivity/specificity estimation (new test vs. gold standard). For comparing two diagnostic tests, use:
- Paired design: McNemar's test sample size
- Unpaired design: Two-proportion comparison

### Q2: What if I don't know the prevalence?

**Options**:
1. Conduct pilot study to estimate prevalence
2. Use published estimates from similar populations
3. Use range of values and report sensitivity analysis
4. Consider case-control enrichment design

**Important**: Prevalence has major impact on sample size, especially for low-prevalence diseases.

### Q3: Why is my sample size so large?

**Common reasons**:
1. **Low prevalence** (most common cause)
2. **High target sensitivity/specificity** (>0.90)
3. **Narrow CI width** (<0.10)
4. **Combination of above factors**

**Solutions**:
- Enrich prevalence (recruit high-risk population)
- Accept wider CI width (0.20 instead of 0.10)
- Lower targets to realistic levels (0.80 instead of 0.95)
- Use case-control design

### Q4: Should I adjust for non-response?

**Yes, always.** Dropout/non-response is inevitable. Recommendations:
- Prospective studies: 10-20%
- Multi-center studies: 20-30%
- Longitudinal studies: 25-35%

### Q5: What about clustering or matching?

This module assumes **simple random sampling**. For clustered/matched designs, apply design effect (DEFF) correction:

```
N_adjusted = N_simple × DEFF
```

Where DEFF = 1 + (cluster_size - 1) × ICC

### Q6: Can I use this for multi-class diagnosis (>2 classes)?

**No.** This is for binary diagnosis (disease/no disease). For multi-class, use:
- One-vs-all approach (multiple binary tests)
- Multi-class ROC methods
- Specialized multi-class sample size formulas

---

## Example Data

The module includes two datasets for practice:

### 1. diagnostic_sample_size_examples

Six clinical scenarios demonstrating diverse applications:

```{r}
#| echo: true
#| eval: false

data(diagnostic_sample_size_examples)

# View scenarios
print(diagnostic_sample_size_examples[, c("scenario", "prevalence",
                                          "target_sensitivity", "target_specificity",
                                          "final_n", "final_n_adjusted")])

# Colorectal cancer example
colorectal <- diagnostic_sample_size_examples[1, ]
# N = 940, adjusted for 20% non-response = 1,175
```

### 2. bujang_table2_validation

Validation benchmark data from Bujang (2023) Table 2:

```{r}
#| echo: true
#| eval: false

data(bujang_table2_validation)

# Test case: Prevalence 10%, Sens/Spec 95%, CI width 0.10
test <- bujang_table2_validation[3, ]
# Expected N = 940 (matches published value)
```

---

## References

::: {#refs}
:::

### Key Citations

- **Bujang MA (2023)**. An Elaboration on Sample Size Planning for Performing a One-Sample Sensitivity and Specificity Analysis by Basing on Calculations on a Specified 95% Confidence Interval Width. *Diagnostics* 13(8):1390. [doi:10.3390/diagnostics13081390](https://doi.org/10.3390/diagnostics13081390)

- **Clopper CJ, Pearson ES (1934)**. The use of confidence or fiducial limits illustrated in the case of the Binomial. *Biometrika* 26(4):404-413.

- **Buderer NM (1996)**. Statistical Methodology: I. Incorporating the prevalence of disease into the sample size calculation for sensitivity and specificity. *Academic Emergency Medicine* 3(9):895-900.

---

## Advanced Topics

### Optimal Prevalence for Balanced Design

When is sensitivity and specificity estimation balanced?

For equal targets (Sens = Spec = p), the crossover prevalence is:

```
prevalence_optimal = p
```

**Example**: If targeting Sens = Spec = 0.90, optimal prevalence is 0.90 (90%).

### Non-Response Patterns

Different non-response patterns affect sample size:
- **Random missing**: Simple inflation adequate
- **Differential by disease status**: May bias sensitivity/specificity estimates
- **Informative missing**: Requires sensitivity analysis

### Adaptive Designs

Consider sequential/adaptive designs for rare diseases:
- Interim analysis at 50% enrollment
- Re-estimate prevalence if significantly different
- Adjust remaining sample size accordingly

---

## Conclusion

The Diagnostic Test Sample Size Calculator provides a rigorous, transparent method for planning diagnostic accuracy studies based on Clopper-Pearson exact binomial confidence intervals. Key takeaways:

1. ✅ **Precision-based planning** is appropriate for diagnostic accuracy studies
2. ✅ **Prevalence has major impact** on sample size, especially for sensitivity
3. ✅ **Differentiate diagnostic vs. screening** purposes for realistic targets
4. ✅ **Use population-specific prevalence**, not general population estimates
5. ✅ **Always adjust for non-response** (10-30% depending on design)
6. ✅ **Publication-ready statements** facilitate Methods section writing

For questions or feedback on this module, please contact the ClinicoPath development team.

---

**Module Version**: ClinicoPath v0.0.32.11+
**Last Updated**: `r Sys.Date()`
**License**: GPL-3
