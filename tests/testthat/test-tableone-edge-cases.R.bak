# ═══════════════════════════════════════════════════════════
# Edge Cases and Error Handling Tests: tableone
# ═══════════════════════════════════════════════════════════
#
# These tests verify that tableone correctly handles:
# 1. Missing data patterns (MCAR, MAR, MNAR)
# 2. Small sample sizes
# 3. Constant variables
# 4. Variables with special characters
# 5. Extreme values and outliers
# 6. Empty datasets
# 7. All-missing variables
#
# Generated: 2026-01-02

library(testthat)
library(ClinicoPath)

# Load test data
data(tableone_test, package = "ClinicoPath")

# ═══════════════════════════════════════════════════════════
# Test 1: Missing Data Patterns
# ═══════════════════════════════════════════════════════════

test_that("tableone handles variables with missing data (MCAR)", {
  # Hemoglobin and WBC have ~3% MCAR missing data
  result <- tableone(
    data = tableone_test,
    vars = c("Age", "Hemoglobin", "WBC"),
    excl = FALSE  # Keep missing values
  )

  expect_no_error(result)
  expect_s3_class(result, "tableoneClass")
})

test_that("tableone handles variables with MAR missing data", {
  # Ki67 and CA199 have higher missingness in advanced stages (MAR)
  result <- tableone(
    data = tableone_test,
    vars = c("TumorStage", "Ki67", "CA199"),
    excl = FALSE
  )

  expect_no_error(result)
  expect_s3_class(result, "tableoneClass")
})

test_that("tableone handles high proportion of missing data", {
  # Create variable with high missingness
  test_data <- tableone_test
  test_data$HighMissing <- tableone_test$Age
  test_data$HighMissing[1:75] <- NA  # 50% missing

  result <- tableone(
    data = test_data,
    vars = c("Age", "HighMissing"),
    excl = FALSE
  )

  expect_no_error(result)
})

test_that("tableone handles complete case exclusion with missing data", {
  # Use excl=TRUE to exclude rows with any missing
  result <- tableone(
    data = tableone_test,
    vars = c("Age", "Sex", "Hemoglobin", "Ki67", "CA199"),
    excl = TRUE
  )

  # Should complete but may reduce sample size significantly
  expect_no_error(result)
  expect_s3_class(result, "tableoneClass")
})

test_that("tableone handles all-missing variable", {
  # Create variable that is completely missing
  test_data <- tableone_test
  test_data$AllNA <- NA

  # Should handle gracefully (error or warning)
  expect_condition(
    tableone(
      data = test_data,
      vars = c("Age", "AllNA"),
      excl = FALSE
    )
  )
})

# ═══════════════════════════════════════════════════════════
# Test 2: Small Sample Sizes
# ═══════════════════════════════════════════════════════════

test_that("tableone handles very small datasets (n=10)", {
  small_data <- tableone_test[1:10, ]

  result <- tableone(
    data = small_data,
    vars = c("Age", "Sex", "TumorStage")
  )

  expect_no_error(result)
  expect_s3_class(result, "tableoneClass")
})

test_that("tableone handles minimal dataset (n=5)", {
  minimal_data <- tableone_test[1:5, ]

  result <- tableone(
    data = minimal_data,
    vars = c("Age", "Sex")
  )

  # Should complete but may warn about small sample
  expect_s3_class(result, "tableoneClass")
})

test_that("tableone handles single row dataset", {
  single_row <- tableone_test[1, ]

  # May error or handle gracefully
  expect_condition(
    tableone(
      data = single_row,
      vars = c("Age", "Sex", "TumorStage")
    )
  )
})

test_that("tableone handles empty dataset after exclusions", {
  # Create data where all rows will be excluded
  test_data <- tableone_test[1:10, ]
  test_data$Hemoglobin <- NA  # All missing

  # With excl=TRUE, all rows will be removed
  expect_condition(
    tableone(
      data = test_data,
      vars = c("Age", "Hemoglobin"),
      excl = TRUE
    )
  )
})

# ═══════════════════════════════════════════════════════════
# Test 3: Constant Variables
# ═══════════════════════════════════════════════════════════

test_that("tableone handles constant numeric variable", {
  test_data <- tableone_test
  test_data$ConstantNum <- 42  # All same value

  result <- tableone(
    data = test_data,
    vars = c("Age", "ConstantNum")
  )

  # Should complete (may show zero variance)
  expect_no_error(result)
})

test_that("tableone handles constant categorical variable", {
  test_data <- tableone_test
  test_data$ConstantCat <- "Single Level"

  result <- tableone(
    data = test_data,
    vars = c("Sex", "ConstantCat")
  )

  # Should complete but show 100% in one category
  expect_no_error(result)
})

test_that("tableone handles near-constant variable", {
  test_data <- tableone_test
  test_data$NearConstant <- "A"
  test_data$NearConstant[1] <- "B"  # 149 A's, 1 B

  result <- tableone(
    data = test_data,
    vars = c("Sex", "NearConstant")
  )

  expect_no_error(result)
})

# ═══════════════════════════════════════════════════════════
# Test 4: Variables with Special Characters
# ═══════════════════════════════════════════════════════════

test_that("tableone handles variable names with spaces", {
  test_data <- tableone_test
  names(test_data)[names(test_data) == "Age"] <- "Patient Age"
  names(test_data)[names(test_data) == "Sex"] <- "Patient Sex"

  result <- tableone(
    data = test_data,
    vars = c("Patient Age", "Patient Sex", "TumorStage")
  )

  expect_no_error(result)
})

test_that("tableone handles variable names with special characters", {
  test_data <- tableone_test
  names(test_data)[names(test_data) == "Ki67"] <- "Ki-67 (%)"
  names(test_data)[names(test_data) == "CA199"] <- "CA19-9"

  result <- tableone(
    data = test_data,
    vars = c("Age", "Ki-67 (%)", "CA19-9")
  )

  expect_no_error(result)
})

# ═══════════════════════════════════════════════════════════
# Test 5: Extreme Values and Outliers
# ═══════════════════════════════════════════════════════════

test_that("tableone handles extreme values in continuous variables", {
  test_data <- tableone_test
  test_data$Age[1] <- 999  # Extreme outlier
  test_data$TumorSize[2] <- 100  # Very large tumor

  result <- tableone(
    data = test_data,
    vars = c("Age", "TumorSize")
  )

  expect_no_error(result)
})

test_that("tableone handles negative values where unexpected", {
  test_data <- tableone_test
  test_data$Hemoglobin[1:5] <- -1  # Invalid negative hemoglobin

  result <- tableone(
    data = test_data,
    vars = c("Hemoglobin", "WBC")
  )

  # Should process (may not validate clinical plausibility)
  expect_no_error(result)
})

test_that("tableone handles zero values", {
  test_data <- tableone_test
  test_data$WBC[1:10] <- 0  # Zero WBC

  result <- tableone(
    data = test_data,
    vars = c("WBC", "Hemoglobin")
  )

  expect_no_error(result)
})

test_that("tableone handles very large values (log-normal)", {
  test_data <- tableone_test
  test_data$CA199[1] <- 1e6  # Very high CA19-9

  result <- tableone(
    data = test_data,
    vars = c("CA199", "Ki67")
  )

  expect_no_error(result)
})

# ═══════════════════════════════════════════════════════════
# Test 6: Data Type Issues
# ═══════════════════════════════════════════════════════════

test_that("tableone handles character that should be numeric", {
  test_data <- tableone_test
  test_data$Age <- as.character(test_data$Age)

  # May auto-convert or error
  expect_condition(
    tableone(
      data = test_data,
      vars = c("Age", "Sex")
    )
  )
})

test_that("tableone handles factor vs character differences", {
  test_data1 <- tableone_test
  test_data1$Sex <- as.character(test_data1$Sex)

  test_data2 <- tableone_test
  test_data2$Sex <- as.factor(test_data2$Sex)

  # Both should work
  result1 <- tableone(data = test_data1, vars = c("Sex", "Age"))
  result2 <- tableone(data = test_data2, vars = c("Sex", "Age"))

  expect_no_error(result1)
  expect_no_error(result2)
})

test_that("tableone handles ordered vs unordered factors", {
  test_data1 <- tableone_test
  test_data1$TumorStage <- factor(test_data1$TumorStage, ordered = FALSE)

  result1 <- tableone(data = test_data1, vars = c("TumorStage", "Grade"))

  test_data2 <- tableone_test  # Grade is ordered
  result2 <- tableone(data = test_data2, vars = c("TumorStage", "Grade"))

  expect_no_error(result1)
  expect_no_error(result2)
})

# ═══════════════════════════════════════════════════════════
# Test 7: Categorical Variables with Many Levels
# ═══════════════════════════════════════════════════════════

test_that("tableone handles categorical variable with many levels", {
  test_data <- tableone_test
  # Create variable with many categories
  test_data$ManyLevels <- sample(LETTERS[1:20], nrow(test_data), replace = TRUE)

  result <- tableone(
    data = test_data,
    vars = c("ManyLevels", "Age")
  )

  # Should complete but table may be long
  expect_no_error(result)
})

test_that("tableone handles categorical with rare levels", {
  test_data <- tableone_test
  test_data$RareLevels <- "Common"
  test_data$RareLevels[1:2] <- "Rare1"  # Only 2 cases
  test_data$RareLevels[3] <- "Rare2"    # Only 1 case

  result <- tableone(
    data = test_data,
    vars = c("RareLevels", "Sex")
  )

  expect_no_error(result)
})

# ═══════════════════════════════════════════════════════════
# Test 8: Boundary Conditions
# ═══════════════════════════════════════════════════════════

test_that("tableone handles all continuous variables", {
  result <- tableone(
    data = tableone_test,
    vars = c("Age", "TumorSize", "Hemoglobin", "WBC", "Ki67", "CA199", "FollowUpMonths")
  )

  expect_no_error(result)
})

test_that("tableone handles all categorical variables", {
  result <- tableone(
    data = tableone_test,
    vars = c("Sex", "LymphNodes", "LVI", "PNI", "PreinvasiveComponent",
             "TumorType", "Treatment", "Response", "VitalStatus")
  )

  expect_no_error(result)
})

test_that("tableone handles all ordinal variables", {
  result <- tableone(
    data = tableone_test,
    vars = c("TumorStage", "Grade")
  )

  expect_no_error(result)
})

# ═══════════════════════════════════════════════════════════
# Test 9: Data Quality Edge Cases
# ═══════════════════════════════════════════════════════════

test_that("tableone handles duplicate patient IDs", {
  test_data <- tableone_test
  test_data$PatientID[1:10] <- "PT001"  # Duplicate IDs

  # PatientID is just data, should process normally
  result <- tableone(
    data = test_data,
    vars = c("Age", "Sex", "TumorStage")
  )

  expect_no_error(result)
})

test_that("tableone handles Inf values", {
  test_data <- tableone_test
  test_data$CA199[1] <- Inf
  test_data$CA199[2] <- -Inf

  # May error or handle gracefully
  expect_condition(
    tableone(
      data = test_data,
      vars = c("CA199", "Ki67")
    )
  )
})

test_that("tableone handles NaN values", {
  test_data <- tableone_test
  test_data$Hemoglobin[1:3] <- NaN

  # Should treat like NA or error
  expect_condition(
    tableone(
      data = test_data,
      vars = c("Hemoglobin", "WBC")
    )
  )
})

# ═══════════════════════════════════════════════════════════
# Test 10: Realistic Clinical Edge Cases
# ═══════════════════════════════════════════════════════════

test_that("tableone handles dataset with only one sex", {
  test_data <- tableone_test
  test_data$Sex <- "Male"  # All male

  result <- tableone(
    data = test_data,
    vars = c("Age", "Sex", "TumorStage")
  )

  # Should show 100% male
  expect_no_error(result)
})

test_that("tableone handles all same tumor stage", {
  test_data <- tableone_test
  test_data$TumorStage <- factor("IV", levels = c("I", "II", "III", "IV"), ordered = TRUE)

  result <- tableone(
    data = test_data,
    vars = c("TumorStage", "Age")
  )

  expect_no_error(result)
})

test_that("tableone handles extreme age distribution", {
  test_data <- tableone_test
  test_data$Age <- sample(c(20, 95), nrow(test_data), replace = TRUE)  # Bimodal extremes

  result <- tableone(
    data = test_data,
    vars = c("Age", "Sex")
  )

  expect_no_error(result)
})

test_that("tableone handles missing data in all variables", {
  test_data <- tableone_test[1:20, ]
  # Add missing to all variables
  test_data$Age[1:5] <- NA
  test_data$Sex[6:10] <- NA
  test_data$TumorStage[11:15] <- NA

  result <- tableone(
    data = test_data,
    vars = c("Age", "Sex", "TumorStage"),
    excl = FALSE
  )

  expect_no_error(result)
})

# ═══════════════════════════════════════════════════════════
# Test 11: Style-Specific Edge Cases
# ═══════════════════════════════════════════════════════════

test_that("janitor style handles continuous variables gracefully", {
  # janitor (t4) is designed for categorical but may receive continuous
  expect_condition(
    tableone(
      data = tableone_test,
      vars = c("Age", "TumorSize"),  # Continuous vars
      sty = "t4"  # Janitor style
    )
  )
})

test_that("all styles handle single variable", {
  for (style in c("t1", "t2", "t3", "t4")) {
    result <- tableone(
      data = tableone_test,
      vars = "Sex",  # Single categorical variable
      sty = style
    )
    expect_no_error(result)
  }
})

test_that("all styles handle data with no complete cases", {
  test_data <- tableone_test[1:10, ]
  test_data$Age[1:5] <- NA
  test_data$Sex[6:10] <- NA  # No complete cases

  for (style in c("t1", "t2", "t3")) {
    expect_condition(
      tableone(
        data = test_data,
        vars = c("Age", "Sex"),
        sty = style,
        excl = TRUE  # Will exclude all rows
      )
    )
  }
})
