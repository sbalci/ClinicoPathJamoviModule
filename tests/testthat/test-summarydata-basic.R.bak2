# ═══════════════════════════════════════════════════════════
# Basic Functionality Tests: summarydata
# ═══════════════════════════════════════════════════════════
#
# Tests basic execution, required arguments, and expected outputs
# for the summarydata jamovi function
#
# Generated: 2026-01-04

library(testthat)
library(ClinicoPath)

# Load test data
data(summarydata_test, package = "ClinicoPath", envir = environment())

# ═══════════════════════════════════════════════════════════
# Test 1: Function Exists and Runs
# ═══════════════════════════════════════════════════════════

test_that("summarydata function exists and runs", {
  # Basic execution test with minimal arguments
  result <- summarydata(
    data = summarydata_test,
    vars = "age"
  )

  # Should return an R6 class object
  expect_true(inherits(result, "R6"))
  expect_true(inherits(result, "summarydataClass"))
  expect_true("results" %in% names(result))
})

# ═══════════════════════════════════════════════════════════
# Test 2: Required Arguments
# ═══════════════════════════════════════════════════════════

test_that("summarydata handles required arguments correctly", {
  # Test with minimal required arguments (just vars)
  result <- summarydata(
    data = summarydata_test,
    vars = c("age", "hemoglobin")
  )

  expect_true(inherits(result, "summarydataClass"))
  expect_no_error(result)
})

test_that("summarydata requires variables to be specified", {
  # Running with no variables should still work but show welcome message
  result <- summarydata(
    data = summarydata_test,
    vars = NULL
  )

  # Should not error, just return empty results
  expect_true(inherits(result, "summarydataClass"))
})

# ═══════════════════════════════════════════════════════════
# Test 3: Expected Outputs
# ═══════════════════════════════════════════════════════════

test_that("summarydata produces expected output structure", {
  result <- summarydata(
    data = summarydata_test,
    vars = c("age", "hemoglobin", "psa")
  )

  # Check that results object exists
  expect_true(!is.null(result$results))

  # Check for expected output elements
  expect_true(!is.null(result$results$text))
  expect_true(!is.null(result$results$text1))
})

test_that("summarydata text output contains statistics", {
  result <- summarydata(
    data = summarydata_test,
    vars = "age"
  )

  # Get the text content
  text_content <- result$results$text$state

  # Should contain descriptive statistics
  expect_true(inherits(text_content, "character") || !is.null(text_content))
})

# ═══════════════════════════════════════════════════════════
# Test 4: Multiple Variables
# ═══════════════════════════════════════════════════════════

test_that("summarydata handles multiple variables", {
  # Test with several variables
  result <- summarydata(
    data = summarydata_test,
    vars = c("age", "hemoglobin", "psa", "tumor_size", "ki67_index")
  )

  expect_no_error(result)
  expect_true(inherits(result, "summarydataClass"))
})

test_that("summarydata handles single variable", {
  # Test with just one variable
  result <- summarydata(
    data = summarydata_test,
    vars = "age"
  )

  expect_no_error(result)
  expect_true(inherits(result, "summarydataClass"))
})

# ═══════════════════════════════════════════════════════════
# Test 5: Different Data Types
# ═══════════════════════════════════════════════════════════

test_that("summarydata works with normal distribution variables", {
  # Test with normally distributed variables
  result <- summarydata(
    data = summarydata_test,
    vars = c("age", "hemoglobin", "temperature")
  )

  expect_no_error(result)
})

test_that("summarydata works with skewed distribution variables", {
  # Test with right-skewed variables
  result <- summarydata(
    data = summarydata_test,
    vars = c("psa", "ca125", "wbc")
  )

  expect_no_error(result)
})

test_that("summarydata works with bounded variables", {
  # Test with bounded variables (0-100 or 0-10 scales)
  result <- summarydata(
    data = summarydata_test,
    vars = c("ki67_index", "pain_score", "qol_score")
  )

  expect_no_error(result)
})

# ═══════════════════════════════════════════════════════════
# Test 6: Data with Missing Values
# ═══════════════════════════════════════════════════════════

test_that("summarydata handles variables with missing data", {
  # PSA and CA125 have ~8-10% missing data
  result <- summarydata(
    data = summarydata_test,
    vars = c("psa", "ca125", "ki67_index")
  )

  # Should complete without error
  expect_no_error(result)
  expect_true(inherits(result, "summarydataClass"))
})

# ═══════════════════════════════════════════════════════════
# Test 7: Basic Option Settings
# ═══════════════════════════════════════════════════════════

test_that("summarydata respects decimal_places option", {
  # Test with different decimal places
  result_2dp <- summarydata(
    data = summarydata_test,
    vars = "age",
    decimal_places = 2
  )

  result_4dp <- summarydata(
    data = summarydata_test,
    vars = "age",
    decimal_places = 4
  )

  expect_no_error(result_2dp)
  expect_no_error(result_4dp)
})

test_that("summarydata runs without distribution diagnostics by default", {
  # Default should be distr = FALSE
  result <- summarydata(
    data = summarydata_test,
    vars = "age",
    distr = FALSE
  )

  expect_no_error(result)
})

test_that("summarydata runs without outlier detection by default", {
  # Default should be outliers = FALSE
  result <- summarydata(
    data = summarydata_test,
    vars = "psa",
    outliers = FALSE
  )

  expect_no_error(result)
})

# ═══════════════════════════════════════════════════════════
# Test 8: Data Loading from Different Formats
# ═══════════════════════════════════════════════════════════

test_that("summarydata works with data from CSV", {
  # Load from CSV
  csv_data <- read.csv("../../data/summarydata_test.csv")

  result <- summarydata(
    data = csv_data,
    vars = c("age", "hemoglobin")
  )

  expect_no_error(result)
})

test_that("summarydata works with data from RDA", {
  # Already loaded as summarydata_test
  result <- summarydata(
    data = summarydata_test,
    vars = c("age", "psa")
  )

  expect_no_error(result)
})

# ═══════════════════════════════════════════════════════════
# Test 9: Empty Results Handling
# ═══════════════════════════════════════════════════════════

test_that("summarydata handles empty variable list gracefully", {
  # Empty vars should show welcome message, not error
  result <- summarydata(
    data = summarydata_test,
    vars = character(0)
  )

  expect_true(inherits(result, "summarydataClass"))
})

# ═══════════════════════════════════════════════════════════
# Test 10: Standard Clinical Use Cases
# ═══════════════════════════════════════════════════════════

test_that("summarydata handles typical clinical lab panel", {
  # Typical clinical chemistry panel
  result <- summarydata(
    data = summarydata_test,
    vars = c("hemoglobin", "wbc", "platelets", "creatinine", "albumin")
  )

  expect_no_error(result)
  expect_true(inherits(result, "summarydataClass"))
})

test_that("summarydata handles tumor biomarker panel", {
  # Pathology/oncology biomarkers
  result <- summarydata(
    data = summarydata_test,
    vars = c("psa", "ca125", "ki67_index", "tumor_size", "mitotic_count")
  )

  expect_no_error(result)
  expect_true(inherits(result, "summarydataClass"))
})

test_that("summarydata handles patient-reported outcomes", {
  # Patient-reported outcome measures
  result <- summarydata(
    data = summarydata_test,
    vars = c("pain_score", "qol_score", "fatigue_score")
  )

  expect_no_error(result)
  expect_true(inherits(result, "summarydataClass"))
})

# ═══════════════════════════════════════════════════════════
# End of Basic Tests
# ═══════════════════════════════════════════════════════════
