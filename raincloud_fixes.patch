# Raincloud Function Fixes - Apply with care
# This patch file contains all Notice system implementations

# ============================================
# FIX 1: Add .createNotice helper method
# Location: After line 64 in R/raincloud.b.R
# ============================================

        .createNotice = function(name, type, message, position = 1) {
            # Helper method for consistent Notice creation
            notice <- jmvcore::Notice$new(
                options = self$options,
                name = name,
                type = type
            )
            notice$setContent(message)
            self$results$insert(position, notice)
            return(invisible(NULL))
        },

# ============================================
# FIX 2: Replace missing variables check
# Location: Lines 68-97 in R/raincloud.b.R
# REMOVE old code, ADD this
# ============================================

            # Check if required variables have been selected
            if (is.null(self$options$dep_var) || is.null(self$options$group_var)) {
                private$.createNotice(
                    name = 'missingVariables',
                    type = jmvcore::NoticeType$ERROR,
                    message = 'Dependent variable and grouping variable are required. Please select both variables to generate the raincloud plot.',
                    position = 1
                )

                # Keep welcome HTML for first-time users (shortened)
                intro_msg <- "
                <div style='background-color: #e3f2fd; padding: 12px; border-radius: 8px;'>
                <h4 style='color: #1976d2; margin-top: 0;'>☁️ Raincloud Plot</h4>
                <p>Select <strong>Dependent Variable</strong> (continuous) and <strong>Grouping Variable</strong> (categorical) to begin.</p>
                </div>"
                self$results$todo$setContent(intro_msg)
                return()
            } else {
                self$results$todo$setContent("")
            }

# ============================================
# FIX 3: Empty dataset error
# Location: Lines 100-102 in R/raincloud.b.R
# ============================================

            # Validate dataset
            if (nrow(self$data) == 0) {
                private$.createNotice(
                    name = 'emptyDataset',
                    type = jmvcore::NoticeType$ERROR,
                    message = 'Dataset contains no rows. Please load data before running analysis.',
                    position = 1
                )
                return()
            }

# ============================================
# FIX 4: Missing ggdist package
# Location: Lines 105-114 in R/raincloud.b.R
# ============================================

            # Safely require ggdist
            if (!requireNamespace("ggdist", quietly = TRUE)) {
                private$.createNotice(
                    name = 'missingPackage',
                    type = jmvcore::NoticeType$ERROR,
                    message = 'Required package "ggdist" is not installed. Install using: install.packages("ggdist")',
                    position = 1
                )
                return()
            }

# ============================================
# FIX 5: No complete cases
# Location: Lines 135-137 in R/raincloud.b.R
# ============================================

            if (nrow(analysis_data) == 0) {
                private$.createNotice(
                    name = 'noCompleteCases',
                    type = jmvcore::NoticeType$ERROR,
                    message = sprintf('No complete cases found for selected variables. Dataset has %d rows but all contain missing values in at least one selected variable.', nrow(self$data)),
                    position = 1
                )
                return()
            }

# ============================================
# FIX 6: Group imbalance warning
# Location: ADD after line 153 in R/raincloud.b.R
# ============================================

            # Add group imbalance warning
            if (max_group / min_group > 5) {
                private$.createNotice(
                    name = 'groupImbalance',
                    type = jmvcore::NoticeType$STRONG_WARNING,
                    message = sprintf('Highly unbalanced groups detected (largest:smallest ratio = %.1f:1). Statistical comparisons may be unreliable; consider using robust methods or stratified sampling.', max_group / min_group),
                    position = 1
                )
            }

# ============================================
# FIX 7: Small sample warning
# Location: ADD after line 169 in R/raincloud.b.R
# ============================================

            # Add small sample warning
            if (min_group < 10) {
                private$.createNotice(
                    name = 'smallSample',
                    type = jmvcore::NoticeType$STRONG_WARNING,
                    message = sprintf('Small sample size detected: smallest group has %d observations. Inferential tests (normality, comparisons) may be unreliable; interpret with caution.', min_group),
                    position = 2
                )
            }

# ============================================
# FIX 8: Analysis complete info
# Location: ADD after line 205 in R/raincloud.b.R
# ============================================

            # Success notice at bottom
            private$.createNotice(
                name = 'analysisComplete',
                type = jmvcore::NoticeType$INFO,
                message = sprintf('Raincloud plot analysis completed successfully using %d complete observations across %d groups.', nrow(analysis_data), length(levels(analysis_data[[group_var]]))),
                position = 999
            )

# ============================================
# FIX 9: NA handling in tests
# Location: ADD after lines 678-679 in R/raincloud.b.R
# ============================================

                group1_data <- data[data[[group_var]] == group_levels[1], dep_var]
                group1_data <- group1_data[!is.na(group1_data)]
                group2_data <- data[data[[group_var]] == group_levels[2], dep_var]
                group2_data <- group2_data[!is.na(group2_data)]

                if (length(group1_data) < 2 || length(group2_data) < 2) {
                    return("<div style='color:#d9534f'>Insufficient data for comparison.</div>")
                }

# ============================================
# FIX 10: Auto-selection warning
# Location: ADD after line 713 in R/raincloud.b.R
# ============================================

            # Warn about auto-selection
            if (comparison_method == "auto") {
                smallest_n <- min(sapply(levels(data[[group_var]]), function(g) sum(data[[group_var]] == g)))
                private$.createNotice(
                    name = 'autoTestSelection',
                    type = jmvcore::NoticeType$WARNING,
                    message = sprintf('Auto-selection chose %s based on Shapiro-Wilk tests. Note: low power with small samples (smallest n=%d), over-sensitive with large samples. Consider manual test selection.', test_method, smallest_n),
                    position = 3
                )
            }
