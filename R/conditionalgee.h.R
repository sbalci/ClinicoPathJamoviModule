
# This file is automatically generated, you probably don't want to edit this

conditionalgeeOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "conditionalgeeOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            subjectID = NULL,
            gap_time = NULL,
            event = NULL,
            event_number = NULL,
            covariates = NULL,
            time_varying_covariates = NULL,
            baseline_covariates = NULL,
            distribution_family = "weibull",
            correlation_structure = "exchangeable",
            link_function = "log",
            conditioning_set = "previous_gap",
            confidence_level = 0.95,
            max_iterations = 200,
            tolerance = 0.000001,
            robust_se = TRUE,
            include_diagnostics = TRUE,
            include_predictions = TRUE,
            plotGapTimes = TRUE,
            plotCorrelation = TRUE,
            plotResiduals = FALSE,
            plotPredictions = FALSE,
            showEducation = TRUE,
            showInterpretation = TRUE,
            exportResults = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="conditionalgee",
                requiresData=TRUE,
                ...)

            private$..subjectID <- jmvcore::OptionVariable$new(
                "subjectID",
                subjectID,
                suggested=list(
                    "id"),
                permitted=list(
                    "factor",
                    "id"))
            private$..gap_time <- jmvcore::OptionVariable$new(
                "gap_time",
                gap_time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event <- jmvcore::OptionVariable$new(
                "event",
                event,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..event_number <- jmvcore::OptionVariable$new(
                "event_number",
                event_number,
                suggested=list(
                    "continuous",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..time_varying_covariates <- jmvcore::OptionVariables$new(
                "time_varying_covariates",
                time_varying_covariates,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..baseline_covariates <- jmvcore::OptionVariables$new(
                "baseline_covariates",
                baseline_covariates,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..distribution_family <- jmvcore::OptionList$new(
                "distribution_family",
                distribution_family,
                options=list(
                    "exponential",
                    "weibull",
                    "gamma",
                    "lognormal"),
                default="weibull")
            private$..correlation_structure <- jmvcore::OptionList$new(
                "correlation_structure",
                correlation_structure,
                options=list(
                    "exchangeable",
                    "ar1",
                    "unstructured",
                    "independence"),
                default="exchangeable")
            private$..link_function <- jmvcore::OptionList$new(
                "link_function",
                link_function,
                options=list(
                    "log",
                    "identity",
                    "sqrt"),
                default="log")
            private$..conditioning_set <- jmvcore::OptionList$new(
                "conditioning_set",
                conditioning_set,
                options=list(
                    "previous_gap",
                    "cumulative_history",
                    "event_order",
                    "custom"),
                default="previous_gap")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..max_iterations <- jmvcore::OptionInteger$new(
                "max_iterations",
                max_iterations,
                min=50,
                max=1000,
                default=200)
            private$..tolerance <- jmvcore::OptionNumber$new(
                "tolerance",
                tolerance,
                min=1e-8,
                max=0.001,
                default=0.000001)
            private$..robust_se <- jmvcore::OptionBool$new(
                "robust_se",
                robust_se,
                default=TRUE)
            private$..include_diagnostics <- jmvcore::OptionBool$new(
                "include_diagnostics",
                include_diagnostics,
                default=TRUE)
            private$..include_predictions <- jmvcore::OptionBool$new(
                "include_predictions",
                include_predictions,
                default=TRUE)
            private$..plotGapTimes <- jmvcore::OptionBool$new(
                "plotGapTimes",
                plotGapTimes,
                default=TRUE)
            private$..plotCorrelation <- jmvcore::OptionBool$new(
                "plotCorrelation",
                plotCorrelation,
                default=TRUE)
            private$..plotResiduals <- jmvcore::OptionBool$new(
                "plotResiduals",
                plotResiduals,
                default=FALSE)
            private$..plotPredictions <- jmvcore::OptionBool$new(
                "plotPredictions",
                plotPredictions,
                default=FALSE)
            private$..showEducation <- jmvcore::OptionBool$new(
                "showEducation",
                showEducation,
                default=TRUE)
            private$..showInterpretation <- jmvcore::OptionBool$new(
                "showInterpretation",
                showInterpretation,
                default=TRUE)
            private$..exportResults <- jmvcore::OptionBool$new(
                "exportResults",
                exportResults,
                default=FALSE)

            self$.addOption(private$..subjectID)
            self$.addOption(private$..gap_time)
            self$.addOption(private$..event)
            self$.addOption(private$..event_number)
            self$.addOption(private$..covariates)
            self$.addOption(private$..time_varying_covariates)
            self$.addOption(private$..baseline_covariates)
            self$.addOption(private$..distribution_family)
            self$.addOption(private$..correlation_structure)
            self$.addOption(private$..link_function)
            self$.addOption(private$..conditioning_set)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..max_iterations)
            self$.addOption(private$..tolerance)
            self$.addOption(private$..robust_se)
            self$.addOption(private$..include_diagnostics)
            self$.addOption(private$..include_predictions)
            self$.addOption(private$..plotGapTimes)
            self$.addOption(private$..plotCorrelation)
            self$.addOption(private$..plotResiduals)
            self$.addOption(private$..plotPredictions)
            self$.addOption(private$..showEducation)
            self$.addOption(private$..showInterpretation)
            self$.addOption(private$..exportResults)
        }),
    active = list(
        subjectID = function() private$..subjectID$value,
        gap_time = function() private$..gap_time$value,
        event = function() private$..event$value,
        event_number = function() private$..event_number$value,
        covariates = function() private$..covariates$value,
        time_varying_covariates = function() private$..time_varying_covariates$value,
        baseline_covariates = function() private$..baseline_covariates$value,
        distribution_family = function() private$..distribution_family$value,
        correlation_structure = function() private$..correlation_structure$value,
        link_function = function() private$..link_function$value,
        conditioning_set = function() private$..conditioning_set$value,
        confidence_level = function() private$..confidence_level$value,
        max_iterations = function() private$..max_iterations$value,
        tolerance = function() private$..tolerance$value,
        robust_se = function() private$..robust_se$value,
        include_diagnostics = function() private$..include_diagnostics$value,
        include_predictions = function() private$..include_predictions$value,
        plotGapTimes = function() private$..plotGapTimes$value,
        plotCorrelation = function() private$..plotCorrelation$value,
        plotResiduals = function() private$..plotResiduals$value,
        plotPredictions = function() private$..plotPredictions$value,
        showEducation = function() private$..showEducation$value,
        showInterpretation = function() private$..showInterpretation$value,
        exportResults = function() private$..exportResults$value),
    private = list(
        ..subjectID = NA,
        ..gap_time = NA,
        ..event = NA,
        ..event_number = NA,
        ..covariates = NA,
        ..time_varying_covariates = NA,
        ..baseline_covariates = NA,
        ..distribution_family = NA,
        ..correlation_structure = NA,
        ..link_function = NA,
        ..conditioning_set = NA,
        ..confidence_level = NA,
        ..max_iterations = NA,
        ..tolerance = NA,
        ..robust_se = NA,
        ..include_diagnostics = NA,
        ..include_predictions = NA,
        ..plotGapTimes = NA,
        ..plotCorrelation = NA,
        ..plotResiduals = NA,
        ..plotPredictions = NA,
        ..showEducation = NA,
        ..showInterpretation = NA,
        ..exportResults = NA)
)

conditionalgeeResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "conditionalgeeResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        modelfit = function() private$.items[["modelfit"]],
        coefficients = function() private$.items[["coefficients"]],
        correlationStructure = function() private$.items[["correlationStructure"]],
        modelDiagnostics = function() private$.items[["modelDiagnostics"]],
        gapTimePredictions = function() private$.items[["gapTimePredictions"]],
        educationalContent = function() private$.items[["educationalContent"]],
        interpretationContent = function() private$.items[["interpretationContent"]],
        gapTimesPlot = function() private$.items[["gapTimesPlot"]],
        correlationPlot = function() private$.items[["correlationPlot"]],
        residualsPlot = function() private$.items[["residualsPlot"]],
        predictionsPlot = function() private$.items[["predictionsPlot"]],
        exportTable = function() private$.items[["exportTable"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Conditional GEE for Recurrent Events Gap Times",
                refs=list(
                    "geepack",
                    "survival",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis Summary",
                clearWith=list(
                    "subjectID",
                    "gap_time",
                    "event",
                    "event_number")))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelfit",
                title="Conditional GEE Model Fit",
                rows=1,
                columns=list(
                    list(
                        `name`="distribution", 
                        `title`="Distribution", 
                        `type`="text"),
                    list(
                        `name`="correlation", 
                        `title`="Correlation Structure", 
                        `type`="text"),
                    list(
                        `name`="conditioning", 
                        `title`="Conditioning Set", 
                        `type`="text"),
                    list(
                        `name`="observations", 
                        `title`="Observations", 
                        `type`="integer"),
                    list(
                        `name`="clusters", 
                        `title`="Clusters", 
                        `type`="integer"),
                    list(
                        `name`="max_events", 
                        `title`="Max Events", 
                        `type`="integer"),
                    list(
                        `name`="link", 
                        `title`="Link Function", 
                        `type`="text")),
                clearWith=list(
                    "subjectID",
                    "gap_time",
                    "event",
                    "distribution_family",
                    "correlation_structure",
                    "conditioning_set")))
            self$add(jmvcore::Table$new(
                options=options,
                name="coefficients",
                title="Model Coefficients",
                columns=list(
                    list(
                        `name`="covariate", 
                        `title`="Covariate", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="wald", 
                        `title`="Wald", 
                        `type`="number"),
                    list(
                        `name`="p", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper", 
                        `title`="Upper CI", 
                        `type`="number")),
                clearWith=list(
                    "covariates",
                    "time_varying_covariates",
                    "baseline_covariates",
                    "confidence_level")))
            self$add(jmvcore::Table$new(
                options=options,
                name="correlationStructure",
                title="Correlation Parameters",
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text")),
                clearWith=list(
                    "correlation_structure",
                    "confidence_level")))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelDiagnostics",
                title="Model Diagnostics",
                visible="(include_diagnostics)",
                rows=4,
                columns=list(
                    list(
                        `name`="diagnostic", 
                        `title`="Diagnostic Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="p", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text")),
                clearWith=list(
                    "include_diagnostics",
                    "distribution_family",
                    "correlation_structure")))
            self$add(jmvcore::Table$new(
                options=options,
                name="gapTimePredictions",
                title="Gap Time Predictions",
                visible="(include_predictions)",
                columns=list(
                    list(
                        `name`="subject", 
                        `title`="Subject ID", 
                        `type`="text"),
                    list(
                        `name`="observed_mean", 
                        `title`="Observed Mean", 
                        `type`="number"),
                    list(
                        `name`="predicted_next", 
                        `title`="Predicted Next", 
                        `type`="number"),
                    list(
                        `name`="residual", 
                        `title`="Residual", 
                        `type`="number"),
                    list(
                        `name`="risk_category", 
                        `title`="Risk Category", 
                        `type`="text")),
                clearWith=list(
                    "include_predictions",
                    "subjectID",
                    "gap_time",
                    "event_number")))
            self$add(jmvcore::Html$new(
                options=options,
                name="educationalContent",
                title="Educational Overview",
                visible="(showEducation)",
                clearWith=list(
                    "distribution_family",
                    "correlation_structure",
                    "conditioning_set")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretationContent",
                title="Results Interpretation",
                visible="(showInterpretation)",
                clearWith=list(
                    "subjectID",
                    "gap_time",
                    "event")))
            self$add(jmvcore::Image$new(
                options=options,
                name="gapTimesPlot",
                title="Gap Time Patterns",
                width=800,
                height=600,
                renderFun=".gapTimePatternsPlot",
                visible="(plotGapTimes)",
                requiresData=TRUE,
                clearWith=list(
                    "subjectID",
                    "gap_time",
                    "event_number")))
            self$add(jmvcore::Image$new(
                options=options,
                name="correlationPlot",
                title="Correlation Structure",
                width=700,
                height=500,
                renderFun=".correlationPlot",
                visible="(plotCorrelation)",
                requiresData=TRUE,
                clearWith=list(
                    "correlation_structure",
                    "subjectID")))
            self$add(jmvcore::Image$new(
                options=options,
                name="residualsPlot",
                title="Model Residuals",
                width=800,
                height=600,
                renderFun=".residualsPlot",
                visible="(plotResiduals)",
                requiresData=TRUE,
                clearWith=list(
                    "include_diagnostics",
                    "subjectID",
                    "gap_time")))
            self$add(jmvcore::Image$new(
                options=options,
                name="predictionsPlot",
                title="Gap Time Predictions vs Observed",
                width=700,
                height=500,
                renderFun=".predictionsPlot",
                visible="(plotPredictions)",
                requiresData=TRUE,
                clearWith=list(
                    "include_predictions",
                    "subjectID",
                    "gap_time")))
            self$add(jmvcore::Table$new(
                options=options,
                name="exportTable",
                title="Exported Results",
                visible="(exportResults)",
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Model Component", 
                        `type`="text"),
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"),
                    list(
                        `name`="interpretation", 
                        `title`="Clinical Interpretation", 
                        `type`="text")),
                clearWith=list(
                    "exportResults")))}))

conditionalgeeBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "conditionalgeeBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "conditionalgee",
                version = c(0,0,1),
                options = options,
                results = conditionalgeeResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Conditional GEE for Recurrent Events Gap Times
#'
#' Conditional Generalized Estimating Equations for analyzing gap times 
#' between recurrent  events. This analysis models the time between 
#' consecutive event occurrences conditional  on previous event history, 
#' accounting for within-subject correlation and providing  robust 
#' population-average estimates of covariate effects on inter-event times.
#'
#' @examples
#' data('histopathology', package='ClinicoPath')
#'
#' @param data .
#' @param subjectID .
#' @param gap_time .
#' @param event .
#' @param event_number .
#' @param covariates .
#' @param time_varying_covariates .
#' @param baseline_covariates .
#' @param distribution_family .
#' @param correlation_structure .
#' @param link_function .
#' @param conditioning_set .
#' @param confidence_level .
#' @param max_iterations .
#' @param tolerance .
#' @param robust_se .
#' @param include_diagnostics .
#' @param include_predictions .
#' @param plotGapTimes .
#' @param plotCorrelation .
#' @param plotResiduals .
#' @param plotPredictions .
#' @param showEducation .
#' @param showInterpretation .
#' @param exportResults .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelfit} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$coefficients} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$correlationStructure} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelDiagnostics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$gapTimePredictions} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$educationalContent} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$interpretationContent} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$gapTimesPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$correlationPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$residualsPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$predictionsPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$exportTable} \tab \tab \tab \tab \tab a table \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelfit$asDF}
#'
#' \code{as.data.frame(results$modelfit)}
#'
#' @export
conditionalgee <- function(
    data,
    subjectID,
    gap_time,
    event,
    event_number,
    covariates,
    time_varying_covariates,
    baseline_covariates,
    distribution_family = "weibull",
    correlation_structure = "exchangeable",
    link_function = "log",
    conditioning_set = "previous_gap",
    confidence_level = 0.95,
    max_iterations = 200,
    tolerance = 0.000001,
    robust_se = TRUE,
    include_diagnostics = TRUE,
    include_predictions = TRUE,
    plotGapTimes = TRUE,
    plotCorrelation = TRUE,
    plotResiduals = FALSE,
    plotPredictions = FALSE,
    showEducation = TRUE,
    showInterpretation = TRUE,
    exportResults = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("conditionalgee requires jmvcore to be installed (restart may be required)")

    if ( ! missing(subjectID)) subjectID <- jmvcore::resolveQuo(jmvcore::enquo(subjectID))
    if ( ! missing(gap_time)) gap_time <- jmvcore::resolveQuo(jmvcore::enquo(gap_time))
    if ( ! missing(event)) event <- jmvcore::resolveQuo(jmvcore::enquo(event))
    if ( ! missing(event_number)) event_number <- jmvcore::resolveQuo(jmvcore::enquo(event_number))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(time_varying_covariates)) time_varying_covariates <- jmvcore::resolveQuo(jmvcore::enquo(time_varying_covariates))
    if ( ! missing(baseline_covariates)) baseline_covariates <- jmvcore::resolveQuo(jmvcore::enquo(baseline_covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(subjectID), subjectID, NULL),
            `if`( ! missing(gap_time), gap_time, NULL),
            `if`( ! missing(event), event, NULL),
            `if`( ! missing(event_number), event_number, NULL),
            `if`( ! missing(covariates), covariates, NULL),
            `if`( ! missing(time_varying_covariates), time_varying_covariates, NULL),
            `if`( ! missing(baseline_covariates), baseline_covariates, NULL))

    for (v in event) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- conditionalgeeOptions$new(
        subjectID = subjectID,
        gap_time = gap_time,
        event = event,
        event_number = event_number,
        covariates = covariates,
        time_varying_covariates = time_varying_covariates,
        baseline_covariates = baseline_covariates,
        distribution_family = distribution_family,
        correlation_structure = correlation_structure,
        link_function = link_function,
        conditioning_set = conditioning_set,
        confidence_level = confidence_level,
        max_iterations = max_iterations,
        tolerance = tolerance,
        robust_se = robust_se,
        include_diagnostics = include_diagnostics,
        include_predictions = include_predictions,
        plotGapTimes = plotGapTimes,
        plotCorrelation = plotCorrelation,
        plotResiduals = plotResiduals,
        plotPredictions = plotPredictions,
        showEducation = showEducation,
        showInterpretation = showInterpretation,
        exportResults = exportResults)

    analysis <- conditionalgeeClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

