
# This file is automatically generated, you probably don't want to edit this

referenceintervalsOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "referenceintervalsOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            measurement = NULL,
            age = NULL,
            gender = NULL,
            ethnicity = NULL,
            additional_factors = NULL,
            ri_method = "robust_nonparametric",
            confidence_level = 0.95,
            reference_percentiles = "2.5,97.5",
            minimum_sample_size = 120,
            outlier_detection = "horn",
            transformation_test = TRUE,
            partitioning_analysis = TRUE,
            age_partitioning = "none",
            age_breakpoints = "18,65",
            harris_boyd_test = TRUE,
            verification_study = FALSE,
            transferability_assessment = FALSE,
            uncertainty_estimation = TRUE,
            clinical_interpretation = TRUE,
            quality_assessment = TRUE,
            literature_comparison = FALSE,
            distribution_plots = TRUE,
            partitioning_plots = TRUE,
            age_trend_plots = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="referenceintervals",
                requiresData=TRUE,
                ...)

            private$..measurement <- jmvcore::OptionVariable$new(
                "measurement",
                measurement,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..age <- jmvcore::OptionVariable$new(
                "age",
                age,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..gender <- jmvcore::OptionVariable$new(
                "gender",
                gender,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..ethnicity <- jmvcore::OptionVariable$new(
                "ethnicity",
                ethnicity,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..additional_factors <- jmvcore::OptionVariables$new(
                "additional_factors",
                additional_factors,
                suggested=list(
                    "nominal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..ri_method <- jmvcore::OptionList$new(
                "ri_method",
                ri_method,
                options=list(
                    "parametric",
                    "nonparametric",
                    "robust_nonparametric",
                    "bootstrap",
                    "box_cox",
                    "log_normal"),
                default="robust_nonparametric")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.9,
                max=0.99,
                default=0.95)
            private$..reference_percentiles <- jmvcore::OptionString$new(
                "reference_percentiles",
                reference_percentiles,
                default="2.5,97.5")
            private$..minimum_sample_size <- jmvcore::OptionInteger$new(
                "minimum_sample_size",
                minimum_sample_size,
                min=120,
                max=1000,
                default=120)
            private$..outlier_detection <- jmvcore::OptionList$new(
                "outlier_detection",
                outlier_detection,
                options=list(
                    "none",
                    "dixon",
                    "grubbs",
                    "tukey",
                    "horn",
                    "robust"),
                default="horn")
            private$..transformation_test <- jmvcore::OptionBool$new(
                "transformation_test",
                transformation_test,
                default=TRUE)
            private$..partitioning_analysis <- jmvcore::OptionBool$new(
                "partitioning_analysis",
                partitioning_analysis,
                default=TRUE)
            private$..age_partitioning <- jmvcore::OptionList$new(
                "age_partitioning",
                age_partitioning,
                options=list(
                    "none",
                    "pediatric_adult",
                    "decades",
                    "custom_groups",
                    "continuous_modeling"),
                default="none")
            private$..age_breakpoints <- jmvcore::OptionString$new(
                "age_breakpoints",
                age_breakpoints,
                default="18,65")
            private$..harris_boyd_test <- jmvcore::OptionBool$new(
                "harris_boyd_test",
                harris_boyd_test,
                default=TRUE)
            private$..verification_study <- jmvcore::OptionBool$new(
                "verification_study",
                verification_study,
                default=FALSE)
            private$..transferability_assessment <- jmvcore::OptionBool$new(
                "transferability_assessment",
                transferability_assessment,
                default=FALSE)
            private$..uncertainty_estimation <- jmvcore::OptionBool$new(
                "uncertainty_estimation",
                uncertainty_estimation,
                default=TRUE)
            private$..clinical_interpretation <- jmvcore::OptionBool$new(
                "clinical_interpretation",
                clinical_interpretation,
                default=TRUE)
            private$..quality_assessment <- jmvcore::OptionBool$new(
                "quality_assessment",
                quality_assessment,
                default=TRUE)
            private$..literature_comparison <- jmvcore::OptionBool$new(
                "literature_comparison",
                literature_comparison,
                default=FALSE)
            private$..distribution_plots <- jmvcore::OptionBool$new(
                "distribution_plots",
                distribution_plots,
                default=TRUE)
            private$..partitioning_plots <- jmvcore::OptionBool$new(
                "partitioning_plots",
                partitioning_plots,
                default=TRUE)
            private$..age_trend_plots <- jmvcore::OptionBool$new(
                "age_trend_plots",
                age_trend_plots,
                default=TRUE)

            self$.addOption(private$..measurement)
            self$.addOption(private$..age)
            self$.addOption(private$..gender)
            self$.addOption(private$..ethnicity)
            self$.addOption(private$..additional_factors)
            self$.addOption(private$..ri_method)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..reference_percentiles)
            self$.addOption(private$..minimum_sample_size)
            self$.addOption(private$..outlier_detection)
            self$.addOption(private$..transformation_test)
            self$.addOption(private$..partitioning_analysis)
            self$.addOption(private$..age_partitioning)
            self$.addOption(private$..age_breakpoints)
            self$.addOption(private$..harris_boyd_test)
            self$.addOption(private$..verification_study)
            self$.addOption(private$..transferability_assessment)
            self$.addOption(private$..uncertainty_estimation)
            self$.addOption(private$..clinical_interpretation)
            self$.addOption(private$..quality_assessment)
            self$.addOption(private$..literature_comparison)
            self$.addOption(private$..distribution_plots)
            self$.addOption(private$..partitioning_plots)
            self$.addOption(private$..age_trend_plots)
        }),
    active = list(
        measurement = function() private$..measurement$value,
        age = function() private$..age$value,
        gender = function() private$..gender$value,
        ethnicity = function() private$..ethnicity$value,
        additional_factors = function() private$..additional_factors$value,
        ri_method = function() private$..ri_method$value,
        confidence_level = function() private$..confidence_level$value,
        reference_percentiles = function() private$..reference_percentiles$value,
        minimum_sample_size = function() private$..minimum_sample_size$value,
        outlier_detection = function() private$..outlier_detection$value,
        transformation_test = function() private$..transformation_test$value,
        partitioning_analysis = function() private$..partitioning_analysis$value,
        age_partitioning = function() private$..age_partitioning$value,
        age_breakpoints = function() private$..age_breakpoints$value,
        harris_boyd_test = function() private$..harris_boyd_test$value,
        verification_study = function() private$..verification_study$value,
        transferability_assessment = function() private$..transferability_assessment$value,
        uncertainty_estimation = function() private$..uncertainty_estimation$value,
        clinical_interpretation = function() private$..clinical_interpretation$value,
        quality_assessment = function() private$..quality_assessment$value,
        literature_comparison = function() private$..literature_comparison$value,
        distribution_plots = function() private$..distribution_plots$value,
        partitioning_plots = function() private$..partitioning_plots$value,
        age_trend_plots = function() private$..age_trend_plots$value),
    private = list(
        ..measurement = NA,
        ..age = NA,
        ..gender = NA,
        ..ethnicity = NA,
        ..additional_factors = NA,
        ..ri_method = NA,
        ..confidence_level = NA,
        ..reference_percentiles = NA,
        ..minimum_sample_size = NA,
        ..outlier_detection = NA,
        ..transformation_test = NA,
        ..partitioning_analysis = NA,
        ..age_partitioning = NA,
        ..age_breakpoints = NA,
        ..harris_boyd_test = NA,
        ..verification_study = NA,
        ..transferability_assessment = NA,
        ..uncertainty_estimation = NA,
        ..clinical_interpretation = NA,
        ..quality_assessment = NA,
        ..literature_comparison = NA,
        ..distribution_plots = NA,
        ..partitioning_plots = NA,
        ..age_trend_plots = NA)
)

referenceintervalsResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "referenceintervalsResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        summary = function() private$.items[["summary"]],
        riResults = function() private$.items[["riResults"]],
        normalityTest = function() private$.items[["normalityTest"]],
        referencePaths = function() private$.items[["referencePaths"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Reference Interval Establishment",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Analysis Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="summary",
                title="Data Summary",
                rows=1,
                clearWith=list(
                    "measurement"),
                columns=list(
                    list(
                        `name`="characteristic", 
                        `title`="Characteristic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="riResults",
                title="Reference Interval Results",
                rows=1,
                clearWith=list(
                    "measurement",
                    "ri_method",
                    "confidence_level",
                    "reference_percentiles"),
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="lower_limit", 
                        `title`="Lower Limit", 
                        `type`="number"),
                    list(
                        `name`="upper_limit", 
                        `title`="Upper Limit", 
                        `type`="number"),
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="normalityTest",
                title="Normality Assessment",
                visible="(transformation_test)",
                rows=1,
                clearWith=list(
                    "measurement"),
                columns=list(
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto:pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="referencePaths",
                title="References",
                visible=TRUE))}))

referenceintervalsBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "referenceintervalsBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "referenceintervals",
                version = c(1,0,0),
                options = options,
                results = referenceintervalsResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Reference Interval Establishment
#'
#' Robust statistical methods for establishing clinical reference intervals 
#' following CLSI EP28-A3c guidelines. Supports parametric and non-parametric 
#' approaches, robust methods for outlier handling, and partitioning analysis 
#' for demographic factors. Essential for laboratory standardization and 
#' clinical interpretation of test results.
#' 
#'
#' @examples
#' data \%>\%
#' referenceintervals(
#'     measurement = "laboratory_value",
#'     age = "patient_age",
#'     gender = "patient_gender",
#'     method = "robust_nonparametric"
#' )
#'
#' @param data the data as a data frame
#' @param measurement Laboratory test measurement values from reference
#'   population
#' @param age Age of reference subjects for age-specific intervals
#' @param gender Gender for sex-specific reference intervals
#' @param ethnicity Ethnicity for population-specific intervals
#' @param additional_factors Additional variables for partitioning analysis
#' @param ri_method Statistical method for calculating reference intervals
#' @param confidence_level Confidence level for reference interval limits
#' @param reference_percentiles Lower and upper percentiles for reference
#'   interval
#' @param minimum_sample_size Minimum required sample size (CLSI recommends
#'   â‰¥120)
#' @param outlier_detection Method for identifying and handling outliers
#' @param transformation_test Test normality and suggest appropriate
#'   transformations
#' @param partitioning_analysis Analyze need for demographic partitioning
#' @param age_partitioning Method for age-related partitioning
#' @param age_breakpoints Comma-separated age breakpoints for custom grouping
#' @param harris_boyd_test Apply Harris-Boyd test for need to partition
#' @param verification_study Perform verification with independent samples
#' @param transferability_assessment Assess transferability to different
#'   populations
#' @param uncertainty_estimation Estimate uncertainty of reference interval
#'   limits
#' @param clinical_interpretation Provide clinical interpretation guidelines
#' @param quality_assessment Assess quality of reference interval
#'   establishment
#' @param literature_comparison Compare with published reference intervals
#' @param distribution_plots Generate distribution and normality plots
#' @param partitioning_plots Create partitioning visualization plots
#' @param age_trend_plots Generate age-related trend visualizations
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$riResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$normalityTest} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$referencePaths} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summary$asDF}
#'
#' \code{as.data.frame(results$summary)}
#'
#' @export
referenceintervals <- function(
    data,
    measurement,
    age,
    gender,
    ethnicity,
    additional_factors,
    ri_method = "robust_nonparametric",
    confidence_level = 0.95,
    reference_percentiles = "2.5,97.5",
    minimum_sample_size = 120,
    outlier_detection = "horn",
    transformation_test = TRUE,
    partitioning_analysis = TRUE,
    age_partitioning = "none",
    age_breakpoints = "18,65",
    harris_boyd_test = TRUE,
    verification_study = FALSE,
    transferability_assessment = FALSE,
    uncertainty_estimation = TRUE,
    clinical_interpretation = TRUE,
    quality_assessment = TRUE,
    literature_comparison = FALSE,
    distribution_plots = TRUE,
    partitioning_plots = TRUE,
    age_trend_plots = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("referenceintervals requires jmvcore to be installed (restart may be required)")

    if ( ! missing(measurement)) measurement <- jmvcore::resolveQuo(jmvcore::enquo(measurement))
    if ( ! missing(age)) age <- jmvcore::resolveQuo(jmvcore::enquo(age))
    if ( ! missing(gender)) gender <- jmvcore::resolveQuo(jmvcore::enquo(gender))
    if ( ! missing(ethnicity)) ethnicity <- jmvcore::resolveQuo(jmvcore::enquo(ethnicity))
    if ( ! missing(additional_factors)) additional_factors <- jmvcore::resolveQuo(jmvcore::enquo(additional_factors))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(measurement), measurement, NULL),
            `if`( ! missing(age), age, NULL),
            `if`( ! missing(gender), gender, NULL),
            `if`( ! missing(ethnicity), ethnicity, NULL),
            `if`( ! missing(additional_factors), additional_factors, NULL))

    for (v in gender) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in ethnicity) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- referenceintervalsOptions$new(
        measurement = measurement,
        age = age,
        gender = gender,
        ethnicity = ethnicity,
        additional_factors = additional_factors,
        ri_method = ri_method,
        confidence_level = confidence_level,
        reference_percentiles = reference_percentiles,
        minimum_sample_size = minimum_sample_size,
        outlier_detection = outlier_detection,
        transformation_test = transformation_test,
        partitioning_analysis = partitioning_analysis,
        age_partitioning = age_partitioning,
        age_breakpoints = age_breakpoints,
        harris_boyd_test = harris_boyd_test,
        verification_study = verification_study,
        transferability_assessment = transferability_assessment,
        uncertainty_estimation = uncertainty_estimation,
        clinical_interpretation = clinical_interpretation,
        quality_assessment = quality_assessment,
        literature_comparison = literature_comparison,
        distribution_plots = distribution_plots,
        partitioning_plots = partitioning_plots,
        age_trend_plots = age_trend_plots)

    analysis <- referenceintervalsClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

