
# This file is automatically generated, you probably don't want to edit this

clinicaltrialdesignOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinicaltrialdesignOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            trial_type = "superiority",
            outcome_type = "continuous",
            test_type = "two_sample_ttest",
            calculation_type = "sample_size",
            alpha = 0.05,
            power = 0.8,
            sample_size = 100,
            effect_size = 0.5,
            mean_difference = 1,
            common_sd = 2,
            proportion1 = 0.3,
            proportion2 = 0.5,
            allocation_ratio = 1,
            two_sided = TRUE,
            continuity_correction = TRUE,
            margin = 0.1,
            margin_type = "absolute",
            dropout_rate = 10,
            interim_analyses = 0,
            multiple_comparisons = "none",
            show_assumptions = TRUE,
            show_interpretation = TRUE,
            show_sensitivity = TRUE,
            show_plots = TRUE,
            regulatory_context = "ich", ...) {

            super$initialize(
                package="ClinicoPath",
                name="clinicaltrialdesign",
                requiresData=TRUE,
                ...)

            private$..trial_type <- jmvcore::OptionList$new(
                "trial_type",
                trial_type,
                options=list(
                    "superiority",
                    "non_inferiority",
                    "equivalence",
                    "pilot"),
                default="superiority")
            private$..outcome_type <- jmvcore::OptionList$new(
                "outcome_type",
                outcome_type,
                options=list(
                    "continuous",
                    "binary",
                    "categorical",
                    "time_to_event"),
                default="continuous")
            private$..test_type <- jmvcore::OptionList$new(
                "test_type",
                test_type,
                options=list(
                    "two_sample_ttest",
                    "one_sample_ttest",
                    "paired_ttest",
                    "anova_oneway",
                    "two_proportions",
                    "one_proportion",
                    "chi_square",
                    "correlation",
                    "mcnemar"),
                default="two_sample_ttest")
            private$..calculation_type <- jmvcore::OptionList$new(
                "calculation_type",
                calculation_type,
                options=list(
                    "power",
                    "sample_size",
                    "effect_size"),
                default="sample_size")
            private$..alpha <- jmvcore::OptionNumber$new(
                "alpha",
                alpha,
                min=0.001,
                max=0.5,
                default=0.05)
            private$..power <- jmvcore::OptionNumber$new(
                "power",
                power,
                min=0.5,
                max=0.99,
                default=0.8)
            private$..sample_size <- jmvcore::OptionInteger$new(
                "sample_size",
                sample_size,
                min=10,
                max=100000,
                default=100)
            private$..effect_size <- jmvcore::OptionNumber$new(
                "effect_size",
                effect_size,
                min=0.1,
                max=5,
                default=0.5)
            private$..mean_difference <- jmvcore::OptionNumber$new(
                "mean_difference",
                mean_difference,
                default=1)
            private$..common_sd <- jmvcore::OptionNumber$new(
                "common_sd",
                common_sd,
                min=0.1,
                default=2)
            private$..proportion1 <- jmvcore::OptionNumber$new(
                "proportion1",
                proportion1,
                min=0.001,
                max=0.999,
                default=0.3)
            private$..proportion2 <- jmvcore::OptionNumber$new(
                "proportion2",
                proportion2,
                min=0.001,
                max=0.999,
                default=0.5)
            private$..allocation_ratio <- jmvcore::OptionNumber$new(
                "allocation_ratio",
                allocation_ratio,
                min=0.1,
                max=10,
                default=1)
            private$..two_sided <- jmvcore::OptionBool$new(
                "two_sided",
                two_sided,
                default=TRUE)
            private$..continuity_correction <- jmvcore::OptionBool$new(
                "continuity_correction",
                continuity_correction,
                default=TRUE)
            private$..margin <- jmvcore::OptionNumber$new(
                "margin",
                margin,
                min=0,
                default=0.1)
            private$..margin_type <- jmvcore::OptionList$new(
                "margin_type",
                margin_type,
                options=list(
                    "absolute",
                    "relative"),
                default="absolute")
            private$..dropout_rate <- jmvcore::OptionNumber$new(
                "dropout_rate",
                dropout_rate,
                min=0,
                max=50,
                default=10)
            private$..interim_analyses <- jmvcore::OptionInteger$new(
                "interim_analyses",
                interim_analyses,
                min=0,
                max=5,
                default=0)
            private$..multiple_comparisons <- jmvcore::OptionList$new(
                "multiple_comparisons",
                multiple_comparisons,
                options=list(
                    "none",
                    "bonferroni",
                    "holm",
                    "sidak"),
                default="none")
            private$..show_assumptions <- jmvcore::OptionBool$new(
                "show_assumptions",
                show_assumptions,
                default=TRUE)
            private$..show_interpretation <- jmvcore::OptionBool$new(
                "show_interpretation",
                show_interpretation,
                default=TRUE)
            private$..show_sensitivity <- jmvcore::OptionBool$new(
                "show_sensitivity",
                show_sensitivity,
                default=TRUE)
            private$..show_plots <- jmvcore::OptionBool$new(
                "show_plots",
                show_plots,
                default=TRUE)
            private$..regulatory_context <- jmvcore::OptionList$new(
                "regulatory_context",
                regulatory_context,
                options=list(
                    "fda",
                    "ema",
                    "ich",
                    "other"),
                default="ich")

            self$.addOption(private$..trial_type)
            self$.addOption(private$..outcome_type)
            self$.addOption(private$..test_type)
            self$.addOption(private$..calculation_type)
            self$.addOption(private$..alpha)
            self$.addOption(private$..power)
            self$.addOption(private$..sample_size)
            self$.addOption(private$..effect_size)
            self$.addOption(private$..mean_difference)
            self$.addOption(private$..common_sd)
            self$.addOption(private$..proportion1)
            self$.addOption(private$..proportion2)
            self$.addOption(private$..allocation_ratio)
            self$.addOption(private$..two_sided)
            self$.addOption(private$..continuity_correction)
            self$.addOption(private$..margin)
            self$.addOption(private$..margin_type)
            self$.addOption(private$..dropout_rate)
            self$.addOption(private$..interim_analyses)
            self$.addOption(private$..multiple_comparisons)
            self$.addOption(private$..show_assumptions)
            self$.addOption(private$..show_interpretation)
            self$.addOption(private$..show_sensitivity)
            self$.addOption(private$..show_plots)
            self$.addOption(private$..regulatory_context)
        }),
    active = list(
        trial_type = function() private$..trial_type$value,
        outcome_type = function() private$..outcome_type$value,
        test_type = function() private$..test_type$value,
        calculation_type = function() private$..calculation_type$value,
        alpha = function() private$..alpha$value,
        power = function() private$..power$value,
        sample_size = function() private$..sample_size$value,
        effect_size = function() private$..effect_size$value,
        mean_difference = function() private$..mean_difference$value,
        common_sd = function() private$..common_sd$value,
        proportion1 = function() private$..proportion1$value,
        proportion2 = function() private$..proportion2$value,
        allocation_ratio = function() private$..allocation_ratio$value,
        two_sided = function() private$..two_sided$value,
        continuity_correction = function() private$..continuity_correction$value,
        margin = function() private$..margin$value,
        margin_type = function() private$..margin_type$value,
        dropout_rate = function() private$..dropout_rate$value,
        interim_analyses = function() private$..interim_analyses$value,
        multiple_comparisons = function() private$..multiple_comparisons$value,
        show_assumptions = function() private$..show_assumptions$value,
        show_interpretation = function() private$..show_interpretation$value,
        show_sensitivity = function() private$..show_sensitivity$value,
        show_plots = function() private$..show_plots$value,
        regulatory_context = function() private$..regulatory_context$value),
    private = list(
        ..trial_type = NA,
        ..outcome_type = NA,
        ..test_type = NA,
        ..calculation_type = NA,
        ..alpha = NA,
        ..power = NA,
        ..sample_size = NA,
        ..effect_size = NA,
        ..mean_difference = NA,
        ..common_sd = NA,
        ..proportion1 = NA,
        ..proportion2 = NA,
        ..allocation_ratio = NA,
        ..two_sided = NA,
        ..continuity_correction = NA,
        ..margin = NA,
        ..margin_type = NA,
        ..dropout_rate = NA,
        ..interim_analyses = NA,
        ..multiple_comparisons = NA,
        ..show_assumptions = NA,
        ..show_interpretation = NA,
        ..show_sensitivity = NA,
        ..show_plots = NA,
        ..regulatory_context = NA)
)

clinicaltrialdesignResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinicaltrialdesignResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        design_summary = function() private$.items[["design_summary"]],
        power_results = function() private$.items[["power_results"]],
        sample_size_breakdown = function() private$.items[["sample_size_breakdown"]],
        effect_size_analysis = function() private$.items[["effect_size_analysis"]],
        assumptions_check = function() private$.items[["assumptions_check"]],
        sensitivity_analysis = function() private$.items[["sensitivity_analysis"]],
        regulatory_considerations = function() private$.items[["regulatory_considerations"]],
        power_curve = function() private$.items[["power_curve"]],
        effect_size_plot = function() private$.items[["effect_size_plot"]],
        sample_size_plot = function() private$.items[["sample_size_plot"]],
        clinical_interpretation = function() private$.items[["clinical_interpretation"]],
        study_protocol_template = function() private$.items[["study_protocol_template"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Clinical Trial Design & Power Analysis")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Getting Started",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="design_summary",
                title="Trial Design Summary",
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Design Parameter", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Selected Value", 
                        `type`="text"),
                    list(
                        `name`="recommendation", 
                        `title`="Recommendation", 
                        `type`="text"),
                    list(
                        `name`="rationale", 
                        `title`="Rationale", 
                        `type`="text")),
                clearWith=list(
                    "trial_type",
                    "outcome_type",
                    "test_type")))
            self$add(jmvcore::Table$new(
                options=options,
                name="power_results",
                title="Power Analysis Results",
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="input_value", 
                        `title`="Input Value", 
                        `type`="text"),
                    list(
                        `name`="calculated_value", 
                        `title`="Calculated Value", 
                        `type`="text"),
                    list(
                        `name`="confidence_interval", 
                        `title`="95% CI", 
                        `type`="text"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text")),
                clearWith=list(
                    "calculation_type",
                    "alpha",
                    "power",
                    "effect_size",
                    "sample_size")))
            self$add(jmvcore::Table$new(
                options=options,
                name="sample_size_breakdown",
                title="Sample Size Breakdown",
                visible="(calculation_type:sample_size)",
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Sample Size Component", 
                        `type`="text"),
                    list(
                        `name`="per_group", 
                        `title`="Per Group", 
                        `type`="integer"),
                    list(
                        `name`="total", 
                        `title`="Total", 
                        `type`="integer"),
                    list(
                        `name`="adjustment_factor", 
                        `title`="Adjustment Factor", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="rationale", 
                        `title`="Rationale", 
                        `type`="text")),
                clearWith=list(
                    "sample_size",
                    "allocation_ratio",
                    "dropout_rate",
                    "interim_analyses")))
            self$add(jmvcore::Table$new(
                options=options,
                name="effect_size_analysis",
                title="Effect Size Analysis",
                columns=list(
                    list(
                        `name`="effect_measure", 
                        `title`="Effect Measure", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="magnitude", 
                        `title`="Magnitude", 
                        `type`="text"),
                    list(
                        `name`="clinical_significance", 
                        `title`="Clinical Significance", 
                        `type`="text"),
                    list(
                        `name`="statistical_significance", 
                        `title`="Statistical Significance", 
                        `type`="text")),
                clearWith=list(
                    "effect_size",
                    "mean_difference",
                    "proportion1",
                    "proportion2")))
            self$add(jmvcore::Table$new(
                options=options,
                name="assumptions_check",
                title="Statistical Assumptions",
                visible="(show_assumptions)",
                columns=list(
                    list(
                        `name`="assumption", 
                        `title`="Assumption", 
                        `type`="text"),
                    list(
                        `name`="description", 
                        `title`="Description", 
                        `type`="text"),
                    list(
                        `name`="assessment_method", 
                        `title`="Assessment Method", 
                        `type`="text"),
                    list(
                        `name`="violation_impact", 
                        `title`="Impact if Violated", 
                        `type`="text"),
                    list(
                        `name`="alternatives", 
                        `title`="Alternative Tests", 
                        `type`="text")),
                clearWith=list(
                    "test_type",
                    "outcome_type")))
            self$add(jmvcore::Table$new(
                options=options,
                name="sensitivity_analysis",
                title="Sensitivity Analysis",
                visible="(show_sensitivity)",
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="low_value", 
                        `title`="Low Value", 
                        `type`="text"),
                    list(
                        `name`="base_value", 
                        `title`="Base Value", 
                        `type`="text"),
                    list(
                        `name`="high_value", 
                        `title`="High Value", 
                        `type`="text"),
                    list(
                        `name`="impact_assessment", 
                        `title`="Impact Assessment", 
                        `type`="text")),
                clearWith=list(
                    "effect_size",
                    "power",
                    "alpha",
                    "dropout_rate")))
            self$add(jmvcore::Table$new(
                options=options,
                name="regulatory_considerations",
                title="Regulatory Considerations",
                visible="(show_interpretation)",
                columns=list(
                    list(
                        `name`="regulatory_aspect", 
                        `title`="Regulatory Aspect", 
                        `type`="text"),
                    list(
                        `name`="requirement", 
                        `title`="Requirement/Guideline", 
                        `type`="text"),
                    list(
                        `name`="compliance_status", 
                        `title`="Compliance Status", 
                        `type`="text"),
                    list(
                        `name`="recommendation", 
                        `title`="Recommendation", 
                        `type`="text"),
                    list(
                        `name`="reference", 
                        `title`="Reference", 
                        `type`="text")),
                clearWith=list(
                    "regulatory_context",
                    "trial_type",
                    "alpha",
                    "power")))
            self$add(jmvcore::Image$new(
                options=options,
                name="power_curve",
                title="Power Curve Analysis",
                width=800,
                height=600,
                visible="(show_plots)",
                requiresData=FALSE,
                clearWith=list(
                    "effect_size",
                    "alpha",
                    "test_type",
                    "allocation_ratio")))
            self$add(jmvcore::Image$new(
                options=options,
                name="effect_size_plot",
                title="Effect Size Visualization",
                width=800,
                height=600,
                visible="(show_plots)",
                requiresData=FALSE,
                clearWith=list(
                    "effect_size",
                    "mean_difference",
                    "common_sd",
                    "outcome_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="sample_size_plot",
                title="Sample Size Requirements",
                width=800,
                height=600,
                visible="(show_plots && calculation_type:sample_size)",
                requiresData=FALSE,
                clearWith=list(
                    "power",
                    "alpha",
                    "effect_size",
                    "dropout_rate")))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinical_interpretation",
                title="Clinical Interpretation & Guidelines",
                visible="(show_interpretation)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="study_protocol_template",
                title="Study Protocol Template",
                visible="(show_interpretation)"))}))

clinicaltrialdesignBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinicaltrialdesignBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "clinicaltrialdesign",
                version = c(1,0,0),
                options = options,
                results = clinicaltrialdesignResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Clinical Trial Design & Power Analysis
#'
#' Comprehensive power analysis and sample size calculation for clinical trial 
#' design.
#' Covers the most common clinical trial types with appropriate statistical 
#' tests,
#' effect size calculations, and regulatory considerations for clinical 
#' research.
#' 
#' Supports randomized controlled trials (RCTs), equivalence trials, 
#' non-inferiority
#' trials, superiority trials, and observational studies with proper power 
#' calculations.
#' 
#'
#' @examples
#' data('your_data')
#'
#' clinicaltrialdesign(
#'     trial_type = "superiority",
#'     outcome_type = "continuous",
#'     test_type = "two_sample_ttest",
#'     effect_size = 0.5,
#'     alpha = 0.05,
#'     power = 0.80
#' )
#'
#' @param data the data as a data frame (optional for power calculations)
#' @param trial_type Type of clinical trial design for appropriate power
#'   calculations
#' @param outcome_type Type of primary outcome variable determining
#'   appropriate statistical test
#' @param test_type Statistical test appropriate for the outcome type and
#'   study design
#' @param calculation_type What to calculate - power, sample size, or
#'   detectable effect size
#' @param alpha Significance level (typically 0.05 for superiority, 0.025 for
#'   non-inferiority)
#' @param power Desired statistical power (typically 0.80 or 0.90)
#' @param sample_size Total sample size for power calculation
#' @param effect_size Standardized effect size (Cohen's d for continuous
#'   outcomes)
#' @param mean_difference Expected difference in means between groups
#' @param common_sd Pooled standard deviation for continuous outcomes
#' @param proportion1 Expected proportion in control/reference group
#' @param proportion2 Expected proportion in treatment/experimental group
#' @param allocation_ratio Ratio of treatment to control group sizes (1 =
#'   equal allocation)
#' @param two_sided Use two-sided statistical test (recommended for most
#'   trials)
#' @param continuity_correction Apply continuity correction for proportion
#'   tests
#' @param margin Non-inferiority or equivalence margin (absolute difference)
#' @param margin_type Type of margin for non-inferiority/equivalence testing
#' @param dropout_rate Expected dropout/loss to follow-up rate for sample size
#'   inflation
#' @param interim_analyses Number of planned interim analyses (affects alpha
#'   spending)
#' @param multiple_comparisons Adjustment for multiple testing (when
#'   applicable)
#' @param show_assumptions Display assumptions for the selected statistical
#'   test
#' @param show_interpretation Include clinical interpretation and regulatory
#'   considerations
#' @param show_sensitivity Perform sensitivity analysis across parameter
#'   ranges
#' @param show_plots Generate power/sample size relationship plots
#' @param regulatory_context Regulatory context for power analysis
#'   considerations
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab Instructions for clinical trial design and power analysis \cr
#'   \code{results$design_summary} \tab \tab \tab \tab \tab Summary of trial design parameters and recommendations \cr
#'   \code{results$power_results} \tab \tab \tab \tab \tab Primary power analysis calculations and results \cr
#'   \code{results$sample_size_breakdown} \tab \tab \tab \tab \tab Detailed sample size calculations with adjustments \cr
#'   \code{results$effect_size_analysis} \tab \tab \tab \tab \tab Effect size calculations and clinical significance assessment \cr
#'   \code{results$assumptions_check} \tab \tab \tab \tab \tab Key assumptions for the selected statistical test \cr
#'   \code{results$sensitivity_analysis} \tab \tab \tab \tab \tab Power/sample size sensitivity across parameter ranges \cr
#'   \code{results$regulatory_considerations} \tab \tab \tab \tab \tab Regulatory guidance and compliance considerations \cr
#'   \code{results$power_curve} \tab \tab \tab \tab \tab Power curves showing relationship between sample size and statistical power \cr
#'   \code{results$effect_size_plot} \tab \tab \tab \tab \tab Effect size distribution and clinical significance thresholds \cr
#'   \code{results$sample_size_plot} \tab \tab \tab \tab \tab Sample size requirements across different effect sizes and power levels \cr
#'   \code{results$clinical_interpretation} \tab \tab \tab \tab \tab Clinical context, interpretation guidelines, and next steps \cr
#'   \code{results$study_protocol_template} \tab \tab \tab \tab \tab Template sections for study protocol statistical analysis plan \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$design_summary$asDF}
#'
#' \code{as.data.frame(results$design_summary)}
#'
#' @export
clinicaltrialdesign <- function(
    data,
    trial_type = "superiority",
    outcome_type = "continuous",
    test_type = "two_sample_ttest",
    calculation_type = "sample_size",
    alpha = 0.05,
    power = 0.8,
    sample_size = 100,
    effect_size = 0.5,
    mean_difference = 1,
    common_sd = 2,
    proportion1 = 0.3,
    proportion2 = 0.5,
    allocation_ratio = 1,
    two_sided = TRUE,
    continuity_correction = TRUE,
    margin = 0.1,
    margin_type = "absolute",
    dropout_rate = 10,
    interim_analyses = 0,
    multiple_comparisons = "none",
    show_assumptions = TRUE,
    show_interpretation = TRUE,
    show_sensitivity = TRUE,
    show_plots = TRUE,
    regulatory_context = "ich") {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("clinicaltrialdesign requires jmvcore to be installed (restart may be required)")

    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame())


    options <- clinicaltrialdesignOptions$new(
        trial_type = trial_type,
        outcome_type = outcome_type,
        test_type = test_type,
        calculation_type = calculation_type,
        alpha = alpha,
        power = power,
        sample_size = sample_size,
        effect_size = effect_size,
        mean_difference = mean_difference,
        common_sd = common_sd,
        proportion1 = proportion1,
        proportion2 = proportion2,
        allocation_ratio = allocation_ratio,
        two_sided = two_sided,
        continuity_correction = continuity_correction,
        margin = margin,
        margin_type = margin_type,
        dropout_rate = dropout_rate,
        interim_analyses = interim_analyses,
        multiple_comparisons = multiple_comparisons,
        show_assumptions = show_assumptions,
        show_interpretation = show_interpretation,
        show_sensitivity = show_sensitivity,
        show_plots = show_plots,
        regulatory_context = regulatory_context)

    analysis <- clinicaltrialdesignClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

