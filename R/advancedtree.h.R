
# This file is automatically generated, you probably don't want to edit this

advancedtreeOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "advancedtreeOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            vars = NULL,
            facs = NULL,
            target = NULL,
            targetLevel = NULL,
            algorithm = "rpart",
            validation = "cv",
            cv_folds = 5,
            test_split = 0.3,
            max_depth = 6,
            min_samples_split = 20,
            min_samples_leaf = 10,
            n_estimators = 100,
            learning_rate = 0.1,
            feature_selection = FALSE,
            importance_method = "gini",
            handle_imbalance = FALSE,
            imbalance_method = "weights",
            hyperparameter_tuning = FALSE,
            tuning_method = "random",
            show_tree_plot = TRUE,
            show_importance_plot = TRUE,
            show_performance_metrics = TRUE,
            show_validation_curves = TRUE,
            show_roc_curve = TRUE,
            show_calibration_plot = FALSE,
            show_confusion_matrix = TRUE,
            interpretability = FALSE,
            shap_analysis = FALSE,
            partial_dependence = FALSE,
            interaction_analysis = FALSE,
            clinical_context = "diagnosis",
            cost_sensitive_thresholds = FALSE,
            fn_fp_ratio = 1,
            missing_data_handling = "complete",
            export_model = FALSE,
            bootstrap_confidence = FALSE,
            n_bootstrap = 1000, ...) {

            super$initialize(
                package="ClinicoPath",
                name="advancedtree",
                requiresData=TRUE,
                ...)

            private$..vars <- jmvcore::OptionVariables$new(
                "vars",
                vars,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..facs <- jmvcore::OptionVariables$new(
                "facs",
                facs,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..target <- jmvcore::OptionVariable$new(
                "target",
                target,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..targetLevel <- jmvcore::OptionLevel$new(
                "targetLevel",
                targetLevel,
                variable="(target)")
            private$..algorithm <- jmvcore::OptionList$new(
                "algorithm",
                algorithm,
                options=list(
                    "rpart",
                    "ctree",
                    "randomforest",
                    "xgboost",
                    "extratrees",
                    "ensemble"),
                default="rpart")
            private$..validation <- jmvcore::OptionList$new(
                "validation",
                validation,
                options=list(
                    "cv",
                    "bootstrap",
                    "holdout",
                    "temporal"),
                default="cv")
            private$..cv_folds <- jmvcore::OptionInteger$new(
                "cv_folds",
                cv_folds,
                default=5,
                min=3,
                max=10)
            private$..test_split <- jmvcore::OptionNumber$new(
                "test_split",
                test_split,
                default=0.3,
                min=0.1,
                max=0.5)
            private$..max_depth <- jmvcore::OptionInteger$new(
                "max_depth",
                max_depth,
                default=6,
                min=2,
                max=15)
            private$..min_samples_split <- jmvcore::OptionInteger$new(
                "min_samples_split",
                min_samples_split,
                default=20,
                min=2,
                max=100)
            private$..min_samples_leaf <- jmvcore::OptionInteger$new(
                "min_samples_leaf",
                min_samples_leaf,
                default=10,
                min=1,
                max=50)
            private$..n_estimators <- jmvcore::OptionInteger$new(
                "n_estimators",
                n_estimators,
                default=100,
                min=10,
                max=1000)
            private$..learning_rate <- jmvcore::OptionNumber$new(
                "learning_rate",
                learning_rate,
                default=0.1,
                min=0.01,
                max=0.5)
            private$..feature_selection <- jmvcore::OptionBool$new(
                "feature_selection",
                feature_selection,
                default=FALSE)
            private$..importance_method <- jmvcore::OptionList$new(
                "importance_method",
                importance_method,
                options=list(
                    "gini",
                    "permutation",
                    "shap"),
                default="gini")
            private$..handle_imbalance <- jmvcore::OptionBool$new(
                "handle_imbalance",
                handle_imbalance,
                default=FALSE)
            private$..imbalance_method <- jmvcore::OptionList$new(
                "imbalance_method",
                imbalance_method,
                options=list(
                    "weights",
                    "smote",
                    "undersample",
                    "cost_sensitive"),
                default="weights")
            private$..hyperparameter_tuning <- jmvcore::OptionBool$new(
                "hyperparameter_tuning",
                hyperparameter_tuning,
                default=FALSE)
            private$..tuning_method <- jmvcore::OptionList$new(
                "tuning_method",
                tuning_method,
                options=list(
                    "grid",
                    "random",
                    "bayesian"),
                default="random")
            private$..show_tree_plot <- jmvcore::OptionBool$new(
                "show_tree_plot",
                show_tree_plot,
                default=TRUE)
            private$..show_importance_plot <- jmvcore::OptionBool$new(
                "show_importance_plot",
                show_importance_plot,
                default=TRUE)
            private$..show_performance_metrics <- jmvcore::OptionBool$new(
                "show_performance_metrics",
                show_performance_metrics,
                default=TRUE)
            private$..show_validation_curves <- jmvcore::OptionBool$new(
                "show_validation_curves",
                show_validation_curves,
                default=TRUE)
            private$..show_roc_curve <- jmvcore::OptionBool$new(
                "show_roc_curve",
                show_roc_curve,
                default=TRUE)
            private$..show_calibration_plot <- jmvcore::OptionBool$new(
                "show_calibration_plot",
                show_calibration_plot,
                default=FALSE)
            private$..show_confusion_matrix <- jmvcore::OptionBool$new(
                "show_confusion_matrix",
                show_confusion_matrix,
                default=TRUE)
            private$..interpretability <- jmvcore::OptionBool$new(
                "interpretability",
                interpretability,
                default=FALSE)
            private$..shap_analysis <- jmvcore::OptionBool$new(
                "shap_analysis",
                shap_analysis,
                default=FALSE)
            private$..partial_dependence <- jmvcore::OptionBool$new(
                "partial_dependence",
                partial_dependence,
                default=FALSE)
            private$..interaction_analysis <- jmvcore::OptionBool$new(
                "interaction_analysis",
                interaction_analysis,
                default=FALSE)
            private$..clinical_context <- jmvcore::OptionList$new(
                "clinical_context",
                clinical_context,
                options=list(
                    "diagnosis",
                    "prognosis",
                    "treatment",
                    "risk",
                    "biomarker",
                    "screening"),
                default="diagnosis")
            private$..cost_sensitive_thresholds <- jmvcore::OptionBool$new(
                "cost_sensitive_thresholds",
                cost_sensitive_thresholds,
                default=FALSE)
            private$..fn_fp_ratio <- jmvcore::OptionNumber$new(
                "fn_fp_ratio",
                fn_fp_ratio,
                default=1,
                min=0.1,
                max=10)
            private$..missing_data_handling <- jmvcore::OptionList$new(
                "missing_data_handling",
                missing_data_handling,
                options=list(
                    "complete",
                    "simple",
                    "model",
                    "tree"),
                default="complete")
            private$..export_model <- jmvcore::OptionBool$new(
                "export_model",
                export_model,
                default=FALSE)
            private$..bootstrap_confidence <- jmvcore::OptionBool$new(
                "bootstrap_confidence",
                bootstrap_confidence,
                default=FALSE)
            private$..n_bootstrap <- jmvcore::OptionInteger$new(
                "n_bootstrap",
                n_bootstrap,
                default=1000,
                min=100,
                max=5000)

            self$.addOption(private$..vars)
            self$.addOption(private$..facs)
            self$.addOption(private$..target)
            self$.addOption(private$..targetLevel)
            self$.addOption(private$..algorithm)
            self$.addOption(private$..validation)
            self$.addOption(private$..cv_folds)
            self$.addOption(private$..test_split)
            self$.addOption(private$..max_depth)
            self$.addOption(private$..min_samples_split)
            self$.addOption(private$..min_samples_leaf)
            self$.addOption(private$..n_estimators)
            self$.addOption(private$..learning_rate)
            self$.addOption(private$..feature_selection)
            self$.addOption(private$..importance_method)
            self$.addOption(private$..handle_imbalance)
            self$.addOption(private$..imbalance_method)
            self$.addOption(private$..hyperparameter_tuning)
            self$.addOption(private$..tuning_method)
            self$.addOption(private$..show_tree_plot)
            self$.addOption(private$..show_importance_plot)
            self$.addOption(private$..show_performance_metrics)
            self$.addOption(private$..show_validation_curves)
            self$.addOption(private$..show_roc_curve)
            self$.addOption(private$..show_calibration_plot)
            self$.addOption(private$..show_confusion_matrix)
            self$.addOption(private$..interpretability)
            self$.addOption(private$..shap_analysis)
            self$.addOption(private$..partial_dependence)
            self$.addOption(private$..interaction_analysis)
            self$.addOption(private$..clinical_context)
            self$.addOption(private$..cost_sensitive_thresholds)
            self$.addOption(private$..fn_fp_ratio)
            self$.addOption(private$..missing_data_handling)
            self$.addOption(private$..export_model)
            self$.addOption(private$..bootstrap_confidence)
            self$.addOption(private$..n_bootstrap)
        }),
    active = list(
        vars = function() private$..vars$value,
        facs = function() private$..facs$value,
        target = function() private$..target$value,
        targetLevel = function() private$..targetLevel$value,
        algorithm = function() private$..algorithm$value,
        validation = function() private$..validation$value,
        cv_folds = function() private$..cv_folds$value,
        test_split = function() private$..test_split$value,
        max_depth = function() private$..max_depth$value,
        min_samples_split = function() private$..min_samples_split$value,
        min_samples_leaf = function() private$..min_samples_leaf$value,
        n_estimators = function() private$..n_estimators$value,
        learning_rate = function() private$..learning_rate$value,
        feature_selection = function() private$..feature_selection$value,
        importance_method = function() private$..importance_method$value,
        handle_imbalance = function() private$..handle_imbalance$value,
        imbalance_method = function() private$..imbalance_method$value,
        hyperparameter_tuning = function() private$..hyperparameter_tuning$value,
        tuning_method = function() private$..tuning_method$value,
        show_tree_plot = function() private$..show_tree_plot$value,
        show_importance_plot = function() private$..show_importance_plot$value,
        show_performance_metrics = function() private$..show_performance_metrics$value,
        show_validation_curves = function() private$..show_validation_curves$value,
        show_roc_curve = function() private$..show_roc_curve$value,
        show_calibration_plot = function() private$..show_calibration_plot$value,
        show_confusion_matrix = function() private$..show_confusion_matrix$value,
        interpretability = function() private$..interpretability$value,
        shap_analysis = function() private$..shap_analysis$value,
        partial_dependence = function() private$..partial_dependence$value,
        interaction_analysis = function() private$..interaction_analysis$value,
        clinical_context = function() private$..clinical_context$value,
        cost_sensitive_thresholds = function() private$..cost_sensitive_thresholds$value,
        fn_fp_ratio = function() private$..fn_fp_ratio$value,
        missing_data_handling = function() private$..missing_data_handling$value,
        export_model = function() private$..export_model$value,
        bootstrap_confidence = function() private$..bootstrap_confidence$value,
        n_bootstrap = function() private$..n_bootstrap$value),
    private = list(
        ..vars = NA,
        ..facs = NA,
        ..target = NA,
        ..targetLevel = NA,
        ..algorithm = NA,
        ..validation = NA,
        ..cv_folds = NA,
        ..test_split = NA,
        ..max_depth = NA,
        ..min_samples_split = NA,
        ..min_samples_leaf = NA,
        ..n_estimators = NA,
        ..learning_rate = NA,
        ..feature_selection = NA,
        ..importance_method = NA,
        ..handle_imbalance = NA,
        ..imbalance_method = NA,
        ..hyperparameter_tuning = NA,
        ..tuning_method = NA,
        ..show_tree_plot = NA,
        ..show_importance_plot = NA,
        ..show_performance_metrics = NA,
        ..show_validation_curves = NA,
        ..show_roc_curve = NA,
        ..show_calibration_plot = NA,
        ..show_confusion_matrix = NA,
        ..interpretability = NA,
        ..shap_analysis = NA,
        ..partial_dependence = NA,
        ..interaction_analysis = NA,
        ..clinical_context = NA,
        ..cost_sensitive_thresholds = NA,
        ..fn_fp_ratio = NA,
        ..missing_data_handling = NA,
        ..export_model = NA,
        ..bootstrap_confidence = NA,
        ..n_bootstrap = NA)
)

advancedtreeResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "advancedtreeResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        model_summary = function() private$.items[["model_summary"]],
        tree_plot = function() private$.items[["tree_plot"]],
        tree_plot_explanation = function() private$.items[["tree_plot_explanation"]],
        importance_plot = function() private$.items[["importance_plot"]],
        importance_plot_explanation = function() private$.items[["importance_plot_explanation"]],
        performance_table = function() private$.items[["performance_table"]],
        performance_table_explanation = function() private$.items[["performance_table_explanation"]],
        roc_plot = function() private$.items[["roc_plot"]],
        roc_plot_explanation = function() private$.items[["roc_plot_explanation"]],
        validation_curves = function() private$.items[["validation_curves"]],
        confusion_matrix = function() private$.items[["confusion_matrix"]],
        confusion_matrix_explanation = function() private$.items[["confusion_matrix_explanation"]],
        calibration_plot = function() private$.items[["calibration_plot"]],
        shap_plot = function() private$.items[["shap_plot"]],
        partial_dependence_plot = function() private$.items[["partial_dependence_plot"]],
        interaction_plot = function() private$.items[["interaction_plot"]],
        hyperparameter_results = function() private$.items[["hyperparameter_results"]],
        clinical_interpretation = function() private$.items[["clinical_interpretation"]],
        feature_selection_results = function() private$.items[["feature_selection_results"]],
        bootstrap_intervals = function() private$.items[["bootstrap_intervals"]],
        model_export = function() private$.items[["model_export"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Advanced Decision Tree Analysis")
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Instructions",
                visible=FALSE))
            self$add(jmvcore::Html$new(
                options=options,
                name="model_summary",
                title="Model Summary",
                visible="(show_performance_metrics)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "algorithm",
                    "validation")))
            self$add(jmvcore::Image$new(
                options=options,
                name="tree_plot",
                title="Decision Tree Visualization",
                width=800,
                height=600,
                renderFun=".plot_tree",
                visible="(show_tree_plot && algorithm:rpart || algorithm:ctree)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "algorithm",
                    "max_depth",
                    "min_samples_split",
                    "min_samples_leaf")))
            self$add(jmvcore::Html$new(
                options=options,
                name="tree_plot_explanation",
                title="How to Read the Decision Tree",
                visible="(show_tree_plot && algorithm:rpart || algorithm:ctree)",
                clearWith=list(
                    "algorithm")))
            self$add(jmvcore::Image$new(
                options=options,
                name="importance_plot",
                title="Feature Importance",
                width=700,
                height=500,
                renderFun=".plot_importance",
                visible="(show_importance_plot)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "algorithm",
                    "importance_method")))
            self$add(jmvcore::Html$new(
                options=options,
                name="importance_plot_explanation",
                title="Understanding Feature Importance",
                visible="(show_importance_plot)",
                clearWith=list(
                    "algorithm",
                    "importance_method")))
            self$add(jmvcore::Table$new(
                options=options,
                name="performance_table",
                title="Performance Metrics",
                visible="(show_performance_metrics)",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="dp:3"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number", 
                        `format`="dp:3"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number", 
                        `format`="dp:3")),
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "algorithm",
                    "validation")))
            self$add(jmvcore::Html$new(
                options=options,
                name="performance_table_explanation",
                title="Interpreting Performance Metrics",
                visible="(show_performance_metrics)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="roc_plot",
                title="ROC Curve Analysis",
                width=600,
                height=500,
                renderFun=".plot_roc",
                visible="(show_roc_curve)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "algorithm",
                    "validation")))
            self$add(jmvcore::Html$new(
                options=options,
                name="roc_plot_explanation",
                title="Understanding the ROC Curve",
                visible="(show_roc_curve)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="validation_curves",
                title="Validation Performance",
                width=800,
                height=500,
                renderFun=".plot_validation",
                visible="(show_validation_curves)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "algorithm",
                    "validation",
                    "cv_folds")))
            self$add(jmvcore::Html$new(
                options=options,
                name="confusion_matrix",
                title="Confusion Matrix",
                visible="(show_confusion_matrix)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "algorithm",
                    "validation")))
            self$add(jmvcore::Html$new(
                options=options,
                name="confusion_matrix_explanation",
                title="Reading the Confusion Matrix",
                visible="(show_confusion_matrix)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="calibration_plot",
                title="Probability Calibration",
                width=600,
                height=500,
                renderFun=".plot_calibration",
                visible="(show_calibration_plot)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "algorithm",
                    "validation")))
            self$add(jmvcore::Image$new(
                options=options,
                name="shap_plot",
                title="SHAP Value Analysis",
                width=800,
                height=600,
                renderFun=".plot_shap",
                visible="(shap_analysis && interpretability)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "algorithm")))
            self$add(jmvcore::Image$new(
                options=options,
                name="partial_dependence_plot",
                title="Partial Dependence Plots",
                width=900,
                height=700,
                renderFun=".plot_partial_dependence",
                visible="(partial_dependence && interpretability)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "algorithm")))
            self$add(jmvcore::Image$new(
                options=options,
                name="interaction_plot",
                title="Feature Interactions",
                width=700,
                height=600,
                renderFun=".plot_interactions",
                visible="(interaction_analysis && interpretability)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "algorithm")))
            self$add(jmvcore::Html$new(
                options=options,
                name="hyperparameter_results",
                title="Hyperparameter Optimization Results",
                visible="(hyperparameter_tuning)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "algorithm",
                    "tuning_method")))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinical_interpretation",
                title="Clinical Interpretation Guide",
                visible="(show_performance_metrics)",
                clearWith=list(
                    "clinical_context",
                    "algorithm",
                    "target")))
            self$add(jmvcore::Html$new(
                options=options,
                name="feature_selection_results",
                title="Feature Selection Results",
                visible="(feature_selection)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "algorithm")))
            self$add(jmvcore::Html$new(
                options=options,
                name="bootstrap_intervals",
                title="Bootstrap Confidence Intervals",
                visible="(bootstrap_confidence)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "algorithm",
                    "n_bootstrap")))
            self$add(jmvcore::Html$new(
                options=options,
                name="model_export",
                title="Model Export Information",
                visible="(export_model)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "algorithm")))}))

advancedtreeBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "advancedtreeBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "advancedtree",
                version = c(0,0,3),
                options = options,
                results = advancedtreeResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Advanced Decision Tree Analysis
#'
#' Advanced decision tree analysis using modern algorithms for clinical 
#' research and medical decision making.
#' Extends basic decision tree functionality with gradient boosting, 
#' conditional inference trees, 
#' ensemble methods, and enhanced interpretability. Provides comprehensive 
#' performance evaluation,
#' feature importance analysis, and clinical-focused visualizations. 
#' Complements existing
#' ClinicoPath decision tree modules with state-of-the-art algorithms.
#' 
#'
#' @examples
#' # Example: Advanced decision tree for cancer prognosis
#' data(cancer_data)
#' advancedtree(
#'     data = cancer_data,
#'     vars = c("age", "tumor_size", "biomarker1", "biomarker2"),
#'     facs = c("grade", "stage", "histology"),
#'     target = "outcome",
#'     targetLevel = "poor_prognosis",
#'     algorithm = "xgboost",
#'     validation = "cv",
#'     interpretability = TRUE
#' )
#'
#' @param data The data as a data frame containing clinical variables,
#'   biomarkers,  and patient outcomes for advanced decision tree analysis.
#' @param vars Continuous variables such as biomarker levels, age,  laboratory
#'   values, or quantitative measurements.
#' @param facs Categorical variables such as tumor grade, stage,  histological
#'   type, or patient demographics.
#' @param target Primary outcome variable: disease status, treatment response,
#'   survival status, or diagnostic category.
#' @param targetLevel Level representing the positive outcome, event of
#'   interest, or disease presence for binary classification.
#' @param algorithm Tree algorithm to use. Each offers different strengths:
#'   CART (interpretable), ctree (unbiased), Random Forest (robust), XGBoost
#'   (high performance), Extra Trees (fast), Ensemble (combined).
#' @param validation Validation approach for performance estimation.
#'   Cross-validation provides robust estimates, bootstrap handles small
#'   samples, holdout for large datasets, temporal for time-series data.
#' @param cv_folds Number of folds for cross-validation. 5-fold provides good
#'   balance between bias and variance for most clinical datasets.
#' @param test_split Proportion of data reserved for testing (holdout
#'   validation). Typical values: 20-30\% for large datasets, 10-20\% for small
#'   ones.
#' @param max_depth Maximum depth of individual trees. Deeper trees capture
#'   more interactions but may overfit. Clinical trees typically 2-8 levels.
#' @param min_samples_split Minimum number of samples required to split a
#'   node. Higher values prevent overfitting in clinical data.
#' @param min_samples_leaf Minimum number of samples in leaf nodes. Important
#'   for clinical validity - too few samples reduce reliability.
#' @param n_estimators Number of trees in ensemble methods (Random Forest,
#'   XGBoost). More trees improve performance but increase computation time.
#' @param learning_rate Learning rate for gradient boosting. Lower values
#'   require more trees but often achieve better performance.
#' @param feature_selection Perform automated feature selection using
#'   tree-based importance. Helps identify most relevant clinical variables and
#'   biomarkers.
#' @param importance_method Method for calculating feature importance.
#'   Permutation and SHAP provide more reliable importance for clinical
#'   interpretation.
#' @param handle_imbalance Address class imbalance common in clinical data
#'   (rare diseases, adverse events). Uses algorithm-specific approaches.
#' @param imbalance_method Method for handling class imbalance. Class weights
#'   are simple and effective, SMOTE generates synthetic samples.
#' @param hyperparameter_tuning Perform automated hyperparameter tuning using
#'   grid search or random search. Improves model performance but increases
#'   runtime.
#' @param tuning_method Hyperparameter optimization strategy. Random search is
#'   efficient for most problems, Bayesian for complex scenarios.
#' @param show_tree_plot Display visual representation of the decision tree.
#'   Most informative for single trees, less useful for ensembles.
#' @param show_importance_plot Display feature importance rankings. Critical
#'   for understanding which clinical variables drive predictions.
#' @param show_performance_metrics Display comprehensive performance
#'   evaluation including accuracy, sensitivity, specificity, AUC, and clinical
#'   metrics.
#' @param show_validation_curves Display learning curves and validation
#'   performance. Helps assess overfitting and training adequacy.
#' @param show_roc_curve Display ROC curve analysis for binary classification.
#'   Essential for clinical decision making and threshold selection.
#' @param show_calibration_plot Display probability calibration plot.
#'   Important for clinical applications requiring reliable probability
#'   estimates.
#' @param show_confusion_matrix Display detailed confusion matrix with
#'   clinical interpretations. Shows actual vs predicted classifications.
#' @param interpretability Perform advanced interpretability analysis
#'   including SHAP values, partial dependence plots, and interaction effects.
#' @param shap_analysis Calculate SHAP (SHapley Additive exPlanations) values
#'   for individual prediction explanations. Powerful for clinical decision
#'   support.
#' @param partial_dependence Show how individual features affect predictions
#'   across their value ranges. Helps understand clinical relationships.
#' @param interaction_analysis Analyze interactions between clinical
#'   variables. Important for understanding combined effects of biomarkers.
#' @param clinical_context Clinical application context. Affects performance
#'   thresholds, interpretation guidelines, and visualization emphasis.
#' @param cost_sensitive_thresholds Optimize decision thresholds considering
#'   clinical costs of false positives vs false negatives.
#' @param fn_fp_ratio Relative cost of missing a positive case vs false alarm.
#'   Screening (high ratio), confirmation tests (low ratio).
#' @param missing_data_handling Strategy for handling missing data. Tree-based
#'   methods can handle missing values naturally in some algorithms.
#' @param export_model Export the trained model for external use or
#'   deployment. Useful for clinical decision support system integration.
#' @param bootstrap_confidence Calculate bootstrap confidence intervals for
#'   performance metrics. Provides uncertainty quantification for clinical
#'   reporting.
#' @param n_bootstrap Number of bootstrap samples for confidence interval
#'   calculation. More samples provide better estimates but increase computation
#'   time.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$model_summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$tree_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$tree_plot_explanation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$importance_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$importance_plot_explanation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$performance_table} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$performance_table_explanation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$roc_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$roc_plot_explanation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$validation_curves} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$confusion_matrix} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$confusion_matrix_explanation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$calibration_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$shap_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$partial_dependence_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$interaction_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$hyperparameter_results} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$clinical_interpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$feature_selection_results} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$bootstrap_intervals} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$model_export} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$performance_table$asDF}
#'
#' \code{as.data.frame(results$performance_table)}
#'
#' @export
advancedtree <- function(
    data,
    vars,
    facs,
    target,
    targetLevel,
    algorithm = "rpart",
    validation = "cv",
    cv_folds = 5,
    test_split = 0.3,
    max_depth = 6,
    min_samples_split = 20,
    min_samples_leaf = 10,
    n_estimators = 100,
    learning_rate = 0.1,
    feature_selection = FALSE,
    importance_method = "gini",
    handle_imbalance = FALSE,
    imbalance_method = "weights",
    hyperparameter_tuning = FALSE,
    tuning_method = "random",
    show_tree_plot = TRUE,
    show_importance_plot = TRUE,
    show_performance_metrics = TRUE,
    show_validation_curves = TRUE,
    show_roc_curve = TRUE,
    show_calibration_plot = FALSE,
    show_confusion_matrix = TRUE,
    interpretability = FALSE,
    shap_analysis = FALSE,
    partial_dependence = FALSE,
    interaction_analysis = FALSE,
    clinical_context = "diagnosis",
    cost_sensitive_thresholds = FALSE,
    fn_fp_ratio = 1,
    missing_data_handling = "complete",
    export_model = FALSE,
    bootstrap_confidence = FALSE,
    n_bootstrap = 1000) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("advancedtree requires jmvcore to be installed (restart may be required)")

    if ( ! missing(vars)) vars <- jmvcore::resolveQuo(jmvcore::enquo(vars))
    if ( ! missing(facs)) facs <- jmvcore::resolveQuo(jmvcore::enquo(facs))
    if ( ! missing(target)) target <- jmvcore::resolveQuo(jmvcore::enquo(target))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(vars), vars, NULL),
            `if`( ! missing(facs), facs, NULL),
            `if`( ! missing(target), target, NULL))

    for (v in facs) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in target) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- advancedtreeOptions$new(
        vars = vars,
        facs = facs,
        target = target,
        targetLevel = targetLevel,
        algorithm = algorithm,
        validation = validation,
        cv_folds = cv_folds,
        test_split = test_split,
        max_depth = max_depth,
        min_samples_split = min_samples_split,
        min_samples_leaf = min_samples_leaf,
        n_estimators = n_estimators,
        learning_rate = learning_rate,
        feature_selection = feature_selection,
        importance_method = importance_method,
        handle_imbalance = handle_imbalance,
        imbalance_method = imbalance_method,
        hyperparameter_tuning = hyperparameter_tuning,
        tuning_method = tuning_method,
        show_tree_plot = show_tree_plot,
        show_importance_plot = show_importance_plot,
        show_performance_metrics = show_performance_metrics,
        show_validation_curves = show_validation_curves,
        show_roc_curve = show_roc_curve,
        show_calibration_plot = show_calibration_plot,
        show_confusion_matrix = show_confusion_matrix,
        interpretability = interpretability,
        shap_analysis = shap_analysis,
        partial_dependence = partial_dependence,
        interaction_analysis = interaction_analysis,
        clinical_context = clinical_context,
        cost_sensitive_thresholds = cost_sensitive_thresholds,
        fn_fp_ratio = fn_fp_ratio,
        missing_data_handling = missing_data_handling,
        export_model = export_model,
        bootstrap_confidence = bootstrap_confidence,
        n_bootstrap = n_bootstrap)

    analysis <- advancedtreeClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

