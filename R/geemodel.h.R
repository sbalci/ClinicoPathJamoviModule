
# This file is automatically generated, you probably don't want to edit this

geemodelOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "geemodelOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            outcome = NULL,
            predictors = NULL,
            cluster_id = NULL,
            time_var = NULL,
            family = "gaussian",
            corstr = "exchangeable",
            robust_se = TRUE,
            conf_level = 0.95,
            qic = TRUE,
            posthoc = FALSE,
            posthoc_adjust = "holm",
            diagnostics = TRUE,
            correlation_plot = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="geemodel",
                requiresData=TRUE,
                ...)

            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..predictors <- jmvcore::OptionVariables$new(
                "predictors",
                predictors,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..cluster_id <- jmvcore::OptionVariable$new(
                "cluster_id",
                cluster_id,
                required=TRUE,
                permitted=list(
                    "id",
                    "factor"))
            private$..time_var <- jmvcore::OptionVariable$new(
                "time_var",
                time_var,
                permitted=list(
                    "numeric",
                    "factor"))
            private$..family <- jmvcore::OptionList$new(
                "family",
                family,
                options=list(
                    "gaussian",
                    "binomial",
                    "poisson",
                    "gamma"),
                default="gaussian")
            private$..corstr <- jmvcore::OptionList$new(
                "corstr",
                corstr,
                options=list(
                    "independence",
                    "exchangeable",
                    "ar1",
                    "unstructured"),
                default="exchangeable")
            private$..robust_se <- jmvcore::OptionBool$new(
                "robust_se",
                robust_se,
                default=TRUE)
            private$..conf_level <- jmvcore::OptionNumber$new(
                "conf_level",
                conf_level,
                min=0.8,
                max=0.99,
                default=0.95)
            private$..qic <- jmvcore::OptionBool$new(
                "qic",
                qic,
                default=TRUE)
            private$..posthoc <- jmvcore::OptionBool$new(
                "posthoc",
                posthoc,
                default=FALSE)
            private$..posthoc_adjust <- jmvcore::OptionList$new(
                "posthoc_adjust",
                posthoc_adjust,
                options=list(
                    "bonferroni",
                    "holm",
                    "bh",
                    "none"),
                default="holm")
            private$..diagnostics <- jmvcore::OptionBool$new(
                "diagnostics",
                diagnostics,
                default=TRUE)
            private$..correlation_plot <- jmvcore::OptionBool$new(
                "correlation_plot",
                correlation_plot,
                default=FALSE)

            self$.addOption(private$..outcome)
            self$.addOption(private$..predictors)
            self$.addOption(private$..cluster_id)
            self$.addOption(private$..time_var)
            self$.addOption(private$..family)
            self$.addOption(private$..corstr)
            self$.addOption(private$..robust_se)
            self$.addOption(private$..conf_level)
            self$.addOption(private$..qic)
            self$.addOption(private$..posthoc)
            self$.addOption(private$..posthoc_adjust)
            self$.addOption(private$..diagnostics)
            self$.addOption(private$..correlation_plot)
        }),
    active = list(
        outcome = function() private$..outcome$value,
        predictors = function() private$..predictors$value,
        cluster_id = function() private$..cluster_id$value,
        time_var = function() private$..time_var$value,
        family = function() private$..family$value,
        corstr = function() private$..corstr$value,
        robust_se = function() private$..robust_se$value,
        conf_level = function() private$..conf_level$value,
        qic = function() private$..qic$value,
        posthoc = function() private$..posthoc$value,
        posthoc_adjust = function() private$..posthoc_adjust$value,
        diagnostics = function() private$..diagnostics$value,
        correlation_plot = function() private$..correlation_plot$value),
    private = list(
        ..outcome = NA,
        ..predictors = NA,
        ..cluster_id = NA,
        ..time_var = NA,
        ..family = NA,
        ..corstr = NA,
        ..robust_se = NA,
        ..conf_level = NA,
        ..qic = NA,
        ..posthoc = NA,
        ..posthoc_adjust = NA,
        ..diagnostics = NA,
        ..correlation_plot = NA)
)

geemodelResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "geemodelResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        modelInfo = function() private$.items[["modelInfo"]],
        coefficientsTable = function() private$.items[["coefficientsTable"]],
        qicTable = function() private$.items[["qicTable"]],
        posthocTable = function() private$.items[["posthocTable"]],
        diagnosticsTable = function() private$.items[["diagnosticsTable"]],
        correlationPlot = function() private$.items[["correlationPlot"]],
        methodologyNote = function() private$.items[["methodologyNote"]],
        interpretationNote = function() private$.items[["interpretationNote"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Generalized Estimating Equations")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=FALSE))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelInfo",
                title="Model Information",
                rows=6,
                clearWith=list(
                    "outcome",
                    "predictors",
                    "cluster_id",
                    "family",
                    "corstr"),
                columns=list(
                    list(
                        `name`="info", 
                        `title`="", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="coefficientsTable",
                title="Model Coefficients",
                clearWith=list(
                    "outcome",
                    "predictors",
                    "cluster_id",
                    "family",
                    "corstr",
                    "robust_se"),
                columns=list(
                    list(
                        `name`="term", 
                        `title`="Term", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="wald", 
                        `title`="Wald", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="qicTable",
                title="Model Selection Criterion",
                visible="(qic)",
                rows=1,
                clearWith=list(
                    "outcome",
                    "predictors",
                    "cluster_id",
                    "family",
                    "corstr"),
                columns=list(
                    list(
                        `name`="qic", 
                        `title`="QIC", 
                        `type`="number"),
                    list(
                        `name`="qicu", 
                        `title`="QICu", 
                        `type`="number"),
                    list(
                        `name`="aic", 
                        `title`="Quasi AIC", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="posthocTable",
                title="Post-hoc Pairwise Comparisons",
                visible="(posthoc)",
                clearWith=list(
                    "outcome",
                    "predictors",
                    "cluster_id",
                    "family",
                    "corstr",
                    "posthoc",
                    "posthoc_adjust"),
                columns=list(
                    list(
                        `name`="contrast", 
                        `title`="Contrast", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="z", 
                        `title`="z-ratio", 
                        `type`="number"),
                    list(
                        `name`="p", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="diagnosticsTable",
                title="Model Diagnostics",
                visible="(diagnostics)",
                rows=5,
                clearWith=list(
                    "outcome",
                    "predictors",
                    "cluster_id"),
                columns=list(
                    list(
                        `name`="diagnostic", 
                        `title`="", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="correlationPlot",
                title="Estimated Within-Cluster Correlation",
                visible="(correlation_plot)",
                requiresData=TRUE,
                width=500,
                height=400,
                renderFun=".plotCorrelation",
                clearWith=list(
                    "outcome",
                    "predictors",
                    "cluster_id",
                    "corstr")))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodologyNote",
                title="Methodology Notes",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretationNote",
                title="Interpretation Guide",
                visible=TRUE))}))

geemodelBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "geemodelBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "geemodel",
                version = c(1,0,0),
                options = options,
                results = geemodelResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Generalized Estimating Equations
#'
#' Generalized Estimating Equations for analyzing correlated/clustered data.
#' Handles repeated measures, longitudinal data, multi-site studies with
#' marginal model approach. Essential for pathology studies with multiple
#' samples per subject (e.g., bilateral organs, multiple biopsies per 
#' patient).
#' 
#' **Key Features:**
#' - Handles binary, continuous, and count outcomes
#' - Multiple correlation structures (exchangeable, AR-1, unstructured)
#' - Robust standard errors (sandwich estimator)
#' - Post-hoc pairwise comparisons
#' - Model selection with QIC
#' 
#' **Clinical Applications:**
#' - Multiple samples per patient
#' - Bilateral organs (eyes, kidneys)
#' - Repeated measures over time
#' - Multi-site studies
#' - Clustered randomized trials
#' 
#'
#' @examples
#' # Example: Multiple liver samples per dog
#' geemodel(
#'   data = liver_data,
#'   outcome = 'diagnosis',
#'   predictors = c('sample_method', 'fibrosis_score'),
#'   cluster_id = 'dog_id',
#'   family = 'binomial',
#'   corstr = 'exchangeable',
#'   robust_se = TRUE
#' )
#'
#' @param data the data as a data frame
#' @param outcome outcome variable (dependent variable); can be continuous,
#'   binary, or count
#' @param predictors predictor variables (independent variables) for the model
#' @param cluster_id variable identifying clusters (e.g., patient ID, dog ID).
#'   Observations with the same ID are treated as correlated.
#' @param time_var for longitudinal data, specifies time ordering within
#'   clusters. Used with AR(1) correlation structure.
#' @param family distribution family and link function for the outcome
#'   variable. Gaussian for continuous, Binomial for binary, Poisson for counts.
#' @param corstr Working correlation structure within clusters: -
#'   Exchangeable: constant correlation between all pairs (recommended starting
#'   point) - AR(1): correlation decays with time lag (for longitudinal data) -
#'   Unstructured: estimates all pairwise correlations (requires many
#'   observations) - Independence: no correlation (equivalent to GLM)
#' @param robust_se sandwich estimator for standard errors (recommended).
#'   Provides valid inference even if correlation structure is misspecified.
#' @param conf_level confidence level for confidence intervals (default 95\%)
#' @param qic Quasi-likelihood under Independence Model Criterion. Lower QIC
#'   indicates better model fit. Use for comparing models.
#' @param posthoc compare levels of categorical predictors using estimated
#'   marginal means
#' @param posthoc_adjust multiple testing correction for post-hoc comparisons
#' @param diagnostics display model diagnostics including number of clusters,
#'   observations per cluster
#' @param correlation_plot visualize the estimated within-cluster correlation
#'   structure
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelInfo} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$coefficientsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$qicTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$posthocTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$diagnosticsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$correlationPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$methodologyNote} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$interpretationNote} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelInfo$asDF}
#'
#' \code{as.data.frame(results$modelInfo)}
#'
#' @export
geemodel <- function(
    data,
    outcome,
    predictors,
    cluster_id,
    time_var,
    family = "gaussian",
    corstr = "exchangeable",
    robust_se = TRUE,
    conf_level = 0.95,
    qic = TRUE,
    posthoc = FALSE,
    posthoc_adjust = "holm",
    diagnostics = TRUE,
    correlation_plot = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("geemodel requires jmvcore to be installed (restart may be required)")

    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(predictors)) predictors <- jmvcore::resolveQuo(jmvcore::enquo(predictors))
    if ( ! missing(cluster_id)) cluster_id <- jmvcore::resolveQuo(jmvcore::enquo(cluster_id))
    if ( ! missing(time_var)) time_var <- jmvcore::resolveQuo(jmvcore::enquo(time_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(predictors), predictors, NULL),
            `if`( ! missing(cluster_id), cluster_id, NULL),
            `if`( ! missing(time_var), time_var, NULL))


    options <- geemodelOptions$new(
        outcome = outcome,
        predictors = predictors,
        cluster_id = cluster_id,
        time_var = time_var,
        family = family,
        corstr = corstr,
        robust_se = robust_se,
        conf_level = conf_level,
        qic = qic,
        posthoc = posthoc,
        posthoc_adjust = posthoc_adjust,
        diagnostics = diagnostics,
        correlation_plot = correlation_plot)

    analysis <- geemodelClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

