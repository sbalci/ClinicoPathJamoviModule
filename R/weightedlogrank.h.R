
# This file is automatically generated, you probably don't want to edit this

weightedlogrankOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "weightedlogrankOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            outcome = NULL,
            explanatory = NULL,
            outcomeLevel = "1",
            gehan_wilcoxon = TRUE,
            tarone_ware = TRUE,
            peto_peto = TRUE,
            modified_peto = FALSE,
            standard_logrank = TRUE,
            multiple_comparison = "holm",
            confidence_level = 0.95,
            show_kaplan_meier = TRUE,
            show_weight_functions = FALSE,
            show_test_statistics = FALSE,
            show_sample_sizes = TRUE,
            show_events = TRUE,
            median_survival = TRUE,
            showSummaries = FALSE,
            showExplanations = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="weightedlogrank",
                requiresData=TRUE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..explanatory <- jmvcore::OptionVariable$new(
                "explanatory",
                explanatory,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..outcomeLevel <- jmvcore::OptionString$new(
                "outcomeLevel",
                outcomeLevel,
                default="1")
            private$..gehan_wilcoxon <- jmvcore::OptionBool$new(
                "gehan_wilcoxon",
                gehan_wilcoxon,
                default=TRUE)
            private$..tarone_ware <- jmvcore::OptionBool$new(
                "tarone_ware",
                tarone_ware,
                default=TRUE)
            private$..peto_peto <- jmvcore::OptionBool$new(
                "peto_peto",
                peto_peto,
                default=TRUE)
            private$..modified_peto <- jmvcore::OptionBool$new(
                "modified_peto",
                modified_peto,
                default=FALSE)
            private$..standard_logrank <- jmvcore::OptionBool$new(
                "standard_logrank",
                standard_logrank,
                default=TRUE)
            private$..multiple_comparison <- jmvcore::OptionString$new(
                "multiple_comparison",
                multiple_comparison,
                default="holm")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..show_kaplan_meier <- jmvcore::OptionBool$new(
                "show_kaplan_meier",
                show_kaplan_meier,
                default=TRUE)
            private$..show_weight_functions <- jmvcore::OptionBool$new(
                "show_weight_functions",
                show_weight_functions,
                default=FALSE)
            private$..show_test_statistics <- jmvcore::OptionBool$new(
                "show_test_statistics",
                show_test_statistics,
                default=FALSE)
            private$..show_sample_sizes <- jmvcore::OptionBool$new(
                "show_sample_sizes",
                show_sample_sizes,
                default=TRUE)
            private$..show_events <- jmvcore::OptionBool$new(
                "show_events",
                show_events,
                default=TRUE)
            private$..median_survival <- jmvcore::OptionBool$new(
                "median_survival",
                median_survival,
                default=TRUE)
            private$..showSummaries <- jmvcore::OptionBool$new(
                "showSummaries",
                showSummaries,
                default=FALSE)
            private$..showExplanations <- jmvcore::OptionBool$new(
                "showExplanations",
                showExplanations,
                default=FALSE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..outcome)
            self$.addOption(private$..explanatory)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..gehan_wilcoxon)
            self$.addOption(private$..tarone_ware)
            self$.addOption(private$..peto_peto)
            self$.addOption(private$..modified_peto)
            self$.addOption(private$..standard_logrank)
            self$.addOption(private$..multiple_comparison)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..show_kaplan_meier)
            self$.addOption(private$..show_weight_functions)
            self$.addOption(private$..show_test_statistics)
            self$.addOption(private$..show_sample_sizes)
            self$.addOption(private$..show_events)
            self$.addOption(private$..median_survival)
            self$.addOption(private$..showSummaries)
            self$.addOption(private$..showExplanations)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        outcome = function() private$..outcome$value,
        explanatory = function() private$..explanatory$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        gehan_wilcoxon = function() private$..gehan_wilcoxon$value,
        tarone_ware = function() private$..tarone_ware$value,
        peto_peto = function() private$..peto_peto$value,
        modified_peto = function() private$..modified_peto$value,
        standard_logrank = function() private$..standard_logrank$value,
        multiple_comparison = function() private$..multiple_comparison$value,
        confidence_level = function() private$..confidence_level$value,
        show_kaplan_meier = function() private$..show_kaplan_meier$value,
        show_weight_functions = function() private$..show_weight_functions$value,
        show_test_statistics = function() private$..show_test_statistics$value,
        show_sample_sizes = function() private$..show_sample_sizes$value,
        show_events = function() private$..show_events$value,
        median_survival = function() private$..median_survival$value,
        showSummaries = function() private$..showSummaries$value,
        showExplanations = function() private$..showExplanations$value),
    private = list(
        ..elapsedtime = NA,
        ..outcome = NA,
        ..explanatory = NA,
        ..outcomeLevel = NA,
        ..gehan_wilcoxon = NA,
        ..tarone_ware = NA,
        ..peto_peto = NA,
        ..modified_peto = NA,
        ..standard_logrank = NA,
        ..multiple_comparison = NA,
        ..confidence_level = NA,
        ..show_kaplan_meier = NA,
        ..show_weight_functions = NA,
        ..show_test_statistics = NA,
        ..show_sample_sizes = NA,
        ..show_events = NA,
        ..median_survival = NA,
        ..showSummaries = NA,
        ..showExplanations = NA)
)

weightedlogrankResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "weightedlogrankResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        groupSummary = function() private$.items[["groupSummary"]],
        weightedTestsTable = function() private$.items[["weightedTestsTable"]],
        survivalPlot = function() private$.items[["survivalPlot"]],
        weightFunctionsPlot = function() private$.items[["weightFunctionsPlot"]],
        testStatisticsPlot = function() private$.items[["testStatisticsPlot"]],
        analysisSummary = function() private$.items[["analysisSummary"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Weighted Log-Rank Tests",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="groupSummary",
                title="Group Summary",
                visible="(show_sample_sizes || show_events || median_survival)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="weightedTestsTable",
                title="Weighted Log-Rank Test Results",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="test_name", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="chi_square", 
                        `title`="\u03C7\u00B2", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p_value", 
                        `title`="p", 
                        `type`="number"),
                    list(
                        `name`="p_adjusted", 
                        `title`="Adjusted p", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlot",
                title="Kaplan-Meier Survival Curves",
                visible="(show_kaplan_meier)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="weightFunctionsPlot",
                title="Weight Functions",
                visible="(show_weight_functions)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="testStatisticsPlot",
                title="Test Statistics Evolution",
                visible="(show_test_statistics)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="analysisSummary",
                title="Analysis Summary",
                visible="(showSummaries)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Methodology",
                visible="(showExplanations)"))}))

weightedlogrankBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "weightedlogrankBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "weightedlogrank",
                version = c(0,0,31),
                options = options,
                results = weightedlogrankResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Weighted Log-Rank Tests
#'
#' Performs weighted log-rank tests for comparing survival distributions 
#' between groups. These tests provide enhanced power for detecting 
#' differences at specific time points using various weighting schemes. 
#' Includes Gehan-Wilcoxon, Tarone-Ware, Peto-Peto, and custom weight function 
#' approaches for comprehensive survival comparison.
#'
#' @examples
#' # example will be added
#'
#' @param data The data as a data frame.
#' @param elapsedtime Time variable for survival analysis
#' @param outcome Event indicator variable
#' @param explanatory Grouping variable for comparison
#' @param outcomeLevel Level of outcome variable indicating event
#' @param gehan_wilcoxon Perform Gehan-Wilcoxon weighted test
#' @param tarone_ware Perform Tarone-Ware weighted test
#' @param peto_peto Perform Peto-Peto weighted test
#' @param modified_peto Perform Modified Peto weighted test
#' @param standard_logrank Include standard unweighted log-rank test
#' @param multiple_comparison Method for multiple comparison adjustment
#' @param confidence_level Confidence level for intervals
#' @param show_kaplan_meier Display Kaplan-Meier survival curves
#' @param show_weight_functions Display weight function plots
#' @param show_test_statistics Plot test statistics over time
#' @param show_sample_sizes Display sample sizes by group
#' @param show_events Display event counts by group
#' @param median_survival Display median survival times by group
#' @param showSummaries Generate natural language summaries
#' @param showExplanations Show methodology explanations
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$groupSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$weightedTestsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$survivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$weightFunctionsPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$testStatisticsPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$analysisSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$weightedTestsTable$asDF}
#'
#' \code{as.data.frame(results$weightedTestsTable)}
#'
#' @export
weightedlogrank <- function(
    data,
    elapsedtime,
    outcome,
    explanatory,
    outcomeLevel = "1",
    gehan_wilcoxon = TRUE,
    tarone_ware = TRUE,
    peto_peto = TRUE,
    modified_peto = FALSE,
    standard_logrank = TRUE,
    multiple_comparison = "holm",
    confidence_level = 0.95,
    show_kaplan_meier = TRUE,
    show_weight_functions = FALSE,
    show_test_statistics = FALSE,
    show_sample_sizes = TRUE,
    show_events = TRUE,
    median_survival = TRUE,
    showSummaries = FALSE,
    showExplanations = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("weightedlogrank requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(explanatory)) explanatory <- jmvcore::resolveQuo(jmvcore::enquo(explanatory))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(elapsedtime), elapsedtime, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(explanatory), explanatory, NULL))


    options <- weightedlogrankOptions$new(
        elapsedtime = elapsedtime,
        outcome = outcome,
        explanatory = explanatory,
        outcomeLevel = outcomeLevel,
        gehan_wilcoxon = gehan_wilcoxon,
        tarone_ware = tarone_ware,
        peto_peto = peto_peto,
        modified_peto = modified_peto,
        standard_logrank = standard_logrank,
        multiple_comparison = multiple_comparison,
        confidence_level = confidence_level,
        show_kaplan_meier = show_kaplan_meier,
        show_weight_functions = show_weight_functions,
        show_test_statistics = show_test_statistics,
        show_sample_sizes = show_sample_sizes,
        show_events = show_events,
        median_survival = median_survival,
        showSummaries = showSummaries,
        showExplanations = showExplanations)

    analysis <- weightedlogrankClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

