
# This file is automatically generated, you probably don't want to edit this

excessmortalityOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "excessmortalityOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            timeVar = NULL,
            statusVar = NULL,
            ageVar = NULL,
            sexVar = NULL,
            covariates = NULL,
            expectedRate = "population",
            splineType = "bs",
            nknots = 4,
            degree = 3,
            confidenceLevel = 95,
            plotHazard = TRUE,
            plotSurvival = TRUE,
            plotCumHazard = FALSE,
            timePoints = "1,2,3,5,10", ...) {

            super$initialize(
                package="ClinicoPath",
                name="excessmortality",
                requiresData=TRUE,
                ...)

            private$..timeVar <- jmvcore::OptionVariable$new(
                "timeVar",
                timeVar,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..statusVar <- jmvcore::OptionVariable$new(
                "statusVar",
                statusVar,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..ageVar <- jmvcore::OptionVariable$new(
                "ageVar",
                ageVar,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..sexVar <- jmvcore::OptionVariable$new(
                "sexVar",
                sexVar,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..expectedRate <- jmvcore::OptionList$new(
                "expectedRate",
                expectedRate,
                options=list(
                    "population",
                    "custom",
                    "internal"),
                default="population")
            private$..splineType <- jmvcore::OptionList$new(
                "splineType",
                splineType,
                options=list(
                    "bs",
                    "ns",
                    "tprs"),
                default="bs")
            private$..nknots <- jmvcore::OptionNumber$new(
                "nknots",
                nknots,
                min=1,
                max=10,
                default=4)
            private$..degree <- jmvcore::OptionNumber$new(
                "degree",
                degree,
                min=1,
                max=5,
                default=3)
            private$..confidenceLevel <- jmvcore::OptionNumber$new(
                "confidenceLevel",
                confidenceLevel,
                min=90,
                max=99.9,
                default=95)
            private$..plotHazard <- jmvcore::OptionBool$new(
                "plotHazard",
                plotHazard,
                default=TRUE)
            private$..plotSurvival <- jmvcore::OptionBool$new(
                "plotSurvival",
                plotSurvival,
                default=TRUE)
            private$..plotCumHazard <- jmvcore::OptionBool$new(
                "plotCumHazard",
                plotCumHazard,
                default=FALSE)
            private$..timePoints <- jmvcore::OptionString$new(
                "timePoints",
                timePoints,
                default="1,2,3,5,10")

            self$.addOption(private$..timeVar)
            self$.addOption(private$..statusVar)
            self$.addOption(private$..ageVar)
            self$.addOption(private$..sexVar)
            self$.addOption(private$..covariates)
            self$.addOption(private$..expectedRate)
            self$.addOption(private$..splineType)
            self$.addOption(private$..nknots)
            self$.addOption(private$..degree)
            self$.addOption(private$..confidenceLevel)
            self$.addOption(private$..plotHazard)
            self$.addOption(private$..plotSurvival)
            self$.addOption(private$..plotCumHazard)
            self$.addOption(private$..timePoints)
        }),
    active = list(
        timeVar = function() private$..timeVar$value,
        statusVar = function() private$..statusVar$value,
        ageVar = function() private$..ageVar$value,
        sexVar = function() private$..sexVar$value,
        covariates = function() private$..covariates$value,
        expectedRate = function() private$..expectedRate$value,
        splineType = function() private$..splineType$value,
        nknots = function() private$..nknots$value,
        degree = function() private$..degree$value,
        confidenceLevel = function() private$..confidenceLevel$value,
        plotHazard = function() private$..plotHazard$value,
        plotSurvival = function() private$..plotSurvival$value,
        plotCumHazard = function() private$..plotCumHazard$value,
        timePoints = function() private$..timePoints$value),
    private = list(
        ..timeVar = NA,
        ..statusVar = NA,
        ..ageVar = NA,
        ..sexVar = NA,
        ..covariates = NA,
        ..expectedRate = NA,
        ..splineType = NA,
        ..nknots = NA,
        ..degree = NA,
        ..confidenceLevel = NA,
        ..plotHazard = NA,
        ..plotSurvival = NA,
        ..plotCumHazard = NA,
        ..timePoints = NA)
)

excessmortalityResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "excessmortalityResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        modelSummary = function() private$.items[["modelSummary"]],
        coefficients = function() private$.items[["coefficients"]],
        predictions = function() private$.items[["predictions"]],
        goodnessOfFit = function() private$.items[["goodnessOfFit"]],
        hazardPlot = function() private$.items[["hazardPlot"]],
        survivalPlot = function() private$.items[["survivalPlot"]],
        cumHazardPlot = function() private$.items[["cumHazardPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Excess Mortality Analysis",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="coefficients",
                title="Model Coefficients",
                visible="(covariates)",
                columns=list(
                    list(
                        `name`="term", 
                        `title`="Term", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="z_value", 
                        `title`="z value", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="predictions",
                title="Excess Mortality Predictions",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="time", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="excess_hazard", 
                        `title`="Excess Hazard", 
                        `type`="number"),
                    list(
                        `name`="excess_survival", 
                        `title`="Excess Survival", 
                        `type`="number"),
                    list(
                        `name`="ci_hazard_lower", 
                        `title`="Hazard CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_hazard_upper", 
                        `title`="Hazard CI Upper", 
                        `type`="number"),
                    list(
                        `name`="ci_survival_lower", 
                        `title`="Survival CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_survival_upper", 
                        `title`="Survival CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="goodnessOfFit",
                title="Goodness of Fit",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="hazardPlot",
                title="Excess Hazard Function",
                visible="(plotHazard)",
                width=600,
                height=400,
                renderFun=".hazardPlot"))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlot",
                title="Excess Survival Function",
                visible="(plotSurvival)",
                width=600,
                height=400,
                renderFun=".survivalPlot"))
            self$add(jmvcore::Image$new(
                options=options,
                name="cumHazardPlot",
                title="Cumulative Excess Hazard",
                visible="(plotCumHazard)",
                width=600,
                height=400,
                renderFun=".cumHazardPlot"))}))

excessmortalityBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "excessmortalityBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "excessmortality",
                version = c(1,0,0),
                options = options,
                results = excessmortalityResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Excess Mortality Analysis
#'
#' 
#' @param data .
#' @param timeVar .
#' @param statusVar .
#' @param ageVar .
#' @param sexVar .
#' @param covariates .
#' @param expectedRate .
#' @param splineType .
#' @param nknots .
#' @param degree .
#' @param confidenceLevel .
#' @param plotHazard .
#' @param plotSurvival .
#' @param plotCumHazard .
#' @param timePoints .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$coefficients} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$predictions} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$goodnessOfFit} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$hazardPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$survivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$cumHazardPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelSummary$asDF}
#'
#' \code{as.data.frame(results$modelSummary)}
#'
#' @export
excessmortality <- function(
    data,
    timeVar,
    statusVar,
    ageVar,
    sexVar,
    covariates,
    expectedRate = "population",
    splineType = "bs",
    nknots = 4,
    degree = 3,
    confidenceLevel = 95,
    plotHazard = TRUE,
    plotSurvival = TRUE,
    plotCumHazard = FALSE,
    timePoints = "1,2,3,5,10") {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("excessmortality requires jmvcore to be installed (restart may be required)")

    if ( ! missing(timeVar)) timeVar <- jmvcore::resolveQuo(jmvcore::enquo(timeVar))
    if ( ! missing(statusVar)) statusVar <- jmvcore::resolveQuo(jmvcore::enquo(statusVar))
    if ( ! missing(ageVar)) ageVar <- jmvcore::resolveQuo(jmvcore::enquo(ageVar))
    if ( ! missing(sexVar)) sexVar <- jmvcore::resolveQuo(jmvcore::enquo(sexVar))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(timeVar), timeVar, NULL),
            `if`( ! missing(statusVar), statusVar, NULL),
            `if`( ! missing(ageVar), ageVar, NULL),
            `if`( ! missing(sexVar), sexVar, NULL),
            `if`( ! missing(covariates), covariates, NULL))

    for (v in sexVar) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- excessmortalityOptions$new(
        timeVar = timeVar,
        statusVar = statusVar,
        ageVar = ageVar,
        sexVar = sexVar,
        covariates = covariates,
        expectedRate = expectedRate,
        splineType = splineType,
        nknots = nknots,
        degree = degree,
        confidenceLevel = confidenceLevel,
        plotHazard = plotHazard,
        plotSurvival = plotSurvival,
        plotCumHazard = plotCumHazard,
        timePoints = timePoints)

    analysis <- excessmortalityClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

