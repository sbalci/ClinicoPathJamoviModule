
# This file is automatically generated, you probably don't want to edit this

penalizedcoxregressionOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "penalizedcoxregressionOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            status = NULL,
            predictors = NULL,
            penaltyType = "lasso",
            alphaValue = 0.5,
            crossValidation = TRUE,
            cvFolds = 10,
            lambdaSelection = "lambda.1se",
            customLambda = 0.01,
            standardize = TRUE,
            plotCoefficientPath = TRUE,
            plotCrossValidation = TRUE,
            variableSelection = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="penalizedcoxregression",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..status <- jmvcore::OptionVariable$new(
                "status",
                status,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..predictors <- jmvcore::OptionVariables$new(
                "predictors",
                predictors,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..penaltyType <- jmvcore::OptionList$new(
                "penaltyType",
                penaltyType,
                options=list(
                    "lasso",
                    "ridge",
                    "elastic_net",
                    "adaptive_lasso"),
                default="lasso")
            private$..alphaValue <- jmvcore::OptionNumber$new(
                "alphaValue",
                alphaValue,
                min=0,
                max=1,
                default=0.5)
            private$..crossValidation <- jmvcore::OptionBool$new(
                "crossValidation",
                crossValidation,
                default=TRUE)
            private$..cvFolds <- jmvcore::OptionInteger$new(
                "cvFolds",
                cvFolds,
                min=3,
                max=20,
                default=10)
            private$..lambdaSelection <- jmvcore::OptionList$new(
                "lambdaSelection",
                lambdaSelection,
                options=list(
                    "lambda.min",
                    "lambda.1se",
                    "custom"),
                default="lambda.1se")
            private$..customLambda <- jmvcore::OptionNumber$new(
                "customLambda",
                customLambda,
                min=0.0001,
                max=100,
                default=0.01)
            private$..standardize <- jmvcore::OptionBool$new(
                "standardize",
                standardize,
                default=TRUE)
            private$..plotCoefficientPath <- jmvcore::OptionBool$new(
                "plotCoefficientPath",
                plotCoefficientPath,
                default=TRUE)
            private$..plotCrossValidation <- jmvcore::OptionBool$new(
                "plotCrossValidation",
                plotCrossValidation,
                default=TRUE)
            private$..variableSelection <- jmvcore::OptionBool$new(
                "variableSelection",
                variableSelection,
                default=TRUE)

            self$.addOption(private$..time)
            self$.addOption(private$..status)
            self$.addOption(private$..predictors)
            self$.addOption(private$..penaltyType)
            self$.addOption(private$..alphaValue)
            self$.addOption(private$..crossValidation)
            self$.addOption(private$..cvFolds)
            self$.addOption(private$..lambdaSelection)
            self$.addOption(private$..customLambda)
            self$.addOption(private$..standardize)
            self$.addOption(private$..plotCoefficientPath)
            self$.addOption(private$..plotCrossValidation)
            self$.addOption(private$..variableSelection)
        }),
    active = list(
        time = function() private$..time$value,
        status = function() private$..status$value,
        predictors = function() private$..predictors$value,
        penaltyType = function() private$..penaltyType$value,
        alphaValue = function() private$..alphaValue$value,
        crossValidation = function() private$..crossValidation$value,
        cvFolds = function() private$..cvFolds$value,
        lambdaSelection = function() private$..lambdaSelection$value,
        customLambda = function() private$..customLambda$value,
        standardize = function() private$..standardize$value,
        plotCoefficientPath = function() private$..plotCoefficientPath$value,
        plotCrossValidation = function() private$..plotCrossValidation$value,
        variableSelection = function() private$..variableSelection$value),
    private = list(
        ..time = NA,
        ..status = NA,
        ..predictors = NA,
        ..penaltyType = NA,
        ..alphaValue = NA,
        ..crossValidation = NA,
        ..cvFolds = NA,
        ..lambdaSelection = NA,
        ..customLambda = NA,
        ..standardize = NA,
        ..plotCoefficientPath = NA,
        ..plotCrossValidation = NA,
        ..variableSelection = NA)
)

penalizedcoxregressionResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "penalizedcoxregressionResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        modelSummary = function() private$.items[["modelSummary"]],
        selectedVariables = function() private$.items[["selectedVariables"]],
        crossValidationResults = function() private$.items[["crossValidationResults"]],
        penaltyPath = function() private$.items[["penaltyPath"]],
        coefficientPath = function() private$.items[["coefficientPath"]],
        crossValidationPlot = function() private$.items[["crossValidationPlot"]],
        analysisReport = function() private$.items[["analysisReport"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Penalized Cox Regression")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="selectedVariables",
                title="Selected Variables",
                visible="(variableSelection)",
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="coefficient", 
                        `title`="Coefficient", 
                        `type`="number"),
                    list(
                        `name`="hazard_ratio", 
                        `title`="Hazard Ratio", 
                        `type`="number"),
                    list(
                        `name`="importance", 
                        `title`="Importance Score", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="crossValidationResults",
                title="Cross-Validation Results",
                visible="(crossValidation)",
                columns=list(
                    list(
                        `name`="lambda", 
                        `title`="Lambda", 
                        `type`="number"),
                    list(
                        `name`="cv_error", 
                        `title`="CV Error", 
                        `type`="number"),
                    list(
                        `name`="cv_se", 
                        `title`="CV SE", 
                        `type`="number"),
                    list(
                        `name`="n_variables", 
                        `title`="Number of Variables", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="penaltyPath",
                title="Regularization Path",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="step", 
                        `title`="Step", 
                        `type`="integer"),
                    list(
                        `name`="lambda", 
                        `title`="Lambda", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="Degrees of Freedom", 
                        `type`="number"),
                    list(
                        `name`="dev_ratio", 
                        `title`="Deviance Ratio", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="coefficientPath",
                title="Coefficient Path Plot",
                visible="(plotCoefficientPath)",
                width=700,
                height=500,
                renderFun=".coefficientPath"))
            self$add(jmvcore::Image$new(
                options=options,
                name="crossValidationPlot",
                title="Cross-Validation Plot",
                visible="(plotCrossValidation && crossValidation)",
                width=600,
                height=400,
                renderFun=".crossValidationPlot"))
            self$add(jmvcore::Html$new(
                options=options,
                name="analysisReport",
                title="Analysis Report",
                visible=TRUE))}))

penalizedcoxregressionBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "penalizedcoxregressionBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "penalizedcoxregression",
                version = c(1,0,0),
                options = options,
                results = penalizedcoxregressionResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Penalized Cox Regression
#'
#' Performs penalized Cox proportional hazards regression for high-dimensional 
#' survival data using L1 (LASSO), L2 (Ridge), and Elastic Net regularization.
#' This method is particularly useful when the number of covariates approaches
#' or exceeds the number of observations, or when variable selection is 
#' needed.
#' 
#' Key features:
#' - LASSO (L1) regularization for automatic variable selection
#' - Ridge (L2) regularization for correlated predictors
#' - Elastic Net combining L1 and L2 penalties
#' - Cross-validation for optimal penalty parameter selection
#' - Coefficient path visualization across penalty values
#' - Variable importance ranking and selection
#' - High-dimensional survival analysis capabilities
#' 
#'
#' @examples
#' # Penalized Cox regression with LASSO
#' penalizedcoxregression(
#'     data = data,
#'     time = "time",
#'     status = "status",
#'     predictors = c("age", "gene1", "gene2", "treatment"),
#'     penaltyType = "lasso",
#'     crossValidation = TRUE
#' )
#'
#' @param data the data as a data frame
#' @param time the time variable for survival analysis
#' @param status the status variable (0 = censored, 1 = event)
#' @param predictors predictor variables for the penalized Cox model
#' @param penaltyType the type of penalty to apply in regularization
#' @param alphaValue mixing parameter for elastic net (0 = ridge, 1 = lasso)
#' @param crossValidation whether to use cross-validation for penalty
#'   parameter selection
#' @param cvFolds number of folds for cross-validation
#' @param lambdaSelection criterion for selecting the regularization parameter
#' @param customLambda custom lambda value when using custom selection
#' @param standardize whether to standardize predictor variables
#' @param plotCoefficientPath whether to plot coefficient paths across lambda
#'   values
#' @param plotCrossValidation whether to plot cross-validation error curves
#' @param variableSelection whether to output selected variables and their
#'   importance
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$selectedVariables} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$crossValidationResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$penaltyPath} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$coefficientPath} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$crossValidationPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$analysisReport} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelSummary$asDF}
#'
#' \code{as.data.frame(results$modelSummary)}
#'
#' @export
penalizedcoxregression <- function(
    data,
    time,
    status,
    predictors,
    penaltyType = "lasso",
    alphaValue = 0.5,
    crossValidation = TRUE,
    cvFolds = 10,
    lambdaSelection = "lambda.1se",
    customLambda = 0.01,
    standardize = TRUE,
    plotCoefficientPath = TRUE,
    plotCrossValidation = TRUE,
    variableSelection = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("penalizedcoxregression requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(status)) status <- jmvcore::resolveQuo(jmvcore::enquo(status))
    if ( ! missing(predictors)) predictors <- jmvcore::resolveQuo(jmvcore::enquo(predictors))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(status), status, NULL),
            `if`( ! missing(predictors), predictors, NULL))

    for (v in status) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- penalizedcoxregressionOptions$new(
        time = time,
        status = status,
        predictors = predictors,
        penaltyType = penaltyType,
        alphaValue = alphaValue,
        crossValidation = crossValidation,
        cvFolds = cvFolds,
        lambdaSelection = lambdaSelection,
        customLambda = customLambda,
        standardize = standardize,
        plotCoefficientPath = plotCoefficientPath,
        plotCrossValidation = plotCrossValidation,
        variableSelection = variableSelection)

    analysis <- penalizedcoxregressionClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

