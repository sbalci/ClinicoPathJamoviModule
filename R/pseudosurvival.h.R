
# This file is automatically generated, you probably don't want to edit this

pseudosurvivalOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "pseudosurvivalOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time_var = NULL,
            status_var = NULL,
            covariates = NULL,
            stratification_vars = NULL,
            analysis_type = "survival_probability",
            time_points = "12,24,36,60",
            tau_rmst = 60,
            quantile_probs = "0.25,0.5,0.75",
            jackknife_method = "standard",
            regression_method = "ols",
            cluster_var = NULL,
            confidence_level = 0.95,
            bootstrap_samples = 500,
            robust_se = FALSE,
            model_diagnostics = TRUE,
            prediction_intervals = FALSE,
            survival_curves = TRUE,
            rmst_comparison = TRUE,
            sensitivity_analysis = FALSE,
            competing_risks = FALSE,
            weighted_analysis = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="pseudosurvival",
                requiresData=FALSE,
                ...)

            private$..time_var <- jmvcore::OptionVariable$new(
                "time_var",
                time_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..status_var <- jmvcore::OptionVariable$new(
                "status_var",
                status_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..stratification_vars <- jmvcore::OptionVariables$new(
                "stratification_vars",
                stratification_vars,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..analysis_type <- jmvcore::OptionList$new(
                "analysis_type",
                analysis_type,
                options=list(
                    "survival_probability",
                    "rmst_regression",
                    "cumulative_incidence",
                    "life_years_lost",
                    "quantile_regression"),
                default="survival_probability")
            private$..time_points <- jmvcore::OptionString$new(
                "time_points",
                time_points,
                default="12,24,36,60")
            private$..tau_rmst <- jmvcore::OptionNumber$new(
                "tau_rmst",
                tau_rmst,
                default=60,
                min=1,
                max=1000)
            private$..quantile_probs <- jmvcore::OptionString$new(
                "quantile_probs",
                quantile_probs,
                default="0.25,0.5,0.75")
            private$..jackknife_method <- jmvcore::OptionList$new(
                "jackknife_method",
                jackknife_method,
                options=list(
                    "standard",
                    "robust",
                    "cluster_jackknife"),
                default="standard")
            private$..regression_method <- jmvcore::OptionList$new(
                "regression_method",
                regression_method,
                options=list(
                    "ols",
                    "gee",
                    "robust",
                    "weighted"),
                default="ols")
            private$..cluster_var <- jmvcore::OptionVariable$new(
                "cluster_var",
                cluster_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "id"),
                default=NULL)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.8,
                max=0.99)
            private$..bootstrap_samples <- jmvcore::OptionInteger$new(
                "bootstrap_samples",
                bootstrap_samples,
                default=500,
                min=100,
                max=2000)
            private$..robust_se <- jmvcore::OptionBool$new(
                "robust_se",
                robust_se,
                default=FALSE)
            private$..model_diagnostics <- jmvcore::OptionBool$new(
                "model_diagnostics",
                model_diagnostics,
                default=TRUE)
            private$..prediction_intervals <- jmvcore::OptionBool$new(
                "prediction_intervals",
                prediction_intervals,
                default=FALSE)
            private$..survival_curves <- jmvcore::OptionBool$new(
                "survival_curves",
                survival_curves,
                default=TRUE)
            private$..rmst_comparison <- jmvcore::OptionBool$new(
                "rmst_comparison",
                rmst_comparison,
                default=TRUE)
            private$..sensitivity_analysis <- jmvcore::OptionBool$new(
                "sensitivity_analysis",
                sensitivity_analysis,
                default=FALSE)
            private$..competing_risks <- jmvcore::OptionBool$new(
                "competing_risks",
                competing_risks,
                default=FALSE)
            private$..weighted_analysis <- jmvcore::OptionBool$new(
                "weighted_analysis",
                weighted_analysis,
                default=FALSE)

            self$.addOption(private$..time_var)
            self$.addOption(private$..status_var)
            self$.addOption(private$..covariates)
            self$.addOption(private$..stratification_vars)
            self$.addOption(private$..analysis_type)
            self$.addOption(private$..time_points)
            self$.addOption(private$..tau_rmst)
            self$.addOption(private$..quantile_probs)
            self$.addOption(private$..jackknife_method)
            self$.addOption(private$..regression_method)
            self$.addOption(private$..cluster_var)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..bootstrap_samples)
            self$.addOption(private$..robust_se)
            self$.addOption(private$..model_diagnostics)
            self$.addOption(private$..prediction_intervals)
            self$.addOption(private$..survival_curves)
            self$.addOption(private$..rmst_comparison)
            self$.addOption(private$..sensitivity_analysis)
            self$.addOption(private$..competing_risks)
            self$.addOption(private$..weighted_analysis)
        }),
    active = list(
        time_var = function() private$..time_var$value,
        status_var = function() private$..status_var$value,
        covariates = function() private$..covariates$value,
        stratification_vars = function() private$..stratification_vars$value,
        analysis_type = function() private$..analysis_type$value,
        time_points = function() private$..time_points$value,
        tau_rmst = function() private$..tau_rmst$value,
        quantile_probs = function() private$..quantile_probs$value,
        jackknife_method = function() private$..jackknife_method$value,
        regression_method = function() private$..regression_method$value,
        cluster_var = function() private$..cluster_var$value,
        confidence_level = function() private$..confidence_level$value,
        bootstrap_samples = function() private$..bootstrap_samples$value,
        robust_se = function() private$..robust_se$value,
        model_diagnostics = function() private$..model_diagnostics$value,
        prediction_intervals = function() private$..prediction_intervals$value,
        survival_curves = function() private$..survival_curves$value,
        rmst_comparison = function() private$..rmst_comparison$value,
        sensitivity_analysis = function() private$..sensitivity_analysis$value,
        competing_risks = function() private$..competing_risks$value,
        weighted_analysis = function() private$..weighted_analysis$value),
    private = list(
        ..time_var = NA,
        ..status_var = NA,
        ..covariates = NA,
        ..stratification_vars = NA,
        ..analysis_type = NA,
        ..time_points = NA,
        ..tau_rmst = NA,
        ..quantile_probs = NA,
        ..jackknife_method = NA,
        ..regression_method = NA,
        ..cluster_var = NA,
        ..confidence_level = NA,
        ..bootstrap_samples = NA,
        ..robust_se = NA,
        ..model_diagnostics = NA,
        ..prediction_intervals = NA,
        ..survival_curves = NA,
        ..rmst_comparison = NA,
        ..sensitivity_analysis = NA,
        ..competing_risks = NA,
        ..weighted_analysis = NA)
)

pseudosurvivalResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "pseudosurvivalResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        pseudo_summary = function() private$.items[["pseudo_summary"]],
        regression_results = function() private$.items[["regression_results"]],
        covariate_effects = function() private$.items[["covariate_effects"]],
        rmst_analysis = function() private$.items[["rmst_analysis"]],
        survival_probability_results = function() private$.items[["survival_probability_results"]],
        group_comparisons = function() private$.items[["group_comparisons"]],
        model_diagnostics_summary = function() private$.items[["model_diagnostics_summary"]],
        sensitivity_results = function() private$.items[["sensitivity_results"]],
        pseudo_observations_plot = function() private$.items[["pseudo_observations_plot"]],
        regression_plots = function() private$.items[["regression_plots"]],
        survival_curves_plot = function() private$.items[["survival_curves_plot"]],
        rmst_comparison_plot = function() private$.items[["rmst_comparison_plot"]],
        diagnostics_plots = function() private$.items[["diagnostics_plots"]],
        sensitivity_plot = function() private$.items[["sensitivity_plot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Pseudo-Observations Survival Methods")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Analysis Instructions",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="pseudo_summary",
                title="Pseudo-Observations Summary",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="regression_results",
                title="Regression Analysis Results",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="covariate_effects",
                title="Covariate Effects",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="rmst_analysis",
                title="RMST Analysis",
                visible="(analysis_type == 'rmst_regression')"))
            self$add(jmvcore::Html$new(
                options=options,
                name="survival_probability_results",
                title="Survival Probability Results",
                visible="(analysis_type == 'survival_probability')"))
            self$add(jmvcore::Html$new(
                options=options,
                name="group_comparisons",
                title="Group Comparisons",
                visible="(rmst_comparison && analysis_type == 'rmst_regression')"))
            self$add(jmvcore::Html$new(
                options=options,
                name="model_diagnostics_summary",
                title="Model Diagnostics",
                visible="(model_diagnostics)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="sensitivity_results",
                title="Sensitivity Analysis",
                visible="(sensitivity_analysis)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="pseudo_observations_plot",
                title="Pseudo-Observations Distribution",
                width=800,
                height=600,
                renderFun=".plot_pseudo_observations",
                visible=TRUE,
                clearWith=list(
                    "time_var",
                    "status_var",
                    "analysis_type",
                    "time_points")))
            self$add(jmvcore::Image$new(
                options=options,
                name="regression_plots",
                title="Regression Analysis Plots",
                width=800,
                height=600,
                renderFun=".plot_regression",
                visible=TRUE,
                clearWith=list(
                    "covariates",
                    "analysis_type",
                    "regression_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="survival_curves_plot",
                title="Survival Probability Curves",
                width=800,
                height=600,
                renderFun=".plot_survival_curves",
                visible="(survival_curves)",
                clearWith=list(
                    "time_var",
                    "status_var",
                    "covariates",
                    "time_points")))
            self$add(jmvcore::Image$new(
                options=options,
                name="rmst_comparison_plot",
                title="RMST Comparison Plot",
                width=800,
                height=600,
                renderFun=".plot_rmst_comparison",
                visible="(rmst_comparison && analysis_type == 'rmst_regression')",
                clearWith=list(
                    "time_var",
                    "status_var",
                    "covariates",
                    "tau_rmst")))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagnostics_plots",
                title="Model Diagnostic Plots",
                width=800,
                height=600,
                renderFun=".plot_diagnostics",
                visible="(model_diagnostics)",
                clearWith=list(
                    "covariates",
                    "regression_method",
                    "robust_se")))
            self$add(jmvcore::Image$new(
                options=options,
                name="sensitivity_plot",
                title="Sensitivity Analysis Plot",
                width=800,
                height=600,
                renderFun=".plot_sensitivity",
                visible="(sensitivity_analysis)",
                clearWith=list(
                    "tau_rmst",
                    "analysis_type",
                    "covariates")))}))

pseudosurvivalBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "pseudosurvivalBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "pseudosurvival",
                version = c(0,0,3),
                options = options,
                results = pseudosurvivalResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'na')
        }))

#' Pseudo-Observations Survival Methods
#'
#' Pseudo-observations methods for direct modeling of survival probabilities 
#' and restricted mean survival time (RMST). Enables regression analysis of 
#' survival probability at specific time points and RMST with standard 
#' statistical methods.
#' 
#'
#' @examples
#' # Example: RMST regression with covariates
#' pseudosurvival(
#'     data = cancer_data,
#'     time_var = survival_time,
#'     status_var = death_status,
#'     covariates = c("age", "stage", "treatment"),
#'     analysis_type = "rmst_regression",
#'     tau_rmst = 60
#' )
#'
#' @param time_var Survival time variable
#' @param status_var Event status indicator variable
#' @param covariates Covariates to include in the pseudo-regression model
#' @param stratification_vars Variables for stratifying the analysis
#' @param analysis_type Analysis approach using pseudo-observations
#' @param time_points Time points for pseudo-observation calculation
#' @param tau_rmst Maximum follow-up time for RMST analysis
#' @param quantile_probs Survival quantiles for pseudo-observation analysis
#' @param jackknife_method Method for computing pseudo-observations
#' @param regression_method Statistical method for pseudo-observation
#'   regression
#' @param cluster_var Variable defining clusters for GEE or cluster jackknife
#' @param confidence_level Confidence level for parameter estimates
#' @param bootstrap_samples Bootstrap resamples for standard error estimation
#' @param robust_se Whether to compute robust standard errors
#' @param model_diagnostics Whether to include model diagnostics
#' @param prediction_intervals Whether to compute prediction intervals
#' @param survival_curves Whether to plot survival probability curves
#' @param rmst_comparison Whether to perform RMST group comparisons
#' @param sensitivity_analysis Whether to perform sensitivity analysis
#' @param competing_risks Whether to include competing risks modeling
#' @param weighted_analysis Whether to apply inverse probability weighting
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$pseudo_summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$regression_results} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$covariate_effects} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$rmst_analysis} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$survival_probability_results} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$group_comparisons} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$model_diagnostics_summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$sensitivity_results} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$pseudo_observations_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$regression_plots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$survival_curves_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$rmst_comparison_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$diagnostics_plots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$sensitivity_plot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' @export
pseudosurvival <- function(
    time_var,
    status_var,
    covariates = NULL,
    stratification_vars = NULL,
    analysis_type = "survival_probability",
    time_points = "12,24,36,60",
    tau_rmst = 60,
    quantile_probs = "0.25,0.5,0.75",
    jackknife_method = "standard",
    regression_method = "ols",
    cluster_var = NULL,
    confidence_level = 0.95,
    bootstrap_samples = 500,
    robust_se = FALSE,
    model_diagnostics = TRUE,
    prediction_intervals = FALSE,
    survival_curves = TRUE,
    rmst_comparison = TRUE,
    sensitivity_analysis = FALSE,
    competing_risks = FALSE,
    weighted_analysis = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("pseudosurvival requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time_var)) time_var <- jmvcore::resolveQuo(jmvcore::enquo(time_var))
    if ( ! missing(status_var)) status_var <- jmvcore::resolveQuo(jmvcore::enquo(status_var))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(stratification_vars)) stratification_vars <- jmvcore::resolveQuo(jmvcore::enquo(stratification_vars))
    if ( ! missing(cluster_var)) cluster_var <- jmvcore::resolveQuo(jmvcore::enquo(cluster_var))

    options <- pseudosurvivalOptions$new(
        time_var = time_var,
        status_var = status_var,
        covariates = covariates,
        stratification_vars = stratification_vars,
        analysis_type = analysis_type,
        time_points = time_points,
        tau_rmst = tau_rmst,
        quantile_probs = quantile_probs,
        jackknife_method = jackknife_method,
        regression_method = regression_method,
        cluster_var = cluster_var,
        confidence_level = confidence_level,
        bootstrap_samples = bootstrap_samples,
        robust_se = robust_se,
        model_diagnostics = model_diagnostics,
        prediction_intervals = prediction_intervals,
        survival_curves = survival_curves,
        rmst_comparison = rmst_comparison,
        sensitivity_analysis = sensitivity_analysis,
        competing_risks = competing_risks,
        weighted_analysis = weighted_analysis)

    analysis <- pseudosurvivalClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

