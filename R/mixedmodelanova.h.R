
# This file is automatically generated, you probably don't want to edit this

mixedmodelanovaOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "mixedmodelanovaOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            dependent = NULL,
            fixed_factors = NULL,
            random_factors = NULL,
            covariates = NULL,
            model_type = "random_intercept",
            interaction_terms = FALSE,
            estimation_method = "reml",
            show_fixed_effects = TRUE,
            show_random_effects = TRUE,
            show_model_fit = TRUE,
            show_assumptions = TRUE,
            show_posthoc = FALSE,
            posthoc_method = "tukey",
            confidence_level = 0.95,
            show_effect_sizes = TRUE,
            show_icc = TRUE,
            show_plots = TRUE,
            show_methodology = FALSE,
            show_references = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="mixedmodelanova",
                requiresData=TRUE,
                ...)

            private$..dependent <- jmvcore::OptionVariable$new(
                "dependent",
                dependent,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..fixed_factors <- jmvcore::OptionVariables$new(
                "fixed_factors",
                fixed_factors,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..random_factors <- jmvcore::OptionVariables$new(
                "random_factors",
                random_factors,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..model_type <- jmvcore::OptionList$new(
                "model_type",
                model_type,
                options=list(
                    "random_intercept",
                    "random_slope",
                    "nested"),
                default="random_intercept")
            private$..interaction_terms <- jmvcore::OptionBool$new(
                "interaction_terms",
                interaction_terms,
                default=FALSE)
            private$..estimation_method <- jmvcore::OptionList$new(
                "estimation_method",
                estimation_method,
                options=list(
                    "reml",
                    "ml"),
                default="reml")
            private$..show_fixed_effects <- jmvcore::OptionBool$new(
                "show_fixed_effects",
                show_fixed_effects,
                default=TRUE)
            private$..show_random_effects <- jmvcore::OptionBool$new(
                "show_random_effects",
                show_random_effects,
                default=TRUE)
            private$..show_model_fit <- jmvcore::OptionBool$new(
                "show_model_fit",
                show_model_fit,
                default=TRUE)
            private$..show_assumptions <- jmvcore::OptionBool$new(
                "show_assumptions",
                show_assumptions,
                default=TRUE)
            private$..show_posthoc <- jmvcore::OptionBool$new(
                "show_posthoc",
                show_posthoc,
                default=FALSE)
            private$..posthoc_method <- jmvcore::OptionList$new(
                "posthoc_method",
                posthoc_method,
                options=list(
                    "tukey",
                    "bonferroni",
                    "holm",
                    "none"),
                default="tukey")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..show_effect_sizes <- jmvcore::OptionBool$new(
                "show_effect_sizes",
                show_effect_sizes,
                default=TRUE)
            private$..show_icc <- jmvcore::OptionBool$new(
                "show_icc",
                show_icc,
                default=TRUE)
            private$..show_plots <- jmvcore::OptionBool$new(
                "show_plots",
                show_plots,
                default=TRUE)
            private$..show_methodology <- jmvcore::OptionBool$new(
                "show_methodology",
                show_methodology,
                default=FALSE)
            private$..show_references <- jmvcore::OptionBool$new(
                "show_references",
                show_references,
                default=FALSE)

            self$.addOption(private$..dependent)
            self$.addOption(private$..fixed_factors)
            self$.addOption(private$..random_factors)
            self$.addOption(private$..covariates)
            self$.addOption(private$..model_type)
            self$.addOption(private$..interaction_terms)
            self$.addOption(private$..estimation_method)
            self$.addOption(private$..show_fixed_effects)
            self$.addOption(private$..show_random_effects)
            self$.addOption(private$..show_model_fit)
            self$.addOption(private$..show_assumptions)
            self$.addOption(private$..show_posthoc)
            self$.addOption(private$..posthoc_method)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..show_effect_sizes)
            self$.addOption(private$..show_icc)
            self$.addOption(private$..show_plots)
            self$.addOption(private$..show_methodology)
            self$.addOption(private$..show_references)
        }),
    active = list(
        dependent = function() private$..dependent$value,
        fixed_factors = function() private$..fixed_factors$value,
        random_factors = function() private$..random_factors$value,
        covariates = function() private$..covariates$value,
        model_type = function() private$..model_type$value,
        interaction_terms = function() private$..interaction_terms$value,
        estimation_method = function() private$..estimation_method$value,
        show_fixed_effects = function() private$..show_fixed_effects$value,
        show_random_effects = function() private$..show_random_effects$value,
        show_model_fit = function() private$..show_model_fit$value,
        show_assumptions = function() private$..show_assumptions$value,
        show_posthoc = function() private$..show_posthoc$value,
        posthoc_method = function() private$..posthoc_method$value,
        confidence_level = function() private$..confidence_level$value,
        show_effect_sizes = function() private$..show_effect_sizes$value,
        show_icc = function() private$..show_icc$value,
        show_plots = function() private$..show_plots$value,
        show_methodology = function() private$..show_methodology$value,
        show_references = function() private$..show_references$value),
    private = list(
        ..dependent = NA,
        ..fixed_factors = NA,
        ..random_factors = NA,
        ..covariates = NA,
        ..model_type = NA,
        ..interaction_terms = NA,
        ..estimation_method = NA,
        ..show_fixed_effects = NA,
        ..show_random_effects = NA,
        ..show_model_fit = NA,
        ..show_assumptions = NA,
        ..show_posthoc = NA,
        ..posthoc_method = NA,
        ..confidence_level = NA,
        ..show_effect_sizes = NA,
        ..show_icc = NA,
        ..show_plots = NA,
        ..show_methodology = NA,
        ..show_references = NA)
)

mixedmodelanovaResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "mixedmodelanovaResults",
    inherit = jmvcore::Group,
    active = list(
        model_info = function() private$.items[["model_info"]],
        fixed_effects = function() private$.items[["fixed_effects"]],
        anova_table = function() private$.items[["anova_table"]],
        random_effects = function() private$.items[["random_effects"]],
        model_fit = function() private$.items[["model_fit"]],
        icc_table = function() private$.items[["icc_table"]],
        effect_sizes = function() private$.items[["effect_sizes"]],
        posthoc = function() private$.items[["posthoc"]],
        assumptions = function() private$.items[["assumptions"]],
        diagnostic_plots = function() private$.items[["diagnostic_plots"]],
        interpretation = function() private$.items[["interpretation"]],
        methodology = function() private$.items[["methodology"]],
        references = function() private$.items[["references"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Mixed Model ANOVA")
            self$add(jmvcore::Table$new(
                options=options,
                name="model_info",
                title="Model Information",
                rows=1,
                columns=list(
                    list(
                        `name`="formula", 
                        `title`="Model Formula", 
                        `type`="text"),
                    list(
                        `name`="estimation", 
                        `title`="Estimation Method", 
                        `type`="text"),
                    list(
                        `name`="n_obs", 
                        `title`="Observations", 
                        `type`="integer"),
                    list(
                        `name`="n_groups", 
                        `title`="Number of Groups", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="fixed_effects",
                title="Fixed Effects",
                visible="(show_fixed_effects)",
                rows=0,
                columns=list(
                    list(
                        `name`="term", 
                        `title`="Term", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="number"),
                    list(
                        `name`="t_value", 
                        `title`="t", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="anova_table",
                title="Type III ANOVA Table",
                visible="(show_fixed_effects)",
                rows=0,
                columns=list(
                    list(
                        `name`="term", 
                        `title`="Effect", 
                        `type`="text"),
                    list(
                        `name`="sumsq", 
                        `title`="Sum Sq", 
                        `type`="number"),
                    list(
                        `name`="meansq", 
                        `title`="Mean Sq", 
                        `type`="number"),
                    list(
                        `name`="numdf", 
                        `title`="NumDF", 
                        `type`="number"),
                    list(
                        `name`="dendf", 
                        `title`="DenDF", 
                        `type`="number"),
                    list(
                        `name`="f_value", 
                        `title`="F", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="random_effects",
                title="Random Effects",
                visible="(show_random_effects)",
                rows=0,
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="variance", 
                        `title`="Variance", 
                        `type`="number"),
                    list(
                        `name`="std_dev", 
                        `title`="Std. Dev", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="model_fit",
                title="Model Fit Statistics",
                visible="(show_model_fit)",
                rows=1,
                columns=list(
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number"),
                    list(
                        `name`="loglik", 
                        `title`="Log-Likelihood", 
                        `type`="number"),
                    list(
                        `name`="deviance", 
                        `title`="Deviance", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="icc_table",
                title="Intraclass Correlation Coefficients",
                visible="(show_icc)",
                rows=0,
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Grouping Variable", 
                        `type`="text"),
                    list(
                        `name`="icc", 
                        `title`="ICC", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="effect_sizes",
                title="Effect Sizes (Partial \u03B7\u00B2)",
                visible="(show_effect_sizes)",
                rows=0,
                columns=list(
                    list(
                        `name`="term", 
                        `title`="Effect", 
                        `type`="text"),
                    list(
                        `name`="partial_eta_sq", 
                        `title`="Partial \u03B7\u00B2", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="posthoc",
                title="Post Hoc Comparisons",
                visible="(show_posthoc)",
                rows=0,
                columns=list(
                    list(
                        `name`="contrast", 
                        `title`="Contrast", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="number"),
                    list(
                        `name`="t_ratio", 
                        `title`="t ratio", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="assumptions",
                title="Assumption Checks",
                visible="(show_assumptions)",
                rows=0,
                columns=list(
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="result", 
                        `title`="Result", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagnostic_plots",
                title="Diagnostic Plots",
                visible="(show_plots)",
                width=600,
                height=600,
                renderFun=".diagnosticPlots"))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Interpretation Guide"))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodology",
                title="Methodology",
                visible="(show_methodology)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="references",
                title="References",
                visible="(show_references)"))}))

mixedmodelanovaBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "mixedmodelanovaBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "mixedmodelanova",
                version = c(1,0,0),
                options = options,
                results = mixedmodelanovaResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Mixed Model ANOVA
#'
#' 
#' @param data .
#' @param dependent .
#' @param fixed_factors .
#' @param random_factors .
#' @param covariates .
#' @param model_type .
#' @param interaction_terms .
#' @param estimation_method .
#' @param show_fixed_effects .
#' @param show_random_effects .
#' @param show_model_fit .
#' @param show_assumptions .
#' @param show_posthoc .
#' @param posthoc_method .
#' @param confidence_level .
#' @param show_effect_sizes .
#' @param show_icc .
#' @param show_plots .
#' @param show_methodology .
#' @param show_references .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$model_info} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$fixed_effects} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$anova_table} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$random_effects} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$model_fit} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$icc_table} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$effect_sizes} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$posthoc} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$assumptions} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$diagnostic_plots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$methodology} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$references} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$model_info$asDF}
#'
#' \code{as.data.frame(results$model_info)}
#'
#' @export
mixedmodelanova <- function(
    data,
    dependent,
    fixed_factors,
    random_factors,
    covariates,
    model_type = "random_intercept",
    interaction_terms = FALSE,
    estimation_method = "reml",
    show_fixed_effects = TRUE,
    show_random_effects = TRUE,
    show_model_fit = TRUE,
    show_assumptions = TRUE,
    show_posthoc = FALSE,
    posthoc_method = "tukey",
    confidence_level = 0.95,
    show_effect_sizes = TRUE,
    show_icc = TRUE,
    show_plots = TRUE,
    show_methodology = FALSE,
    show_references = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("mixedmodelanova requires jmvcore to be installed (restart may be required)")

    if ( ! missing(dependent)) dependent <- jmvcore::resolveQuo(jmvcore::enquo(dependent))
    if ( ! missing(fixed_factors)) fixed_factors <- jmvcore::resolveQuo(jmvcore::enquo(fixed_factors))
    if ( ! missing(random_factors)) random_factors <- jmvcore::resolveQuo(jmvcore::enquo(random_factors))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(dependent), dependent, NULL),
            `if`( ! missing(fixed_factors), fixed_factors, NULL),
            `if`( ! missing(random_factors), random_factors, NULL),
            `if`( ! missing(covariates), covariates, NULL))

    for (v in fixed_factors) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in random_factors) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- mixedmodelanovaOptions$new(
        dependent = dependent,
        fixed_factors = fixed_factors,
        random_factors = random_factors,
        covariates = covariates,
        model_type = model_type,
        interaction_terms = interaction_terms,
        estimation_method = estimation_method,
        show_fixed_effects = show_fixed_effects,
        show_random_effects = show_random_effects,
        show_model_fit = show_model_fit,
        show_assumptions = show_assumptions,
        show_posthoc = show_posthoc,
        posthoc_method = posthoc_method,
        confidence_level = confidence_level,
        show_effect_sizes = show_effect_sizes,
        show_icc = show_icc,
        show_plots = show_plots,
        show_methodology = show_methodology,
        show_references = show_references)

    analysis <- mixedmodelanovaClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

