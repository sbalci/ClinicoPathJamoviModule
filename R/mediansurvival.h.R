
# This file is automatically generated, you probably don't want to edit this

mediansurvivalOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "mediansurvivalOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            outcome = NULL,
            explanatory = NULL,
            outcomeLevel = "1",
            confidence_method = "brookmeyer_crowley",
            confidence_level = 0.95,
            test_method = "logrank",
            multiple_comparison = "holm",
            show_survival_plot = TRUE,
            show_median_lines = TRUE,
            show_confidence_bands = TRUE,
            show_risk_table = FALSE,
            showSummaries = FALSE,
            showExplanations = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="mediansurvival",
                requiresData=TRUE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..explanatory <- jmvcore::OptionVariable$new(
                "explanatory",
                explanatory,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..outcomeLevel <- jmvcore::OptionString$new(
                "outcomeLevel",
                outcomeLevel,
                default="1")
            private$..confidence_method <- jmvcore::OptionList$new(
                "confidence_method",
                confidence_method,
                options=list(
                    "brookmeyer_crowley",
                    "log_transform",
                    "loglog_transform",
                    "plain"),
                default="brookmeyer_crowley")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..test_method <- jmvcore::OptionList$new(
                "test_method",
                test_method,
                options=list(
                    "logrank",
                    "wilcoxon",
                    "petopeto",
                    "all"),
                default="logrank")
            private$..multiple_comparison <- jmvcore::OptionList$new(
                "multiple_comparison",
                multiple_comparison,
                options=list(
                    "none",
                    "holm",
                    "bonferroni",
                    "fdr",
                    "hochberg"),
                default="holm")
            private$..show_survival_plot <- jmvcore::OptionBool$new(
                "show_survival_plot",
                show_survival_plot,
                default=TRUE)
            private$..show_median_lines <- jmvcore::OptionBool$new(
                "show_median_lines",
                show_median_lines,
                default=TRUE)
            private$..show_confidence_bands <- jmvcore::OptionBool$new(
                "show_confidence_bands",
                show_confidence_bands,
                default=TRUE)
            private$..show_risk_table <- jmvcore::OptionBool$new(
                "show_risk_table",
                show_risk_table,
                default=FALSE)
            private$..showSummaries <- jmvcore::OptionBool$new(
                "showSummaries",
                showSummaries,
                default=FALSE)
            private$..showExplanations <- jmvcore::OptionBool$new(
                "showExplanations",
                showExplanations,
                default=FALSE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..outcome)
            self$.addOption(private$..explanatory)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..confidence_method)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..test_method)
            self$.addOption(private$..multiple_comparison)
            self$.addOption(private$..show_survival_plot)
            self$.addOption(private$..show_median_lines)
            self$.addOption(private$..show_confidence_bands)
            self$.addOption(private$..show_risk_table)
            self$.addOption(private$..showSummaries)
            self$.addOption(private$..showExplanations)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        outcome = function() private$..outcome$value,
        explanatory = function() private$..explanatory$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        confidence_method = function() private$..confidence_method$value,
        confidence_level = function() private$..confidence_level$value,
        test_method = function() private$..test_method$value,
        multiple_comparison = function() private$..multiple_comparison$value,
        show_survival_plot = function() private$..show_survival_plot$value,
        show_median_lines = function() private$..show_median_lines$value,
        show_confidence_bands = function() private$..show_confidence_bands$value,
        show_risk_table = function() private$..show_risk_table$value,
        showSummaries = function() private$..showSummaries$value,
        showExplanations = function() private$..showExplanations$value),
    private = list(
        ..elapsedtime = NA,
        ..outcome = NA,
        ..explanatory = NA,
        ..outcomeLevel = NA,
        ..confidence_method = NA,
        ..confidence_level = NA,
        ..test_method = NA,
        ..multiple_comparison = NA,
        ..show_survival_plot = NA,
        ..show_median_lines = NA,
        ..show_confidence_bands = NA,
        ..show_risk_table = NA,
        ..showSummaries = NA,
        ..showExplanations = NA)
)

mediansurvivalResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "mediansurvivalResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        medianTable = function() private$.items[["medianTable"]],
        comparisonTable = function() private$.items[["comparisonTable"]],
        survivalPlot = function() private$.items[["survivalPlot"]],
        medianComparisonPlot = function() private$.items[["medianComparisonPlot"]],
        analysisSummary = function() private$.items[["analysisSummary"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Median Survival Comparisons")
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="medianTable",
                title="Median Survival Times",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="median", 
                        `title`="Median", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="n_events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="n_total", 
                        `title`="Total", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="comparisonTable",
                title="Pairwise Comparisons",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="test_statistic", 
                        `title`="Test Statistic", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number"),
                    list(
                        `name`="p_adjusted", 
                        `title`="Adjusted p", 
                        `type`="number"),
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlot",
                title="Survival Curves with Median Indicators",
                visible="(show_survival_plot)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="medianComparisonPlot",
                title="Median Survival Comparison",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="analysisSummary",
                title="Analysis Summary",
                visible="(showSummaries)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Methodology",
                visible="(showExplanations)"))}))

mediansurvivalBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "mediansurvivalBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "mediansurvival",
                version = c(1,0,0),
                options = options,
                results = mediansurvivalResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Median Survival Comparisons
#'
#' Performs statistical comparisons of median survival times between groups. 
#' Provides confidence intervals, hypothesis tests, and robust estimators for  
#' median survival with handling of censored data and group comparisons.
#'
#' @examples
#' # Example usage will be added
#'
#' @param data The data as a data frame.
#' @param elapsedtime Time variable for survival analysis.
#' @param outcome Event indicator variable.
#' @param explanatory Grouping variable for comparison.
#' @param outcomeLevel Level of outcome variable indicating event.
#' @param confidence_method Method for constructing confidence intervals for
#'   median survival.
#' @param confidence_level Confidence level for median survival intervals.
#' @param test_method Statistical test method for comparing median survival
#'   times.
#' @param multiple_comparison Method for multiple comparison adjustment.
#' @param show_survival_plot Display Kaplan-Meier survival curves with median
#'   indicators.
#' @param show_median_lines Add median survival lines to survival plot.
#' @param show_confidence_bands Display confidence bands around survival
#'   curves.
#' @param show_risk_table Include numbers at risk table below survival plot.
#' @param showSummaries Generate natural language summaries.
#' @param showExplanations Show methodology explanations.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$medianTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$comparisonTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$survivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$medianComparisonPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$analysisSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$medianTable$asDF}
#'
#' \code{as.data.frame(results$medianTable)}
#'
#' @export
mediansurvival <- function(
    data,
    elapsedtime,
    outcome,
    explanatory,
    outcomeLevel = "1",
    confidence_method = "brookmeyer_crowley",
    confidence_level = 0.95,
    test_method = "logrank",
    multiple_comparison = "holm",
    show_survival_plot = TRUE,
    show_median_lines = TRUE,
    show_confidence_bands = TRUE,
    show_risk_table = FALSE,
    showSummaries = FALSE,
    showExplanations = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("mediansurvival requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(explanatory)) explanatory <- jmvcore::resolveQuo(jmvcore::enquo(explanatory))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(elapsedtime), elapsedtime, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(explanatory), explanatory, NULL))


    options <- mediansurvivalOptions$new(
        elapsedtime = elapsedtime,
        outcome = outcome,
        explanatory = explanatory,
        outcomeLevel = outcomeLevel,
        confidence_method = confidence_method,
        confidence_level = confidence_level,
        test_method = test_method,
        multiple_comparison = multiple_comparison,
        show_survival_plot = show_survival_plot,
        show_median_lines = show_median_lines,
        show_confidence_bands = show_confidence_bands,
        show_risk_table = show_risk_table,
        showSummaries = showSummaries,
        showExplanations = showExplanations)

    analysis <- mediansurvivalClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

