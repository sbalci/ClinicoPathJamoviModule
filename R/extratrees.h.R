
# This file is automatically generated, you probably don't want to edit this

extratreesOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "extratreesOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            event = NULL,
            predictors = NULL,
            strata = NULL,
            num_trees = 500,
            mtry = "sqrt",
            mtry_custom = NULL,
            min_node_size = 10,
            max_depth = 0,
            splitrule = "extratrees",
            num_random_splits = 1,
            sample_fraction = 1,
            replace = TRUE,
            case_weights = NULL,
            importance = "permutation",
            scale_permutation = TRUE,
            keep_inbag = FALSE,
            oob_error = TRUE,
            probability = FALSE,
            show_forest_summary = TRUE,
            show_importance = TRUE,
            show_oob_predictions = FALSE,
            plot_importance = TRUE,
            plot_oob_error = TRUE,
            plot_survival = FALSE,
            plot_partial = FALSE,
            regularization = 1,
            alpha = 0.05,
            num_threads = 0,
            random_seed = 123, ...) {

            super$initialize(
                package="ClinicoPath",
                name="extratrees",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event <- jmvcore::OptionVariable$new(
                "event",
                event,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..predictors <- jmvcore::OptionVariables$new(
                "predictors",
                predictors,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..strata <- jmvcore::OptionVariable$new(
                "strata",
                strata,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..num_trees <- jmvcore::OptionInteger$new(
                "num_trees",
                num_trees,
                default=500,
                min=10,
                max=10000)
            private$..mtry <- jmvcore::OptionList$new(
                "mtry",
                mtry,
                options=list(
                    "sqrt",
                    "third",
                    "half",
                    "all",
                    "custom"),
                default="sqrt")
            private$..mtry_custom <- jmvcore::OptionInteger$new(
                "mtry_custom",
                mtry_custom,
                min=1)
            private$..min_node_size <- jmvcore::OptionInteger$new(
                "min_node_size",
                min_node_size,
                default=10,
                min=1,
                max=100)
            private$..max_depth <- jmvcore::OptionInteger$new(
                "max_depth",
                max_depth,
                default=0,
                min=0,
                max=50)
            private$..splitrule <- jmvcore::OptionList$new(
                "splitrule",
                splitrule,
                options=list(
                    "extratrees",
                    "logrank",
                    "C",
                    "maxstat"),
                default="extratrees")
            private$..num_random_splits <- jmvcore::OptionInteger$new(
                "num_random_splits",
                num_random_splits,
                default=1,
                min=1,
                max=20)
            private$..sample_fraction <- jmvcore::OptionNumber$new(
                "sample_fraction",
                sample_fraction,
                default=1,
                min=0.1,
                max=1)
            private$..replace <- jmvcore::OptionBool$new(
                "replace",
                replace,
                default=TRUE)
            private$..case_weights <- jmvcore::OptionVariable$new(
                "case_weights",
                case_weights,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..importance <- jmvcore::OptionList$new(
                "importance",
                importance,
                options=list(
                    "permutation",
                    "impurity",
                    "both",
                    "none"),
                default="permutation")
            private$..scale_permutation <- jmvcore::OptionBool$new(
                "scale_permutation",
                scale_permutation,
                default=TRUE)
            private$..keep_inbag <- jmvcore::OptionBool$new(
                "keep_inbag",
                keep_inbag,
                default=FALSE)
            private$..oob_error <- jmvcore::OptionBool$new(
                "oob_error",
                oob_error,
                default=TRUE)
            private$..probability <- jmvcore::OptionBool$new(
                "probability",
                probability,
                default=FALSE)
            private$..show_forest_summary <- jmvcore::OptionBool$new(
                "show_forest_summary",
                show_forest_summary,
                default=TRUE)
            private$..show_importance <- jmvcore::OptionBool$new(
                "show_importance",
                show_importance,
                default=TRUE)
            private$..show_oob_predictions <- jmvcore::OptionBool$new(
                "show_oob_predictions",
                show_oob_predictions,
                default=FALSE)
            private$..plot_importance <- jmvcore::OptionBool$new(
                "plot_importance",
                plot_importance,
                default=TRUE)
            private$..plot_oob_error <- jmvcore::OptionBool$new(
                "plot_oob_error",
                plot_oob_error,
                default=TRUE)
            private$..plot_survival <- jmvcore::OptionBool$new(
                "plot_survival",
                plot_survival,
                default=FALSE)
            private$..plot_partial <- jmvcore::OptionBool$new(
                "plot_partial",
                plot_partial,
                default=FALSE)
            private$..regularization <- jmvcore::OptionNumber$new(
                "regularization",
                regularization,
                default=1,
                min=0,
                max=10)
            private$..alpha <- jmvcore::OptionNumber$new(
                "alpha",
                alpha,
                default=0.05,
                min=0.001,
                max=0.5)
            private$..num_threads <- jmvcore::OptionInteger$new(
                "num_threads",
                num_threads,
                default=0,
                min=0,
                max=32)
            private$..random_seed <- jmvcore::OptionInteger$new(
                "random_seed",
                random_seed,
                default=123,
                min=1,
                max=999999)

            self$.addOption(private$..time)
            self$.addOption(private$..event)
            self$.addOption(private$..predictors)
            self$.addOption(private$..strata)
            self$.addOption(private$..num_trees)
            self$.addOption(private$..mtry)
            self$.addOption(private$..mtry_custom)
            self$.addOption(private$..min_node_size)
            self$.addOption(private$..max_depth)
            self$.addOption(private$..splitrule)
            self$.addOption(private$..num_random_splits)
            self$.addOption(private$..sample_fraction)
            self$.addOption(private$..replace)
            self$.addOption(private$..case_weights)
            self$.addOption(private$..importance)
            self$.addOption(private$..scale_permutation)
            self$.addOption(private$..keep_inbag)
            self$.addOption(private$..oob_error)
            self$.addOption(private$..probability)
            self$.addOption(private$..show_forest_summary)
            self$.addOption(private$..show_importance)
            self$.addOption(private$..show_oob_predictions)
            self$.addOption(private$..plot_importance)
            self$.addOption(private$..plot_oob_error)
            self$.addOption(private$..plot_survival)
            self$.addOption(private$..plot_partial)
            self$.addOption(private$..regularization)
            self$.addOption(private$..alpha)
            self$.addOption(private$..num_threads)
            self$.addOption(private$..random_seed)
        }),
    active = list(
        time = function() private$..time$value,
        event = function() private$..event$value,
        predictors = function() private$..predictors$value,
        strata = function() private$..strata$value,
        num_trees = function() private$..num_trees$value,
        mtry = function() private$..mtry$value,
        mtry_custom = function() private$..mtry_custom$value,
        min_node_size = function() private$..min_node_size$value,
        max_depth = function() private$..max_depth$value,
        splitrule = function() private$..splitrule$value,
        num_random_splits = function() private$..num_random_splits$value,
        sample_fraction = function() private$..sample_fraction$value,
        replace = function() private$..replace$value,
        case_weights = function() private$..case_weights$value,
        importance = function() private$..importance$value,
        scale_permutation = function() private$..scale_permutation$value,
        keep_inbag = function() private$..keep_inbag$value,
        oob_error = function() private$..oob_error$value,
        probability = function() private$..probability$value,
        show_forest_summary = function() private$..show_forest_summary$value,
        show_importance = function() private$..show_importance$value,
        show_oob_predictions = function() private$..show_oob_predictions$value,
        plot_importance = function() private$..plot_importance$value,
        plot_oob_error = function() private$..plot_oob_error$value,
        plot_survival = function() private$..plot_survival$value,
        plot_partial = function() private$..plot_partial$value,
        regularization = function() private$..regularization$value,
        alpha = function() private$..alpha$value,
        num_threads = function() private$..num_threads$value,
        random_seed = function() private$..random_seed$value),
    private = list(
        ..time = NA,
        ..event = NA,
        ..predictors = NA,
        ..strata = NA,
        ..num_trees = NA,
        ..mtry = NA,
        ..mtry_custom = NA,
        ..min_node_size = NA,
        ..max_depth = NA,
        ..splitrule = NA,
        ..num_random_splits = NA,
        ..sample_fraction = NA,
        ..replace = NA,
        ..case_weights = NA,
        ..importance = NA,
        ..scale_permutation = NA,
        ..keep_inbag = NA,
        ..oob_error = NA,
        ..probability = NA,
        ..show_forest_summary = NA,
        ..show_importance = NA,
        ..show_oob_predictions = NA,
        ..plot_importance = NA,
        ..plot_oob_error = NA,
        ..plot_survival = NA,
        ..plot_partial = NA,
        ..regularization = NA,
        ..alpha = NA,
        ..num_threads = NA,
        ..random_seed = NA)
)

extratreesResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "extratreesResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        forestSummary = function() private$.items[["forestSummary"]],
        variableImportance = function() private$.items[["variableImportance"]],
        oobPredictions = function() private$.items[["oobPredictions"]],
        importancePlot = function() private$.items[["importancePlot"]],
        oobErrorPlot = function() private$.items[["oobErrorPlot"]],
        survivalPlot = function() private$.items[["survivalPlot"]],
        partialPlots = function() private$.items[["partialPlots"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Extremely Randomized Trees for Survival",
                refs=list(
                    "ExtraTrees",
                    "Survival",
                    "ranger",
                    "randomForestSRC",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="TODO",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="forestSummary",
                title="Forest Summary",
                visible="(show_forest_summary)",
                rows=0,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="variableImportance",
                title="Variable Importance",
                visible="(show_importance)",
                rows=0,
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="importance", 
                        `title`="Importance", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="se", 
                        `title`="Standard Error", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="rank", 
                        `title`="Rank", 
                        `type`="integer"),
                    list(
                        `name`="pvalue", 
                        `title`="P-value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="oobPredictions",
                title="Out-of-Bag Predictions",
                visible="(show_oob_predictions)",
                rows=0,
                columns=list(
                    list(
                        `name`="case_id", 
                        `title`="Case ID", 
                        `type`="integer"),
                    list(
                        `name`="observed_time", 
                        `title`="Observed Time", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="event_status", 
                        `title`="Event Status", 
                        `type`="integer"),
                    list(
                        `name`="predicted_risk", 
                        `title`="Predicted Risk", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="risk_group", 
                        `title`="Risk Group", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="importancePlot",
                title="Variable Importance Plot",
                width=600,
                height=400,
                visible="(plot_importance)",
                renderFun=".plotImportance",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="oobErrorPlot",
                title="Out-of-Bag Error Convergence",
                width=600,
                height=400,
                visible="(plot_oob_error)",
                renderFun=".plotOobError",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlot",
                title="Risk Group Survival Curves",
                width=800,
                height=600,
                visible="(plot_survival)",
                renderFun=".plotSurvival",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="partialPlots",
                title="Partial Dependence Plots",
                width=800,
                height=600,
                visible="(plot_partial)",
                renderFun=".plotPartial",
                requiresData=TRUE))}))

extratreesBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "extratreesBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "extratrees",
                version = c(0,0,31),
                options = options,
                results = extratreesResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Extremely Randomized Trees for Survival
#'
#' Extremely Randomized Trees (Extra Trees) for survival analysis using the 
#' ranger package implementation. This method extends random forests by 
#' introducing additional randomization in both variable selection and split 
#' point selection, leading to increased bias but reduced variance and 
#' computational efficiency. The algorithm is particularly effective for 
#' high-dimensional survival data, large datasets, and scenarios requiring 
#' fast training and prediction. Features include built-in variable importance 
#' measures, out-of-bag error estimation, support for competing risks, and 
#' excellent scalability. Ideal for exploratory analysis, baseline modeling, 
#' and ensemble methods in survival prediction tasks.
#' 
#'
#' @examples
#' result <- extratrees(
#'     data = mydata,
#'     time = "time_to_event",
#'     event = "event_indicator",
#'     predictors = c("age", "stage", "biomarker1", "biomarker2"),
#'     num_trees = 500,
#'     mtry = "sqrt",
#'     min_node_size = 10,
#'     splitrule = "extratrees"
#' )
#'
#' @param data The data as a data frame.
#' @param time Time to event variable (numeric). For right-censored data, this
#'   is the  time from study entry to event or censoring.
#' @param event Event indicator variable. For survival analysis: 0 = censored,
#'   1 = event. For competing risks: 0 = censored, 1+ = different event types.
#' @param predictors Variables to use for tree construction. Can include
#'   numeric, ordinal, and nominal variables. The algorithm handles mixed-type
#'   predictors efficiently.
#' @param strata Optional stratification variable for stratified survival
#'   analysis. Creates separate baseline hazards for each stratum.
#' @param num_trees Number of trees in the forest. More trees generally
#'   improve stability and performance but increase computation time. 500-2000
#'   is typical.
#' @param mtry Number of variables randomly selected at each split. Square
#'   root of total variables is default. Smaller values increase randomization.
#' @param mtry_custom Custom number of variables per split when mtry is set to
#'   'custom'. Should be between 1 and total number of predictors.
#' @param min_node_size Minimum number of observations in terminal nodes.
#'   Larger values create simpler trees and reduce overfitting, smaller values
#'   allow more complex patterns.
#' @param max_depth Maximum depth of trees. 0 means no limit. Deep trees may
#'   overfit, while shallow trees may underfit. Usually left unlimited for Extra
#'   Trees.
#' @param splitrule Splitting criterion. 'extratrees' uses extreme
#'   randomization, 'logrank' uses log-rank statistic, 'C' optimizes concordance
#'   index, 'maxstat' uses maximally selected rank statistics.
#' @param num_random_splits Number of random splits to try per variable for
#'   Extra Trees rule. Higher values reduce randomization but may improve
#'   performance.
#' @param sample_fraction Fraction of observations sampled for each tree.
#'   Values < 1.0 create subsampled forests which can improve generalization and
#'   reduce computation.
#' @param replace Use bootstrap sampling (with replacement) for each tree.
#'   When FALSE, uses subsampling without replacement.
#' @param case_weights Optional variable containing case weights for
#'   observations. Higher weights give observations more influence in tree
#'   construction.
#' @param importance Method for calculating variable importance. Permutation
#'   importance measures prediction accuracy decrease when variables are
#'   permuted. Impurity importance measures decrease in node impurity.
#' @param scale_permutation Scale permutation importance by standard error.
#'   Provides more stable importance measures especially for correlated
#'   predictors.
#' @param keep_inbag Store which observations are in-bag for each tree.
#'   Required for some post-processing analyses but increases memory usage.
#' @param oob_error Calculate out-of-bag prediction error. Provides unbiased
#'   estimate of model performance without need for separate validation set.
#' @param probability Estimate survival probabilities instead of hazard
#'   ratios. Useful for risk prediction and probability-based decisions.
#' @param show_forest_summary Display summary statistics for the Extra Trees
#'   forest including OOB error, variable importance rankings, and model
#'   parameters.
#' @param show_importance Display detailed variable importance measures with
#'   rankings and statistical significance tests.
#' @param show_oob_predictions Display out-of-bag predictions for model
#'   evaluation and risk stratification analysis.
#' @param plot_importance Create variable importance plot showing relative
#'   importance of predictors with confidence intervals.
#' @param plot_oob_error Plot out-of-bag error as function of number of trees
#'   to assess convergence and optimal forest size.
#' @param plot_survival Create Kaplan-Meier survival curves for risk groups
#'   defined by Extra Trees predictions with statistical comparisons.
#' @param plot_partial Generate partial dependence plots for top variables
#'   showing marginal effects on survival predictions.
#' @param regularization Regularization parameter for Extra Trees. Values > 1
#'   increase randomization, values < 1 reduce it. 1.0 is standard Extra Trees.
#' @param alpha Significance level for variable importance testing and
#'   confidence intervals in plots.
#' @param num_threads Number of threads for parallel computation. 0 uses all
#'   available cores. Parallel computation significantly speeds up training.
#' @param random_seed Random seed for reproducible results. Change to get
#'   different random forests and bootstrap samples.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$forestSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$variableImportance} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$oobPredictions} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$importancePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$oobErrorPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$survivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$partialPlots} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$forestSummary$asDF}
#'
#' \code{as.data.frame(results$forestSummary)}
#'
#' @export
extratrees <- function(
    data,
    time,
    event,
    predictors,
    strata,
    num_trees = 500,
    mtry = "sqrt",
    mtry_custom,
    min_node_size = 10,
    max_depth = 0,
    splitrule = "extratrees",
    num_random_splits = 1,
    sample_fraction = 1,
    replace = TRUE,
    case_weights,
    importance = "permutation",
    scale_permutation = TRUE,
    keep_inbag = FALSE,
    oob_error = TRUE,
    probability = FALSE,
    show_forest_summary = TRUE,
    show_importance = TRUE,
    show_oob_predictions = FALSE,
    plot_importance = TRUE,
    plot_oob_error = TRUE,
    plot_survival = FALSE,
    plot_partial = FALSE,
    regularization = 1,
    alpha = 0.05,
    num_threads = 0,
    random_seed = 123) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("extratrees requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(event)) event <- jmvcore::resolveQuo(jmvcore::enquo(event))
    if ( ! missing(predictors)) predictors <- jmvcore::resolveQuo(jmvcore::enquo(predictors))
    if ( ! missing(strata)) strata <- jmvcore::resolveQuo(jmvcore::enquo(strata))
    if ( ! missing(case_weights)) case_weights <- jmvcore::resolveQuo(jmvcore::enquo(case_weights))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(event), event, NULL),
            `if`( ! missing(predictors), predictors, NULL),
            `if`( ! missing(strata), strata, NULL),
            `if`( ! missing(case_weights), case_weights, NULL))

    for (v in strata) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- extratreesOptions$new(
        time = time,
        event = event,
        predictors = predictors,
        strata = strata,
        num_trees = num_trees,
        mtry = mtry,
        mtry_custom = mtry_custom,
        min_node_size = min_node_size,
        max_depth = max_depth,
        splitrule = splitrule,
        num_random_splits = num_random_splits,
        sample_fraction = sample_fraction,
        replace = replace,
        case_weights = case_weights,
        importance = importance,
        scale_permutation = scale_permutation,
        keep_inbag = keep_inbag,
        oob_error = oob_error,
        probability = probability,
        show_forest_summary = show_forest_summary,
        show_importance = show_importance,
        show_oob_predictions = show_oob_predictions,
        plot_importance = plot_importance,
        plot_oob_error = plot_oob_error,
        plot_survival = plot_survival,
        plot_partial = plot_partial,
        regularization = regularization,
        alpha = alpha,
        num_threads = num_threads,
        random_seed = random_seed)

    analysis <- extratreesClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

