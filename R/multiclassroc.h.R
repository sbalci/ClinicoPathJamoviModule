
# This file is automatically generated, you probably don't want to edit this

multiclassrocOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "multiclassrocOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            outcome = NULL,
            predictors = NULL,
            method = "ovr",
            calculate_macro_auc = TRUE,
            calculate_micro_auc = TRUE,
            calculate_weighted_auc = TRUE,
            confidence_intervals = TRUE,
            ci_method = "bootstrap",
            bootstrap_samples = 1000,
            confidence_level = 0.95,
            pairwise_comparisons = FALSE,
            confusion_matrix = TRUE,
            class_metrics = TRUE,
            plot_roc_curves = TRUE,
            plot_method = "overlay",
            plot_diagonal = TRUE,
            random_seed = 42, ...) {

            super$initialize(
                package="ClinicoPath",
                name="multiclassroc",
                requiresData=TRUE,
                ...)

            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..predictors <- jmvcore::OptionVariables$new(
                "predictors",
                predictors,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..method <- jmvcore::OptionList$new(
                "method",
                method,
                options=list(
                    "ovr",
                    "ovo",
                    "multinomial"),
                default="ovr")
            private$..calculate_macro_auc <- jmvcore::OptionBool$new(
                "calculate_macro_auc",
                calculate_macro_auc,
                default=TRUE)
            private$..calculate_micro_auc <- jmvcore::OptionBool$new(
                "calculate_micro_auc",
                calculate_micro_auc,
                default=TRUE)
            private$..calculate_weighted_auc <- jmvcore::OptionBool$new(
                "calculate_weighted_auc",
                calculate_weighted_auc,
                default=TRUE)
            private$..confidence_intervals <- jmvcore::OptionBool$new(
                "confidence_intervals",
                confidence_intervals,
                default=TRUE)
            private$..ci_method <- jmvcore::OptionList$new(
                "ci_method",
                ci_method,
                options=list(
                    "bootstrap",
                    "delong"),
                default="bootstrap")
            private$..bootstrap_samples <- jmvcore::OptionNumber$new(
                "bootstrap_samples",
                bootstrap_samples,
                min=100,
                max=10000,
                default=1000)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..pairwise_comparisons <- jmvcore::OptionBool$new(
                "pairwise_comparisons",
                pairwise_comparisons,
                default=FALSE)
            private$..confusion_matrix <- jmvcore::OptionBool$new(
                "confusion_matrix",
                confusion_matrix,
                default=TRUE)
            private$..class_metrics <- jmvcore::OptionBool$new(
                "class_metrics",
                class_metrics,
                default=TRUE)
            private$..plot_roc_curves <- jmvcore::OptionBool$new(
                "plot_roc_curves",
                plot_roc_curves,
                default=TRUE)
            private$..plot_method <- jmvcore::OptionList$new(
                "plot_method",
                plot_method,
                options=list(
                    "separate",
                    "overlay"),
                default="overlay")
            private$..plot_diagonal <- jmvcore::OptionBool$new(
                "plot_diagonal",
                plot_diagonal,
                default=TRUE)
            private$..random_seed <- jmvcore::OptionNumber$new(
                "random_seed",
                random_seed,
                min=1,
                max=999999,
                default=42)

            self$.addOption(private$..outcome)
            self$.addOption(private$..predictors)
            self$.addOption(private$..method)
            self$.addOption(private$..calculate_macro_auc)
            self$.addOption(private$..calculate_micro_auc)
            self$.addOption(private$..calculate_weighted_auc)
            self$.addOption(private$..confidence_intervals)
            self$.addOption(private$..ci_method)
            self$.addOption(private$..bootstrap_samples)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..pairwise_comparisons)
            self$.addOption(private$..confusion_matrix)
            self$.addOption(private$..class_metrics)
            self$.addOption(private$..plot_roc_curves)
            self$.addOption(private$..plot_method)
            self$.addOption(private$..plot_diagonal)
            self$.addOption(private$..random_seed)
        }),
    active = list(
        outcome = function() private$..outcome$value,
        predictors = function() private$..predictors$value,
        method = function() private$..method$value,
        calculate_macro_auc = function() private$..calculate_macro_auc$value,
        calculate_micro_auc = function() private$..calculate_micro_auc$value,
        calculate_weighted_auc = function() private$..calculate_weighted_auc$value,
        confidence_intervals = function() private$..confidence_intervals$value,
        ci_method = function() private$..ci_method$value,
        bootstrap_samples = function() private$..bootstrap_samples$value,
        confidence_level = function() private$..confidence_level$value,
        pairwise_comparisons = function() private$..pairwise_comparisons$value,
        confusion_matrix = function() private$..confusion_matrix$value,
        class_metrics = function() private$..class_metrics$value,
        plot_roc_curves = function() private$..plot_roc_curves$value,
        plot_method = function() private$..plot_method$value,
        plot_diagonal = function() private$..plot_diagonal$value,
        random_seed = function() private$..random_seed$value),
    private = list(
        ..outcome = NA,
        ..predictors = NA,
        ..method = NA,
        ..calculate_macro_auc = NA,
        ..calculate_micro_auc = NA,
        ..calculate_weighted_auc = NA,
        ..confidence_intervals = NA,
        ..ci_method = NA,
        ..bootstrap_samples = NA,
        ..confidence_level = NA,
        ..pairwise_comparisons = NA,
        ..confusion_matrix = NA,
        ..class_metrics = NA,
        ..plot_roc_curves = NA,
        ..plot_method = NA,
        ..plot_diagonal = NA,
        ..random_seed = NA)
)

multiclassrocResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "multiclassrocResults",
    inherit = jmvcore::Group,
    active = list(
        instructionsText = function() private$.items[["instructionsText"]],
        summaryTable = function() private$.items[["summaryTable"]],
        classAucTable = function() private$.items[["classAucTable"]],
        pairwiseTable = function() private$.items[["pairwiseTable"]],
        classMetricsTable = function() private$.items[["classMetricsTable"]],
        confusionMatrix = function() private$.items[["confusionMatrix"]],
        rocPlot = function() private$.items[["rocPlot"]],
        interpretationText = function() private$.items[["interpretationText"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Multi-class ROC Analysis")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructionsText",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="summaryTable",
                title="Multi-class ROC Summary",
                rows=1,
                visible="(calculate_macro_auc || calculate_micro_auc || calculate_weighted_auc)",
                clearWith=list(
                    "outcome",
                    "predictors",
                    "method",
                    "confidence_intervals"),
                columns=list(
                    list(
                        `name`="n_classes", 
                        `title`="Number of Classes", 
                        `type`="integer"),
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"),
                    list(
                        `name`="macro_auc", 
                        `title`="Macro-Average AUC", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="macro_ci_lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto,pvalue", 
                        `visible`="(confidence_intervals)"),
                    list(
                        `name`="macro_ci_upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto,pvalue", 
                        `visible`="(confidence_intervals)"),
                    list(
                        `name`="micro_auc", 
                        `title`="Micro-Average AUC", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="micro_ci_lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto,pvalue", 
                        `visible`="(confidence_intervals)"),
                    list(
                        `name`="micro_ci_upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto,pvalue", 
                        `visible`="(confidence_intervals)"),
                    list(
                        `name`="weighted_auc", 
                        `title`="Weighted-Average AUC", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="classAucTable",
                title="Per-Class AUC Values",
                visible=TRUE,
                clearWith=list(
                    "outcome",
                    "predictors",
                    "method",
                    "confidence_intervals"),
                columns=list(
                    list(
                        `name`="class_name", 
                        `title`="Class", 
                        `type`="text", 
                        `combineBelow`=TRUE),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="prevalence", 
                        `title`="Prevalence", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="auc", 
                        `title`="AUC", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto,pvalue", 
                        `visible`="(confidence_intervals)"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto,pvalue", 
                        `visible`="(confidence_intervals)"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="pairwiseTable",
                title="Pairwise Class Comparisons (One-vs-One)",
                visible="(pairwise_comparisons && method:ovo)",
                clearWith=list(
                    "outcome",
                    "predictors",
                    "confidence_intervals"),
                columns=list(
                    list(
                        `name`="class_a", 
                        `title`="Class A", 
                        `type`="text"),
                    list(
                        `name`="class_b", 
                        `title`="Class B", 
                        `type`="text"),
                    list(
                        `name`="n_a", 
                        `title`="N(A)", 
                        `type`="integer"),
                    list(
                        `name`="n_b", 
                        `title`="N(B)", 
                        `type`="integer"),
                    list(
                        `name`="auc", 
                        `title`="AUC", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto,pvalue", 
                        `visible`="(confidence_intervals)"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto,pvalue", 
                        `visible`="(confidence_intervals)"),
                    list(
                        `name`="p_value", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="classMetricsTable",
                title="Per-Class Performance Metrics",
                visible="(class_metrics)",
                clearWith=list(
                    "outcome",
                    "predictors",
                    "method"),
                columns=list(
                    list(
                        `name`="class_name", 
                        `title`="Class", 
                        `type`="text"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="ppv", 
                        `title`="PPV", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="npv", 
                        `title`="NPV", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="f1_score", 
                        `title`="F1-Score", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="optimal_threshold", 
                        `title`="Optimal Threshold", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="confusionMatrix",
                title="Confusion Matrix",
                visible="(confusion_matrix)",
                clearWith=list(
                    "outcome",
                    "predictors",
                    "method"),
                columns=list(
                    list(
                        `name`="true_class", 
                        `title`="True Class", 
                        `type`="text", 
                        `combineBelow`=TRUE))))
            self$add(jmvcore::Image$new(
                options=options,
                name="rocPlot",
                title="Multi-class ROC Curves",
                width=600,
                height=500,
                renderFun=".rocPlot",
                visible="(plot_roc_curves)",
                clearWith=list(
                    "outcome",
                    "predictors",
                    "method",
                    "plot_method",
                    "plot_diagonal")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretationText",
                title="Interpretation Guide",
                visible=TRUE))}))

multiclassrocBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "multiclassrocBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "multiclassroc",
                version = c(0,0,32),
                options = options,
                results = multiclassrocResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = TRUE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Multi-class ROC Analysis
#'
#' Multi-class ROC Analysis for evaluating diagnostic performance with 3 or 
#' more
#' diagnostic classes. This analysis extends traditional binary ROC to handle
#' multi-category outcomes using one-vs-rest, one-vs-one, and global 
#' approaches.
#' 
#' Common applications include tumor subtype classification, disease staging 
#' with
#' multiple levels, and AI model validation for multi-class predictions.
#' 
#'
#' @examples
#' # Example with tumor subtype classification
#' data <- data.frame(
#'   true_class = factor(sample(c("TypeA", "TypeB", "TypeC"), 100, replace=TRUE)),
#'   score_A = rnorm(100),
#'   score_B = rnorm(100),
#'   score_C = rnorm(100)
#' )
#'
#' multiclassroc(
#'   data = data,
#'   outcome = 'true_class',
#'   predictors = c('score_A', 'score_B', 'score_C'),
#'   method = 'ovr',
#'   calculate_macro_auc = TRUE,
#'   confidence_intervals = TRUE
#' )
#'
#' @param data the data as a data frame
#' @param outcome a string naming the outcome variable (must have 3+ levels)
#' @param predictors a vector of strings naming predictor variables
#'   (continuous scores)
#' @param method method for multi-class ROC: 'ovr' (one class vs all others),
#'   'ovo' (all pairwise comparisons), or 'multinomial' (global probability
#'   model)
#' @param calculate_macro_auc calculate macro-average AUC across all classes
#'   (unweighted mean)
#' @param calculate_micro_auc calculate micro-average AUC (aggregate all
#'   predictions)
#' @param calculate_weighted_auc calculate weighted-average AUC (weighted by
#'   class prevalence)
#' @param confidence_intervals calculate confidence intervals for AUC
#'   estimates
#' @param ci_method method for confidence interval calculation
#' @param bootstrap_samples number of bootstrap samples for CI calculation
#' @param confidence_level confidence level for intervals (default: 0.95 for
#'   95\% CI)
#' @param pairwise_comparisons show detailed results for all pairwise class
#'   comparisons (OvO method)
#' @param confusion_matrix show confusion matrix at optimal global threshold
#' @param class_metrics calculate sensitivity, specificity, PPV, NPV for each
#'   class
#' @param plot_roc_curves plot ROC curves for each class
#' @param plot_method display method for ROC curves
#' @param plot_diagonal show diagonal reference line (random classifier)
#' @param random_seed random seed for reproducible bootstrap sampling
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructionsText} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summaryTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$classAucTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$pairwiseTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$classMetricsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$confusionMatrix} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$rocPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$interpretationText} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summaryTable$asDF}
#'
#' \code{as.data.frame(results$summaryTable)}
#'
#' @export
multiclassroc <- function(
    data,
    outcome,
    predictors,
    method = "ovr",
    calculate_macro_auc = TRUE,
    calculate_micro_auc = TRUE,
    calculate_weighted_auc = TRUE,
    confidence_intervals = TRUE,
    ci_method = "bootstrap",
    bootstrap_samples = 1000,
    confidence_level = 0.95,
    pairwise_comparisons = FALSE,
    confusion_matrix = TRUE,
    class_metrics = TRUE,
    plot_roc_curves = TRUE,
    plot_method = "overlay",
    plot_diagonal = TRUE,
    random_seed = 42) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("multiclassroc requires jmvcore to be installed (restart may be required)")

    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(predictors)) predictors <- jmvcore::resolveQuo(jmvcore::enquo(predictors))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(predictors), predictors, NULL))

    for (v in outcome) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- multiclassrocOptions$new(
        outcome = outcome,
        predictors = predictors,
        method = method,
        calculate_macro_auc = calculate_macro_auc,
        calculate_micro_auc = calculate_micro_auc,
        calculate_weighted_auc = calculate_weighted_auc,
        confidence_intervals = confidence_intervals,
        ci_method = ci_method,
        bootstrap_samples = bootstrap_samples,
        confidence_level = confidence_level,
        pairwise_comparisons = pairwise_comparisons,
        confusion_matrix = confusion_matrix,
        class_metrics = class_metrics,
        plot_roc_curves = plot_roc_curves,
        plot_method = plot_method,
        plot_diagonal = plot_diagonal,
        random_seed = random_seed)

    analysis <- multiclassrocClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

