
# This file is automatically generated, you probably don't want to edit this

trichotomousrocOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "trichotomousrocOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            predictor = NULL,
            outcome = NULL,
            positive_level = NULL,
            indeterminate_level = NULL,
            negative_level = NULL,
            threshold_method = "youden",
            lower_threshold = 0.33,
            upper_threshold = 0.67,
            cost_fn = 1,
            cost_fp = 1,
            cost_indeterminate = 0.5,
            confidence_level = 0.95,
            bootstrap_samples = 1000,
            bootstrap_method = "bca",
            calculate_vus = TRUE,
            category_sensitivities = TRUE,
            pairwise_comparisons = TRUE,
            confusion_matrix_3x3 = TRUE,
            plot_3d_surface = TRUE,
            plot_threshold_analysis = TRUE,
            plot_category_distributions = TRUE,
            plot_pairwise_rocs = FALSE,
            clinical_context = "general",
            show_clinical_interpretation = TRUE,
            indeterminate_action = "test",
            stratified_analysis = FALSE,
            stratify_by = NULL,
            missing_handling = "complete",
            random_seed = 123, ...) {

            super$initialize(
                package="ClinicoPath",
                name="trichotomousroc",
                requiresData=TRUE,
                ...)

            private$..predictor <- jmvcore::OptionVariable$new(
                "predictor",
                predictor,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..positive_level <- jmvcore::OptionLevel$new(
                "positive_level",
                positive_level,
                variable="(outcome)")
            private$..indeterminate_level <- jmvcore::OptionLevel$new(
                "indeterminate_level",
                indeterminate_level,
                variable="(outcome)")
            private$..negative_level <- jmvcore::OptionLevel$new(
                "negative_level",
                negative_level,
                variable="(outcome)")
            private$..threshold_method <- jmvcore::OptionList$new(
                "threshold_method",
                threshold_method,
                options=list(
                    "youden",
                    "clinical",
                    "fixed",
                    "tertile"),
                default="youden")
            private$..lower_threshold <- jmvcore::OptionNumber$new(
                "lower_threshold",
                lower_threshold,
                default=0.33)
            private$..upper_threshold <- jmvcore::OptionNumber$new(
                "upper_threshold",
                upper_threshold,
                default=0.67)
            private$..cost_fn <- jmvcore::OptionNumber$new(
                "cost_fn",
                cost_fn,
                default=1,
                min=0)
            private$..cost_fp <- jmvcore::OptionNumber$new(
                "cost_fp",
                cost_fp,
                default=1,
                min=0)
            private$..cost_indeterminate <- jmvcore::OptionNumber$new(
                "cost_indeterminate",
                cost_indeterminate,
                default=0.5,
                min=0,
                max=2)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.8,
                max=0.99)
            private$..bootstrap_samples <- jmvcore::OptionInteger$new(
                "bootstrap_samples",
                bootstrap_samples,
                default=1000,
                min=100,
                max=10000)
            private$..bootstrap_method <- jmvcore::OptionList$new(
                "bootstrap_method",
                bootstrap_method,
                options=list(
                    "percentile",
                    "bca"),
                default="bca")
            private$..calculate_vus <- jmvcore::OptionBool$new(
                "calculate_vus",
                calculate_vus,
                default=TRUE)
            private$..category_sensitivities <- jmvcore::OptionBool$new(
                "category_sensitivities",
                category_sensitivities,
                default=TRUE)
            private$..pairwise_comparisons <- jmvcore::OptionBool$new(
                "pairwise_comparisons",
                pairwise_comparisons,
                default=TRUE)
            private$..confusion_matrix_3x3 <- jmvcore::OptionBool$new(
                "confusion_matrix_3x3",
                confusion_matrix_3x3,
                default=TRUE)
            private$..plot_3d_surface <- jmvcore::OptionBool$new(
                "plot_3d_surface",
                plot_3d_surface,
                default=TRUE)
            private$..plot_threshold_analysis <- jmvcore::OptionBool$new(
                "plot_threshold_analysis",
                plot_threshold_analysis,
                default=TRUE)
            private$..plot_category_distributions <- jmvcore::OptionBool$new(
                "plot_category_distributions",
                plot_category_distributions,
                default=TRUE)
            private$..plot_pairwise_rocs <- jmvcore::OptionBool$new(
                "plot_pairwise_rocs",
                plot_pairwise_rocs,
                default=FALSE)
            private$..clinical_context <- jmvcore::OptionList$new(
                "clinical_context",
                clinical_context,
                options=list(
                    "general",
                    "her2",
                    "pdl1",
                    "cytology",
                    "grading"),
                default="general")
            private$..show_clinical_interpretation <- jmvcore::OptionBool$new(
                "show_clinical_interpretation",
                show_clinical_interpretation,
                default=TRUE)
            private$..indeterminate_action <- jmvcore::OptionList$new(
                "indeterminate_action",
                indeterminate_action,
                options=list(
                    "test",
                    "judgment",
                    "repeat",
                    "positive",
                    "negative"),
                default="test")
            private$..stratified_analysis <- jmvcore::OptionBool$new(
                "stratified_analysis",
                stratified_analysis,
                default=FALSE)
            private$..stratify_by <- jmvcore::OptionVariable$new(
                "stratify_by",
                stratify_by,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..missing_handling <- jmvcore::OptionList$new(
                "missing_handling",
                missing_handling,
                options=list(
                    "complete",
                    "imputation"),
                default="complete")
            private$..random_seed <- jmvcore::OptionInteger$new(
                "random_seed",
                random_seed,
                default=123,
                min=1,
                max=999999)

            self$.addOption(private$..predictor)
            self$.addOption(private$..outcome)
            self$.addOption(private$..positive_level)
            self$.addOption(private$..indeterminate_level)
            self$.addOption(private$..negative_level)
            self$.addOption(private$..threshold_method)
            self$.addOption(private$..lower_threshold)
            self$.addOption(private$..upper_threshold)
            self$.addOption(private$..cost_fn)
            self$.addOption(private$..cost_fp)
            self$.addOption(private$..cost_indeterminate)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..bootstrap_samples)
            self$.addOption(private$..bootstrap_method)
            self$.addOption(private$..calculate_vus)
            self$.addOption(private$..category_sensitivities)
            self$.addOption(private$..pairwise_comparisons)
            self$.addOption(private$..confusion_matrix_3x3)
            self$.addOption(private$..plot_3d_surface)
            self$.addOption(private$..plot_threshold_analysis)
            self$.addOption(private$..plot_category_distributions)
            self$.addOption(private$..plot_pairwise_rocs)
            self$.addOption(private$..clinical_context)
            self$.addOption(private$..show_clinical_interpretation)
            self$.addOption(private$..indeterminate_action)
            self$.addOption(private$..stratified_analysis)
            self$.addOption(private$..stratify_by)
            self$.addOption(private$..missing_handling)
            self$.addOption(private$..random_seed)
        }),
    active = list(
        predictor = function() private$..predictor$value,
        outcome = function() private$..outcome$value,
        positive_level = function() private$..positive_level$value,
        indeterminate_level = function() private$..indeterminate_level$value,
        negative_level = function() private$..negative_level$value,
        threshold_method = function() private$..threshold_method$value,
        lower_threshold = function() private$..lower_threshold$value,
        upper_threshold = function() private$..upper_threshold$value,
        cost_fn = function() private$..cost_fn$value,
        cost_fp = function() private$..cost_fp$value,
        cost_indeterminate = function() private$..cost_indeterminate$value,
        confidence_level = function() private$..confidence_level$value,
        bootstrap_samples = function() private$..bootstrap_samples$value,
        bootstrap_method = function() private$..bootstrap_method$value,
        calculate_vus = function() private$..calculate_vus$value,
        category_sensitivities = function() private$..category_sensitivities$value,
        pairwise_comparisons = function() private$..pairwise_comparisons$value,
        confusion_matrix_3x3 = function() private$..confusion_matrix_3x3$value,
        plot_3d_surface = function() private$..plot_3d_surface$value,
        plot_threshold_analysis = function() private$..plot_threshold_analysis$value,
        plot_category_distributions = function() private$..plot_category_distributions$value,
        plot_pairwise_rocs = function() private$..plot_pairwise_rocs$value,
        clinical_context = function() private$..clinical_context$value,
        show_clinical_interpretation = function() private$..show_clinical_interpretation$value,
        indeterminate_action = function() private$..indeterminate_action$value,
        stratified_analysis = function() private$..stratified_analysis$value,
        stratify_by = function() private$..stratify_by$value,
        missing_handling = function() private$..missing_handling$value,
        random_seed = function() private$..random_seed$value),
    private = list(
        ..predictor = NA,
        ..outcome = NA,
        ..positive_level = NA,
        ..indeterminate_level = NA,
        ..negative_level = NA,
        ..threshold_method = NA,
        ..lower_threshold = NA,
        ..upper_threshold = NA,
        ..cost_fn = NA,
        ..cost_fp = NA,
        ..cost_indeterminate = NA,
        ..confidence_level = NA,
        ..bootstrap_samples = NA,
        ..bootstrap_method = NA,
        ..calculate_vus = NA,
        ..category_sensitivities = NA,
        ..pairwise_comparisons = NA,
        ..confusion_matrix_3x3 = NA,
        ..plot_3d_surface = NA,
        ..plot_threshold_analysis = NA,
        ..plot_category_distributions = NA,
        ..plot_pairwise_rocs = NA,
        ..clinical_context = NA,
        ..show_clinical_interpretation = NA,
        ..indeterminate_action = NA,
        ..stratified_analysis = NA,
        ..stratify_by = NA,
        ..missing_handling = NA,
        ..random_seed = NA)
)

trichotomousrocResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "trichotomousrocResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        performanceSummary = function() private$.items[["performanceSummary"]],
        vusTable = function() private$.items[["vusTable"]],
        thresholdsTable = function() private$.items[["thresholdsTable"]],
        confusionMatrix3x3 = function() private$.items[["confusionMatrix3x3"]],
        categorySensitivitiesTable = function() private$.items[["categorySensitivitiesTable"]],
        pairwiseROCTable = function() private$.items[["pairwiseROCTable"]],
        clinicalImpactTable = function() private$.items[["clinicalImpactTable"]],
        stratifiedAnalysisTable = function() private$.items[["stratifiedAnalysisTable"]],
        surface3DPlot = function() private$.items[["surface3DPlot"]],
        thresholdAnalysisPlot = function() private$.items[["thresholdAnalysisPlot"]],
        categoryDistributionPlot = function() private$.items[["categoryDistributionPlot"]],
        pairwiseROCPlot = function() private$.items[["pairwiseROCPlot"]],
        clinicalInterpretation = function() private$.items[["clinicalInterpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Trichotomous (Three-way) ROC Analysis",
                refs=list(
                    "DiagTest3Grp",
                    "ThreeWayROC",
                    "pROC",
                    "ggplot2",
                    "plotly",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="performanceSummary",
                title="Trichotomous Performance Summary",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="vusTable",
                title="Volume Under Surface (VUS)",
                visible="(calculate_vus)",
                columns=list(
                    list(
                        `name`="vus", 
                        `title`="VUS", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="comparison_to_random", 
                        `title`="vs Random (0.167)", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="thresholdsTable",
                title="Optimal Thresholds",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="threshold_type", 
                        `title`="Threshold", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="method", 
                        `title`="Selection Method", 
                        `type`="text"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="confusionMatrix3x3",
                title="3\u00D73 Confusion Matrix",
                visible="(confusion_matrix_3x3)",
                rows=3,
                columns=list(
                    list(
                        `name`="true_category", 
                        `title`="True Category", 
                        `type`="text"),
                    list(
                        `name`="pred_positive", 
                        `title`="Predicted Positive", 
                        `type`="integer"),
                    list(
                        `name`="pred_indeterminate", 
                        `title`="Predicted Indeterminate", 
                        `type`="integer"),
                    list(
                        `name`="pred_negative", 
                        `title`="Predicted Negative", 
                        `type`="integer"),
                    list(
                        `name`="total", 
                        `title`="Total", 
                        `type`="integer"),
                    list(
                        `name`="sensitivity", 
                        `title`="Category Sensitivity", 
                        `type`="number", 
                        `format`="pc"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="categorySensitivitiesTable",
                title="Category-Specific Sensitivities",
                visible="(category_sensitivities)",
                columns=list(
                    list(
                        `name`="category", 
                        `title`="Category", 
                        `type`="text"),
                    list(
                        `name`="n_cases", 
                        `title`="N Cases", 
                        `type`="integer"),
                    list(
                        `name`="correctly_classified", 
                        `title`="Correctly Classified", 
                        `type`="integer"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="pc"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="pairwiseROCTable",
                title="Pairwise Binary ROC Comparisons",
                visible="(pairwise_comparisons)",
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="auc", 
                        `title`="AUC", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="n_cases", 
                        `title`="N Cases", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="clinicalImpactTable",
                title="Clinical Impact of Indeterminate Zone",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="scenario", 
                        `title`="Scenario", 
                        `type`="text"),
                    list(
                        `name`="n_indeterminate", 
                        `title`="N Indeterminate", 
                        `type`="integer"),
                    list(
                        `name`="pct_indeterminate", 
                        `title`="% Indeterminate", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="additional_tests_needed", 
                        `title`="Additional Tests Needed", 
                        `type`="integer"),
                    list(
                        `name`="clinical_action", 
                        `title`="Clinical Action", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="stratifiedAnalysisTable",
                title="Stratified Analysis by Subgroup",
                visible="(stratified_analysis)",
                columns=list(
                    list(
                        `name`="stratum", 
                        `title`="Stratum", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="vus", 
                        `title`="VUS", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="lower_threshold", 
                        `title`="Lower Threshold", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="upper_threshold", 
                        `title`="Upper Threshold", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="surface3DPlot",
                title="3D ROC Surface",
                width=700,
                height=600,
                renderFun=".plot3DSurface",
                visible="(plot_3d_surface)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="thresholdAnalysisPlot",
                title="Threshold Sensitivity Analysis",
                width=700,
                height=500,
                renderFun=".plotThresholdAnalysis",
                visible="(plot_threshold_analysis)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="categoryDistributionPlot",
                title="Category Distribution with Thresholds",
                width=700,
                height=500,
                renderFun=".plotCategoryDistribution",
                visible="(plot_category_distributions)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="pairwiseROCPlot",
                title="Pairwise ROC Curves",
                width=700,
                height=500,
                renderFun=".plotPairwiseROC",
                visible="(plot_pairwise_rocs)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalInterpretation",
                title="Clinical Interpretation",
                visible="(show_clinical_interpretation)"))}))

trichotomousrocBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "trichotomousrocBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "trichotomousroc",
                version = c(0,0,32),
                options = options,
                results = trichotomousrocResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Trichotomous (Three-way) ROC Analysis
#'
#' Trichotomous ROC analysis for three-category diagnostic tests with 
#' positive, indeterminate (grey zone), and negative outcomes. Essential for 
#' biomarker scoring systems like HER2 (0-1+/2+/3+), PD-L1 expression levels, 
#' and cytology classifications with "atypical" results. Unlike binary ROC 
#' which only considers positive vs negative, trichotomous ROC accounts for 
#' the clinically important indeterminate zone where additional testing may be 
#' required. The analysis provides 3×3 confusion matrices, category-specific 
#' sensitivities and specificities, volume under the ROC surface (VUS) as a 3D 
#' extension of AUC, and optimal threshold determination for each decision 
#' boundary. Particularly valuable for establishing clinical cutoffs in 
#' molecular pathology where grey-zone results trigger reflex testing (e.g., 
#' HER2 2+ requires FISH confirmation).
#' 
#'
#' @examples
#' result <- trichotomousroc(
#'     data = her2_data,
#'     predictor = "her2_score",
#'     outcome = "gold_standard",
#'     positive_level = "positive",
#'     indeterminate_level = "indeterminate",
#'     negative_level = "negative"
#' )
#'
#' @param data The data as a data frame.
#' @param predictor Continuous predictor variable (e.g., IHC H-score, gene
#'   expression level, AI probability score) used to classify cases into three
#'   categories.
#' @param outcome Three-level gold standard outcome variable defining the true
#'   classification (positive/indeterminate/negative or
#'   diseased/borderline/healthy).
#' @param positive_level Level of the outcome variable representing definite
#'   positive/diseased cases.
#' @param indeterminate_level Level of the outcome variable representing
#'   indeterminate/borderline/grey zone cases.
#' @param negative_level Level of the outcome variable representing definite
#'   negative/non-diseased cases.
#' @param threshold_method Method for determining the two thresholds that
#'   separate the three categories. Youden maximizes overall correct
#'   classification, clinical uses cost-benefit analysis, fixed allows manual
#'   threshold specification, tertile divides into equal thirds.
#' @param lower_threshold Lower threshold value when using fixed threshold
#'   method. Values below this are classified as negative. Required when
#'   threshold_method = 'fixed'.
#' @param upper_threshold Upper threshold value when using fixed threshold
#'   method. Values above this are classified as positive. Required when
#'   threshold_method = 'fixed'.
#' @param cost_fn Relative cost of misclassifying a positive case as negative.
#'   Higher values increase sensitivity at expense of specificity.
#' @param cost_fp Relative cost of misclassifying a negative case as positive.
#'   Higher values increase specificity at expense of sensitivity.
#' @param cost_indeterminate Relative cost of classifying a case as
#'   indeterminate (requiring additional testing). Typically lower than definite
#'   misclassification but higher than correct classification.
#' @param confidence_level Confidence level for intervals around VUS and
#'   performance metrics.
#' @param bootstrap_samples Number of bootstrap samples for confidence
#'   interval estimation. More samples provide more stable estimates but
#'   increase computation time.
#' @param bootstrap_method Bootstrap confidence interval method. BCa provides
#'   bias-corrected intervals.
#' @param calculate_vus Calculate Volume Under the ROC Surface, the 3D
#'   extension of AUC for three categories. VUS ranges from 0 to 1, where 0.167
#'   represents random classification and 1 represents perfect classification.
#'   Values > 0.167 indicate discriminatory ability.
#' @param category_sensitivities Calculate sensitivity for each category
#'   (ability to correctly identify positive, indeterminate, and negative cases
#'   respectively).
#' @param pairwise_comparisons Perform binary ROC analysis for all three
#'   pairwise comparisons: positive vs negative (ignoring indeterminate),
#'   positive vs indeterminate, and indeterminate vs negative.
#' @param confusion_matrix_3x3 Display full 3×3 confusion matrix showing all
#'   possible classification outcomes. Rows represent true categories, columns
#'   represent predicted categories.
#' @param plot_3d_surface Create 3D visualization of the ROC surface. The
#'   surface extends the 2D ROC curve to three dimensions, showing
#'   classification performance across all threshold combinations.
#' @param plot_threshold_analysis Plot showing how classification metrics vary
#'   with different threshold combinations. Helps visualize the trade-off
#'   between definite and indeterminate classifications.
#' @param plot_category_distributions Display distribution of predictor scores
#'   for each outcome category with threshold lines showing decision boundaries.
#' @param plot_pairwise_rocs Show the three pairwise binary ROC curves for
#'   comparison with the trichotomous analysis.
#' @param clinical_context Clinical context for interpretation assistance.
#'   Provides context-specific guidance on threshold selection and clinical
#'   implications.
#' @param show_clinical_interpretation Provide clinical interpretation of
#'   results including recommendations for threshold use and implications for
#'   patient management.
#' @param indeterminate_action Specify the clinical action for cases
#'   classified as indeterminate. This affects the interpretation of diagnostic
#'   performance metrics.
#' @param stratified_analysis Perform stratified trichotomous ROC analysis by
#'   important subgroups to assess consistency across populations.
#' @param stratify_by Variable defining strata for stratified analysis. Each
#'   level will receive separate trichotomous ROC analysis.
#' @param missing_handling Method for handling missing data in predictor or
#'   outcome variables.
#' @param random_seed Random seed for bootstrap sampling. Ensures reproducible
#'   results.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$performanceSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$vusTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$thresholdsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$confusionMatrix3x3} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$categorySensitivitiesTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$pairwiseROCTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clinicalImpactTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$stratifiedAnalysisTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$surface3DPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$thresholdAnalysisPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$categoryDistributionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$pairwiseROCPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$clinicalInterpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$performanceSummary$asDF}
#'
#' \code{as.data.frame(results$performanceSummary)}
#'
#' @export
trichotomousroc <- function(
    data,
    predictor,
    outcome,
    positive_level,
    indeterminate_level,
    negative_level,
    threshold_method = "youden",
    lower_threshold = 0.33,
    upper_threshold = 0.67,
    cost_fn = 1,
    cost_fp = 1,
    cost_indeterminate = 0.5,
    confidence_level = 0.95,
    bootstrap_samples = 1000,
    bootstrap_method = "bca",
    calculate_vus = TRUE,
    category_sensitivities = TRUE,
    pairwise_comparisons = TRUE,
    confusion_matrix_3x3 = TRUE,
    plot_3d_surface = TRUE,
    plot_threshold_analysis = TRUE,
    plot_category_distributions = TRUE,
    plot_pairwise_rocs = FALSE,
    clinical_context = "general",
    show_clinical_interpretation = TRUE,
    indeterminate_action = "test",
    stratified_analysis = FALSE,
    stratify_by,
    missing_handling = "complete",
    random_seed = 123) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("trichotomousroc requires jmvcore to be installed (restart may be required)")

    if ( ! missing(predictor)) predictor <- jmvcore::resolveQuo(jmvcore::enquo(predictor))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(stratify_by)) stratify_by <- jmvcore::resolveQuo(jmvcore::enquo(stratify_by))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(predictor), predictor, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(stratify_by), stratify_by, NULL))

    for (v in outcome) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in stratify_by) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- trichotomousrocOptions$new(
        predictor = predictor,
        outcome = outcome,
        positive_level = positive_level,
        indeterminate_level = indeterminate_level,
        negative_level = negative_level,
        threshold_method = threshold_method,
        lower_threshold = lower_threshold,
        upper_threshold = upper_threshold,
        cost_fn = cost_fn,
        cost_fp = cost_fp,
        cost_indeterminate = cost_indeterminate,
        confidence_level = confidence_level,
        bootstrap_samples = bootstrap_samples,
        bootstrap_method = bootstrap_method,
        calculate_vus = calculate_vus,
        category_sensitivities = category_sensitivities,
        pairwise_comparisons = pairwise_comparisons,
        confusion_matrix_3x3 = confusion_matrix_3x3,
        plot_3d_surface = plot_3d_surface,
        plot_threshold_analysis = plot_threshold_analysis,
        plot_category_distributions = plot_category_distributions,
        plot_pairwise_rocs = plot_pairwise_rocs,
        clinical_context = clinical_context,
        show_clinical_interpretation = show_clinical_interpretation,
        indeterminate_action = indeterminate_action,
        stratified_analysis = stratified_analysis,
        stratify_by = stratify_by,
        missing_handling = missing_handling,
        random_seed = random_seed)

    analysis <- trichotomousrocClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

