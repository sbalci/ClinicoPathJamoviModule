
# This file is automatically generated, you probably don't want to edit this

intervalcensorcureOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "intervalcensorcureOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            leftTime = NULL,
            rightTime = NULL,
            covariates = NULL,
            survivalDistribution = "weibull",
            cureModel = "mixture",
            includeUncured = TRUE,
            confidenceLevel = 0.95,
            maxIterations = 1000,
            tolerance = 0.000001,
            bootstrapSamples = 500,
            performBootstrap = FALSE,
            modelComparison = TRUE,
            plotSurvival = TRUE,
            plotCure = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="intervalcensorcure",
                requiresData=TRUE,
                ...)

            private$..leftTime <- jmvcore::OptionVariable$new(
                "leftTime",
                leftTime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..rightTime <- jmvcore::OptionVariable$new(
                "rightTime",
                rightTime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..survivalDistribution <- jmvcore::OptionList$new(
                "survivalDistribution",
                survivalDistribution,
                options=list(
                    "weibull",
                    "exponential",
                    "lognormal",
                    "loglogistic",
                    "gamma"),
                default="weibull")
            private$..cureModel <- jmvcore::OptionList$new(
                "cureModel",
                cureModel,
                options=list(
                    "mixture",
                    "non_mixture",
                    "promotion_time"),
                default="mixture")
            private$..includeUncured <- jmvcore::OptionBool$new(
                "includeUncured",
                includeUncured,
                default=TRUE)
            private$..confidenceLevel <- jmvcore::OptionNumber$new(
                "confidenceLevel",
                confidenceLevel,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..maxIterations <- jmvcore::OptionInteger$new(
                "maxIterations",
                maxIterations,
                min=100,
                max=10000,
                default=1000)
            private$..tolerance <- jmvcore::OptionNumber$new(
                "tolerance",
                tolerance,
                min=1e-8,
                max=0.001,
                default=0.000001)
            private$..bootstrapSamples <- jmvcore::OptionInteger$new(
                "bootstrapSamples",
                bootstrapSamples,
                min=100,
                max=5000,
                default=500)
            private$..performBootstrap <- jmvcore::OptionBool$new(
                "performBootstrap",
                performBootstrap,
                default=FALSE)
            private$..modelComparison <- jmvcore::OptionBool$new(
                "modelComparison",
                modelComparison,
                default=TRUE)
            private$..plotSurvival <- jmvcore::OptionBool$new(
                "plotSurvival",
                plotSurvival,
                default=TRUE)
            private$..plotCure <- jmvcore::OptionBool$new(
                "plotCure",
                plotCure,
                default=TRUE)

            self$.addOption(private$..leftTime)
            self$.addOption(private$..rightTime)
            self$.addOption(private$..covariates)
            self$.addOption(private$..survivalDistribution)
            self$.addOption(private$..cureModel)
            self$.addOption(private$..includeUncured)
            self$.addOption(private$..confidenceLevel)
            self$.addOption(private$..maxIterations)
            self$.addOption(private$..tolerance)
            self$.addOption(private$..bootstrapSamples)
            self$.addOption(private$..performBootstrap)
            self$.addOption(private$..modelComparison)
            self$.addOption(private$..plotSurvival)
            self$.addOption(private$..plotCure)
        }),
    active = list(
        leftTime = function() private$..leftTime$value,
        rightTime = function() private$..rightTime$value,
        covariates = function() private$..covariates$value,
        survivalDistribution = function() private$..survivalDistribution$value,
        cureModel = function() private$..cureModel$value,
        includeUncured = function() private$..includeUncured$value,
        confidenceLevel = function() private$..confidenceLevel$value,
        maxIterations = function() private$..maxIterations$value,
        tolerance = function() private$..tolerance$value,
        bootstrapSamples = function() private$..bootstrapSamples$value,
        performBootstrap = function() private$..performBootstrap$value,
        modelComparison = function() private$..modelComparison$value,
        plotSurvival = function() private$..plotSurvival$value,
        plotCure = function() private$..plotCure$value),
    private = list(
        ..leftTime = NA,
        ..rightTime = NA,
        ..covariates = NA,
        ..survivalDistribution = NA,
        ..cureModel = NA,
        ..includeUncured = NA,
        ..confidenceLevel = NA,
        ..maxIterations = NA,
        ..tolerance = NA,
        ..bootstrapSamples = NA,
        ..performBootstrap = NA,
        ..modelComparison = NA,
        ..plotSurvival = NA,
        ..plotCure = NA)
)

intervalcensorcureResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "intervalcensorcureResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        modelSummary = function() private$.items[["modelSummary"]],
        cureResults = function() private$.items[["cureResults"]],
        survivalResults = function() private$.items[["survivalResults"]],
        modelFit = function() private$.items[["modelFit"]],
        modelComparison = function() private$.items[["modelComparison"]],
        bootstrapResults = function() private$.items[["bootstrapResults"]],
        survivalPlot = function() private$.items[["survivalPlot"]],
        curePlot = function() private$.items[["curePlot"]],
        modelSummaryText = function() private$.items[["modelSummaryText"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Interval-Censored Cure Models")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="Standard Error", 
                        `type`="number"),
                    list(
                        `name`="z_value", 
                        `title`="Z-value", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower 95% CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper 95% CI", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="cureResults",
                title="Cure Fraction Analysis",
                visible="(includeUncured)",
                columns=list(
                    list(
                        `name`="covariate", 
                        `title`="Covariate", 
                        `type`="text"),
                    list(
                        `name`="cure_fraction", 
                        `title`="Cure Fraction", 
                        `type`="number"),
                    list(
                        `name`="cure_se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="cure_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="cure_upper", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="survivalResults",
                title="Survival Parameters",
                visible="(includeUncured)",
                columns=list(
                    list(
                        `name`="parameter_name", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="parameter_value", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="parameter_se", 
                        `title`="Standard Error", 
                        `type`="number"),
                    list(
                        `name`="parameter_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="parameter_upper", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelFit",
                title="Model Fit Statistics",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelComparison",
                title="Model Comparison",
                visible="(modelComparison)",
                columns=list(
                    list(
                        `name`="distribution", 
                        `title`="Distribution", 
                        `type`="text"),
                    list(
                        `name`="loglik", 
                        `title`="Log-Likelihood", 
                        `type`="number"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number"),
                    list(
                        `name`="convergence", 
                        `title`="Convergence", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="bootstrapResults",
                title="Bootstrap Analysis",
                visible="(performBootstrap)",
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="boot_mean", 
                        `title`="Bootstrap Mean", 
                        `type`="number"),
                    list(
                        `name`="boot_se", 
                        `title`="Bootstrap SE", 
                        `type`="number"),
                    list(
                        `name`="boot_lower", 
                        `title`="Bootstrap Lower CI", 
                        `type`="number"),
                    list(
                        `name`="boot_upper", 
                        `title`="Bootstrap Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlot",
                title="Survival Function Plot",
                visible="(plotSurvival)",
                width=700,
                height=500,
                renderFun=".survivalPlot"))
            self$add(jmvcore::Image$new(
                options=options,
                name="curePlot",
                title="Cure Fraction Plot",
                visible="(plotCure && includeUncured)",
                width=600,
                height=400,
                renderFun=".curePlot"))
            self$add(jmvcore::Html$new(
                options=options,
                name="modelSummaryText",
                title="Analysis Summary",
                visible=TRUE))}))

intervalcensorcureBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "intervalcensorcureBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "intervalcensorcure",
                version = c(1,0,0),
                options = options,
                results = intervalcensorcureResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Interval-Censored Cure Models
#'
#' Performs cure model analysis for interval-censored survival data using 
#' the ICGOR (Interval-Censored Generalized Odds Rate) methodology. This 
#' approach is specifically designed for situations where the exact event 
#' time is not known, but falls within an interval, and a fraction of the 
#' population may be cured (i.e., will never experience the event).
#' 
#' Key features:
#' - Mixture and non-mixture cure models
#' - Various survival distributions (Weibull, exponential, log-normal, 
#' log-logistic)
#' - Covariate effects on both cure fraction and survival parameters
#' - Model comparison and goodness-of-fit assessment
#' - Bootstrap confidence intervals
#' - Parametric and non-parametric approaches
#' 
#'
#' @examples
#' # Interval-censored cure model with Weibull distribution
#' intervalcensorcure(
#'     data = data,
#'     leftTime = "left_time",
#'     rightTime = "right_time",
#'     covariates = c("age", "treatment"),
#'     survivalDistribution = "weibull",
#'     cureModel = "mixture",
#'     includeUncured = TRUE
#' )
#'
#' @param data the data as a data frame
#' @param leftTime the left endpoint of the interval for interval-censored
#'   observations
#' @param rightTime the right endpoint of the interval for interval-censored
#'   observations
#' @param covariates covariates to include in the cure model
#' @param survivalDistribution the parametric survival distribution for the
#'   uncured fraction
#' @param cureModel the type of cure model to fit
#' @param includeUncured whether to include detailed analysis of the uncured
#'   fraction
#' @param confidenceLevel the confidence level for parameter estimates
#' @param maxIterations maximum number of iterations for model convergence
#' @param tolerance convergence tolerance for parameter estimation
#' @param bootstrapSamples number of bootstrap samples for confidence
#'   intervals
#' @param performBootstrap whether to perform bootstrap analysis for
#'   confidence intervals
#' @param modelComparison whether to perform model comparison across different
#'   distributions
#' @param plotSurvival whether to plot estimated survival functions
#' @param plotCure whether to plot cure fraction estimates
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$cureResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$survivalResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelFit} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$bootstrapResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$survivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$curePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$modelSummaryText} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelSummary$asDF}
#'
#' \code{as.data.frame(results$modelSummary)}
#'
#' @export
intervalcensorcure <- function(
    data,
    leftTime,
    rightTime,
    covariates,
    survivalDistribution = "weibull",
    cureModel = "mixture",
    includeUncured = TRUE,
    confidenceLevel = 0.95,
    maxIterations = 1000,
    tolerance = 0.000001,
    bootstrapSamples = 500,
    performBootstrap = FALSE,
    modelComparison = TRUE,
    plotSurvival = TRUE,
    plotCure = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("intervalcensorcure requires jmvcore to be installed (restart may be required)")

    if ( ! missing(leftTime)) leftTime <- jmvcore::resolveQuo(jmvcore::enquo(leftTime))
    if ( ! missing(rightTime)) rightTime <- jmvcore::resolveQuo(jmvcore::enquo(rightTime))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(leftTime), leftTime, NULL),
            `if`( ! missing(rightTime), rightTime, NULL),
            `if`( ! missing(covariates), covariates, NULL))


    options <- intervalcensorcureOptions$new(
        leftTime = leftTime,
        rightTime = rightTime,
        covariates = covariates,
        survivalDistribution = survivalDistribution,
        cureModel = cureModel,
        includeUncured = includeUncured,
        confidenceLevel = confidenceLevel,
        maxIterations = maxIterations,
        tolerance = tolerance,
        bootstrapSamples = bootstrapSamples,
        performBootstrap = performBootstrap,
        modelComparison = modelComparison,
        plotSurvival = plotSurvival,
        plotCure = plotCure)

    analysis <- intervalcensorcureClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

