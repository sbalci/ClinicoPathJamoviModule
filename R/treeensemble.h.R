
# This file is automatically generated, you probably don't want to edit this

treeensembleOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "treeensembleOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            vars = NULL,
            facs = NULL,
            target = NULL,
            targetLevel = NULL,
            n_trees = 500,
            mtry_method = "auto",
            mtry_custom = 3,
            min_node_size = 5,
            validation = "oob",
            cv_folds = 5,
            test_split = 0.25,
            importance_type = "permutation",
            feature_selection = FALSE,
            max_features = 10,
            clinical_context = "biomarker",
            class_weights = FALSE,
            show_performance_metrics = TRUE,
            show_importance_plot = TRUE,
            show_oob_error = TRUE,
            show_confusion_matrix = TRUE,
            show_clinical_interpretation = TRUE,
            set_seed = TRUE,
            seed_value = 42, ...) {

            super$initialize(
                package="ClinicoPath",
                name="treeensemble",
                requiresData=TRUE,
                ...)

            private$..vars <- jmvcore::OptionVariables$new(
                "vars",
                vars,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..facs <- jmvcore::OptionVariables$new(
                "facs",
                facs,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..target <- jmvcore::OptionVariable$new(
                "target",
                target,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..targetLevel <- jmvcore::OptionLevel$new(
                "targetLevel",
                targetLevel,
                variable="(target)")
            private$..n_trees <- jmvcore::OptionInteger$new(
                "n_trees",
                n_trees,
                default=500,
                min=50,
                max=2000)
            private$..mtry_method <- jmvcore::OptionList$new(
                "mtry_method",
                mtry_method,
                options=list(
                    "auto",
                    "custom"),
                default="auto")
            private$..mtry_custom <- jmvcore::OptionInteger$new(
                "mtry_custom",
                mtry_custom,
                default=3,
                min=1,
                max=20)
            private$..min_node_size <- jmvcore::OptionInteger$new(
                "min_node_size",
                min_node_size,
                default=5,
                min=1,
                max=50)
            private$..validation <- jmvcore::OptionList$new(
                "validation",
                validation,
                options=list(
                    "oob",
                    "cv",
                    "holdout"),
                default="oob")
            private$..cv_folds <- jmvcore::OptionInteger$new(
                "cv_folds",
                cv_folds,
                default=5,
                min=3,
                max=10)
            private$..test_split <- jmvcore::OptionNumber$new(
                "test_split",
                test_split,
                default=0.25,
                min=0.1,
                max=0.4)
            private$..importance_type <- jmvcore::OptionList$new(
                "importance_type",
                importance_type,
                options=list(
                    "permutation",
                    "gini",
                    "both"),
                default="permutation")
            private$..feature_selection <- jmvcore::OptionBool$new(
                "feature_selection",
                feature_selection,
                default=FALSE)
            private$..max_features <- jmvcore::OptionInteger$new(
                "max_features",
                max_features,
                default=10,
                min=2,
                max=50)
            private$..clinical_context <- jmvcore::OptionList$new(
                "clinical_context",
                clinical_context,
                options=list(
                    "biomarker",
                    "diagnosis",
                    "prognosis",
                    "treatment"),
                default="biomarker")
            private$..class_weights <- jmvcore::OptionBool$new(
                "class_weights",
                class_weights,
                default=FALSE)
            private$..show_performance_metrics <- jmvcore::OptionBool$new(
                "show_performance_metrics",
                show_performance_metrics,
                default=TRUE)
            private$..show_importance_plot <- jmvcore::OptionBool$new(
                "show_importance_plot",
                show_importance_plot,
                default=TRUE)
            private$..show_oob_error <- jmvcore::OptionBool$new(
                "show_oob_error",
                show_oob_error,
                default=TRUE)
            private$..show_confusion_matrix <- jmvcore::OptionBool$new(
                "show_confusion_matrix",
                show_confusion_matrix,
                default=TRUE)
            private$..show_clinical_interpretation <- jmvcore::OptionBool$new(
                "show_clinical_interpretation",
                show_clinical_interpretation,
                default=TRUE)
            private$..set_seed <- jmvcore::OptionBool$new(
                "set_seed",
                set_seed,
                default=TRUE)
            private$..seed_value <- jmvcore::OptionInteger$new(
                "seed_value",
                seed_value,
                default=42,
                min=1,
                max=999999)

            self$.addOption(private$..vars)
            self$.addOption(private$..facs)
            self$.addOption(private$..target)
            self$.addOption(private$..targetLevel)
            self$.addOption(private$..n_trees)
            self$.addOption(private$..mtry_method)
            self$.addOption(private$..mtry_custom)
            self$.addOption(private$..min_node_size)
            self$.addOption(private$..validation)
            self$.addOption(private$..cv_folds)
            self$.addOption(private$..test_split)
            self$.addOption(private$..importance_type)
            self$.addOption(private$..feature_selection)
            self$.addOption(private$..max_features)
            self$.addOption(private$..clinical_context)
            self$.addOption(private$..class_weights)
            self$.addOption(private$..show_performance_metrics)
            self$.addOption(private$..show_importance_plot)
            self$.addOption(private$..show_oob_error)
            self$.addOption(private$..show_confusion_matrix)
            self$.addOption(private$..show_clinical_interpretation)
            self$.addOption(private$..set_seed)
            self$.addOption(private$..seed_value)
        }),
    active = list(
        vars = function() private$..vars$value,
        facs = function() private$..facs$value,
        target = function() private$..target$value,
        targetLevel = function() private$..targetLevel$value,
        n_trees = function() private$..n_trees$value,
        mtry_method = function() private$..mtry_method$value,
        mtry_custom = function() private$..mtry_custom$value,
        min_node_size = function() private$..min_node_size$value,
        validation = function() private$..validation$value,
        cv_folds = function() private$..cv_folds$value,
        test_split = function() private$..test_split$value,
        importance_type = function() private$..importance_type$value,
        feature_selection = function() private$..feature_selection$value,
        max_features = function() private$..max_features$value,
        clinical_context = function() private$..clinical_context$value,
        class_weights = function() private$..class_weights$value,
        show_performance_metrics = function() private$..show_performance_metrics$value,
        show_importance_plot = function() private$..show_importance_plot$value,
        show_oob_error = function() private$..show_oob_error$value,
        show_confusion_matrix = function() private$..show_confusion_matrix$value,
        show_clinical_interpretation = function() private$..show_clinical_interpretation$value,
        set_seed = function() private$..set_seed$value,
        seed_value = function() private$..seed_value$value),
    private = list(
        ..vars = NA,
        ..facs = NA,
        ..target = NA,
        ..targetLevel = NA,
        ..n_trees = NA,
        ..mtry_method = NA,
        ..mtry_custom = NA,
        ..min_node_size = NA,
        ..validation = NA,
        ..cv_folds = NA,
        ..test_split = NA,
        ..importance_type = NA,
        ..feature_selection = NA,
        ..max_features = NA,
        ..clinical_context = NA,
        ..class_weights = NA,
        ..show_performance_metrics = NA,
        ..show_importance_plot = NA,
        ..show_oob_error = NA,
        ..show_confusion_matrix = NA,
        ..show_clinical_interpretation = NA,
        ..set_seed = NA,
        ..seed_value = NA)
)

treeensembleResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "treeensembleResults",
    inherit = jmvcore::Group,
    active = list(),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Clinical Random Forest Analysis")}))

treeensembleBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "treeensembleBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "treeensemble",
                version = c(0,0,31),
                options = options,
                results = treeensembleResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Clinical Random Forest Analysis
#'
#' Random Forest and ensemble methods for clinical research and biomarker 
#' discovery.
#' Provides high-accuracy predictions with robust feature importance analysis,
#' out-of-bag error estimation, and clinical interpretation guidelines.
#' 
#' @param data .
#' @param vars .
#' @param facs .
#' @param target .
#' @param targetLevel .
#' @param n_trees .
#' @param mtry_method .
#' @param mtry_custom .
#' @param min_node_size .
#' @param validation .
#' @param cv_folds .
#' @param test_split .
#' @param importance_type .
#' @param feature_selection .
#' @param max_features .
#' @param clinical_context .
#' @param class_weights .
#' @param show_performance_metrics .
#' @param show_importance_plot .
#' @param show_oob_error .
#' @param show_confusion_matrix .
#' @param show_clinical_interpretation .
#' @param set_seed .
#' @param seed_value .
#' @return A results object containing:
#' \tabular{llllll}{
#' }
#'
#' @export
treeensemble <- function(
    data,
    vars = NULL,
    facs = NULL,
    target,
    targetLevel,
    n_trees = 500,
    mtry_method = "auto",
    mtry_custom = 3,
    min_node_size = 5,
    validation = "oob",
    cv_folds = 5,
    test_split = 0.25,
    importance_type = "permutation",
    feature_selection = FALSE,
    max_features = 10,
    clinical_context = "biomarker",
    class_weights = FALSE,
    show_performance_metrics = TRUE,
    show_importance_plot = TRUE,
    show_oob_error = TRUE,
    show_confusion_matrix = TRUE,
    show_clinical_interpretation = TRUE,
    set_seed = TRUE,
    seed_value = 42) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("treeensemble requires jmvcore to be installed (restart may be required)")

    if ( ! missing(vars)) vars <- jmvcore::resolveQuo(jmvcore::enquo(vars))
    if ( ! missing(facs)) facs <- jmvcore::resolveQuo(jmvcore::enquo(facs))
    if ( ! missing(target)) target <- jmvcore::resolveQuo(jmvcore::enquo(target))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(vars), vars, NULL),
            `if`( ! missing(facs), facs, NULL),
            `if`( ! missing(target), target, NULL))

    for (v in facs) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in target) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- treeensembleOptions$new(
        vars = vars,
        facs = facs,
        target = target,
        targetLevel = targetLevel,
        n_trees = n_trees,
        mtry_method = mtry_method,
        mtry_custom = mtry_custom,
        min_node_size = min_node_size,
        validation = validation,
        cv_folds = cv_folds,
        test_split = test_split,
        importance_type = importance_type,
        feature_selection = feature_selection,
        max_features = max_features,
        clinical_context = clinical_context,
        class_weights = class_weights,
        show_performance_metrics = show_performance_metrics,
        show_importance_plot = show_importance_plot,
        show_oob_error = show_oob_error,
        show_confusion_matrix = show_confusion_matrix,
        show_clinical_interpretation = show_clinical_interpretation,
        set_seed = set_seed,
        seed_value = seed_value)

    analysis <- treeensembleClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

