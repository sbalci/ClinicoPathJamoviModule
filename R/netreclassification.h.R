
# This file is automatically generated, you probably don't want to edit this

netreclassificationOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "netreclassificationOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            outcome = NULL,
            baseline_risk = NULL,
            new_risk = NULL,
            time_var = NULL,
            followup_time = 5,
            nri_type = "categorical",
            risk_thresholds = "0.05, 0.10, 0.20",
            custom_categories = FALSE,
            category_labels = "Low, Intermediate, High, Very High",
            confidence_level = 0.95,
            bootstrap_samples = 1000,
            bootstrap_method = "bca",
            hypothesis_test = TRUE,
            decompose_nri = TRUE,
            direction_analysis = TRUE,
            show_transitions = TRUE,
            clinical_cutoffs = FALSE,
            treatment_threshold = 0.075,
            cost_effectiveness = FALSE,
            cross_validation = FALSE,
            cv_folds = 5,
            sensitivity_analysis = FALSE,
            show_summary = TRUE,
            show_reclassification = TRUE,
            show_performance = TRUE,
            plot_reclassification = TRUE,
            plot_risk_distribution = TRUE,
            plot_improvement = TRUE,
            plot_sensitivity = FALSE,
            competing_risks = FALSE,
            missing_handling = "complete",
            stratified_analysis = FALSE,
            subgroup_var = NULL,
            alpha_level = 0.05,
            random_seed = 123, ...) {

            super$initialize(
                package="ClinicoPath",
                name="netreclassification",
                requiresData=TRUE,
                ...)

            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..baseline_risk <- jmvcore::OptionVariable$new(
                "baseline_risk",
                baseline_risk,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..new_risk <- jmvcore::OptionVariable$new(
                "new_risk",
                new_risk,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..time_var <- jmvcore::OptionVariable$new(
                "time_var",
                time_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..followup_time <- jmvcore::OptionNumber$new(
                "followup_time",
                followup_time,
                default=5,
                min=0.1)
            private$..nri_type <- jmvcore::OptionList$new(
                "nri_type",
                nri_type,
                options=list(
                    "categorical",
                    "numeric",
                    "both"),
                default="categorical")
            private$..risk_thresholds <- jmvcore::OptionString$new(
                "risk_thresholds",
                risk_thresholds,
                default="0.05, 0.10, 0.20")
            private$..custom_categories <- jmvcore::OptionBool$new(
                "custom_categories",
                custom_categories,
                default=FALSE)
            private$..category_labels <- jmvcore::OptionString$new(
                "category_labels",
                category_labels,
                default="Low, Intermediate, High, Very High")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.5,
                max=0.99)
            private$..bootstrap_samples <- jmvcore::OptionInteger$new(
                "bootstrap_samples",
                bootstrap_samples,
                default=1000,
                min=100,
                max=10000)
            private$..bootstrap_method <- jmvcore::OptionList$new(
                "bootstrap_method",
                bootstrap_method,
                options=list(
                    "percentile",
                    "bca",
                    "basic"),
                default="bca")
            private$..hypothesis_test <- jmvcore::OptionBool$new(
                "hypothesis_test",
                hypothesis_test,
                default=TRUE)
            private$..decompose_nri <- jmvcore::OptionBool$new(
                "decompose_nri",
                decompose_nri,
                default=TRUE)
            private$..direction_analysis <- jmvcore::OptionBool$new(
                "direction_analysis",
                direction_analysis,
                default=TRUE)
            private$..show_transitions <- jmvcore::OptionBool$new(
                "show_transitions",
                show_transitions,
                default=TRUE)
            private$..clinical_cutoffs <- jmvcore::OptionBool$new(
                "clinical_cutoffs",
                clinical_cutoffs,
                default=FALSE)
            private$..treatment_threshold <- jmvcore::OptionNumber$new(
                "treatment_threshold",
                treatment_threshold,
                default=0.075,
                min=0.01,
                max=0.5)
            private$..cost_effectiveness <- jmvcore::OptionBool$new(
                "cost_effectiveness",
                cost_effectiveness,
                default=FALSE)
            private$..cross_validation <- jmvcore::OptionBool$new(
                "cross_validation",
                cross_validation,
                default=FALSE)
            private$..cv_folds <- jmvcore::OptionInteger$new(
                "cv_folds",
                cv_folds,
                default=5,
                min=3,
                max=10)
            private$..sensitivity_analysis <- jmvcore::OptionBool$new(
                "sensitivity_analysis",
                sensitivity_analysis,
                default=FALSE)
            private$..show_summary <- jmvcore::OptionBool$new(
                "show_summary",
                show_summary,
                default=TRUE)
            private$..show_reclassification <- jmvcore::OptionBool$new(
                "show_reclassification",
                show_reclassification,
                default=TRUE)
            private$..show_performance <- jmvcore::OptionBool$new(
                "show_performance",
                show_performance,
                default=TRUE)
            private$..plot_reclassification <- jmvcore::OptionBool$new(
                "plot_reclassification",
                plot_reclassification,
                default=TRUE)
            private$..plot_risk_distribution <- jmvcore::OptionBool$new(
                "plot_risk_distribution",
                plot_risk_distribution,
                default=TRUE)
            private$..plot_improvement <- jmvcore::OptionBool$new(
                "plot_improvement",
                plot_improvement,
                default=TRUE)
            private$..plot_sensitivity <- jmvcore::OptionBool$new(
                "plot_sensitivity",
                plot_sensitivity,
                default=FALSE)
            private$..competing_risks <- jmvcore::OptionBool$new(
                "competing_risks",
                competing_risks,
                default=FALSE)
            private$..missing_handling <- jmvcore::OptionList$new(
                "missing_handling",
                missing_handling,
                options=list(
                    "complete",
                    "imputation",
                    "ipw"),
                default="complete")
            private$..stratified_analysis <- jmvcore::OptionBool$new(
                "stratified_analysis",
                stratified_analysis,
                default=FALSE)
            private$..subgroup_var <- jmvcore::OptionVariable$new(
                "subgroup_var",
                subgroup_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..alpha_level <- jmvcore::OptionNumber$new(
                "alpha_level",
                alpha_level,
                default=0.05,
                min=0.001,
                max=0.2)
            private$..random_seed <- jmvcore::OptionInteger$new(
                "random_seed",
                random_seed,
                default=123,
                min=1,
                max=999999)

            self$.addOption(private$..outcome)
            self$.addOption(private$..baseline_risk)
            self$.addOption(private$..new_risk)
            self$.addOption(private$..time_var)
            self$.addOption(private$..followup_time)
            self$.addOption(private$..nri_type)
            self$.addOption(private$..risk_thresholds)
            self$.addOption(private$..custom_categories)
            self$.addOption(private$..category_labels)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..bootstrap_samples)
            self$.addOption(private$..bootstrap_method)
            self$.addOption(private$..hypothesis_test)
            self$.addOption(private$..decompose_nri)
            self$.addOption(private$..direction_analysis)
            self$.addOption(private$..show_transitions)
            self$.addOption(private$..clinical_cutoffs)
            self$.addOption(private$..treatment_threshold)
            self$.addOption(private$..cost_effectiveness)
            self$.addOption(private$..cross_validation)
            self$.addOption(private$..cv_folds)
            self$.addOption(private$..sensitivity_analysis)
            self$.addOption(private$..show_summary)
            self$.addOption(private$..show_reclassification)
            self$.addOption(private$..show_performance)
            self$.addOption(private$..plot_reclassification)
            self$.addOption(private$..plot_risk_distribution)
            self$.addOption(private$..plot_improvement)
            self$.addOption(private$..plot_sensitivity)
            self$.addOption(private$..competing_risks)
            self$.addOption(private$..missing_handling)
            self$.addOption(private$..stratified_analysis)
            self$.addOption(private$..subgroup_var)
            self$.addOption(private$..alpha_level)
            self$.addOption(private$..random_seed)
        }),
    active = list(
        outcome = function() private$..outcome$value,
        baseline_risk = function() private$..baseline_risk$value,
        new_risk = function() private$..new_risk$value,
        time_var = function() private$..time_var$value,
        followup_time = function() private$..followup_time$value,
        nri_type = function() private$..nri_type$value,
        risk_thresholds = function() private$..risk_thresholds$value,
        custom_categories = function() private$..custom_categories$value,
        category_labels = function() private$..category_labels$value,
        confidence_level = function() private$..confidence_level$value,
        bootstrap_samples = function() private$..bootstrap_samples$value,
        bootstrap_method = function() private$..bootstrap_method$value,
        hypothesis_test = function() private$..hypothesis_test$value,
        decompose_nri = function() private$..decompose_nri$value,
        direction_analysis = function() private$..direction_analysis$value,
        show_transitions = function() private$..show_transitions$value,
        clinical_cutoffs = function() private$..clinical_cutoffs$value,
        treatment_threshold = function() private$..treatment_threshold$value,
        cost_effectiveness = function() private$..cost_effectiveness$value,
        cross_validation = function() private$..cross_validation$value,
        cv_folds = function() private$..cv_folds$value,
        sensitivity_analysis = function() private$..sensitivity_analysis$value,
        show_summary = function() private$..show_summary$value,
        show_reclassification = function() private$..show_reclassification$value,
        show_performance = function() private$..show_performance$value,
        plot_reclassification = function() private$..plot_reclassification$value,
        plot_risk_distribution = function() private$..plot_risk_distribution$value,
        plot_improvement = function() private$..plot_improvement$value,
        plot_sensitivity = function() private$..plot_sensitivity$value,
        competing_risks = function() private$..competing_risks$value,
        missing_handling = function() private$..missing_handling$value,
        stratified_analysis = function() private$..stratified_analysis$value,
        subgroup_var = function() private$..subgroup_var$value,
        alpha_level = function() private$..alpha_level$value,
        random_seed = function() private$..random_seed$value),
    private = list(
        ..outcome = NA,
        ..baseline_risk = NA,
        ..new_risk = NA,
        ..time_var = NA,
        ..followup_time = NA,
        ..nri_type = NA,
        ..risk_thresholds = NA,
        ..custom_categories = NA,
        ..category_labels = NA,
        ..confidence_level = NA,
        ..bootstrap_samples = NA,
        ..bootstrap_method = NA,
        ..hypothesis_test = NA,
        ..decompose_nri = NA,
        ..direction_analysis = NA,
        ..show_transitions = NA,
        ..clinical_cutoffs = NA,
        ..treatment_threshold = NA,
        ..cost_effectiveness = NA,
        ..cross_validation = NA,
        ..cv_folds = NA,
        ..sensitivity_analysis = NA,
        ..show_summary = NA,
        ..show_reclassification = NA,
        ..show_performance = NA,
        ..plot_reclassification = NA,
        ..plot_risk_distribution = NA,
        ..plot_improvement = NA,
        ..plot_sensitivity = NA,
        ..competing_risks = NA,
        ..missing_handling = NA,
        ..stratified_analysis = NA,
        ..subgroup_var = NA,
        ..alpha_level = NA,
        ..random_seed = NA)
)

netreclassificationResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "netreclassificationResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        todo = function() private$.items[["todo"]],
        summary = function() private$.items[["summary"]],
        reclassification = function() private$.items[["reclassification"]],
        decomposition = function() private$.items[["decomposition"]],
        performance = function() private$.items[["performance"]],
        transitions = function() private$.items[["transitions"]],
        subgroupAnalysis = function() private$.items[["subgroupAnalysis"]],
        sensitivityTable = function() private$.items[["sensitivityTable"]],
        reclassificationPlot = function() private$.items[["reclassificationPlot"]],
        riskDistributionPlot = function() private$.items[["riskDistributionPlot"]],
        improvementPlot = function() private$.items[["improvementPlot"]],
        sensitivityPlot = function() private$.items[["sensitivityPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Analysis Results",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=FALSE))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis Todo",
                visible=FALSE))
            self$add(jmvcore::Table$new(
                options=options,
                name="summary",
                title="NRI Summary",
                visible="(show_summary)",
                clearWith=list(
                    "outcome",
                    "baseline_risk",
                    "new_risk",
                    "nri_type",
                    "risk_thresholds"),
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="reclassification",
                title="Reclassification Cross-Tabulation",
                visible="(show_reclassification)",
                clearWith=list(
                    "baseline_risk",
                    "new_risk",
                    "risk_thresholds",
                    "nri_type"),
                columns=list(
                    list(
                        `name`="baseline_category", 
                        `title`="Baseline Category", 
                        `type`="text"),
                    list(
                        `name`="new_low", 
                        `title`="Low Risk", 
                        `type`="integer"),
                    list(
                        `name`="new_intermediate", 
                        `title`="Intermediate Risk", 
                        `type`="integer"),
                    list(
                        `name`="new_high", 
                        `title`="High Risk", 
                        `type`="integer"),
                    list(
                        `name`="new_very_high", 
                        `title`="Very High Risk", 
                        `type`="integer"),
                    list(
                        `name`="total", 
                        `title`="Total", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="decomposition",
                title="NRI Decomposition",
                visible="(decompose_nri)",
                clearWith=list(
                    "outcome",
                    "baseline_risk",
                    "new_risk",
                    "nri_type"),
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="events_contribution", 
                        `title`="Events Contribution", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="nonevents_contribution", 
                        `title`="Non-Events Contribution", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="total_nri", 
                        `title`="Total NRI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="significance", 
                        `title`="Significance", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="performance",
                title="Model Performance Comparison",
                visible="(show_performance)",
                clearWith=list(
                    "outcome",
                    "baseline_risk",
                    "new_risk"),
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="c_statistic", 
                        `title`="C-Statistic", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="c_statistic_ci", 
                        `title`="C-Statistic CI", 
                        `type`="text"),
                    list(
                        `name`="calibration_slope", 
                        `title`="Calibration Slope", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="brier_score", 
                        `title`="Brier Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="r_squared", 
                        `title`="R\u00B2", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="transitions",
                title="Detailed Transition Matrix",
                visible="(show_transitions)",
                clearWith=list(
                    "baseline_risk",
                    "new_risk",
                    "risk_thresholds"),
                columns=list(
                    list(
                        `name`="transition_type", 
                        `title`="Transition", 
                        `type`="text"),
                    list(
                        `name`="events_n", 
                        `title`="Events (n)", 
                        `type`="integer"),
                    list(
                        `name`="events_percent", 
                        `title`="Events (%)", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="nonevents_n", 
                        `title`="Non-Events (n)", 
                        `type`="integer"),
                    list(
                        `name`="nonevents_percent", 
                        `title`="Non-Events (%)", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="net_benefit", 
                        `title`="Net Benefit", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="subgroupAnalysis",
                title="Subgroup Analysis",
                visible="(stratified_analysis)",
                clearWith=list(
                    "subgroup_var",
                    "outcome",
                    "baseline_risk",
                    "new_risk"),
                columns=list(
                    list(
                        `name`="subgroup", 
                        `title`="Subgroup", 
                        `type`="text"),
                    list(
                        `name`="n_subjects", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="nri_estimate", 
                        `title`="NRI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="nri_ci", 
                        `title`="95% CI", 
                        `type`="text"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="sensitivityTable",
                title="Sensitivity Analysis",
                visible="(sensitivity_analysis)",
                clearWith=list(
                    "risk_thresholds",
                    "outcome",
                    "baseline_risk",
                    "new_risk"),
                columns=list(
                    list(
                        `name`="threshold_set", 
                        `title`="Threshold Set", 
                        `type`="text"),
                    list(
                        `name`="nri_categorical", 
                        `title`="Categorical NRI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="nri_continuous", 
                        `title`="Continuous NRI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="consistency", 
                        `title`="Consistency", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="reclassificationPlot",
                title="Reclassification Visualization",
                width=600,
                height=500,
                visible="(plot_reclassification)",
                requiresData=TRUE,
                clearWith=list(
                    "baseline_risk",
                    "new_risk",
                    "risk_thresholds")))
            self$add(jmvcore::Image$new(
                options=options,
                name="riskDistributionPlot",
                title="Risk Distribution Comparison",
                width=500,
                height=400,
                visible="(plot_risk_distribution)",
                requiresData=TRUE,
                clearWith=list(
                    "outcome",
                    "baseline_risk",
                    "new_risk")))
            self$add(jmvcore::Image$new(
                options=options,
                name="improvementPlot",
                title="NRI Components Analysis",
                width=500,
                height=400,
                visible="(plot_improvement)",
                requiresData=TRUE,
                clearWith=list(
                    "decompose_nri",
                    "confidence_level")))
            self$add(jmvcore::Image$new(
                options=options,
                name="sensitivityPlot",
                title="Sensitivity Analysis Plot",
                width=500,
                height=400,
                visible="(plot_sensitivity)",
                requiresData=TRUE,
                clearWith=list(
                    "sensitivity_analysis",
                    "risk_thresholds")))}))

netreclassificationBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "netreclassificationBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "netreclassification",
                version = c(0,0,31),
                options = options,
                results = netreclassificationResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Net Reclassification Improvement (NRI)
#'
#' Net Reclassification Improvement (NRI) analysis for assessing the clinical 
#' utility of adding new biomarkers or risk factors to existing prediction 
#' models. NRI quantifies how well a new model reclassifies individuals into 
#' more appropriate risk categories compared to a baseline model. This 
#' implementation supports both categorical NRI (with predefined risk 
#' thresholds) and numeric NRI (risk-free approach). The analysis includes 
#' confidence intervals via bootstrap, statistical significance testing, and 
#' comprehensive visualization of reclassification patterns. Essential for 
#' biomarker validation studies, clinical decision making, and demonstrating 
#' incremental value of new predictors in medical research. Particularly 
#' valuable for risk prediction model development and validation in 
#' cardiovascular, oncology, and other clinical domains where risk 
#' stratification drives treatment decisions.
#' 
#'
#' @examples
#' result <- netreclassification(
#'     data = mydata,
#'     outcome = "event_indicator",
#'     baseline_risk = "baseline_predictions",
#'     new_risk = "new_model_predictions",
#'     risk_categories = c(0.05, 0.10, 0.20),
#'     time_point = 5,
#'     bootstrap_samples = 1000
#' )
#'
#' @param data The data as a data frame.
#' @param outcome Binary outcome variable (0/1) indicating event occurrence.
#'   For time-to-event data, this should be event status at the specified time
#'   point.
#' @param baseline_risk Predicted risks or probabilities from the baseline
#'   (reference) model. Should be on probability scale (0-1) for risk
#'   predictions.
#' @param new_risk Predicted risks or probabilities from the new (enhanced)
#'   model that includes additional predictors or biomarkers.
#' @param time_var Time to event variable for survival data analysis. Required
#'   when using time-to-event outcomes.
#' @param followup_time Time point for survival analysis (years). Events
#'   occurring after this time are considered censored for NRI calculation.
#' @param nri_type Type of NRI analysis. Categorical uses predefined risk
#'   thresholds, numeric (risk-free) compares all risk changes, both provides
#'   comprehensive assessment.
#' @param risk_thresholds Comma-separated risk thresholds for categorical NRI
#'   (e.g., 5\%, 10\%, 20\%). These define clinically meaningful risk categories
#'   for decision making.
#' @param custom_categories Use custom category labels instead of automatic
#'   threshold-based naming. Allows for more clinically meaningful category
#'   descriptions.
#' @param category_labels Comma-separated labels for risk categories when
#'   using custom categories. Should match the number of categories defined by
#'   thresholds.
#' @param confidence_level Confidence level for NRI confidence intervals and
#'   hypothesis testing. 0.95 provides 95\% confidence intervals.
#' @param bootstrap_samples Number of bootstrap samples for confidence
#'   interval estimation. More samples provide more stable estimates but
#'   increase computation time.
#' @param bootstrap_method Bootstrap confidence interval method. BCa provides
#'   bias-corrected and accelerated intervals with better coverage properties.
#' @param hypothesis_test Perform hypothesis test for NRI = 0. Tests whether
#'   the new model provides significant reclassification improvement.
#' @param decompose_nri Decompose total NRI into contributions from events and
#'   non-events. Provides insight into which population drives the improvement.
#' @param direction_analysis Analyze upward vs downward reclassification
#'   patterns separately. Shows whether improvement comes from better risk
#'   stratification.
#' @param show_transitions Display detailed reclassification transition matrix
#'   showing movement between all risk categories.
#' @param clinical_cutoffs Use clinically established risk cutoffs (e.g.,
#'   ACC/AHA guidelines) instead of data-driven thresholds for cardiovascular
#'   risk.
#' @param treatment_threshold Risk threshold for treatment initiation. Used to
#'   calculate clinical decision metrics and treatment reclassification.
#' @param cost_effectiveness Include cost-effectiveness considerations in
#'   reclassification analysis. Requires additional cost and utility parameters.
#' @param cross_validation Perform k-fold cross-validation to assess stability
#'   of NRI estimates and reduce optimism bias in model comparisons.
#' @param cv_folds Number of folds for cross-validation when enabled. 5-fold
#'   CV provides good balance of bias and variance.
#' @param sensitivity_analysis Perform sensitivity analysis by varying risk
#'   thresholds to assess robustness of NRI conclusions.
#' @param show_summary Display comprehensive NRI summary including overall
#'   NRI, decomposed components, and statistical significance.
#' @param show_reclassification Display detailed reclassification
#'   cross-tabulation showing movement patterns between baseline and new model
#'   categories.
#' @param show_performance Display comparative performance metrics
#'   (C-statistic, calibration) for baseline and new models alongside NRI
#'   results.
#' @param plot_reclassification Create reclassification plot showing risk
#'   distribution changes and movement patterns between models.
#' @param plot_risk_distribution Plot risk distributions for baseline and new
#'   models separately for events and non-events with category boundaries.
#' @param plot_improvement Visualize NRI decomposition showing contributions
#'   from events and non-events with confidence intervals.
#' @param plot_sensitivity Create plots showing how NRI varies with different
#'   risk thresholds to assess robustness of conclusions.
#' @param competing_risks Account for competing risks in survival analysis.
#'   Modifies NRI calculation for settings with multiple event types.
#' @param missing_handling Method for handling missing data in risk
#'   predictions. Multiple imputation provides most robust results.
#' @param stratified_analysis Perform stratified NRI analysis by important
#'   subgroups (age, sex, baseline risk level) to assess consistency.
#' @param subgroup_var Variable defining subgroups for stratified analysis.
#'   Each level will receive separate NRI calculation.
#' @param alpha_level Type I error rate for hypothesis testing and confidence
#'   intervals. Standard value is 0.05 for 95\% confidence.
#' @param random_seed Random seed for bootstrap sampling and cross-validation.
#'   Ensures reproducible results across analyses.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$reclassification} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$decomposition} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$performance} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$transitions} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$subgroupAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$sensitivityTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$reclassificationPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$riskDistributionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$improvementPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$sensitivityPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summary$asDF}
#'
#' \code{as.data.frame(results$summary)}
#'
#' @export
netreclassification <- function(
    data,
    outcome,
    baseline_risk,
    new_risk,
    time_var,
    followup_time = 5,
    nri_type = "categorical",
    risk_thresholds = "0.05, 0.10, 0.20",
    custom_categories = FALSE,
    category_labels = "Low, Intermediate, High, Very High",
    confidence_level = 0.95,
    bootstrap_samples = 1000,
    bootstrap_method = "bca",
    hypothesis_test = TRUE,
    decompose_nri = TRUE,
    direction_analysis = TRUE,
    show_transitions = TRUE,
    clinical_cutoffs = FALSE,
    treatment_threshold = 0.075,
    cost_effectiveness = FALSE,
    cross_validation = FALSE,
    cv_folds = 5,
    sensitivity_analysis = FALSE,
    show_summary = TRUE,
    show_reclassification = TRUE,
    show_performance = TRUE,
    plot_reclassification = TRUE,
    plot_risk_distribution = TRUE,
    plot_improvement = TRUE,
    plot_sensitivity = FALSE,
    competing_risks = FALSE,
    missing_handling = "complete",
    stratified_analysis = FALSE,
    subgroup_var,
    alpha_level = 0.05,
    random_seed = 123) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("netreclassification requires jmvcore to be installed (restart may be required)")

    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(baseline_risk)) baseline_risk <- jmvcore::resolveQuo(jmvcore::enquo(baseline_risk))
    if ( ! missing(new_risk)) new_risk <- jmvcore::resolveQuo(jmvcore::enquo(new_risk))
    if ( ! missing(time_var)) time_var <- jmvcore::resolveQuo(jmvcore::enquo(time_var))
    if ( ! missing(subgroup_var)) subgroup_var <- jmvcore::resolveQuo(jmvcore::enquo(subgroup_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(baseline_risk), baseline_risk, NULL),
            `if`( ! missing(new_risk), new_risk, NULL),
            `if`( ! missing(time_var), time_var, NULL),
            `if`( ! missing(subgroup_var), subgroup_var, NULL))

    for (v in subgroup_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- netreclassificationOptions$new(
        outcome = outcome,
        baseline_risk = baseline_risk,
        new_risk = new_risk,
        time_var = time_var,
        followup_time = followup_time,
        nri_type = nri_type,
        risk_thresholds = risk_thresholds,
        custom_categories = custom_categories,
        category_labels = category_labels,
        confidence_level = confidence_level,
        bootstrap_samples = bootstrap_samples,
        bootstrap_method = bootstrap_method,
        hypothesis_test = hypothesis_test,
        decompose_nri = decompose_nri,
        direction_analysis = direction_analysis,
        show_transitions = show_transitions,
        clinical_cutoffs = clinical_cutoffs,
        treatment_threshold = treatment_threshold,
        cost_effectiveness = cost_effectiveness,
        cross_validation = cross_validation,
        cv_folds = cv_folds,
        sensitivity_analysis = sensitivity_analysis,
        show_summary = show_summary,
        show_reclassification = show_reclassification,
        show_performance = show_performance,
        plot_reclassification = plot_reclassification,
        plot_risk_distribution = plot_risk_distribution,
        plot_improvement = plot_improvement,
        plot_sensitivity = plot_sensitivity,
        competing_risks = competing_risks,
        missing_handling = missing_handling,
        stratified_analysis = stratified_analysis,
        subgroup_var = subgroup_var,
        alpha_level = alpha_level,
        random_seed = random_seed)

    analysis <- netreclassificationClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

