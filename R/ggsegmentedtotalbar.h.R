
# This file is automatically generated, you probably don't want to edit this

ggsegmentedtotalbarOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ggsegmentedtotalbarOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            x_var = NULL,
            y_var = NULL,
            fill_var = NULL,
            facet_var = NULL,
            chart_style = "clean",
            color_palette = "clinical",
            show_percentages = TRUE,
            percentage_format = "integer",
            show_counts = FALSE,
            label_threshold = 5,
            orientation = "vertical",
            sort_categories = "none",
            plot_title = "",
            x_title = "",
            y_title = "Percentage",
            legend_title = "",
            legend_position = "right",
            bar_width = 0.8,
            plot_width = 10,
            plot_height = 6,
            add_outline = TRUE,
            outline_color = "white",
            export_ready = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="ggsegmentedtotalbar",
                requiresData=TRUE,
                ...)

            private$..x_var <- jmvcore::OptionVariable$new(
                "x_var",
                x_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..y_var <- jmvcore::OptionVariable$new(
                "y_var",
                y_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..fill_var <- jmvcore::OptionVariable$new(
                "fill_var",
                fill_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..facet_var <- jmvcore::OptionVariable$new(
                "facet_var",
                facet_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..chart_style <- jmvcore::OptionList$new(
                "chart_style",
                chart_style,
                options=list(
                    "clean",
                    "publication",
                    "presentation",
                    "clinical",
                    "bbc_style",
                    "prism_style"),
                default="clean")
            private$..color_palette <- jmvcore::OptionList$new(
                "color_palette",
                color_palette,
                options=list(
                    "default",
                    "viridis",
                    "set1",
                    "dark2",
                    "paired",
                    "clinical",
                    "colorblind",
                    "bbc_multi",
                    "prism_colorblind_safe",
                    "nature",
                    "science"),
                default="clinical")
            private$..show_percentages <- jmvcore::OptionBool$new(
                "show_percentages",
                show_percentages,
                default=TRUE)
            private$..percentage_format <- jmvcore::OptionList$new(
                "percentage_format",
                percentage_format,
                options=list(
                    "integer",
                    "decimal1",
                    "decimal2"),
                default="integer")
            private$..show_counts <- jmvcore::OptionBool$new(
                "show_counts",
                show_counts,
                default=FALSE)
            private$..label_threshold <- jmvcore::OptionNumber$new(
                "label_threshold",
                label_threshold,
                min=0,
                max=50,
                default=5)
            private$..orientation <- jmvcore::OptionList$new(
                "orientation",
                orientation,
                options=list(
                    "vertical",
                    "horizontal"),
                default="vertical")
            private$..sort_categories <- jmvcore::OptionList$new(
                "sort_categories",
                sort_categories,
                options=list(
                    "none",
                    "total",
                    "largest_segment",
                    "alpha"),
                default="none")
            private$..plot_title <- jmvcore::OptionString$new(
                "plot_title",
                plot_title,
                default="")
            private$..x_title <- jmvcore::OptionString$new(
                "x_title",
                x_title,
                default="")
            private$..y_title <- jmvcore::OptionString$new(
                "y_title",
                y_title,
                default="Percentage")
            private$..legend_title <- jmvcore::OptionString$new(
                "legend_title",
                legend_title,
                default="")
            private$..legend_position <- jmvcore::OptionList$new(
                "legend_position",
                legend_position,
                options=list(
                    "right",
                    "left",
                    "top",
                    "bottom",
                    "none"),
                default="right")
            private$..bar_width <- jmvcore::OptionNumber$new(
                "bar_width",
                bar_width,
                min=0.1,
                max=1,
                default=0.8)
            private$..plot_width <- jmvcore::OptionNumber$new(
                "plot_width",
                plot_width,
                min=4,
                max=16,
                default=10)
            private$..plot_height <- jmvcore::OptionNumber$new(
                "plot_height",
                plot_height,
                min=3,
                max=12,
                default=6)
            private$..add_outline <- jmvcore::OptionBool$new(
                "add_outline",
                add_outline,
                default=TRUE)
            private$..outline_color <- jmvcore::OptionList$new(
                "outline_color",
                outline_color,
                options=list(
                    "white",
                    "black",
                    "gray",
                    "none"),
                default="white")
            private$..export_ready <- jmvcore::OptionBool$new(
                "export_ready",
                export_ready,
                default=TRUE)

            self$.addOption(private$..x_var)
            self$.addOption(private$..y_var)
            self$.addOption(private$..fill_var)
            self$.addOption(private$..facet_var)
            self$.addOption(private$..chart_style)
            self$.addOption(private$..color_palette)
            self$.addOption(private$..show_percentages)
            self$.addOption(private$..percentage_format)
            self$.addOption(private$..show_counts)
            self$.addOption(private$..label_threshold)
            self$.addOption(private$..orientation)
            self$.addOption(private$..sort_categories)
            self$.addOption(private$..plot_title)
            self$.addOption(private$..x_title)
            self$.addOption(private$..y_title)
            self$.addOption(private$..legend_title)
            self$.addOption(private$..legend_position)
            self$.addOption(private$..bar_width)
            self$.addOption(private$..plot_width)
            self$.addOption(private$..plot_height)
            self$.addOption(private$..add_outline)
            self$.addOption(private$..outline_color)
            self$.addOption(private$..export_ready)
        }),
    active = list(
        x_var = function() private$..x_var$value,
        y_var = function() private$..y_var$value,
        fill_var = function() private$..fill_var$value,
        facet_var = function() private$..facet_var$value,
        chart_style = function() private$..chart_style$value,
        color_palette = function() private$..color_palette$value,
        show_percentages = function() private$..show_percentages$value,
        percentage_format = function() private$..percentage_format$value,
        show_counts = function() private$..show_counts$value,
        label_threshold = function() private$..label_threshold$value,
        orientation = function() private$..orientation$value,
        sort_categories = function() private$..sort_categories$value,
        plot_title = function() private$..plot_title$value,
        x_title = function() private$..x_title$value,
        y_title = function() private$..y_title$value,
        legend_title = function() private$..legend_title$value,
        legend_position = function() private$..legend_position$value,
        bar_width = function() private$..bar_width$value,
        plot_width = function() private$..plot_width$value,
        plot_height = function() private$..plot_height$value,
        add_outline = function() private$..add_outline$value,
        outline_color = function() private$..outline_color$value,
        export_ready = function() private$..export_ready$value),
    private = list(
        ..x_var = NA,
        ..y_var = NA,
        ..fill_var = NA,
        ..facet_var = NA,
        ..chart_style = NA,
        ..color_palette = NA,
        ..show_percentages = NA,
        ..percentage_format = NA,
        ..show_counts = NA,
        ..label_threshold = NA,
        ..orientation = NA,
        ..sort_categories = NA,
        ..plot_title = NA,
        ..x_title = NA,
        ..y_title = NA,
        ..legend_title = NA,
        ..legend_position = NA,
        ..bar_width = NA,
        ..plot_width = NA,
        ..plot_height = NA,
        ..add_outline = NA,
        ..outline_color = NA,
        ..export_ready = NA)
)

ggsegmentedtotalbarResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ggsegmentedtotalbarResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        plot = function() private$.items[["plot"]],
        summary = function() private$.items[["summary"]],
        composition_table = function() private$.items[["composition_table"]],
        detailed_stats = function() private$.items[["detailed_stats"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Segmented Total Bar Charts",
                refs=list(
                    "ggplot2"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot",
                title="Segmented Total Bar Chart",
                width=650,
                height=450,
                requiresData=TRUE,
                refs="ggplot2"))
            self$add(jmvcore::Table$new(
                options=options,
                name="summary",
                title="Chart Summary",
                rows=1,
                visible="(x_var && y_var && fill_var)",
                clearWith=list(
                    "x_var",
                    "y_var",
                    "fill_var"),
                columns=list(
                    list(
                        `name`="categories", 
                        `title`="Categories", 
                        `type`="integer"),
                    list(
                        `name`="segments", 
                        `title`="Segments", 
                        `type`="integer"),
                    list(
                        `name`="total_observations", 
                        `title`="Total Observations", 
                        `type`="integer"),
                    list(
                        `name`="chart_type", 
                        `title`="Chart Type", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="composition_table",
                title="Composition Analysis",
                visible="(x_var && y_var && fill_var)",
                clearWith=list(
                    "x_var",
                    "y_var",
                    "fill_var"),
                columns=list(
                    list(
                        `name`="category", 
                        `title`="Category", 
                        `type`="text"),
                    list(
                        `name`="segment", 
                        `title`="Segment", 
                        `type`="text"),
                    list(
                        `name`="count", 
                        `title`="Count", 
                        `type`="integer"),
                    list(
                        `name`="percentage", 
                        `title`="Percentage", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="total_in_category", 
                        `title`="Category Total", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="detailed_stats",
                title="Detailed Statistics",
                visible=FALSE,
                clearWith=list(
                    "x_var",
                    "y_var",
                    "fill_var"),
                columns=list(
                    list(
                        `name`="measure", 
                        `title`="Measure", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Chart Interpretation",
                visible="(x_var && y_var && fill_var)",
                clearWith=list(
                    "x_var",
                    "y_var",
                    "fill_var")))}))

ggsegmentedtotalbarBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ggsegmentedtotalbarBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "ggsegmentedtotalbar",
                version = c(0,0,31),
                options = options,
                results = ggsegmentedtotalbarResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Segmented Total Bar Charts
#'
#' Create segmented total bar charts (100\% stacked bars) that show 
#' proportional 
#' breakdowns within categories. Perfect for displaying composition data where 
#' each bar represents 100\% and segments show relative proportions.
#' 
#'
#' @examples
#' \donttest{
#' # Example usage for segmented total bar charts:
#' # Shows proportional composition within categories
#' # Each bar totals to 100\% with segments showing relative proportions
#'}
#' @param data The data as a data frame.
#' @param x_var Categorical variable for x-axis categories.
#' @param y_var Numeric variable for segment values.
#' @param fill_var Categorical variable for bar segment colors and
#'   composition.
#' @param facet_var Optional variable for creating multiple panels.
#' @param chart_style Overall visual style for the chart.
#' @param color_palette Color palette for segment fills.
#' @param show_percentages Whether to display percentage labels on segments.
#' @param percentage_format Format for percentage display.
#' @param show_counts Whether to display raw count values on segments.
#' @param label_threshold Minimum percentage for showing labels (0-50\%).
#' @param orientation Orientation of the bars.
#' @param sort_categories How to sort the categories.
#' @param plot_title Main title for the plot.
#' @param x_title Title for x-axis.
#' @param y_title Title for y-axis.
#' @param legend_title Title for the legend.
#' @param legend_position Position of the legend.
#' @param bar_width Width of the bars (0.1 to 1.0).
#' @param plot_width Width of the plot in inches.
#' @param plot_height Height of the plot in inches.
#' @param add_outline Whether to add white outlines around segments.
#' @param outline_color Color for segment outlines.
#' @param export_ready Whether to optimize plot for high-quality export.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$composition_table} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$detailed_stats} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summary$asDF}
#'
#' \code{as.data.frame(results$summary)}
#'
#' @export
ggsegmentedtotalbar <- function(
    data,
    x_var,
    y_var,
    fill_var,
    facet_var = NULL,
    chart_style = "clean",
    color_palette = "clinical",
    show_percentages = TRUE,
    percentage_format = "integer",
    show_counts = FALSE,
    label_threshold = 5,
    orientation = "vertical",
    sort_categories = "none",
    plot_title = "",
    x_title = "",
    y_title = "Percentage",
    legend_title = "",
    legend_position = "right",
    bar_width = 0.8,
    plot_width = 10,
    plot_height = 6,
    add_outline = TRUE,
    outline_color = "white",
    export_ready = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("ggsegmentedtotalbar requires jmvcore to be installed (restart may be required)")

    if ( ! missing(x_var)) x_var <- jmvcore::resolveQuo(jmvcore::enquo(x_var))
    if ( ! missing(y_var)) y_var <- jmvcore::resolveQuo(jmvcore::enquo(y_var))
    if ( ! missing(fill_var)) fill_var <- jmvcore::resolveQuo(jmvcore::enquo(fill_var))
    if ( ! missing(facet_var)) facet_var <- jmvcore::resolveQuo(jmvcore::enquo(facet_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(x_var), x_var, NULL),
            `if`( ! missing(y_var), y_var, NULL),
            `if`( ! missing(fill_var), fill_var, NULL),
            `if`( ! missing(facet_var), facet_var, NULL))

    for (v in x_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in fill_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in facet_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- ggsegmentedtotalbarOptions$new(
        x_var = x_var,
        y_var = y_var,
        fill_var = fill_var,
        facet_var = facet_var,
        chart_style = chart_style,
        color_palette = color_palette,
        show_percentages = show_percentages,
        percentage_format = percentage_format,
        show_counts = show_counts,
        label_threshold = label_threshold,
        orientation = orientation,
        sort_categories = sort_categories,
        plot_title = plot_title,
        x_title = x_title,
        y_title = y_title,
        legend_title = legend_title,
        legend_position = legend_position,
        bar_width = bar_width,
        plot_width = plot_width,
        plot_height = plot_height,
        add_outline = add_outline,
        outline_color = outline_color,
        export_ready = export_ready)

    analysis <- ggsegmentedtotalbarClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

