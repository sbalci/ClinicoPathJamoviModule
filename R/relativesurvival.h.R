
# This file is automatically generated, you probably don't want to edit this

relativesurvivalOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "relativesurvivalOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            status = NULL,
            age = NULL,
            sex = NULL,
            year = NULL,
            covariates = NULL,
            ratetable = "us",
            method = "poharperme",
            time_scale = "years",
            net_survival = TRUE,
            excess_mortality = TRUE,
            crude_probability = TRUE,
            age_standardized = FALSE,
            period_analysis = FALSE,
            cohort_year = "",
            regression_model = "none",
            spline_df = 4,
            plot_observed = TRUE,
            plot_expected = TRUE,
            plot_relative = TRUE,
            plot_excess = TRUE,
            confidence_level = 0.95,
            timepoints = "1,3,5,10", ...) {

            super$initialize(
                package="ClinicoPath",
                name="relativesurvival",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..status <- jmvcore::OptionVariable$new(
                "status",
                status,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..age <- jmvcore::OptionVariable$new(
                "age",
                age,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..sex <- jmvcore::OptionVariable$new(
                "sex",
                sex,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..year <- jmvcore::OptionVariable$new(
                "year",
                year,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..ratetable <- jmvcore::OptionList$new(
                "ratetable",
                ratetable,
                options=list(
                    "us",
                    "mn",
                    "fr",
                    "it",
                    "custom"),
                default="us")
            private$..method <- jmvcore::OptionList$new(
                "method",
                method,
                options=list(
                    "ederer1",
                    "ederer2",
                    "hakulinen",
                    "poharperme"),
                default="poharperme")
            private$..time_scale <- jmvcore::OptionList$new(
                "time_scale",
                time_scale,
                options=list(
                    "years",
                    "months",
                    "days"),
                default="years")
            private$..net_survival <- jmvcore::OptionBool$new(
                "net_survival",
                net_survival,
                default=TRUE)
            private$..excess_mortality <- jmvcore::OptionBool$new(
                "excess_mortality",
                excess_mortality,
                default=TRUE)
            private$..crude_probability <- jmvcore::OptionBool$new(
                "crude_probability",
                crude_probability,
                default=TRUE)
            private$..age_standardized <- jmvcore::OptionBool$new(
                "age_standardized",
                age_standardized,
                default=FALSE)
            private$..period_analysis <- jmvcore::OptionBool$new(
                "period_analysis",
                period_analysis,
                default=FALSE)
            private$..cohort_year <- jmvcore::OptionString$new(
                "cohort_year",
                cohort_year,
                default="")
            private$..regression_model <- jmvcore::OptionList$new(
                "regression_model",
                regression_model,
                options=list(
                    "none",
                    "additive",
                    "multiplicative",
                    "flexible"),
                default="none")
            private$..spline_df <- jmvcore::OptionInteger$new(
                "spline_df",
                spline_df,
                default=4,
                min=1,
                max=10)
            private$..plot_observed <- jmvcore::OptionBool$new(
                "plot_observed",
                plot_observed,
                default=TRUE)
            private$..plot_expected <- jmvcore::OptionBool$new(
                "plot_expected",
                plot_expected,
                default=TRUE)
            private$..plot_relative <- jmvcore::OptionBool$new(
                "plot_relative",
                plot_relative,
                default=TRUE)
            private$..plot_excess <- jmvcore::OptionBool$new(
                "plot_excess",
                plot_excess,
                default=TRUE)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.5,
                max=0.99)
            private$..timepoints <- jmvcore::OptionString$new(
                "timepoints",
                timepoints,
                default="1,3,5,10")

            self$.addOption(private$..time)
            self$.addOption(private$..status)
            self$.addOption(private$..age)
            self$.addOption(private$..sex)
            self$.addOption(private$..year)
            self$.addOption(private$..covariates)
            self$.addOption(private$..ratetable)
            self$.addOption(private$..method)
            self$.addOption(private$..time_scale)
            self$.addOption(private$..net_survival)
            self$.addOption(private$..excess_mortality)
            self$.addOption(private$..crude_probability)
            self$.addOption(private$..age_standardized)
            self$.addOption(private$..period_analysis)
            self$.addOption(private$..cohort_year)
            self$.addOption(private$..regression_model)
            self$.addOption(private$..spline_df)
            self$.addOption(private$..plot_observed)
            self$.addOption(private$..plot_expected)
            self$.addOption(private$..plot_relative)
            self$.addOption(private$..plot_excess)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..timepoints)
        }),
    active = list(
        time = function() private$..time$value,
        status = function() private$..status$value,
        age = function() private$..age$value,
        sex = function() private$..sex$value,
        year = function() private$..year$value,
        covariates = function() private$..covariates$value,
        ratetable = function() private$..ratetable$value,
        method = function() private$..method$value,
        time_scale = function() private$..time_scale$value,
        net_survival = function() private$..net_survival$value,
        excess_mortality = function() private$..excess_mortality$value,
        crude_probability = function() private$..crude_probability$value,
        age_standardized = function() private$..age_standardized$value,
        period_analysis = function() private$..period_analysis$value,
        cohort_year = function() private$..cohort_year$value,
        regression_model = function() private$..regression_model$value,
        spline_df = function() private$..spline_df$value,
        plot_observed = function() private$..plot_observed$value,
        plot_expected = function() private$..plot_expected$value,
        plot_relative = function() private$..plot_relative$value,
        plot_excess = function() private$..plot_excess$value,
        confidence_level = function() private$..confidence_level$value,
        timepoints = function() private$..timepoints$value),
    private = list(
        ..time = NA,
        ..status = NA,
        ..age = NA,
        ..sex = NA,
        ..year = NA,
        ..covariates = NA,
        ..ratetable = NA,
        ..method = NA,
        ..time_scale = NA,
        ..net_survival = NA,
        ..excess_mortality = NA,
        ..crude_probability = NA,
        ..age_standardized = NA,
        ..period_analysis = NA,
        ..cohort_year = NA,
        ..regression_model = NA,
        ..spline_df = NA,
        ..plot_observed = NA,
        ..plot_expected = NA,
        ..plot_relative = NA,
        ..plot_excess = NA,
        ..confidence_level = NA,
        ..timepoints = NA)
)

relativesurvivalResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "relativesurvivalResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        summary = function() private$.items[["summary"]],
        survivalTable = function() private$.items[["survivalTable"]],
        netSurvivalTable = function() private$.items[["netSurvivalTable"]],
        excessMortalityTable = function() private$.items[["excessMortalityTable"]],
        crudeProbTable = function() private$.items[["crudeProbTable"]],
        regressionTable = function() private$.items[["regressionTable"]],
        observedPlot = function() private$.items[["observedPlot"]],
        expectedPlot = function() private$.items[["expectedPlot"]],
        relativePlot = function() private$.items[["relativePlot"]],
        excessPlot = function() private$.items[["excessPlot"]],
        ageStandardizedTable = function() private$.items[["ageStandardizedTable"]],
        periodAnalysisTable = function() private$.items[["periodAnalysisTable"]],
        modelFit = function() private$.items[["modelFit"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Relative Survival Analysis")
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="To Do",
                clearWith=list(
                    "time",
                    "status",
                    "age",
                    "sex",
                    "year")))
            self$add(jmvcore::Html$new(
                options=options,
                name="summary",
                title="Analysis Summary",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="survivalTable",
                title="Survival Estimates by Time",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="observed", 
                        `title`="Observed Survival", 
                        `type`="number"),
                    list(
                        `name`="expected", 
                        `title`="Expected Survival", 
                        `type`="number"),
                    list(
                        `name`="relative", 
                        `title`="Relative Survival", 
                        `type`="number"),
                    list(
                        `name`="rel_ci_lower", 
                        `title`="RS CI Lower", 
                        `type`="number"),
                    list(
                        `name`="rel_ci_upper", 
                        `title`="RS CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="netSurvivalTable",
                title="Net Survival Estimates",
                visible="(net_survival)",
                rows=1,
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="net_survival", 
                        `title`="Net Survival", 
                        `type`="number"),
                    list(
                        `name`="net_ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="net_ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"),
                    list(
                        `name`="standard_error", 
                        `title`="Std. Error", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="excessMortalityTable",
                title="Excess Mortality Rates",
                visible="(excess_mortality)",
                rows=1,
                columns=list(
                    list(
                        `name`="time_interval", 
                        `title`="Time Interval", 
                        `type`="text"),
                    list(
                        `name`="excess_hazard", 
                        `title`="Excess Hazard", 
                        `type`="number"),
                    list(
                        `name`="hazard_ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="hazard_ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="crudeProbTable",
                title="Crude Probability of Death",
                visible="(crude_probability)",
                rows=1,
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="disease_death", 
                        `title`="Disease Death", 
                        `type`="number"),
                    list(
                        `name`="other_death", 
                        `title`="Other Causes Death", 
                        `type`="number"),
                    list(
                        `name`="disease_ci_lower", 
                        `title`="Disease CI Lower", 
                        `type`="number"),
                    list(
                        `name`="disease_ci_upper", 
                        `title`="Disease CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="regressionTable",
                title="Regression Model Results",
                visible="(!regression_model:none)",
                rows=1,
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="coefficient", 
                        `title`="Coefficient", 
                        `type`="number"),
                    list(
                        `name`="std_error", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="z_value", 
                        `title`="z-value", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="coef_ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="coef_ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="observedPlot",
                title="Observed Survival",
                width=700,
                height=450,
                renderFun=".plotObserved",
                visible="(plot_observed)",
                clearWith=list(
                    "time",
                    "status",
                    "covariates")))
            self$add(jmvcore::Image$new(
                options=options,
                name="expectedPlot",
                title="Expected Survival",
                width=700,
                height=450,
                renderFun=".plotExpected",
                visible="(plot_expected)",
                clearWith=list(
                    "age",
                    "sex",
                    "year",
                    "ratetable")))
            self$add(jmvcore::Image$new(
                options=options,
                name="relativePlot",
                title="Relative Survival",
                width=700,
                height=450,
                renderFun=".plotRelative",
                visible="(plot_relative)",
                clearWith=list(
                    "time",
                    "status",
                    "age",
                    "sex",
                    "year",
                    "method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="excessPlot",
                title="Excess Mortality",
                width=700,
                height=450,
                renderFun=".plotExcess",
                visible="(plot_excess)",
                clearWith=list(
                    "time",
                    "status",
                    "age",
                    "sex",
                    "year",
                    "method")))
            self$add(jmvcore::Table$new(
                options=options,
                name="ageStandardizedTable",
                title="Age-Standardized Survival",
                visible="(age_standardized)",
                rows=1,
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="crude_rate", 
                        `title`="Crude Rate", 
                        `type`="number"),
                    list(
                        `name`="age_adjusted", 
                        `title`="Age-Adjusted Rate", 
                        `type`="number"),
                    list(
                        `name`="adj_ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="adj_ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="periodAnalysisTable",
                title="Period Analysis Results",
                visible="(period_analysis)",
                rows=1,
                columns=list(
                    list(
                        `name`="period", 
                        `title`="Period", 
                        `type`="text"),
                    list(
                        `name`="n_patients", 
                        `title`="N Patients", 
                        `type`="integer"),
                    list(
                        `name`="rel_survival_5y", 
                        `title`="5-Year RS", 
                        `type`="number"),
                    list(
                        `name`="rs_ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="rs_ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelFit",
                title="Model Fit Statistics",
                visible="(!regression_model:none)",
                rows=1,
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation",
                visible=TRUE))}))

relativesurvivalBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "relativesurvivalBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "relativesurvival",
                version = c(0,0,3),
                options = options,
                results = relativesurvivalResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Relative Survival Analysis
#'
#' Relative survival analysis compares observed survival in a patient cohort 
#' to 
#' expected survival in a matched general population. Essential for cancer 
#' registry 
#' studies and population-based research.
#' 
#'
#' @examples
#' \donttest{
#' # Example: Cancer relative survival
#' relativesurvival(
#'     data = cancer_registry,
#'     time = followup_years,
#'     status = vital_status,
#'     age = age_at_diagnosis,
#'     sex = gender,
#'     year = diagnosis_year,
#'     ratetable = "us_population"
#' )
#'}
#' @param data The data as a data frame.
#' @param time Follow-up time variable
#' @param status Event status variable
#' @param age Age variable for rate table matching
#' @param sex Sex variable for rate table matching
#' @param year Calendar year for rate table matching
#' @param covariates Covariates for regression models
#' @param ratetable Population rate table for expected survival
#' @param method Relative survival estimation method
#' @param time_scale Time unit specification
#' @param net_survival Compute net survival estimates
#' @param excess_mortality Compute excess mortality
#' @param crude_probability Compute cause-specific crude probabilities
#' @param age_standardized Perform age standardization
#' @param period_analysis Use period analysis approach
#' @param cohort_year Cohort year specification
#' @param regression_model Regression model specification
#' @param spline_df Spline complexity
#' @param plot_observed Show observed survival
#' @param plot_expected Show expected survival
#' @param plot_relative Show relative survival
#' @param plot_excess Show excess hazard
#' @param confidence_level CI level
#' @param timepoints Specific time points
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$survivalTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$netSurvivalTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$excessMortalityTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$crudeProbTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$regressionTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$observedPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$expectedPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$relativePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$excessPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$ageStandardizedTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$periodAnalysisTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelFit} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$survivalTable$asDF}
#'
#' \code{as.data.frame(results$survivalTable)}
#'
#' @export
relativesurvival <- function(
    data,
    time,
    status,
    age,
    sex,
    year,
    covariates,
    ratetable = "us",
    method = "poharperme",
    time_scale = "years",
    net_survival = TRUE,
    excess_mortality = TRUE,
    crude_probability = TRUE,
    age_standardized = FALSE,
    period_analysis = FALSE,
    cohort_year = "",
    regression_model = "none",
    spline_df = 4,
    plot_observed = TRUE,
    plot_expected = TRUE,
    plot_relative = TRUE,
    plot_excess = TRUE,
    confidence_level = 0.95,
    timepoints = "1,3,5,10") {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("relativesurvival requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(status)) status <- jmvcore::resolveQuo(jmvcore::enquo(status))
    if ( ! missing(age)) age <- jmvcore::resolveQuo(jmvcore::enquo(age))
    if ( ! missing(sex)) sex <- jmvcore::resolveQuo(jmvcore::enquo(sex))
    if ( ! missing(year)) year <- jmvcore::resolveQuo(jmvcore::enquo(year))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(status), status, NULL),
            `if`( ! missing(age), age, NULL),
            `if`( ! missing(sex), sex, NULL),
            `if`( ! missing(year), year, NULL),
            `if`( ! missing(covariates), covariates, NULL))

    for (v in sex) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- relativesurvivalOptions$new(
        time = time,
        status = status,
        age = age,
        sex = sex,
        year = year,
        covariates = covariates,
        ratetable = ratetable,
        method = method,
        time_scale = time_scale,
        net_survival = net_survival,
        excess_mortality = excess_mortality,
        crude_probability = crude_probability,
        age_standardized = age_standardized,
        period_analysis = period_analysis,
        cohort_year = cohort_year,
        regression_model = regression_model,
        spline_df = spline_df,
        plot_observed = plot_observed,
        plot_expected = plot_expected,
        plot_relative = plot_relative,
        plot_excess = plot_excess,
        confidence_level = confidence_level,
        timepoints = timepoints)

    analysis <- relativesurvivalClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

