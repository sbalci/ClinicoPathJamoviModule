
# This file is automatically generated, you probably don't want to edit this

timevarycoxOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "timevarycoxOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            timevar_data = NULL,
            outcome = NULL,
            fixed_covariates = NULL,
            subject_id = NULL,
            outcomeLevel = "1",
            robust_se = TRUE,
            cluster_se = TRUE,
            show_model_summary = TRUE,
            show_coefficients = TRUE,
            show_hazard_ratios = TRUE,
            showSummaries = FALSE,
            showExplanations = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="timevarycox",
                requiresData=TRUE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..timevar_data <- jmvcore::OptionVariables$new(
                "timevar_data",
                timevar_data,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..fixed_covariates <- jmvcore::OptionVariables$new(
                "fixed_covariates",
                fixed_covariates,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..subject_id <- jmvcore::OptionVariable$new(
                "subject_id",
                subject_id,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..outcomeLevel <- jmvcore::OptionString$new(
                "outcomeLevel",
                outcomeLevel,
                default="1")
            private$..robust_se <- jmvcore::OptionBool$new(
                "robust_se",
                robust_se,
                default=TRUE)
            private$..cluster_se <- jmvcore::OptionBool$new(
                "cluster_se",
                cluster_se,
                default=TRUE)
            private$..show_model_summary <- jmvcore::OptionBool$new(
                "show_model_summary",
                show_model_summary,
                default=TRUE)
            private$..show_coefficients <- jmvcore::OptionBool$new(
                "show_coefficients",
                show_coefficients,
                default=TRUE)
            private$..show_hazard_ratios <- jmvcore::OptionBool$new(
                "show_hazard_ratios",
                show_hazard_ratios,
                default=TRUE)
            private$..showSummaries <- jmvcore::OptionBool$new(
                "showSummaries",
                showSummaries,
                default=FALSE)
            private$..showExplanations <- jmvcore::OptionBool$new(
                "showExplanations",
                showExplanations,
                default=FALSE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..timevar_data)
            self$.addOption(private$..outcome)
            self$.addOption(private$..fixed_covariates)
            self$.addOption(private$..subject_id)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..robust_se)
            self$.addOption(private$..cluster_se)
            self$.addOption(private$..show_model_summary)
            self$.addOption(private$..show_coefficients)
            self$.addOption(private$..show_hazard_ratios)
            self$.addOption(private$..showSummaries)
            self$.addOption(private$..showExplanations)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        timevar_data = function() private$..timevar_data$value,
        outcome = function() private$..outcome$value,
        fixed_covariates = function() private$..fixed_covariates$value,
        subject_id = function() private$..subject_id$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        robust_se = function() private$..robust_se$value,
        cluster_se = function() private$..cluster_se$value,
        show_model_summary = function() private$..show_model_summary$value,
        show_coefficients = function() private$..show_coefficients$value,
        show_hazard_ratios = function() private$..show_hazard_ratios$value,
        showSummaries = function() private$..showSummaries$value,
        showExplanations = function() private$..showExplanations$value),
    private = list(
        ..elapsedtime = NA,
        ..timevar_data = NA,
        ..outcome = NA,
        ..fixed_covariates = NA,
        ..subject_id = NA,
        ..outcomeLevel = NA,
        ..robust_se = NA,
        ..cluster_se = NA,
        ..show_model_summary = NA,
        ..show_coefficients = NA,
        ..show_hazard_ratios = NA,
        ..showSummaries = NA,
        ..showExplanations = NA)
)

timevarycoxResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "timevarycoxResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        modelSummary = function() private$.items[["modelSummary"]],
        coefficientsTable = function() private$.items[["coefficientsTable"]],
        analysisSummary = function() private$.items[["analysisSummary"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Time-Varying Covariates Cox Regression",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "survival"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                visible="(show_model_summary)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="coefficientsTable",
                title="Regression Coefficients",
                visible="(show_coefficients)",
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="coefficient", 
                        `title`="\u03B2", 
                        `type`="number"),
                    list(
                        `name`="hazard_ratio", 
                        `title`="HR", 
                        `type`="number"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="analysisSummary",
                title="Analysis Summary",
                visible="(showSummaries)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Methodology",
                visible="(showExplanations)"))}))

timevarycoxBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "timevarycoxBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "timevarycox",
                version = c(0,0,31),
                options = options,
                results = timevarycoxResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Time-Varying Covariates Cox Regression
#'
#' Performs Cox proportional hazards regression with time-varying covariates.  
#' This analysis allows covariates to change values over time during 
#' follow-up,  which is essential for modeling dynamic clinical variables such 
#' as treatment  changes, biomarker levels, or disease progression markers.
#'
#' @examples
#' # example will be added
#'
#' @param data The data as a data frame.
#' @param elapsedtime Time variable for survival analysis
#' @param timevar_data Variables that change over time
#' @param outcome Event indicator variable
#' @param fixed_covariates Time-constant covariates
#' @param subject_id Unique identifier for each subject
#' @param outcomeLevel Level of outcome variable indicating event
#' @param robust_se Use robust standard errors
#' @param cluster_se Cluster standard errors by subject
#' @param show_model_summary Display model summary information
#' @param show_coefficients Display regression coefficients table
#' @param show_hazard_ratios Display hazard ratios
#' @param showSummaries Generate natural language summaries
#' @param showExplanations Show methodology explanations
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$coefficientsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$analysisSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$coefficientsTable$asDF}
#'
#' \code{as.data.frame(results$coefficientsTable)}
#'
#' @export
timevarycox <- function(
    data,
    elapsedtime,
    timevar_data,
    outcome,
    fixed_covariates,
    subject_id,
    outcomeLevel = "1",
    robust_se = TRUE,
    cluster_se = TRUE,
    show_model_summary = TRUE,
    show_coefficients = TRUE,
    show_hazard_ratios = TRUE,
    showSummaries = FALSE,
    showExplanations = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("timevarycox requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(timevar_data)) timevar_data <- jmvcore::resolveQuo(jmvcore::enquo(timevar_data))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(fixed_covariates)) fixed_covariates <- jmvcore::resolveQuo(jmvcore::enquo(fixed_covariates))
    if ( ! missing(subject_id)) subject_id <- jmvcore::resolveQuo(jmvcore::enquo(subject_id))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(elapsedtime), elapsedtime, NULL),
            `if`( ! missing(timevar_data), timevar_data, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(fixed_covariates), fixed_covariates, NULL),
            `if`( ! missing(subject_id), subject_id, NULL))


    options <- timevarycoxOptions$new(
        elapsedtime = elapsedtime,
        timevar_data = timevar_data,
        outcome = outcome,
        fixed_covariates = fixed_covariates,
        subject_id = subject_id,
        outcomeLevel = outcomeLevel,
        robust_se = robust_se,
        cluster_se = cluster_se,
        show_model_summary = show_model_summary,
        show_coefficients = show_coefficients,
        show_hazard_ratios = show_hazard_ratios,
        showSummaries = showSummaries,
        showExplanations = showExplanations)

    analysis <- timevarycoxClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

