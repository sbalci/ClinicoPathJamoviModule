
# This file is automatically generated, you probably don't want to edit this

reclassmetricsOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "reclassmetricsOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            outcome = NULL,
            outcomeType = "binary",
            survivalTime = NULL,
            timePoint = 60,
            oldModelProb = NULL,
            newModelProb = NULL,
            riskCategories = "0.0,0.1,0.2,1.0",
            nriType = "both",
            ciLevel = 0.95,
            bootstrapCI = TRUE,
            nBootstrap = 500,
            showReclassTable = TRUE,
            showEventNonEvent = TRUE,
            showIDIComponents = TRUE,
            showCalibrationComparison = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="reclassmetrics",
                requiresData=TRUE,
                ...)

            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..outcomeType <- jmvcore::OptionList$new(
                "outcomeType",
                outcomeType,
                options=list(
                    "binary",
                    "survival"),
                default="binary")
            private$..survivalTime <- jmvcore::OptionVariable$new(
                "survivalTime",
                survivalTime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..timePoint <- jmvcore::OptionNumber$new(
                "timePoint",
                timePoint,
                default=60,
                min=1)
            private$..oldModelProb <- jmvcore::OptionVariable$new(
                "oldModelProb",
                oldModelProb,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..newModelProb <- jmvcore::OptionVariable$new(
                "newModelProb",
                newModelProb,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..riskCategories <- jmvcore::OptionString$new(
                "riskCategories",
                riskCategories,
                default="0.0,0.1,0.2,1.0")
            private$..nriType <- jmvcore::OptionList$new(
                "nriType",
                nriType,
                options=list(
                    "categorical",
                    "continuous",
                    "both"),
                default="both")
            private$..ciLevel <- jmvcore::OptionNumber$new(
                "ciLevel",
                ciLevel,
                default=0.95,
                min=0.8,
                max=0.99)
            private$..bootstrapCI <- jmvcore::OptionBool$new(
                "bootstrapCI",
                bootstrapCI,
                default=TRUE)
            private$..nBootstrap <- jmvcore::OptionInteger$new(
                "nBootstrap",
                nBootstrap,
                default=500,
                min=100,
                max=2000)
            private$..showReclassTable <- jmvcore::OptionBool$new(
                "showReclassTable",
                showReclassTable,
                default=TRUE)
            private$..showEventNonEvent <- jmvcore::OptionBool$new(
                "showEventNonEvent",
                showEventNonEvent,
                default=TRUE)
            private$..showIDIComponents <- jmvcore::OptionBool$new(
                "showIDIComponents",
                showIDIComponents,
                default=TRUE)
            private$..showCalibrationComparison <- jmvcore::OptionBool$new(
                "showCalibrationComparison",
                showCalibrationComparison,
                default=TRUE)

            self$.addOption(private$..outcome)
            self$.addOption(private$..outcomeType)
            self$.addOption(private$..survivalTime)
            self$.addOption(private$..timePoint)
            self$.addOption(private$..oldModelProb)
            self$.addOption(private$..newModelProb)
            self$.addOption(private$..riskCategories)
            self$.addOption(private$..nriType)
            self$.addOption(private$..ciLevel)
            self$.addOption(private$..bootstrapCI)
            self$.addOption(private$..nBootstrap)
            self$.addOption(private$..showReclassTable)
            self$.addOption(private$..showEventNonEvent)
            self$.addOption(private$..showIDIComponents)
            self$.addOption(private$..showCalibrationComparison)
        }),
    active = list(
        outcome = function() private$..outcome$value,
        outcomeType = function() private$..outcomeType$value,
        survivalTime = function() private$..survivalTime$value,
        timePoint = function() private$..timePoint$value,
        oldModelProb = function() private$..oldModelProb$value,
        newModelProb = function() private$..newModelProb$value,
        riskCategories = function() private$..riskCategories$value,
        nriType = function() private$..nriType$value,
        ciLevel = function() private$..ciLevel$value,
        bootstrapCI = function() private$..bootstrapCI$value,
        nBootstrap = function() private$..nBootstrap$value,
        showReclassTable = function() private$..showReclassTable$value,
        showEventNonEvent = function() private$..showEventNonEvent$value,
        showIDIComponents = function() private$..showIDIComponents$value,
        showCalibrationComparison = function() private$..showCalibrationComparison$value),
    private = list(
        ..outcome = NA,
        ..outcomeType = NA,
        ..survivalTime = NA,
        ..timePoint = NA,
        ..oldModelProb = NA,
        ..newModelProb = NA,
        ..riskCategories = NA,
        ..nriType = NA,
        ..ciLevel = NA,
        ..bootstrapCI = NA,
        ..nBootstrap = NA,
        ..showReclassTable = NA,
        ..showEventNonEvent = NA,
        ..showIDIComponents = NA,
        ..showCalibrationComparison = NA)
)

reclassmetricsResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "reclassmetricsResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        nriResults = function() private$.items[["nriResults"]],
        idiResults = function() private$.items[["idiResults"]],
        reclassTable = function() private$.items[["reclassTable"]],
        eventNonEventNRI = function() private$.items[["eventNonEventNRI"]],
        idiComponents = function() private$.items[["idiComponents"]],
        calibrationComparison = function() private$.items[["calibrationComparison"]],
        reclassPlot = function() private$.items[["reclassPlot"]],
        improvementPlot = function() private$.items[["improvementPlot"]],
        summary = function() private$.items[["summary"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Model Reclassification Metrics",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "janitor",
                    "labelled",
                    "glue",
                    "survival",
                    "PredictABEL",
                    "nricens",
                    "pROC",
                    "scales"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="nriResults",
                title="Net Reclassification Improvement (NRI)",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="idiResults",
                title="Integrated Discrimination Improvement (IDI)",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="reclassTable",
                title="Reclassification Table",
                visible="(showReclassTable)",
                rows=0,
                columns=list(
                    list(
                        `name`="old_category", 
                        `title`="Old Model Risk", 
                        `type`="text"),
                    list(
                        `name`="new_low", 
                        `title`="New: Low", 
                        `type`="integer"),
                    list(
                        `name`="new_medium", 
                        `title`="New: Medium", 
                        `type`="integer"),
                    list(
                        `name`="new_high", 
                        `title`="New: High", 
                        `type`="integer"),
                    list(
                        `name`="total", 
                        `title`="Total", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="eventNonEventNRI",
                title="NRI by Event Status",
                visible="(showEventNonEvent)",
                rows=1,
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="nri_estimate", 
                        `title`="NRI Component", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"),
                    list(
                        `name`="n_improved", 
                        `title`="N Improved", 
                        `type`="integer"),
                    list(
                        `name`="n_worsened", 
                        `title`="N Worsened", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="idiComponents",
                title="IDI Components",
                visible="(showIDIComponents)",
                rows=1,
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="old_model", 
                        `title`="Old Model", 
                        `type`="number"),
                    list(
                        `name`="new_model", 
                        `title`="New Model", 
                        `type`="number"),
                    list(
                        `name`="improvement", 
                        `title`="Improvement", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="calibrationComparison",
                title="Calibration Comparison",
                visible="(showCalibrationComparison)",
                rows=1,
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="cal_slope", 
                        `title`="Calibration Slope", 
                        `type`="number"),
                    list(
                        `name`="cal_intercept", 
                        `title`="Calibration Intercept", 
                        `type`="number"),
                    list(
                        `name`="brier_score", 
                        `title`="Brier Score", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="reclassPlot",
                title="Risk Reclassification Plot",
                width=700,
                height=500,
                renderFun=".reclassPlot",
                visible=TRUE,
                clearWith=list(
                    "oldModelProb",
                    "newModelProb",
                    "riskCategories")))
            self$add(jmvcore::Image$new(
                options=options,
                name="improvementPlot",
                title="Probability Improvement Plot",
                width=700,
                height=500,
                renderFun=".improvementPlot",
                visible=TRUE,
                clearWith=list(
                    "oldModelProb",
                    "newModelProb",
                    "outcome")))
            self$add(jmvcore::Html$new(
                options=options,
                name="summary",
                title="Summary & Interpretation",
                visible=TRUE))}))

reclassmetricsBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "reclassmetricsBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "reclassmetrics",
                version = c(1,0,0),
                options = options,
                results = reclassmetricsResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = TRUE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Model Reclassification Metrics (NRI & IDI)
#'
#' Calculate reclassification metrics to compare predictive performance 
#' between two models. Provides Net Reclassification Improvement (NRI), 
#' Integrated Discrimination Improvement (IDI), and related metrics for both 
#' binary and survival outcomes. Essential for demonstrating incremental value 
#' of new biomarkers or predictors.
#' 
#'
#' @examples
#' # Example usage - Binary outcome:
#' # ClinicoPath::reclassmetrics(
#' #   data = data,
#' #   outcome = "disease",
#' #   oldModelProb = "old_risk",
#' #   newModelProb = "new_risk",
#' #   outcomeType = "binary",
#' #   riskCategories = "0.0,0.1,0.2,1.0"
#' # )
#' #
#' # Example usage - Survival outcome:
#' # ClinicoPath::reclassmetrics(
#' #   data = data,
#' #   outcome = "death",
#' #   survivalTime = "months",
#' #   oldModelProb = "old_surv",
#' #   newModelProb = "new_surv",
#' #   outcomeType = "survival",
#' #   timePoint = 60
#' # )
#'
#' @param data The data as a data frame.
#' @param outcome Binary outcome (for binary analysis) or event indicator (for
#'   survival).
#' @param outcomeType Type of outcome variable.
#' @param survivalTime Time to event or censoring (in months) for survival
#'   analysis.
#' @param timePoint Time point (in months) at which to evaluate survival
#'   predictions.
#' @param oldModelProb Predicted probabilities or survival probabilities from
#'   the baseline model.
#' @param newModelProb Predicted probabilities or survival probabilities from
#'   the enhanced model.
#' @param riskCategories Comma-separated risk thresholds for categorical NRI
#'   (e.g., "0.0,0.1,0.2,1.0" for low/medium/high risk groups).
#' @param nriType Type of NRI calculation.
#' @param ciLevel Confidence level for intervals (0.80-0.99).
#' @param bootstrapCI Use bootstrap resampling for confidence intervals
#'   (recommended).
#' @param nBootstrap Number of bootstrap samples for confidence intervals.
#' @param showReclassTable Display cross-tabulation of risk category changes.
#' @param showEventNonEvent Display NRI components separately for events and
#'   non-events.
#' @param showIDIComponents Display integrated sensitivity and 1-specificity
#'   improvements.
#' @param showCalibrationComparison Compare calibration between old and new
#'   models.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$nriResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$idiResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$reclassTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$eventNonEventNRI} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$idiComponents} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$calibrationComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$reclassPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$improvementPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$nriResults$asDF}
#'
#' \code{as.data.frame(results$nriResults)}
#'
#' @export
reclassmetrics <- function(
    data,
    outcome,
    outcomeType = "binary",
    survivalTime,
    timePoint = 60,
    oldModelProb,
    newModelProb,
    riskCategories = "0.0,0.1,0.2,1.0",
    nriType = "both",
    ciLevel = 0.95,
    bootstrapCI = TRUE,
    nBootstrap = 500,
    showReclassTable = TRUE,
    showEventNonEvent = TRUE,
    showIDIComponents = TRUE,
    showCalibrationComparison = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("reclassmetrics requires jmvcore to be installed (restart may be required)")

    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(survivalTime)) survivalTime <- jmvcore::resolveQuo(jmvcore::enquo(survivalTime))
    if ( ! missing(oldModelProb)) oldModelProb <- jmvcore::resolveQuo(jmvcore::enquo(oldModelProb))
    if ( ! missing(newModelProb)) newModelProb <- jmvcore::resolveQuo(jmvcore::enquo(newModelProb))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(survivalTime), survivalTime, NULL),
            `if`( ! missing(oldModelProb), oldModelProb, NULL),
            `if`( ! missing(newModelProb), newModelProb, NULL))


    options <- reclassmetricsOptions$new(
        outcome = outcome,
        outcomeType = outcomeType,
        survivalTime = survivalTime,
        timePoint = timePoint,
        oldModelProb = oldModelProb,
        newModelProb = newModelProb,
        riskCategories = riskCategories,
        nriType = nriType,
        ciLevel = ciLevel,
        bootstrapCI = bootstrapCI,
        nBootstrap = nBootstrap,
        showReclassTable = showReclassTable,
        showEventNonEvent = showEventNonEvent,
        showIDIComponents = showIDIComponents,
        showCalibrationComparison = showCalibrationComparison)

    analysis <- reclassmetricsClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

