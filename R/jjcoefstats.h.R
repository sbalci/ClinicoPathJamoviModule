
# This file is automatically generated, you probably don't want to edit this

jjcoefstatsOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jjcoefstatsOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            inputMode = "precomputed",
            term = NULL,
            estimate = NULL,
            stdError = NULL,
            confLow = NULL,
            confHigh = NULL,
            pValue = NULL,
            degreesOfFreedom = NULL,
            outcome = NULL,
            predictors = NULL,
            modelType = "lm",
            survivalTime = NULL,
            eventStatus = NULL,
            randomEffects = NULL,
            sortCoefs = FALSE,
            excludeIntercept = FALSE,
            showPValues = FALSE,
            pValueDisplay = "numeric",
            ciLevel = 0.95,
            exponentiate = FALSE,
            expScaleLabel = "exp",
            referenceValue = 0,
            colorScheme = "default",
            plotTheme = "default",
            plotWidth = 700,
            plotHeight = 500,
            showexplanations = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="jjcoefstats",
                requiresData=TRUE,
                ...)

            private$..inputMode <- jmvcore::OptionList$new(
                "inputMode",
                inputMode,
                options=list(
                    "precomputed",
                    "fitmodel"),
                default="precomputed")
            private$..term <- jmvcore::OptionVariable$new(
                "term",
                term,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..estimate <- jmvcore::OptionVariable$new(
                "estimate",
                estimate,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..stdError <- jmvcore::OptionVariable$new(
                "stdError",
                stdError,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..confLow <- jmvcore::OptionVariable$new(
                "confLow",
                confLow,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..confHigh <- jmvcore::OptionVariable$new(
                "confHigh",
                confHigh,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..pValue <- jmvcore::OptionVariable$new(
                "pValue",
                pValue,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..degreesOfFreedom <- jmvcore::OptionInteger$new(
                "degreesOfFreedom",
                degreesOfFreedom)
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..predictors <- jmvcore::OptionVariables$new(
                "predictors",
                predictors,
                default=NULL)
            private$..modelType <- jmvcore::OptionList$new(
                "modelType",
                modelType,
                options=list(
                    "lm",
                    "glm",
                    "cox",
                    "mixed"),
                default="lm")
            private$..survivalTime <- jmvcore::OptionVariable$new(
                "survivalTime",
                survivalTime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..eventStatus <- jmvcore::OptionVariable$new(
                "eventStatus",
                eventStatus,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..randomEffects <- jmvcore::OptionVariable$new(
                "randomEffects",
                randomEffects,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..sortCoefs <- jmvcore::OptionBool$new(
                "sortCoefs",
                sortCoefs,
                default=FALSE)
            private$..excludeIntercept <- jmvcore::OptionBool$new(
                "excludeIntercept",
                excludeIntercept,
                default=FALSE)
            private$..showPValues <- jmvcore::OptionBool$new(
                "showPValues",
                showPValues,
                default=FALSE)
            private$..pValueDisplay <- jmvcore::OptionList$new(
                "pValueDisplay",
                pValueDisplay,
                options=list(
                    "none",
                    "numeric",
                    "symbols"),
                default="numeric")
            private$..ciLevel <- jmvcore::OptionNumber$new(
                "ciLevel",
                ciLevel,
                default=0.95,
                min=0.8,
                max=0.99)
            private$..exponentiate <- jmvcore::OptionBool$new(
                "exponentiate",
                exponentiate,
                default=FALSE)
            private$..expScaleLabel <- jmvcore::OptionList$new(
                "expScaleLabel",
                expScaleLabel,
                options=list(
                    "or",
                    "hr",
                    "exp"),
                default="exp")
            private$..referenceValue <- jmvcore::OptionNumber$new(
                "referenceValue",
                referenceValue,
                default=0)
            private$..colorScheme <- jmvcore::OptionList$new(
                "colorScheme",
                colorScheme,
                options=list(
                    "default",
                    "colorblind",
                    "viridis",
                    "grayscale"),
                default="default")
            private$..plotTheme <- jmvcore::OptionList$new(
                "plotTheme",
                plotTheme,
                options=list(
                    "default",
                    "classic",
                    "minimal",
                    "light"),
                default="default")
            private$..plotWidth <- jmvcore::OptionInteger$new(
                "plotWidth",
                plotWidth,
                default=700,
                min=400,
                max=2000)
            private$..plotHeight <- jmvcore::OptionInteger$new(
                "plotHeight",
                plotHeight,
                default=500,
                min=300,
                max=2000)
            private$..showexplanations <- jmvcore::OptionBool$new(
                "showexplanations",
                showexplanations,
                default=FALSE)

            self$.addOption(private$..inputMode)
            self$.addOption(private$..term)
            self$.addOption(private$..estimate)
            self$.addOption(private$..stdError)
            self$.addOption(private$..confLow)
            self$.addOption(private$..confHigh)
            self$.addOption(private$..pValue)
            self$.addOption(private$..degreesOfFreedom)
            self$.addOption(private$..outcome)
            self$.addOption(private$..predictors)
            self$.addOption(private$..modelType)
            self$.addOption(private$..survivalTime)
            self$.addOption(private$..eventStatus)
            self$.addOption(private$..randomEffects)
            self$.addOption(private$..sortCoefs)
            self$.addOption(private$..excludeIntercept)
            self$.addOption(private$..showPValues)
            self$.addOption(private$..pValueDisplay)
            self$.addOption(private$..ciLevel)
            self$.addOption(private$..exponentiate)
            self$.addOption(private$..expScaleLabel)
            self$.addOption(private$..referenceValue)
            self$.addOption(private$..colorScheme)
            self$.addOption(private$..plotTheme)
            self$.addOption(private$..plotWidth)
            self$.addOption(private$..plotHeight)
            self$.addOption(private$..showexplanations)
        }),
    active = list(
        inputMode = function() private$..inputMode$value,
        term = function() private$..term$value,
        estimate = function() private$..estimate$value,
        stdError = function() private$..stdError$value,
        confLow = function() private$..confLow$value,
        confHigh = function() private$..confHigh$value,
        pValue = function() private$..pValue$value,
        degreesOfFreedom = function() private$..degreesOfFreedom$value,
        outcome = function() private$..outcome$value,
        predictors = function() private$..predictors$value,
        modelType = function() private$..modelType$value,
        survivalTime = function() private$..survivalTime$value,
        eventStatus = function() private$..eventStatus$value,
        randomEffects = function() private$..randomEffects$value,
        sortCoefs = function() private$..sortCoefs$value,
        excludeIntercept = function() private$..excludeIntercept$value,
        showPValues = function() private$..showPValues$value,
        pValueDisplay = function() private$..pValueDisplay$value,
        ciLevel = function() private$..ciLevel$value,
        exponentiate = function() private$..exponentiate$value,
        expScaleLabel = function() private$..expScaleLabel$value,
        referenceValue = function() private$..referenceValue$value,
        colorScheme = function() private$..colorScheme$value,
        plotTheme = function() private$..plotTheme$value,
        plotWidth = function() private$..plotWidth$value,
        plotHeight = function() private$..plotHeight$value,
        showexplanations = function() private$..showexplanations$value),
    private = list(
        ..inputMode = NA,
        ..term = NA,
        ..estimate = NA,
        ..stdError = NA,
        ..confLow = NA,
        ..confHigh = NA,
        ..pValue = NA,
        ..degreesOfFreedom = NA,
        ..outcome = NA,
        ..predictors = NA,
        ..modelType = NA,
        ..survivalTime = NA,
        ..eventStatus = NA,
        ..randomEffects = NA,
        ..sortCoefs = NA,
        ..excludeIntercept = NA,
        ..showPValues = NA,
        ..pValueDisplay = NA,
        ..ciLevel = NA,
        ..exponentiate = NA,
        ..expScaleLabel = NA,
        ..referenceValue = NA,
        ..colorScheme = NA,
        ..plotTheme = NA,
        ..plotWidth = NA,
        ..plotHeight = NA,
        ..showexplanations = NA)
)

jjcoefstatsResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jjcoefstatsResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        about = function() private$.items[["about"]],
        plainSummary = function() private$.items[["plainSummary"]],
        coefPlot = function() private$.items[["coefPlot"]],
        modelSummary = function() private$.items[["modelSummary"]],
        coefficientTable = function() private$.items[["coefficientTable"]],
        modelMetrics = function() private$.items[["modelMetrics"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Coefficient Forest Plot",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "janitor",
                    "labelled",
                    "glue",
                    "ggstatsplot",
                    "ggplot2",
                    "broom",
                    "survival",
                    "lme4"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="about",
                title="About",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="plainSummary",
                title="Plain-Language Summary",
                visible="(showexplanations)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="coefPlot",
                title="Coefficient Forest Plot",
                width=700,
                height=500,
                renderFun=".coefPlot",
                requiresData=TRUE,
                clearWith=list(
                    "term",
                    "estimate",
                    "stdError",
                    "outcome",
                    "predictors",
                    "modelType",
                    "sortCoefs",
                    "excludeIntercept",
                    "exponentiate",
                    "referenceValue")))
            self$add(jmvcore::Html$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="coefficientTable",
                title="Coefficients Table",
                visible=TRUE,
                rows=0,
                columns=list(
                    list(
                        `name`="term", 
                        `title`="Term", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="std_error", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="conf_low", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="conf_high", 
                        `title`="CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelMetrics",
                title="Model Fit Metrics",
                visible="(inputMode == 'fitmodel')",
                rows=0,
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))}))

jjcoefstatsBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jjcoefstatsBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "jjcoefstats",
                version = c(0,0,32),
                options = options,
                results = jjcoefstatsResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Coefficient Forest Plot (ggcoefstats)
#'
#' Create publication-ready forest plots for regression coefficients and 
#' meta-analysis results. Supports both pre-computed coefficients and 
#' automatic model fitting from raw data. Uses ggstatsplot's ggcoefstats() for 
#' professional visualization.
#' 
#'
#' @examples
#' # Example usage:
#' # For pre-computed coefficients:
#' # ClinicoPath::jjcoefstats(
#' #   data = model_results,
#' #   term = "term",
#' #   estimate = "estimate",
#' #   std_error = "std_error"
#' # )
#' #
#' # For automatic fitting:
#' # ClinicoPath::jjcoefstats(
#' #   data = mydata,
#' #   outcome = "weight",
#' #   predictors = vars(height, age, sex),
#' #   modelType = "lm"
#' # )
#'
#' @param data The data as a data frame.
#' @param inputMode Whether to use pre-computed coefficients or fit a model
#'   from raw data.
#' @param term Variable containing coefficient names (for pre-computed mode).
#' @param estimate Coefficient estimates or log-odds ratios.
#' @param stdError Standard errors of estimates.
#' @param confLow Lower confidence interval bounds.
#' @param confHigh Upper confidence interval bounds.
#' @param pValue P-values for each coefficient.
#' @param degreesOfFreedom Degrees of freedom for t-distribution. If provided,
#'   t-distribution will be used for confidence intervals and p-values instead
#'   of normal approximation. Typically n - p - 1 for regression models (n =
#'   sample size, p = number of predictors).
#' @param outcome Outcome variable for model fitting.
#' @param predictors Predictor variables for model fitting.
#' @param modelType Type of regression model to fit.
#' @param survivalTime Time variable for Cox proportional hazards model.
#' @param eventStatus Event indicator for Cox model (0=censored, 1=event).
#' @param randomEffects Grouping variable for random intercepts in mixed
#'   effects models (e.g., subject ID, cluster ID). Used to specify random
#'   effects term like (1|subject).
#' @param sortCoefs Sort coefficients by estimate magnitude.
#' @param excludeIntercept Exclude intercept from the plot.
#' @param showPValues Display p-values alongside coefficients.
#' @param pValueDisplay How to display p-values in the table and plot.
#' @param ciLevel Confidence level for intervals.
#' @param exponentiate Exponentiate coefficients (for odds ratios or hazard
#'   ratios).
#' @param expScaleLabel Label to apply to exponentiated coefficients in
#'   pre-computed mode.
#' @param referenceValue Reference value for plotting (0 for differences, 1
#'   for ratios; will auto-switch to 1 when exponentiating).
#' @param colorScheme Color palette for the plot.
#' @param plotTheme ggplot2 theme for the plot.
#' @param plotWidth Plot width in pixels.
#' @param plotHeight Plot height in pixels.
#' @param showexplanations Show explanations of the statistical results
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$about} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$plainSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$coefPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$coefficientTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelMetrics} \tab \tab \tab \tab \tab a table \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$coefficientTable$asDF}
#'
#' \code{as.data.frame(results$coefficientTable)}
#'
#' @export
jjcoefstats <- function(
    data,
    inputMode = "precomputed",
    term = NULL,
    estimate = NULL,
    stdError = NULL,
    confLow = NULL,
    confHigh = NULL,
    pValue = NULL,
    degreesOfFreedom,
    outcome = NULL,
    predictors = NULL,
    modelType = "lm",
    survivalTime = NULL,
    eventStatus = NULL,
    randomEffects = NULL,
    sortCoefs = FALSE,
    excludeIntercept = FALSE,
    showPValues = FALSE,
    pValueDisplay = "numeric",
    ciLevel = 0.95,
    exponentiate = FALSE,
    expScaleLabel = "exp",
    referenceValue = 0,
    colorScheme = "default",
    plotTheme = "default",
    plotWidth = 700,
    plotHeight = 500,
    showexplanations = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("jjcoefstats requires jmvcore to be installed (restart may be required)")

    if ( ! missing(term)) term <- jmvcore::resolveQuo(jmvcore::enquo(term))
    if ( ! missing(estimate)) estimate <- jmvcore::resolveQuo(jmvcore::enquo(estimate))
    if ( ! missing(stdError)) stdError <- jmvcore::resolveQuo(jmvcore::enquo(stdError))
    if ( ! missing(confLow)) confLow <- jmvcore::resolveQuo(jmvcore::enquo(confLow))
    if ( ! missing(confHigh)) confHigh <- jmvcore::resolveQuo(jmvcore::enquo(confHigh))
    if ( ! missing(pValue)) pValue <- jmvcore::resolveQuo(jmvcore::enquo(pValue))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(predictors)) predictors <- jmvcore::resolveQuo(jmvcore::enquo(predictors))
    if ( ! missing(survivalTime)) survivalTime <- jmvcore::resolveQuo(jmvcore::enquo(survivalTime))
    if ( ! missing(eventStatus)) eventStatus <- jmvcore::resolveQuo(jmvcore::enquo(eventStatus))
    if ( ! missing(randomEffects)) randomEffects <- jmvcore::resolveQuo(jmvcore::enquo(randomEffects))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(term), term, NULL),
            `if`( ! missing(estimate), estimate, NULL),
            `if`( ! missing(stdError), stdError, NULL),
            `if`( ! missing(confLow), confLow, NULL),
            `if`( ! missing(confHigh), confHigh, NULL),
            `if`( ! missing(pValue), pValue, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(predictors), predictors, NULL),
            `if`( ! missing(survivalTime), survivalTime, NULL),
            `if`( ! missing(eventStatus), eventStatus, NULL),
            `if`( ! missing(randomEffects), randomEffects, NULL))

    for (v in term) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in randomEffects) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- jjcoefstatsOptions$new(
        inputMode = inputMode,
        term = term,
        estimate = estimate,
        stdError = stdError,
        confLow = confLow,
        confHigh = confHigh,
        pValue = pValue,
        degreesOfFreedom = degreesOfFreedom,
        outcome = outcome,
        predictors = predictors,
        modelType = modelType,
        survivalTime = survivalTime,
        eventStatus = eventStatus,
        randomEffects = randomEffects,
        sortCoefs = sortCoefs,
        excludeIntercept = excludeIntercept,
        showPValues = showPValues,
        pValueDisplay = pValueDisplay,
        ciLevel = ciLevel,
        exponentiate = exponentiate,
        expScaleLabel = expScaleLabel,
        referenceValue = referenceValue,
        colorScheme = colorScheme,
        plotTheme = plotTheme,
        plotWidth = plotWidth,
        plotHeight = plotHeight,
        showexplanations = showexplanations)

    analysis <- jjcoefstatsClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

