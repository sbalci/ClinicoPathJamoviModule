
# This file is automatically generated, you probably don't want to edit this

pathologycompositionOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "pathologycompositionOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            outcome_variable = NULL,
            component1 = NULL,
            component2 = NULL,
            component3 = NULL,
            component4 = NULL,
            composition_analysis = TRUE,
            optimal_composition = TRUE,
            trend_test = TRUE,
            confidence_level = 0.95,
            low_risk_threshold = 0.05,
            high_risk_threshold = 0.2,
            min_group_size = 10,
            quantitative_categories = "gastric_cancer",
            composition_plot = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="pathologycomposition",
                requiresData=TRUE,
                ...)

            private$..outcome_variable <- jmvcore::OptionVariable$new(
                "outcome_variable",
                outcome_variable,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..component1 <- jmvcore::OptionVariable$new(
                "component1",
                component1,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..component2 <- jmvcore::OptionVariable$new(
                "component2",
                component2,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..component3 <- jmvcore::OptionVariable$new(
                "component3",
                component3,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..component4 <- jmvcore::OptionVariable$new(
                "component4",
                component4,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..composition_analysis <- jmvcore::OptionBool$new(
                "composition_analysis",
                composition_analysis,
                default=TRUE)
            private$..optimal_composition <- jmvcore::OptionBool$new(
                "optimal_composition",
                optimal_composition,
                default=TRUE)
            private$..trend_test <- jmvcore::OptionBool$new(
                "trend_test",
                trend_test,
                default=TRUE)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..low_risk_threshold <- jmvcore::OptionNumber$new(
                "low_risk_threshold",
                low_risk_threshold,
                min=0.01,
                max=0.1,
                default=0.05)
            private$..high_risk_threshold <- jmvcore::OptionNumber$new(
                "high_risk_threshold",
                high_risk_threshold,
                min=0.1,
                max=0.5,
                default=0.2)
            private$..min_group_size <- jmvcore::OptionInteger$new(
                "min_group_size",
                min_group_size,
                min=5,
                max=100,
                default=10)
            private$..quantitative_categories <- jmvcore::OptionList$new(
                "quantitative_categories",
                quantitative_categories,
                options=list(
                    "gastric_cancer",
                    "simplified",
                    "custom"),
                default="gastric_cancer")
            private$..composition_plot <- jmvcore::OptionBool$new(
                "composition_plot",
                composition_plot,
                default=TRUE)

            self$.addOption(private$..outcome_variable)
            self$.addOption(private$..component1)
            self$.addOption(private$..component2)
            self$.addOption(private$..component3)
            self$.addOption(private$..component4)
            self$.addOption(private$..composition_analysis)
            self$.addOption(private$..optimal_composition)
            self$.addOption(private$..trend_test)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..low_risk_threshold)
            self$.addOption(private$..high_risk_threshold)
            self$.addOption(private$..min_group_size)
            self$.addOption(private$..quantitative_categories)
            self$.addOption(private$..composition_plot)
        }),
    active = list(
        outcome_variable = function() private$..outcome_variable$value,
        component1 = function() private$..component1$value,
        component2 = function() private$..component2$value,
        component3 = function() private$..component3$value,
        component4 = function() private$..component4$value,
        composition_analysis = function() private$..composition_analysis$value,
        optimal_composition = function() private$..optimal_composition$value,
        trend_test = function() private$..trend_test$value,
        confidence_level = function() private$..confidence_level$value,
        low_risk_threshold = function() private$..low_risk_threshold$value,
        high_risk_threshold = function() private$..high_risk_threshold$value,
        min_group_size = function() private$..min_group_size$value,
        quantitative_categories = function() private$..quantitative_categories$value,
        composition_plot = function() private$..composition_plot$value),
    private = list(
        ..outcome_variable = NA,
        ..component1 = NA,
        ..component2 = NA,
        ..component3 = NA,
        ..component4 = NA,
        ..composition_analysis = NA,
        ..optimal_composition = NA,
        ..trend_test = NA,
        ..confidence_level = NA,
        ..low_risk_threshold = NA,
        ..high_risk_threshold = NA,
        ..min_group_size = NA,
        ..quantitative_categories = NA,
        ..composition_plot = NA)
)

pathologycompositionResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "pathologycompositionResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        componentanalysis = function() private$.items[["componentanalysis"]],
        compositionrisk = function() private$.items[["compositionrisk"]],
        optimalcompositions = function() private$.items[["optimalcompositions"]],
        compositionplot = function() private$.items[["compositionplot"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Pathology Composition Analysis",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Getting Started",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="componentanalysis",
                title="Individual Component Analysis",
                clearWith=list(
                    "outcome_variable",
                    "component1",
                    "component2",
                    "component3",
                    "component4",
                    "confidence_level",
                    "trend_test"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="compositionrisk",
                title="Composition Risk Analysis",
                visible="(composition_analysis)",
                clearWith=list(
                    "outcome_variable",
                    "component1",
                    "component2",
                    "component3",
                    "component4",
                    "composition_analysis",
                    "confidence_level"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="optimalcompositions",
                title="Optimal Composition Patterns",
                visible="(optimal_composition)",
                clearWith=list(
                    "outcome_variable",
                    "component1",
                    "component2",
                    "component3",
                    "component4",
                    "optimal_composition",
                    "low_risk_threshold",
                    "high_risk_threshold",
                    "min_group_size"),
                columns=list()))
            self$add(jmvcore::Image$new(
                options=options,
                name="compositionplot",
                title="Composition Risk Visualization",
                width=600,
                height=500,
                visible="(composition_plot && component1 && component2)",
                requiresData=TRUE,
                clearWith=list(
                    "outcome_variable",
                    "component1",
                    "component2",
                    "composition_plot")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation and Guidelines",
                visible=TRUE))}))

pathologycompositionBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "pathologycompositionBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "pathologycomposition",
                version = c(1,0,0),
                options = options,
                results = pathologycompositionResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Pathology Composition Analysis
#'
#' Semi-quantitative analysis of histologic components and their association 
#' with 
#' clinical outcomes. Based on advanced pathology research methodologies, 
#' particularly 
#' gastric cancer composition analysis. Performs component risk assessment, 
#' composition 
#' pattern analysis, and optimal threshold identification.
#' 
#'
#' @examples
#' data('pathology_data')
#'
#' pathologycomposition(data = pathology_data,
#'                     outcome_variable = lymph_node_metastasis,
#'                     component1 = signet_ring_cells,
#'                     component2 = poorly_differentiated,
#'                     composition_analysis = TRUE)
#'
#' @param data the data as a data frame
#' @param outcome_variable Clinical outcome variable for composition analysis
#' @param component1 First histologic component (proportion or category)
#' @param component2 Second histologic component (proportion or category)
#' @param component3 Third histologic component (proportion or category)
#' @param component4 Fourth histologic component (proportion or category)
#' @param composition_analysis Analyze risk based on component composition
#'   patterns
#' @param optimal_composition Identify optimal low-risk and high-risk
#'   composition patterns
#' @param trend_test Perform trend tests for dose-response relationships
#' @param confidence_level Confidence level for risk estimates and intervals
#' @param low_risk_threshold Maximum risk probability for low-risk
#'   classification (5\% = 0.05)
#' @param high_risk_threshold Minimum risk probability for high-risk
#'   classification (20\% = 0.20)
#' @param min_group_size Minimum number of cases required for composition
#'   pattern analysis
#' @param quantitative_categories Semi-quantitative categorization system for
#'   components
#' @param composition_plot Generate scatter plot of component composition vs
#'   risk
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$componentanalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$compositionrisk} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$optimalcompositions} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$compositionplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$componentanalysis$asDF}
#'
#' \code{as.data.frame(results$componentanalysis)}
#'
#' @export
pathologycomposition <- function(
    data,
    outcome_variable,
    component1,
    component2,
    component3,
    component4,
    composition_analysis = TRUE,
    optimal_composition = TRUE,
    trend_test = TRUE,
    confidence_level = 0.95,
    low_risk_threshold = 0.05,
    high_risk_threshold = 0.2,
    min_group_size = 10,
    quantitative_categories = "gastric_cancer",
    composition_plot = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("pathologycomposition requires jmvcore to be installed (restart may be required)")

    if ( ! missing(outcome_variable)) outcome_variable <- jmvcore::resolveQuo(jmvcore::enquo(outcome_variable))
    if ( ! missing(component1)) component1 <- jmvcore::resolveQuo(jmvcore::enquo(component1))
    if ( ! missing(component2)) component2 <- jmvcore::resolveQuo(jmvcore::enquo(component2))
    if ( ! missing(component3)) component3 <- jmvcore::resolveQuo(jmvcore::enquo(component3))
    if ( ! missing(component4)) component4 <- jmvcore::resolveQuo(jmvcore::enquo(component4))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(outcome_variable), outcome_variable, NULL),
            `if`( ! missing(component1), component1, NULL),
            `if`( ! missing(component2), component2, NULL),
            `if`( ! missing(component3), component3, NULL),
            `if`( ! missing(component4), component4, NULL))


    options <- pathologycompositionOptions$new(
        outcome_variable = outcome_variable,
        component1 = component1,
        component2 = component2,
        component3 = component3,
        component4 = component4,
        composition_analysis = composition_analysis,
        optimal_composition = optimal_composition,
        trend_test = trend_test,
        confidence_level = confidence_level,
        low_risk_threshold = low_risk_threshold,
        high_risk_threshold = high_risk_threshold,
        min_group_size = min_group_size,
        quantitative_categories = quantitative_categories,
        composition_plot = composition_plot)

    analysis <- pathologycompositionClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

