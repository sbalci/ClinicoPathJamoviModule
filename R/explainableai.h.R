
# This file is automatically generated, you probably don't want to edit this

explainableaiOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "explainableaiOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            analysis_type = "feature_importance",
            features = NULL,
            target_var = NULL,
            model_predictions = NULL,
            image_paths = NULL,
            attention_maps = NULL,
            shap_method = "kernel_explainer",
            lime_method = "tabular",
            n_samples = 100,
            n_features = 20,
            plot_type = "summary",
            overlay_original = TRUE,
            confidence_level = 0.95,
            background_samples = 100,
            perturbation_method = "random",
            clustering_method = "none",
            interaction_analysis = FALSE,
            local_explanations = TRUE,
            global_explanations = TRUE,
            save_explanations = FALSE,
            explanation_path = "",
            attention_threshold = 0.1,
            colormap = "viridis", ...) {

            super$initialize(
                package="ClinicoPath",
                name="explainableai",
                requiresData=TRUE,
                ...)

            private$..analysis_type <- jmvcore::OptionList$new(
                "analysis_type",
                analysis_type,
                options=list(
                    "feature_importance",
                    "shap_analysis",
                    "lime_analysis",
                    "attention_analysis",
                    "permutation_importance",
                    "partial_dependence"),
                default="feature_importance")
            private$..features <- jmvcore::OptionVariables$new(
                "features",
                features,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..target_var <- jmvcore::OptionVariable$new(
                "target_var",
                target_var,
                suggested=list(
                    "nominal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..model_predictions <- jmvcore::OptionVariable$new(
                "model_predictions",
                model_predictions,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..image_paths <- jmvcore::OptionVariable$new(
                "image_paths",
                image_paths,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "id"))
            private$..attention_maps <- jmvcore::OptionVariable$new(
                "attention_maps",
                attention_maps,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..shap_method <- jmvcore::OptionList$new(
                "shap_method",
                shap_method,
                options=list(
                    "tree_explainer",
                    "linear_explainer",
                    "kernel_explainer",
                    "deep_explainer"),
                default="kernel_explainer")
            private$..lime_method <- jmvcore::OptionList$new(
                "lime_method",
                lime_method,
                options=list(
                    "tabular",
                    "image",
                    "text"),
                default="tabular")
            private$..n_samples <- jmvcore::OptionNumber$new(
                "n_samples",
                n_samples,
                min=10,
                max=1000,
                default=100)
            private$..n_features <- jmvcore::OptionNumber$new(
                "n_features",
                n_features,
                min=5,
                max=50,
                default=20)
            private$..plot_type <- jmvcore::OptionList$new(
                "plot_type",
                plot_type,
                options=list(
                    "summary",
                    "waterfall",
                    "force",
                    "heatmap",
                    "beeswarm",
                    "bar"),
                default="summary")
            private$..overlay_original <- jmvcore::OptionBool$new(
                "overlay_original",
                overlay_original,
                default=TRUE)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.8,
                max=0.99,
                default=0.95)
            private$..background_samples <- jmvcore::OptionNumber$new(
                "background_samples",
                background_samples,
                min=50,
                max=500,
                default=100)
            private$..perturbation_method <- jmvcore::OptionList$new(
                "perturbation_method",
                perturbation_method,
                options=list(
                    "random",
                    "systematic",
                    "gaussian_noise",
                    "feature_ablation"),
                default="random")
            private$..clustering_method <- jmvcore::OptionList$new(
                "clustering_method",
                clustering_method,
                options=list(
                    "none",
                    "hierarchical",
                    "kmeans",
                    "correlation"),
                default="none")
            private$..interaction_analysis <- jmvcore::OptionBool$new(
                "interaction_analysis",
                interaction_analysis,
                default=FALSE)
            private$..local_explanations <- jmvcore::OptionBool$new(
                "local_explanations",
                local_explanations,
                default=TRUE)
            private$..global_explanations <- jmvcore::OptionBool$new(
                "global_explanations",
                global_explanations,
                default=TRUE)
            private$..save_explanations <- jmvcore::OptionBool$new(
                "save_explanations",
                save_explanations,
                default=FALSE)
            private$..explanation_path <- jmvcore::OptionString$new(
                "explanation_path",
                explanation_path,
                default="")
            private$..attention_threshold <- jmvcore::OptionNumber$new(
                "attention_threshold",
                attention_threshold,
                min=0,
                max=1,
                default=0.1)
            private$..colormap <- jmvcore::OptionList$new(
                "colormap",
                colormap,
                options=list(
                    "viridis",
                    "plasma",
                    "inferno",
                    "magma",
                    "coolwarm",
                    "seismic"),
                default="viridis")

            self$.addOption(private$..analysis_type)
            self$.addOption(private$..features)
            self$.addOption(private$..target_var)
            self$.addOption(private$..model_predictions)
            self$.addOption(private$..image_paths)
            self$.addOption(private$..attention_maps)
            self$.addOption(private$..shap_method)
            self$.addOption(private$..lime_method)
            self$.addOption(private$..n_samples)
            self$.addOption(private$..n_features)
            self$.addOption(private$..plot_type)
            self$.addOption(private$..overlay_original)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..background_samples)
            self$.addOption(private$..perturbation_method)
            self$.addOption(private$..clustering_method)
            self$.addOption(private$..interaction_analysis)
            self$.addOption(private$..local_explanations)
            self$.addOption(private$..global_explanations)
            self$.addOption(private$..save_explanations)
            self$.addOption(private$..explanation_path)
            self$.addOption(private$..attention_threshold)
            self$.addOption(private$..colormap)
        }),
    active = list(
        analysis_type = function() private$..analysis_type$value,
        features = function() private$..features$value,
        target_var = function() private$..target_var$value,
        model_predictions = function() private$..model_predictions$value,
        image_paths = function() private$..image_paths$value,
        attention_maps = function() private$..attention_maps$value,
        shap_method = function() private$..shap_method$value,
        lime_method = function() private$..lime_method$value,
        n_samples = function() private$..n_samples$value,
        n_features = function() private$..n_features$value,
        plot_type = function() private$..plot_type$value,
        overlay_original = function() private$..overlay_original$value,
        confidence_level = function() private$..confidence_level$value,
        background_samples = function() private$..background_samples$value,
        perturbation_method = function() private$..perturbation_method$value,
        clustering_method = function() private$..clustering_method$value,
        interaction_analysis = function() private$..interaction_analysis$value,
        local_explanations = function() private$..local_explanations$value,
        global_explanations = function() private$..global_explanations$value,
        save_explanations = function() private$..save_explanations$value,
        explanation_path = function() private$..explanation_path$value,
        attention_threshold = function() private$..attention_threshold$value,
        colormap = function() private$..colormap$value),
    private = list(
        ..analysis_type = NA,
        ..features = NA,
        ..target_var = NA,
        ..model_predictions = NA,
        ..image_paths = NA,
        ..attention_maps = NA,
        ..shap_method = NA,
        ..lime_method = NA,
        ..n_samples = NA,
        ..n_features = NA,
        ..plot_type = NA,
        ..overlay_original = NA,
        ..confidence_level = NA,
        ..background_samples = NA,
        ..perturbation_method = NA,
        ..clustering_method = NA,
        ..interaction_analysis = NA,
        ..local_explanations = NA,
        ..global_explanations = NA,
        ..save_explanations = NA,
        ..explanation_path = NA,
        ..attention_threshold = NA,
        ..colormap = NA)
)

explainableaiResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "explainableaiResults",
    inherit = jmvcore::Group,
    active = list(
        overview = function() private$.items[["overview"]],
        featureimportance = function() private$.items[["featureimportance"]],
        shapanalysis = function() private$.items[["shapanalysis"]],
        limeanalysis = function() private$.items[["limeanalysis"]],
        attentionanalysis = function() private$.items[["attentionanalysis"]],
        partialdependence = function() private$.items[["partialdependence"]],
        globalexplanations = function() private$.items[["globalexplanations"]],
        localexplanations = function() private$.items[["localexplanations"]],
        validationmetrics = function() private$.items[["validationmetrics"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Explainable AI Analysis",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="overview",
                title="Explainability Analysis Overview",
                visible=TRUE))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    importancetable = function() private$.items[["importancetable"]],
                    importanceplot = function() private$.items[["importanceplot"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="featureimportance",
                            title="Feature Importance Analysis")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="importancetable",
                            title="Feature Importance Scores",
                            columns=list(
                                list(
                                    `name`="feature", 
                                    `title`="Feature", 
                                    `type`="text"),
                                list(
                                    `name`="importance", 
                                    `title`="Importance Score", 
                                    `type`="number"),
                                list(
                                    `name`="std_error", 
                                    `title`="Standard Error", 
                                    `type`="number"),
                                list(
                                    `name`="ci_lower", 
                                    `title`="95% CI Lower", 
                                    `type`="number"),
                                list(
                                    `name`="ci_upper", 
                                    `title`="95% CI Upper", 
                                    `type`="number"),
                                list(
                                    `name`="rank", 
                                    `title`="Rank", 
                                    `type`="integer"))))
                        self$add(jmvcore::Image$new(
                            options=options,
                            name="importanceplot",
                            title="Feature Importance Plot",
                            width=700,
                            height=500,
                            renderFun=".plotFeatureImportance"))}))$new(options=options))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    shapvaluestable = function() private$.items[["shapvaluestable"]],
                    shapwaterfalltable = function() private$.items[["shapwaterfalltable"]],
                    shapinteractiontable = function() private$.items[["shapinteractiontable"]],
                    shapsummaryplot = function() private$.items[["shapsummaryplot"]],
                    shapwaterfallplot = function() private$.items[["shapwaterfallplot"]],
                    shapinteractionplot = function() private$.items[["shapinteractionplot"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="shapanalysis",
                            title="SHAP Analysis Results")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="shapvaluestable",
                            title="SHAP Values Summary",
                            columns=list(
                                list(
                                    `name`="feature", 
                                    `title`="Feature", 
                                    `type`="text"),
                                list(
                                    `name`="mean_shap_value", 
                                    `title`="Mean |SHAP Value|", 
                                    `type`="number"),
                                list(
                                    `name`="std_shap_value", 
                                    `title`="Std Dev", 
                                    `type`="number"),
                                list(
                                    `name`="min_shap_value", 
                                    `title`="Min SHAP Value", 
                                    `type`="number"),
                                list(
                                    `name`="max_shap_value", 
                                    `title`="Max SHAP Value", 
                                    `type`="number"))))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="shapwaterfalltable",
                            title="SHAP Waterfall Analysis",
                            visible="(local_explanations)",
                            columns=list(
                                list(
                                    `name`="sample_id", 
                                    `title`="Sample ID", 
                                    `type`="text"),
                                list(
                                    `name`="feature", 
                                    `title`="Feature", 
                                    `type`="text"),
                                list(
                                    `name`="feature_value", 
                                    `title`="Feature Value", 
                                    `type`="number"),
                                list(
                                    `name`="shap_value", 
                                    `title`="SHAP Value", 
                                    `type`="number"),
                                list(
                                    `name`="cumulative_sum", 
                                    `title`="Cumulative Sum", 
                                    `type`="number"))))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="shapinteractiontable",
                            title="SHAP Interaction Values",
                            visible="(interaction_analysis)",
                            columns=list(
                                list(
                                    `name`="feature1", 
                                    `title`="Feature 1", 
                                    `type`="text"),
                                list(
                                    `name`="feature2", 
                                    `title`="Feature 2", 
                                    `type`="text"),
                                list(
                                    `name`="interaction_strength", 
                                    `title`="Interaction Strength", 
                                    `type`="number"),
                                list(
                                    `name`="p_value", 
                                    `title`="P-value", 
                                    `type`="number", 
                                    `format`="zto,pvalue"))))
                        self$add(jmvcore::Image$new(
                            options=options,
                            name="shapsummaryplot",
                            title="SHAP Summary Plot",
                            width=800,
                            height=600,
                            renderFun=".plotSHAPSummary"))
                        self$add(jmvcore::Image$new(
                            options=options,
                            name="shapwaterfallplot",
                            title="SHAP Waterfall Plot",
                            visible="(local_explanations)",
                            width=700,
                            height=500,
                            renderFun=".plotSHAPWaterfall"))
                        self$add(jmvcore::Image$new(
                            options=options,
                            name="shapinteractionplot",
                            title="SHAP Interaction Plot",
                            visible="(interaction_analysis)",
                            width=600,
                            height=500,
                            renderFun=".plotSHAPInteraction"))}))$new(options=options))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    limeexplanationtable = function() private$.items[["limeexplanationtable"]],
                    limeplot = function() private$.items[["limeplot"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="limeanalysis",
                            title="LIME Analysis Results")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="limeexplanationtable",
                            title="LIME Explanations",
                            columns=list(
                                list(
                                    `name`="sample_id", 
                                    `title`="Sample ID", 
                                    `type`="text"),
                                list(
                                    `name`="feature", 
                                    `title`="Feature", 
                                    `type`="text"),
                                list(
                                    `name`="feature_value", 
                                    `title`="Feature Value", 
                                    `type`="text"),
                                list(
                                    `name`="weight", 
                                    `title`="Weight", 
                                    `type`="number"),
                                list(
                                    `name`="prediction_local", 
                                    `title`="Local Prediction", 
                                    `type`="number"),
                                list(
                                    `name`="r_squared", 
                                    `title`="Local R\u00B2", 
                                    `type`="number"))))
                        self$add(jmvcore::Image$new(
                            options=options,
                            name="limeplot",
                            title="LIME Explanation Plot",
                            width=700,
                            height=500,
                            renderFun=".plotLIME"))}))$new(options=options))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    attentionstatstable = function() private$.items[["attentionstatstable"]],
                    attentionpeakstable = function() private$.items[["attentionpeakstable"]],
                    attentionheatmapplot = function() private$.items[["attentionheatmapplot"]],
                    attentiondistributionplot = function() private$.items[["attentiondistributionplot"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="attentionanalysis",
                            title="Attention Map Analysis")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="attentionstatstable",
                            title="Attention Statistics",
                            columns=list(
                                list(
                                    `name`="region", 
                                    `title`="Image Region", 
                                    `type`="text"),
                                list(
                                    `name`="mean_attention", 
                                    `title`="Mean Attention", 
                                    `type`="number"),
                                list(
                                    `name`="std_attention", 
                                    `title`="Std Dev", 
                                    `type`="number"),
                                list(
                                    `name`="max_attention", 
                                    `title`="Max Attention", 
                                    `type`="number"),
                                list(
                                    `name`="attention_area", 
                                    `title`="Attention Area (%)", 
                                    `type`="number", 
                                    `format`="pc"))))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="attentionpeakstable",
                            title="Top Attention Peaks",
                            columns=list(
                                list(
                                    `name`="sample_id", 
                                    `title`="Sample ID", 
                                    `type`="text"),
                                list(
                                    `name`="peak_id", 
                                    `title`="Peak ID", 
                                    `type`="integer"),
                                list(
                                    `name`="x_coord", 
                                    `title`="X Coordinate", 
                                    `type`="integer"),
                                list(
                                    `name`="y_coord", 
                                    `title`="Y Coordinate", 
                                    `type`="integer"),
                                list(
                                    `name`="attention_value", 
                                    `title`="Attention Value", 
                                    `type`="number"),
                                list(
                                    `name`="region_size", 
                                    `title`="Region Size (pixels)", 
                                    `type`="integer"))))
                        self$add(jmvcore::Image$new(
                            options=options,
                            name="attentionheatmapplot",
                            title="Attention Heatmaps",
                            width=900,
                            height=600,
                            renderFun=".plotAttentionHeatmap"))
                        self$add(jmvcore::Image$new(
                            options=options,
                            name="attentiondistributionplot",
                            title="Attention Distribution",
                            width=600,
                            height=400,
                            renderFun=".plotAttentionDistribution"))}))$new(options=options))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    pdptable = function() private$.items[["pdptable"]],
                    pdpplot = function() private$.items[["pdpplot"]],
                    iceplot = function() private$.items[["iceplot"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="partialdependence",
                            title="Partial Dependence Analysis")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="pdptable",
                            title="Partial Dependence Values",
                            columns=list(
                                list(
                                    `name`="feature", 
                                    `title`="Feature", 
                                    `type`="text"),
                                list(
                                    `name`="value_range", 
                                    `title`="Value Range", 
                                    `type`="text"),
                                list(
                                    `name`="pd_effect", 
                                    `title`="PD Effect", 
                                    `type`="number"),
                                list(
                                    `name`="ice_std", 
                                    `title`="ICE Std Dev", 
                                    `type`="number"),
                                list(
                                    `name`="interaction_strength", 
                                    `title`="Interaction Strength", 
                                    `type`="number"))))
                        self$add(jmvcore::Image$new(
                            options=options,
                            name="pdpplot",
                            title="Partial Dependence Plots",
                            width=800,
                            height=600,
                            renderFun=".plotPartialDependence"))
                        self$add(jmvcore::Image$new(
                            options=options,
                            name="iceplot",
                            title="Individual Conditional Expectation (ICE) Plot",
                            width=700,
                            height=500,
                            renderFun=".plotICE"))}))$new(options=options))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    modelinsightstable = function() private$.items[["modelinsightstable"]],
                    featureclusteringtable = function() private$.items[["featureclusteringtable"]],
                    globalinsightplot = function() private$.items[["globalinsightplot"]],
                    featureclusterplot = function() private$.items[["featureclusterplot"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="globalexplanations",
                            title="Global Model Explanations")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="modelinsightstable",
                            title="Model Insights Summary",
                            columns=list(
                                list(
                                    `name`="insight_type", 
                                    `title`="Insight Type", 
                                    `type`="text"),
                                list(
                                    `name`="description", 
                                    `title`="Description", 
                                    `type`="text"),
                                list(
                                    `name`="importance_score", 
                                    `title`="Importance Score", 
                                    `type`="number"),
                                list(
                                    `name`="confidence", 
                                    `title`="Confidence", 
                                    `type`="number", 
                                    `format`="pc"))))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="featureclusteringtable",
                            title="Feature Clustering Results",
                            visible="(!clustering_method:none)",
                            columns=list(
                                list(
                                    `name`="cluster_id", 
                                    `title`="Cluster ID", 
                                    `type`="integer"),
                                list(
                                    `name`="features", 
                                    `title`="Features in Cluster", 
                                    `type`="text"),
                                list(
                                    `name`="cluster_importance", 
                                    `title`="Cluster Importance", 
                                    `type`="number"),
                                list(
                                    `name`="within_cluster_similarity", 
                                    `title`="Within-Cluster Similarity", 
                                    `type`="number"))))
                        self$add(jmvcore::Image$new(
                            options=options,
                            name="globalinsightplot",
                            title="Global Model Insights",
                            width=800,
                            height=600,
                            renderFun=".plotGlobalInsights"))
                        self$add(jmvcore::Image$new(
                            options=options,
                            name="featureclusterplot",
                            title="Feature Clustering Visualization",
                            visible="(!clustering_method:none)",
                            width=700,
                            height=500,
                            renderFun=".plotFeatureClustering"))}))$new(options=options))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    samplewiseexplanationtable = function() private$.items[["samplewiseexplanationtable"]],
                    localexplanationplot = function() private$.items[["localexplanationplot"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="localexplanations",
                            title="Local Sample Explanations")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="samplewiseexplanationtable",
                            title="Sample-wise Explanations",
                            columns=list(
                                list(
                                    `name`="sample_id", 
                                    `title`="Sample ID", 
                                    `type`="text"),
                                list(
                                    `name`="prediction", 
                                    `title`="Prediction", 
                                    `type`="number"),
                                list(
                                    `name`="confidence", 
                                    `title`="Confidence", 
                                    `type`="number", 
                                    `format`="pc"),
                                list(
                                    `name`="top_positive_feature", 
                                    `title`="Top Positive Feature", 
                                    `type`="text"),
                                list(
                                    `name`="top_negative_feature", 
                                    `title`="Top Negative Feature", 
                                    `type`="text"),
                                list(
                                    `name`="explanation_quality", 
                                    `title`="Explanation Quality", 
                                    `type`="number"))))
                        self$add(jmvcore::Image$new(
                            options=options,
                            name="localexplanationplot",
                            title="Local Explanation Examples",
                            width=900,
                            height=700,
                            renderFun=".plotLocalExplanations"))}))$new(options=options))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    validationtable = function() private$.items[["validationtable"]],
                    stabilityanalysistable = function() private$.items[["stabilityanalysistable"]],
                    validationplot = function() private$.items[["validationplot"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="validationmetrics",
                            title="Explanation Validation")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="validationtable",
                            title="Explanation Validation Metrics",
                            columns=list(
                                list(
                                    `name`="validation_metric", 
                                    `title`="Validation Metric", 
                                    `type`="text"),
                                list(
                                    `name`="score", 
                                    `title`="Score", 
                                    `type`="number"),
                                list(
                                    `name`="interpretation", 
                                    `title`="Interpretation", 
                                    `type`="text"))))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="stabilityanalysistable",
                            title="Explanation Stability Analysis",
                            columns=list(
                                list(
                                    `name`="feature", 
                                    `title`="Feature", 
                                    `type`="text"),
                                list(
                                    `name`="stability_score", 
                                    `title`="Stability Score", 
                                    `type`="number"),
                                list(
                                    `name`="variance", 
                                    `title`="Variance", 
                                    `type`="number"),
                                list(
                                    `name`="reliability", 
                                    `title`="Reliability", 
                                    `type`="text"))))
                        self$add(jmvcore::Image$new(
                            options=options,
                            name="validationplot",
                            title="Explanation Validation Plot",
                            width=600,
                            height=400,
                            renderFun=".plotExplanationValidation"))}))$new(options=options))}))

explainableaiBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "explainableaiBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "explainableai",
                version = c(1,0,0),
                options = options,
                results = explainableaiResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Explainable AI Analysis
#'
#' Comprehensive explainable AI toolkit for interpreting machine learning 
#' models
#' in medical and clinical applications. Provides attention maps, feature 
#' importance,
#' SHAP values, and other interpretability methods.
#' 
#'
#' @examples
#' # SHAP analysis for feature importance
#' explainableai(
#'     data = model_data,
#'     model_predictions = "predictions_var",
#'     features = c("feature1", "feature2", "feature3"),
#'     method = "shap",
#'     plot_type = "summary"
#' )
#'
#' # Attention map analysis for image models
#' explainableai(
#'     data = image_data,
#'     image_paths = "image_path_var",
#'     attention_maps = "attention_var",
#'     method = "attention_analysis",
#'     overlay_original = TRUE
#' )
#'
#' @param data the data as a data frame
#' @param analysis_type type of explainability analysis to perform
#' @param features features/variables for importance analysis
#' @param target_var target variable or model predictions
#' @param model_predictions variable containing model predictions or
#'   probabilities
#' @param image_paths variable containing paths to image files
#' @param attention_maps variable containing attention map data or file paths
#' @param shap_method SHAP explainer method based on model type
#' @param lime_method LIME explanation method for different data types
#' @param n_samples number of samples to use for explanation analysis
#' @param n_features number of top important features to display
#' @param plot_type type of visualization for explanations
#' @param overlay_original overlay attention maps on original images
#' @param confidence_level confidence level for statistical intervals
#' @param background_samples number of background samples for SHAP baseline
#' @param perturbation_method method for perturbing features in permutation
#'   importance
#' @param clustering_method method for grouping similar features
#' @param interaction_analysis analyze pairwise feature interactions
#' @param local_explanations create individual sample explanations
#' @param global_explanations create overall model explanations
#' @param save_explanations save explanation data for external use
#' @param explanation_path file path to save explanation results
#' @param attention_threshold minimum attention value to display in
#'   visualizations
#' @param colormap color palette for explanation visualizations
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$overview} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$featureimportance$importancetable} \tab \tab \tab \tab \tab Ranked list of feature importance scores \cr
#'   \code{results$featureimportance$importanceplot} \tab \tab \tab \tab \tab Bar plot of feature importance scores \cr
#'   \code{results$shapanalysis$shapvaluestable} \tab \tab \tab \tab \tab Mean absolute SHAP values per feature \cr
#'   \code{results$shapanalysis$shapwaterfalltable} \tab \tab \tab \tab \tab Individual prediction explanations \cr
#'   \code{results$shapanalysis$shapinteractiontable} \tab \tab \tab \tab \tab Feature interaction effects \cr
#'   \code{results$shapanalysis$shapsummaryplot} \tab \tab \tab \tab \tab Overview of SHAP values for all features \cr
#'   \code{results$shapanalysis$shapwaterfallplot} \tab \tab \tab \tab \tab Individual prediction explanation \cr
#'   \code{results$shapanalysis$shapinteractionplot} \tab \tab \tab \tab \tab Feature interaction heatmap \cr
#'   \code{results$limeanalysis$limeexplanationtable} \tab \tab \tab \tab \tab Local explanations for individual predictions \cr
#'   \code{results$limeanalysis$limeplot} \tab \tab \tab \tab \tab Local explanation visualization \cr
#'   \code{results$attentionanalysis$attentionstatstable} \tab \tab \tab \tab \tab Summary statistics of attention patterns \cr
#'   \code{results$attentionanalysis$attentionpeakstable} \tab \tab \tab \tab \tab Highest attention regions across samples \cr
#'   \code{results$attentionanalysis$attentionheatmapplot} \tab \tab \tab \tab \tab Attention map overlays on original images \cr
#'   \code{results$attentionanalysis$attentiondistributionplot} \tab \tab \tab \tab \tab Distribution of attention values \cr
#'   \code{results$partialdependence$pdptable} \tab \tab \tab \tab \tab Partial dependence effect sizes \cr
#'   \code{results$partialdependence$pdpplot} \tab \tab \tab \tab \tab Effect of individual features on predictions \cr
#'   \code{results$partialdependence$iceplot} \tab \tab \tab \tab \tab Individual conditional expectation curves \cr
#'   \code{results$globalexplanations$modelinsightstable} \tab \tab \tab \tab \tab Overall model behavior insights \cr
#'   \code{results$globalexplanations$featureclusteringtable} \tab \tab \tab \tab \tab Groups of similar features \cr
#'   \code{results$globalexplanations$globalinsightplot} \tab \tab \tab \tab \tab Overall model behavior visualization \cr
#'   \code{results$globalexplanations$featureclusterplot} \tab \tab \tab \tab \tab Dendrogram or cluster plot of features \cr
#'   \code{results$localexplanations$samplewiseexplanationtable} \tab \tab \tab \tab \tab Detailed explanations for individual samples \cr
#'   \code{results$localexplanations$localexplanationplot} \tab \tab \tab \tab \tab Individual sample explanation examples \cr
#'   \code{results$validationmetrics$validationtable} \tab \tab \tab \tab \tab Quality metrics for explanations \cr
#'   \code{results$validationmetrics$stabilityanalysistable} \tab \tab \tab \tab \tab Consistency of explanations across perturbations \cr
#'   \code{results$validationmetrics$validationplot} \tab \tab \tab \tab \tab Validation metrics visualization \cr
#' }
#'
#' @export
explainableai <- function(
    data,
    analysis_type = "feature_importance",
    features,
    target_var,
    model_predictions,
    image_paths,
    attention_maps,
    shap_method = "kernel_explainer",
    lime_method = "tabular",
    n_samples = 100,
    n_features = 20,
    plot_type = "summary",
    overlay_original = TRUE,
    confidence_level = 0.95,
    background_samples = 100,
    perturbation_method = "random",
    clustering_method = "none",
    interaction_analysis = FALSE,
    local_explanations = TRUE,
    global_explanations = TRUE,
    save_explanations = FALSE,
    explanation_path = "",
    attention_threshold = 0.1,
    colormap = "viridis") {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("explainableai requires jmvcore to be installed (restart may be required)")

    if ( ! missing(features)) features <- jmvcore::resolveQuo(jmvcore::enquo(features))
    if ( ! missing(target_var)) target_var <- jmvcore::resolveQuo(jmvcore::enquo(target_var))
    if ( ! missing(model_predictions)) model_predictions <- jmvcore::resolveQuo(jmvcore::enquo(model_predictions))
    if ( ! missing(image_paths)) image_paths <- jmvcore::resolveQuo(jmvcore::enquo(image_paths))
    if ( ! missing(attention_maps)) attention_maps <- jmvcore::resolveQuo(jmvcore::enquo(attention_maps))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(features), features, NULL),
            `if`( ! missing(target_var), target_var, NULL),
            `if`( ! missing(model_predictions), model_predictions, NULL),
            `if`( ! missing(image_paths), image_paths, NULL),
            `if`( ! missing(attention_maps), attention_maps, NULL))


    options <- explainableaiOptions$new(
        analysis_type = analysis_type,
        features = features,
        target_var = target_var,
        model_predictions = model_predictions,
        image_paths = image_paths,
        attention_maps = attention_maps,
        shap_method = shap_method,
        lime_method = lime_method,
        n_samples = n_samples,
        n_features = n_features,
        plot_type = plot_type,
        overlay_original = overlay_original,
        confidence_level = confidence_level,
        background_samples = background_samples,
        perturbation_method = perturbation_method,
        clustering_method = clustering_method,
        interaction_analysis = interaction_analysis,
        local_explanations = local_explanations,
        global_explanations = global_explanations,
        save_explanations = save_explanations,
        explanation_path = explanation_path,
        attention_threshold = attention_threshold,
        colormap = colormap)

    analysis <- explainableaiClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

