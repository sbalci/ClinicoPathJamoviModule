
# This file is automatically generated, you probably don't want to edit this

surveysurvivalOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "surveysurvivalOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            tint = FALSE,
            dxdate = NULL,
            fudate = NULL,
            timetypedata = "ymd",
            timetypeoutput = "months",
            outcome = NULL,
            outcomeLevel = NULL,
            weights = NULL,
            strata = NULL,
            cluster = NULL,
            fpc = NULL,
            design_type = "srs",
            nest_clusters = FALSE,
            explanatory = NULL,
            contexpl = NULL,
            km_weighted = TRUE,
            cox_weighted = FALSE,
            robust_se = TRUE,
            ci_level = 0.95,
            population_totals = FALSE,
            subpopulation = NULL,
            km_plot = TRUE,
            endplot = 60,
            byplot = 12,
            ci95 = TRUE,
            risktable = FALSE,
            design_summary = TRUE,
            showSummaries = FALSE,
            showExplanations = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="surveysurvival",
                requiresData=TRUE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..tint <- jmvcore::OptionBool$new(
                "tint",
                tint,
                default=FALSE)
            private$..dxdate <- jmvcore::OptionVariable$new(
                "dxdate",
                dxdate,
                default=NULL)
            private$..fudate <- jmvcore::OptionVariable$new(
                "fudate",
                fudate,
                default=NULL)
            private$..timetypedata <- jmvcore::OptionList$new(
                "timetypedata",
                timetypedata,
                options=list(
                    "ymd",
                    "mdy",
                    "dmy"),
                default="ymd")
            private$..timetypeoutput <- jmvcore::OptionList$new(
                "timetypeoutput",
                timetypeoutput,
                options=list(
                    "days",
                    "weeks",
                    "months",
                    "years"),
                default="months")
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "ordinal",
                    "nominal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..outcomeLevel <- jmvcore::OptionLevel$new(
                "outcomeLevel",
                outcomeLevel,
                variable="(outcome)")
            private$..weights <- jmvcore::OptionVariable$new(
                "weights",
                weights,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..strata <- jmvcore::OptionVariable$new(
                "strata",
                strata,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..cluster <- jmvcore::OptionVariable$new(
                "cluster",
                cluster,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..fpc <- jmvcore::OptionVariable$new(
                "fpc",
                fpc,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..design_type <- jmvcore::OptionList$new(
                "design_type",
                design_type,
                options=list(
                    "srs",
                    "stratified",
                    "cluster",
                    "stratified_cluster",
                    "multistage"),
                default="srs")
            private$..nest_clusters <- jmvcore::OptionBool$new(
                "nest_clusters",
                nest_clusters,
                default=FALSE)
            private$..explanatory <- jmvcore::OptionVariables$new(
                "explanatory",
                explanatory,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..contexpl <- jmvcore::OptionVariables$new(
                "contexpl",
                contexpl,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..km_weighted <- jmvcore::OptionBool$new(
                "km_weighted",
                km_weighted,
                default=TRUE)
            private$..cox_weighted <- jmvcore::OptionBool$new(
                "cox_weighted",
                cox_weighted,
                default=FALSE)
            private$..robust_se <- jmvcore::OptionBool$new(
                "robust_se",
                robust_se,
                default=TRUE)
            private$..ci_level <- jmvcore::OptionNumber$new(
                "ci_level",
                ci_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..population_totals <- jmvcore::OptionBool$new(
                "population_totals",
                population_totals,
                default=FALSE)
            private$..subpopulation <- jmvcore::OptionVariable$new(
                "subpopulation",
                subpopulation,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..km_plot <- jmvcore::OptionBool$new(
                "km_plot",
                km_plot,
                default=TRUE)
            private$..endplot <- jmvcore::OptionInteger$new(
                "endplot",
                endplot,
                default=60)
            private$..byplot <- jmvcore::OptionInteger$new(
                "byplot",
                byplot,
                default=12)
            private$..ci95 <- jmvcore::OptionBool$new(
                "ci95",
                ci95,
                default=TRUE)
            private$..risktable <- jmvcore::OptionBool$new(
                "risktable",
                risktable,
                default=FALSE)
            private$..design_summary <- jmvcore::OptionBool$new(
                "design_summary",
                design_summary,
                default=TRUE)
            private$..showSummaries <- jmvcore::OptionBool$new(
                "showSummaries",
                showSummaries,
                default=FALSE)
            private$..showExplanations <- jmvcore::OptionBool$new(
                "showExplanations",
                showExplanations,
                default=FALSE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..tint)
            self$.addOption(private$..dxdate)
            self$.addOption(private$..fudate)
            self$.addOption(private$..timetypedata)
            self$.addOption(private$..timetypeoutput)
            self$.addOption(private$..outcome)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..weights)
            self$.addOption(private$..strata)
            self$.addOption(private$..cluster)
            self$.addOption(private$..fpc)
            self$.addOption(private$..design_type)
            self$.addOption(private$..nest_clusters)
            self$.addOption(private$..explanatory)
            self$.addOption(private$..contexpl)
            self$.addOption(private$..km_weighted)
            self$.addOption(private$..cox_weighted)
            self$.addOption(private$..robust_se)
            self$.addOption(private$..ci_level)
            self$.addOption(private$..population_totals)
            self$.addOption(private$..subpopulation)
            self$.addOption(private$..km_plot)
            self$.addOption(private$..endplot)
            self$.addOption(private$..byplot)
            self$.addOption(private$..ci95)
            self$.addOption(private$..risktable)
            self$.addOption(private$..design_summary)
            self$.addOption(private$..showSummaries)
            self$.addOption(private$..showExplanations)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        tint = function() private$..tint$value,
        dxdate = function() private$..dxdate$value,
        fudate = function() private$..fudate$value,
        timetypedata = function() private$..timetypedata$value,
        timetypeoutput = function() private$..timetypeoutput$value,
        outcome = function() private$..outcome$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        weights = function() private$..weights$value,
        strata = function() private$..strata$value,
        cluster = function() private$..cluster$value,
        fpc = function() private$..fpc$value,
        design_type = function() private$..design_type$value,
        nest_clusters = function() private$..nest_clusters$value,
        explanatory = function() private$..explanatory$value,
        contexpl = function() private$..contexpl$value,
        km_weighted = function() private$..km_weighted$value,
        cox_weighted = function() private$..cox_weighted$value,
        robust_se = function() private$..robust_se$value,
        ci_level = function() private$..ci_level$value,
        population_totals = function() private$..population_totals$value,
        subpopulation = function() private$..subpopulation$value,
        km_plot = function() private$..km_plot$value,
        endplot = function() private$..endplot$value,
        byplot = function() private$..byplot$value,
        ci95 = function() private$..ci95$value,
        risktable = function() private$..risktable$value,
        design_summary = function() private$..design_summary$value,
        showSummaries = function() private$..showSummaries$value,
        showExplanations = function() private$..showExplanations$value),
    private = list(
        ..elapsedtime = NA,
        ..tint = NA,
        ..dxdate = NA,
        ..fudate = NA,
        ..timetypedata = NA,
        ..timetypeoutput = NA,
        ..outcome = NA,
        ..outcomeLevel = NA,
        ..weights = NA,
        ..strata = NA,
        ..cluster = NA,
        ..fpc = NA,
        ..design_type = NA,
        ..nest_clusters = NA,
        ..explanatory = NA,
        ..contexpl = NA,
        ..km_weighted = NA,
        ..cox_weighted = NA,
        ..robust_se = NA,
        ..ci_level = NA,
        ..population_totals = NA,
        ..subpopulation = NA,
        ..km_plot = NA,
        ..endplot = NA,
        ..byplot = NA,
        ..ci95 = NA,
        ..risktable = NA,
        ..design_summary = NA,
        ..showSummaries = NA,
        ..showExplanations = NA)
)

surveysurvivalResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "surveysurvivalResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        designSummary = function() private$.items[["designSummary"]],
        survivalAnalysis = function() private$.items[["survivalAnalysis"]],
        coxAnalysis = function() private$.items[["coxAnalysis"]],
        populationEstimates = function() private$.items[["populationEstimates"]],
        kmPlot = function() private$.items[["kmPlot"]],
        designDiagnostics = function() private$.items[["designDiagnostics"]],
        weightedSurvivalTable = function() private$.items[["weightedSurvivalTable"]],
        coxCoefficients = function() private$.items[["coxCoefficients"]],
        populationTotalsTable = function() private$.items[["populationTotalsTable"]],
        subpopulationAnalysis = function() private$.items[["subpopulationAnalysis"]],
        modelFitStatistics = function() private$.items[["modelFitStatistics"]],
        designEffectsSummary = function() private$.items[["designEffectsSummary"]],
        analysisSummary = function() private$.items[["analysisSummary"]],
        methodExplanation = function() private$.items[["methodExplanation"]],
        surveyDesignExplanation = function() private$.items[["surveyDesignExplanation"]],
        kmWeightedExplanation = function() private$.items[["kmWeightedExplanation"]],
        coxWeightedExplanation = function() private$.items[["coxWeightedExplanation"]],
        populationInferenceExplanation = function() private$.items[["populationInferenceExplanation"]],
        calculatedtime = function() private$.items[["calculatedtime"]],
        outcomeredefined = function() private$.items[["outcomeredefined"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Survey-Weighted Survival Analysis",
                refs=list(
                    "survey",
                    "survival",
                    "survminer",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="To Do",
                clearWith=list(
                    "outcome",
                    "outcomeLevel",
                    "elapsedtime",
                    "weights",
                    "strata",
                    "cluster",
                    "design_type",
                    "explanatory",
                    "contexpl",
                    "fudate",
                    "dxdate",
                    "tint")))
            self$add(jmvcore::Html$new(
                options=options,
                name="designSummary",
                title="Survey Design Summary",
                visible="(design_summary)",
                clearWith=list(
                    "weights",
                    "strata",
                    "cluster",
                    "design_type",
                    "nest_clusters",
                    "fpc")))
            self$add(jmvcore::Html$new(
                options=options,
                name="survivalAnalysis",
                title="Survey-Weighted Kaplan-Meier Analysis",
                visible="(km_weighted)",
                clearWith=list(
                    "km_weighted",
                    "outcome",
                    "outcomeLevel",
                    "elapsedtime",
                    "weights",
                    "strata",
                    "cluster",
                    "design_type",
                    "explanatory",
                    "fudate",
                    "dxdate",
                    "tint")))
            self$add(jmvcore::Html$new(
                options=options,
                name="coxAnalysis",
                title="Survey-Weighted Cox Regression",
                visible="(cox_weighted)",
                clearWith=list(
                    "cox_weighted",
                    "outcome",
                    "outcomeLevel",
                    "elapsedtime",
                    "explanatory",
                    "contexpl",
                    "weights",
                    "strata",
                    "cluster",
                    "design_type",
                    "robust_se",
                    "fudate",
                    "dxdate",
                    "tint")))
            self$add(jmvcore::Html$new(
                options=options,
                name="populationEstimates",
                title="Population-Level Survival Estimates",
                visible="(population_totals)",
                clearWith=list(
                    "population_totals",
                    "weights",
                    "outcome",
                    "outcomeLevel",
                    "subpopulation")))
            self$add(jmvcore::Image$new(
                options=options,
                name="kmPlot",
                title="Survey-Weighted Kaplan-Meier Plot",
                width=600,
                height=450,
                renderFun=".kmPlot",
                requiresData=TRUE,
                visible="(km_plot)",
                clearWith=list(
                    "km_plot",
                    "km_weighted",
                    "endplot",
                    "byplot",
                    "ci95",
                    "risktable",
                    "outcome",
                    "outcomeLevel",
                    "elapsedtime",
                    "explanatory",
                    "weights",
                    "strata",
                    "cluster",
                    "fudate",
                    "dxdate",
                    "tint")))
            self$add(jmvcore::Table$new(
                options=options,
                name="designDiagnostics",
                title="Survey Design Diagnostics",
                visible="(design_summary)",
                rows=0,
                columns=list(
                    list(
                        `name`="characteristic", 
                        `title`="Design Characteristic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"),
                    list(
                        `name`="description", 
                        `title`="Description", 
                        `type`="text")),
                clearWith=list(
                    "weights",
                    "strata",
                    "cluster",
                    "design_type",
                    "nest_clusters",
                    "fpc")))
            self$add(jmvcore::Table$new(
                options=options,
                name="weightedSurvivalTable",
                title="Survey-Weighted Survival Summary",
                visible="(km_weighted)",
                rows=0,
                columns=list(
                    list(
                        `name`="strata", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="n_effective", 
                        `title`="Effective N", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="median_survival", 
                        `title`="Median Survival", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower", 
                        `superTitle`="95% CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper", 
                        `superTitle`="95% CI", 
                        `type`="number", 
                        `format`="zto")),
                clearWith=list(
                    "km_weighted",
                    "ci_level",
                    "outcome",
                    "outcomeLevel",
                    "elapsedtime",
                    "explanatory",
                    "weights")))
            self$add(jmvcore::Table$new(
                options=options,
                name="coxCoefficients",
                title="Survey-Weighted Cox Regression Coefficients",
                visible="(cox_weighted)",
                rows=0,
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="level", 
                        `title`="Level", 
                        `type`="text"),
                    list(
                        `name`="coef", 
                        `title`="Coefficient", 
                        `type`="number"),
                    list(
                        `name`="hr", 
                        `title`="Hazard Ratio", 
                        `type`="number"),
                    list(
                        `name`="se_robust", 
                        `title`="Robust SE", 
                        `type`="number"),
                    list(
                        `name`="z_stat", 
                        `title`="Z-statistic", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="P-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower", 
                        `superTitle`="95% CI", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper", 
                        `superTitle`="95% CI", 
                        `type`="number")),
                clearWith=list(
                    "cox_weighted",
                    "explanatory",
                    "contexpl",
                    "robust_se",
                    "ci_level")))
            self$add(jmvcore::Table$new(
                options=options,
                name="populationTotalsTable",
                title="Population-Level Estimates",
                visible="(population_totals)",
                rows=0,
                columns=list(
                    list(
                        `name`="estimate_type", 
                        `title`="Estimate", 
                        `type`="text"),
                    list(
                        `name`="total", 
                        `title`="Population Total", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="se", 
                        `title`="Standard Error", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower", 
                        `superTitle`="95% CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper", 
                        `superTitle`="95% CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cv_percent", 
                        `title`="CV (%)", 
                        `type`="number")),
                clearWith=list(
                    "population_totals",
                    "weights",
                    "subpopulation")))
            self$add(jmvcore::Table$new(
                options=options,
                name="subpopulationAnalysis",
                title="Subpopulation (Domain) Analysis",
                visible="(subpopulation)",
                rows=0,
                columns=list(
                    list(
                        `name`="domain", 
                        `title`="Subpopulation", 
                        `type`="text"),
                    list(
                        `name`="n_effective", 
                        `title`="Effective N", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="event_rate", 
                        `title`="Event Rate", 
                        `type`="number", 
                        `format`="proportion"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower", 
                        `superTitle`="95% CI", 
                        `type`="number", 
                        `format`="proportion"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper", 
                        `superTitle`="95% CI", 
                        `type`="number", 
                        `format`="proportion")),
                clearWith=list(
                    "subpopulation",
                    "weights",
                    "outcome")))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelFitStatistics",
                title="Survey-Weighted Model Fit Statistics",
                visible="(cox_weighted)",
                rows=0,
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p_value", 
                        `title`="P-value", 
                        `type`="number", 
                        `format`="zto,pvalue")),
                clearWith=list(
                    "cox_weighted",
                    "explanatory",
                    "contexpl")))
            self$add(jmvcore::Html$new(
                options=options,
                name="designEffectsSummary",
                title="Design Effects Summary",
                visible="(design_summary)",
                clearWith=list(
                    "weights",
                    "strata",
                    "cluster",
                    "design_type")))
            self$add(jmvcore::Html$new(
                options=options,
                name="analysisSummary",
                title="Analysis Summary",
                visible="(showSummaries)",
                clearWith=list(
                    "km_weighted",
                    "cox_weighted",
                    "population_totals",
                    "design_type")))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Survey-Weighted Survival Methods",
                visible="(showExplanations)",
                clearWith=list(
                    "km_weighted",
                    "cox_weighted",
                    "design_type",
                    "robust_se")))
            self$add(jmvcore::Html$new(
                options=options,
                name="surveyDesignExplanation",
                title="Understanding Survey Design in Survival Analysis",
                visible="(showExplanations)",
                clearWith=list(
                    "design_type",
                    "weights",
                    "strata",
                    "cluster")))
            self$add(jmvcore::Html$new(
                options=options,
                name="kmWeightedExplanation",
                title="Understanding Survey-Weighted Kaplan-Meier Estimation",
                visible="(km_weighted && showExplanations)",
                clearWith=list(
                    "km_weighted",
                    "weights",
                    "outcome")))
            self$add(jmvcore::Html$new(
                options=options,
                name="coxWeightedExplanation",
                title="Understanding Survey-Weighted Cox Regression",
                visible="(cox_weighted && showExplanations)",
                clearWith=list(
                    "cox_weighted",
                    "robust_se",
                    "explanatory")))
            self$add(jmvcore::Html$new(
                options=options,
                name="populationInferenceExplanation",
                title="Understanding Population-Level Inference",
                visible="(population_totals && showExplanations)",
                clearWith=list(
                    "population_totals",
                    "weights",
                    "design_type")))
            self$add(jmvcore::Output$new(
                options=options,
                name="calculatedtime",
                title="Add Calculated Time to Data",
                varTitle="`Calculated Time in Survey Survival Function - from ${ dxdate } to { fudate }`",
                varDescription="Calculated Time from given Dates in Survey-Weighted Survival Analysis",
                clearWith=list(
                    "tint",
                    "dxdate",
                    "fudate")))
            self$add(jmvcore::Output$new(
                options=options,
                name="outcomeredefined",
                title="Add Redefined Outcome to Data",
                varTitle="`Redefined Outcome in Survey Survival Function - from ${ outcome }`",
                varDescription="Redefined Outcome for Survey-Weighted Survival Analysis",
                clearWith=list(
                    "outcome",
                    "outcomeLevel")))}))

surveysurvivalBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "surveysurvivalBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "surveysurvival",
                version = c(0,0,1),
                options = options,
                results = surveysurvivalResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Survey-Weighted Survival Analysis
#'
#' Performs survival analysis with complex survey designs and sampling 
#' weights. This module implements survey-weighted survival methods for 
#' population-based inference from complex sampling designs including 
#' stratified, clustered, and multi-stage sampling. The analysis accounts for 
#' survey design effects on standard errors and confidence intervals, enabling 
#' proper population-level survival estimates from survey data.
#'
#' @examples
#' # Example 1: Basic survey-weighted Kaplan-Meier
#' library(survival)
#' library(survey)
#'
#' surveysurvival(
#'     data = mysurveydata,
#'     elapsedtime = "time",
#'     outcome = "status",
#'     outcomeLevel = "1",
#'     weights = "survey_weight",
#'     strata = "stratum",
#'     cluster = "psu",
#'     timetypeoutput = "months"
#' )
#'
#' # Example 2: Weighted Cox regression with complex design
#' surveysurvival(
#'     data = mysurveydata,
#'     elapsedtime = "time",
#'     outcome = "status",
#'     outcomeLevel = "1",
#'     explanatory = c("age_group", "sex"),
#'     contexpl = c("income"),
#'     weights = "survey_weight",
#'     strata = "stratum",
#'     cluster = "psu",
#'     fpc = "fpc_var",
#'     design_type = "stratified_cluster"
#' )
#'
#' # Example 3: Multi-stage survey design
#' surveysurvival(
#'     data = nhanes_data,
#'     elapsedtime = "followup_years",
#'     outcome = "death",
#'     outcomeLevel = "Dead",
#'     explanatory = c("education", "race"),
#'     weights = "wtmec2yr",
#'     strata = "sdmvstra",
#'     cluster = "sdmvpsu",
#'     design_type = "multistage",
#'     nest_clusters = TRUE
#' )
#'
#' @param data The survey dataset to be analyzed, provided as a data frame.
#'   Must contain survival variables, survey design variables (weights, strata,
#'   clusters), and any explanatory variables for analysis.
#' @param elapsedtime The numeric variable representing follow-up time until
#'   the event or last observation. Time should be in consistent units across
#'   all observations.
#' @param tint If true, survival time will be calculated from diagnosis and
#'   follow-up dates. If false, elapsedtime should be provided as a
#'   pre-calculated numeric variable.
#' @param dxdate Date of diagnosis or start of follow-up. Required if tint =
#'   true. Must match the format specified in timetypedata.
#' @param fudate Follow-up date or date of last observation. Required if tint
#'   = true. Must match the format specified in timetypedata.
#' @param timetypedata Specifies the format of date variables in the input
#'   data. Used when tint = true to parse diagnosis and follow-up dates.
#' @param timetypeoutput The units in which survival time is reported in the
#'   output.
#' @param outcome The outcome variable indicating event status (e.g., death,
#'   disease occurrence).
#' @param outcomeLevel The level of outcome considered as the event.
#' @param weights Variable containing survey sampling weights for each
#'   observation. Required for survey-weighted analysis.
#' @param strata Variable defining survey strata. Used in stratified sampling
#'   designs.
#' @param cluster Variable defining primary sampling units or clusters. Used
#'   in cluster and multi-stage sampling designs.
#' @param fpc Variable containing finite population correction factors.
#'   Optional for improved variance estimation when sampling fraction is large.
#' @param design_type Type of survey sampling design used to collect the data.
#' @param nest_clusters Whether clusters are nested within strata (TRUE) or
#'   crossed (FALSE). Relevant for stratified cluster designs.
#' @param explanatory Categorical explanatory variables for weighted Cox
#'   regression.
#' @param contexpl Continuous explanatory variables for weighted Cox
#'   regression.
#' @param km_weighted Perform survey-weighted Kaplan-Meier survival
#'   estimation.
#' @param cox_weighted Perform survey-weighted Cox proportional hazards
#'   regression.
#' @param robust_se Use robust variance estimation accounting for survey
#'   design effects.
#' @param ci_level Confidence level for confidence intervals (e.g., 0.95 for
#'   95\% CI).
#' @param population_totals Calculate population-level survival estimates and
#'   totals.
#' @param subpopulation Variable defining subpopulation for domain estimation.
#' @param km_plot Generate survey-weighted Kaplan-Meier survival plot.
#' @param endplot Maximum follow-up time to display on survival plots.
#' @param byplot Time interval for plot labels and risk tables.
#' @param ci95 Display confidence intervals on survival plots.
#' @param risktable Display number at risk below survival plots.
#' @param design_summary Display summary of survey design characteristics.
#' @param showSummaries Display natural language summaries alongside tables
#'   and plots for interpretation of survey-weighted survival results.
#' @param showExplanations Display detailed explanations of survey-weighted
#'   survival methods and interpretation guidelines.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$designSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$survivalAnalysis} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$coxAnalysis} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$populationEstimates} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$kmPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$designDiagnostics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$weightedSurvivalTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$coxCoefficients} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$populationTotalsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$subpopulationAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelFitStatistics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$designEffectsSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$analysisSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$surveyDesignExplanation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$kmWeightedExplanation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$coxWeightedExplanation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$populationInferenceExplanation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$calculatedtime} \tab \tab \tab \tab \tab an output \cr
#'   \code{results$outcomeredefined} \tab \tab \tab \tab \tab an output \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$designDiagnostics$asDF}
#'
#' \code{as.data.frame(results$designDiagnostics)}
#'
#' @export
surveysurvival <- function(
    data,
    elapsedtime = NULL,
    tint = FALSE,
    dxdate = NULL,
    fudate = NULL,
    timetypedata = "ymd",
    timetypeoutput = "months",
    outcome = NULL,
    outcomeLevel,
    weights = NULL,
    strata = NULL,
    cluster = NULL,
    fpc = NULL,
    design_type = "srs",
    nest_clusters = FALSE,
    explanatory = NULL,
    contexpl = NULL,
    km_weighted = TRUE,
    cox_weighted = FALSE,
    robust_se = TRUE,
    ci_level = 0.95,
    population_totals = FALSE,
    subpopulation = NULL,
    km_plot = TRUE,
    endplot = 60,
    byplot = 12,
    ci95 = TRUE,
    risktable = FALSE,
    design_summary = TRUE,
    showSummaries = FALSE,
    showExplanations = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("surveysurvival requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(dxdate)) dxdate <- jmvcore::resolveQuo(jmvcore::enquo(dxdate))
    if ( ! missing(fudate)) fudate <- jmvcore::resolveQuo(jmvcore::enquo(fudate))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(weights)) weights <- jmvcore::resolveQuo(jmvcore::enquo(weights))
    if ( ! missing(strata)) strata <- jmvcore::resolveQuo(jmvcore::enquo(strata))
    if ( ! missing(cluster)) cluster <- jmvcore::resolveQuo(jmvcore::enquo(cluster))
    if ( ! missing(fpc)) fpc <- jmvcore::resolveQuo(jmvcore::enquo(fpc))
    if ( ! missing(explanatory)) explanatory <- jmvcore::resolveQuo(jmvcore::enquo(explanatory))
    if ( ! missing(contexpl)) contexpl <- jmvcore::resolveQuo(jmvcore::enquo(contexpl))
    if ( ! missing(subpopulation)) subpopulation <- jmvcore::resolveQuo(jmvcore::enquo(subpopulation))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(elapsedtime), elapsedtime, NULL),
            `if`( ! missing(dxdate), dxdate, NULL),
            `if`( ! missing(fudate), fudate, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(weights), weights, NULL),
            `if`( ! missing(strata), strata, NULL),
            `if`( ! missing(cluster), cluster, NULL),
            `if`( ! missing(fpc), fpc, NULL),
            `if`( ! missing(explanatory), explanatory, NULL),
            `if`( ! missing(contexpl), contexpl, NULL),
            `if`( ! missing(subpopulation), subpopulation, NULL))

    for (v in strata) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in cluster) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in explanatory) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in subpopulation) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- surveysurvivalOptions$new(
        elapsedtime = elapsedtime,
        tint = tint,
        dxdate = dxdate,
        fudate = fudate,
        timetypedata = timetypedata,
        timetypeoutput = timetypeoutput,
        outcome = outcome,
        outcomeLevel = outcomeLevel,
        weights = weights,
        strata = strata,
        cluster = cluster,
        fpc = fpc,
        design_type = design_type,
        nest_clusters = nest_clusters,
        explanatory = explanatory,
        contexpl = contexpl,
        km_weighted = km_weighted,
        cox_weighted = cox_weighted,
        robust_se = robust_se,
        ci_level = ci_level,
        population_totals = population_totals,
        subpopulation = subpopulation,
        km_plot = km_plot,
        endplot = endplot,
        byplot = byplot,
        ci95 = ci95,
        risktable = risktable,
        design_summary = design_summary,
        showSummaries = showSummaries,
        showExplanations = showExplanations)

    analysis <- surveysurvivalClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

