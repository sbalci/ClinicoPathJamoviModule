
# This file is automatically generated, you probably don't want to edit this

smoothhazardOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "smoothhazardOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time_var = NULL,
            status_var = NULL,
            covariates = NULL,
            strata_var = NULL,
            method = "kernel",
            bandwidth = 0,
            bandwidth_method = "automatic",
            confidence_level = 0.95,
            time_grid = 50,
            boundary_correction = TRUE,
            kernel_type = "epanechnikov",
            hazard_plot = TRUE,
            cumulative_hazard_plot = FALSE,
            confidence_bands = TRUE,
            comparison_plot = FALSE,
            diagnostic_plots = FALSE,
            hazard_summary = TRUE,
            peak_analysis = FALSE,
            model_comparison = FALSE,
            export_hazard = FALSE,
            bootstrap_ci = FALSE,
            bootstrap_samples = 500, ...) {

            super$initialize(
                package="ClinicoPath",
                name="smoothhazard",
                requiresData=TRUE,
                ...)

            private$..time_var <- jmvcore::OptionVariable$new(
                "time_var",
                time_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..status_var <- jmvcore::OptionVariable$new(
                "status_var",
                status_var,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..strata_var <- jmvcore::OptionVariable$new(
                "strata_var",
                strata_var,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..method <- jmvcore::OptionList$new(
                "method",
                method,
                options=list(
                    "kernel",
                    "bspline",
                    "kernsmooth",
                    "locpoly"),
                default="kernel")
            private$..bandwidth <- jmvcore::OptionNumber$new(
                "bandwidth",
                bandwidth,
                default=0,
                min=0)
            private$..bandwidth_method <- jmvcore::OptionList$new(
                "bandwidth_method",
                bandwidth_method,
                options=list(
                    "automatic",
                    "global",
                    "local",
                    "pilot"),
                default="automatic")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.5,
                max=0.999)
            private$..time_grid <- jmvcore::OptionNumber$new(
                "time_grid",
                time_grid,
                default=50,
                min=10,
                max=200)
            private$..boundary_correction <- jmvcore::OptionBool$new(
                "boundary_correction",
                boundary_correction,
                default=TRUE)
            private$..kernel_type <- jmvcore::OptionList$new(
                "kernel_type",
                kernel_type,
                options=list(
                    "epanechnikov",
                    "biweight",
                    "rectangular",
                    "triangular",
                    "gaussian"),
                default="epanechnikov")
            private$..hazard_plot <- jmvcore::OptionBool$new(
                "hazard_plot",
                hazard_plot,
                default=TRUE)
            private$..cumulative_hazard_plot <- jmvcore::OptionBool$new(
                "cumulative_hazard_plot",
                cumulative_hazard_plot,
                default=FALSE)
            private$..confidence_bands <- jmvcore::OptionBool$new(
                "confidence_bands",
                confidence_bands,
                default=TRUE)
            private$..comparison_plot <- jmvcore::OptionBool$new(
                "comparison_plot",
                comparison_plot,
                default=FALSE)
            private$..diagnostic_plots <- jmvcore::OptionBool$new(
                "diagnostic_plots",
                diagnostic_plots,
                default=FALSE)
            private$..hazard_summary <- jmvcore::OptionBool$new(
                "hazard_summary",
                hazard_summary,
                default=TRUE)
            private$..peak_analysis <- jmvcore::OptionBool$new(
                "peak_analysis",
                peak_analysis,
                default=FALSE)
            private$..model_comparison <- jmvcore::OptionBool$new(
                "model_comparison",
                model_comparison,
                default=FALSE)
            private$..export_hazard <- jmvcore::OptionBool$new(
                "export_hazard",
                export_hazard,
                default=FALSE)
            private$..bootstrap_ci <- jmvcore::OptionBool$new(
                "bootstrap_ci",
                bootstrap_ci,
                default=FALSE)
            private$..bootstrap_samples <- jmvcore::OptionNumber$new(
                "bootstrap_samples",
                bootstrap_samples,
                default=500,
                min=100,
                max=2000)

            self$.addOption(private$..time_var)
            self$.addOption(private$..status_var)
            self$.addOption(private$..covariates)
            self$.addOption(private$..strata_var)
            self$.addOption(private$..method)
            self$.addOption(private$..bandwidth)
            self$.addOption(private$..bandwidth_method)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..time_grid)
            self$.addOption(private$..boundary_correction)
            self$.addOption(private$..kernel_type)
            self$.addOption(private$..hazard_plot)
            self$.addOption(private$..cumulative_hazard_plot)
            self$.addOption(private$..confidence_bands)
            self$.addOption(private$..comparison_plot)
            self$.addOption(private$..diagnostic_plots)
            self$.addOption(private$..hazard_summary)
            self$.addOption(private$..peak_analysis)
            self$.addOption(private$..model_comparison)
            self$.addOption(private$..export_hazard)
            self$.addOption(private$..bootstrap_ci)
            self$.addOption(private$..bootstrap_samples)
        }),
    active = list(
        time_var = function() private$..time_var$value,
        status_var = function() private$..status_var$value,
        covariates = function() private$..covariates$value,
        strata_var = function() private$..strata_var$value,
        method = function() private$..method$value,
        bandwidth = function() private$..bandwidth$value,
        bandwidth_method = function() private$..bandwidth_method$value,
        confidence_level = function() private$..confidence_level$value,
        time_grid = function() private$..time_grid$value,
        boundary_correction = function() private$..boundary_correction$value,
        kernel_type = function() private$..kernel_type$value,
        hazard_plot = function() private$..hazard_plot$value,
        cumulative_hazard_plot = function() private$..cumulative_hazard_plot$value,
        confidence_bands = function() private$..confidence_bands$value,
        comparison_plot = function() private$..comparison_plot$value,
        diagnostic_plots = function() private$..diagnostic_plots$value,
        hazard_summary = function() private$..hazard_summary$value,
        peak_analysis = function() private$..peak_analysis$value,
        model_comparison = function() private$..model_comparison$value,
        export_hazard = function() private$..export_hazard$value,
        bootstrap_ci = function() private$..bootstrap_ci$value,
        bootstrap_samples = function() private$..bootstrap_samples$value),
    private = list(
        ..time_var = NA,
        ..status_var = NA,
        ..covariates = NA,
        ..strata_var = NA,
        ..method = NA,
        ..bandwidth = NA,
        ..bandwidth_method = NA,
        ..confidence_level = NA,
        ..time_grid = NA,
        ..boundary_correction = NA,
        ..kernel_type = NA,
        ..hazard_plot = NA,
        ..cumulative_hazard_plot = NA,
        ..confidence_bands = NA,
        ..comparison_plot = NA,
        ..diagnostic_plots = NA,
        ..hazard_summary = NA,
        ..peak_analysis = NA,
        ..model_comparison = NA,
        ..export_hazard = NA,
        ..bootstrap_ci = NA,
        ..bootstrap_samples = NA)
)

smoothhazardResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "smoothhazardResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        data_summary = function() private$.items[["data_summary"]],
        hazard_estimates = function() private$.items[["hazard_estimates"]],
        hazard_summary = function() private$.items[["hazard_summary"]],
        bandwidth_selection = function() private$.items[["bandwidth_selection"]],
        hazard_plot = function() private$.items[["hazard_plot"]],
        cumulative_hazard_plot = function() private$.items[["cumulative_hazard_plot"]],
        comparison_plot = function() private$.items[["comparison_plot"]],
        diagnostic_plots = function() private$.items[["diagnostic_plots"]],
        peak_analysis = function() private$.items[["peak_analysis"]],
        model_comparison = function() private$.items[["model_comparison"]],
        bootstrap_results = function() private$.items[["bootstrap_results"]],
        hazard_export = function() private$.items[["hazard_export"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Smooth Hazard Estimation & Analysis",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Smooth Hazard Analysis Instructions"))
            self$add(jmvcore::Html$new(
                options=options,
                name="data_summary",
                title="Data Summary"))
            self$add(jmvcore::Table$new(
                options=options,
                name="hazard_estimates",
                title="Hazard Function Estimates",
                clearWith=list(
                    "time_var",
                    "status_var",
                    "method",
                    "bandwidth",
                    "time_grid",
                    "covariates",
                    "strata_var"),
                columns=list(
                    list(
                        `name`="time", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="hazard", 
                        `title`="Hazard Rate", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="cumulative_hazard", 
                        `title`="Cumulative Hazard", 
                        `type`="number"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="hazard_summary",
                title="Hazard Function Summary",
                clearWith=list(
                    "time_var",
                    "status_var",
                    "method",
                    "bandwidth",
                    "hazard_summary")))
            self$add(jmvcore::Html$new(
                options=options,
                name="bandwidth_selection",
                title="Bandwidth Selection Results",
                clearWith=list(
                    "time_var",
                    "status_var",
                    "method",
                    "bandwidth_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="hazard_plot",
                title="Hazard Function Plot",
                width=600,
                height=450,
                clearWith=list(
                    "time_var",
                    "status_var",
                    "method",
                    "bandwidth",
                    "kernel_type",
                    "confidence_bands",
                    "strata_var")))
            self$add(jmvcore::Image$new(
                options=options,
                name="cumulative_hazard_plot",
                title="Cumulative Hazard Plot",
                width=600,
                height=450,
                clearWith=list(
                    "time_var",
                    "status_var",
                    "method",
                    "bandwidth",
                    "cumulative_hazard_plot")))
            self$add(jmvcore::Image$new(
                options=options,
                name="comparison_plot",
                title="Method Comparison Plot",
                width=600,
                height=450,
                clearWith=list(
                    "time_var",
                    "status_var",
                    "comparison_plot",
                    "bandwidth")))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagnostic_plots",
                title="Diagnostic Plots",
                width=600,
                height=450,
                clearWith=list(
                    "time_var",
                    "status_var",
                    "method",
                    "diagnostic_plots")))
            self$add(jmvcore::Html$new(
                options=options,
                name="peak_analysis",
                title="Hazard Peak Analysis",
                clearWith=list(
                    "time_var",
                    "status_var",
                    "method",
                    "bandwidth",
                    "peak_analysis")))
            self$add(jmvcore::Html$new(
                options=options,
                name="model_comparison",
                title="Model Comparison Results",
                clearWith=list(
                    "time_var",
                    "status_var",
                    "method",
                    "model_comparison")))
            self$add(jmvcore::Html$new(
                options=options,
                name="bootstrap_results",
                title="Bootstrap Results",
                clearWith=list(
                    "time_var",
                    "status_var",
                    "method",
                    "bootstrap_ci",
                    "bootstrap_samples")))
            self$add(jmvcore::Table$new(
                options=options,
                name="hazard_export",
                title="Exported Hazard Estimates",
                clearWith=list(
                    "time_var",
                    "status_var",
                    "method",
                    "export_hazard",
                    "time_grid"),
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="number"),
                    list(
                        `name`="hazard_estimate", 
                        `title`="Hazard Estimate", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="cumulative_hazard", 
                        `title`="Cumulative Hazard", 
                        `type`="number"),
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"),
                    list(
                        `name`="bandwidth", 
                        `title`="Bandwidth", 
                        `type`="number"))))}))

smoothhazardBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "smoothhazardBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "smoothhazard",
                version = c(1,0,0),
                options = options,
                results = smoothhazardResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Smooth Hazard Estimation & Analysis
#'
#' 
#' @param data the data as a data frame
#' @param time_var Time to event or censoring variable
#' @param status_var Event status variable (1=event, 0=censored)
#' @param covariates Covariates for stratified hazard estimation
#' @param strata_var Variable for stratified analysis
#' @param method Method for hazard function smoothing
#' @param bandwidth Bandwidth parameter for smoothing (0 = automatic
#'   selection)
#' @param bandwidth_method Method for bandwidth selection
#' @param confidence_level Confidence level for confidence intervals
#' @param time_grid Number of time points for hazard estimation
#' @param boundary_correction Apply boundary correction for hazard estimation
#' @param kernel_type Kernel function for smoothing
#' @param hazard_plot Generate hazard function plot
#' @param cumulative_hazard_plot Generate cumulative hazard function plot
#' @param confidence_bands Include confidence bands in plots
#' @param comparison_plot Compare different smoothing methods
#' @param diagnostic_plots Generate diagnostic plots for bandwidth selection
#' @param hazard_summary Summary statistics for estimated hazard function
#' @param peak_analysis Identify and analyze hazard function peaks
#' @param model_comparison Compare with parametric models
#' @param export_hazard Export hazard function estimates to results
#' @param bootstrap_ci Use bootstrap for confidence interval estimation
#' @param bootstrap_samples Number of bootstrap samples for confidence
#'   intervals
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab Instructions and guidance for smooth hazard estimation \cr
#'   \code{results$data_summary} \tab \tab \tab \tab \tab Summary of input data and analysis parameters \cr
#'   \code{results$hazard_estimates} \tab \tab \tab \tab \tab Estimated hazard function values at specified time points \cr
#'   \code{results$hazard_summary} \tab \tab \tab \tab \tab Summary statistics for the estimated hazard function \cr
#'   \code{results$bandwidth_selection} \tab \tab \tab \tab \tab Results from bandwidth selection procedure \cr
#'   \code{results$hazard_plot} \tab \tab \tab \tab \tab Plot of the estimated hazard function over time \cr
#'   \code{results$cumulative_hazard_plot} \tab \tab \tab \tab \tab Plot of the estimated cumulative hazard function \cr
#'   \code{results$comparison_plot} \tab \tab \tab \tab \tab Comparison of different smoothing methods \cr
#'   \code{results$diagnostic_plots} \tab \tab \tab \tab \tab Diagnostic plots for bandwidth selection \cr
#'   \code{results$peak_analysis} \tab \tab \tab \tab \tab Analysis of hazard function peaks and inflection points \cr
#'   \code{results$model_comparison} \tab \tab \tab \tab \tab Comparison with parametric survival models \cr
#'   \code{results$bootstrap_results} \tab \tab \tab \tab \tab Bootstrap confidence interval results \cr
#'   \code{results$hazard_export} \tab \tab \tab \tab \tab Detailed hazard function estimates for export \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$hazard_estimates$asDF}
#'
#' \code{as.data.frame(results$hazard_estimates)}
#'
#' @export
smoothhazard <- function(
    data,
    time_var,
    status_var,
    covariates,
    strata_var,
    method = "kernel",
    bandwidth = 0,
    bandwidth_method = "automatic",
    confidence_level = 0.95,
    time_grid = 50,
    boundary_correction = TRUE,
    kernel_type = "epanechnikov",
    hazard_plot = TRUE,
    cumulative_hazard_plot = FALSE,
    confidence_bands = TRUE,
    comparison_plot = FALSE,
    diagnostic_plots = FALSE,
    hazard_summary = TRUE,
    peak_analysis = FALSE,
    model_comparison = FALSE,
    export_hazard = FALSE,
    bootstrap_ci = FALSE,
    bootstrap_samples = 500) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("smoothhazard requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time_var)) time_var <- jmvcore::resolveQuo(jmvcore::enquo(time_var))
    if ( ! missing(status_var)) status_var <- jmvcore::resolveQuo(jmvcore::enquo(status_var))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(strata_var)) strata_var <- jmvcore::resolveQuo(jmvcore::enquo(strata_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time_var), time_var, NULL),
            `if`( ! missing(status_var), status_var, NULL),
            `if`( ! missing(covariates), covariates, NULL),
            `if`( ! missing(strata_var), strata_var, NULL))

    for (v in strata_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- smoothhazardOptions$new(
        time_var = time_var,
        status_var = status_var,
        covariates = covariates,
        strata_var = strata_var,
        method = method,
        bandwidth = bandwidth,
        bandwidth_method = bandwidth_method,
        confidence_level = confidence_level,
        time_grid = time_grid,
        boundary_correction = boundary_correction,
        kernel_type = kernel_type,
        hazard_plot = hazard_plot,
        cumulative_hazard_plot = cumulative_hazard_plot,
        confidence_bands = confidence_bands,
        comparison_plot = comparison_plot,
        diagnostic_plots = diagnostic_plots,
        hazard_summary = hazard_summary,
        peak_analysis = peak_analysis,
        model_comparison = model_comparison,
        export_hazard = export_hazard,
        bootstrap_ci = bootstrap_ci,
        bootstrap_samples = bootstrap_samples)

    analysis <- smoothhazardClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

