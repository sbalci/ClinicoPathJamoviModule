
# This file is automatically generated, you probably don't want to edit this

variablebiplotOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "variablebiplotOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            groupVar = NULL,
            features = NULL,
            method = "pca",
            showLoadings = FALSE,
            loadingScale = 1.5,
            topContributors = 10,
            pc1 = 1,
            pc2 = 2,
            showContribTable = FALSE,
            showVarianceExplained = FALSE,
            contributionMetric = "squared",
            showSeparation = FALSE,
            separationMetric = "silhouette",
            showConfidenceEllipse = FALSE,
            pointSize = 3,
            labelPoints = "none",
            centerScale = FALSE,
            minVariance = 70,
            biplotType = "covariance",
            showSummary = FALSE,
            showReport = FALSE,
            showInterpretation = FALSE,
            showRCode = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="variablebiplot",
                requiresData=TRUE,
                ...)

            private$..groupVar <- jmvcore::OptionVariable$new(
                "groupVar",
                groupVar,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..features <- jmvcore::OptionVariables$new(
                "features",
                features,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..method <- jmvcore::OptionList$new(
                "method",
                method,
                options=list(
                    "pca",
                    "plsda",
                    "lda"),
                default="pca")
            private$..showLoadings <- jmvcore::OptionBool$new(
                "showLoadings",
                showLoadings,
                default=FALSE)
            private$..loadingScale <- jmvcore::OptionNumber$new(
                "loadingScale",
                loadingScale,
                default=1.5,
                min=0.5,
                max=5)
            private$..topContributors <- jmvcore::OptionInteger$new(
                "topContributors",
                topContributors,
                default=10,
                min=0,
                max=50)
            private$..pc1 <- jmvcore::OptionInteger$new(
                "pc1",
                pc1,
                default=1,
                min=1,
                max=20)
            private$..pc2 <- jmvcore::OptionInteger$new(
                "pc2",
                pc2,
                default=2,
                min=1,
                max=20)
            private$..showContribTable <- jmvcore::OptionBool$new(
                "showContribTable",
                showContribTable,
                default=FALSE)
            private$..showVarianceExplained <- jmvcore::OptionBool$new(
                "showVarianceExplained",
                showVarianceExplained,
                default=FALSE)
            private$..contributionMetric <- jmvcore::OptionList$new(
                "contributionMetric",
                contributionMetric,
                options=list(
                    "loading",
                    "squared",
                    "correlation"),
                default="squared")
            private$..showSeparation <- jmvcore::OptionBool$new(
                "showSeparation",
                showSeparation,
                default=FALSE)
            private$..separationMetric <- jmvcore::OptionList$new(
                "separationMetric",
                separationMetric,
                options=list(
                    "silhouette",
                    "bw_ratio",
                    "mahalanobis"),
                default="silhouette")
            private$..showConfidenceEllipse <- jmvcore::OptionBool$new(
                "showConfidenceEllipse",
                showConfidenceEllipse,
                default=FALSE)
            private$..pointSize <- jmvcore::OptionNumber$new(
                "pointSize",
                pointSize,
                default=3,
                min=1,
                max=10)
            private$..labelPoints <- jmvcore::OptionList$new(
                "labelPoints",
                labelPoints,
                options=list(
                    "none",
                    "rownum",
                    "rowname"),
                default="none")
            private$..centerScale <- jmvcore::OptionBool$new(
                "centerScale",
                centerScale,
                default=FALSE)
            private$..minVariance <- jmvcore::OptionNumber$new(
                "minVariance",
                minVariance,
                default=70,
                min=50,
                max=99)
            private$..biplotType <- jmvcore::OptionList$new(
                "biplotType",
                biplotType,
                options=list(
                    "covariance",
                    "correlation"),
                default="covariance")
            private$..showSummary <- jmvcore::OptionBool$new(
                "showSummary",
                showSummary,
                default=FALSE)
            private$..showReport <- jmvcore::OptionBool$new(
                "showReport",
                showReport,
                default=FALSE)
            private$..showInterpretation <- jmvcore::OptionBool$new(
                "showInterpretation",
                showInterpretation,
                default=FALSE)
            private$..showRCode <- jmvcore::OptionBool$new(
                "showRCode",
                showRCode,
                default=FALSE)

            self$.addOption(private$..groupVar)
            self$.addOption(private$..features)
            self$.addOption(private$..method)
            self$.addOption(private$..showLoadings)
            self$.addOption(private$..loadingScale)
            self$.addOption(private$..topContributors)
            self$.addOption(private$..pc1)
            self$.addOption(private$..pc2)
            self$.addOption(private$..showContribTable)
            self$.addOption(private$..showVarianceExplained)
            self$.addOption(private$..contributionMetric)
            self$.addOption(private$..showSeparation)
            self$.addOption(private$..separationMetric)
            self$.addOption(private$..showConfidenceEllipse)
            self$.addOption(private$..pointSize)
            self$.addOption(private$..labelPoints)
            self$.addOption(private$..centerScale)
            self$.addOption(private$..minVariance)
            self$.addOption(private$..biplotType)
            self$.addOption(private$..showSummary)
            self$.addOption(private$..showReport)
            self$.addOption(private$..showInterpretation)
            self$.addOption(private$..showRCode)
        }),
    active = list(
        groupVar = function() private$..groupVar$value,
        features = function() private$..features$value,
        method = function() private$..method$value,
        showLoadings = function() private$..showLoadings$value,
        loadingScale = function() private$..loadingScale$value,
        topContributors = function() private$..topContributors$value,
        pc1 = function() private$..pc1$value,
        pc2 = function() private$..pc2$value,
        showContribTable = function() private$..showContribTable$value,
        showVarianceExplained = function() private$..showVarianceExplained$value,
        contributionMetric = function() private$..contributionMetric$value,
        showSeparation = function() private$..showSeparation$value,
        separationMetric = function() private$..separationMetric$value,
        showConfidenceEllipse = function() private$..showConfidenceEllipse$value,
        pointSize = function() private$..pointSize$value,
        labelPoints = function() private$..labelPoints$value,
        centerScale = function() private$..centerScale$value,
        minVariance = function() private$..minVariance$value,
        biplotType = function() private$..biplotType$value,
        showSummary = function() private$..showSummary$value,
        showReport = function() private$..showReport$value,
        showInterpretation = function() private$..showInterpretation$value,
        showRCode = function() private$..showRCode$value),
    private = list(
        ..groupVar = NA,
        ..features = NA,
        ..method = NA,
        ..showLoadings = NA,
        ..loadingScale = NA,
        ..topContributors = NA,
        ..pc1 = NA,
        ..pc2 = NA,
        ..showContribTable = NA,
        ..showVarianceExplained = NA,
        ..contributionMetric = NA,
        ..showSeparation = NA,
        ..separationMetric = NA,
        ..showConfidenceEllipse = NA,
        ..pointSize = NA,
        ..labelPoints = NA,
        ..centerScale = NA,
        ..minVariance = NA,
        ..biplotType = NA,
        ..showSummary = NA,
        ..showReport = NA,
        ..showInterpretation = NA,
        ..showRCode = NA)
)

variablebiplotResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "variablebiplotResults",
    inherit = jmvcore::Group,
    active = list(
        about = function() private$.items[["about"]],
        todo = function() private$.items[["todo"]],
        assumptions = function() private$.items[["assumptions"]],
        summary = function() private$.items[["summary"]],
        interpretation = function() private$.items[["interpretation"]],
        report = function() private$.items[["report"]],
        componentVariance = function() private$.items[["componentVariance"]],
        contributionTable = function() private$.items[["contributionTable"]],
        separationAnalysis = function() private$.items[["separationAnalysis"]],
        biplot = function() private$.items[["biplot"]],
        contributionInterpretation = function() private$.items[["contributionInterpretation"]],
        rCode = function() private$.items[["rCode"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Variable Importance Biplot",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "FactoMineR",
                    "factoextra",
                    "ggplot2"))
            self$add(jmvcore::Html$new(
                options=options,
                name="about",
                title="About This Analysis",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis Setup",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="assumptions",
                title="Assumptions & Warnings",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="summary",
                title="Summary",
                visible="(showSummary)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="How to Read This Biplot",
                visible="(showInterpretation)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="report",
                title="Copy-Ready Report",
                visible="(showReport)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="componentVariance",
                title="Component Variance Explained",
                visible="(showVarianceExplained)",
                rows=0,
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="eigenvalue", 
                        `title`="Eigenvalue", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="variance", 
                        `title`="% Variance", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cumulative", 
                        `title`="% Cumulative", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="contributionTable",
                title="Variable Contributions",
                visible="(showContribTable)",
                rows=0,
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="pc1_contrib", 
                        `title`="PC1 Contrib", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="pc2_contrib", 
                        `title`="PC2 Contrib", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="total_contrib", 
                        `title`="Total Contrib", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="quality", 
                        `title`="Quality (Cos\u00B2)", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="separationAnalysis",
                title="Group Separation Analysis",
                visible="(showSeparation)",
                rows=0,
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="biplot",
                title="Variable Importance Biplot",
                width=800,
                height=700,
                renderFun=".biplot",
                requiresData=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="contributionInterpretation",
                title="Clinical Interpretation",
                visible="(showContribTable)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="rCode",
                title="Reproducible R Code",
                visible="(showRCode)"))}))

variablebiplotBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "variablebiplotBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "variablebiplot",
                version = c(0,0,31),
                options = options,
                results = variablebiplotResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Variable Importance Biplot
#'
#' Create biplots showing variable contributions to group separation using 
#' PCA, PLS-DA, or LDA. Displays patients as points and variables as vectors, 
#' with vector length indicating contribution strength. Inspired by Orange 
#' Data Mining's contribution analysis, adapted for clinical research with 
#' comprehensive variable importance metrics.
#'
#' @examples
#' # Example: PCA biplot for tumor staging
#' variablebiplot(
#'     data = clinical_data,
#'     groupVar = "stage",
#'     features = c("age", "ki67", "grade", "size"),
#'     method = "pca",
#'     showLoadings = TRUE,
#'     topContributors = 10
#' )
#'
#' @param data .
#' @param groupVar .
#' @param features .
#' @param method .
#' @param showLoadings .
#' @param loadingScale .
#' @param topContributors .
#' @param pc1 .
#' @param pc2 .
#' @param showContribTable .
#' @param showVarianceExplained .
#' @param contributionMetric .
#' @param showSeparation .
#' @param separationMetric .
#' @param showConfidenceEllipse .
#' @param pointSize .
#' @param labelPoints .
#' @param centerScale .
#' @param minVariance .
#' @param biplotType .
#' @param showSummary Display a plain-language summary paragraph with key
#'   findings and clinical interpretation. Useful for understanding results and
#'   creating reports.
#' @param showReport Generate a copy-ready paragraph with all statistics
#'   filled in, suitable for pasting into manuscripts or clinical reports.
#' @param showInterpretation Display guidance on how to read and interpret the
#'   biplot, including what arrows, points, and distances represent.
#' @param showRCode Generate copy-ready R code using upstream packages (stats,
#'   mixOmics, MASS) instead of jamovi wrappers. Useful for reproducing analysis
#'   in R scripts, learning the underlying implementation, and sharing code with
#'   non-jamovi users.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$about} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$assumptions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$report} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$componentVariance} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$contributionTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$separationAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$biplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$contributionInterpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$rCode} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$componentVariance$asDF}
#'
#' \code{as.data.frame(results$componentVariance)}
#'
#' @export
variablebiplot <- function(
    data,
    groupVar = NULL,
    features = NULL,
    method = "pca",
    showLoadings = FALSE,
    loadingScale = 1.5,
    topContributors = 10,
    pc1 = 1,
    pc2 = 2,
    showContribTable = FALSE,
    showVarianceExplained = FALSE,
    contributionMetric = "squared",
    showSeparation = FALSE,
    separationMetric = "silhouette",
    showConfidenceEllipse = FALSE,
    pointSize = 3,
    labelPoints = "none",
    centerScale = FALSE,
    minVariance = 70,
    biplotType = "covariance",
    showSummary = FALSE,
    showReport = FALSE,
    showInterpretation = FALSE,
    showRCode = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("variablebiplot requires jmvcore to be installed (restart may be required)")

    if ( ! missing(groupVar)) groupVar <- jmvcore::resolveQuo(jmvcore::enquo(groupVar))
    if ( ! missing(features)) features <- jmvcore::resolveQuo(jmvcore::enquo(features))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(groupVar), groupVar, NULL),
            `if`( ! missing(features), features, NULL))

    for (v in groupVar) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- variablebiplotOptions$new(
        groupVar = groupVar,
        features = features,
        method = method,
        showLoadings = showLoadings,
        loadingScale = loadingScale,
        topContributors = topContributors,
        pc1 = pc1,
        pc2 = pc2,
        showContribTable = showContribTable,
        showVarianceExplained = showVarianceExplained,
        contributionMetric = contributionMetric,
        showSeparation = showSeparation,
        separationMetric = separationMetric,
        showConfidenceEllipse = showConfidenceEllipse,
        pointSize = pointSize,
        labelPoints = labelPoints,
        centerScale = centerScale,
        minVariance = minVariance,
        biplotType = biplotType,
        showSummary = showSummary,
        showReport = showReport,
        showInterpretation = showInterpretation,
        showRCode = showRCode)

    analysis <- variablebiplotClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

