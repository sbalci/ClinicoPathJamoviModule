
# This file is automatically generated, you probably don't want to edit this

dynamiccoeffOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "dynamiccoeffOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            outcome = NULL,
            covariates = NULL,
            dynamic_covariates = NULL,
            outcomeLevel = "1",
            updating_method = "kalman",
            state_dimension = 2,
            process_variance = 0.1,
            observation_variance = 0.1,
            forgetting_factor = 0.99,
            burn_in_period = 10,
            confidence_level = 0.95,
            smoothing_parameter = 0.2,
            adaptation_rate = 0.1,
            show_model_summary = TRUE,
            show_coefficient_paths = TRUE,
            show_state_evolution = TRUE,
            show_adaptation_metrics = TRUE,
            show_dynamic_plots = TRUE,
            show_state_plots = TRUE,
            show_diagnostic_plots = TRUE,
            show_comparison_plots = TRUE,
            showSummaries = FALSE,
            showExplanations = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="dynamiccoeff",
                requiresData=TRUE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..dynamic_covariates <- jmvcore::OptionVariables$new(
                "dynamic_covariates",
                dynamic_covariates,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..outcomeLevel <- jmvcore::OptionString$new(
                "outcomeLevel",
                outcomeLevel,
                default="1")
            private$..updating_method <- jmvcore::OptionList$new(
                "updating_method",
                updating_method,
                options=list(
                    "kalman",
                    "particle",
                    "bayesian",
                    "recursive"),
                default="kalman")
            private$..state_dimension <- jmvcore::OptionNumber$new(
                "state_dimension",
                state_dimension,
                min=1,
                max=10,
                default=2)
            private$..process_variance <- jmvcore::OptionNumber$new(
                "process_variance",
                process_variance,
                min=0.01,
                max=2,
                default=0.1)
            private$..observation_variance <- jmvcore::OptionNumber$new(
                "observation_variance",
                observation_variance,
                min=0.01,
                max=2,
                default=0.1)
            private$..forgetting_factor <- jmvcore::OptionNumber$new(
                "forgetting_factor",
                forgetting_factor,
                min=0.5,
                max=1,
                default=0.99)
            private$..burn_in_period <- jmvcore::OptionNumber$new(
                "burn_in_period",
                burn_in_period,
                min=0,
                max=100,
                default=10)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..smoothing_parameter <- jmvcore::OptionNumber$new(
                "smoothing_parameter",
                smoothing_parameter,
                min=0.01,
                max=1,
                default=0.2)
            private$..adaptation_rate <- jmvcore::OptionNumber$new(
                "adaptation_rate",
                adaptation_rate,
                min=0.01,
                max=0.5,
                default=0.1)
            private$..show_model_summary <- jmvcore::OptionBool$new(
                "show_model_summary",
                show_model_summary,
                default=TRUE)
            private$..show_coefficient_paths <- jmvcore::OptionBool$new(
                "show_coefficient_paths",
                show_coefficient_paths,
                default=TRUE)
            private$..show_state_evolution <- jmvcore::OptionBool$new(
                "show_state_evolution",
                show_state_evolution,
                default=TRUE)
            private$..show_adaptation_metrics <- jmvcore::OptionBool$new(
                "show_adaptation_metrics",
                show_adaptation_metrics,
                default=TRUE)
            private$..show_dynamic_plots <- jmvcore::OptionBool$new(
                "show_dynamic_plots",
                show_dynamic_plots,
                default=TRUE)
            private$..show_state_plots <- jmvcore::OptionBool$new(
                "show_state_plots",
                show_state_plots,
                default=TRUE)
            private$..show_diagnostic_plots <- jmvcore::OptionBool$new(
                "show_diagnostic_plots",
                show_diagnostic_plots,
                default=TRUE)
            private$..show_comparison_plots <- jmvcore::OptionBool$new(
                "show_comparison_plots",
                show_comparison_plots,
                default=TRUE)
            private$..showSummaries <- jmvcore::OptionBool$new(
                "showSummaries",
                showSummaries,
                default=FALSE)
            private$..showExplanations <- jmvcore::OptionBool$new(
                "showExplanations",
                showExplanations,
                default=FALSE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..outcome)
            self$.addOption(private$..covariates)
            self$.addOption(private$..dynamic_covariates)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..updating_method)
            self$.addOption(private$..state_dimension)
            self$.addOption(private$..process_variance)
            self$.addOption(private$..observation_variance)
            self$.addOption(private$..forgetting_factor)
            self$.addOption(private$..burn_in_period)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..smoothing_parameter)
            self$.addOption(private$..adaptation_rate)
            self$.addOption(private$..show_model_summary)
            self$.addOption(private$..show_coefficient_paths)
            self$.addOption(private$..show_state_evolution)
            self$.addOption(private$..show_adaptation_metrics)
            self$.addOption(private$..show_dynamic_plots)
            self$.addOption(private$..show_state_plots)
            self$.addOption(private$..show_diagnostic_plots)
            self$.addOption(private$..show_comparison_plots)
            self$.addOption(private$..showSummaries)
            self$.addOption(private$..showExplanations)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        outcome = function() private$..outcome$value,
        covariates = function() private$..covariates$value,
        dynamic_covariates = function() private$..dynamic_covariates$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        updating_method = function() private$..updating_method$value,
        state_dimension = function() private$..state_dimension$value,
        process_variance = function() private$..process_variance$value,
        observation_variance = function() private$..observation_variance$value,
        forgetting_factor = function() private$..forgetting_factor$value,
        burn_in_period = function() private$..burn_in_period$value,
        confidence_level = function() private$..confidence_level$value,
        smoothing_parameter = function() private$..smoothing_parameter$value,
        adaptation_rate = function() private$..adaptation_rate$value,
        show_model_summary = function() private$..show_model_summary$value,
        show_coefficient_paths = function() private$..show_coefficient_paths$value,
        show_state_evolution = function() private$..show_state_evolution$value,
        show_adaptation_metrics = function() private$..show_adaptation_metrics$value,
        show_dynamic_plots = function() private$..show_dynamic_plots$value,
        show_state_plots = function() private$..show_state_plots$value,
        show_diagnostic_plots = function() private$..show_diagnostic_plots$value,
        show_comparison_plots = function() private$..show_comparison_plots$value,
        showSummaries = function() private$..showSummaries$value,
        showExplanations = function() private$..showExplanations$value),
    private = list(
        ..elapsedtime = NA,
        ..outcome = NA,
        ..covariates = NA,
        ..dynamic_covariates = NA,
        ..outcomeLevel = NA,
        ..updating_method = NA,
        ..state_dimension = NA,
        ..process_variance = NA,
        ..observation_variance = NA,
        ..forgetting_factor = NA,
        ..burn_in_period = NA,
        ..confidence_level = NA,
        ..smoothing_parameter = NA,
        ..adaptation_rate = NA,
        ..show_model_summary = NA,
        ..show_coefficient_paths = NA,
        ..show_state_evolution = NA,
        ..show_adaptation_metrics = NA,
        ..show_dynamic_plots = NA,
        ..show_state_plots = NA,
        ..show_diagnostic_plots = NA,
        ..show_comparison_plots = NA,
        ..showSummaries = NA,
        ..showExplanations = NA)
)

dynamiccoeffResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "dynamiccoeffResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        modelSummary = function() private$.items[["modelSummary"]],
        coefficientPaths = function() private$.items[["coefficientPaths"]],
        stateEvolution = function() private$.items[["stateEvolution"]],
        adaptationMetrics = function() private$.items[["adaptationMetrics"]],
        modelComparison = function() private$.items[["modelComparison"]],
        convergenceMetrics = function() private$.items[["convergenceMetrics"]],
        dynamicPlots = function() private$.items[["dynamicPlots"]],
        statePlots = function() private$.items[["statePlots"]],
        diagnosticPlots = function() private$.items[["diagnosticPlots"]],
        comparisonPlots = function() private$.items[["comparisonPlots"]],
        adaptationPlots = function() private$.items[["adaptationPlots"]],
        analysisSummary = function() private$.items[["analysisSummary"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Dynamic Coefficient Models")
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                visible="(show_model_summary)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="coefficientPaths",
                title="Dynamic Coefficient Paths",
                visible="(show_coefficient_paths)",
                columns=list(
                    list(
                        `name`="covariate", 
                        `title`="Covariate", 
                        `type`="text"),
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="coefficient", 
                        `title`="\u03B2(t)", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="stateEvolution",
                title="State Space Evolution",
                visible="(show_state_evolution)",
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="state_variable", 
                        `title`="State", 
                        `type`="text"),
                    list(
                        `name`="state_value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="state_variance", 
                        `title`="Variance", 
                        `type`="number"),
                    list(
                        `name`="predicted_value", 
                        `title`="Predicted", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="adaptationMetrics",
                title="Adaptation Metrics",
                visible="(show_adaptation_metrics)",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelComparison",
                title="Model Comparison",
                visible="(show_model_summary)",
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="log_likelihood", 
                        `title`="Log-Likelihood", 
                        `type`="number"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number"),
                    list(
                        `name`="prediction_error", 
                        `title`="Prediction Error", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="convergenceMetrics",
                title="Convergence Diagnostics",
                visible="(show_adaptation_metrics)",
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="convergence_rate", 
                        `title`="Convergence Rate", 
                        `type`="number"),
                    list(
                        `name`="effective_sample", 
                        `title`="Effective Sample", 
                        `type`="number"),
                    list(
                        `name`="autocorr_function", 
                        `title`="Autocorrelation", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="dynamicPlots",
                title="Dynamic Coefficient Evolution",
                visible="(show_dynamic_plots)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="statePlots",
                title="State Space Visualization",
                visible="(show_state_plots)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagnosticPlots",
                title="Model Diagnostics",
                visible="(show_diagnostic_plots)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="comparisonPlots",
                title="Model Comparison Plots",
                visible="(show_comparison_plots)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="adaptationPlots",
                title="Adaptation Process",
                visible="(show_adaptation_metrics)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="analysisSummary",
                title="Analysis Summary",
                visible="(showSummaries)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Methodology",
                visible="(showExplanations)"))}))

dynamiccoeffBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "dynamiccoeffBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "dynamiccoeff",
                version = c(1,0,0),
                options = options,
                results = dynamiccoeffResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Dynamic Coefficient Models
#'
#' Implements dynamic coefficient models for survival data where regression 
#' coefficients evolve continuously over time through adaptive updating 
#' mechanisms. This approach provides real-time modeling of changing covariate 
#' effects using Bayesian frameworks and dynamic linear models, offering 
#' sophisticated alternatives to static coefficient approaches in survival 
#' analysis.
#'
#' @examples
#' # Example 1: Dynamic coefficient model with Bayesian updating
#' library(survival)
#' library(dlm)
#'
#' dynamiccoeff(
#'     data = veteran_data,
#'     elapsedtime = "time",
#'     outcome = "status",
#'     outcomeLevel = "1",
#'     covariates = c("age", "karno"),
#'     dynamic_covariates = c("diagtime"),
#'     updating_method = "kalman"
#' )
#'
#' @param data the data as a data frame
#' @param elapsedtime Survival time or follow-up duration variable
#' @param outcome Event indicator variable (0/1, FALSE/TRUE, or factor)
#' @param covariates Covariate variables with constant effects over time
#' @param dynamic_covariates Covariate variables with dynamically updating
#'   coefficients
#' @param outcomeLevel Level of outcome variable indicating event occurrence
#' @param updating_method Method for dynamic coefficient updating
#' @param state_dimension Dimension of the state space for dynamic modeling
#' @param process_variance Variance of the process noise in state evolution
#' @param observation_variance Variance of the observation noise
#' @param forgetting_factor Forgetting factor for exponential discounting of
#'   past observations
#' @param burn_in_period Number of initial observations for model
#'   initialization
#' @param confidence_level Confidence level for dynamic coefficient intervals
#' @param smoothing_parameter Smoothing parameter for coefficient trajectory
#'   smoothing
#' @param adaptation_rate Rate of adaptation for dynamic coefficient updates
#' @param show_model_summary Display comprehensive dynamic model summary
#' @param show_coefficient_paths Display table of dynamic coefficient
#'   trajectories
#' @param show_state_evolution Display state space evolution results
#' @param show_adaptation_metrics Display adaptation and convergence metrics
#' @param show_dynamic_plots Display plots of dynamic coefficient evolution
#' @param show_state_plots Display state space visualization plots
#' @param show_diagnostic_plots Display model diagnostic and residual plots
#' @param show_comparison_plots Display comparison with static coefficient
#'   models
#' @param showSummaries Generate natural language summaries of the analysis
#'   results
#' @param showExplanations Show detailed explanations of the methodology and
#'   interpretation
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$coefficientPaths} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$stateEvolution} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$adaptationMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$convergenceMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$dynamicPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$statePlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$diagnosticPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$comparisonPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$adaptationPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$analysisSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$coefficientPaths$asDF}
#'
#' \code{as.data.frame(results$coefficientPaths)}
#'
#' @export
dynamiccoeff <- function(
    data,
    elapsedtime,
    outcome,
    covariates,
    dynamic_covariates,
    outcomeLevel = "1",
    updating_method = "kalman",
    state_dimension = 2,
    process_variance = 0.1,
    observation_variance = 0.1,
    forgetting_factor = 0.99,
    burn_in_period = 10,
    confidence_level = 0.95,
    smoothing_parameter = 0.2,
    adaptation_rate = 0.1,
    show_model_summary = TRUE,
    show_coefficient_paths = TRUE,
    show_state_evolution = TRUE,
    show_adaptation_metrics = TRUE,
    show_dynamic_plots = TRUE,
    show_state_plots = TRUE,
    show_diagnostic_plots = TRUE,
    show_comparison_plots = TRUE,
    showSummaries = FALSE,
    showExplanations = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("dynamiccoeff requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(dynamic_covariates)) dynamic_covariates <- jmvcore::resolveQuo(jmvcore::enquo(dynamic_covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(elapsedtime), elapsedtime, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(covariates), covariates, NULL),
            `if`( ! missing(dynamic_covariates), dynamic_covariates, NULL))


    options <- dynamiccoeffOptions$new(
        elapsedtime = elapsedtime,
        outcome = outcome,
        covariates = covariates,
        dynamic_covariates = dynamic_covariates,
        outcomeLevel = outcomeLevel,
        updating_method = updating_method,
        state_dimension = state_dimension,
        process_variance = process_variance,
        observation_variance = observation_variance,
        forgetting_factor = forgetting_factor,
        burn_in_period = burn_in_period,
        confidence_level = confidence_level,
        smoothing_parameter = smoothing_parameter,
        adaptation_rate = adaptation_rate,
        show_model_summary = show_model_summary,
        show_coefficient_paths = show_coefficient_paths,
        show_state_evolution = show_state_evolution,
        show_adaptation_metrics = show_adaptation_metrics,
        show_dynamic_plots = show_dynamic_plots,
        show_state_plots = show_state_plots,
        show_diagnostic_plots = show_diagnostic_plots,
        show_comparison_plots = show_comparison_plots,
        showSummaries = showSummaries,
        showExplanations = showExplanations)

    analysis <- dynamiccoeffClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

