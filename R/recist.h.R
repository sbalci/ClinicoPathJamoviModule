
# This file is automatically generated, you probably don't want to edit this

recistOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "recistOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            patientId = NULL,
            assessmentTime = NULL,
            lesionId = NULL,
            lesionType = NULL,
            lesionDiameter = NULL,
            nonTargetStatus = NULL,
            organ = NULL,
            maxTargetLesions = 5,
            maxPerOrgan = 2,
            prThreshold = 30,
            pdThreshold = 20,
            pdAbsolute = 5,
            requireConfirmation = TRUE,
            confirmationWindow = 4,
            nadirReference = TRUE,
            showLesionTable = TRUE,
            showTargetSumTable = TRUE,
            showResponseTable = TRUE,
            showBestResponse = TRUE,
            showLesionPlot = TRUE,
            showSumPlot = TRUE,
            showWaterfallPlot = TRUE,
            groupVar = NULL,
            stratifiedAnalysis = FALSE,
            exportLesionData = FALSE,
            showReference = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="recist",
                requiresData=TRUE,
                ...)

            private$..patientId <- jmvcore::OptionVariable$new(
                "patientId",
                patientId,
                required=TRUE)
            private$..assessmentTime <- jmvcore::OptionVariable$new(
                "assessmentTime",
                assessmentTime,
                required=TRUE,
                suggested=list(
                    "continuous"))
            private$..lesionId <- jmvcore::OptionVariable$new(
                "lesionId",
                lesionId,
                required=TRUE)
            private$..lesionType <- jmvcore::OptionVariable$new(
                "lesionType",
                lesionType,
                required=TRUE,
                suggested=list(
                    "nominal"))
            private$..lesionDiameter <- jmvcore::OptionVariable$new(
                "lesionDiameter",
                lesionDiameter,
                suggested=list(
                    "continuous"))
            private$..nonTargetStatus <- jmvcore::OptionVariable$new(
                "nonTargetStatus",
                nonTargetStatus,
                suggested=list(
                    "nominal"))
            private$..organ <- jmvcore::OptionVariable$new(
                "organ",
                organ,
                suggested=list(
                    "nominal"))
            private$..maxTargetLesions <- jmvcore::OptionNumber$new(
                "maxTargetLesions",
                maxTargetLesions,
                min=1,
                max=10,
                default=5)
            private$..maxPerOrgan <- jmvcore::OptionNumber$new(
                "maxPerOrgan",
                maxPerOrgan,
                min=1,
                max=5,
                default=2)
            private$..prThreshold <- jmvcore::OptionNumber$new(
                "prThreshold",
                prThreshold,
                min=0,
                max=100,
                default=30)
            private$..pdThreshold <- jmvcore::OptionNumber$new(
                "pdThreshold",
                pdThreshold,
                min=0,
                max=100,
                default=20)
            private$..pdAbsolute <- jmvcore::OptionNumber$new(
                "pdAbsolute",
                pdAbsolute,
                min=0,
                max=20,
                default=5)
            private$..requireConfirmation <- jmvcore::OptionBool$new(
                "requireConfirmation",
                requireConfirmation,
                default=TRUE)
            private$..confirmationWindow <- jmvcore::OptionNumber$new(
                "confirmationWindow",
                confirmationWindow,
                min=2,
                max=12,
                default=4)
            private$..nadirReference <- jmvcore::OptionBool$new(
                "nadirReference",
                nadirReference,
                default=TRUE)
            private$..showLesionTable <- jmvcore::OptionBool$new(
                "showLesionTable",
                showLesionTable,
                default=TRUE)
            private$..showTargetSumTable <- jmvcore::OptionBool$new(
                "showTargetSumTable",
                showTargetSumTable,
                default=TRUE)
            private$..showResponseTable <- jmvcore::OptionBool$new(
                "showResponseTable",
                showResponseTable,
                default=TRUE)
            private$..showBestResponse <- jmvcore::OptionBool$new(
                "showBestResponse",
                showBestResponse,
                default=TRUE)
            private$..showLesionPlot <- jmvcore::OptionBool$new(
                "showLesionPlot",
                showLesionPlot,
                default=TRUE)
            private$..showSumPlot <- jmvcore::OptionBool$new(
                "showSumPlot",
                showSumPlot,
                default=TRUE)
            private$..showWaterfallPlot <- jmvcore::OptionBool$new(
                "showWaterfallPlot",
                showWaterfallPlot,
                default=TRUE)
            private$..groupVar <- jmvcore::OptionVariable$new(
                "groupVar",
                groupVar,
                suggested=list(
                    "nominal",
                    "ordinal"))
            private$..stratifiedAnalysis <- jmvcore::OptionBool$new(
                "stratifiedAnalysis",
                stratifiedAnalysis,
                default=FALSE)
            private$..exportLesionData <- jmvcore::OptionBool$new(
                "exportLesionData",
                exportLesionData,
                default=FALSE)
            private$..showReference <- jmvcore::OptionBool$new(
                "showReference",
                showReference,
                default=TRUE)

            self$.addOption(private$..patientId)
            self$.addOption(private$..assessmentTime)
            self$.addOption(private$..lesionId)
            self$.addOption(private$..lesionType)
            self$.addOption(private$..lesionDiameter)
            self$.addOption(private$..nonTargetStatus)
            self$.addOption(private$..organ)
            self$.addOption(private$..maxTargetLesions)
            self$.addOption(private$..maxPerOrgan)
            self$.addOption(private$..prThreshold)
            self$.addOption(private$..pdThreshold)
            self$.addOption(private$..pdAbsolute)
            self$.addOption(private$..requireConfirmation)
            self$.addOption(private$..confirmationWindow)
            self$.addOption(private$..nadirReference)
            self$.addOption(private$..showLesionTable)
            self$.addOption(private$..showTargetSumTable)
            self$.addOption(private$..showResponseTable)
            self$.addOption(private$..showBestResponse)
            self$.addOption(private$..showLesionPlot)
            self$.addOption(private$..showSumPlot)
            self$.addOption(private$..showWaterfallPlot)
            self$.addOption(private$..groupVar)
            self$.addOption(private$..stratifiedAnalysis)
            self$.addOption(private$..exportLesionData)
            self$.addOption(private$..showReference)
        }),
    active = list(
        patientId = function() private$..patientId$value,
        assessmentTime = function() private$..assessmentTime$value,
        lesionId = function() private$..lesionId$value,
        lesionType = function() private$..lesionType$value,
        lesionDiameter = function() private$..lesionDiameter$value,
        nonTargetStatus = function() private$..nonTargetStatus$value,
        organ = function() private$..organ$value,
        maxTargetLesions = function() private$..maxTargetLesions$value,
        maxPerOrgan = function() private$..maxPerOrgan$value,
        prThreshold = function() private$..prThreshold$value,
        pdThreshold = function() private$..pdThreshold$value,
        pdAbsolute = function() private$..pdAbsolute$value,
        requireConfirmation = function() private$..requireConfirmation$value,
        confirmationWindow = function() private$..confirmationWindow$value,
        nadirReference = function() private$..nadirReference$value,
        showLesionTable = function() private$..showLesionTable$value,
        showTargetSumTable = function() private$..showTargetSumTable$value,
        showResponseTable = function() private$..showResponseTable$value,
        showBestResponse = function() private$..showBestResponse$value,
        showLesionPlot = function() private$..showLesionPlot$value,
        showSumPlot = function() private$..showSumPlot$value,
        showWaterfallPlot = function() private$..showWaterfallPlot$value,
        groupVar = function() private$..groupVar$value,
        stratifiedAnalysis = function() private$..stratifiedAnalysis$value,
        exportLesionData = function() private$..exportLesionData$value,
        showReference = function() private$..showReference$value),
    private = list(
        ..patientId = NA,
        ..assessmentTime = NA,
        ..lesionId = NA,
        ..lesionType = NA,
        ..lesionDiameter = NA,
        ..nonTargetStatus = NA,
        ..organ = NA,
        ..maxTargetLesions = NA,
        ..maxPerOrgan = NA,
        ..prThreshold = NA,
        ..pdThreshold = NA,
        ..pdAbsolute = NA,
        ..requireConfirmation = NA,
        ..confirmationWindow = NA,
        ..nadirReference = NA,
        ..showLesionTable = NA,
        ..showTargetSumTable = NA,
        ..showResponseTable = NA,
        ..showBestResponse = NA,
        ..showLesionPlot = NA,
        ..showSumPlot = NA,
        ..showWaterfallPlot = NA,
        ..groupVar = NA,
        ..stratifiedAnalysis = NA,
        ..exportLesionData = NA,
        ..showReference = NA)
)

recistResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "recistResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        dataInfo = function() private$.items[["dataInfo"]],
        lesionTable = function() private$.items[["lesionTable"]],
        targetSumTable = function() private$.items[["targetSumTable"]],
        responseTable = function() private$.items[["responseTable"]],
        bestResponseTable = function() private$.items[["bestResponseTable"]],
        summaryStats = function() private$.items[["summaryStats"]],
        efficacyMetrics = function() private$.items[["efficacyMetrics"]],
        lesionPlot = function() private$.items[["lesionPlot"]],
        sumPlot = function() private$.items[["sumPlot"]],
        waterfallPlot = function() private$.items[["waterfallPlot"]],
        stratifiedTable = function() private$.items[["stratifiedTable"]],
        clinicalInterpretation = function() private$.items[["clinicalInterpretation"]],
        referenceInfo = function() private$.items[["referenceInfo"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="RECIST 1.1 Multi-Lesion Aggregation")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="dataInfo",
                title="Data Summary",
                rows=0,
                clearWith=list(
                    "patientId",
                    "lesionId",
                    "assessmentTime"),
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="lesionTable",
                title="Individual Lesion Measurements",
                visible="(showLesionTable)",
                clearWith=list(
                    "patientId",
                    "lesionId",
                    "lesionDiameter"),
                rows=0,
                columns=list(
                    list(
                        `name`="patientId", 
                        `title`="Patient ID", 
                        `type`="text"),
                    list(
                        `name`="assessmentTime", 
                        `title`="Assessment", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="lesionId", 
                        `title`="Lesion ID", 
                        `type`="text"),
                    list(
                        `name`="lesionType", 
                        `title`="Type", 
                        `type`="text"),
                    list(
                        `name`="diameter", 
                        `title`="Diameter (mm)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="organ", 
                        `title`="Organ", 
                        `type`="text"),
                    list(
                        `name`="included", 
                        `title`="Included in Target Sum", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="targetSumTable",
                title="Target Lesion Sum by Assessment",
                visible="(showTargetSumTable)",
                clearWith=list(
                    "patientId",
                    "assessmentTime",
                    "lesionDiameter"),
                rows=0,
                columns=list(
                    list(
                        `name`="patientId", 
                        `title`="Patient ID", 
                        `type`="text"),
                    list(
                        `name`="assessmentTime", 
                        `title`="Assessment Time", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="targetSum", 
                        `title`="Target Sum (mm)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="changeFromBaseline", 
                        `title`="Change from Baseline (%)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="changeFromNadir", 
                        `title`="Change from Nadir (%)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="numTargetLesions", 
                        `title`="N Target Lesions", 
                        `type`="integer"),
                    list(
                        `name`="numNonTarget", 
                        `title`="N Non-Target", 
                        `type`="integer"),
                    list(
                        `name`="newLesions", 
                        `title`="New Lesions", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="responseTable",
                title="RECIST Response Classification",
                visible="(showResponseTable)",
                clearWith=list(
                    "patientId",
                    "assessmentTime",
                    "lesionDiameter",
                    "requireConfirmation"),
                rows=0,
                columns=list(
                    list(
                        `name`="patientId", 
                        `title`="Patient ID", 
                        `type`="text"),
                    list(
                        `name`="assessmentTime", 
                        `title`="Assessment Time", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="targetResponse", 
                        `title`="Target Response", 
                        `type`="text"),
                    list(
                        `name`="nonTargetResponse", 
                        `title`="Non-Target Response", 
                        `type`="text"),
                    list(
                        `name`="newLesions", 
                        `title`="New Lesions", 
                        `type`="text"),
                    list(
                        `name`="overallResponse", 
                        `title`="Overall Response", 
                        `type`="text"),
                    list(
                        `name`="confirmed", 
                        `title`="Confirmed", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="bestResponseTable",
                title="Best Overall Response by Patient",
                visible="(showBestResponse)",
                clearWith=list(
                    "patientId",
                    "requireConfirmation"),
                rows=0,
                columns=list(
                    list(
                        `name`="patientId", 
                        `title`="Patient ID", 
                        `type`="text"),
                    list(
                        `name`="bestResponse", 
                        `title`="Best Overall Response", 
                        `type`="text"),
                    list(
                        `name`="timeToResponse", 
                        `title`="Time to Response", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="confirmed", 
                        `title`="Confirmed", 
                        `type`="text"),
                    list(
                        `name`="nadirSum", 
                        `title`="Nadir Sum (mm)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="bestPercentChange", 
                        `title`="Best % Change", 
                        `type`="number", 
                        `format`="dp:1"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="summaryStats",
                title="Response Distribution",
                visible="(showBestResponse)",
                clearWith=list(
                    "patientId"),
                rows=0,
                columns=list(
                    list(
                        `name`="category", 
                        `title`="Response Category", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="percent", 
                        `title`="Percent", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="dp:1"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="efficacyMetrics",
                title="Efficacy Metrics",
                visible="(showBestResponse)",
                rows=0,
                clearWith=list(
                    "patientId"),
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value (%)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="total", 
                        `title`="Total", 
                        `type`="integer"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="dp:1"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="lesionPlot",
                title="Individual Lesion Trajectories",
                visible="(showLesionPlot)",
                renderFun=".lesionPlot",
                clearWith=list(
                    "patientId",
                    "lesionId",
                    "lesionDiameter"),
                width=700,
                height=500))
            self$add(jmvcore::Image$new(
                options=options,
                name="sumPlot",
                title="Target Lesion Sum Over Time",
                visible="(showSumPlot)",
                renderFun=".sumPlot",
                clearWith=list(
                    "patientId",
                    "assessmentTime",
                    "lesionDiameter"),
                width=700,
                height=500))
            self$add(jmvcore::Image$new(
                options=options,
                name="waterfallPlot",
                title="Waterfall Plot (Best % Change)",
                visible="(showWaterfallPlot)",
                renderFun=".waterfallPlot",
                clearWith=list(
                    "patientId",
                    "lesionDiameter"),
                width=600,
                height=500))
            self$add(jmvcore::Table$new(
                options=options,
                name="stratifiedTable",
                title="Stratified Response Analysis",
                visible="(stratifiedAnalysis && groupVar)",
                clearWith=list(
                    "groupVar",
                    "stratifiedAnalysis"),
                rows=0,
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="CR", 
                        `title`="CR (%)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="PR", 
                        `title`="PR (%)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="SD", 
                        `title`="SD (%)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="PD", 
                        `title`="PD (%)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="ORR", 
                        `title`="ORR (%)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="DCR", 
                        `title`="DCR (%)", 
                        `type`="number", 
                        `format`="dp:1"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalInterpretation",
                title="Clinical Interpretation",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="referenceInfo",
                title="RECIST 1.1 Reference",
                visible="(showReference)"))}))

recistBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "recistBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "recist",
                version = c(0,0,32),
                options = options,
                results = recistResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' RECIST 1.1 Multi-Lesion Aggregation
#'
#' Multi-lesion RECIST 1.1 aggregation for automated calculation of target 
#' lesion sums and best overall response. Processes individual lesion 
#' measurements and applies RECIST 1.1 criteria (Eisenhauer et al., 2009) for 
#' response classification.
#' 
#'
#' @examples
#' data <- data.frame(
#'     patient = rep(c("P01", "P02"), each = 6),
#'     time = rep(c(0, 8, 16), 4),
#'     lesion = rep(c("L1", "L2"), each = 3, times = 2),
#'     lesion_type = "target",
#'     diameter = c(25, 15, 12, 20, 10, 8, 30, 35, 40, 22, 20, 18)
#' )
#'
#' recist(
#'     data = data,
#'     patientId = "patient",
#'     assessmentTime = "time",
#'     lesionId = "lesion",
#'     lesionType = "lesion_type",
#'     lesionDiameter = "diameter"
#' )
#'
#' @param data the data as a data frame
#' @param patientId Patient identifier variable
#' @param assessmentTime Time from baseline (weeks or months)
#' @param lesionId Unique lesion identifier
#' @param lesionType Lesion type (target, non-target, new)
#' @param lesionDiameter Lesion diameter in millimeters (for target lesions)
#' @param nonTargetStatus Non-target lesion status (present, absent,
#'   unequivocal PD)
#' @param organ Organ location (for max 2 per organ rule)
#' @param maxTargetLesions Maximum number of target lesions (default: 5 per
#'   RECIST 1.1)
#' @param maxPerOrgan Maximum target lesions per organ (default: 2 per RECIST
#'   1.1)
#' @param prThreshold Percent decrease for partial response (default: 30\%)
#' @param pdThreshold Percent increase for progressive disease (default: 20\%)
#' @param pdAbsolute Absolute increase required for PD (default: 5mm)
#' @param requireConfirmation Require 2 consecutive assessments for CR/PR
#' @param confirmationWindow Minimum weeks between confirmation assessments
#' @param nadirReference Use nadir (lowest) sum as reference for PD
#'   calculation
#' @param showLesionTable Show individual lesion measurements
#' @param showTargetSumTable Show aggregated target lesion sums by assessment
#' @param showResponseTable Show RECIST response categories per assessment
#' @param showBestResponse Calculate best overall response per patient
#' @param showLesionPlot Plot individual lesion sizes over time
#' @param showSumPlot Plot target lesion sum over time
#' @param showWaterfallPlot Waterfall plot of best percent change
#' @param groupVar Grouping variable for stratified analysis
#' @param stratifiedAnalysis Perform stratified analysis by group
#' @param exportLesionData Export processed lesion-level data to CSV
#' @param showReference Display RECIST 1.1 guidelines reference
#' @param formula (optional) the formula to use, see the examples
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$dataInfo} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$lesionTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$targetSumTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$responseTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$bestResponseTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$summaryStats} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$efficacyMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$lesionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$sumPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$waterfallPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$stratifiedTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clinicalInterpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$referenceInfo} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$dataInfo$asDF}
#'
#' \code{as.data.frame(results$dataInfo)}
#'
#' @export
recist <- function(
    data,
    patientId,
    assessmentTime,
    lesionId,
    lesionType,
    lesionDiameter,
    nonTargetStatus,
    organ,
    maxTargetLesions = 5,
    maxPerOrgan = 2,
    prThreshold = 30,
    pdThreshold = 20,
    pdAbsolute = 5,
    requireConfirmation = TRUE,
    confirmationWindow = 4,
    nadirReference = TRUE,
    showLesionTable = TRUE,
    showTargetSumTable = TRUE,
    showResponseTable = TRUE,
    showBestResponse = TRUE,
    showLesionPlot = TRUE,
    showSumPlot = TRUE,
    showWaterfallPlot = TRUE,
    groupVar,
    stratifiedAnalysis = FALSE,
    exportLesionData = FALSE,
    showReference = TRUE,
    formula) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("recist requires jmvcore to be installed (restart may be required)")

    if ( ! missing(formula)) {
        if (missing(patientId))
            patientId <- jmvcore::marshalFormula(
                formula=formula,
                data=`if`( ! missing(data), data, NULL),
                from="lhs",
                required=TRUE)
        if (missing(assessmentTime))
            assessmentTime <- jmvcore::marshalFormula(
                formula=formula,
                data=`if`( ! missing(data), data, NULL),
                from="rhs",
                subset="1")
        if (missing(lesionId))
            lesionId <- jmvcore::marshalFormula(
                formula=formula,
                data=`if`( ! missing(data), data, NULL),
                from="rhs",
                subset="2")
        if (missing(lesionType))
            lesionType <- jmvcore::marshalFormula(
                formula=formula,
                data=`if`( ! missing(data), data, NULL),
                from="rhs",
                subset="3")
        if (missing(lesionDiameter))
            lesionDiameter <- jmvcore::marshalFormula(
                formula=formula,
                data=`if`( ! missing(data), data, NULL),
                from="rhs",
                subset="4")
    }

    if ( ! missing(patientId)) patientId <- jmvcore::resolveQuo(jmvcore::enquo(patientId))
    if ( ! missing(assessmentTime)) assessmentTime <- jmvcore::resolveQuo(jmvcore::enquo(assessmentTime))
    if ( ! missing(lesionId)) lesionId <- jmvcore::resolveQuo(jmvcore::enquo(lesionId))
    if ( ! missing(lesionType)) lesionType <- jmvcore::resolveQuo(jmvcore::enquo(lesionType))
    if ( ! missing(lesionDiameter)) lesionDiameter <- jmvcore::resolveQuo(jmvcore::enquo(lesionDiameter))
    if ( ! missing(nonTargetStatus)) nonTargetStatus <- jmvcore::resolveQuo(jmvcore::enquo(nonTargetStatus))
    if ( ! missing(organ)) organ <- jmvcore::resolveQuo(jmvcore::enquo(organ))
    if ( ! missing(groupVar)) groupVar <- jmvcore::resolveQuo(jmvcore::enquo(groupVar))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(patientId), patientId, NULL),
            `if`( ! missing(assessmentTime), assessmentTime, NULL),
            `if`( ! missing(lesionId), lesionId, NULL),
            `if`( ! missing(lesionType), lesionType, NULL),
            `if`( ! missing(lesionDiameter), lesionDiameter, NULL),
            `if`( ! missing(nonTargetStatus), nonTargetStatus, NULL),
            `if`( ! missing(organ), organ, NULL),
            `if`( ! missing(groupVar), groupVar, NULL))


    options <- recistOptions$new(
        patientId = patientId,
        assessmentTime = assessmentTime,
        lesionId = lesionId,
        lesionType = lesionType,
        lesionDiameter = lesionDiameter,
        nonTargetStatus = nonTargetStatus,
        organ = organ,
        maxTargetLesions = maxTargetLesions,
        maxPerOrgan = maxPerOrgan,
        prThreshold = prThreshold,
        pdThreshold = pdThreshold,
        pdAbsolute = pdAbsolute,
        requireConfirmation = requireConfirmation,
        confirmationWindow = confirmationWindow,
        nadirReference = nadirReference,
        showLesionTable = showLesionTable,
        showTargetSumTable = showTargetSumTable,
        showResponseTable = showResponseTable,
        showBestResponse = showBestResponse,
        showLesionPlot = showLesionPlot,
        showSumPlot = showSumPlot,
        showWaterfallPlot = showWaterfallPlot,
        groupVar = groupVar,
        stratifiedAnalysis = stratifiedAnalysis,
        exportLesionData = exportLesionData,
        showReference = showReference)

    analysis <- recistClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

