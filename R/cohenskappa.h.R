
# This file is automatically generated, you probably don't want to edit this

cohenskappaOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "cohenskappaOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            rater1 = NULL,
            rater2 = NULL,
            kappa_type = "cohen",
            confidence_level = 0.95,
            ci_method = "asymptotic",
            bootstrap_samples = 1000,
            exact_agreement = TRUE,
            marginal_homogeneity = TRUE,
            agreement_plot = TRUE,
            confusion_matrix = TRUE,
            category_analysis = FALSE,
            interpretation_guide = TRUE,
            missing_treatment = "listwise",
            minimum_categories = 2, ...) {

            super$initialize(
                package="ClinicoPath",
                name="cohenskappa",
                requiresData=TRUE,
                ...)

            private$..rater1 <- jmvcore::OptionVariable$new(
                "rater1",
                rater1,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..rater2 <- jmvcore::OptionVariable$new(
                "rater2",
                rater2,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..kappa_type <- jmvcore::OptionList$new(
                "kappa_type",
                kappa_type,
                options=list(
                    "cohen",
                    "linear",
                    "quadratic",
                    "all"),
                default="cohen")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.5,
                max=0.99)
            private$..ci_method <- jmvcore::OptionList$new(
                "ci_method",
                ci_method,
                options=list(
                    "asymptotic",
                    "bootstrap",
                    "both"),
                default="asymptotic")
            private$..bootstrap_samples <- jmvcore::OptionInteger$new(
                "bootstrap_samples",
                bootstrap_samples,
                default=1000,
                min=100,
                max=10000)
            private$..exact_agreement <- jmvcore::OptionBool$new(
                "exact_agreement",
                exact_agreement,
                default=TRUE)
            private$..marginal_homogeneity <- jmvcore::OptionBool$new(
                "marginal_homogeneity",
                marginal_homogeneity,
                default=TRUE)
            private$..agreement_plot <- jmvcore::OptionBool$new(
                "agreement_plot",
                agreement_plot,
                default=TRUE)
            private$..confusion_matrix <- jmvcore::OptionBool$new(
                "confusion_matrix",
                confusion_matrix,
                default=TRUE)
            private$..category_analysis <- jmvcore::OptionBool$new(
                "category_analysis",
                category_analysis,
                default=FALSE)
            private$..interpretation_guide <- jmvcore::OptionBool$new(
                "interpretation_guide",
                interpretation_guide,
                default=TRUE)
            private$..missing_treatment <- jmvcore::OptionList$new(
                "missing_treatment",
                missing_treatment,
                options=list(
                    "listwise",
                    "pairwise"),
                default="listwise")
            private$..minimum_categories <- jmvcore::OptionInteger$new(
                "minimum_categories",
                minimum_categories,
                default=2,
                min=2,
                max=10)

            self$.addOption(private$..rater1)
            self$.addOption(private$..rater2)
            self$.addOption(private$..kappa_type)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..ci_method)
            self$.addOption(private$..bootstrap_samples)
            self$.addOption(private$..exact_agreement)
            self$.addOption(private$..marginal_homogeneity)
            self$.addOption(private$..agreement_plot)
            self$.addOption(private$..confusion_matrix)
            self$.addOption(private$..category_analysis)
            self$.addOption(private$..interpretation_guide)
            self$.addOption(private$..missing_treatment)
            self$.addOption(private$..minimum_categories)
        }),
    active = list(
        rater1 = function() private$..rater1$value,
        rater2 = function() private$..rater2$value,
        kappa_type = function() private$..kappa_type$value,
        confidence_level = function() private$..confidence_level$value,
        ci_method = function() private$..ci_method$value,
        bootstrap_samples = function() private$..bootstrap_samples$value,
        exact_agreement = function() private$..exact_agreement$value,
        marginal_homogeneity = function() private$..marginal_homogeneity$value,
        agreement_plot = function() private$..agreement_plot$value,
        confusion_matrix = function() private$..confusion_matrix$value,
        category_analysis = function() private$..category_analysis$value,
        interpretation_guide = function() private$..interpretation_guide$value,
        missing_treatment = function() private$..missing_treatment$value,
        minimum_categories = function() private$..minimum_categories$value),
    private = list(
        ..rater1 = NA,
        ..rater2 = NA,
        ..kappa_type = NA,
        ..confidence_level = NA,
        ..ci_method = NA,
        ..bootstrap_samples = NA,
        ..exact_agreement = NA,
        ..marginal_homogeneity = NA,
        ..agreement_plot = NA,
        ..confusion_matrix = NA,
        ..category_analysis = NA,
        ..interpretation_guide = NA,
        ..missing_treatment = NA,
        ..minimum_categories = NA)
)

cohenskappaResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "cohenskappaResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        summary = function() private$.items[["summary"]],
        kappaTable = function() private$.items[["kappaTable"]],
        agreementStats = function() private$.items[["agreementStats"]],
        confusionMatrix = function() private$.items[["confusionMatrix"]],
        categoryStats = function() private$.items[["categoryStats"]],
        marginalTest = function() private$.items[["marginalTest"]],
        bootstrapResults = function() private$.items[["bootstrapResults"]],
        agreementPlot = function() private$.items[["agreementPlot"]],
        confusionHeatmap = function() private$.items[["confusionHeatmap"]],
        interpretationGuide = function() private$.items[["interpretationGuide"]],
        technicalNotes = function() private$.items[["technicalNotes"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Cohen's Kappa Agreement")
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Instructions",
                clearWith=list(
                    "rater1",
                    "rater2")))
            self$add(jmvcore::Html$new(
                options=options,
                name="summary",
                title="Analysis Summary",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="kappaTable",
                title="Kappa Statistics",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"),
                    list(
                        `name`="kappa", 
                        `title`="Kappa", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="Standard Error", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="z_value", 
                        `title`="Z-value", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="agreementStats",
                title="Agreement Statistics",
                visible="(exact_agreement)",
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="percentage", 
                        `title`="Percentage", 
                        `type`="number"),
                    list(
                        `name`="description", 
                        `title`="Description", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="confusionMatrix",
                title="Confusion Matrix",
                visible="(confusion_matrix)",
                columns=list(
                    list(
                        `name`="rater1_category", 
                        `title`="Rater 1", 
                        `type`="text"),
                    list(
                        `name`="rater2_categories", 
                        `title`="Rater 2 Categories", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="categoryStats",
                title="Category-Specific Agreement",
                visible="(category_analysis)",
                columns=list(
                    list(
                        `name`="category", 
                        `title`="Category", 
                        `type`="text"),
                    list(
                        `name`="n_cases", 
                        `title`="N Cases", 
                        `type`="integer"),
                    list(
                        `name`="agreement_count", 
                        `title`="Agreements", 
                        `type`="integer"),
                    list(
                        `name`="agreement_rate", 
                        `title`="Agreement Rate", 
                        `type`="number"),
                    list(
                        `name`="kappa_contribution", 
                        `title`="Kappa Contribution", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="marginalTest",
                title="Marginal Homogeneity Test",
                visible="(marginal_homogeneity)",
                columns=list(
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="bootstrapResults",
                title="Bootstrap Confidence Intervals",
                visible="(ci_method:bootstrap || ci_method:both)",
                columns=list(
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"),
                    list(
                        `name`="kappa", 
                        `title`="Kappa", 
                        `type`="number"),
                    list(
                        `name`="boot_lower", 
                        `title`="Bootstrap Lower", 
                        `type`="number"),
                    list(
                        `name`="boot_upper", 
                        `title`="Bootstrap Upper", 
                        `type`="number"),
                    list(
                        `name`="boot_samples", 
                        `title`="Bootstrap Samples", 
                        `type`="integer"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="agreementPlot",
                title="Agreement Visualization",
                width=700,
                height=500,
                renderFun=".plotAgreement",
                visible="(agreement_plot)",
                clearWith=list(
                    "rater1",
                    "rater2",
                    "kappa_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="confusionHeatmap",
                title="Agreement Heatmap",
                width=600,
                height=500,
                renderFun=".plotConfusionHeatmap",
                visible="(confusion_matrix)",
                clearWith=list(
                    "rater1",
                    "rater2")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretationGuide",
                title="Clinical Interpretation Guidelines",
                visible="(interpretation_guide)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="technicalNotes",
                title="Technical Notes and Assumptions",
                visible=TRUE))}))

cohenskappaBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "cohenskappaBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "cohenskappa",
                version = c(0,0,31),
                options = options,
                results = cohenskappaResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Cohen's Kappa Agreement
#'
#' Cohen's kappa and weighted kappa for two-rater agreement analysis.
#' Essential for assessing agreement between two pathologists, diagnostic 
#' reproducibility,
#' and quality assurance in clinical pathology practice.
#' 
#' @param data The data as a data frame.
#' @param rater1 .
#' @param rater2 .
#' @param kappa_type Type of kappa statistic to calculate
#' @param confidence_level Confidence level for confidence intervals
#' @param ci_method Method for calculating confidence intervals
#' @param bootstrap_samples Number of bootstrap samples for CI estimation
#' @param exact_agreement Calculate overall and category-specific agreement
#'   percentages
#' @param marginal_homogeneity Test whether marginal distributions are equal
#'   (Stuart-Maxwell test)
#' @param agreement_plot Create agreement plot showing observed vs expected
#'   agreement
#' @param confusion_matrix Display confusion matrix with agreement patterns
#' @param category_analysis Detailed analysis of agreement for each category
#' @param interpretation_guide Provide clinical interpretation of kappa values
#' @param missing_treatment How to handle missing data
#' @param minimum_categories Minimum number of categories required for
#'   analysis
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$kappaTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$agreementStats} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$confusionMatrix} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$categoryStats} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$marginalTest} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$bootstrapResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$agreementPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$confusionHeatmap} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$interpretationGuide} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$technicalNotes} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$kappaTable$asDF}
#'
#' \code{as.data.frame(results$kappaTable)}
#'
#' @export
cohenskappa <- function(
    data,
    rater1,
    rater2,
    kappa_type = "cohen",
    confidence_level = 0.95,
    ci_method = "asymptotic",
    bootstrap_samples = 1000,
    exact_agreement = TRUE,
    marginal_homogeneity = TRUE,
    agreement_plot = TRUE,
    confusion_matrix = TRUE,
    category_analysis = FALSE,
    interpretation_guide = TRUE,
    missing_treatment = "listwise",
    minimum_categories = 2) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("cohenskappa requires jmvcore to be installed (restart may be required)")

    if ( ! missing(rater1)) rater1 <- jmvcore::resolveQuo(jmvcore::enquo(rater1))
    if ( ! missing(rater2)) rater2 <- jmvcore::resolveQuo(jmvcore::enquo(rater2))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(rater1), rater1, NULL),
            `if`( ! missing(rater2), rater2, NULL))


    options <- cohenskappaOptions$new(
        rater1 = rater1,
        rater2 = rater2,
        kappa_type = kappa_type,
        confidence_level = confidence_level,
        ci_method = ci_method,
        bootstrap_samples = bootstrap_samples,
        exact_agreement = exact_agreement,
        marginal_homogeneity = marginal_homogeneity,
        agreement_plot = agreement_plot,
        confusion_matrix = confusion_matrix,
        category_analysis = category_analysis,
        interpretation_guide = interpretation_guide,
        missing_treatment = missing_treatment,
        minimum_categories = minimum_categories)

    analysis <- cohenskappaClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

