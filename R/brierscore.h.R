
# This file is automatically generated, you probably don't want to edit this

brierscoreOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "brierscoreOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            event = NULL,
            event_code = NULL,
            predicted_survival = NULL,
            linear_predictor = NULL,
            prediction_formula = "",
            prediction_time = 60,
            multiple_time_points = FALSE,
            time_points = "12, 36, 60",
            calculate_ibs = FALSE,
            ibs_start_time = 0,
            ibs_end_time = 60,
            scaled_brier = TRUE,
            reference_model = FALSE,
            reference_predictions = NULL,
            reference_formula = "",
            confidence_intervals = FALSE,
            ci_method = "bootstrap",
            bootstrap_samples = 500,
            confidence_level = 0.95,
            compare_multiple_models = FALSE,
            additional_predictions = NULL,
            model_names = "Model 1, Model 2, Model 3",
            competing_risks = FALSE,
            cause_specific = TRUE,
            plot_brier_over_time = TRUE,
            plot_calibration_curve = FALSE,
            calibration_groups = 10,
            plot_model_comparison = FALSE,
            plot_integrated_brier = FALSE,
            stratified_brier = FALSE,
            stratify_by = NULL,
            inverse_probability_weighting = TRUE,
            external_validation = FALSE,
            temporal_validation = FALSE,
            development_period = "",
            missing_handling = "complete",
            random_seed = 123, ...) {

            super$initialize(
                package="ClinicoPath",
                name="brierscore",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event <- jmvcore::OptionVariable$new(
                "event",
                event,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..event_code <- jmvcore::OptionLevel$new(
                "event_code",
                event_code,
                variable="(event)")
            private$..predicted_survival <- jmvcore::OptionVariable$new(
                "predicted_survival",
                predicted_survival,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..linear_predictor <- jmvcore::OptionVariable$new(
                "linear_predictor",
                linear_predictor,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..prediction_formula <- jmvcore::OptionString$new(
                "prediction_formula",
                prediction_formula,
                default="")
            private$..prediction_time <- jmvcore::OptionNumber$new(
                "prediction_time",
                prediction_time,
                default=60,
                min=0)
            private$..multiple_time_points <- jmvcore::OptionBool$new(
                "multiple_time_points",
                multiple_time_points,
                default=FALSE)
            private$..time_points <- jmvcore::OptionString$new(
                "time_points",
                time_points,
                default="12, 36, 60")
            private$..calculate_ibs <- jmvcore::OptionBool$new(
                "calculate_ibs",
                calculate_ibs,
                default=FALSE)
            private$..ibs_start_time <- jmvcore::OptionNumber$new(
                "ibs_start_time",
                ibs_start_time,
                default=0,
                min=0)
            private$..ibs_end_time <- jmvcore::OptionNumber$new(
                "ibs_end_time",
                ibs_end_time,
                default=60,
                min=0)
            private$..scaled_brier <- jmvcore::OptionBool$new(
                "scaled_brier",
                scaled_brier,
                default=TRUE)
            private$..reference_model <- jmvcore::OptionBool$new(
                "reference_model",
                reference_model,
                default=FALSE)
            private$..reference_predictions <- jmvcore::OptionVariable$new(
                "reference_predictions",
                reference_predictions,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..reference_formula <- jmvcore::OptionString$new(
                "reference_formula",
                reference_formula,
                default="")
            private$..confidence_intervals <- jmvcore::OptionBool$new(
                "confidence_intervals",
                confidence_intervals,
                default=FALSE)
            private$..ci_method <- jmvcore::OptionList$new(
                "ci_method",
                ci_method,
                options=list(
                    "bootstrap",
                    "influence"),
                default="bootstrap")
            private$..bootstrap_samples <- jmvcore::OptionInteger$new(
                "bootstrap_samples",
                bootstrap_samples,
                default=500,
                min=100,
                max=5000)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.8,
                max=0.99)
            private$..compare_multiple_models <- jmvcore::OptionBool$new(
                "compare_multiple_models",
                compare_multiple_models,
                default=FALSE)
            private$..additional_predictions <- jmvcore::OptionVariables$new(
                "additional_predictions",
                additional_predictions,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..model_names <- jmvcore::OptionString$new(
                "model_names",
                model_names,
                default="Model 1, Model 2, Model 3")
            private$..competing_risks <- jmvcore::OptionBool$new(
                "competing_risks",
                competing_risks,
                default=FALSE)
            private$..cause_specific <- jmvcore::OptionBool$new(
                "cause_specific",
                cause_specific,
                default=TRUE)
            private$..plot_brier_over_time <- jmvcore::OptionBool$new(
                "plot_brier_over_time",
                plot_brier_over_time,
                default=TRUE)
            private$..plot_calibration_curve <- jmvcore::OptionBool$new(
                "plot_calibration_curve",
                plot_calibration_curve,
                default=FALSE)
            private$..calibration_groups <- jmvcore::OptionInteger$new(
                "calibration_groups",
                calibration_groups,
                default=10,
                min=3,
                max=20)
            private$..plot_model_comparison <- jmvcore::OptionBool$new(
                "plot_model_comparison",
                plot_model_comparison,
                default=FALSE)
            private$..plot_integrated_brier <- jmvcore::OptionBool$new(
                "plot_integrated_brier",
                plot_integrated_brier,
                default=FALSE)
            private$..stratified_brier <- jmvcore::OptionBool$new(
                "stratified_brier",
                stratified_brier,
                default=FALSE)
            private$..stratify_by <- jmvcore::OptionVariable$new(
                "stratify_by",
                stratify_by,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..inverse_probability_weighting <- jmvcore::OptionBool$new(
                "inverse_probability_weighting",
                inverse_probability_weighting,
                default=TRUE)
            private$..external_validation <- jmvcore::OptionBool$new(
                "external_validation",
                external_validation,
                default=FALSE)
            private$..temporal_validation <- jmvcore::OptionBool$new(
                "temporal_validation",
                temporal_validation,
                default=FALSE)
            private$..development_period <- jmvcore::OptionString$new(
                "development_period",
                development_period,
                default="")
            private$..missing_handling <- jmvcore::OptionList$new(
                "missing_handling",
                missing_handling,
                options=list(
                    "complete",
                    "imputation"),
                default="complete")
            private$..random_seed <- jmvcore::OptionInteger$new(
                "random_seed",
                random_seed,
                default=123,
                min=1,
                max=999999)

            self$.addOption(private$..time)
            self$.addOption(private$..event)
            self$.addOption(private$..event_code)
            self$.addOption(private$..predicted_survival)
            self$.addOption(private$..linear_predictor)
            self$.addOption(private$..prediction_formula)
            self$.addOption(private$..prediction_time)
            self$.addOption(private$..multiple_time_points)
            self$.addOption(private$..time_points)
            self$.addOption(private$..calculate_ibs)
            self$.addOption(private$..ibs_start_time)
            self$.addOption(private$..ibs_end_time)
            self$.addOption(private$..scaled_brier)
            self$.addOption(private$..reference_model)
            self$.addOption(private$..reference_predictions)
            self$.addOption(private$..reference_formula)
            self$.addOption(private$..confidence_intervals)
            self$.addOption(private$..ci_method)
            self$.addOption(private$..bootstrap_samples)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..compare_multiple_models)
            self$.addOption(private$..additional_predictions)
            self$.addOption(private$..model_names)
            self$.addOption(private$..competing_risks)
            self$.addOption(private$..cause_specific)
            self$.addOption(private$..plot_brier_over_time)
            self$.addOption(private$..plot_calibration_curve)
            self$.addOption(private$..calibration_groups)
            self$.addOption(private$..plot_model_comparison)
            self$.addOption(private$..plot_integrated_brier)
            self$.addOption(private$..stratified_brier)
            self$.addOption(private$..stratify_by)
            self$.addOption(private$..inverse_probability_weighting)
            self$.addOption(private$..external_validation)
            self$.addOption(private$..temporal_validation)
            self$.addOption(private$..development_period)
            self$.addOption(private$..missing_handling)
            self$.addOption(private$..random_seed)
        }),
    active = list(
        time = function() private$..time$value,
        event = function() private$..event$value,
        event_code = function() private$..event_code$value,
        predicted_survival = function() private$..predicted_survival$value,
        linear_predictor = function() private$..linear_predictor$value,
        prediction_formula = function() private$..prediction_formula$value,
        prediction_time = function() private$..prediction_time$value,
        multiple_time_points = function() private$..multiple_time_points$value,
        time_points = function() private$..time_points$value,
        calculate_ibs = function() private$..calculate_ibs$value,
        ibs_start_time = function() private$..ibs_start_time$value,
        ibs_end_time = function() private$..ibs_end_time$value,
        scaled_brier = function() private$..scaled_brier$value,
        reference_model = function() private$..reference_model$value,
        reference_predictions = function() private$..reference_predictions$value,
        reference_formula = function() private$..reference_formula$value,
        confidence_intervals = function() private$..confidence_intervals$value,
        ci_method = function() private$..ci_method$value,
        bootstrap_samples = function() private$..bootstrap_samples$value,
        confidence_level = function() private$..confidence_level$value,
        compare_multiple_models = function() private$..compare_multiple_models$value,
        additional_predictions = function() private$..additional_predictions$value,
        model_names = function() private$..model_names$value,
        competing_risks = function() private$..competing_risks$value,
        cause_specific = function() private$..cause_specific$value,
        plot_brier_over_time = function() private$..plot_brier_over_time$value,
        plot_calibration_curve = function() private$..plot_calibration_curve$value,
        calibration_groups = function() private$..calibration_groups$value,
        plot_model_comparison = function() private$..plot_model_comparison$value,
        plot_integrated_brier = function() private$..plot_integrated_brier$value,
        stratified_brier = function() private$..stratified_brier$value,
        stratify_by = function() private$..stratify_by$value,
        inverse_probability_weighting = function() private$..inverse_probability_weighting$value,
        external_validation = function() private$..external_validation$value,
        temporal_validation = function() private$..temporal_validation$value,
        development_period = function() private$..development_period$value,
        missing_handling = function() private$..missing_handling$value,
        random_seed = function() private$..random_seed$value),
    private = list(
        ..time = NA,
        ..event = NA,
        ..event_code = NA,
        ..predicted_survival = NA,
        ..linear_predictor = NA,
        ..prediction_formula = NA,
        ..prediction_time = NA,
        ..multiple_time_points = NA,
        ..time_points = NA,
        ..calculate_ibs = NA,
        ..ibs_start_time = NA,
        ..ibs_end_time = NA,
        ..scaled_brier = NA,
        ..reference_model = NA,
        ..reference_predictions = NA,
        ..reference_formula = NA,
        ..confidence_intervals = NA,
        ..ci_method = NA,
        ..bootstrap_samples = NA,
        ..confidence_level = NA,
        ..compare_multiple_models = NA,
        ..additional_predictions = NA,
        ..model_names = NA,
        ..competing_risks = NA,
        ..cause_specific = NA,
        ..plot_brier_over_time = NA,
        ..plot_calibration_curve = NA,
        ..calibration_groups = NA,
        ..plot_model_comparison = NA,
        ..plot_integrated_brier = NA,
        ..stratified_brier = NA,
        ..stratify_by = NA,
        ..inverse_probability_weighting = NA,
        ..external_validation = NA,
        ..temporal_validation = NA,
        ..development_period = NA,
        ..missing_handling = NA,
        ..random_seed = NA)
)

brierscoreResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "brierscoreResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        brierSummary = function() private$.items[["brierSummary"]],
        integratedBrier = function() private$.items[["integratedBrier"]],
        modelComparison = function() private$.items[["modelComparison"]],
        pairwiseComparisons = function() private$.items[["pairwiseComparisons"]],
        calibrationTable = function() private$.items[["calibrationTable"]],
        stratifiedBrier = function() private$.items[["stratifiedBrier"]],
        brierOverTimePlot = function() private$.items[["brierOverTimePlot"]],
        calibrationPlot = function() private$.items[["calibrationPlot"]],
        modelComparisonPlot = function() private$.items[["modelComparisonPlot"]],
        integratedBrierPlot = function() private$.items[["integratedBrierPlot"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Brier Score & Integrated Brier Score")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="brierSummary",
                title="Brier Score Summary",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="number"),
                    list(
                        `name`="brier_score", 
                        `title`="Brier Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="brier_ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="brier_ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="scaled_brier", 
                        `title`="Scaled Brier", 
                        `type`="number", 
                        `visible`="(scaled_brier)"),
                    list(
                        `name`="null_model_brier", 
                        `title`="Null Model Brier", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(scaled_brier)"),
                    list(
                        `name`="n_events", 
                        `title`="N Events", 
                        `type`="integer"),
                    list(
                        `name`="n_censored", 
                        `title`="N Censored", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="integratedBrier",
                title="Integrated Brier Score (IBS)",
                visible="(calculate_ibs)",
                rows=1,
                columns=list(
                    list(
                        `name`="time_range", 
                        `title`="Time Range", 
                        `type`="text"),
                    list(
                        `name`="ibs", 
                        `title`="IBS", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ibs_ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ibs_ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="scaled_ibs", 
                        `title`="Scaled IBS", 
                        `type`="number", 
                        `visible`="(scaled_brier)"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelComparison",
                title="Model Comparison (Brier Scores)",
                visible="(compare_multiple_models || reference_model)",
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="brier_score", 
                        `title`="Brier Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="brier_ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="brier_ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="scaled_brier", 
                        `title`="Scaled Brier", 
                        `type`="number", 
                        `visible`="(scaled_brier)"),
                    list(
                        `name`="ibs", 
                        `title`="IBS", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(calculate_ibs)"),
                    list(
                        `name`="rank", 
                        `title`="Rank", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="pairwiseComparisons",
                title="Pairwise Model Comparisons",
                visible="(compare_multiple_models)",
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="brier_diff", 
                        `title`="Brier Difference", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="P-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="conclusion", 
                        `title`="Conclusion", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="calibrationTable",
                title="Calibration Groups",
                visible="(plot_calibration_curve)",
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Risk Group", 
                        `type`="integer"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="mean_predicted", 
                        `title`="Mean Predicted Survival", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="observed_survival", 
                        `title`="Observed Survival (KM)", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="calibration_error", 
                        `title`="Calibration Error", 
                        `type`="number"),
                    list(
                        `name`="hosmer_lemeshow_contrib", 
                        `title`="HL Contribution", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="stratifiedBrier",
                title="Stratified Brier Scores",
                visible="(stratified_brier)",
                columns=list(
                    list(
                        `name`="stratum", 
                        `title`="Stratum", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="brier_score", 
                        `title`="Brier Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="brier_ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="brier_ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="scaled_brier", 
                        `title`="Scaled Brier", 
                        `type`="number", 
                        `visible`="(scaled_brier)"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="brierOverTimePlot",
                title="Brier Score Over Time",
                width=600,
                height=500,
                renderFun=".plotBrierOverTime",
                visible="(plot_brier_over_time)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="calibrationPlot",
                title="Calibration Curve",
                width=600,
                height=500,
                renderFun=".plotCalibrationCurve",
                visible="(plot_calibration_curve)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="modelComparisonPlot",
                title="Model Comparison",
                width=600,
                height=500,
                renderFun=".plotModelComparison",
                visible="(plot_model_comparison && (compare_multiple_models || reference_model))"))
            self$add(jmvcore::Image$new(
                options=options,
                name="integratedBrierPlot",
                title="Integrated Brier Score Visualization",
                width=600,
                height=500,
                renderFun=".plotIntegratedBrier",
                visible="(plot_integrated_brier && calculate_ibs)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation",
                visible=TRUE))}))

brierscoreBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "brierscoreBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "brierscore",
                version = c(0,0,32),
                options = options,
                results = brierscoreResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Brier Score & Integrated Brier Score
#'
#' ⚠️ IMPORTANT LIMITATIONS: This is a BASIC implementation for single 
#' time-point Brier score evaluation. It requires PRE-COMPUTED survival 
#' probabilities (not raw Cox models). Many features listed below are NOT 
#' IMPLEMENTED or STATISTICALLY INVALID.
#' Brier Score analysis evaluates calibration accuracy by measuring the mean 
#' squared difference between predicted survival probabilities and observed 
#' outcomes at a SINGLE specified time point. Lower Brier scores indicate 
#' better prediction accuracy (perfect prediction = 0, worst = 1). Includes 
#' scaled Brier scores relative to null model (Kaplan-Meier curve).
#' ⚠️ NOT SUPPORTED: Multiple time points, Integrated Brier Score (IBS), 
#' competing risks, linear predictor inputs, formula inputs, temporal/external 
#' validation flags. These features may appear in the UI but will generate 
#' errors if used.
#' For rigorous clinical validation, use established packages: 
#' riskRegression::Score() or pec::pec(). This implementation has NOT been 
#' validated against those standards.
#' 
#'
#' @examples
#' result <- brierscore(
#'     data = validation_data,
#'     time = "follow_up_time",
#'     event = "death",
#'     predictions = "predicted_survival_prob",
#'     prediction_time = 60
#' )
#'
#' @param data The data as a data frame.
#' @param time Time-to-event or censoring variable. For survival analysis,
#'   this is the follow-up time in days, months, or years.
#' @param event Binary event indicator variable (1 = event occurred, 0 =
#'   censored). For competing risks, can be multi-level factor.
#' @param event_code Which level of the event variable represents the event of
#'   interest (e.g., death, progression, recurrence).
#' @param predicted_survival Pre-computed survival probabilities at the
#'   specified prediction time. Should be between 0 and 1. For example,
#'   predicted 5-year survival probability from a Cox model or machine learning
#'   algorithm.
#' @param linear_predictor Linear predictor from Cox model (log hazard ratio).
#'   If provided instead of predicted_survival, survival probabilities will be
#'   computed using Breslow estimator and baseline hazard.
#' @param prediction_formula Formula for prediction model if neither
#'   predicted_survival nor linear_predictor is provided. Example: "~ age +
#'   stage + grade". Cox model will be fitted internally and predictions
#'   generated.
#' @param prediction_time Time point at which to evaluate Brier score (in same
#'   units as time variable). For example, 60 months for 5-year predictions,
#'   1825 days for 5-year predictions in days.
#' @param multiple_time_points Calculate Brier scores at multiple time points
#'   to show how calibration changes over time.
#' @param time_points Comma-separated list of additional time points for
#'   evaluation. Example: "12, 24, 36, 60" for 1, 2, 3, and 5 years (in months).
#' @param calculate_ibs Calculate Integrated Brier Score by integrating
#'   time-dependent Brier score across follow-up period. Provides single summary
#'   measure of overall prediction performance across time. Computationally
#'   expensive.
#' @param ibs_start_time Start time for IBS integration. Usually 0 to include
#'   entire follow-up period.
#' @param ibs_end_time End time for IBS integration. Should not exceed maximum
#'   follow-up time. Determines the time horizon over which prediction
#'   performance is summarized.
#' @param scaled_brier Calculate scaled (standardized) Brier score relative to
#'   null model (Kaplan-Meier survival curve). Scaled Brier = 1 - (Brier_model /
#'   Brier_null). Values near 0 indicate no improvement over KM, positive values
#'   indicate better predictions than KM.
#' @param reference_model Compare Brier score to a reference prediction model
#'   to assess incremental value of new predictors.
#' @param reference_predictions Pre-computed survival probabilities from
#'   reference model for comparison.
#' @param reference_formula Formula for reference model if
#'   reference_predictions not provided. Example: "~ age + stage" (simpler than
#'   full model).
#' @param confidence_intervals Calculate confidence intervals for Brier scores
#'   using bootstrap or influence function methods. Bootstrap method is
#'   computationally expensive.
#' @param ci_method Method for confidence interval estimation. Bootstrap is
#'   more accurate but computationally intensive, influence function is faster.
#' @param bootstrap_samples Number of bootstrap samples for confidence
#'   interval estimation. More samples provide more stable estimates.
#' @param confidence_level Confidence level for interval estimation.
#' @param compare_multiple_models Compare Brier scores across multiple
#'   prediction models to identify the best calibrated model.
#' @param additional_predictions Additional prediction variables (survival
#'   probabilities) from competing models for comparison.
#' @param model_names Comma-separated names for prediction models being
#'   compared. Used for labeling output tables and plots.
#' @param competing_risks Use competing risks framework when multiple event
#'   types can occur. Brier score accounts for cumulative incidence rather than
#'   survival.
#' @param cause_specific For competing risks, calculate cause-specific Brier
#'   score for the event of interest.
#' @param plot_brier_over_time Plot time-dependent Brier score across
#'   follow-up period. Shows how prediction accuracy changes over time.
#' @param plot_calibration_curve Display calibration curve showing agreement
#'   between predicted and observed survival probabilities. Perfect calibration
#'   appears as 45° line.
#' @param calibration_groups Number of risk groups for calibration curve
#'   (e.g., deciles = 10). More groups provide finer resolution but require
#'   larger sample size.
#' @param plot_model_comparison Bar plot comparing Brier scores across
#'   multiple models with confidence intervals.
#' @param plot_integrated_brier Visualize IBS as area under the Brier score
#'   curve over time.
#' @param stratified_brier Calculate Brier scores stratified by important
#'   subgroups to assess calibration consistency across populations.
#' @param stratify_by Variable for stratified analysis (e.g., treatment arm,
#'   age group, center).
#' @param inverse_probability_weighting Use inverse probability of censoring
#'   weighting (IPCW) to handle censored observations. Recommended for proper
#'   Brier score estimation.
#' @param external_validation Indicate this is external validation (model
#'   developed on different dataset). Affects interpretation and may trigger
#'   additional diagnostics.
#' @param temporal_validation Indicate this is temporal validation (more
#'   recent patients than development cohort). May assess calibration drift over
#'   time.
#' @param development_period End date of development period for temporal
#'   validation assessment (format: YYYY-MM-DD).
#' @param missing_handling Method for handling missing predictor or outcome
#'   data.
#' @param random_seed Random seed for bootstrap sampling and other stochastic
#'   procedures.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$brierSummary} \tab \tab \tab \tab \tab Summary of Brier score at specified time point(s) \cr
#'   \code{results$integratedBrier} \tab \tab \tab \tab \tab Integrated Brier score over time period \cr
#'   \code{results$modelComparison} \tab \tab \tab \tab \tab Comparison of Brier scores across multiple models \cr
#'   \code{results$pairwiseComparisons} \tab \tab \tab \tab \tab Statistical tests comparing Brier scores between models \cr
#'   \code{results$calibrationTable} \tab \tab \tab \tab \tab Predicted vs observed survival by risk group \cr
#'   \code{results$stratifiedBrier} \tab \tab \tab \tab \tab Brier scores by subgroup \cr
#'   \code{results$brierOverTimePlot} \tab \tab \tab \tab \tab Time-dependent Brier score across follow-up period \cr
#'   \code{results$calibrationPlot} \tab \tab \tab \tab \tab Predicted vs observed survival probabilities \cr
#'   \code{results$modelComparisonPlot} \tab \tab \tab \tab \tab Bar plot comparing Brier scores across models \cr
#'   \code{results$integratedBrierPlot} \tab \tab \tab \tab \tab Area under Brier score curve \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$brierSummary$asDF}
#'
#' \code{as.data.frame(results$brierSummary)}
#'
#' @export
brierscore <- function(
    data,
    time,
    event,
    event_code,
    predicted_survival,
    linear_predictor,
    prediction_formula = "",
    prediction_time = 60,
    multiple_time_points = FALSE,
    time_points = "12, 36, 60",
    calculate_ibs = FALSE,
    ibs_start_time = 0,
    ibs_end_time = 60,
    scaled_brier = TRUE,
    reference_model = FALSE,
    reference_predictions,
    reference_formula = "",
    confidence_intervals = FALSE,
    ci_method = "bootstrap",
    bootstrap_samples = 500,
    confidence_level = 0.95,
    compare_multiple_models = FALSE,
    additional_predictions,
    model_names = "Model 1, Model 2, Model 3",
    competing_risks = FALSE,
    cause_specific = TRUE,
    plot_brier_over_time = TRUE,
    plot_calibration_curve = FALSE,
    calibration_groups = 10,
    plot_model_comparison = FALSE,
    plot_integrated_brier = FALSE,
    stratified_brier = FALSE,
    stratify_by,
    inverse_probability_weighting = TRUE,
    external_validation = FALSE,
    temporal_validation = FALSE,
    development_period = "",
    missing_handling = "complete",
    random_seed = 123) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("brierscore requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(event)) event <- jmvcore::resolveQuo(jmvcore::enquo(event))
    if ( ! missing(predicted_survival)) predicted_survival <- jmvcore::resolveQuo(jmvcore::enquo(predicted_survival))
    if ( ! missing(linear_predictor)) linear_predictor <- jmvcore::resolveQuo(jmvcore::enquo(linear_predictor))
    if ( ! missing(reference_predictions)) reference_predictions <- jmvcore::resolveQuo(jmvcore::enquo(reference_predictions))
    if ( ! missing(additional_predictions)) additional_predictions <- jmvcore::resolveQuo(jmvcore::enquo(additional_predictions))
    if ( ! missing(stratify_by)) stratify_by <- jmvcore::resolveQuo(jmvcore::enquo(stratify_by))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(event), event, NULL),
            `if`( ! missing(predicted_survival), predicted_survival, NULL),
            `if`( ! missing(linear_predictor), linear_predictor, NULL),
            `if`( ! missing(reference_predictions), reference_predictions, NULL),
            `if`( ! missing(additional_predictions), additional_predictions, NULL),
            `if`( ! missing(stratify_by), stratify_by, NULL))

    for (v in stratify_by) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- brierscoreOptions$new(
        time = time,
        event = event,
        event_code = event_code,
        predicted_survival = predicted_survival,
        linear_predictor = linear_predictor,
        prediction_formula = prediction_formula,
        prediction_time = prediction_time,
        multiple_time_points = multiple_time_points,
        time_points = time_points,
        calculate_ibs = calculate_ibs,
        ibs_start_time = ibs_start_time,
        ibs_end_time = ibs_end_time,
        scaled_brier = scaled_brier,
        reference_model = reference_model,
        reference_predictions = reference_predictions,
        reference_formula = reference_formula,
        confidence_intervals = confidence_intervals,
        ci_method = ci_method,
        bootstrap_samples = bootstrap_samples,
        confidence_level = confidence_level,
        compare_multiple_models = compare_multiple_models,
        additional_predictions = additional_predictions,
        model_names = model_names,
        competing_risks = competing_risks,
        cause_specific = cause_specific,
        plot_brier_over_time = plot_brier_over_time,
        plot_calibration_curve = plot_calibration_curve,
        calibration_groups = calibration_groups,
        plot_model_comparison = plot_model_comparison,
        plot_integrated_brier = plot_integrated_brier,
        stratified_brier = stratified_brier,
        stratify_by = stratify_by,
        inverse_probability_weighting = inverse_probability_weighting,
        external_validation = external_validation,
        temporal_validation = temporal_validation,
        development_period = development_period,
        missing_handling = missing_handling,
        random_seed = random_seed)

    analysis <- brierscoreClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

