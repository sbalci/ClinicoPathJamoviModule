
# This file is automatically generated, you probably don't want to edit this

consortdiagramOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "consortdiagramOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            participant_id = NULL,
            screening_exclusions = NULL,
            enrollment_exclusions = NULL,
            randomization_var = NULL,
            allocation_exclusions = NULL,
            followup_exclusions = NULL,
            analysis_exclusions = NULL,
            show_exclusion_details = FALSE,
            diagram_width = 800,
            diagram_height = 600,
            text_width = 50,
            study_title = "Study Flow Diagram",
            screening_label = "Assessed for eligibility",
            enrollment_label = "Enrolled",
            allocation_label = "Allocated to intervention",
            followup_label = "Completed follow-up",
            analysis_label = "Analyzed",
            export_format = "png",
            include_interpretation = FALSE,
            consort_validation = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="consortdiagram",
                requiresData=TRUE,
                ...)

            private$..participant_id <- jmvcore::OptionVariable$new(
                "participant_id",
                participant_id,
                suggested=list(
                    "id"),
                permitted=list(
                    "factor",
                    "numeric",
                    "id"))
            private$..screening_exclusions <- jmvcore::OptionVariables$new(
                "screening_exclusions",
                screening_exclusions,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..enrollment_exclusions <- jmvcore::OptionVariables$new(
                "enrollment_exclusions",
                enrollment_exclusions,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..randomization_var <- jmvcore::OptionVariable$new(
                "randomization_var",
                randomization_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..allocation_exclusions <- jmvcore::OptionVariables$new(
                "allocation_exclusions",
                allocation_exclusions,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..followup_exclusions <- jmvcore::OptionVariables$new(
                "followup_exclusions",
                followup_exclusions,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..analysis_exclusions <- jmvcore::OptionVariables$new(
                "analysis_exclusions",
                analysis_exclusions,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..show_exclusion_details <- jmvcore::OptionBool$new(
                "show_exclusion_details",
                show_exclusion_details,
                default=FALSE)
            private$..diagram_width <- jmvcore::OptionNumber$new(
                "diagram_width",
                diagram_width,
                min=600,
                max=1200,
                default=800)
            private$..diagram_height <- jmvcore::OptionNumber$new(
                "diagram_height",
                diagram_height,
                min=400,
                max=1000,
                default=600)
            private$..text_width <- jmvcore::OptionInteger$new(
                "text_width",
                text_width,
                min=20,
                max=100,
                default=50)
            private$..study_title <- jmvcore::OptionString$new(
                "study_title",
                study_title,
                default="Study Flow Diagram")
            private$..screening_label <- jmvcore::OptionString$new(
                "screening_label",
                screening_label,
                default="Assessed for eligibility")
            private$..enrollment_label <- jmvcore::OptionString$new(
                "enrollment_label",
                enrollment_label,
                default="Enrolled")
            private$..allocation_label <- jmvcore::OptionString$new(
                "allocation_label",
                allocation_label,
                default="Allocated to intervention")
            private$..followup_label <- jmvcore::OptionString$new(
                "followup_label",
                followup_label,
                default="Completed follow-up")
            private$..analysis_label <- jmvcore::OptionString$new(
                "analysis_label",
                analysis_label,
                default="Analyzed")
            private$..export_format <- jmvcore::OptionList$new(
                "export_format",
                export_format,
                options=list(
                    "png",
                    "svg",
                    "pdf"),
                default="png")
            private$..include_interpretation <- jmvcore::OptionBool$new(
                "include_interpretation",
                include_interpretation,
                default=FALSE)
            private$..consort_validation <- jmvcore::OptionBool$new(
                "consort_validation",
                consort_validation,
                default=FALSE)

            self$.addOption(private$..participant_id)
            self$.addOption(private$..screening_exclusions)
            self$.addOption(private$..enrollment_exclusions)
            self$.addOption(private$..randomization_var)
            self$.addOption(private$..allocation_exclusions)
            self$.addOption(private$..followup_exclusions)
            self$.addOption(private$..analysis_exclusions)
            self$.addOption(private$..show_exclusion_details)
            self$.addOption(private$..diagram_width)
            self$.addOption(private$..diagram_height)
            self$.addOption(private$..text_width)
            self$.addOption(private$..study_title)
            self$.addOption(private$..screening_label)
            self$.addOption(private$..enrollment_label)
            self$.addOption(private$..allocation_label)
            self$.addOption(private$..followup_label)
            self$.addOption(private$..analysis_label)
            self$.addOption(private$..export_format)
            self$.addOption(private$..include_interpretation)
            self$.addOption(private$..consort_validation)
        }),
    active = list(
        participant_id = function() private$..participant_id$value,
        screening_exclusions = function() private$..screening_exclusions$value,
        enrollment_exclusions = function() private$..enrollment_exclusions$value,
        randomization_var = function() private$..randomization_var$value,
        allocation_exclusions = function() private$..allocation_exclusions$value,
        followup_exclusions = function() private$..followup_exclusions$value,
        analysis_exclusions = function() private$..analysis_exclusions$value,
        show_exclusion_details = function() private$..show_exclusion_details$value,
        diagram_width = function() private$..diagram_width$value,
        diagram_height = function() private$..diagram_height$value,
        text_width = function() private$..text_width$value,
        study_title = function() private$..study_title$value,
        screening_label = function() private$..screening_label$value,
        enrollment_label = function() private$..enrollment_label$value,
        allocation_label = function() private$..allocation_label$value,
        followup_label = function() private$..followup_label$value,
        analysis_label = function() private$..analysis_label$value,
        export_format = function() private$..export_format$value,
        include_interpretation = function() private$..include_interpretation$value,
        consort_validation = function() private$..consort_validation$value),
    private = list(
        ..participant_id = NA,
        ..screening_exclusions = NA,
        ..enrollment_exclusions = NA,
        ..randomization_var = NA,
        ..allocation_exclusions = NA,
        ..followup_exclusions = NA,
        ..analysis_exclusions = NA,
        ..show_exclusion_details = NA,
        ..diagram_width = NA,
        ..diagram_height = NA,
        ..text_width = NA,
        ..study_title = NA,
        ..screening_label = NA,
        ..enrollment_label = NA,
        ..allocation_label = NA,
        ..followup_label = NA,
        ..analysis_label = NA,
        ..export_format = NA,
        ..include_interpretation = NA,
        ..consort_validation = NA)
)

consortdiagramResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "consortdiagramResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        flowSummary = function() private$.items[["flowSummary"]],
        armSummary = function() private$.items[["armSummary"]],
        exclusionBreakdown = function() private$.items[["exclusionBreakdown"]],
        diagram = function() private$.items[["diagram"]],
        interpretation = function() private$.items[["interpretation"]],
        consortValidation = function() private$.items[["consortValidation"]],
        exportInfo = function() private$.items[["exportInfo"]],
        clinicalSummary = function() private$.items[["clinicalSummary"]],
        aboutAnalysis = function() private$.items[["aboutAnalysis"]],
        caveatsAssumptions = function() private$.items[["caveatsAssumptions"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="CONSORT Flow Diagram",
                refs=list(
                    "CONSORT",
                    "consort",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Welcome",
                visible="(!participant_id)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="flowSummary",
                title="Participant Flow Summary",
                rows=0,
                columns=list(
                    list(
                        `name`="stage", 
                        `title`="Stage", 
                        `type`="text"),
                    list(
                        `name`="n_remaining", 
                        `title`="Remaining (n)", 
                        `type`="integer"),
                    list(
                        `name`="n_excluded", 
                        `title`="Excluded (n)", 
                        `type`="integer"),
                    list(
                        `name`="pct_retained", 
                        `title`="Retained (%)", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="exclusion_details", 
                        `title`="Exclusion Reasons", 
                        `type`="text")),
                clearWith=list(
                    "participant_id",
                    "screening_exclusions",
                    "enrollment_exclusions",
                    "randomization_var",
                    "allocation_exclusions",
                    "followup_exclusions",
                    "analysis_exclusions")))
            self$add(jmvcore::Table$new(
                options=options,
                name="armSummary",
                title="Flow by Treatment Arm",
                visible="(randomization_var)",
                rows=0,
                columns=list(
                    list(
                        `name`="arm", 
                        `title`="Treatment Arm", 
                        `type`="text"),
                    list(
                        `name`="allocated", 
                        `title`="Allocated (n)", 
                        `type`="integer"),
                    list(
                        `name`="received", 
                        `title`="Received Intervention (n)", 
                        `type`="integer"),
                    list(
                        `name`="completed_followup", 
                        `title`="Completed Follow-up (n)", 
                        `type`="integer"),
                    list(
                        `name`="analyzed", 
                        `title`="Analyzed (n)", 
                        `type`="integer"),
                    list(
                        `name`="retention_rate", 
                        `title`="Retention Rate (%)", 
                        `type`="number", 
                        `format`="pc")),
                clearWith=list(
                    "randomization_var",
                    "allocation_exclusions",
                    "followup_exclusions",
                    "analysis_exclusions")))
            self$add(jmvcore::Table$new(
                options=options,
                name="exclusionBreakdown",
                title="Detailed Exclusion Breakdown",
                visible="(show_exclusion_details)",
                rows=0,
                columns=list(
                    list(
                        `name`="stage", 
                        `title`="Stage", 
                        `type`="text"),
                    list(
                        `name`="reason", 
                        `title`="Exclusion Reason", 
                        `type`="text"),
                    list(
                        `name`="count", 
                        `title`="Count (n)", 
                        `type`="integer"),
                    list(
                        `name`="percentage", 
                        `title`="Percentage of Stage (%)", 
                        `type`="number", 
                        `format`="pc")),
                clearWith=list(
                    "screening_exclusions",
                    "enrollment_exclusions",
                    "allocation_exclusions",
                    "followup_exclusions",
                    "analysis_exclusions")))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagram",
                title="CONSORT Flow Diagram",
                width=800,
                height=600,
                renderFun=".plot",
                requiresData=TRUE,
                clearWith=list(
                    "participant_id",
                    "screening_exclusions",
                    "enrollment_exclusions",
                    "randomization_var",
                    "allocation_exclusions",
                    "followup_exclusions",
                    "analysis_exclusions",
                    "show_percentages",
                    "show_exclusion_details",
                    "diagram_width",
                    "diagram_height",
                    "text_width",
                    "study_title",
                    "screening_label",
                    "enrollment_label",
                    "allocation_label",
                    "followup_label",
                    "analysis_label"),
                refs=list(
                    "consort",
                    "CONSORT")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation",
                visible="(include_interpretation)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="consortValidation",
                title="CONSORT 2010 Compliance Checklist",
                visible="(consort_validation)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="exportInfo",
                title="Export Information"))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalSummary",
                title="Clinical Summary",
                visible="(include_interpretation)",
                clearWith=list(
                    "participant_id",
                    "screening_exclusions",
                    "enrollment_exclusions",
                    "allocation_exclusions",
                    "followup_exclusions",
                    "analysis_exclusions")))
            self$add(jmvcore::Html$new(
                options=options,
                name="aboutAnalysis",
                title="About CONSORT Diagrams",
                visible="(include_interpretation)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="caveatsAssumptions",
                title="Caveats & Assumptions",
                visible="(include_interpretation)"))}))

consortdiagramBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "consortdiagramBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "consortdiagram",
                version = c(1,0,0),
                options = options,
                results = consortdiagramResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' CONSORT Flow Diagram
#'
#' Creates CONSORT 2010 compliant flow diagrams for clinical trials using the 
#' consort R package.
#' Automatically calculates participant numbers from patient-level data with 
#' exclusion columns.
#' Follows the approach described by Riinu Ots 
#' (https://www.riinu.me/2024/02/consort/).
#' 
#'
#' @examples
#' # Prepare data with exclusion columns
#' # Each row = one participant
#' # Non-NA values in exclusion columns indicate exclusion at that stage
#' # Example:
#' # data with columns: id, age_exclusion, consent_exclusion, randomization_arm
#'
#' @param data Patient-level data frame where each row represents one
#'   participant. Exclusion columns should have non-NA values for excluded
#'   participants.
#' @param participant_id Unique participant identifier variable.
#' @param screening_exclusions List of variables representing screening-stage
#'   exclusion reasons.
#' @param enrollment_exclusions List of variables representing
#'   enrollment-stage exclusion reasons.
#' @param randomization_var Treatment arm or group assignment variable for
#'   randomized trials.
#' @param allocation_exclusions List of variables representing
#'   post-randomization exclusion reasons.
#' @param followup_exclusions List of variables representing follow-up-stage
#'   exclusion reasons.
#' @param analysis_exclusions List of variables representing analysis-stage
#'   exclusion reasons.
#' @param show_exclusion_details Whether to display detailed exclusion reasons
#'   with counts.
#' @param diagram_width Diagram width in pixels.
#' @param diagram_height Diagram height in pixels.
#' @param text_width Maximum characters before text wraps in diagram boxes.
#' @param study_title Title for the CONSORT diagram.
#' @param screening_label Custom label for screening stage.
#' @param enrollment_label Custom label for enrollment stage.
#' @param allocation_label Custom label for allocation stage.
#' @param followup_label Custom label for follow-up stage.
#' @param analysis_label Custom label for analysis stage.
#' @param export_format Export format for the diagram.
#' @param include_interpretation Whether to include interpretation section.
#' @param consort_validation Whether to perform CONSORT 2010 compliance
#'   validation.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$flowSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$armSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$exclusionBreakdown} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$diagram} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$consortValidation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$exportInfo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$clinicalSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$aboutAnalysis} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$caveatsAssumptions} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$flowSummary$asDF}
#'
#' \code{as.data.frame(results$flowSummary)}
#'
#' @export
consortdiagram <- function(
    data,
    participant_id,
    screening_exclusions,
    enrollment_exclusions,
    randomization_var,
    allocation_exclusions,
    followup_exclusions,
    analysis_exclusions,
    show_exclusion_details = FALSE,
    diagram_width = 800,
    diagram_height = 600,
    text_width = 50,
    study_title = "Study Flow Diagram",
    screening_label = "Assessed for eligibility",
    enrollment_label = "Enrolled",
    allocation_label = "Allocated to intervention",
    followup_label = "Completed follow-up",
    analysis_label = "Analyzed",
    export_format = "png",
    include_interpretation = FALSE,
    consort_validation = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("consortdiagram requires jmvcore to be installed (restart may be required)")

    if ( ! missing(participant_id)) participant_id <- jmvcore::resolveQuo(jmvcore::enquo(participant_id))
    if ( ! missing(screening_exclusions)) screening_exclusions <- jmvcore::resolveQuo(jmvcore::enquo(screening_exclusions))
    if ( ! missing(enrollment_exclusions)) enrollment_exclusions <- jmvcore::resolveQuo(jmvcore::enquo(enrollment_exclusions))
    if ( ! missing(randomization_var)) randomization_var <- jmvcore::resolveQuo(jmvcore::enquo(randomization_var))
    if ( ! missing(allocation_exclusions)) allocation_exclusions <- jmvcore::resolveQuo(jmvcore::enquo(allocation_exclusions))
    if ( ! missing(followup_exclusions)) followup_exclusions <- jmvcore::resolveQuo(jmvcore::enquo(followup_exclusions))
    if ( ! missing(analysis_exclusions)) analysis_exclusions <- jmvcore::resolveQuo(jmvcore::enquo(analysis_exclusions))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(participant_id), participant_id, NULL),
            `if`( ! missing(screening_exclusions), screening_exclusions, NULL),
            `if`( ! missing(enrollment_exclusions), enrollment_exclusions, NULL),
            `if`( ! missing(randomization_var), randomization_var, NULL),
            `if`( ! missing(allocation_exclusions), allocation_exclusions, NULL),
            `if`( ! missing(followup_exclusions), followup_exclusions, NULL),
            `if`( ! missing(analysis_exclusions), analysis_exclusions, NULL))

    for (v in randomization_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- consortdiagramOptions$new(
        participant_id = participant_id,
        screening_exclusions = screening_exclusions,
        enrollment_exclusions = enrollment_exclusions,
        randomization_var = randomization_var,
        allocation_exclusions = allocation_exclusions,
        followup_exclusions = followup_exclusions,
        analysis_exclusions = analysis_exclusions,
        show_exclusion_details = show_exclusion_details,
        diagram_width = diagram_width,
        diagram_height = diagram_height,
        text_width = text_width,
        study_title = study_title,
        screening_label = screening_label,
        enrollment_label = enrollment_label,
        allocation_label = allocation_label,
        followup_label = followup_label,
        analysis_label = analysis_label,
        export_format = export_format,
        include_interpretation = include_interpretation,
        consort_validation = consort_validation)

    analysis <- consortdiagramClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

