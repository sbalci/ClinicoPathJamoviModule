
# This file is automatically generated, you probably don't want to edit this

generalizedrocOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "generalizedrocOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            outcome = NULL,
            predictor = NULL,
            assume_equal_variance = FALSE,
            transformation = "none",
            distribution_model = "normal",
            calculate_auc = TRUE,
            confidence_intervals = TRUE,
            ci_method = "bootstrap",
            bootstrap_samples = 1000,
            confidence_level = 0.95,
            show_diagnostics = TRUE,
            variance_test = "levene",
            optimal_threshold = TRUE,
            plot_roc = TRUE,
            plot_distributions = TRUE,
            plot_diagnostic = FALSE,
            random_seed = 42,
            use_tram = FALSE,
            covariates = NULL,
            tram_model = "Colr",
            covariate_values = "0, 0.5, 1",
            plot_covariate_roc = TRUE,
            plot_auc_vs_covariate = TRUE,
            n_covariate_points = 50,
            tram_constraints = "none",
            censoring_aware = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="generalizedroc",
                requiresData=TRUE,
                ...)

            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..predictor <- jmvcore::OptionVariable$new(
                "predictor",
                predictor,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..assume_equal_variance <- jmvcore::OptionBool$new(
                "assume_equal_variance",
                assume_equal_variance,
                default=FALSE)
            private$..transformation <- jmvcore::OptionList$new(
                "transformation",
                transformation,
                options=list(
                    "none",
                    "log",
                    "sqrt",
                    "boxcox"),
                default="none")
            private$..distribution_model <- jmvcore::OptionList$new(
                "distribution_model",
                distribution_model,
                options=list(
                    "normal",
                    "empirical",
                    "kernel"),
                default="normal")
            private$..calculate_auc <- jmvcore::OptionBool$new(
                "calculate_auc",
                calculate_auc,
                default=TRUE)
            private$..confidence_intervals <- jmvcore::OptionBool$new(
                "confidence_intervals",
                confidence_intervals,
                default=TRUE)
            private$..ci_method <- jmvcore::OptionList$new(
                "ci_method",
                ci_method,
                options=list(
                    "bootstrap",
                    "asymptotic"),
                default="bootstrap")
            private$..bootstrap_samples <- jmvcore::OptionNumber$new(
                "bootstrap_samples",
                bootstrap_samples,
                min=100,
                max=10000,
                default=1000)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..show_diagnostics <- jmvcore::OptionBool$new(
                "show_diagnostics",
                show_diagnostics,
                default=TRUE)
            private$..variance_test <- jmvcore::OptionList$new(
                "variance_test",
                variance_test,
                options=list(
                    "levene",
                    "fligner",
                    "bartlett"),
                default="levene")
            private$..optimal_threshold <- jmvcore::OptionBool$new(
                "optimal_threshold",
                optimal_threshold,
                default=TRUE)
            private$..plot_roc <- jmvcore::OptionBool$new(
                "plot_roc",
                plot_roc,
                default=TRUE)
            private$..plot_distributions <- jmvcore::OptionBool$new(
                "plot_distributions",
                plot_distributions,
                default=TRUE)
            private$..plot_diagnostic <- jmvcore::OptionBool$new(
                "plot_diagnostic",
                plot_diagnostic,
                default=FALSE)
            private$..random_seed <- jmvcore::OptionNumber$new(
                "random_seed",
                random_seed,
                min=1,
                max=999999,
                default=42)
            private$..use_tram <- jmvcore::OptionBool$new(
                "use_tram",
                use_tram,
                default=FALSE)
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..tram_model <- jmvcore::OptionList$new(
                "tram_model",
                tram_model,
                options=list(
                    "Colr",
                    "BoxCox",
                    "Lehmann",
                    "Polr"),
                default="Colr")
            private$..covariate_values <- jmvcore::OptionString$new(
                "covariate_values",
                covariate_values,
                default="0, 0.5, 1")
            private$..plot_covariate_roc <- jmvcore::OptionBool$new(
                "plot_covariate_roc",
                plot_covariate_roc,
                default=TRUE)
            private$..plot_auc_vs_covariate <- jmvcore::OptionBool$new(
                "plot_auc_vs_covariate",
                plot_auc_vs_covariate,
                default=TRUE)
            private$..n_covariate_points <- jmvcore::OptionInteger$new(
                "n_covariate_points",
                n_covariate_points,
                default=50,
                min=10,
                max=200)
            private$..tram_constraints <- jmvcore::OptionList$new(
                "tram_constraints",
                tram_constraints,
                options=list(
                    "none",
                    "increasing",
                    "decreasing"),
                default="none")
            private$..censoring_aware <- jmvcore::OptionBool$new(
                "censoring_aware",
                censoring_aware,
                default=FALSE)

            self$.addOption(private$..outcome)
            self$.addOption(private$..predictor)
            self$.addOption(private$..assume_equal_variance)
            self$.addOption(private$..transformation)
            self$.addOption(private$..distribution_model)
            self$.addOption(private$..calculate_auc)
            self$.addOption(private$..confidence_intervals)
            self$.addOption(private$..ci_method)
            self$.addOption(private$..bootstrap_samples)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..show_diagnostics)
            self$.addOption(private$..variance_test)
            self$.addOption(private$..optimal_threshold)
            self$.addOption(private$..plot_roc)
            self$.addOption(private$..plot_distributions)
            self$.addOption(private$..plot_diagnostic)
            self$.addOption(private$..random_seed)
            self$.addOption(private$..use_tram)
            self$.addOption(private$..covariates)
            self$.addOption(private$..tram_model)
            self$.addOption(private$..covariate_values)
            self$.addOption(private$..plot_covariate_roc)
            self$.addOption(private$..plot_auc_vs_covariate)
            self$.addOption(private$..n_covariate_points)
            self$.addOption(private$..tram_constraints)
            self$.addOption(private$..censoring_aware)
        }),
    active = list(
        outcome = function() private$..outcome$value,
        predictor = function() private$..predictor$value,
        assume_equal_variance = function() private$..assume_equal_variance$value,
        transformation = function() private$..transformation$value,
        distribution_model = function() private$..distribution_model$value,
        calculate_auc = function() private$..calculate_auc$value,
        confidence_intervals = function() private$..confidence_intervals$value,
        ci_method = function() private$..ci_method$value,
        bootstrap_samples = function() private$..bootstrap_samples$value,
        confidence_level = function() private$..confidence_level$value,
        show_diagnostics = function() private$..show_diagnostics$value,
        variance_test = function() private$..variance_test$value,
        optimal_threshold = function() private$..optimal_threshold$value,
        plot_roc = function() private$..plot_roc$value,
        plot_distributions = function() private$..plot_distributions$value,
        plot_diagnostic = function() private$..plot_diagnostic$value,
        random_seed = function() private$..random_seed$value,
        use_tram = function() private$..use_tram$value,
        covariates = function() private$..covariates$value,
        tram_model = function() private$..tram_model$value,
        covariate_values = function() private$..covariate_values$value,
        plot_covariate_roc = function() private$..plot_covariate_roc$value,
        plot_auc_vs_covariate = function() private$..plot_auc_vs_covariate$value,
        n_covariate_points = function() private$..n_covariate_points$value,
        tram_constraints = function() private$..tram_constraints$value,
        censoring_aware = function() private$..censoring_aware$value),
    private = list(
        ..outcome = NA,
        ..predictor = NA,
        ..assume_equal_variance = NA,
        ..transformation = NA,
        ..distribution_model = NA,
        ..calculate_auc = NA,
        ..confidence_intervals = NA,
        ..ci_method = NA,
        ..bootstrap_samples = NA,
        ..confidence_level = NA,
        ..show_diagnostics = NA,
        ..variance_test = NA,
        ..optimal_threshold = NA,
        ..plot_roc = NA,
        ..plot_distributions = NA,
        ..plot_diagnostic = NA,
        ..random_seed = NA,
        ..use_tram = NA,
        ..covariates = NA,
        ..tram_model = NA,
        ..covariate_values = NA,
        ..plot_covariate_roc = NA,
        ..plot_auc_vs_covariate = NA,
        ..n_covariate_points = NA,
        ..tram_constraints = NA,
        ..censoring_aware = NA)
)

generalizedrocResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "generalizedrocResults",
    inherit = jmvcore::Group,
    active = list(
        instructionsText = function() private$.items[["instructionsText"]],
        aucTable = function() private$.items[["aucTable"]],
        parametersTable = function() private$.items[["parametersTable"]],
        diagnosticsTable = function() private$.items[["diagnosticsTable"]],
        thresholdTable = function() private$.items[["thresholdTable"]],
        rocPlot = function() private$.items[["rocPlot"]],
        distributionPlot = function() private$.items[["distributionPlot"]],
        qqPlot = function() private$.items[["qqPlot"]],
        interpretationText = function() private$.items[["interpretationText"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Generalized ROC Analysis")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructionsText",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="aucTable",
                title="Generalized ROC Performance",
                rows=1,
                visible="(calculate_auc)",
                clearWith=list(
                    "outcome",
                    "predictor",
                    "assume_equal_variance",
                    "transformation"),
                columns=list(
                    list(
                        `name`="auc", 
                        `title`="AUC", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto,pvalue", 
                        `visible`="(confidence_intervals)"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto,pvalue", 
                        `visible`="(confidence_intervals)"),
                    list(
                        `name`="se", 
                        `title`="Standard Error", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="parametersTable",
                title="Distribution Parameters",
                visible="(distribution_model:normal)",
                clearWith=list(
                    "outcome",
                    "predictor",
                    "transformation"),
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text", 
                        `combineBelow`=TRUE),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="mean", 
                        `title`="Mean", 
                        `type`="number"),
                    list(
                        `name`="sd", 
                        `title`="SD", 
                        `type`="number"),
                    list(
                        `name`="variance", 
                        `title`="Variance", 
                        `type`="number"),
                    list(
                        `name`="skewness", 
                        `title`="Skewness", 
                        `type`="number"),
                    list(
                        `name`="kurtosis", 
                        `title`="Kurtosis", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="diagnosticsTable",
                title="Distribution Diagnostics",
                visible="(show_diagnostics)",
                clearWith=list(
                    "outcome",
                    "predictor",
                    "transformation",
                    "variance_test"),
                columns=list(
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="result", 
                        `title`="Result", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="thresholdTable",
                title="Optimal Threshold Analysis",
                rows=1,
                visible="(optimal_threshold)",
                clearWith=list(
                    "outcome",
                    "predictor",
                    "transformation"),
                columns=list(
                    list(
                        `name`="threshold", 
                        `title`="Optimal Threshold", 
                        `type`="number"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="youden", 
                        `title`="Youden's J", 
                        `type`="number"),
                    list(
                        `name`="ppv", 
                        `title`="PPV", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="npv", 
                        `title`="NPV", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="rocPlot",
                title="Generalized ROC Curve",
                width=600,
                height=500,
                renderFun=".rocPlot",
                visible="(plot_roc)",
                clearWith=list(
                    "outcome",
                    "predictor",
                    "transformation",
                    "assume_equal_variance")))
            self$add(jmvcore::Image$new(
                options=options,
                name="distributionPlot",
                title="Group Distributions",
                width=600,
                height=400,
                renderFun=".distributionPlot",
                visible="(plot_distributions)",
                clearWith=list(
                    "outcome",
                    "predictor",
                    "transformation")))
            self$add(jmvcore::Image$new(
                options=options,
                name="qqPlot",
                title="Q-Q Plots for Normality Assessment",
                width=600,
                height=400,
                renderFun=".qqPlot",
                visible="(plot_diagnostic)",
                clearWith=list(
                    "outcome",
                    "predictor",
                    "transformation")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretationText",
                title="Interpretation Guide",
                visible=TRUE))}))

generalizedrocBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "generalizedrocBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "generalizedroc",
                version = c(0,0,32),
                options = options,
                results = generalizedrocResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = TRUE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Generalized ROC Analysis
#'
#' Generalized ROC (gROC) Analysis extends traditional binary ROC to handle
#' continuous or ordinal outcomes, particularly when the outcome distributions
#' have unequal variances across groups.
#' 
#' This method is particularly useful for continuous biomarkers (PD-L1 CPS,
#' Ki67 percentage), quantitative imaging features, and ordinal scales where
#' traditional ROC assumptions may be violated.
#' 
#' The generalized approach models the full distribution rather than imposing
#' binary cutoffs, providing more flexible and robust performance assessment.
#' 
#'
#' @examples
#' # Example with continuous Ki67 percentage
#' data <- data.frame(
#'   outcome = factor(sample(c("Low", "High"), 100, replace=TRUE)),
#'   ki67_percent = c(rnorm(50, 10, 5), rnorm(50, 40, 15))
#' )
#'
#' generalizedroc(
#'   data = data,
#'   outcome = 'outcome',
#'   predictor = 'ki67_percent',
#'   assume_equal_variance = FALSE,
#'   transformation = 'none'
#' )
#'
#' @param data the data as a data frame
#' @param outcome a string naming the outcome variable (binary or ordinal)
#' @param predictor a string naming the continuous predictor variable
#' @param assume_equal_variance if TRUE, assumes equal variance across groups
#'   (standard ROC); if FALSE, allows unequal variances (generalized ROC)
#' @param transformation transformation applied to predictor before analysis
#' @param distribution_model assumed distribution for each group
#' @param calculate_auc calculate area under the generalized ROC curve
#' @param confidence_intervals calculate confidence intervals for AUC and
#'   other parameters
#' @param ci_method method for confidence interval calculation
#' @param bootstrap_samples number of bootstrap samples for CI calculation
#' @param confidence_level confidence level for intervals (default: 0.95 for
#'   95\% CI)
#' @param show_diagnostics show diagnostic tests for normality and variance
#'   equality
#' @param variance_test test for equality of variances across groups
#' @param optimal_threshold find optimal threshold using Youden's index
#' @param plot_roc plot the generalized ROC curve
#' @param plot_distributions plot predictor distributions for each outcome
#'   group
#' @param plot_diagnostic plot Q-Q plots for normality assessment
#' @param random_seed random seed for reproducible bootstrap sampling
#' @param use_tram Use tram package for covariate-adjusted transformation
#'   models
#' @param covariates Covariates to include in transformation model
#' @param tram_model Type of transformation model from tram package
#' @param covariate_values Comma-separated covariate values for ROC evaluation
#' @param plot_covariate_roc Plot ROC curves as function of covariate values
#' @param plot_auc_vs_covariate Plot how AUC changes across covariate values
#' @param n_covariate_points Number of points to evaluate across covariate
#'   range
#' @param tram_constraints Constraints on transformation function
#' @param censoring_aware Use censoring-aware transformation models
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructionsText} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$aucTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$parametersTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$diagnosticsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$thresholdTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$rocPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$distributionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$qqPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$interpretationText} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$aucTable$asDF}
#'
#' \code{as.data.frame(results$aucTable)}
#'
#' @export
generalizedroc <- function(
    data,
    outcome,
    predictor,
    assume_equal_variance = FALSE,
    transformation = "none",
    distribution_model = "normal",
    calculate_auc = TRUE,
    confidence_intervals = TRUE,
    ci_method = "bootstrap",
    bootstrap_samples = 1000,
    confidence_level = 0.95,
    show_diagnostics = TRUE,
    variance_test = "levene",
    optimal_threshold = TRUE,
    plot_roc = TRUE,
    plot_distributions = TRUE,
    plot_diagnostic = FALSE,
    random_seed = 42,
    use_tram = FALSE,
    covariates = NULL,
    tram_model = "Colr",
    covariate_values = "0, 0.5, 1",
    plot_covariate_roc = TRUE,
    plot_auc_vs_covariate = TRUE,
    n_covariate_points = 50,
    tram_constraints = "none",
    censoring_aware = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("generalizedroc requires jmvcore to be installed (restart may be required)")

    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(predictor)) predictor <- jmvcore::resolveQuo(jmvcore::enquo(predictor))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(predictor), predictor, NULL),
            `if`( ! missing(covariates), covariates, NULL))

    for (v in outcome) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- generalizedrocOptions$new(
        outcome = outcome,
        predictor = predictor,
        assume_equal_variance = assume_equal_variance,
        transformation = transformation,
        distribution_model = distribution_model,
        calculate_auc = calculate_auc,
        confidence_intervals = confidence_intervals,
        ci_method = ci_method,
        bootstrap_samples = bootstrap_samples,
        confidence_level = confidence_level,
        show_diagnostics = show_diagnostics,
        variance_test = variance_test,
        optimal_threshold = optimal_threshold,
        plot_roc = plot_roc,
        plot_distributions = plot_distributions,
        plot_diagnostic = plot_diagnostic,
        random_seed = random_seed,
        use_tram = use_tram,
        covariates = covariates,
        tram_model = tram_model,
        covariate_values = covariate_values,
        plot_covariate_roc = plot_covariate_roc,
        plot_auc_vs_covariate = plot_auc_vs_covariate,
        n_covariate_points = n_covariate_points,
        tram_constraints = tram_constraints,
        censoring_aware = censoring_aware)

    analysis <- generalizedrocClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

