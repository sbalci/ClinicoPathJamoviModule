
# This file is automatically generated, you probably don't want to edit this

competingRisksPowerOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "competingRisksPowerOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            analysisType = "power",
            alpha = 0.05,
            power = 0.8,
            totalSampleSize = 200,
            allocationRatio = "1:1",
            followUpTime = 5,
            accrualTime = 2,
            eventRate1 = 0.3,
            competingRate1 = 0.2,
            eventRate2 = 0.4,
            competingRate2 = 0.2,
            hazardRatio = 1.5,
            testType = "gray",
            distributionType = "exponential",
            shape1 = 1,
            shape2 = 1,
            numberOfSimulations = 1000,
            showSimulationDetails = FALSE,
            showEducational = TRUE,
            plotPowerCurve = TRUE,
            plotEventRates = FALSE,
            sensitivityAnalysis = FALSE,
            confidenceLevel = 0.95, ...) {

            super$initialize(
                package="ClinicoPath",
                name="competingRisksPower",
                requiresData=TRUE,
                ...)

            private$..analysisType <- jmvcore::OptionList$new(
                "analysisType",
                analysisType,
                options=list(
                    "power",
                    "samplesize",
                    "effectsize",
                    "difference"),
                default="power")
            private$..alpha <- jmvcore::OptionNumber$new(
                "alpha",
                alpha,
                min=0.01,
                max=0.2,
                default=0.05)
            private$..power <- jmvcore::OptionNumber$new(
                "power",
                power,
                min=0.5,
                max=0.99,
                default=0.8)
            private$..totalSampleSize <- jmvcore::OptionNumber$new(
                "totalSampleSize",
                totalSampleSize,
                min=20,
                max=10000,
                default=200)
            private$..allocationRatio <- jmvcore::OptionString$new(
                "allocationRatio",
                allocationRatio,
                default="1:1")
            private$..followUpTime <- jmvcore::OptionNumber$new(
                "followUpTime",
                followUpTime,
                min=0.1,
                max=50,
                default=5)
            private$..accrualTime <- jmvcore::OptionNumber$new(
                "accrualTime",
                accrualTime,
                min=0.1,
                max=20,
                default=2)
            private$..eventRate1 <- jmvcore::OptionNumber$new(
                "eventRate1",
                eventRate1,
                min=0.01,
                max=0.9,
                default=0.3)
            private$..competingRate1 <- jmvcore::OptionNumber$new(
                "competingRate1",
                competingRate1,
                min=0.01,
                max=0.9,
                default=0.2)
            private$..eventRate2 <- jmvcore::OptionNumber$new(
                "eventRate2",
                eventRate2,
                min=0.01,
                max=0.9,
                default=0.4)
            private$..competingRate2 <- jmvcore::OptionNumber$new(
                "competingRate2",
                competingRate2,
                min=0.01,
                max=0.9,
                default=0.2)
            private$..hazardRatio <- jmvcore::OptionNumber$new(
                "hazardRatio",
                hazardRatio,
                min=0.1,
                max=10,
                default=1.5)
            private$..testType <- jmvcore::OptionList$new(
                "testType",
                testType,
                options=list(
                    "gray",
                    "finegray",
                    "causespecific"),
                default="gray")
            private$..distributionType <- jmvcore::OptionList$new(
                "distributionType",
                distributionType,
                options=list(
                    "exponential",
                    "weibull",
                    "lognormal"),
                default="exponential")
            private$..shape1 <- jmvcore::OptionNumber$new(
                "shape1",
                shape1,
                min=0.1,
                max=10,
                default=1)
            private$..shape2 <- jmvcore::OptionNumber$new(
                "shape2",
                shape2,
                min=0.1,
                max=10,
                default=1)
            private$..numberOfSimulations <- jmvcore::OptionNumber$new(
                "numberOfSimulations",
                numberOfSimulations,
                min=100,
                max=10000,
                default=1000)
            private$..showSimulationDetails <- jmvcore::OptionBool$new(
                "showSimulationDetails",
                showSimulationDetails,
                default=FALSE)
            private$..showEducational <- jmvcore::OptionBool$new(
                "showEducational",
                showEducational,
                default=TRUE)
            private$..plotPowerCurve <- jmvcore::OptionBool$new(
                "plotPowerCurve",
                plotPowerCurve,
                default=TRUE)
            private$..plotEventRates <- jmvcore::OptionBool$new(
                "plotEventRates",
                plotEventRates,
                default=FALSE)
            private$..sensitivityAnalysis <- jmvcore::OptionBool$new(
                "sensitivityAnalysis",
                sensitivityAnalysis,
                default=FALSE)
            private$..confidenceLevel <- jmvcore::OptionNumber$new(
                "confidenceLevel",
                confidenceLevel,
                min=0.9,
                max=0.99,
                default=0.95)

            self$.addOption(private$..analysisType)
            self$.addOption(private$..alpha)
            self$.addOption(private$..power)
            self$.addOption(private$..totalSampleSize)
            self$.addOption(private$..allocationRatio)
            self$.addOption(private$..followUpTime)
            self$.addOption(private$..accrualTime)
            self$.addOption(private$..eventRate1)
            self$.addOption(private$..competingRate1)
            self$.addOption(private$..eventRate2)
            self$.addOption(private$..competingRate2)
            self$.addOption(private$..hazardRatio)
            self$.addOption(private$..testType)
            self$.addOption(private$..distributionType)
            self$.addOption(private$..shape1)
            self$.addOption(private$..shape2)
            self$.addOption(private$..numberOfSimulations)
            self$.addOption(private$..showSimulationDetails)
            self$.addOption(private$..showEducational)
            self$.addOption(private$..plotPowerCurve)
            self$.addOption(private$..plotEventRates)
            self$.addOption(private$..sensitivityAnalysis)
            self$.addOption(private$..confidenceLevel)
        }),
    active = list(
        analysisType = function() private$..analysisType$value,
        alpha = function() private$..alpha$value,
        power = function() private$..power$value,
        totalSampleSize = function() private$..totalSampleSize$value,
        allocationRatio = function() private$..allocationRatio$value,
        followUpTime = function() private$..followUpTime$value,
        accrualTime = function() private$..accrualTime$value,
        eventRate1 = function() private$..eventRate1$value,
        competingRate1 = function() private$..competingRate1$value,
        eventRate2 = function() private$..eventRate2$value,
        competingRate2 = function() private$..competingRate2$value,
        hazardRatio = function() private$..hazardRatio$value,
        testType = function() private$..testType$value,
        distributionType = function() private$..distributionType$value,
        shape1 = function() private$..shape1$value,
        shape2 = function() private$..shape2$value,
        numberOfSimulations = function() private$..numberOfSimulations$value,
        showSimulationDetails = function() private$..showSimulationDetails$value,
        showEducational = function() private$..showEducational$value,
        plotPowerCurve = function() private$..plotPowerCurve$value,
        plotEventRates = function() private$..plotEventRates$value,
        sensitivityAnalysis = function() private$..sensitivityAnalysis$value,
        confidenceLevel = function() private$..confidenceLevel$value),
    private = list(
        ..analysisType = NA,
        ..alpha = NA,
        ..power = NA,
        ..totalSampleSize = NA,
        ..allocationRatio = NA,
        ..followUpTime = NA,
        ..accrualTime = NA,
        ..eventRate1 = NA,
        ..competingRate1 = NA,
        ..eventRate2 = NA,
        ..competingRate2 = NA,
        ..hazardRatio = NA,
        ..testType = NA,
        ..distributionType = NA,
        ..shape1 = NA,
        ..shape2 = NA,
        ..numberOfSimulations = NA,
        ..showSimulationDetails = NA,
        ..showEducational = NA,
        ..plotPowerCurve = NA,
        ..plotEventRates = NA,
        ..sensitivityAnalysis = NA,
        ..confidenceLevel = NA)
)

competingRisksPowerResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "competingRisksPowerResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        educationalInfo = function() private$.items[["educationalInfo"]],
        powerResults = function() private$.items[["powerResults"]],
        studyDesignTable = function() private$.items[["studyDesignTable"]],
        sampleSizeBreakdown = function() private$.items[["sampleSizeBreakdown"]],
        powerCurveTable = function() private$.items[["powerCurveTable"]],
        sensitivityTable = function() private$.items[["sensitivityTable"]],
        simulationDiagnostics = function() private$.items[["simulationDiagnostics"]],
        methodsInfo = function() private$.items[["methodsInfo"]],
        recommendationsInfo = function() private$.items[["recommendationsInfo"]],
        powerCurvePlot = function() private$.items[["powerCurvePlot"]],
        eventRatesPlot = function() private$.items[["eventRatesPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Competing Risks Power Analysis",
                refs=list(
                    "powerCompRisk",
                    "cmprsk",
                    "survival",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="To Do",
                clearWith=list(
                    "analysisType",
                    "alpha",
                    "power")))
            self$add(jmvcore::Html$new(
                options=options,
                name="educationalInfo",
                title="Competing Risks Power Analysis Guide",
                visible="(showEducational)",
                clearWith=list(
                    "analysisType")))
            self$add(jmvcore::Table$new(
                options=options,
                name="powerResults",
                title="Power Analysis Results",
                rows=1,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"),
                    list(
                        `name`="confidence_interval", 
                        `title`="95% CI", 
                        `type`="text"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text")),
                clearWith=list(
                    "analysisType",
                    "alpha",
                    "power",
                    "totalSampleSize")))
            self$add(jmvcore::Table$new(
                options=options,
                name="studyDesignTable",
                title="Study Design Parameters",
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Design Parameter", 
                        `type`="text"),
                    list(
                        `name`="group1", 
                        `title`="Group 1", 
                        `type`="text"),
                    list(
                        `name`="group2", 
                        `title`="Group 2", 
                        `type`="text"),
                    list(
                        `name`="overall", 
                        `title`="Overall", 
                        `type`="text"),
                    list(
                        `name`="notes", 
                        `title`="Notes", 
                        `type`="text")),
                clearWith=list(
                    "allocationRatio",
                    "followUpTime",
                    "eventRate1",
                    "eventRate2")))
            self$add(jmvcore::Table$new(
                options=options,
                name="sampleSizeBreakdown",
                title="Sample Size Breakdown",
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="sample_size", 
                        `title`="Sample Size", 
                        `type`="number"),
                    list(
                        `name`="expected_events", 
                        `title`="Expected Events", 
                        `type`="number"),
                    list(
                        `name`="expected_competing", 
                        `title`="Expected Competing", 
                        `type`="number"),
                    list(
                        `name`="expected_censored", 
                        `title`="Expected Censored", 
                        `type`="number"),
                    list(
                        `name`="event_rate", 
                        `title`="Event Rate (%)", 
                        `type`="number")),
                clearWith=list(
                    "totalSampleSize",
                    "allocationRatio",
                    "eventRate1",
                    "eventRate2")))
            self$add(jmvcore::Table$new(
                options=options,
                name="powerCurveTable",
                title="Power Across Different Scenarios",
                columns=list(
                    list(
                        `name`="scenario", 
                        `title`="Scenario", 
                        `type`="text"),
                    list(
                        `name`="parameter_value", 
                        `title`="Parameter Value", 
                        `type`="number"),
                    list(
                        `name`="power", 
                        `title`="Power", 
                        `type`="number"),
                    list(
                        `name`="sample_size", 
                        `title`="Required N", 
                        `type`="number"),
                    list(
                        `name`="feasibility", 
                        `title`="Feasibility", 
                        `type`="text")),
                clearWith=list(
                    "analysisType",
                    "alpha",
                    "totalSampleSize")))
            self$add(jmvcore::Table$new(
                options=options,
                name="sensitivityTable",
                title="Sensitivity Analysis",
                visible="(sensitivityAnalysis)",
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="low_value", 
                        `title`="Low Value", 
                        `type`="text"),
                    list(
                        `name`="base_value", 
                        `title`="Base Value", 
                        `type`="text"),
                    list(
                        `name`="high_value", 
                        `title`="High Value", 
                        `type`="text"),
                    list(
                        `name`="power_change", 
                        `title`="Power Change (%)", 
                        `type`="text"),
                    list(
                        `name`="robustness", 
                        `title`="Robustness", 
                        `type`="text")),
                clearWith=list(
                    "sensitivityAnalysis",
                    "eventRate1",
                    "eventRate2")))
            self$add(jmvcore::Table$new(
                options=options,
                name="simulationDiagnostics",
                title="Simulation Diagnostics",
                visible="(showSimulationDetails)",
                rows=1,
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"),
                    list(
                        `name`="status", 
                        `title`="Status", 
                        `type`="text"),
                    list(
                        `name`="recommendation", 
                        `title`="Recommendation", 
                        `type`="text")),
                clearWith=list(
                    "numberOfSimulations",
                    "analysisType")))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodsInfo",
                title="Statistical Methods",
                clearWith=list(
                    "testType",
                    "distributionType")))
            self$add(jmvcore::Html$new(
                options=options,
                name="recommendationsInfo",
                title="Study Design Recommendations",
                clearWith=list(
                    "analysisType",
                    "power",
                    "totalSampleSize")))
            self$add(jmvcore::Image$new(
                options=options,
                name="powerCurvePlot",
                title="Power Curve",
                width=800,
                height=600,
                renderFun=".powerCurvePlot",
                visible="(plotPowerCurve)",
                clearWith=list(
                    "analysisType",
                    "alpha",
                    "eventRate1",
                    "eventRate2")))
            self$add(jmvcore::Image$new(
                options=options,
                name="eventRatesPlot",
                title="Cumulative Incidence Visualization",
                width=700,
                height=500,
                renderFun=".eventRatesPlot",
                visible="(plotEventRates)",
                clearWith=list(
                    "eventRate1",
                    "eventRate2",
                    "competingRate1",
                    "competingRate2")))}))

competingRisksPowerBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "competingRisksPowerBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "competingRisksPower",
                version = c(0,0,1),
                options = options,
                results = competingRisksPowerResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Competing Risks Power Analysis (Specialized)
#'
#' Power analysis and sample size calculations for competing risks studies. 
#' Calculates power for testing
#' differences in cumulative incidence functions between groups using Gray's 
#' test and subdistribution hazard models.
#' 
#' This is the specialized function for competing risks power analysis. For 
#' unified analysis across all survival
#' study types, also consider 'Comprehensive Survival Power Analysis'.
#' 
#'
#' @examples
#' \donttest{
#' # example will be added
#'}
#' @param data The data as a data frame (optional for power calculations).
#' @param analysisType Type of power analysis to perform
#' @param alpha Type I error rate for statistical testing
#' @param power Desired statistical power (for sample size calculations)
#' @param totalSampleSize Total sample size for power calculation
#' @param allocationRatio Allocation ratio between groups (e.g., "1:1", "2:1")
#' @param followUpTime Maximum follow-up time for the study
#' @param accrualTime Patient accrual/recruitment period
#' @param eventRate1 Cumulative incidence rate for primary event in Group 1
#' @param competingRate1 Cumulative incidence rate for competing events in
#'   Group 1
#' @param eventRate2 Cumulative incidence rate for primary event in Group 2
#' @param competingRate2 Cumulative incidence rate for competing events in
#'   Group 2
#' @param hazardRatio Expected subdistribution hazard ratio between groups
#' @param testType Type of statistical test for competing risks comparison
#' @param distributionType Assumed distribution for event times
#' @param shape1 Shape parameter for Weibull distribution (Group 1)
#' @param shape2 Shape parameter for Weibull distribution (Group 2)
#' @param numberOfSimulations Number of Monte Carlo simulations for power
#'   estimation
#' @param showSimulationDetails Display detailed simulation results and
#'   convergence diagnostics
#' @param showEducational Display educational information about competing
#'   risks power analysis
#' @param plotPowerCurve Display power curve across different effect sizes or
#'   sample sizes
#' @param plotEventRates Display visualization of cumulative incidence rates
#' @param sensitivityAnalysis Perform sensitivity analysis across different
#'   parameter values
#' @param confidenceLevel Confidence level for power estimates
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$educationalInfo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$powerResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$studyDesignTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$sampleSizeBreakdown} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$powerCurveTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$sensitivityTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$simulationDiagnostics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$methodsInfo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$recommendationsInfo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$powerCurvePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$eventRatesPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$powerResults$asDF}
#'
#' \code{as.data.frame(results$powerResults)}
#'
#' @export
competingRisksPower <- function(
    data,
    analysisType = "power",
    alpha = 0.05,
    power = 0.8,
    totalSampleSize = 200,
    allocationRatio = "1:1",
    followUpTime = 5,
    accrualTime = 2,
    eventRate1 = 0.3,
    competingRate1 = 0.2,
    eventRate2 = 0.4,
    competingRate2 = 0.2,
    hazardRatio = 1.5,
    testType = "gray",
    distributionType = "exponential",
    shape1 = 1,
    shape2 = 1,
    numberOfSimulations = 1000,
    showSimulationDetails = FALSE,
    showEducational = TRUE,
    plotPowerCurve = TRUE,
    plotEventRates = FALSE,
    sensitivityAnalysis = FALSE,
    confidenceLevel = 0.95) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("competingRisksPower requires jmvcore to be installed (restart may be required)")

    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame())


    options <- competingRisksPowerOptions$new(
        analysisType = analysisType,
        alpha = alpha,
        power = power,
        totalSampleSize = totalSampleSize,
        allocationRatio = allocationRatio,
        followUpTime = followUpTime,
        accrualTime = accrualTime,
        eventRate1 = eventRate1,
        competingRate1 = competingRate1,
        eventRate2 = eventRate2,
        competingRate2 = competingRate2,
        hazardRatio = hazardRatio,
        testType = testType,
        distributionType = distributionType,
        shape1 = shape1,
        shape2 = shape2,
        numberOfSimulations = numberOfSimulations,
        showSimulationDetails = showSimulationDetails,
        showEducational = showEducational,
        plotPowerCurve = plotPowerCurve,
        plotEventRates = plotEventRates,
        sensitivityAnalysis = sensitivityAnalysis,
        confidenceLevel = confidenceLevel)

    analysis <- competingRisksPowerClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

