
# This file is automatically generated, you probably don't want to edit this

deeplearningpredictionOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "deeplearningpredictionOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            image_path_var = NULL,
            target_var = NULL,
            model_type = "vision_transformer",
            prediction_type = "classification",
            patch_size = 384,
            batch_size = 8,
            validation_split = 0.2,
            learning_rate = 0.0001,
            epochs = 10,
            attention_maps = TRUE,
            data_augmentation = TRUE,
            gray_zone_width = 5,
            thresholds = "",
            pretrained_weights = TRUE,
            freeze_backbone = FALSE,
            dropout_rate = 0.1,
            weight_decay = 0.0001,
            early_stopping = TRUE,
            save_model = FALSE,
            model_path = "",
            gpu_acceleration = TRUE,
            cross_validation = FALSE,
            cv_folds = 5,
            class_weights = TRUE,
            confidence_threshold = 0.8, ...) {

            super$initialize(
                package="ClinicoPath",
                name="deeplearningprediction",
                requiresData=TRUE,
                ...)

            private$..image_path_var <- jmvcore::OptionVariable$new(
                "image_path_var",
                image_path_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "id"))
            private$..target_var <- jmvcore::OptionVariable$new(
                "target_var",
                target_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..model_type <- jmvcore::OptionList$new(
                "model_type",
                model_type,
                options=list(
                    "vision_transformer",
                    "resnet",
                    "efficientnet",
                    "densenet",
                    "custom_cnn"),
                default="vision_transformer")
            private$..prediction_type <- jmvcore::OptionList$new(
                "prediction_type",
                prediction_type,
                options=list(
                    "classification",
                    "cumulative_logit",
                    "cumulative_logit_grayzone",
                    "regression"),
                default="classification")
            private$..patch_size <- jmvcore::OptionNumber$new(
                "patch_size",
                patch_size,
                min=224,
                max=1024,
                default=384)
            private$..batch_size <- jmvcore::OptionNumber$new(
                "batch_size",
                batch_size,
                min=1,
                max=32,
                default=8)
            private$..validation_split <- jmvcore::OptionNumber$new(
                "validation_split",
                validation_split,
                min=0.1,
                max=0.5,
                default=0.2)
            private$..learning_rate <- jmvcore::OptionNumber$new(
                "learning_rate",
                learning_rate,
                min=0.00001,
                max=0.1,
                default=0.0001)
            private$..epochs <- jmvcore::OptionNumber$new(
                "epochs",
                epochs,
                min=1,
                max=100,
                default=10)
            private$..attention_maps <- jmvcore::OptionBool$new(
                "attention_maps",
                attention_maps,
                default=TRUE)
            private$..data_augmentation <- jmvcore::OptionBool$new(
                "data_augmentation",
                data_augmentation,
                default=TRUE)
            private$..gray_zone_width <- jmvcore::OptionNumber$new(
                "gray_zone_width",
                gray_zone_width,
                min=0,
                max=50,
                default=5)
            private$..thresholds <- jmvcore::OptionString$new(
                "thresholds",
                thresholds,
                default="")
            private$..pretrained_weights <- jmvcore::OptionBool$new(
                "pretrained_weights",
                pretrained_weights,
                default=TRUE)
            private$..freeze_backbone <- jmvcore::OptionBool$new(
                "freeze_backbone",
                freeze_backbone,
                default=FALSE)
            private$..dropout_rate <- jmvcore::OptionNumber$new(
                "dropout_rate",
                dropout_rate,
                min=0,
                max=0.8,
                default=0.1)
            private$..weight_decay <- jmvcore::OptionNumber$new(
                "weight_decay",
                weight_decay,
                min=0,
                max=0.01,
                default=0.0001)
            private$..early_stopping <- jmvcore::OptionBool$new(
                "early_stopping",
                early_stopping,
                default=TRUE)
            private$..save_model <- jmvcore::OptionBool$new(
                "save_model",
                save_model,
                default=FALSE)
            private$..model_path <- jmvcore::OptionString$new(
                "model_path",
                model_path,
                default="")
            private$..gpu_acceleration <- jmvcore::OptionBool$new(
                "gpu_acceleration",
                gpu_acceleration,
                default=TRUE)
            private$..cross_validation <- jmvcore::OptionBool$new(
                "cross_validation",
                cross_validation,
                default=FALSE)
            private$..cv_folds <- jmvcore::OptionNumber$new(
                "cv_folds",
                cv_folds,
                min=3,
                max=10,
                default=5)
            private$..class_weights <- jmvcore::OptionBool$new(
                "class_weights",
                class_weights,
                default=TRUE)
            private$..confidence_threshold <- jmvcore::OptionNumber$new(
                "confidence_threshold",
                confidence_threshold,
                min=0.5,
                max=1,
                default=0.8)

            self$.addOption(private$..image_path_var)
            self$.addOption(private$..target_var)
            self$.addOption(private$..model_type)
            self$.addOption(private$..prediction_type)
            self$.addOption(private$..patch_size)
            self$.addOption(private$..batch_size)
            self$.addOption(private$..validation_split)
            self$.addOption(private$..learning_rate)
            self$.addOption(private$..epochs)
            self$.addOption(private$..attention_maps)
            self$.addOption(private$..data_augmentation)
            self$.addOption(private$..gray_zone_width)
            self$.addOption(private$..thresholds)
            self$.addOption(private$..pretrained_weights)
            self$.addOption(private$..freeze_backbone)
            self$.addOption(private$..dropout_rate)
            self$.addOption(private$..weight_decay)
            self$.addOption(private$..early_stopping)
            self$.addOption(private$..save_model)
            self$.addOption(private$..model_path)
            self$.addOption(private$..gpu_acceleration)
            self$.addOption(private$..cross_validation)
            self$.addOption(private$..cv_folds)
            self$.addOption(private$..class_weights)
            self$.addOption(private$..confidence_threshold)
        }),
    active = list(
        image_path_var = function() private$..image_path_var$value,
        target_var = function() private$..target_var$value,
        model_type = function() private$..model_type$value,
        prediction_type = function() private$..prediction_type$value,
        patch_size = function() private$..patch_size$value,
        batch_size = function() private$..batch_size$value,
        validation_split = function() private$..validation_split$value,
        learning_rate = function() private$..learning_rate$value,
        epochs = function() private$..epochs$value,
        attention_maps = function() private$..attention_maps$value,
        data_augmentation = function() private$..data_augmentation$value,
        gray_zone_width = function() private$..gray_zone_width$value,
        thresholds = function() private$..thresholds$value,
        pretrained_weights = function() private$..pretrained_weights$value,
        freeze_backbone = function() private$..freeze_backbone$value,
        dropout_rate = function() private$..dropout_rate$value,
        weight_decay = function() private$..weight_decay$value,
        early_stopping = function() private$..early_stopping$value,
        save_model = function() private$..save_model$value,
        model_path = function() private$..model_path$value,
        gpu_acceleration = function() private$..gpu_acceleration$value,
        cross_validation = function() private$..cross_validation$value,
        cv_folds = function() private$..cv_folds$value,
        class_weights = function() private$..class_weights$value,
        confidence_threshold = function() private$..confidence_threshold$value),
    private = list(
        ..image_path_var = NA,
        ..target_var = NA,
        ..model_type = NA,
        ..prediction_type = NA,
        ..patch_size = NA,
        ..batch_size = NA,
        ..validation_split = NA,
        ..learning_rate = NA,
        ..epochs = NA,
        ..attention_maps = NA,
        ..data_augmentation = NA,
        ..gray_zone_width = NA,
        ..thresholds = NA,
        ..pretrained_weights = NA,
        ..freeze_backbone = NA,
        ..dropout_rate = NA,
        ..weight_decay = NA,
        ..early_stopping = NA,
        ..save_model = NA,
        ..model_path = NA,
        ..gpu_acceleration = NA,
        ..cross_validation = NA,
        ..cv_folds = NA,
        ..class_weights = NA,
        ..confidence_threshold = NA)
)

deeplearningpredictionResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "deeplearningpredictionResults",
    inherit = jmvcore::Group,
    active = list(
        modelSummary = function() private$.items[["modelSummary"]],
        dataInfo = function() private$.items[["dataInfo"]],
        trainingMetrics = function() private$.items[["trainingMetrics"]],
        predictionResults = function() private$.items[["predictionResults"]],
        performanceAnalysis = function() private$.items[["performanceAnalysis"]],
        explainabilityAnalysis = function() private$.items[["explainabilityAnalysis"]],
        crossValidationResults = function() private$.items[["crossValidationResults"]],
        trainingCurvePlot = function() private$.items[["trainingCurvePlot"]],
        confusionMatrixPlot = function() private$.items[["confusionMatrixPlot"]],
        rocCurvePlot = function() private$.items[["rocCurvePlot"]],
        attentionHeatmapPlot = function() private$.items[["attentionHeatmapPlot"]],
        predictionDistributionPlot = function() private$.items[["predictionDistributionPlot"]],
        cumulativeLogitPlot = function() private$.items[["cumulativeLogitPlot"]],
        crossValidationPlot = function() private$.items[["crossValidationPlot"]],
        modelArchitecturePlot = function() private$.items[["modelArchitecturePlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Deep Learning Image Prediction")
            self$add(jmvcore::Html$new(
                options=options,
                name="modelSummary",
                title="Model Summary and Configuration",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="dataInfo",
                title="Dataset Information",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    trainingHistory = function() private$.items[["trainingHistory"]],
                    finalMetrics = function() private$.items[["finalMetrics"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="trainingMetrics",
                            title="Training Metrics")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="trainingHistory",
                            title="Training History",
                            columns=list(
                                list(
                                    `name`="epoch", 
                                    `title`="Epoch", 
                                    `type`="integer"),
                                list(
                                    `name`="train_loss", 
                                    `title`="Training Loss", 
                                    `type`="number"),
                                list(
                                    `name`="train_accuracy", 
                                    `title`="Training Accuracy", 
                                    `type`="number", 
                                    `format`="pc"),
                                list(
                                    `name`="val_loss", 
                                    `title`="Validation Loss", 
                                    `type`="number"),
                                list(
                                    `name`="val_accuracy", 
                                    `title`="Validation Accuracy", 
                                    `type`="number", 
                                    `format`="pc"),
                                list(
                                    `name`="learning_rate", 
                                    `title`="Learning Rate", 
                                    `type`="number"))))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="finalMetrics",
                            title="Final Performance Metrics",
                            columns=list(
                                list(
                                    `name`="metric", 
                                    `title`="Metric", 
                                    `type`="text"),
                                list(
                                    `name`="training", 
                                    `title`="Training", 
                                    `type`="number"),
                                list(
                                    `name`="validation", 
                                    `title`="Validation", 
                                    `type`="number"),
                                list(
                                    `name`="test", 
                                    `title`="Test", 
                                    `type`="number"))))}))$new(options=options))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    classificationResults = function() private$.items[["classificationResults"]],
                    cumulativeLogitResults = function() private$.items[["cumulativeLogitResults"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="predictionResults",
                            title="Prediction Results")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="classificationResults",
                            title="Classification Predictions",
                            visible="(prediction_type:classification)",
                            columns=list(
                                list(
                                    `name`="sample_id", 
                                    `title`="Sample ID", 
                                    `type`="text"),
                                list(
                                    `name`="image_path", 
                                    `title`="Image Path", 
                                    `type`="text"),
                                list(
                                    `name`="predicted_class", 
                                    `title`="Predicted Class", 
                                    `type`="text"),
                                list(
                                    `name`="confidence", 
                                    `title`="Confidence", 
                                    `type`="number", 
                                    `format`="pc"),
                                list(
                                    `name`="true_class", 
                                    `title`="True Class", 
                                    `type`="text"))))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="cumulativeLogitResults",
                            title="Cumulative Logit Predictions",
                            visible="(prediction_type:cumulative_logit || prediction_type:cumulative_logit_grayzone)",
                            columns=list(
                                list(
                                    `name`="sample_id", 
                                    `title`="Sample ID", 
                                    `type`="text"),
                                list(
                                    `name`="threshold", 
                                    `title`="Threshold", 
                                    `type`="number"),
                                list(
                                    `name`="cumulative_prob", 
                                    `title`="Cumulative Probability", 
                                    `type`="number", 
                                    `format`="pc"),
                                list(
                                    `name`="predicted_level", 
                                    `title`="Predicted Level", 
                                    `type`="text"),
                                list(
                                    `name`="confidence", 
                                    `title`="Confidence", 
                                    `type`="number", 
                                    `format`="pc"),
                                list(
                                    `name`="gray_zone_flag", 
                                    `title`="In Gray Zone", 
                                    `type`="text", 
                                    `visible`="(prediction_type:cumulative_logit_grayzone)"))))}))$new(options=options))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    confusionMatrix = function() private$.items[["confusionMatrix"]],
                    classificationReport = function() private$.items[["classificationReport"]],
                    rocAnalysis = function() private$.items[["rocAnalysis"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="performanceAnalysis",
                            title="Performance Analysis")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="confusionMatrix",
                            title="Confusion Matrix",
                            clearWith=list(
                                "target_var",
                                "model_type"),
                            columns=list()))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="classificationReport",
                            title="Per-Class Performance",
                            columns=list(
                                list(
                                    `name`="class", 
                                    `title`="Class", 
                                    `type`="text"),
                                list(
                                    `name`="precision", 
                                    `title`="Precision", 
                                    `type`="number", 
                                    `format`="zto"),
                                list(
                                    `name`="recall", 
                                    `title`="Recall", 
                                    `type`="number", 
                                    `format`="zto"),
                                list(
                                    `name`="f1_score", 
                                    `title`="F1-Score", 
                                    `type`="number", 
                                    `format`="zto"),
                                list(
                                    `name`="support", 
                                    `title`="Support", 
                                    `type`="integer"))))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="rocAnalysis",
                            title="ROC Analysis",
                            columns=list(
                                list(
                                    `name`="class", 
                                    `title`="Class", 
                                    `type`="text"),
                                list(
                                    `name`="auc", 
                                    `title`="AUC", 
                                    `type`="number"),
                                list(
                                    `name`="ci_lower", 
                                    `title`="95% CI Lower", 
                                    `type`="number"),
                                list(
                                    `name`="ci_upper", 
                                    `title`="95% CI Upper", 
                                    `type`="number"))))}))$new(options=options))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    attentionSummary = function() private$.items[["attentionSummary"]],
                    featureImportance = function() private$.items[["featureImportance"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="explainabilityAnalysis",
                            title="Model Explainability")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="attentionSummary",
                            title="Attention Analysis Summary",
                            columns=list(
                                list(
                                    `name`="region", 
                                    `title`="Image Region", 
                                    `type`="text"),
                                list(
                                    `name`="avg_attention", 
                                    `title`="Average Attention", 
                                    `type`="number"),
                                list(
                                    `name`="std_attention", 
                                    `title`="Std Dev", 
                                    `type`="number"),
                                list(
                                    `name`="samples_count", 
                                    `title`="Sample Count", 
                                    `type`="integer"))))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="featureImportance",
                            title="Feature Importance",
                            columns=list(
                                list(
                                    `name`="feature_type", 
                                    `title`="Feature Type", 
                                    `type`="text"),
                                list(
                                    `name`="importance_score", 
                                    `title`="Importance Score", 
                                    `type`="number"),
                                list(
                                    `name`="frequency", 
                                    `title`="Frequency", 
                                    `type`="number", 
                                    `format`="pc"))))}))$new(options=options))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    cvMetrics = function() private$.items[["cvMetrics"]],
                    cvSummary = function() private$.items[["cvSummary"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="crossValidationResults",
                            title="Cross-Validation Results")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="cvMetrics",
                            title="Cross-Validation Metrics",
                            columns=list(
                                list(
                                    `name`="fold", 
                                    `title`="Fold", 
                                    `type`="integer"),
                                list(
                                    `name`="accuracy", 
                                    `title`="Accuracy", 
                                    `type`="number", 
                                    `format`="pc"),
                                list(
                                    `name`="precision", 
                                    `title`="Precision", 
                                    `type`="number"),
                                list(
                                    `name`="recall", 
                                    `title`="Recall", 
                                    `type`="number"),
                                list(
                                    `name`="f1_score", 
                                    `title`="F1-Score", 
                                    `type`="number"),
                                list(
                                    `name`="auc", 
                                    `title`="AUC", 
                                    `type`="number"))))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="cvSummary",
                            title="Cross-Validation Summary",
                            columns=list(
                                list(
                                    `name`="metric", 
                                    `title`="Metric", 
                                    `type`="text"),
                                list(
                                    `name`="mean", 
                                    `title`="Mean", 
                                    `type`="number"),
                                list(
                                    `name`="std", 
                                    `title`="Std Dev", 
                                    `type`="number"),
                                list(
                                    `name`="ci_lower", 
                                    `title`="95% CI Lower", 
                                    `type`="number"),
                                list(
                                    `name`="ci_upper", 
                                    `title`="95% CI Upper", 
                                    `type`="number"))))}))$new(options=options))
            self$add(jmvcore::Image$new(
                options=options,
                name="trainingCurvePlot",
                title="Training Curves",
                width=800,
                height=500,
                renderFun=".plotTrainingCurves"))
            self$add(jmvcore::Image$new(
                options=options,
                name="confusionMatrixPlot",
                title="Confusion Matrix Visualization",
                width=600,
                height=500,
                renderFun=".plotConfusionMatrix"))
            self$add(jmvcore::Image$new(
                options=options,
                name="rocCurvePlot",
                title="ROC Curves",
                width=700,
                height=500,
                renderFun=".plotROCCurves"))
            self$add(jmvcore::Image$new(
                options=options,
                name="attentionHeatmapPlot",
                title="Attention Heatmaps",
                visible="(attention_maps)",
                width=800,
                height=600,
                renderFun=".plotAttentionHeatmaps"))
            self$add(jmvcore::Image$new(
                options=options,
                name="predictionDistributionPlot",
                title="Prediction Confidence Distribution",
                width=600,
                height=400,
                renderFun=".plotPredictionDistribution"))
            self$add(jmvcore::Image$new(
                options=options,
                name="cumulativeLogitPlot",
                title="Cumulative Logit Analysis",
                visible="(prediction_type:cumulative_logit || prediction_type:cumulative_logit_grayzone)",
                width=700,
                height=500,
                renderFun=".plotCumulativeLogit"))
            self$add(jmvcore::Image$new(
                options=options,
                name="crossValidationPlot",
                title="Cross-Validation Performance",
                visible="(cross_validation)",
                width=600,
                height=400,
                renderFun=".plotCrossValidation"))
            self$add(jmvcore::Image$new(
                options=options,
                name="modelArchitecturePlot",
                title="Model Architecture Visualization",
                width=900,
                height=600,
                renderFun=".plotModelArchitecture"))}))

deeplearningpredictionBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "deeplearningpredictionBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "deeplearningprediction",
                version = c(1,0,0),
                options = options,
                results = deeplearningpredictionResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Deep Learning Image Prediction
#'
#' Advanced deep learning prediction module for histopathological image 
#' analysis.
#' Implements Vision Transformer (ViT), ResNet, and other CNN architectures 
#' for 
#' biomarker prediction from H&E-stained tissue images.
#' 
#'
#' @examples
#' # Basic Vision Transformer prediction
#' deeplearningprediction(
#'     data = image_data,
#'     image_path_var = "image_file_path",
#'     target_var = "biomarker_status",
#'     model_type = "vision_transformer",
#'     attention_maps = TRUE,
#'     validation_split = 0.2
#' )
#'
#' # Cumulative logit with gray-zone
#' deeplearningprediction(
#'     data = ordinal_data,
#'     image_path_var = "image_paths",
#'     target_var = "ki67_score",
#'     model_type = "vision_transformer",
#'     prediction_type = "cumulative_logit",
#'     gray_zone_width = 5.0,
#'     thresholds = c(5, 10, 15, 20)
#' )
#'
#' @param data the data as a data frame
#' @param image_path_var variable containing file paths to histological images
#' @param target_var dependent variable to predict (biomarker status,
#'   classification)
#' @param model_type deep learning architecture for image analysis
#' @param prediction_type type of prediction task and output format
#' @param patch_size size of image patches for processing (pixels)
#' @param batch_size number of images processed simultaneously
#' @param validation_split proportion of data used for validation
#' @param learning_rate learning rate for model training
#' @param epochs number of training epochs
#' @param attention_maps create attention/saliency maps for model
#'   explainability
#' @param data_augmentation apply image transformations during training
#' @param gray_zone_width width of gray zone for cumulative logit models
#' @param thresholds custom thresholds for ordinal prediction (comma-separated
#'   numbers)
#' @param pretrained_weights initialize with ImageNet pretrained weights
#' @param freeze_backbone freeze pretrained backbone for fine-tuning
#' @param dropout_rate dropout rate for regularization
#' @param weight_decay L2 regularization weight decay
#' @param early_stopping stop training when validation loss stops improving
#' @param save_model save trained model for future use
#' @param model_path file path to save trained model
#' @param gpu_acceleration utilize GPU for faster training if available
#' @param cross_validation perform k-fold cross-validation
#' @param cv_folds number of cross-validation folds
#' @param class_weights apply class balancing weights for imbalanced datasets
#' @param confidence_threshold minimum confidence threshold for predictions
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$dataInfo} \tab \tab \tab \tab \tab Summary of input data and preprocessing \cr
#'   \code{results$trainingMetrics$trainingHistory} \tab \tab \tab \tab \tab Epoch-by-epoch training progress \cr
#'   \code{results$trainingMetrics$finalMetrics} \tab \tab \tab \tab \tab Overall model performance assessment \cr
#'   \code{results$predictionResults$classificationResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$predictionResults$cumulativeLogitResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$performanceAnalysis$confusionMatrix} \tab \tab \tab \tab \tab Classification confusion matrix \cr
#'   \code{results$performanceAnalysis$classificationReport} \tab \tab \tab \tab \tab Precision, recall, F1-score per class \cr
#'   \code{results$performanceAnalysis$rocAnalysis} \tab \tab \tab \tab \tab ROC AUC scores for each class \cr
#'   \code{results$explainabilityAnalysis$attentionSummary} \tab \tab \tab \tab \tab Summary of attention patterns across samples \cr
#'   \code{results$explainabilityAnalysis$featureImportance} \tab \tab \tab \tab \tab Most important image features for prediction \cr
#'   \code{results$crossValidationResults$cvMetrics} \tab \tab \tab \tab \tab Performance across CV folds \cr
#'   \code{results$crossValidationResults$cvSummary} \tab \tab \tab \tab \tab Mean and standard deviation of CV metrics \cr
#'   \code{results$trainingCurvePlot} \tab \tab \tab \tab \tab Training and validation loss/accuracy over epochs \cr
#'   \code{results$confusionMatrixPlot} \tab \tab \tab \tab \tab Heatmap of confusion matrix \cr
#'   \code{results$rocCurvePlot} \tab \tab \tab \tab \tab ROC curves for each class \cr
#'   \code{results$attentionHeatmapPlot} \tab \tab \tab \tab \tab Sample attention maps showing model focus areas \cr
#'   \code{results$predictionDistributionPlot} \tab \tab \tab \tab \tab Distribution of prediction confidence scores \cr
#'   \code{results$cumulativeLogitPlot} \tab \tab \tab \tab \tab Cumulative probability plots for ordinal prediction \cr
#'   \code{results$crossValidationPlot} \tab \tab \tab \tab \tab Box plots of CV performance metrics \cr
#'   \code{results$modelArchitecturePlot} \tab \tab \tab \tab \tab Visual representation of the neural network architecture \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$dataInfo$asDF}
#'
#' \code{as.data.frame(results$dataInfo)}
#'
#' @export
deeplearningprediction <- function(
    data,
    image_path_var,
    target_var,
    model_type = "vision_transformer",
    prediction_type = "classification",
    patch_size = 384,
    batch_size = 8,
    validation_split = 0.2,
    learning_rate = 0.0001,
    epochs = 10,
    attention_maps = TRUE,
    data_augmentation = TRUE,
    gray_zone_width = 5,
    thresholds = "",
    pretrained_weights = TRUE,
    freeze_backbone = FALSE,
    dropout_rate = 0.1,
    weight_decay = 0.0001,
    early_stopping = TRUE,
    save_model = FALSE,
    model_path = "",
    gpu_acceleration = TRUE,
    cross_validation = FALSE,
    cv_folds = 5,
    class_weights = TRUE,
    confidence_threshold = 0.8) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("deeplearningprediction requires jmvcore to be installed (restart may be required)")

    if ( ! missing(image_path_var)) image_path_var <- jmvcore::resolveQuo(jmvcore::enquo(image_path_var))
    if ( ! missing(target_var)) target_var <- jmvcore::resolveQuo(jmvcore::enquo(target_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(image_path_var), image_path_var, NULL),
            `if`( ! missing(target_var), target_var, NULL))

    for (v in target_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- deeplearningpredictionOptions$new(
        image_path_var = image_path_var,
        target_var = target_var,
        model_type = model_type,
        prediction_type = prediction_type,
        patch_size = patch_size,
        batch_size = batch_size,
        validation_split = validation_split,
        learning_rate = learning_rate,
        epochs = epochs,
        attention_maps = attention_maps,
        data_augmentation = data_augmentation,
        gray_zone_width = gray_zone_width,
        thresholds = thresholds,
        pretrained_weights = pretrained_weights,
        freeze_backbone = freeze_backbone,
        dropout_rate = dropout_rate,
        weight_decay = weight_decay,
        early_stopping = early_stopping,
        save_model = save_model,
        model_path = model_path,
        gpu_acceleration = gpu_acceleration,
        cross_validation = cross_validation,
        cv_folds = cv_folds,
        class_weights = class_weights,
        confidence_threshold = confidence_threshold)

    analysis <- deeplearningpredictionClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

