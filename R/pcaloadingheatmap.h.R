
# This file is automatically generated, you probably don't want to edit this

pcaloadingheatmapOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "pcaloadingheatmapOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            vars = NULL,
            ncomp = 4,
            cutoff = 0.5,
            center = TRUE,
            scale = TRUE,
            textvalues = TRUE,
            starvalues = FALSE,
            textsize = 2,
            plotlegend = TRUE,
            plotcutoff = TRUE,
            gradientcolor = TRUE,
            colorlow = "steelblue1",
            colormid = "white",
            colorhigh = "firebrick1",
            plotwidth = 600,
            plotheight = 450, ...) {

            super$initialize(
                package="ClinicoPath",
                name="pcaloadingheatmap",
                requiresData=TRUE,
                ...)

            private$..vars <- jmvcore::OptionVariables$new(
                "vars",
                vars,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..ncomp <- jmvcore::OptionInteger$new(
                "ncomp",
                ncomp,
                min=1,
                max=10,
                default=4)
            private$..cutoff <- jmvcore::OptionNumber$new(
                "cutoff",
                cutoff,
                min=0,
                max=1,
                default=0.5)
            private$..center <- jmvcore::OptionBool$new(
                "center",
                center,
                default=TRUE)
            private$..scale <- jmvcore::OptionBool$new(
                "scale",
                scale,
                default=TRUE)
            private$..textvalues <- jmvcore::OptionBool$new(
                "textvalues",
                textvalues,
                default=TRUE)
            private$..starvalues <- jmvcore::OptionBool$new(
                "starvalues",
                starvalues,
                default=FALSE)
            private$..textsize <- jmvcore::OptionNumber$new(
                "textsize",
                textsize,
                min=1,
                max=10,
                default=2)
            private$..plotlegend <- jmvcore::OptionBool$new(
                "plotlegend",
                plotlegend,
                default=TRUE)
            private$..plotcutoff <- jmvcore::OptionBool$new(
                "plotcutoff",
                plotcutoff,
                default=TRUE)
            private$..gradientcolor <- jmvcore::OptionBool$new(
                "gradientcolor",
                gradientcolor,
                default=TRUE)
            private$..colorlow <- jmvcore::OptionString$new(
                "colorlow",
                colorlow,
                default="steelblue1")
            private$..colormid <- jmvcore::OptionString$new(
                "colormid",
                colormid,
                default="white")
            private$..colorhigh <- jmvcore::OptionString$new(
                "colorhigh",
                colorhigh,
                default="firebrick1")
            private$..plotwidth <- jmvcore::OptionInteger$new(
                "plotwidth",
                plotwidth,
                min=300,
                max=2000,
                default=600)
            private$..plotheight <- jmvcore::OptionInteger$new(
                "plotheight",
                plotheight,
                min=300,
                max=2000,
                default=450)

            self$.addOption(private$..vars)
            self$.addOption(private$..ncomp)
            self$.addOption(private$..cutoff)
            self$.addOption(private$..center)
            self$.addOption(private$..scale)
            self$.addOption(private$..textvalues)
            self$.addOption(private$..starvalues)
            self$.addOption(private$..textsize)
            self$.addOption(private$..plotlegend)
            self$.addOption(private$..plotcutoff)
            self$.addOption(private$..gradientcolor)
            self$.addOption(private$..colorlow)
            self$.addOption(private$..colormid)
            self$.addOption(private$..colorhigh)
            self$.addOption(private$..plotwidth)
            self$.addOption(private$..plotheight)
        }),
    active = list(
        vars = function() private$..vars$value,
        ncomp = function() private$..ncomp$value,
        cutoff = function() private$..cutoff$value,
        center = function() private$..center$value,
        scale = function() private$..scale$value,
        textvalues = function() private$..textvalues$value,
        starvalues = function() private$..starvalues$value,
        textsize = function() private$..textsize$value,
        plotlegend = function() private$..plotlegend$value,
        plotcutoff = function() private$..plotcutoff$value,
        gradientcolor = function() private$..gradientcolor$value,
        colorlow = function() private$..colorlow$value,
        colormid = function() private$..colormid$value,
        colorhigh = function() private$..colorhigh$value,
        plotwidth = function() private$..plotwidth$value,
        plotheight = function() private$..plotheight$value),
    private = list(
        ..vars = NA,
        ..ncomp = NA,
        ..cutoff = NA,
        ..center = NA,
        ..scale = NA,
        ..textvalues = NA,
        ..starvalues = NA,
        ..textsize = NA,
        ..plotlegend = NA,
        ..plotcutoff = NA,
        ..gradientcolor = NA,
        ..colorlow = NA,
        ..colormid = NA,
        ..colorhigh = NA,
        ..plotwidth = NA,
        ..plotheight = NA)
)

pcaloadingheatmapResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "pcaloadingheatmapResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        heatmap = function() private$.items[["heatmap"]],
        barmap = function() private$.items[["barmap"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="PCA Loading Heatmap & Barmap")
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="heatmap",
                title="Loading Heatmap",
                width=600,
                height=450,
                renderFun=".heatmap",
                requiresData=TRUE,
                clearWith=list(
                    "vars",
                    "ncomp",
                    "cutoff",
                    "center",
                    "scale",
                    "textvalues",
                    "starvalues",
                    "textsize",
                    "colorlow",
                    "colormid",
                    "colorhigh",
                    "plotwidth",
                    "plotheight")))
            self$add(jmvcore::Image$new(
                options=options,
                name="barmap",
                title="Loading Barmap",
                width=600,
                height=450,
                renderFun=".barmap",
                requiresData=TRUE,
                clearWith=list(
                    "vars",
                    "ncomp",
                    "cutoff",
                    "center",
                    "scale",
                    "textvalues",
                    "starvalues",
                    "textsize",
                    "plotlegend",
                    "plotcutoff",
                    "gradientcolor",
                    "colorlow",
                    "colormid",
                    "colorhigh",
                    "plotwidth",
                    "plotheight")))}))

pcaloadingheatmapBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "pcaloadingheatmapBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "pcaloadingheatmap",
                version = c(0,0,31),
                options = options,
                results = pcaloadingheatmapResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' PCA Loading Heatmap & Barmap
#'
#' Creates heatmap and barmap visualizations of PCA loadings for easy 
#' interpretation
#' of component structure. Heatmaps show all loadings as a color-coded matrix, 
#' while
#' barmaps display loading patterns as bar charts across components.
#' 
#' Both visualizations support optional significance indicators (stars) for 
#' loadings
#' above a specified cutoff threshold. These publication-ready plots help 
#' identify
#' which variables contribute most strongly to each component.
#' 
#'
#' @examples
#' # Example with mtcars dataset
#' data("mtcars")
#'
#' # Create loading heatmap and barmap
#' pcaloadingheatmap(
#'   data = mtcars,
#'   vars = c("mpg", "disp", "hp", "drat", "wt", "qsec"),
#'   ncomp = 4,
#'   cutoff = 0.5,
#'   center = TRUE,
#'   scale = TRUE,
#'   textvalues = TRUE,
#'   gradientcolor = TRUE
#' )
#'
#' @section References:
#' Torres-Espin A, Chou A, Huie JR, et al. (2021). Reproducible analysis of disease space via principal components using the novel R package syndRomics. eLife, 10:e61812.
#'
#' @param data The data as a data frame.
#' @param vars Continuous variables to include in Principal Component
#'   Analysis. Select at least 3 numeric variables.
#' @param ncomp Number of principal components to display (1 to 10).
#' @param cutoff Threshold for marking loadings as significant (0 to 1).
#'   Loadings with |loading| >= cutoff will be marked with stars if star_values
#'   is enabled.
#' @param center Center variables before PCA.
#' @param scale Scale variables before PCA.
#' @param textvalues Display numeric loading values in heatmap/barmap cells.
#' @param starvalues Display stars (*) for loadings >= cutoff threshold. Only
#'   relevant if textvalues is FALSE.
#' @param textsize Font size for text in plots.
#' @param plotlegend Display legend in barmap plot.
#' @param plotcutoff Display horizontal lines at ±cutoff threshold in barmap.
#' @param gradientcolor Use gradient colors proportional to loading values. If
#'   FALSE, uses binary colors for positive/negative.
#' @param colorlow Color for negative loadings.
#' @param colormid Midpoint color for zero loading.
#' @param colorhigh Color for positive loadings.
#' @param plotwidth Width of plots in pixels.
#' @param plotheight Height of plots in pixels.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$heatmap} \tab \tab \tab \tab \tab Heatmap visualization of PCA loadings across components \cr
#'   \code{results$barmap} \tab \tab \tab \tab \tab Barmap visualization of PCA loadings showing magnitude and direction \cr
#' }
#'
#' @export
pcaloadingheatmap <- function(
    data,
    vars,
    ncomp = 4,
    cutoff = 0.5,
    center = TRUE,
    scale = TRUE,
    textvalues = TRUE,
    starvalues = FALSE,
    textsize = 2,
    plotlegend = TRUE,
    plotcutoff = TRUE,
    gradientcolor = TRUE,
    colorlow = "steelblue1",
    colormid = "white",
    colorhigh = "firebrick1",
    plotwidth = 600,
    plotheight = 450) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("pcaloadingheatmap requires jmvcore to be installed (restart may be required)")

    if ( ! missing(vars)) vars <- jmvcore::resolveQuo(jmvcore::enquo(vars))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(vars), vars, NULL))


    options <- pcaloadingheatmapOptions$new(
        vars = vars,
        ncomp = ncomp,
        cutoff = cutoff,
        center = center,
        scale = scale,
        textvalues = textvalues,
        starvalues = starvalues,
        textsize = textsize,
        plotlegend = plotlegend,
        plotcutoff = plotcutoff,
        gradientcolor = gradientcolor,
        colorlow = colorlow,
        colormid = colormid,
        colorhigh = colorhigh,
        plotwidth = plotwidth,
        plotheight = plotheight)

    analysis <- pcaloadingheatmapClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

