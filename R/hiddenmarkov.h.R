
# This file is automatically generated, you probably don't want to edit this

hiddenmarkovOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "hiddenmarkovOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            subject = NULL,
            state = NULL,
            time = NULL,
            covs = NULL,
            hiddenCovs = NULL,
            nstates = 3,
            qmatrix = "irreversible",
            censor = NULL,
            pci = FALSE,
            timeIntervals = "",
            obstype = "exact",
            ematrix = "identity",
            method = "BFGS",
            fixedpar = "",
            initprobs = "",
            showModel = TRUE,
            showTransitions = TRUE,
            predTimes = "1, 3, 5",
            showPrevalence = TRUE,
            showResiduals = FALSE,
            showViterbi = FALSE,
            bootstrap = FALSE,
            nboot = 500,
            plotTransitions = TRUE,
            plotPrevalence = TRUE,
            plotResiduals = FALSE,
            showEducational = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="hiddenmarkov",
                requiresData=TRUE,
                ...)

            private$..subject <- jmvcore::OptionVariable$new(
                "subject",
                subject,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..state <- jmvcore::OptionVariable$new(
                "state",
                state,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..covs <- jmvcore::OptionVariables$new(
                "covs",
                covs,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..hiddenCovs <- jmvcore::OptionVariables$new(
                "hiddenCovs",
                hiddenCovs,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..nstates <- jmvcore::OptionNumber$new(
                "nstates",
                nstates,
                min=2,
                max=10,
                default=3)
            private$..qmatrix <- jmvcore::OptionList$new(
                "qmatrix",
                qmatrix,
                options=list(
                    "irreversible",
                    "reversible",
                    "custom"),
                default="irreversible")
            private$..censor <- jmvcore::OptionVariable$new(
                "censor",
                censor,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..pci <- jmvcore::OptionBool$new(
                "pci",
                pci,
                default=FALSE)
            private$..timeIntervals <- jmvcore::OptionString$new(
                "timeIntervals",
                timeIntervals,
                default="")
            private$..obstype <- jmvcore::OptionList$new(
                "obstype",
                obstype,
                options=list(
                    "exact",
                    "panel",
                    "mixed"),
                default="exact")
            private$..ematrix <- jmvcore::OptionList$new(
                "ematrix",
                ematrix,
                options=list(
                    "identity",
                    "symmetric",
                    "custom"),
                default="identity")
            private$..method <- jmvcore::OptionList$new(
                "method",
                method,
                options=list(
                    "BFGS",
                    "Nelder-Mead",
                    "BOBYQA"),
                default="BFGS")
            private$..fixedpar <- jmvcore::OptionString$new(
                "fixedpar",
                fixedpar,
                default="")
            private$..initprobs <- jmvcore::OptionString$new(
                "initprobs",
                initprobs,
                default="")
            private$..showModel <- jmvcore::OptionBool$new(
                "showModel",
                showModel,
                default=TRUE)
            private$..showTransitions <- jmvcore::OptionBool$new(
                "showTransitions",
                showTransitions,
                default=TRUE)
            private$..predTimes <- jmvcore::OptionString$new(
                "predTimes",
                predTimes,
                default="1, 3, 5")
            private$..showPrevalence <- jmvcore::OptionBool$new(
                "showPrevalence",
                showPrevalence,
                default=TRUE)
            private$..showResiduals <- jmvcore::OptionBool$new(
                "showResiduals",
                showResiduals,
                default=FALSE)
            private$..showViterbi <- jmvcore::OptionBool$new(
                "showViterbi",
                showViterbi,
                default=FALSE)
            private$..bootstrap <- jmvcore::OptionBool$new(
                "bootstrap",
                bootstrap,
                default=FALSE)
            private$..nboot <- jmvcore::OptionNumber$new(
                "nboot",
                nboot,
                min=50,
                max=2000,
                default=500)
            private$..plotTransitions <- jmvcore::OptionBool$new(
                "plotTransitions",
                plotTransitions,
                default=TRUE)
            private$..plotPrevalence <- jmvcore::OptionBool$new(
                "plotPrevalence",
                plotPrevalence,
                default=TRUE)
            private$..plotResiduals <- jmvcore::OptionBool$new(
                "plotResiduals",
                plotResiduals,
                default=FALSE)
            private$..showEducational <- jmvcore::OptionBool$new(
                "showEducational",
                showEducational,
                default=TRUE)

            self$.addOption(private$..subject)
            self$.addOption(private$..state)
            self$.addOption(private$..time)
            self$.addOption(private$..covs)
            self$.addOption(private$..hiddenCovs)
            self$.addOption(private$..nstates)
            self$.addOption(private$..qmatrix)
            self$.addOption(private$..censor)
            self$.addOption(private$..pci)
            self$.addOption(private$..timeIntervals)
            self$.addOption(private$..obstype)
            self$.addOption(private$..ematrix)
            self$.addOption(private$..method)
            self$.addOption(private$..fixedpar)
            self$.addOption(private$..initprobs)
            self$.addOption(private$..showModel)
            self$.addOption(private$..showTransitions)
            self$.addOption(private$..predTimes)
            self$.addOption(private$..showPrevalence)
            self$.addOption(private$..showResiduals)
            self$.addOption(private$..showViterbi)
            self$.addOption(private$..bootstrap)
            self$.addOption(private$..nboot)
            self$.addOption(private$..plotTransitions)
            self$.addOption(private$..plotPrevalence)
            self$.addOption(private$..plotResiduals)
            self$.addOption(private$..showEducational)
        }),
    active = list(
        subject = function() private$..subject$value,
        state = function() private$..state$value,
        time = function() private$..time$value,
        covs = function() private$..covs$value,
        hiddenCovs = function() private$..hiddenCovs$value,
        nstates = function() private$..nstates$value,
        qmatrix = function() private$..qmatrix$value,
        censor = function() private$..censor$value,
        pci = function() private$..pci$value,
        timeIntervals = function() private$..timeIntervals$value,
        obstype = function() private$..obstype$value,
        ematrix = function() private$..ematrix$value,
        method = function() private$..method$value,
        fixedpar = function() private$..fixedpar$value,
        initprobs = function() private$..initprobs$value,
        showModel = function() private$..showModel$value,
        showTransitions = function() private$..showTransitions$value,
        predTimes = function() private$..predTimes$value,
        showPrevalence = function() private$..showPrevalence$value,
        showResiduals = function() private$..showResiduals$value,
        showViterbi = function() private$..showViterbi$value,
        bootstrap = function() private$..bootstrap$value,
        nboot = function() private$..nboot$value,
        plotTransitions = function() private$..plotTransitions$value,
        plotPrevalence = function() private$..plotPrevalence$value,
        plotResiduals = function() private$..plotResiduals$value,
        showEducational = function() private$..showEducational$value),
    private = list(
        ..subject = NA,
        ..state = NA,
        ..time = NA,
        ..covs = NA,
        ..hiddenCovs = NA,
        ..nstates = NA,
        ..qmatrix = NA,
        ..censor = NA,
        ..pci = NA,
        ..timeIntervals = NA,
        ..obstype = NA,
        ..ematrix = NA,
        ..method = NA,
        ..fixedpar = NA,
        ..initprobs = NA,
        ..showModel = NA,
        ..showTransitions = NA,
        ..predTimes = NA,
        ..showPrevalence = NA,
        ..showResiduals = NA,
        ..showViterbi = NA,
        ..bootstrap = NA,
        ..nboot = NA,
        ..plotTransitions = NA,
        ..plotPrevalence = NA,
        ..plotResiduals = NA,
        ..showEducational = NA)
)

hiddenmarkovResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "hiddenmarkovResults",
    inherit = jmvcore::Group,
    active = list(
        modelSummary = function() private$.items[["modelSummary"]],
        transitionMatrix = function() private$.items[["transitionMatrix"]],
        transitionProbs = function() private$.items[["transitionProbs"]],
        statePrevalence = function() private$.items[["statePrevalence"]],
        misclassification = function() private$.items[["misclassification"]],
        goodnessOfFit = function() private$.items[["goodnessOfFit"]],
        viterbiStates = function() private$.items[["viterbiStates"]],
        transitionPlot = function() private$.items[["transitionPlot"]],
        prevalencePlot = function() private$.items[["prevalencePlot"]],
        residualPlot = function() private$.items[["residualPlot"]],
        educationalText = function() private$.items[["educationalText"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Hidden Markov Models for Survival")
            self$add(jmvcore::Table$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="pvalue", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="transitionMatrix",
                title="Transition Intensity Matrix",
                columns=list(
                    list(
                        `name`="from_state", 
                        `title`="From State", 
                        `type`="text"),
                    list(
                        `name`="to_state", 
                        `title`="To State", 
                        `type`="text"),
                    list(
                        `name`="intensity", 
                        `title`="Intensity", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="transitionProbs",
                title="Transition Probabilities",
                columns=list(
                    list(
                        `name`="time", 
                        `title`="Time", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="from_state", 
                        `title`="From State", 
                        `type`="text"),
                    list(
                        `name`="to_state", 
                        `title`="To State", 
                        `type`="text"),
                    list(
                        `name`="probability", 
                        `title`="Probability", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="statePrevalence",
                title="Expected State Prevalence",
                columns=list(
                    list(
                        `name`="time", 
                        `title`="Time", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="state", 
                        `title`="State", 
                        `type`="text"),
                    list(
                        `name`="prevalence", 
                        `title`="Prevalence", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="misclassification",
                title="Misclassification Probabilities",
                columns=list(
                    list(
                        `name`="true_state", 
                        `title`="True State", 
                        `type`="text"),
                    list(
                        `name`="observed_state", 
                        `title`="Observed State", 
                        `type`="text"),
                    list(
                        `name`="probability", 
                        `title`="Probability", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="goodnessOfFit",
                title="Model Fit Statistics",
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="pvalue", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="viterbiStates",
                title="Most Likely Hidden States (Viterbi)",
                columns=list(
                    list(
                        `name`="subject", 
                        `title`="Subject", 
                        `type`="text"),
                    list(
                        `name`="time", 
                        `title`="Time", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="observed_state", 
                        `title`="Observed", 
                        `type`="text"),
                    list(
                        `name`="viterbi_state", 
                        `title`="Viterbi State", 
                        `type`="text"),
                    list(
                        `name`="probability", 
                        `title`="Probability", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="transitionPlot",
                title="Transition Intensities Over Time",
                width=800,
                height=600,
                renderFun=".transitionPlot"))
            self$add(jmvcore::Image$new(
                options=options,
                name="prevalencePlot",
                title="State Prevalence Over Time",
                width=800,
                height=600,
                renderFun=".prevalencePlot"))
            self$add(jmvcore::Image$new(
                options=options,
                name="residualPlot",
                title="Model Residuals",
                width=800,
                height=600,
                renderFun=".residualPlot"))
            self$add(jmvcore::Html$new(
                options=options,
                name="educationalText",
                title="Hidden Markov Models for Survival - Educational Information",
                visible="(showEducational)",
                refs="msm"))}))

hiddenmarkovBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "hiddenmarkovBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "hiddenmarkov",
                version = c(0,0,1),
                options = options,
                results = hiddenmarkovResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Hidden Markov Models for Survival
#'
#' Fits Hidden Markov models for survival data using the msm package.  Hidden 
#' Markov models are useful when the states are not directly  observed but are 
#' inferred from observed covariates or measurements.  Provides estimation of 
#' transition intensities, state prevalences,  and predictions with 
#' uncertainty quantification.
#' 
#'
#' @examples
#' \donttest{
#' # example will be added
#'}
#' @param data The data as a data frame.
#' @param subject Subject identifier variable
#' @param state Observed state variable (can be noisy observations of true
#'   states)
#' @param time Time at which state was observed
#' @param covs Covariates to include in the transition intensity model
#' @param hiddenCovs Covariates for hidden state probabilities
#'   (misclassification model)
#' @param nstates Number of hidden states in the model
#' @param qmatrix Structure of the transition intensity matrix
#' @param censor Censoring indicator (1=observed, 0=censored)
#' @param pci Use piecewise constant transition intensities
#' @param timeIntervals Comma-separated time intervals for piecewise constant
#'   model
#' @param obstype Type of observation process
#' @param ematrix Structure of the emission/misclassification matrix
#' @param method Optimization method for parameter estimation
#' @param fixedpar Comma-separated indices of parameters to fix during
#'   estimation
#' @param initprobs Comma-separated initial state probabilities
#' @param showModel Display detailed model summary and parameter estimates
#' @param showTransitions Display transition probability matrices at specific
#'   times
#' @param predTimes Comma-separated list of time points for transition
#'   predictions
#' @param showPrevalence Display expected state prevalences over time
#' @param showResiduals Display model residuals and goodness-of-fit statistics
#' @param showViterbi Display most likely hidden state sequences (Viterbi
#'   algorithm)
#' @param bootstrap Use bootstrap methods for confidence interval estimation
#' @param nboot Number of bootstrap samples (when bootstrap is enabled)
#' @param plotTransitions Display transition intensity plots over time
#' @param plotPrevalence Display state prevalence plots over time
#' @param plotResiduals Display residual plots for model diagnostics
#' @param showEducational Display educational information about Hidden Markov
#'   models
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$transitionMatrix} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$transitionProbs} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$statePrevalence} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$misclassification} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$goodnessOfFit} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$viterbiStates} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$transitionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$prevalencePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$residualPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$educationalText} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelSummary$asDF}
#'
#' \code{as.data.frame(results$modelSummary)}
#'
#' @export
hiddenmarkov <- function(
    data,
    subject,
    state,
    time,
    covs,
    hiddenCovs,
    nstates = 3,
    qmatrix = "irreversible",
    censor,
    pci = FALSE,
    timeIntervals = "",
    obstype = "exact",
    ematrix = "identity",
    method = "BFGS",
    fixedpar = "",
    initprobs = "",
    showModel = TRUE,
    showTransitions = TRUE,
    predTimes = "1, 3, 5",
    showPrevalence = TRUE,
    showResiduals = FALSE,
    showViterbi = FALSE,
    bootstrap = FALSE,
    nboot = 500,
    plotTransitions = TRUE,
    plotPrevalence = TRUE,
    plotResiduals = FALSE,
    showEducational = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("hiddenmarkov requires jmvcore to be installed (restart may be required)")

    if ( ! missing(subject)) subject <- jmvcore::resolveQuo(jmvcore::enquo(subject))
    if ( ! missing(state)) state <- jmvcore::resolveQuo(jmvcore::enquo(state))
    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(covs)) covs <- jmvcore::resolveQuo(jmvcore::enquo(covs))
    if ( ! missing(hiddenCovs)) hiddenCovs <- jmvcore::resolveQuo(jmvcore::enquo(hiddenCovs))
    if ( ! missing(censor)) censor <- jmvcore::resolveQuo(jmvcore::enquo(censor))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(subject), subject, NULL),
            `if`( ! missing(state), state, NULL),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(covs), covs, NULL),
            `if`( ! missing(hiddenCovs), hiddenCovs, NULL),
            `if`( ! missing(censor), censor, NULL))


    options <- hiddenmarkovOptions$new(
        subject = subject,
        state = state,
        time = time,
        covs = covs,
        hiddenCovs = hiddenCovs,
        nstates = nstates,
        qmatrix = qmatrix,
        censor = censor,
        pci = pci,
        timeIntervals = timeIntervals,
        obstype = obstype,
        ematrix = ematrix,
        method = method,
        fixedpar = fixedpar,
        initprobs = initprobs,
        showModel = showModel,
        showTransitions = showTransitions,
        predTimes = predTimes,
        showPrevalence = showPrevalence,
        showResiduals = showResiduals,
        showViterbi = showViterbi,
        bootstrap = bootstrap,
        nboot = nboot,
        plotTransitions = plotTransitions,
        plotPrevalence = plotPrevalence,
        plotResiduals = plotResiduals,
        showEducational = showEducational)

    analysis <- hiddenmarkovClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

