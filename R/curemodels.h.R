
# This file is automatically generated, you probably don't want to edit this

curemodelsOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "curemodelsOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            status = NULL,
            predictors = NULL,
            model_type = "mixture",
            cure_link = "logit",
            survival_dist = "weibull",
            bootstrap_ci = FALSE,
            n_bootstrap = 1000,
            cure_threshold = 60,
            plot_cure_fraction = TRUE,
            plot_survival = TRUE,
            goodness_of_fit = TRUE,
            sensitivity_analysis = FALSE,
            use_background_mortality = FALSE,
            background_hazard_var = NULL,
            cure_expected_rate = NULL,
            use_nonparametric = FALSE,
            npcure_covariate = NULL,
            npcure_bandwidth = "auto",
            npcure_time_points = 100, ...) {

            super$initialize(
                package="ClinicoPath",
                name="curemodels",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..status <- jmvcore::OptionVariable$new(
                "status",
                status,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..predictors <- jmvcore::OptionVariables$new(
                "predictors",
                predictors,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..model_type <- jmvcore::OptionList$new(
                "model_type",
                model_type,
                options=list(
                    "mixture",
                    "nonmixture",
                    "cure",
                    "npcure",
                    "all"),
                default="mixture")
            private$..cure_link <- jmvcore::OptionList$new(
                "cure_link",
                cure_link,
                options=list(
                    "logit",
                    "probit",
                    "cloglog"),
                default="logit")
            private$..survival_dist <- jmvcore::OptionList$new(
                "survival_dist",
                survival_dist,
                options=list(
                    "weibull",
                    "exponential",
                    "lognormal",
                    "loglogistic"),
                default="weibull")
            private$..bootstrap_ci <- jmvcore::OptionBool$new(
                "bootstrap_ci",
                bootstrap_ci,
                default=FALSE)
            private$..n_bootstrap <- jmvcore::OptionInteger$new(
                "n_bootstrap",
                n_bootstrap,
                default=1000,
                min=100,
                max=10000)
            private$..cure_threshold <- jmvcore::OptionNumber$new(
                "cure_threshold",
                cure_threshold,
                default=60,
                min=0)
            private$..plot_cure_fraction <- jmvcore::OptionBool$new(
                "plot_cure_fraction",
                plot_cure_fraction,
                default=TRUE)
            private$..plot_survival <- jmvcore::OptionBool$new(
                "plot_survival",
                plot_survival,
                default=TRUE)
            private$..goodness_of_fit <- jmvcore::OptionBool$new(
                "goodness_of_fit",
                goodness_of_fit,
                default=TRUE)
            private$..sensitivity_analysis <- jmvcore::OptionBool$new(
                "sensitivity_analysis",
                sensitivity_analysis,
                default=FALSE)
            private$..use_background_mortality <- jmvcore::OptionBool$new(
                "use_background_mortality",
                use_background_mortality,
                default=FALSE)
            private$..background_hazard_var <- jmvcore::OptionVariable$new(
                "background_hazard_var",
                background_hazard_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..cure_expected_rate <- jmvcore::OptionVariable$new(
                "cure_expected_rate",
                cure_expected_rate,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..use_nonparametric <- jmvcore::OptionBool$new(
                "use_nonparametric",
                use_nonparametric,
                default=FALSE)
            private$..npcure_covariate <- jmvcore::OptionVariable$new(
                "npcure_covariate",
                npcure_covariate,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..npcure_bandwidth <- jmvcore::OptionList$new(
                "npcure_bandwidth",
                npcure_bandwidth,
                options=list(
                    "auto",
                    "small",
                    "medium",
                    "large"),
                default="auto")
            private$..npcure_time_points <- jmvcore::OptionInteger$new(
                "npcure_time_points",
                npcure_time_points,
                default=100,
                min=50,
                max=500)

            self$.addOption(private$..time)
            self$.addOption(private$..status)
            self$.addOption(private$..predictors)
            self$.addOption(private$..model_type)
            self$.addOption(private$..cure_link)
            self$.addOption(private$..survival_dist)
            self$.addOption(private$..bootstrap_ci)
            self$.addOption(private$..n_bootstrap)
            self$.addOption(private$..cure_threshold)
            self$.addOption(private$..plot_cure_fraction)
            self$.addOption(private$..plot_survival)
            self$.addOption(private$..goodness_of_fit)
            self$.addOption(private$..sensitivity_analysis)
            self$.addOption(private$..use_background_mortality)
            self$.addOption(private$..background_hazard_var)
            self$.addOption(private$..cure_expected_rate)
            self$.addOption(private$..use_nonparametric)
            self$.addOption(private$..npcure_covariate)
            self$.addOption(private$..npcure_bandwidth)
            self$.addOption(private$..npcure_time_points)
        }),
    active = list(
        time = function() private$..time$value,
        status = function() private$..status$value,
        predictors = function() private$..predictors$value,
        model_type = function() private$..model_type$value,
        cure_link = function() private$..cure_link$value,
        survival_dist = function() private$..survival_dist$value,
        bootstrap_ci = function() private$..bootstrap_ci$value,
        n_bootstrap = function() private$..n_bootstrap$value,
        cure_threshold = function() private$..cure_threshold$value,
        plot_cure_fraction = function() private$..plot_cure_fraction$value,
        plot_survival = function() private$..plot_survival$value,
        goodness_of_fit = function() private$..goodness_of_fit$value,
        sensitivity_analysis = function() private$..sensitivity_analysis$value,
        use_background_mortality = function() private$..use_background_mortality$value,
        background_hazard_var = function() private$..background_hazard_var$value,
        cure_expected_rate = function() private$..cure_expected_rate$value,
        use_nonparametric = function() private$..use_nonparametric$value,
        npcure_covariate = function() private$..npcure_covariate$value,
        npcure_bandwidth = function() private$..npcure_bandwidth$value,
        npcure_time_points = function() private$..npcure_time_points$value),
    private = list(
        ..time = NA,
        ..status = NA,
        ..predictors = NA,
        ..model_type = NA,
        ..cure_link = NA,
        ..survival_dist = NA,
        ..bootstrap_ci = NA,
        ..n_bootstrap = NA,
        ..cure_threshold = NA,
        ..plot_cure_fraction = NA,
        ..plot_survival = NA,
        ..goodness_of_fit = NA,
        ..sensitivity_analysis = NA,
        ..use_background_mortality = NA,
        ..background_hazard_var = NA,
        ..cure_expected_rate = NA,
        ..use_nonparametric = NA,
        ..npcure_covariate = NA,
        ..npcure_bandwidth = NA,
        ..npcure_time_points = NA)
)

curemodelsResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "curemodelsResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        warnings = function() private$.items[["warnings"]],
        summary = function() private$.items[["summary"]],
        modelTable = function() private$.items[["modelTable"]],
        cureTable = function() private$.items[["cureTable"]],
        cureFractionPlot = function() private$.items[["cureFractionPlot"]],
        survivalPlot = function() private$.items[["survivalPlot"]],
        goodnessOfFit = function() private$.items[["goodnessOfFit"]],
        sensitivityAnalysis = function() private$.items[["sensitivityAnalysis"]],
        modelComparison = function() private$.items[["modelComparison"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Cure Models for Long-term Survivors",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "survival",
                    "parallel",
                    "smcure",
                    "flexsurvcure",
                    "glue",
                    "stringr"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="To Do",
                clearWith=list(
                    "time",
                    "status",
                    "predictors")))
            self$add(jmvcore::Html$new(
                options=options,
                name="warnings",
                title="Warnings",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="summary",
                title="Analysis Summary",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelTable",
                title="Cure Model Results",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="std_error", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="z_value", 
                        `title`="z value", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="cureTable",
                title="Cure Fraction Summary",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="cure_fraction", 
                        `title`="Cure Fraction", 
                        `type`="number"),
                    list(
                        `name`="cure_ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="cure_ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"),
                    list(
                        `name`="uncured_median", 
                        `title`="Median Survival (Uncured)", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="cureFractionPlot",
                title="Cure Fraction Plot",
                width=700,
                height=450,
                renderFun=".plotCureFraction",
                visible="(plot_cure_fraction)",
                clearWith=list(
                    "time",
                    "status",
                    "predictors",
                    "model_type",
                    "cure_link")))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlot",
                title="Survival Curves by Cure Status",
                width=700,
                height=450,
                renderFun=".plotSurvival",
                visible="(plot_survival)",
                clearWith=list(
                    "time",
                    "status",
                    "predictors",
                    "model_type",
                    "survival_dist")))
            self$add(jmvcore::Table$new(
                options=options,
                name="goodnessOfFit",
                title="Goodness of Fit Tests",
                visible="(goodness_of_fit)",
                rows=1,
                columns=list(
                    list(
                        `name`="test_name", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="sensitivityAnalysis",
                title="Sensitivity Analysis",
                visible="(sensitivity_analysis)",
                clearWith=list(
                    "time",
                    "status",
                    "predictors",
                    "cure_threshold")))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelComparison",
                title="Model Comparison",
                visible="(model_type:both)",
                rows=2,
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model Type", 
                        `type`="text"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number"),
                    list(
                        `name`="loglik", 
                        `title`="Log-Likelihood", 
                        `type`="number"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation",
                visible=TRUE))}))

curemodelsBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "curemodelsBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "curemodels",
                version = c(1,0,0),
                options = options,
                results = curemodelsResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Cure Models for Long-term Survivors
#'
#' Cure models for analyzing survival data with a cured fraction of long-term 
#' survivors.
#' Implements mixture cure models and non-mixture cure models for oncology 
#' research.
#' 
#'
#' @examples
#' \donttest{
#' # Example usage
#' curemodels(
#'     data = cancer_data,
#'     time = followup_time,
#'     status = death_status,
#'     predictors = c(age, stage, treatment),
#'     model_type = "mixture"
#' )
#'}
#' @param data The data as a data frame.
#' @param time Follow-up time variable
#' @param status Event status variable
#' @param predictors Predictor variables for the model
#' @param model_type Type of cure model: mixture (smcure), non-mixture
#'   (flexsurvcure), cuRe, npcure, or all
#' @param cure_link Link function for the cure probability model
#' @param survival_dist Distribution for modeling survival of uncured patients
#' @param bootstrap_ci Use bootstrap for confidence interval estimation
#' @param n_bootstrap Number of bootstrap samples
#' @param cure_threshold Time threshold for defining cured patients
#' @param plot_cure_fraction Generate cure fraction plot
#' @param plot_survival Generate survival curve plots
#' @param goodness_of_fit Conduct goodness of fit assessment
#' @param sensitivity_analysis Conduct sensitivity analysis
#' @param use_background_mortality Enable background mortality integration
#'   using cuRe package
#' @param background_hazard_var Background hazard variable for cuRe models
#' @param cure_expected_rate Expected cure rate variable for relative cure
#'   models
#' @param use_nonparametric Enable nonparametric cure estimation using npcure
#'   package
#' @param npcure_covariate Continuous covariate for npcure model (limited to
#'   one variable)
#' @param npcure_bandwidth Bandwidth parameter for npcure kernel smoothing
#' @param npcure_time_points Number of time points for testimate in npcure
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$warnings} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$cureTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$cureFractionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$survivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$goodnessOfFit} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$sensitivityAnalysis} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelTable$asDF}
#'
#' \code{as.data.frame(results$modelTable)}
#'
#' @export
curemodels <- function(
    data,
    time,
    status,
    predictors,
    model_type = "mixture",
    cure_link = "logit",
    survival_dist = "weibull",
    bootstrap_ci = FALSE,
    n_bootstrap = 1000,
    cure_threshold = 60,
    plot_cure_fraction = TRUE,
    plot_survival = TRUE,
    goodness_of_fit = TRUE,
    sensitivity_analysis = FALSE,
    use_background_mortality = FALSE,
    background_hazard_var,
    cure_expected_rate,
    use_nonparametric = FALSE,
    npcure_covariate,
    npcure_bandwidth = "auto",
    npcure_time_points = 100) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("curemodels requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(status)) status <- jmvcore::resolveQuo(jmvcore::enquo(status))
    if ( ! missing(predictors)) predictors <- jmvcore::resolveQuo(jmvcore::enquo(predictors))
    if ( ! missing(background_hazard_var)) background_hazard_var <- jmvcore::resolveQuo(jmvcore::enquo(background_hazard_var))
    if ( ! missing(cure_expected_rate)) cure_expected_rate <- jmvcore::resolveQuo(jmvcore::enquo(cure_expected_rate))
    if ( ! missing(npcure_covariate)) npcure_covariate <- jmvcore::resolveQuo(jmvcore::enquo(npcure_covariate))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(status), status, NULL),
            `if`( ! missing(predictors), predictors, NULL),
            `if`( ! missing(background_hazard_var), background_hazard_var, NULL),
            `if`( ! missing(cure_expected_rate), cure_expected_rate, NULL),
            `if`( ! missing(npcure_covariate), npcure_covariate, NULL))


    options <- curemodelsOptions$new(
        time = time,
        status = status,
        predictors = predictors,
        model_type = model_type,
        cure_link = cure_link,
        survival_dist = survival_dist,
        bootstrap_ci = bootstrap_ci,
        n_bootstrap = n_bootstrap,
        cure_threshold = cure_threshold,
        plot_cure_fraction = plot_cure_fraction,
        plot_survival = plot_survival,
        goodness_of_fit = goodness_of_fit,
        sensitivity_analysis = sensitivity_analysis,
        use_background_mortality = use_background_mortality,
        background_hazard_var = background_hazard_var,
        cure_expected_rate = cure_expected_rate,
        use_nonparametric = use_nonparametric,
        npcure_covariate = npcure_covariate,
        npcure_bandwidth = npcure_bandwidth,
        npcure_time_points = npcure_time_points)

    analysis <- curemodelsClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

