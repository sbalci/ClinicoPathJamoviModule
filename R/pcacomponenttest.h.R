
# This file is automatically generated, you probably don't want to edit this

pcacomponenttestOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "pcacomponenttestOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            vars = NULL,
            ncomp = 5,
            nperm = 1000,
            center = TRUE,
            scale = TRUE,
            conflevel = 0.95,
            adjustmethod = "BH",
            showpercent = TRUE,
            colororiginal = "steelblue",
            colorpermuted = "orange",
            showScreePlot = FALSE,
            showLoadingsPlot = FALSE,
            nLoadings = 5,
            plotwidth = 600,
            plotheight = 450, ...) {

            super$initialize(
                package="ClinicoPath",
                name="pcacomponenttest",
                requiresData=TRUE,
                ...)

            private$..vars <- jmvcore::OptionVariables$new(
                "vars",
                vars,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..ncomp <- jmvcore::OptionInteger$new(
                "ncomp",
                ncomp,
                min=1,
                max=20,
                default=5)
            private$..nperm <- jmvcore::OptionInteger$new(
                "nperm",
                nperm,
                min=100,
                max=10000,
                default=1000)
            private$..center <- jmvcore::OptionBool$new(
                "center",
                center,
                default=TRUE)
            private$..scale <- jmvcore::OptionBool$new(
                "scale",
                scale,
                default=TRUE)
            private$..conflevel <- jmvcore::OptionNumber$new(
                "conflevel",
                conflevel,
                min=0.8,
                max=0.99,
                default=0.95)
            private$..adjustmethod <- jmvcore::OptionList$new(
                "adjustmethod",
                adjustmethod,
                options=list(
                    "BH",
                    "bonferroni",
                    "holm",
                    "hochberg",
                    "hommel",
                    "BY",
                    "none"),
                default="BH")
            private$..showpercent <- jmvcore::OptionBool$new(
                "showpercent",
                showpercent,
                default=TRUE)
            private$..colororiginal <- jmvcore::OptionString$new(
                "colororiginal",
                colororiginal,
                default="steelblue")
            private$..colorpermuted <- jmvcore::OptionString$new(
                "colorpermuted",
                colorpermuted,
                default="orange")
            private$..showScreePlot <- jmvcore::OptionBool$new(
                "showScreePlot",
                showScreePlot,
                default=FALSE)
            private$..showLoadingsPlot <- jmvcore::OptionBool$new(
                "showLoadingsPlot",
                showLoadingsPlot,
                default=FALSE)
            private$..nLoadings <- jmvcore::OptionInteger$new(
                "nLoadings",
                nLoadings,
                min=1,
                max=50,
                default=5)
            private$..plotwidth <- jmvcore::OptionInteger$new(
                "plotwidth",
                plotwidth,
                min=300,
                max=2000,
                default=600)
            private$..plotheight <- jmvcore::OptionInteger$new(
                "plotheight",
                plotheight,
                min=300,
                max=2000,
                default=450)

            self$.addOption(private$..vars)
            self$.addOption(private$..ncomp)
            self$.addOption(private$..nperm)
            self$.addOption(private$..center)
            self$.addOption(private$..scale)
            self$.addOption(private$..conflevel)
            self$.addOption(private$..adjustmethod)
            self$.addOption(private$..showpercent)
            self$.addOption(private$..colororiginal)
            self$.addOption(private$..colorpermuted)
            self$.addOption(private$..showScreePlot)
            self$.addOption(private$..showLoadingsPlot)
            self$.addOption(private$..nLoadings)
            self$.addOption(private$..plotwidth)
            self$.addOption(private$..plotheight)
        }),
    active = list(
        vars = function() private$..vars$value,
        ncomp = function() private$..ncomp$value,
        nperm = function() private$..nperm$value,
        center = function() private$..center$value,
        scale = function() private$..scale$value,
        conflevel = function() private$..conflevel$value,
        adjustmethod = function() private$..adjustmethod$value,
        showpercent = function() private$..showpercent$value,
        colororiginal = function() private$..colororiginal$value,
        colorpermuted = function() private$..colorpermuted$value,
        showScreePlot = function() private$..showScreePlot$value,
        showLoadingsPlot = function() private$..showLoadingsPlot$value,
        nLoadings = function() private$..nLoadings$value,
        plotwidth = function() private$..plotwidth$value,
        plotheight = function() private$..plotheight$value),
    private = list(
        ..vars = NA,
        ..ncomp = NA,
        ..nperm = NA,
        ..center = NA,
        ..scale = NA,
        ..conflevel = NA,
        ..adjustmethod = NA,
        ..showpercent = NA,
        ..colororiginal = NA,
        ..colorpermuted = NA,
        ..showScreePlot = NA,
        ..showLoadingsPlot = NA,
        ..nLoadings = NA,
        ..plotwidth = NA,
        ..plotheight = NA)
)

pcacomponenttestResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "pcacomponenttestResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        results = function() private$.items[["results"]],
        vafplot = function() private$.items[["vafplot"]],
        screePlot = function() private$.items[["screePlot"]],
        loadingsPlot = function() private$.items[["loadingsPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="PCA Component Significance Test",
                refs=list(
                    "glue"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="results",
                title="Component Significance Results",
                clearWith=list(
                    "vars",
                    "ncomp",
                    "nperm",
                    "center",
                    "scale",
                    "conflevel",
                    "adjustmethod"),
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="originalvaf", 
                        `title`="Original VAF", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="meanvaf", 
                        `title`="Permuted Mean VAF", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="cilow", 
                        `title`="CI Lower", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="cihigh", 
                        `title`="CI Upper", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="pvalue", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="adjpvalue", 
                        `title`="Adjusted p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="significant", 
                        `title`="Sig.", 
                        `type`="text", 
                        `content`="($key)"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="vafplot",
                title="VAF Plot - Original vs Permuted",
                width=600,
                height=450,
                renderFun=".vafplot",
                requiresData=TRUE,
                clearWith=list(
                    "vars",
                    "ncomp",
                    "nperm",
                    "center",
                    "scale",
                    "conflevel",
                    "showpercent",
                    "colororiginal",
                    "colorpermuted",
                    "plotwidth",
                    "plotheight")))
            self$add(jmvcore::Image$new(
                options=options,
                name="screePlot",
                title="Scree Plot (Eigenvalues)",
                width=600,
                height=450,
                renderFun=".screePlot",
                visible="(showScreePlot)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="loadingsPlot",
                title="Variable Loadings Plot",
                width=600,
                height=600,
                renderFun=".loadingsPlot",
                visible="(showLoadingsPlot)"))}))

pcacomponenttestBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "pcacomponenttestBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "pcacomponenttest",
                version = c(1,0,0),
                options = options,
                results = pcacomponenttestResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' PCA Component Significance Test
#'
#' Performs SEQUENTIAL permutation-based significance testing to determine 
#' which principal
#' components explain more variance than expected by random chance. This 
#' provides
#' an objective, hypothesis-tested approach to component retention.
#' 
#' The test uses the Buja & Eyuboglu (1992) sequential method where:
#' 1. Each component is tested against a permutation null distribution
#' 2. Significant components have their variance REMOVED before testing the 
#' next component
#' 3. Testing STOPS when the first non-significant component is found
#' 
#' This sequential approach prevents inflated Type I errors that occur when 
#' all components
#' are tested against the same null distribution (batch testing).
#' 
#' CRITICAL: Requires centered and scaled data for valid correlation-based 
#' interpretation.
#' Without centering/scaling, the test compares raw variance instead of 
#' correlation structure.
#' 
#'
#' @examples
#' # Example with mtcars dataset
#' data("mtcars")
#'
#' # Test significance of first 5 principal components
#' pcacomponenttest(
#'   data = mtcars,
#'   vars = c("mpg", "disp", "hp", "drat", "wt", "qsec"),
#'   ncomp = 5,
#'   nperm = 1000,
#'   center = TRUE,
#'   scale = TRUE,
#'   conflevel = 0.95,
#'   adjustmethod = "BH"
#' )
#'
#' @section References:
#' Buja A, Eyuboglu N. (1992). Remarks on Parallel Analysis. Multivariate Behavioral Research, 27(4):509-540.
#'
#' Torres-Espin A, Chou A, Huie JR, et al. (2021). Reproducible analysis of disease space via principal components using the novel R package syndRomics. eLife, 10:e61812.
#'
#' @param data The data as a data frame.
#' @param vars Continuous variables to include in Principal Component
#'   Analysis. Select at least 3 numeric variables.
#' @param ncomp Number of principal components to test for significance (1 to
#'   20). Testing will be performed for PC1 through the specified number of
#'   components.
#' @param nperm Number of permutations to generate null distribution
#'   (100-10000). Higher values provide more accurate p-values but take longer.
#'   Minimum p-value = 1/(nperm+1). For p<0.001, use nperm>=1000.
#' @param center Center variables to have mean = 0 before PCA. Recommended:
#'   TRUE for most analyses.
#' @param scale Scale variables to have standard deviation = 1 before PCA.
#'   Recommended: TRUE when variables have different units or scales.
#' @param conflevel Confidence level for confidence intervals (0.80-0.99).
#'   Default: 0.95 for 95\% CI.
#' @param adjustmethod Method for adjusting p-values for multiple testing. BH
#'   (Benjamini-Hochberg) controls false discovery rate.
#' @param showpercent Display variance accounted for (VAF) as percentage
#'   (0-100) instead of proportion (0-1).
#' @param colororiginal Color for original VAF line/points. Use color names or
#'   hex codes.
#' @param colorpermuted Color for permuted VAF line/points. Use color names or
#'   hex codes.
#' @param showScreePlot Display a scree plot of eigenvalues.
#' @param showLoadingsPlot Display a plot of variable loadings for significant
#'   components.
#' @param nLoadings Number of top variables to display in loadings plot.
#' @param plotwidth Width of the plot in pixels.
#' @param plotheight Height of the plot in pixels.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$results} \tab \tab \tab \tab \tab Statistical significance of principal components based on permutation testing \cr
#'   \code{results$vafplot} \tab \tab \tab \tab \tab Visualization comparing original VAF to permuted null distribution \cr
#'   \code{results$screePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$loadingsPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$results$asDF}
#'
#' \code{as.data.frame(results$results)}
#'
#' @export
pcacomponenttest <- function(
    data,
    vars,
    ncomp = 5,
    nperm = 1000,
    center = TRUE,
    scale = TRUE,
    conflevel = 0.95,
    adjustmethod = "BH",
    showpercent = TRUE,
    colororiginal = "steelblue",
    colorpermuted = "orange",
    showScreePlot = FALSE,
    showLoadingsPlot = FALSE,
    nLoadings = 5,
    plotwidth = 600,
    plotheight = 450) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("pcacomponenttest requires jmvcore to be installed (restart may be required)")

    if ( ! missing(vars)) vars <- jmvcore::resolveQuo(jmvcore::enquo(vars))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(vars), vars, NULL))


    options <- pcacomponenttestOptions$new(
        vars = vars,
        ncomp = ncomp,
        nperm = nperm,
        center = center,
        scale = scale,
        conflevel = conflevel,
        adjustmethod = adjustmethod,
        showpercent = showpercent,
        colororiginal = colororiginal,
        colorpermuted = colorpermuted,
        showScreePlot = showScreePlot,
        showLoadingsPlot = showLoadingsPlot,
        nLoadings = nLoadings,
        plotwidth = plotwidth,
        plotheight = plotheight)

    analysis <- pcacomponenttestClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

