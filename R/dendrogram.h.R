
# This file is automatically generated, you probably don't want to edit this

dendrogramOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "dendrogramOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            vars = NULL,
            clusterMethod = "ward.D2",
            distanceMethod = "euclidean",
            standardize = TRUE,
            showLabels = TRUE,
            colorGroups = FALSE,
            group = NULL,
            plotHeight = 600,
            plotWidth = 800,
            plotType = "linear",
            edgeType = "diagonal",
            colorScheme = "default",
            highlightClusters = FALSE,
            nClusters = 3,
            maxLabels = 50,
            showRowDendro = TRUE,
            showColDendro = TRUE,
            heatmapScale = "row",
            heatmapPalette = "bluered",
            showCellBorders = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="dendrogram",
                requiresData=TRUE,
                ...)

            private$..vars <- jmvcore::OptionVariables$new(
                "vars",
                vars,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..clusterMethod <- jmvcore::OptionList$new(
                "clusterMethod",
                clusterMethod,
                options=list(
                    "complete",
                    "single",
                    "average",
                    "ward.D2",
                    "ward.D",
                    "mcquitty",
                    "median",
                    "centroid"),
                default="ward.D2")
            private$..distanceMethod <- jmvcore::OptionList$new(
                "distanceMethod",
                distanceMethod,
                options=list(
                    "euclidean",
                    "maximum",
                    "manhattan",
                    "canberra",
                    "binary",
                    "minkowski"),
                default="euclidean")
            private$..standardize <- jmvcore::OptionBool$new(
                "standardize",
                standardize,
                default=TRUE)
            private$..showLabels <- jmvcore::OptionBool$new(
                "showLabels",
                showLabels,
                default=TRUE)
            private$..colorGroups <- jmvcore::OptionBool$new(
                "colorGroups",
                colorGroups,
                default=FALSE)
            private$..group <- jmvcore::OptionVariable$new(
                "group",
                group,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..plotHeight <- jmvcore::OptionNumber$new(
                "plotHeight",
                plotHeight,
                min=200,
                max=2000,
                default=600)
            private$..plotWidth <- jmvcore::OptionNumber$new(
                "plotWidth",
                plotWidth,
                min=200,
                max=2000,
                default=800)
            private$..plotType <- jmvcore::OptionList$new(
                "plotType",
                plotType,
                options=list(
                    "linear",
                    "circular",
                    "base",
                    "heatmap"),
                default="linear")
            private$..edgeType <- jmvcore::OptionList$new(
                "edgeType",
                edgeType,
                options=list(
                    "diagonal",
                    "link",
                    "elbow"),
                default="diagonal")
            private$..colorScheme <- jmvcore::OptionList$new(
                "colorScheme",
                colorScheme,
                options=list(
                    "default",
                    "viridis",
                    "RdYlBu",
                    "Set1",
                    "Dark2"),
                default="default")
            private$..highlightClusters <- jmvcore::OptionBool$new(
                "highlightClusters",
                highlightClusters,
                default=FALSE)
            private$..nClusters <- jmvcore::OptionNumber$new(
                "nClusters",
                nClusters,
                min=2,
                max=10,
                default=3)
            private$..maxLabels <- jmvcore::OptionNumber$new(
                "maxLabels",
                maxLabels,
                min=0,
                max=200,
                default=50)
            private$..showRowDendro <- jmvcore::OptionBool$new(
                "showRowDendro",
                showRowDendro,
                default=TRUE)
            private$..showColDendro <- jmvcore::OptionBool$new(
                "showColDendro",
                showColDendro,
                default=TRUE)
            private$..heatmapScale <- jmvcore::OptionList$new(
                "heatmapScale",
                heatmapScale,
                options=list(
                    "none",
                    "row",
                    "column"),
                default="row")
            private$..heatmapPalette <- jmvcore::OptionList$new(
                "heatmapPalette",
                heatmapPalette,
                options=list(
                    "bluered",
                    "viridis",
                    "RdYlBu",
                    "spectral"),
                default="bluered")
            private$..showCellBorders <- jmvcore::OptionBool$new(
                "showCellBorders",
                showCellBorders,
                default=FALSE)

            self$.addOption(private$..vars)
            self$.addOption(private$..clusterMethod)
            self$.addOption(private$..distanceMethod)
            self$.addOption(private$..standardize)
            self$.addOption(private$..showLabels)
            self$.addOption(private$..colorGroups)
            self$.addOption(private$..group)
            self$.addOption(private$..plotHeight)
            self$.addOption(private$..plotWidth)
            self$.addOption(private$..plotType)
            self$.addOption(private$..edgeType)
            self$.addOption(private$..colorScheme)
            self$.addOption(private$..highlightClusters)
            self$.addOption(private$..nClusters)
            self$.addOption(private$..maxLabels)
            self$.addOption(private$..showRowDendro)
            self$.addOption(private$..showColDendro)
            self$.addOption(private$..heatmapScale)
            self$.addOption(private$..heatmapPalette)
            self$.addOption(private$..showCellBorders)
        }),
    active = list(
        vars = function() private$..vars$value,
        clusterMethod = function() private$..clusterMethod$value,
        distanceMethod = function() private$..distanceMethod$value,
        standardize = function() private$..standardize$value,
        showLabels = function() private$..showLabels$value,
        colorGroups = function() private$..colorGroups$value,
        group = function() private$..group$value,
        plotHeight = function() private$..plotHeight$value,
        plotWidth = function() private$..plotWidth$value,
        plotType = function() private$..plotType$value,
        edgeType = function() private$..edgeType$value,
        colorScheme = function() private$..colorScheme$value,
        highlightClusters = function() private$..highlightClusters$value,
        nClusters = function() private$..nClusters$value,
        maxLabels = function() private$..maxLabels$value,
        showRowDendro = function() private$..showRowDendro$value,
        showColDendro = function() private$..showColDendro$value,
        heatmapScale = function() private$..heatmapScale$value,
        heatmapPalette = function() private$..heatmapPalette$value,
        showCellBorders = function() private$..showCellBorders$value),
    private = list(
        ..vars = NA,
        ..clusterMethod = NA,
        ..distanceMethod = NA,
        ..standardize = NA,
        ..showLabels = NA,
        ..colorGroups = NA,
        ..group = NA,
        ..plotHeight = NA,
        ..plotWidth = NA,
        ..plotType = NA,
        ..edgeType = NA,
        ..colorScheme = NA,
        ..highlightClusters = NA,
        ..nClusters = NA,
        ..maxLabels = NA,
        ..showRowDendro = NA,
        ..showColDendro = NA,
        ..heatmapScale = NA,
        ..heatmapPalette = NA,
        ..showCellBorders = NA)
)

dendrogramResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "dendrogramResults",
    inherit = jmvcore::Group,
    active = list(
        welcome = function() private$.items[["welcome"]],
        plot = function() private$.items[["plot"]],
        clusterInfo = function() private$.items[["clusterInfo"]],
        summary = function() private$.items[["summary"]],
        clusterSummary = function() private$.items[["clusterSummary"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Dendrogram",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "BiocManager",
                    "tibble",
                    "tidyr",
                    "tidyHeatmap",
                    "grid",
                    "ComplexHeatmap",
                    "igraph",
                    "ggraph",
                    "dendextend",
                    "viridisLite",
                    "viridis",
                    "RColorBrewer",
                    "grDevices"))
            self$add(jmvcore::Html$new(
                options=options,
                name="welcome",
                title="",
                visible="(vars)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot",
                title="Dendrogram Plot",
                width=600,
                height=450,
                renderFun=".plot"))
            self$add(jmvcore::Html$new(
                options=options,
                name="clusterInfo",
                title="Cluster Information"))
            self$add(jmvcore::Table$new(
                options=options,
                name="summary",
                title="Summary Statistics",
                rows=0,
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="mean", 
                        `title`="Mean", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="sd", 
                        `title`="SD", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="missing", 
                        `title`="Missing", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="clusterSummary",
                title="Cluster Membership",
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="integer"),
                    list(
                        `name`="size", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="percent", 
                        `title`="Percent", 
                        `type`="number", 
                        `format`="zto"))))}))

dendrogramBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "dendrogramBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "dendrogram",
                version = c(0,0,31),
                options = options,
                results = dendrogramResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Dendrogram
#'
#' 
#' @param data .
#' @param vars .
#' @param clusterMethod .
#' @param distanceMethod .
#' @param standardize .
#' @param showLabels .
#' @param colorGroups .
#' @param group .
#' @param plotHeight .
#' @param plotWidth .
#' @param plotType .
#' @param edgeType .
#' @param colorScheme .
#' @param highlightClusters .
#' @param nClusters .
#' @param maxLabels .
#' @param showRowDendro .
#' @param showColDendro .
#' @param heatmapScale .
#' @param heatmapPalette .
#' @param showCellBorders .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$welcome} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$clusterInfo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clusterSummary} \tab \tab \tab \tab \tab a table \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summary$asDF}
#'
#' \code{as.data.frame(results$summary)}
#'
#' @export
dendrogram <- function(
    data,
    vars,
    clusterMethod = "ward.D2",
    distanceMethod = "euclidean",
    standardize = TRUE,
    showLabels = TRUE,
    colorGroups = FALSE,
    group,
    plotHeight = 600,
    plotWidth = 800,
    plotType = "linear",
    edgeType = "diagonal",
    colorScheme = "default",
    highlightClusters = FALSE,
    nClusters = 3,
    maxLabels = 50,
    showRowDendro = TRUE,
    showColDendro = TRUE,
    heatmapScale = "row",
    heatmapPalette = "bluered",
    showCellBorders = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("dendrogram requires jmvcore to be installed (restart may be required)")

    if ( ! missing(vars)) vars <- jmvcore::resolveQuo(jmvcore::enquo(vars))
    if ( ! missing(group)) group <- jmvcore::resolveQuo(jmvcore::enquo(group))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(vars), vars, NULL),
            `if`( ! missing(group), group, NULL))

    for (v in group) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- dendrogramOptions$new(
        vars = vars,
        clusterMethod = clusterMethod,
        distanceMethod = distanceMethod,
        standardize = standardize,
        showLabels = showLabels,
        colorGroups = colorGroups,
        group = group,
        plotHeight = plotHeight,
        plotWidth = plotWidth,
        plotType = plotType,
        edgeType = edgeType,
        colorScheme = colorScheme,
        highlightClusters = highlightClusters,
        nClusters = nClusters,
        maxLabels = maxLabels,
        showRowDendro = showRowDendro,
        showColDendro = showColDendro,
        heatmapScale = heatmapScale,
        heatmapPalette = heatmapPalette,
        showCellBorders = showCellBorders)

    analysis <- dendrogramClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

