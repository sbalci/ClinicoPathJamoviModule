
# This file is automatically generated, you probably don't want to edit this

enhancednonparametricOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "enhancednonparametricOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            dependent = NULL,
            grouping = NULL,
            exact_test = FALSE,
            posthoc = TRUE,
            posthoc_method = "bonferroni",
            show_plots = TRUE,
            confidence_level = 0.95, ...) {

            super$initialize(
                package="ClinicoPath",
                name="enhancednonparametric",
                requiresData=TRUE,
                ...)

            private$..dependent <- jmvcore::OptionVariable$new(
                "dependent",
                dependent,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..grouping <- jmvcore::OptionVariable$new(
                "grouping",
                grouping,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..exact_test <- jmvcore::OptionBool$new(
                "exact_test",
                exact_test,
                default=FALSE)
            private$..posthoc <- jmvcore::OptionBool$new(
                "posthoc",
                posthoc,
                default=TRUE)
            private$..posthoc_method <- jmvcore::OptionList$new(
                "posthoc_method",
                posthoc_method,
                options=list(
                    "bonferroni",
                    "holm",
                    "hochberg",
                    "fdr",
                    "bh",
                    "by"),
                default="bonferroni")
            private$..show_plots <- jmvcore::OptionBool$new(
                "show_plots",
                show_plots,
                default=TRUE)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)

            self$.addOption(private$..dependent)
            self$.addOption(private$..grouping)
            self$.addOption(private$..exact_test)
            self$.addOption(private$..posthoc)
            self$.addOption(private$..posthoc_method)
            self$.addOption(private$..show_plots)
            self$.addOption(private$..confidence_level)
        }),
    active = list(
        dependent = function() private$..dependent$value,
        grouping = function() private$..grouping$value,
        exact_test = function() private$..exact_test$value,
        posthoc = function() private$..posthoc$value,
        posthoc_method = function() private$..posthoc_method$value,
        show_plots = function() private$..show_plots$value,
        confidence_level = function() private$..confidence_level$value),
    private = list(
        ..dependent = NA,
        ..grouping = NA,
        ..exact_test = NA,
        ..posthoc = NA,
        ..posthoc_method = NA,
        ..show_plots = NA,
        ..confidence_level = NA)
)

enhancednonparametricResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "enhancednonparametricResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        descriptives = function() private$.items[["descriptives"]],
        assumptions = function() private$.items[["assumptions"]],
        tests = function() private$.items[["tests"]],
        effectsizes = function() private$.items[["effectsizes"]],
        posthoc = function() private$.items[["posthoc"]],
        distributionplot = function() private$.items[["distributionplot"]],
        effectsizeplot = function() private$.items[["effectsizeplot"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Enhanced Non-Parametric Tests")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Getting Started",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="descriptives",
                title="Descriptive Statistics",
                clearWith=list(
                    "dependent",
                    "grouping"),
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="median", 
                        `title`="Median", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="q1", 
                        `title`="Q1", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="q3", 
                        `title`="Q3", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="mean", 
                        `title`="Mean", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="sd", 
                        `title`="SD", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="min", 
                        `title`="Min", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="max", 
                        `title`="Max", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="assumptions",
                title="Assumption Testing",
                clearWith=list(
                    "dependent",
                    "grouping"),
                columns=list(
                    list(
                        `name`="assumption", 
                        `title`="Assumption", 
                        `type`="text"),
                    list(
                        `name`="assessment", 
                        `title`="Assessment", 
                        `type`="text"),
                    list(
                        `name`="recommendation", 
                        `title`="Recommendation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="tests",
                title="Non-Parametric Tests",
                clearWith=list(
                    "dependent",
                    "grouping",
                    "exact_test",
                    "confidence_level"),
                columns=list(
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="p", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="effect_size", 
                        `title`="Effect Size", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="effectsizes",
                title="Effect Size Summary",
                clearWith=list(
                    "dependent",
                    "grouping",
                    "confidence_level"),
                columns=list(
                    list(
                        `name`="measure", 
                        `title`="Effect Size Measure", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="posthoc",
                title="Post Hoc Comparisons (Dunn's Test)",
                visible="(posthoc)",
                clearWith=list(
                    "dependent",
                    "grouping",
                    "posthoc_method",
                    "confidence_level"),
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="z_statistic", 
                        `title`="Z", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="p_raw", 
                        `title`="p (raw)", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="p_adjusted", 
                        `title`="p (adj)", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="effect_size", 
                        `title`="Effect Size (r)", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="significance", 
                        `title`="Sig", 
                        `type`="text"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="distributionplot",
                title="Distribution Comparison",
                width=600,
                height=500,
                visible="(show_plots)",
                requiresData=TRUE,
                clearWith=list(
                    "dependent",
                    "grouping",
                    "show_plots")))
            self$add(jmvcore::Image$new(
                options=options,
                name="effectsizeplot",
                title="Effect Size Plot",
                width=600,
                height=400,
                visible="(show_plots)",
                requiresData=TRUE,
                clearWith=list(
                    "dependent",
                    "grouping",
                    "show_plots",
                    "confidence_level")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation and Guidelines",
                visible=TRUE))}))

enhancednonparametricBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "enhancednonparametricBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "enhancednonparametric",
                version = c(1,0,0),
                options = options,
                results = enhancednonparametricResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Enhanced Non-Parametric Tests
#'
#' Enhanced Mann-Whitney U and Kruskal-Wallis tests with comprehensive
#' effect size calculations, assumption checking, and post hoc analysis. 
#' Essential for pathology research with non-normal data.
#' 
#'
#' @examples
#' data('histopathology')
#'
#' enhancednonparametric(data = histopathology,
#'                      dependent = measurement,
#'                      grouping = group)
#'
#' @param data the data as a data frame
#' @param dependent The dependent variable from \code{data}, variable must be
#'   numeric
#' @param grouping The grouping variable from \code{data}, variable must be a
#'   factor
#' @param exact_test Use exact computation for Mann-Whitney U test p-values
#' @param posthoc Perform post hoc tests for multi-group comparisons
#'   (Kruskal-Wallis)
#' @param posthoc_method Multiple comparison correction method for post hoc
#'   tests
#' @param show_plots Generate distribution and effect size plots
#' @param confidence_level Confidence level for confidence intervals and tests
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$descriptives} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$assumptions} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$tests} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$effectsizes} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$posthoc} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$distributionplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$effectsizeplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$descriptives$asDF}
#'
#' \code{as.data.frame(results$descriptives)}
#'
#' @export
enhancednonparametric <- function(
    data,
    dependent,
    grouping,
    exact_test = FALSE,
    posthoc = TRUE,
    posthoc_method = "bonferroni",
    show_plots = TRUE,
    confidence_level = 0.95) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("enhancednonparametric requires jmvcore to be installed (restart may be required)")

    if ( ! missing(dependent)) dependent <- jmvcore::resolveQuo(jmvcore::enquo(dependent))
    if ( ! missing(grouping)) grouping <- jmvcore::resolveQuo(jmvcore::enquo(grouping))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(dependent), dependent, NULL),
            `if`( ! missing(grouping), grouping, NULL))

    for (v in grouping) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- enhancednonparametricOptions$new(
        dependent = dependent,
        grouping = grouping,
        exact_test = exact_test,
        posthoc = posthoc,
        posthoc_method = posthoc_method,
        show_plots = show_plots,
        confidence_level = confidence_level)

    analysis <- enhancednonparametricClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

