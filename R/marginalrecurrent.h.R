
# This file is automatically generated, you probably don't want to edit this

marginalrecurrentOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "marginalrecurrentOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            subjectID = NULL,
            time = NULL,
            event = NULL,
            terminal_time = NULL,
            terminal_event = NULL,
            covariates = NULL,
            model_type = "marginal",
            baseline_type = "nonparametric",
            confidence_level = 0.95,
            bootstrap = TRUE,
            bootstrap_samples = 1000,
            robust_se = TRUE,
            include_cumulative = TRUE,
            include_survival = TRUE,
            time_points = "",
            plotRecurrentEvents = TRUE,
            plotCumulative = TRUE,
            plotSurvival = TRUE,
            plotResiduals = FALSE,
            showEducation = TRUE,
            showInterpretation = TRUE,
            exportResults = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="marginalrecurrent",
                requiresData=TRUE,
                ...)

            private$..subjectID <- jmvcore::OptionVariable$new(
                "subjectID",
                subjectID,
                suggested=list(
                    "id"),
                permitted=list(
                    "factor",
                    "id"))
            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event <- jmvcore::OptionVariable$new(
                "event",
                event,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..terminal_time <- jmvcore::OptionVariable$new(
                "terminal_time",
                terminal_time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..terminal_event <- jmvcore::OptionVariable$new(
                "terminal_event",
                terminal_event,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..model_type <- jmvcore::OptionList$new(
                "model_type",
                model_type,
                options=list(
                    "marginal",
                    "accelerated",
                    "gamma_frailty"),
                default="marginal")
            private$..baseline_type <- jmvcore::OptionList$new(
                "baseline_type",
                baseline_type,
                options=list(
                    "nonparametric",
                    "weibull",
                    "loglinear"),
                default="nonparametric")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..bootstrap <- jmvcore::OptionBool$new(
                "bootstrap",
                bootstrap,
                default=TRUE)
            private$..bootstrap_samples <- jmvcore::OptionInteger$new(
                "bootstrap_samples",
                bootstrap_samples,
                min=100,
                max=5000,
                default=1000)
            private$..robust_se <- jmvcore::OptionBool$new(
                "robust_se",
                robust_se,
                default=TRUE)
            private$..include_cumulative <- jmvcore::OptionBool$new(
                "include_cumulative",
                include_cumulative,
                default=TRUE)
            private$..include_survival <- jmvcore::OptionBool$new(
                "include_survival",
                include_survival,
                default=TRUE)
            private$..time_points <- jmvcore::OptionString$new(
                "time_points",
                time_points,
                default="")
            private$..plotRecurrentEvents <- jmvcore::OptionBool$new(
                "plotRecurrentEvents",
                plotRecurrentEvents,
                default=TRUE)
            private$..plotCumulative <- jmvcore::OptionBool$new(
                "plotCumulative",
                plotCumulative,
                default=TRUE)
            private$..plotSurvival <- jmvcore::OptionBool$new(
                "plotSurvival",
                plotSurvival,
                default=TRUE)
            private$..plotResiduals <- jmvcore::OptionBool$new(
                "plotResiduals",
                plotResiduals,
                default=FALSE)
            private$..showEducation <- jmvcore::OptionBool$new(
                "showEducation",
                showEducation,
                default=TRUE)
            private$..showInterpretation <- jmvcore::OptionBool$new(
                "showInterpretation",
                showInterpretation,
                default=TRUE)
            private$..exportResults <- jmvcore::OptionBool$new(
                "exportResults",
                exportResults,
                default=FALSE)

            self$.addOption(private$..subjectID)
            self$.addOption(private$..time)
            self$.addOption(private$..event)
            self$.addOption(private$..terminal_time)
            self$.addOption(private$..terminal_event)
            self$.addOption(private$..covariates)
            self$.addOption(private$..model_type)
            self$.addOption(private$..baseline_type)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..bootstrap)
            self$.addOption(private$..bootstrap_samples)
            self$.addOption(private$..robust_se)
            self$.addOption(private$..include_cumulative)
            self$.addOption(private$..include_survival)
            self$.addOption(private$..time_points)
            self$.addOption(private$..plotRecurrentEvents)
            self$.addOption(private$..plotCumulative)
            self$.addOption(private$..plotSurvival)
            self$.addOption(private$..plotResiduals)
            self$.addOption(private$..showEducation)
            self$.addOption(private$..showInterpretation)
            self$.addOption(private$..exportResults)
        }),
    active = list(
        subjectID = function() private$..subjectID$value,
        time = function() private$..time$value,
        event = function() private$..event$value,
        terminal_time = function() private$..terminal_time$value,
        terminal_event = function() private$..terminal_event$value,
        covariates = function() private$..covariates$value,
        model_type = function() private$..model_type$value,
        baseline_type = function() private$..baseline_type$value,
        confidence_level = function() private$..confidence_level$value,
        bootstrap = function() private$..bootstrap$value,
        bootstrap_samples = function() private$..bootstrap_samples$value,
        robust_se = function() private$..robust_se$value,
        include_cumulative = function() private$..include_cumulative$value,
        include_survival = function() private$..include_survival$value,
        time_points = function() private$..time_points$value,
        plotRecurrentEvents = function() private$..plotRecurrentEvents$value,
        plotCumulative = function() private$..plotCumulative$value,
        plotSurvival = function() private$..plotSurvival$value,
        plotResiduals = function() private$..plotResiduals$value,
        showEducation = function() private$..showEducation$value,
        showInterpretation = function() private$..showInterpretation$value,
        exportResults = function() private$..exportResults$value),
    private = list(
        ..subjectID = NA,
        ..time = NA,
        ..event = NA,
        ..terminal_time = NA,
        ..terminal_event = NA,
        ..covariates = NA,
        ..model_type = NA,
        ..baseline_type = NA,
        ..confidence_level = NA,
        ..bootstrap = NA,
        ..bootstrap_samples = NA,
        ..robust_se = NA,
        ..include_cumulative = NA,
        ..include_survival = NA,
        ..time_points = NA,
        ..plotRecurrentEvents = NA,
        ..plotCumulative = NA,
        ..plotSurvival = NA,
        ..plotResiduals = NA,
        ..showEducation = NA,
        ..showInterpretation = NA,
        ..exportResults = NA)
)

marginalrecurrentResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "marginalrecurrentResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        modelfit = function() private$.items[["modelfit"]],
        coefficients = function() private$.items[["coefficients"]],
        cumulativeRate = function() private$.items[["cumulativeRate"]],
        survivalFunction = function() private$.items[["survivalFunction"]],
        goodnessOfFit = function() private$.items[["goodnessOfFit"]],
        educationalContent = function() private$.items[["educationalContent"]],
        interpretationContent = function() private$.items[["interpretationContent"]],
        recurrentEventsPlot = function() private$.items[["recurrentEventsPlot"]],
        cumulativePlot = function() private$.items[["cumulativePlot"]],
        survivalPlot = function() private$.items[["survivalPlot"]],
        residualsPlot = function() private$.items[["residualsPlot"]],
        exportTable = function() private$.items[["exportTable"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Marginal Models for Recurrent Events",
                refs=list(
                    "reReg",
                    "survival",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis Summary",
                clearWith=list(
                    "subjectID",
                    "time",
                    "event",
                    "covariates")))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelfit",
                title="Model Fit Summary",
                rows=1,
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model Type", 
                        `type`="text"),
                    list(
                        `name`="subjects", 
                        `title`="Subjects", 
                        `type`="integer"),
                    list(
                        `name`="events", 
                        `title`="Total Events", 
                        `type`="integer"),
                    list(
                        `name`="baseline", 
                        `title`="Baseline Function", 
                        `type`="text"),
                    list(
                        `name`="loglik", 
                        `title`="Log-Likelihood", 
                        `type`="number"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number")),
                clearWith=list(
                    "subjectID",
                    "time",
                    "event",
                    "covariates",
                    "model_type",
                    "baseline_type")))
            self$add(jmvcore::Table$new(
                options=options,
                name="coefficients",
                title="Model Coefficients",
                columns=list(
                    list(
                        `name`="covariate", 
                        `title`="Covariate", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="z", 
                        `title`="z-value", 
                        `type`="number"),
                    list(
                        `name`="p", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper", 
                        `title`="Upper CI", 
                        `type`="number")),
                clearWith=list(
                    "subjectID",
                    "time",
                    "event",
                    "covariates",
                    "model_type",
                    "confidence_level")))
            self$add(jmvcore::Table$new(
                options=options,
                name="cumulativeRate",
                title="Cumulative Rate Function",
                visible="(include_cumulative)",
                columns=list(
                    list(
                        `name`="time", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="cumrate", 
                        `title`="Cumulative Rate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper", 
                        `title`="Upper CI", 
                        `type`="number")),
                clearWith=list(
                    "subjectID",
                    "time",
                    "event",
                    "covariates",
                    "include_cumulative")))
            self$add(jmvcore::Table$new(
                options=options,
                name="survivalFunction",
                title="Survival Function",
                visible="(include_survival)",
                columns=list(
                    list(
                        `name`="time", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="survival", 
                        `title`="Survival", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper", 
                        `title`="Upper CI", 
                        `type`="number")),
                clearWith=list(
                    "subjectID",
                    "time",
                    "event",
                    "covariates",
                    "include_survival")))
            self$add(jmvcore::Table$new(
                options=options,
                name="goodnessOfFit",
                title="Goodness of Fit Tests",
                rows=3,
                columns=list(
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="p", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text")),
                clearWith=list(
                    "subjectID",
                    "time",
                    "event",
                    "covariates",
                    "model_type")))
            self$add(jmvcore::Html$new(
                options=options,
                name="educationalContent",
                title="Educational Overview",
                visible="(showEducation)",
                clearWith=list(
                    "model_type",
                    "baseline_type")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretationContent",
                title="Results Interpretation",
                visible="(showInterpretation)",
                clearWith=list(
                    "subjectID",
                    "time",
                    "event",
                    "covariates")))
            self$add(jmvcore::Image$new(
                options=options,
                name="recurrentEventsPlot",
                title="Recurrent Event Processes",
                width=800,
                height=600,
                renderFun=".recurrentEventsPlot",
                visible="(plotRecurrentEvents)",
                requiresData=TRUE,
                clearWith=list(
                    "subjectID",
                    "time",
                    "event")))
            self$add(jmvcore::Image$new(
                options=options,
                name="cumulativePlot",
                title="Cumulative Rate Function",
                width=700,
                height=500,
                renderFun=".cumulativePlot",
                visible="(plotCumulative)",
                requiresData=TRUE,
                clearWith=list(
                    "subjectID",
                    "time",
                    "event",
                    "covariates",
                    "include_cumulative")))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlot",
                title="Survival Function",
                width=700,
                height=500,
                renderFun=".survivalPlot",
                visible="(plotSurvival)",
                requiresData=TRUE,
                clearWith=list(
                    "subjectID",
                    "time",
                    "event",
                    "covariates",
                    "include_survival")))
            self$add(jmvcore::Image$new(
                options=options,
                name="residualsPlot",
                title="Model Residuals",
                width=800,
                height=600,
                renderFun=".residualsPlot",
                visible="(plotResiduals)",
                requiresData=TRUE,
                clearWith=list(
                    "subjectID",
                    "time",
                    "event",
                    "covariates",
                    "model_type")))
            self$add(jmvcore::Table$new(
                options=options,
                name="exportTable",
                title="Exported Results",
                visible="(exportResults)",
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"),
                    list(
                        `name`="interpretation", 
                        `title`="Clinical Interpretation", 
                        `type`="text")),
                clearWith=list(
                    "subjectID",
                    "time",
                    "event",
                    "covariates",
                    "exportResults")))}))

marginalrecurrentBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "marginalrecurrentBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "marginalrecurrent",
                version = c(0,0,1),
                options = options,
                results = marginalrecurrentResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Marginal Models for Recurrent Events
#'
#' Marginal models for analyzing recurrent event data using rate-based 
#' approaches.  This analysis provides population-average estimates of 
#' covariate effects on  recurrent event rates, with options for marginal rate 
#' models, accelerated rate  models, and gamma frailty models to handle 
#' within-subject correlation.
#'
#' @examples
#' data('histopathology', package='ClinicoPath')
#'
#' @param data .
#' @param subjectID .
#' @param time .
#' @param event .
#' @param terminal_time .
#' @param terminal_event .
#' @param covariates .
#' @param model_type .
#' @param baseline_type .
#' @param confidence_level .
#' @param bootstrap .
#' @param bootstrap_samples .
#' @param robust_se .
#' @param include_cumulative .
#' @param include_survival .
#' @param time_points .
#' @param plotRecurrentEvents .
#' @param plotCumulative .
#' @param plotSurvival .
#' @param plotResiduals .
#' @param showEducation .
#' @param showInterpretation .
#' @param exportResults .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelfit} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$coefficients} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$cumulativeRate} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$survivalFunction} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$goodnessOfFit} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$educationalContent} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$interpretationContent} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$recurrentEventsPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$cumulativePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$survivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$residualsPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$exportTable} \tab \tab \tab \tab \tab a table \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelfit$asDF}
#'
#' \code{as.data.frame(results$modelfit)}
#'
#' @export
marginalrecurrent <- function(
    data,
    subjectID,
    time,
    event,
    terminal_time,
    terminal_event,
    covariates,
    model_type = "marginal",
    baseline_type = "nonparametric",
    confidence_level = 0.95,
    bootstrap = TRUE,
    bootstrap_samples = 1000,
    robust_se = TRUE,
    include_cumulative = TRUE,
    include_survival = TRUE,
    time_points = "",
    plotRecurrentEvents = TRUE,
    plotCumulative = TRUE,
    plotSurvival = TRUE,
    plotResiduals = FALSE,
    showEducation = TRUE,
    showInterpretation = TRUE,
    exportResults = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("marginalrecurrent requires jmvcore to be installed (restart may be required)")

    if ( ! missing(subjectID)) subjectID <- jmvcore::resolveQuo(jmvcore::enquo(subjectID))
    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(event)) event <- jmvcore::resolveQuo(jmvcore::enquo(event))
    if ( ! missing(terminal_time)) terminal_time <- jmvcore::resolveQuo(jmvcore::enquo(terminal_time))
    if ( ! missing(terminal_event)) terminal_event <- jmvcore::resolveQuo(jmvcore::enquo(terminal_event))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(subjectID), subjectID, NULL),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(event), event, NULL),
            `if`( ! missing(terminal_time), terminal_time, NULL),
            `if`( ! missing(terminal_event), terminal_event, NULL),
            `if`( ! missing(covariates), covariates, NULL))

    for (v in event) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in terminal_event) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- marginalrecurrentOptions$new(
        subjectID = subjectID,
        time = time,
        event = event,
        terminal_time = terminal_time,
        terminal_event = terminal_event,
        covariates = covariates,
        model_type = model_type,
        baseline_type = baseline_type,
        confidence_level = confidence_level,
        bootstrap = bootstrap,
        bootstrap_samples = bootstrap_samples,
        robust_se = robust_se,
        include_cumulative = include_cumulative,
        include_survival = include_survival,
        time_points = time_points,
        plotRecurrentEvents = plotRecurrentEvents,
        plotCumulative = plotCumulative,
        plotSurvival = plotSurvival,
        plotResiduals = plotResiduals,
        showEducation = showEducation,
        showInterpretation = showInterpretation,
        exportResults = exportResults)

    analysis <- marginalrecurrentClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

