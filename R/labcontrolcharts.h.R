
# This file is automatically generated, you probably don't want to edit this

labcontrolchartsOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "labcontrolchartsOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            measurement = NULL,
            run_number = NULL,
            batch_id = NULL,
            control_level = NULL,
            chart_type = "shewhart",
            control_limits = "3sigma",
            target_mean = 0,
            target_sd = 0,
            cusum_k = 0.5,
            cusum_h = 4,
            ewma_lambda = 0.2,
            westgard_rules = "13s,22s,R4s",
            baseline_runs = 20,
            violation_detection = TRUE,
            trend_analysis = TRUE,
            shift_detection = TRUE,
            performance_metrics = TRUE,
            corrective_actions = TRUE,
            qc_summary = TRUE,
            export_violations = FALSE,
            control_plots = TRUE,
            histogram_plot = TRUE,
            trend_plot = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="labcontrolcharts",
                requiresData=TRUE,
                ...)

            private$..measurement <- jmvcore::OptionVariable$new(
                "measurement",
                measurement,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..run_number <- jmvcore::OptionVariable$new(
                "run_number",
                run_number,
                suggested=list(
                    "continuous",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..batch_id <- jmvcore::OptionVariable$new(
                "batch_id",
                batch_id,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..control_level <- jmvcore::OptionVariable$new(
                "control_level",
                control_level,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..chart_type <- jmvcore::OptionList$new(
                "chart_type",
                chart_type,
                options=list(
                    "shewhart",
                    "cusum",
                    "ewma",
                    "combined",
                    "multi_rule"),
                default="shewhart")
            private$..control_limits <- jmvcore::OptionList$new(
                "control_limits",
                control_limits,
                options=list(
                    "3sigma",
                    "2sigma",
                    "custom",
                    "westgard"),
                default="3sigma")
            private$..target_mean <- jmvcore::OptionNumber$new(
                "target_mean",
                target_mean,
                default=0)
            private$..target_sd <- jmvcore::OptionNumber$new(
                "target_sd",
                target_sd,
                default=0)
            private$..cusum_k <- jmvcore::OptionNumber$new(
                "cusum_k",
                cusum_k,
                min=0.1,
                max=2,
                default=0.5)
            private$..cusum_h <- jmvcore::OptionNumber$new(
                "cusum_h",
                cusum_h,
                min=1,
                max=10,
                default=4)
            private$..ewma_lambda <- jmvcore::OptionNumber$new(
                "ewma_lambda",
                ewma_lambda,
                min=0.05,
                max=1,
                default=0.2)
            private$..westgard_rules <- jmvcore::OptionString$new(
                "westgard_rules",
                westgard_rules,
                default="13s,22s,R4s")
            private$..baseline_runs <- jmvcore::OptionInteger$new(
                "baseline_runs",
                baseline_runs,
                min=10,
                max=100,
                default=20)
            private$..violation_detection <- jmvcore::OptionBool$new(
                "violation_detection",
                violation_detection,
                default=TRUE)
            private$..trend_analysis <- jmvcore::OptionBool$new(
                "trend_analysis",
                trend_analysis,
                default=TRUE)
            private$..shift_detection <- jmvcore::OptionBool$new(
                "shift_detection",
                shift_detection,
                default=TRUE)
            private$..performance_metrics <- jmvcore::OptionBool$new(
                "performance_metrics",
                performance_metrics,
                default=TRUE)
            private$..corrective_actions <- jmvcore::OptionBool$new(
                "corrective_actions",
                corrective_actions,
                default=TRUE)
            private$..qc_summary <- jmvcore::OptionBool$new(
                "qc_summary",
                qc_summary,
                default=TRUE)
            private$..export_violations <- jmvcore::OptionBool$new(
                "export_violations",
                export_violations,
                default=FALSE)
            private$..control_plots <- jmvcore::OptionBool$new(
                "control_plots",
                control_plots,
                default=TRUE)
            private$..histogram_plot <- jmvcore::OptionBool$new(
                "histogram_plot",
                histogram_plot,
                default=TRUE)
            private$..trend_plot <- jmvcore::OptionBool$new(
                "trend_plot",
                trend_plot,
                default=TRUE)

            self$.addOption(private$..measurement)
            self$.addOption(private$..run_number)
            self$.addOption(private$..batch_id)
            self$.addOption(private$..control_level)
            self$.addOption(private$..chart_type)
            self$.addOption(private$..control_limits)
            self$.addOption(private$..target_mean)
            self$.addOption(private$..target_sd)
            self$.addOption(private$..cusum_k)
            self$.addOption(private$..cusum_h)
            self$.addOption(private$..ewma_lambda)
            self$.addOption(private$..westgard_rules)
            self$.addOption(private$..baseline_runs)
            self$.addOption(private$..violation_detection)
            self$.addOption(private$..trend_analysis)
            self$.addOption(private$..shift_detection)
            self$.addOption(private$..performance_metrics)
            self$.addOption(private$..corrective_actions)
            self$.addOption(private$..qc_summary)
            self$.addOption(private$..export_violations)
            self$.addOption(private$..control_plots)
            self$.addOption(private$..histogram_plot)
            self$.addOption(private$..trend_plot)
        }),
    active = list(
        measurement = function() private$..measurement$value,
        run_number = function() private$..run_number$value,
        batch_id = function() private$..batch_id$value,
        control_level = function() private$..control_level$value,
        chart_type = function() private$..chart_type$value,
        control_limits = function() private$..control_limits$value,
        target_mean = function() private$..target_mean$value,
        target_sd = function() private$..target_sd$value,
        cusum_k = function() private$..cusum_k$value,
        cusum_h = function() private$..cusum_h$value,
        ewma_lambda = function() private$..ewma_lambda$value,
        westgard_rules = function() private$..westgard_rules$value,
        baseline_runs = function() private$..baseline_runs$value,
        violation_detection = function() private$..violation_detection$value,
        trend_analysis = function() private$..trend_analysis$value,
        shift_detection = function() private$..shift_detection$value,
        performance_metrics = function() private$..performance_metrics$value,
        corrective_actions = function() private$..corrective_actions$value,
        qc_summary = function() private$..qc_summary$value,
        export_violations = function() private$..export_violations$value,
        control_plots = function() private$..control_plots$value,
        histogram_plot = function() private$..histogram_plot$value,
        trend_plot = function() private$..trend_plot$value),
    private = list(
        ..measurement = NA,
        ..run_number = NA,
        ..batch_id = NA,
        ..control_level = NA,
        ..chart_type = NA,
        ..control_limits = NA,
        ..target_mean = NA,
        ..target_sd = NA,
        ..cusum_k = NA,
        ..cusum_h = NA,
        ..ewma_lambda = NA,
        ..westgard_rules = NA,
        ..baseline_runs = NA,
        ..violation_detection = NA,
        ..trend_analysis = NA,
        ..shift_detection = NA,
        ..performance_metrics = NA,
        ..corrective_actions = NA,
        ..qc_summary = NA,
        ..export_violations = NA,
        ..control_plots = NA,
        ..histogram_plot = NA,
        ..trend_plot = NA)
)

labcontrolchartsResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "labcontrolchartsResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        dataInfo = function() private$.items[["dataInfo"]],
        controlLimits = function() private$.items[["controlLimits"]],
        violationSummary = function() private$.items[["violationSummary"]],
        violationDetails = function() private$.items[["violationDetails"]],
        trendAnalysis = function() private$.items[["trendAnalysis"]],
        shiftDetection = function() private$.items[["shiftDetection"]],
        performanceMetrics = function() private$.items[["performanceMetrics"]],
        qcStatistics = function() private$.items[["qcStatistics"]],
        correctiveActions = function() private$.items[["correctiveActions"]],
        westgardInterpretation = function() private$.items[["westgardInterpretation"]],
        shewhartChart = function() private$.items[["shewhartChart"]],
        cusumChart = function() private$.items[["cusumChart"]],
        ewmaChart = function() private$.items[["ewmaChart"]],
        distributionPlot = function() private$.items[["distributionPlot"]],
        trendPlot = function() private$.items[["trendPlot"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Laboratory Control Charts (Shewhart, CUSUM, EWMA)")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Analysis Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="dataInfo",
                title="Data Summary",
                visible=TRUE,
                rows=1,
                clearWith=list(
                    "measurement",
                    "run_number"),
                columns=list(
                    list(
                        `name`="characteristic", 
                        `title`="Characteristic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="controlLimits",
                title="Control Limits and Parameters",
                visible=TRUE,
                rows=1,
                clearWith=list(
                    "measurement",
                    "chart_type",
                    "control_limits"),
                columns=list(
                    list(
                        `name`="chart_type", 
                        `title`="Chart Type", 
                        `type`="text"),
                    list(
                        `name`="center_line", 
                        `title`="Center Line (CL)", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="upper_control_limit", 
                        `title`="Upper Control Limit (UCL)", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="lower_control_limit", 
                        `title`="Lower Control Limit (LCL)", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="upper_warning_limit", 
                        `title`="Upper Warning Limit (UWL)", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="lower_warning_limit", 
                        `title`="Lower Warning Limit (LWL)", 
                        `type`="number", 
                        `format`="zto:4"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="violationSummary",
                title="Control Rule Violations Summary",
                visible="(violation_detection)",
                rows=1,
                clearWith=list(
                    "violation_detection",
                    "measurement",
                    "chart_type"),
                columns=list(
                    list(
                        `name`="rule", 
                        `title`="Control Rule", 
                        `type`="text"),
                    list(
                        `name`="violations", 
                        `title`="Number of Violations", 
                        `type`="integer"),
                    list(
                        `name`="violation_rate", 
                        `title`="Violation Rate (%)", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="first_violation", 
                        `title`="First Violation (Run)", 
                        `type`="integer"),
                    list(
                        `name`="last_violation", 
                        `title`="Last Violation (Run)", 
                        `type`="integer"),
                    list(
                        `name`="severity", 
                        `title`="Severity", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="violationDetails",
                title="Detailed Violation List",
                visible="(export_violations)",
                rows=1,
                clearWith=list(
                    "export_violations",
                    "measurement"),
                columns=list(
                    list(
                        `name`="run_number", 
                        `title`="Run Number", 
                        `type`="integer"),
                    list(
                        `name`="measurement_value", 
                        `title`="Measurement Value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="violation_type", 
                        `title`="Violation Type", 
                        `type`="text"),
                    list(
                        `name`="rule_violated", 
                        `title`="Rule Violated", 
                        `type`="text"),
                    list(
                        `name`="action_required", 
                        `title`="Action Required", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="trendAnalysis",
                title="Trend Analysis Results",
                visible="(trend_analysis)",
                rows=1,
                clearWith=list(
                    "trend_analysis",
                    "measurement"),
                columns=list(
                    list(
                        `name`="trend_type", 
                        `title`="Trend Type", 
                        `type`="text"),
                    list(
                        `name`="detected", 
                        `title`="Detected", 
                        `type`="text"),
                    list(
                        `name`="start_run", 
                        `title`="Start Run", 
                        `type`="integer"),
                    list(
                        `name`="end_run", 
                        `title`="End Run", 
                        `type`="integer"),
                    list(
                        `name`="slope", 
                        `title`="Slope", 
                        `type`="number", 
                        `format`="zto:6"),
                    list(
                        `name`="significance", 
                        `title`="Statistical Significance", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="shiftDetection",
                title="Shift Detection Analysis",
                visible="(shift_detection)",
                rows=1,
                clearWith=list(
                    "shift_detection",
                    "measurement"),
                columns=list(
                    list(
                        `name`="shift_point", 
                        `title`="Shift Point (Run)", 
                        `type`="integer"),
                    list(
                        `name`="shift_magnitude", 
                        `title`="Shift Magnitude", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="shift_direction", 
                        `title`="Direction", 
                        `type`="text"),
                    list(
                        `name`="before_mean", 
                        `title`="Mean Before", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="after_mean", 
                        `title`="Mean After", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="statistical_test", 
                        `title`="Statistical Test", 
                        `type`="text"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto:4"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="performanceMetrics",
                title="Control Chart Performance Metrics",
                visible="(performance_metrics)",
                rows=1,
                clearWith=list(
                    "performance_metrics",
                    "chart_type"),
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Performance Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"),
                    list(
                        `name`="acceptable_range", 
                        `title`="Acceptable Range", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="qcStatistics",
                title="Quality Control Statistics",
                visible="(qc_summary)",
                rows=1,
                clearWith=list(
                    "qc_summary",
                    "measurement"),
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="QC Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="correctiveActions",
                title="Corrective Action Recommendations",
                visible="(corrective_actions)",
                rows=1,
                clearWith=list(
                    "corrective_actions",
                    "violation_detection"),
                columns=list(
                    list(
                        `name`="issue_identified", 
                        `title`="Issue Identified", 
                        `type`="text"),
                    list(
                        `name`="priority", 
                        `title`="Priority", 
                        `type`="text"),
                    list(
                        `name`="recommended_action", 
                        `title`="Recommended Action", 
                        `type`="text"),
                    list(
                        `name`="timeframe", 
                        `title`="Timeframe", 
                        `type`="text"),
                    list(
                        `name`="responsible_party", 
                        `title`="Responsible Party", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="westgardInterpretation",
                title="Westgard Rules Interpretation",
                visible=TRUE,
                rows=1,
                clearWith=list(
                    "westgard_rules",
                    "control_limits"),
                columns=list(
                    list(
                        `name`="rule", 
                        `title`="Westgard Rule", 
                        `type`="text"),
                    list(
                        `name`="description", 
                        `title`="Description", 
                        `type`="text"),
                    list(
                        `name`="error_detected", 
                        `title`="Error Type Detected", 
                        `type`="text"),
                    list(
                        `name`="clinical_significance", 
                        `title`="Clinical Significance", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="shewhartChart",
                title="Shewhart Control Chart",
                visible="(control_plots)",
                requiresData=TRUE,
                width=900,
                height=600,
                renderFun=".plotShewhart",
                clearWith=list(
                    "control_plots",
                    "measurement",
                    "chart_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="cusumChart",
                title="CUSUM Control Chart",
                visible="(control_plots && chart_type == \"cusum\" || chart_type == \"combined\")",
                requiresData=TRUE,
                width=900,
                height=600,
                renderFun=".plotCUSUM",
                clearWith=list(
                    "control_plots",
                    "measurement",
                    "chart_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="ewmaChart",
                title="EWMA Control Chart",
                visible="(control_plots && chart_type == \"ewma\" || chart_type == \"combined\")",
                requiresData=TRUE,
                width=900,
                height=600,
                renderFun=".plotEWMA",
                clearWith=list(
                    "control_plots",
                    "measurement",
                    "chart_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="distributionPlot",
                title="Measurement Distribution",
                visible="(histogram_plot)",
                requiresData=TRUE,
                width=700,
                height=500,
                renderFun=".plotDistribution",
                clearWith=list(
                    "histogram_plot",
                    "measurement")))
            self$add(jmvcore::Image$new(
                options=options,
                name="trendPlot",
                title="Trend Analysis Visualization",
                visible="(trend_plot && trend_analysis)",
                requiresData=TRUE,
                width=800,
                height=500,
                renderFun=".plotTrend",
                clearWith=list(
                    "trend_plot",
                    "measurement",
                    "trend_analysis")))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Method and Clinical Context",
                visible=TRUE))}))

labcontrolchartsBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "labcontrolchartsBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "labcontrolcharts",
                version = c(1,0,0),
                options = options,
                results = labcontrolchartsResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Laboratory Control Charts (Shewhart, CUSUM, EWMA)
#'
#' Statistical process control charts for laboratory quality monitoring. 
#' Implements Shewhart charts, CUSUM (Cumulative Sum), and EWMA (Exponentially 
#' Weighted Moving Average) charts for detecting systematic errors, shifts, 
#' and trends in laboratory measurements. Essential for ISO 15189 compliance 
#' and quality assurance programs.
#' 
#'
#' @examples
#' data \%>\%
#' labcontrolcharts(
#'     measurement = "glucose_value",
#'     run_number = "run_id",
#'     chart_type = "shewhart",
#'     control_limits = "3sigma"
#' )
#'
#' @param data the data as a data frame
#' @param measurement Laboratory measurement values to monitor
#' @param run_number Sequential run number or time point identifier
#' @param batch_id Batch or lot identifier for stratified analysis
#' @param control_level Control material level (e.g., Level 1, Level 2, Level
#'   3)
#' @param chart_type Type of control chart to generate
#' @param control_limits Method for calculating control limits
#' @param target_mean Target or expected mean value (0 = calculate from data)
#' @param target_sd Target or expected standard deviation (0 = calculate from
#'   data)
#' @param cusum_k CUSUM reference value (typically 0.5σ)
#' @param cusum_h CUSUM decision interval (typically 4-5σ)
#' @param ewma_lambda EWMA smoothing parameter (0.05-0.25 typical)
#' @param westgard_rules Comma-separated Westgard rules (e.g.,
#'   "13s,22s,R4s,41s,10x")
#' @param baseline_runs Number of initial runs to establish baseline
#' @param violation_detection Identify and mark control rule violations
#' @param trend_analysis Perform trend detection and analysis
#' @param shift_detection Detect systematic shifts in measurements
#' @param performance_metrics Calculate ARL, power, and false alarm rates
#' @param corrective_actions Provide corrective action recommendations
#' @param qc_summary Calculate comprehensive QC statistics
#' @param export_violations Export detailed list of violations
#' @param control_plots Generate control chart visualizations
#' @param histogram_plot Create measurement distribution histogram
#' @param trend_plot Generate trend analysis visualization
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$dataInfo} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$controlLimits} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$violationSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$violationDetails} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$trendAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$shiftDetection} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$performanceMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$qcStatistics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$correctiveActions} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$westgardInterpretation} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$shewhartChart} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$cusumChart} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$ewmaChart} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$distributionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$trendPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$dataInfo$asDF}
#'
#' \code{as.data.frame(results$dataInfo)}
#'
#' @export
labcontrolcharts <- function(
    data,
    measurement,
    run_number,
    batch_id,
    control_level,
    chart_type = "shewhart",
    control_limits = "3sigma",
    target_mean = 0,
    target_sd = 0,
    cusum_k = 0.5,
    cusum_h = 4,
    ewma_lambda = 0.2,
    westgard_rules = "13s,22s,R4s",
    baseline_runs = 20,
    violation_detection = TRUE,
    trend_analysis = TRUE,
    shift_detection = TRUE,
    performance_metrics = TRUE,
    corrective_actions = TRUE,
    qc_summary = TRUE,
    export_violations = FALSE,
    control_plots = TRUE,
    histogram_plot = TRUE,
    trend_plot = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("labcontrolcharts requires jmvcore to be installed (restart may be required)")

    if ( ! missing(measurement)) measurement <- jmvcore::resolveQuo(jmvcore::enquo(measurement))
    if ( ! missing(run_number)) run_number <- jmvcore::resolveQuo(jmvcore::enquo(run_number))
    if ( ! missing(batch_id)) batch_id <- jmvcore::resolveQuo(jmvcore::enquo(batch_id))
    if ( ! missing(control_level)) control_level <- jmvcore::resolveQuo(jmvcore::enquo(control_level))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(measurement), measurement, NULL),
            `if`( ! missing(run_number), run_number, NULL),
            `if`( ! missing(batch_id), batch_id, NULL),
            `if`( ! missing(control_level), control_level, NULL))

    for (v in batch_id) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in control_level) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- labcontrolchartsOptions$new(
        measurement = measurement,
        run_number = run_number,
        batch_id = batch_id,
        control_level = control_level,
        chart_type = chart_type,
        control_limits = control_limits,
        target_mean = target_mean,
        target_sd = target_sd,
        cusum_k = cusum_k,
        cusum_h = cusum_h,
        ewma_lambda = ewma_lambda,
        westgard_rules = westgard_rules,
        baseline_runs = baseline_runs,
        violation_detection = violation_detection,
        trend_analysis = trend_analysis,
        shift_detection = shift_detection,
        performance_metrics = performance_metrics,
        corrective_actions = corrective_actions,
        qc_summary = qc_summary,
        export_violations = export_violations,
        control_plots = control_plots,
        histogram_plot = histogram_plot,
        trend_plot = trend_plot)

    analysis <- labcontrolchartsClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

