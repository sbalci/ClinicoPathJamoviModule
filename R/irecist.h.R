
# This file is automatically generated, you probably don't want to edit this

irecistOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "irecistOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            patientId = NULL,
            assessmentTime = NULL,
            targetLesionSum = NULL,
            newLesions = NULL,
            nonTargetStatus = NULL,
            tumorBurden = NULL,
            confirmationWindow = 4,
            confirmationWindowMax = 12,
            baselineReference = "baseline",
            prThreshold = 30,
            pdThreshold = 20,
            pdAbsolute = 5,
            trackPseudoprogression = TRUE,
            requireConfirmation = TRUE,
            confirmationScans = 1,
            showResponseTable = TRUE,
            showBestResponse = TRUE,
            showWaterfallPlot = TRUE,
            showSwimmerPlot = TRUE,
            showSpiderPlot = FALSE,
            showTimeToCPD = TRUE,
            groupVar = NULL,
            stratifiedAnalysis = FALSE,
            nadirReference = TRUE,
            exportResults = FALSE,
            showDetailedTimeline = FALSE,
            calculateORR = TRUE,
            calculateDCR = TRUE,
            showPseudoprogressionRate = TRUE,
            showReference = TRUE,
            showSummary = TRUE,
            showGlossary = TRUE,
            showAssumptions = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="irecist",
                requiresData=TRUE,
                ...)

            private$..patientId <- jmvcore::OptionVariable$new(
                "patientId",
                patientId,
                required=TRUE)
            private$..assessmentTime <- jmvcore::OptionVariable$new(
                "assessmentTime",
                assessmentTime,
                required=TRUE,
                suggested=list(
                    "continuous"))
            private$..targetLesionSum <- jmvcore::OptionVariable$new(
                "targetLesionSum",
                targetLesionSum,
                required=TRUE,
                suggested=list(
                    "continuous"))
            private$..newLesions <- jmvcore::OptionVariable$new(
                "newLesions",
                newLesions,
                required=TRUE,
                suggested=list(
                    "nominal",
                    "ordinal"))
            private$..nonTargetStatus <- jmvcore::OptionVariable$new(
                "nonTargetStatus",
                nonTargetStatus,
                suggested=list(
                    "nominal"))
            private$..tumorBurden <- jmvcore::OptionVariable$new(
                "tumorBurden",
                tumorBurden,
                suggested=list(
                    "continuous"))
            private$..confirmationWindow <- jmvcore::OptionNumber$new(
                "confirmationWindow",
                confirmationWindow,
                min=2,
                max=16,
                default=4)
            private$..confirmationWindowMax <- jmvcore::OptionNumber$new(
                "confirmationWindowMax",
                confirmationWindowMax,
                min=4,
                max=24,
                default=12)
            private$..baselineReference <- jmvcore::OptionList$new(
                "baselineReference",
                baselineReference,
                options=list(
                    "baseline",
                    "pretreatment"),
                default="baseline")
            private$..prThreshold <- jmvcore::OptionNumber$new(
                "prThreshold",
                prThreshold,
                min=0,
                max=100,
                default=30)
            private$..pdThreshold <- jmvcore::OptionNumber$new(
                "pdThreshold",
                pdThreshold,
                min=0,
                max=100,
                default=20)
            private$..pdAbsolute <- jmvcore::OptionNumber$new(
                "pdAbsolute",
                pdAbsolute,
                min=0,
                max=20,
                default=5)
            private$..trackPseudoprogression <- jmvcore::OptionBool$new(
                "trackPseudoprogression",
                trackPseudoprogression,
                default=TRUE)
            private$..requireConfirmation <- jmvcore::OptionBool$new(
                "requireConfirmation",
                requireConfirmation,
                default=TRUE)
            private$..confirmationScans <- jmvcore::OptionNumber$new(
                "confirmationScans",
                confirmationScans,
                min=1,
                max=3,
                default=1)
            private$..showResponseTable <- jmvcore::OptionBool$new(
                "showResponseTable",
                showResponseTable,
                default=TRUE)
            private$..showBestResponse <- jmvcore::OptionBool$new(
                "showBestResponse",
                showBestResponse,
                default=TRUE)
            private$..showWaterfallPlot <- jmvcore::OptionBool$new(
                "showWaterfallPlot",
                showWaterfallPlot,
                default=TRUE)
            private$..showSwimmerPlot <- jmvcore::OptionBool$new(
                "showSwimmerPlot",
                showSwimmerPlot,
                default=TRUE)
            private$..showSpiderPlot <- jmvcore::OptionBool$new(
                "showSpiderPlot",
                showSpiderPlot,
                default=FALSE)
            private$..showTimeToCPD <- jmvcore::OptionBool$new(
                "showTimeToCPD",
                showTimeToCPD,
                default=TRUE)
            private$..groupVar <- jmvcore::OptionVariable$new(
                "groupVar",
                groupVar,
                suggested=list(
                    "nominal",
                    "ordinal"))
            private$..stratifiedAnalysis <- jmvcore::OptionBool$new(
                "stratifiedAnalysis",
                stratifiedAnalysis,
                default=FALSE)
            private$..nadirReference <- jmvcore::OptionBool$new(
                "nadirReference",
                nadirReference,
                default=TRUE)
            private$..exportResults <- jmvcore::OptionBool$new(
                "exportResults",
                exportResults,
                default=FALSE)
            private$..showDetailedTimeline <- jmvcore::OptionBool$new(
                "showDetailedTimeline",
                showDetailedTimeline,
                default=FALSE)
            private$..calculateORR <- jmvcore::OptionBool$new(
                "calculateORR",
                calculateORR,
                default=TRUE)
            private$..calculateDCR <- jmvcore::OptionBool$new(
                "calculateDCR",
                calculateDCR,
                default=TRUE)
            private$..showPseudoprogressionRate <- jmvcore::OptionBool$new(
                "showPseudoprogressionRate",
                showPseudoprogressionRate,
                default=TRUE)
            private$..showReference <- jmvcore::OptionBool$new(
                "showReference",
                showReference,
                default=TRUE)
            private$..showSummary <- jmvcore::OptionBool$new(
                "showSummary",
                showSummary,
                default=TRUE)
            private$..showGlossary <- jmvcore::OptionBool$new(
                "showGlossary",
                showGlossary,
                default=TRUE)
            private$..showAssumptions <- jmvcore::OptionBool$new(
                "showAssumptions",
                showAssumptions,
                default=TRUE)

            self$.addOption(private$..patientId)
            self$.addOption(private$..assessmentTime)
            self$.addOption(private$..targetLesionSum)
            self$.addOption(private$..newLesions)
            self$.addOption(private$..nonTargetStatus)
            self$.addOption(private$..tumorBurden)
            self$.addOption(private$..confirmationWindow)
            self$.addOption(private$..confirmationWindowMax)
            self$.addOption(private$..baselineReference)
            self$.addOption(private$..prThreshold)
            self$.addOption(private$..pdThreshold)
            self$.addOption(private$..pdAbsolute)
            self$.addOption(private$..trackPseudoprogression)
            self$.addOption(private$..requireConfirmation)
            self$.addOption(private$..confirmationScans)
            self$.addOption(private$..showResponseTable)
            self$.addOption(private$..showBestResponse)
            self$.addOption(private$..showWaterfallPlot)
            self$.addOption(private$..showSwimmerPlot)
            self$.addOption(private$..showSpiderPlot)
            self$.addOption(private$..showTimeToCPD)
            self$.addOption(private$..groupVar)
            self$.addOption(private$..stratifiedAnalysis)
            self$.addOption(private$..nadirReference)
            self$.addOption(private$..exportResults)
            self$.addOption(private$..showDetailedTimeline)
            self$.addOption(private$..calculateORR)
            self$.addOption(private$..calculateDCR)
            self$.addOption(private$..showPseudoprogressionRate)
            self$.addOption(private$..showReference)
            self$.addOption(private$..showSummary)
            self$.addOption(private$..showGlossary)
            self$.addOption(private$..showAssumptions)
        }),
    active = list(
        patientId = function() private$..patientId$value,
        assessmentTime = function() private$..assessmentTime$value,
        targetLesionSum = function() private$..targetLesionSum$value,
        newLesions = function() private$..newLesions$value,
        nonTargetStatus = function() private$..nonTargetStatus$value,
        tumorBurden = function() private$..tumorBurden$value,
        confirmationWindow = function() private$..confirmationWindow$value,
        confirmationWindowMax = function() private$..confirmationWindowMax$value,
        baselineReference = function() private$..baselineReference$value,
        prThreshold = function() private$..prThreshold$value,
        pdThreshold = function() private$..pdThreshold$value,
        pdAbsolute = function() private$..pdAbsolute$value,
        trackPseudoprogression = function() private$..trackPseudoprogression$value,
        requireConfirmation = function() private$..requireConfirmation$value,
        confirmationScans = function() private$..confirmationScans$value,
        showResponseTable = function() private$..showResponseTable$value,
        showBestResponse = function() private$..showBestResponse$value,
        showWaterfallPlot = function() private$..showWaterfallPlot$value,
        showSwimmerPlot = function() private$..showSwimmerPlot$value,
        showSpiderPlot = function() private$..showSpiderPlot$value,
        showTimeToCPD = function() private$..showTimeToCPD$value,
        groupVar = function() private$..groupVar$value,
        stratifiedAnalysis = function() private$..stratifiedAnalysis$value,
        nadirReference = function() private$..nadirReference$value,
        exportResults = function() private$..exportResults$value,
        showDetailedTimeline = function() private$..showDetailedTimeline$value,
        calculateORR = function() private$..calculateORR$value,
        calculateDCR = function() private$..calculateDCR$value,
        showPseudoprogressionRate = function() private$..showPseudoprogressionRate$value,
        showReference = function() private$..showReference$value,
        showSummary = function() private$..showSummary$value,
        showGlossary = function() private$..showGlossary$value,
        showAssumptions = function() private$..showAssumptions$value),
    private = list(
        ..patientId = NA,
        ..assessmentTime = NA,
        ..targetLesionSum = NA,
        ..newLesions = NA,
        ..nonTargetStatus = NA,
        ..tumorBurden = NA,
        ..confirmationWindow = NA,
        ..confirmationWindowMax = NA,
        ..baselineReference = NA,
        ..prThreshold = NA,
        ..pdThreshold = NA,
        ..pdAbsolute = NA,
        ..trackPseudoprogression = NA,
        ..requireConfirmation = NA,
        ..confirmationScans = NA,
        ..showResponseTable = NA,
        ..showBestResponse = NA,
        ..showWaterfallPlot = NA,
        ..showSwimmerPlot = NA,
        ..showSpiderPlot = NA,
        ..showTimeToCPD = NA,
        ..groupVar = NA,
        ..stratifiedAnalysis = NA,
        ..nadirReference = NA,
        ..exportResults = NA,
        ..showDetailedTimeline = NA,
        ..calculateORR = NA,
        ..calculateDCR = NA,
        ..showPseudoprogressionRate = NA,
        ..showReference = NA,
        ..showSummary = NA,
        ..showGlossary = NA,
        ..showAssumptions = NA)
)

irecistResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "irecistResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        dataInfo = function() private$.items[["dataInfo"]],
        responseTable = function() private$.items[["responseTable"]],
        bestResponseTable = function() private$.items[["bestResponseTable"]],
        summaryStats = function() private$.items[["summaryStats"]],
        efficacyMetrics = function() private$.items[["efficacyMetrics"]],
        pseudoprogressionTable = function() private$.items[["pseudoprogressionTable"]],
        waterfallPlot = function() private$.items[["waterfallPlot"]],
        swimmerPlot = function() private$.items[["swimmerPlot"]],
        spiderPlot = function() private$.items[["spiderPlot"]],
        timeToCPDPlot = function() private$.items[["timeToCPDPlot"]],
        timelinePlot = function() private$.items[["timelinePlot"]],
        stratifiedTable = function() private$.items[["stratifiedTable"]],
        clinicalInterpretation = function() private$.items[["clinicalInterpretation"]],
        referenceInfo = function() private$.items[["referenceInfo"]],
        executiveSummary = function() private$.items[["executiveSummary"]],
        glossary = function() private$.items[["glossary"]],
        assumptions = function() private$.items[["assumptions"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="iRECIST Analysis")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="dataInfo",
                title="Data Summary",
                rows=0,
                clearWith=list(
                    "patientId",
                    "assessmentTime",
                    "targetLesionSum",
                    "newLesions"),
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="responseTable",
                title="iRECIST Response Classifications",
                visible="(showResponseTable)",
                clearWith=list(
                    "patientId",
                    "assessmentTime",
                    "targetLesionSum",
                    "newLesions",
                    "nonTargetStatus",
                    "confirmationWindow"),
                rows=0,
                columns=list(
                    list(
                        `name`="patientId", 
                        `title`="Patient ID", 
                        `type`="text"),
                    list(
                        `name`="assessmentTime", 
                        `title`="Assessment Time", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="targetSum", 
                        `title`="Target Sum (mm)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="changeFromBaseline", 
                        `title`="Change from Baseline (%)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="changeFromNadir", 
                        `title`="Change from Nadir (%)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="newLesions", 
                        `title`="New Lesions", 
                        `type`="text"),
                    list(
                        `name`="irecistCategory", 
                        `title`="iRECIST Category", 
                        `type`="text"),
                    list(
                        `name`="confirmed", 
                        `title`="Confirmed", 
                        `type`="text"),
                    list(
                        `name`="notes", 
                        `title`="Notes", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="bestResponseTable",
                title="Best Overall Response by Patient",
                visible="(showBestResponse)",
                clearWith=list(
                    "patientId",
                    "assessmentTime",
                    "targetLesionSum",
                    "newLesions",
                    "nonTargetStatus"),
                rows=0,
                columns=list(
                    list(
                        `name`="patientId", 
                        `title`="Patient ID", 
                        `type`="text"),
                    list(
                        `name`="bestResponse", 
                        `title`="Best Overall Response", 
                        `type`="text"),
                    list(
                        `name`="timeToResponse", 
                        `title`="Time to Response", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="confirmed", 
                        `title`="Confirmed", 
                        `type`="text"),
                    list(
                        `name`="hadPseudoprogression", 
                        `title`="Pseudoprogression", 
                        `type`="text"),
                    list(
                        `name`="timeToCPD", 
                        `title`="Time to iCPD", 
                        `type`="number", 
                        `format`="dp:1"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="summaryStats",
                title="Summary Statistics",
                rows=0,
                clearWith=list(
                    "patientId",
                    "assessmentTime",
                    "targetLesionSum",
                    "newLesions",
                    "showBestResponse"),
                columns=list(
                    list(
                        `name`="category", 
                        `title`="Response Category", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="percent", 
                        `title`="Percent", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="dp:1"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="efficacyMetrics",
                title="Efficacy Metrics",
                visible="(calculateORR || calculateDCR || showPseudoprogressionRate)",
                rows=0,
                clearWith=list(
                    "patientId",
                    "calculateORR",
                    "calculateDCR"),
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="total", 
                        `title`="Total", 
                        `type`="integer"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="dp:1"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="pseudoprogressionTable",
                title="Pseudoprogression Analysis",
                visible="(trackPseudoprogression && showPseudoprogressionRate)",
                clearWith=list(
                    "patientId",
                    "trackPseudoprogression"),
                rows=0,
                columns=list(
                    list(
                        `name`="patientId", 
                        `title`="Patient ID", 
                        `type`="text"),
                    list(
                        `name`="iupdTime", 
                        `title`="iUPD Time", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="confirmationTime", 
                        `title`="Confirmation Time", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="outcome", 
                        `title`="Outcome", 
                        `type`="text"),
                    list(
                        `name`="subsequentResponse", 
                        `title`="Subsequent Response", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="waterfallPlot",
                title="Waterfall Plot (Best Response)",
                visible="(showWaterfallPlot)",
                renderFun=".waterfallPlot",
                clearWith=list(
                    "patientId",
                    "targetLesionSum",
                    "showWaterfallPlot",
                    "groupVar"),
                width=600,
                height=500))
            self$add(jmvcore::Image$new(
                options=options,
                name="swimmerPlot",
                title="Swimmer Plot (Treatment Duration & Response)",
                visible="(showSwimmerPlot)",
                renderFun=".swimmerPlot",
                clearWith=list(
                    "patientId",
                    "assessmentTime",
                    "showSwimmerPlot",
                    "trackPseudoprogression"),
                width=800,
                height=600))
            self$add(jmvcore::Image$new(
                options=options,
                name="spiderPlot",
                title="Spider Plot (Tumor Size Over Time)",
                visible="(showSpiderPlot)",
                renderFun=".spiderPlot",
                clearWith=list(
                    "patientId",
                    "assessmentTime",
                    "targetLesionSum",
                    "showSpiderPlot"),
                width=700,
                height=500))
            self$add(jmvcore::Image$new(
                options=options,
                name="timeToCPDPlot",
                title="Time to Confirmed Progressive Disease (iCPD)",
                visible="(showTimeToCPD)",
                renderFun=".timeToCPDPlot",
                clearWith=list(
                    "patientId",
                    "assessmentTime",
                    "showTimeToCPD",
                    "groupVar"),
                width=700,
                height=500))
            self$add(jmvcore::Image$new(
                options=options,
                name="timelinePlot",
                title="Detailed Response Timeline",
                visible="(showDetailedTimeline)",
                renderFun=".timelinePlot",
                clearWith=list(
                    "patientId",
                    "assessmentTime",
                    "showDetailedTimeline"),
                width=900,
                height=600))
            self$add(jmvcore::Table$new(
                options=options,
                name="stratifiedTable",
                title="Stratified Analysis by Group",
                visible="(stratifiedAnalysis && groupVar)",
                clearWith=list(
                    "groupVar",
                    "stratifiedAnalysis"),
                rows=0,
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="iCR", 
                        `title`="iCR (%)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="iPR", 
                        `title`="iPR (%)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="iSD", 
                        `title`="iSD (%)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="iCPD", 
                        `title`="iCPD (%)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="orr", 
                        `title`="ORR (%)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="dcr", 
                        `title`="DCR (%)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="pseudoprogression_rate", 
                        `title`="Pseudoprogression Rate (%)", 
                        `type`="number", 
                        `format`="dp:1"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalInterpretation",
                title="Clinical Interpretation",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="referenceInfo",
                title="Reference Information",
                visible="(showReference)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="executiveSummary",
                title="Executive Summary",
                visible="(showSummary)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="glossary",
                title="iRECIST Glossary",
                visible="(showGlossary)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="assumptions",
                title="Assumptions & Caveats",
                visible="(showAssumptions)"))}))

irecistBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "irecistBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "irecist",
                version = c(0,0,32),
                options = options,
                results = irecistResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' iRECIST Analysis
#'
#' Immune-related Response Evaluation Criteria in Solid Tumors (iRECIST) 
#' analysis for assessing tumor response in immunotherapy trials. Implements 
#' Seymour et al. (2017) guidelines including pseudoprogression detection and 
#' confirmation requirements.
#' 
#'
#' @examples
#' data <- data.frame(
#'     patient = c("P01", "P01", "P01", "P02", "P02"),
#'     time = c(0, 8, 16, 0, 8),
#'     target_sum = c(45, 52, 48, 50, 35),
#'     new_lesions = c(0, 0, 0, 0, 0)
#' )
#'
#' irecist(
#'     data = data,
#'     patientId = "patient",
#'     assessmentTime = "time",
#'     targetLesionSum = "target_sum",
#'     newLesions = "new_lesions"
#' )
#'
#' @param data the data as a data frame
#' @param patientId Patient identifier variable
#' @param assessmentTime Time from baseline (weeks or months)
#' @param targetLesionSum Sum of target lesion diameters (mm)
#' @param newLesions Binary indicator for new lesions (0=no, 1=yes)
#' @param nonTargetStatus Non-target lesion status (CR, non-CR/non-PD, PD)
#' @param tumorBurden Total tumor burden measure (optional)
#' @param confirmationWindow Minimum time window for iUPD confirmation
#'   (default: 4 weeks per iRECIST guidelines)
#' @param confirmationWindowMax Maximum time window for iUPD confirmation
#'   (default: 12 weeks)
#' @param baselineReference Reference point for baseline measurements
#' @param prThreshold Percent decrease for partial response (default: 30\% per
#'   RECIST)
#' @param pdThreshold Percent increase for progressive disease (default: 20\%
#'   per RECIST)
#' @param pdAbsolute Absolute increase required for PD (default: 5mm per
#'   RECIST)
#' @param trackPseudoprogression Flag and track iUPD (unconfirmed progression)
#'   cases
#' @param requireConfirmation Require confirmation scan for response calls
#' @param confirmationScans Number of confirmation scans required for CR/PR
#' @param showResponseTable Show detailed response category table
#' @param showBestResponse Calculate and show best overall response per
#'   patient
#' @param showWaterfallPlot Generate waterfall plot with iRECIST colors
#' @param showSwimmerPlot Generate swimmer plot with iUPD events marked
#' @param showSpiderPlot Generate spider plot showing individual lesion
#'   trajectories
#' @param showTimeToCPD Calculate time to confirmed progressive disease (iCPD)
#' @param groupVar Grouping variable for stratified analysis (e.g., treatment
#'   arm)
#' @param stratifiedAnalysis Perform analysis stratified by grouping variable
#' @param nadirReference Use nadir (lowest) value as reference for PD
#'   calculation
#' @param exportResults Export results to CSV file
#' @param showDetailedTimeline Show detailed timeline of response assessments
#'   and transitions
#' @param calculateORR Calculate ORR (iCR + iPR)
#' @param calculateDCR Calculate DCR (iCR + iPR + iSD)
#' @param showPseudoprogressionRate Calculate rate of pseudoprogression (iUPD
#'   â†’ non-iCPD)
#' @param showReference Display iRECIST guidelines reference (Seymour et al.
#'   2017)
#' @param showSummary Display natural-language summary with copy-ready text
#' @param showGlossary Display glossary of iRECIST terms and definitions
#' @param showAssumptions Display analysis assumptions and data requirements
#' @param formula (optional) the formula to use, see the examples
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$dataInfo} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$responseTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$bestResponseTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$summaryStats} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$efficacyMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$pseudoprogressionTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$waterfallPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$swimmerPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$spiderPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$timeToCPDPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$timelinePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$stratifiedTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clinicalInterpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$referenceInfo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$executiveSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$glossary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$assumptions} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$dataInfo$asDF}
#'
#' \code{as.data.frame(results$dataInfo)}
#'
#' @export
irecist <- function(
    data,
    patientId,
    assessmentTime,
    targetLesionSum,
    newLesions,
    nonTargetStatus,
    tumorBurden,
    confirmationWindow = 4,
    confirmationWindowMax = 12,
    baselineReference = "baseline",
    prThreshold = 30,
    pdThreshold = 20,
    pdAbsolute = 5,
    trackPseudoprogression = TRUE,
    requireConfirmation = TRUE,
    confirmationScans = 1,
    showResponseTable = TRUE,
    showBestResponse = TRUE,
    showWaterfallPlot = TRUE,
    showSwimmerPlot = TRUE,
    showSpiderPlot = FALSE,
    showTimeToCPD = TRUE,
    groupVar,
    stratifiedAnalysis = FALSE,
    nadirReference = TRUE,
    exportResults = FALSE,
    showDetailedTimeline = FALSE,
    calculateORR = TRUE,
    calculateDCR = TRUE,
    showPseudoprogressionRate = TRUE,
    showReference = TRUE,
    showSummary = TRUE,
    showGlossary = TRUE,
    showAssumptions = TRUE,
    formula) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("irecist requires jmvcore to be installed (restart may be required)")

    if ( ! missing(formula)) {
        if (missing(patientId))
            patientId <- jmvcore::marshalFormula(
                formula=formula,
                data=`if`( ! missing(data), data, NULL),
                from="lhs",
                required=TRUE)
        if (missing(assessmentTime))
            assessmentTime <- jmvcore::marshalFormula(
                formula=formula,
                data=`if`( ! missing(data), data, NULL),
                from="rhs",
                subset="1")
        if (missing(targetLesionSum))
            targetLesionSum <- jmvcore::marshalFormula(
                formula=formula,
                data=`if`( ! missing(data), data, NULL),
                from="rhs",
                subset="2")
        if (missing(newLesions))
            newLesions <- jmvcore::marshalFormula(
                formula=formula,
                data=`if`( ! missing(data), data, NULL),
                from="rhs",
                subset="3")
        if (missing(nonTargetStatus))
            nonTargetStatus <- jmvcore::marshalFormula(
                formula=formula,
                data=`if`( ! missing(data), data, NULL),
                from="rhs",
                subset="4")
    }

    if ( ! missing(patientId)) patientId <- jmvcore::resolveQuo(jmvcore::enquo(patientId))
    if ( ! missing(assessmentTime)) assessmentTime <- jmvcore::resolveQuo(jmvcore::enquo(assessmentTime))
    if ( ! missing(targetLesionSum)) targetLesionSum <- jmvcore::resolveQuo(jmvcore::enquo(targetLesionSum))
    if ( ! missing(newLesions)) newLesions <- jmvcore::resolveQuo(jmvcore::enquo(newLesions))
    if ( ! missing(nonTargetStatus)) nonTargetStatus <- jmvcore::resolveQuo(jmvcore::enquo(nonTargetStatus))
    if ( ! missing(tumorBurden)) tumorBurden <- jmvcore::resolveQuo(jmvcore::enquo(tumorBurden))
    if ( ! missing(groupVar)) groupVar <- jmvcore::resolveQuo(jmvcore::enquo(groupVar))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(patientId), patientId, NULL),
            `if`( ! missing(assessmentTime), assessmentTime, NULL),
            `if`( ! missing(targetLesionSum), targetLesionSum, NULL),
            `if`( ! missing(newLesions), newLesions, NULL),
            `if`( ! missing(nonTargetStatus), nonTargetStatus, NULL),
            `if`( ! missing(tumorBurden), tumorBurden, NULL),
            `if`( ! missing(groupVar), groupVar, NULL))


    options <- irecistOptions$new(
        patientId = patientId,
        assessmentTime = assessmentTime,
        targetLesionSum = targetLesionSum,
        newLesions = newLesions,
        nonTargetStatus = nonTargetStatus,
        tumorBurden = tumorBurden,
        confirmationWindow = confirmationWindow,
        confirmationWindowMax = confirmationWindowMax,
        baselineReference = baselineReference,
        prThreshold = prThreshold,
        pdThreshold = pdThreshold,
        pdAbsolute = pdAbsolute,
        trackPseudoprogression = trackPseudoprogression,
        requireConfirmation = requireConfirmation,
        confirmationScans = confirmationScans,
        showResponseTable = showResponseTable,
        showBestResponse = showBestResponse,
        showWaterfallPlot = showWaterfallPlot,
        showSwimmerPlot = showSwimmerPlot,
        showSpiderPlot = showSpiderPlot,
        showTimeToCPD = showTimeToCPD,
        groupVar = groupVar,
        stratifiedAnalysis = stratifiedAnalysis,
        nadirReference = nadirReference,
        exportResults = exportResults,
        showDetailedTimeline = showDetailedTimeline,
        calculateORR = calculateORR,
        calculateDCR = calculateDCR,
        showPseudoprogressionRate = showPseudoprogressionRate,
        showReference = showReference,
        showSummary = showSummary,
        showGlossary = showGlossary,
        showAssumptions = showAssumptions)

    analysis <- irecistClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

