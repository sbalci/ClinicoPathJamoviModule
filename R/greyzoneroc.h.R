
# This file is automatically generated, you probably don't want to edit this

greyzonerocOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "greyzonerocOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            predictor = NULL,
            outcome = NULL,
            positive_level = NULL,
            grey_zone_method = "fixed_width",
            grey_zone_width = 0.1,
            lower_grey_boundary = 0.45,
            upper_grey_boundary = 0.55,
            confidence_threshold = 0.8,
            cost_false_positive = 1,
            cost_false_negative = 1,
            cost_grey_zone = 0.3,
            calculate_definite_performance = TRUE,
            calculate_all_cases_performance = TRUE,
            grey_zone_characteristics = TRUE,
            optimal_threshold = "youden",
            clinical_threshold = 0.5,
            prediction_intervals = FALSE,
            bootstrap_grey_zone = TRUE,
            bootstrap_samples = 1000,
            confidence_level = 0.95,
            grey_zone_action = "reflex",
            reflex_test_name = "Confirmatory test",
            plot_grey_zone_roc = TRUE,
            plot_threshold_distributions = TRUE,
            plot_grey_zone_size = TRUE,
            plot_uncertainty_map = FALSE,
            plot_cost_surface = FALSE,
            fuzzy_membership = FALSE,
            bayesian_grey_zone = FALSE,
            stratified_grey_zone = FALSE,
            stratify_by = NULL,
            clinical_scenario = "general",
            missing_handling = "complete",
            random_seed = 123, ...) {

            super$initialize(
                package="ClinicoPath",
                name="greyzoneroc",
                requiresData=TRUE,
                ...)

            private$..predictor <- jmvcore::OptionVariable$new(
                "predictor",
                predictor,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..positive_level <- jmvcore::OptionLevel$new(
                "positive_level",
                positive_level,
                variable="(outcome)")
            private$..grey_zone_method <- jmvcore::OptionList$new(
                "grey_zone_method",
                grey_zone_method,
                options=list(
                    "fixed_width",
                    "confidence",
                    "cost_benefit",
                    "youden_symmetric",
                    "custom"),
                default="fixed_width")
            private$..grey_zone_width <- jmvcore::OptionNumber$new(
                "grey_zone_width",
                grey_zone_width,
                default=0.1,
                min=0.01,
                max=0.5)
            private$..lower_grey_boundary <- jmvcore::OptionNumber$new(
                "lower_grey_boundary",
                lower_grey_boundary,
                default=0.45,
                min=0,
                max=1)
            private$..upper_grey_boundary <- jmvcore::OptionNumber$new(
                "upper_grey_boundary",
                upper_grey_boundary,
                default=0.55,
                min=0,
                max=1)
            private$..confidence_threshold <- jmvcore::OptionNumber$new(
                "confidence_threshold",
                confidence_threshold,
                default=0.8,
                min=0.5,
                max=0.99)
            private$..cost_false_positive <- jmvcore::OptionNumber$new(
                "cost_false_positive",
                cost_false_positive,
                default=1,
                min=0)
            private$..cost_false_negative <- jmvcore::OptionNumber$new(
                "cost_false_negative",
                cost_false_negative,
                default=1,
                min=0)
            private$..cost_grey_zone <- jmvcore::OptionNumber$new(
                "cost_grey_zone",
                cost_grey_zone,
                default=0.3,
                min=0,
                max=2)
            private$..calculate_definite_performance <- jmvcore::OptionBool$new(
                "calculate_definite_performance",
                calculate_definite_performance,
                default=TRUE)
            private$..calculate_all_cases_performance <- jmvcore::OptionBool$new(
                "calculate_all_cases_performance",
                calculate_all_cases_performance,
                default=TRUE)
            private$..grey_zone_characteristics <- jmvcore::OptionBool$new(
                "grey_zone_characteristics",
                grey_zone_characteristics,
                default=TRUE)
            private$..optimal_threshold <- jmvcore::OptionList$new(
                "optimal_threshold",
                optimal_threshold,
                options=list(
                    "youden",
                    "equal",
                    "topleft",
                    "cost",
                    "clinical"),
                default="youden")
            private$..clinical_threshold <- jmvcore::OptionNumber$new(
                "clinical_threshold",
                clinical_threshold,
                default=0.5,
                min=0,
                max=1)
            private$..prediction_intervals <- jmvcore::OptionBool$new(
                "prediction_intervals",
                prediction_intervals,
                default=FALSE)
            private$..bootstrap_grey_zone <- jmvcore::OptionBool$new(
                "bootstrap_grey_zone",
                bootstrap_grey_zone,
                default=TRUE)
            private$..bootstrap_samples <- jmvcore::OptionInteger$new(
                "bootstrap_samples",
                bootstrap_samples,
                default=1000,
                min=100,
                max=10000)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.8,
                max=0.99)
            private$..grey_zone_action <- jmvcore::OptionList$new(
                "grey_zone_action",
                grey_zone_action,
                options=list(
                    "reflex",
                    "expert",
                    "repeat",
                    "followup",
                    "default_positive",
                    "default_negative"),
                default="reflex")
            private$..reflex_test_name <- jmvcore::OptionString$new(
                "reflex_test_name",
                reflex_test_name,
                default="Confirmatory test")
            private$..plot_grey_zone_roc <- jmvcore::OptionBool$new(
                "plot_grey_zone_roc",
                plot_grey_zone_roc,
                default=TRUE)
            private$..plot_threshold_distributions <- jmvcore::OptionBool$new(
                "plot_threshold_distributions",
                plot_threshold_distributions,
                default=TRUE)
            private$..plot_grey_zone_size <- jmvcore::OptionBool$new(
                "plot_grey_zone_size",
                plot_grey_zone_size,
                default=TRUE)
            private$..plot_uncertainty_map <- jmvcore::OptionBool$new(
                "plot_uncertainty_map",
                plot_uncertainty_map,
                default=FALSE)
            private$..plot_cost_surface <- jmvcore::OptionBool$new(
                "plot_cost_surface",
                plot_cost_surface,
                default=FALSE)
            private$..fuzzy_membership <- jmvcore::OptionBool$new(
                "fuzzy_membership",
                fuzzy_membership,
                default=FALSE)
            private$..bayesian_grey_zone <- jmvcore::OptionBool$new(
                "bayesian_grey_zone",
                bayesian_grey_zone,
                default=FALSE)
            private$..stratified_grey_zone <- jmvcore::OptionBool$new(
                "stratified_grey_zone",
                stratified_grey_zone,
                default=FALSE)
            private$..stratify_by <- jmvcore::OptionVariable$new(
                "stratify_by",
                stratify_by,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..clinical_scenario <- jmvcore::OptionList$new(
                "clinical_scenario",
                clinical_scenario,
                options=list(
                    "general",
                    "ai",
                    "cytology",
                    "biomarker",
                    "risk"),
                default="general")
            private$..missing_handling <- jmvcore::OptionList$new(
                "missing_handling",
                missing_handling,
                options=list(
                    "complete",
                    "imputation"),
                default="complete")
            private$..random_seed <- jmvcore::OptionInteger$new(
                "random_seed",
                random_seed,
                default=123,
                min=1,
                max=999999)

            self$.addOption(private$..predictor)
            self$.addOption(private$..outcome)
            self$.addOption(private$..positive_level)
            self$.addOption(private$..grey_zone_method)
            self$.addOption(private$..grey_zone_width)
            self$.addOption(private$..lower_grey_boundary)
            self$.addOption(private$..upper_grey_boundary)
            self$.addOption(private$..confidence_threshold)
            self$.addOption(private$..cost_false_positive)
            self$.addOption(private$..cost_false_negative)
            self$.addOption(private$..cost_grey_zone)
            self$.addOption(private$..calculate_definite_performance)
            self$.addOption(private$..calculate_all_cases_performance)
            self$.addOption(private$..grey_zone_characteristics)
            self$.addOption(private$..optimal_threshold)
            self$.addOption(private$..clinical_threshold)
            self$.addOption(private$..prediction_intervals)
            self$.addOption(private$..bootstrap_grey_zone)
            self$.addOption(private$..bootstrap_samples)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..grey_zone_action)
            self$.addOption(private$..reflex_test_name)
            self$.addOption(private$..plot_grey_zone_roc)
            self$.addOption(private$..plot_threshold_distributions)
            self$.addOption(private$..plot_grey_zone_size)
            self$.addOption(private$..plot_uncertainty_map)
            self$.addOption(private$..plot_cost_surface)
            self$.addOption(private$..fuzzy_membership)
            self$.addOption(private$..bayesian_grey_zone)
            self$.addOption(private$..stratified_grey_zone)
            self$.addOption(private$..stratify_by)
            self$.addOption(private$..clinical_scenario)
            self$.addOption(private$..missing_handling)
            self$.addOption(private$..random_seed)
        }),
    active = list(
        predictor = function() private$..predictor$value,
        outcome = function() private$..outcome$value,
        positive_level = function() private$..positive_level$value,
        grey_zone_method = function() private$..grey_zone_method$value,
        grey_zone_width = function() private$..grey_zone_width$value,
        lower_grey_boundary = function() private$..lower_grey_boundary$value,
        upper_grey_boundary = function() private$..upper_grey_boundary$value,
        confidence_threshold = function() private$..confidence_threshold$value,
        cost_false_positive = function() private$..cost_false_positive$value,
        cost_false_negative = function() private$..cost_false_negative$value,
        cost_grey_zone = function() private$..cost_grey_zone$value,
        calculate_definite_performance = function() private$..calculate_definite_performance$value,
        calculate_all_cases_performance = function() private$..calculate_all_cases_performance$value,
        grey_zone_characteristics = function() private$..grey_zone_characteristics$value,
        optimal_threshold = function() private$..optimal_threshold$value,
        clinical_threshold = function() private$..clinical_threshold$value,
        prediction_intervals = function() private$..prediction_intervals$value,
        bootstrap_grey_zone = function() private$..bootstrap_grey_zone$value,
        bootstrap_samples = function() private$..bootstrap_samples$value,
        confidence_level = function() private$..confidence_level$value,
        grey_zone_action = function() private$..grey_zone_action$value,
        reflex_test_name = function() private$..reflex_test_name$value,
        plot_grey_zone_roc = function() private$..plot_grey_zone_roc$value,
        plot_threshold_distributions = function() private$..plot_threshold_distributions$value,
        plot_grey_zone_size = function() private$..plot_grey_zone_size$value,
        plot_uncertainty_map = function() private$..plot_uncertainty_map$value,
        plot_cost_surface = function() private$..plot_cost_surface$value,
        fuzzy_membership = function() private$..fuzzy_membership$value,
        bayesian_grey_zone = function() private$..bayesian_grey_zone$value,
        stratified_grey_zone = function() private$..stratified_grey_zone$value,
        stratify_by = function() private$..stratify_by$value,
        clinical_scenario = function() private$..clinical_scenario$value,
        missing_handling = function() private$..missing_handling$value,
        random_seed = function() private$..random_seed$value),
    private = list(
        ..predictor = NA,
        ..outcome = NA,
        ..positive_level = NA,
        ..grey_zone_method = NA,
        ..grey_zone_width = NA,
        ..lower_grey_boundary = NA,
        ..upper_grey_boundary = NA,
        ..confidence_threshold = NA,
        ..cost_false_positive = NA,
        ..cost_false_negative = NA,
        ..cost_grey_zone = NA,
        ..calculate_definite_performance = NA,
        ..calculate_all_cases_performance = NA,
        ..grey_zone_characteristics = NA,
        ..optimal_threshold = NA,
        ..clinical_threshold = NA,
        ..prediction_intervals = NA,
        ..bootstrap_grey_zone = NA,
        ..bootstrap_samples = NA,
        ..confidence_level = NA,
        ..grey_zone_action = NA,
        ..reflex_test_name = NA,
        ..plot_grey_zone_roc = NA,
        ..plot_threshold_distributions = NA,
        ..plot_grey_zone_size = NA,
        ..plot_uncertainty_map = NA,
        ..plot_cost_surface = NA,
        ..fuzzy_membership = NA,
        ..bayesian_grey_zone = NA,
        ..stratified_grey_zone = NA,
        ..stratify_by = NA,
        ..clinical_scenario = NA,
        ..missing_handling = NA,
        ..random_seed = NA)
)

greyzonerocResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "greyzonerocResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        greyZoneSummary = function() private$.items[["greyZoneSummary"]],
        greyZoneBoundaries = function() private$.items[["greyZoneBoundaries"]],
        definitePerformanceTable = function() private$.items[["definitePerformanceTable"]],
        allCasesPerformanceTable = function() private$.items[["allCasesPerformanceTable"]],
        greyZoneCharacteristics = function() private$.items[["greyZoneCharacteristics"]],
        classificationBreakdown = function() private$.items[["classificationBreakdown"]],
        costAnalysisTable = function() private$.items[["costAnalysisTable"]],
        tradeoffAnalysisTable = function() private$.items[["tradeoffAnalysisTable"]],
        stratifiedGreyZoneTable = function() private$.items[["stratifiedGreyZoneTable"]],
        greyZoneROCPlot = function() private$.items[["greyZoneROCPlot"]],
        thresholdDistributionsPlot = function() private$.items[["thresholdDistributionsPlot"]],
        greyZoneSizePlot = function() private$.items[["greyZoneSizePlot"]],
        uncertaintyMapPlot = function() private$.items[["uncertaintyMapPlot"]],
        costSurfacePlot = function() private$.items[["costSurfacePlot"]],
        clinicalRecommendations = function() private$.items[["clinicalRecommendations"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Grey-zone (Fuzzy) ROC Analysis",
                refs=list(
                    "pROC",
                    "ggplot2",
                    "dplyr",
                    "boot",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="greyZoneSummary",
                title="Grey Zone Summary",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="greyZoneBoundaries",
                title="Grey Zone Boundaries",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="boundary", 
                        `title`="Boundary", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="method", 
                        `title`="Selection Method", 
                        `type`="text"),
                    list(
                        `name`="rationale", 
                        `title`="Rationale", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="definitePerformanceTable",
                title="Performance - Definite Classifications Only",
                visible="(calculate_definite_performance)",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="n_cases", 
                        `title`="N Cases", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="allCasesPerformanceTable",
                title="Performance - All Cases (Grey as Incorrect)",
                visible="(calculate_all_cases_performance)",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="greyZoneCharacteristics",
                title="Grey Zone Case Characteristics",
                visible="(grey_zone_characteristics)",
                columns=list(
                    list(
                        `name`="characteristic", 
                        `title`="Characteristic", 
                        `type`="text"),
                    list(
                        `name`="grey_zone", 
                        `title`="Grey Zone", 
                        `type`="text"),
                    list(
                        `name`="definite_positive", 
                        `title`="Definite Positive", 
                        `type`="text"),
                    list(
                        `name`="definite_negative", 
                        `title`="Definite Negative", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="classificationBreakdown",
                title="Classification Breakdown",
                visible=TRUE,
                rows=2,
                columns=list(
                    list(
                        `name`="true_status", 
                        `title`="True Status", 
                        `type`="text"),
                    list(
                        `name`="definite_positive", 
                        `title`="Definite Positive", 
                        `type`="integer"),
                    list(
                        `name`="grey_zone", 
                        `title`="Grey Zone", 
                        `type`="integer"),
                    list(
                        `name`="definite_negative", 
                        `title`="Definite Negative", 
                        `type`="integer"),
                    list(
                        `name`="total", 
                        `title`="Total", 
                        `type`="integer"),
                    list(
                        `name`="pct_grey", 
                        `title`="% in Grey Zone", 
                        `type`="number", 
                        `format`="pc"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="costAnalysisTable",
                title="Cost-Benefit Analysis",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="scenario", 
                        `title`="Scenario", 
                        `type`="text"),
                    list(
                        `name`="total_cost", 
                        `title`="Total Cost", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="misclass_cost", 
                        `title`="Misclassification Cost", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="grey_zone_cost", 
                        `title`="Grey Zone Cost", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="n_reflex_tests", 
                        `title`="N Reflex Tests Needed", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="tradeoffAnalysisTable",
                title="Grey Zone Width Trade-off Analysis",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="grey_zone_width", 
                        `title`="Grey Zone Width", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="pct_definite", 
                        `title`="% Definite", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="definite_accuracy", 
                        `title`="Definite Accuracy", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="definite_sensitivity", 
                        `title`="Definite Sensitivity", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="definite_specificity", 
                        `title`="Definite Specificity", 
                        `type`="number", 
                        `format`="pc"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="stratifiedGreyZoneTable",
                title="Stratified Grey Zone Analysis",
                visible="(stratified_grey_zone)",
                columns=list(
                    list(
                        `name`="stratum", 
                        `title`="Stratum", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="lower_boundary", 
                        `title`="Lower Boundary", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="upper_boundary", 
                        `title`="Upper Boundary", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="pct_grey", 
                        `title`="% Grey Zone", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="definite_performance", 
                        `title`="Definite AUC", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="greyZoneROCPlot",
                title="ROC Curve with Grey Zone",
                width=700,
                height=600,
                renderFun=".plotGreyZoneROC",
                visible="(plot_grey_zone_roc)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="thresholdDistributionsPlot",
                title="Score Distributions with Grey Zone Boundaries",
                width=700,
                height=500,
                renderFun=".plotThresholdDistributions",
                visible="(plot_threshold_distributions)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="greyZoneSizePlot",
                title="Grey Zone Size vs Performance Trade-off",
                width=700,
                height=500,
                renderFun=".plotGreyZoneSize",
                visible="(plot_grey_zone_size)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="uncertaintyMapPlot",
                title="Prediction Uncertainty Heatmap",
                width=700,
                height=500,
                renderFun=".plotUncertaintyMap",
                visible="(plot_uncertainty_map)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="costSurfacePlot",
                title="Cost Surface Analysis",
                width=700,
                height=500,
                renderFun=".plotCostSurface",
                visible="(plot_cost_surface)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalRecommendations",
                title="Clinical Recommendations",
                visible=TRUE))}))

greyzonerocBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "greyzonerocBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "greyzoneroc",
                version = c(0,0,32),
                options = options,
                results = greyzonerocResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Grey-zone (Fuzzy) ROC Analysis
#'
#' Grey-zone ROC analysis for diagnostic tests where uncertainty around 
#' decision thresholds requires a "don't know" or "defer decision" option. 
#' Unlike traditional binary ROC that forces every case into positive or 
#' negative, grey-zone ROC acknowledges diagnostic uncertainty by creating an 
#' indeterminate zone around the threshold where additional testing or expert 
#' review is recommended. Essential for AI model deployment where uncertain 
#' predictions should not drive clinical decisions, cytology with atypical 
#' findings requiring repeat sampling, and biomarker cutoffs where borderline 
#' values need confirmation. The analysis determines optimal grey-zone 
#' boundaries that maximize diagnostic certainty while minimizing inconclusive 
#' results, calculates performance metrics excluding vs including grey-zone 
#' cases, and provides clinical decision rules for handling uncertain 
#' classifications. Particularly valuable for real-world implementation of 
#' diagnostic tests where "I don't know" is a valid and often safer response 
#' than forcing a potentially incorrect binary classification.
#' 
#'
#' @examples
#' result <- greyzoneroc(
#'     data = ai_predictions,
#'     predictor = "ai_probability",
#'     outcome = "true_diagnosis",
#'     positive_level = "disease",
#'     grey_zone_width = 0.1,
#'     confidence_threshold = 0.80
#' )
#'
#' @param data The data as a data frame.
#' @param predictor Continuous predictor variable or probability score from
#'   diagnostic test. For AI models, this is typically the predicted
#'   probability. For biomarkers, this is the measured concentration or
#'   expression level.
#' @param outcome Binary gold standard outcome variable defining true disease
#'   status. Must have exactly 2 levels (positive/negative or diseased/healthy).
#' @param positive_level Level of the outcome variable representing the
#'   positive/diseased state.
#' @param grey_zone_method Method for defining the grey-zone boundaries. Fixed
#'   width creates equal margins around the optimal threshold, confidence uses
#'   prediction uncertainty from the model, cost-benefit minimizes expected
#'   costs, Youden creates symmetric zone maximizing certainty, custom allows
#'   manual boundary specification.
#' @param grey_zone_width Width of the grey zone when using fixed_width
#'   method. For probability scores (0-1), 0.1 creates a ±0.05 margin around the
#'   threshold. Larger values increase the indeterminate region but improve
#'   certainty for definite classifications.
#' @param lower_grey_boundary Lower boundary of grey zone when using custom
#'   method. Values below this are classified as negative. Should be less than
#'   upper_grey_boundary.
#' @param upper_grey_boundary Upper boundary of grey zone when using custom
#'   method. Values above this are classified as positive. Should be greater
#'   than lower_grey_boundary.
#' @param confidence_threshold Minimum confidence level required for definite
#'   classification when using confidence-based method. Predictions with lower
#'   confidence are assigned to grey zone. Higher values increase grey-zone size
#'   but improve reliability of definite calls.
#' @param cost_false_positive Relative cost of false positive classification.
#'   Used in cost-benefit optimization to determine grey-zone boundaries that
#'   minimize expected costs.
#' @param cost_false_negative Relative cost of false negative classification.
#'   Higher values widen the grey zone for low scores to avoid missing positive
#'   cases.
#' @param cost_grey_zone Relative cost of classifying a case as grey zone
#'   (requiring additional testing). Typically lower than misclassification
#'   costs but higher than correct classification. Reflects the burden of
#'   deferred decisions and additional testing.
#' @param calculate_definite_performance Calculate sensitivity, specificity,
#'   and AUC using only cases with definite classifications (excluding
#'   grey-zone). Shows the reliability of the test when it makes a definite
#'   call.
#' @param calculate_all_cases_performance Calculate performance treating
#'   grey-zone as misclassifications. Provides worst-case scenario where all
#'   deferred decisions are considered failures.
#' @param grey_zone_characteristics Analyze characteristics of cases falling
#'   in the grey zone including prevalence distribution, risk factors, and
#'   suggestions for resolution.
#' @param optimal_threshold Method for selecting the central threshold around
#'   which the grey zone is defined.
#' @param clinical_threshold Prespecified clinical threshold when using
#'   clinical threshold selection. Common values: 0.5 for balanced
#'   classification, varies by clinical context.
#' @param prediction_intervals Calculate prediction intervals around ROC curve
#'   to visualize uncertainty. Particularly useful for AI models with calibrated
#'   probabilities.
#' @param bootstrap_grey_zone Use bootstrap to assess stability of grey-zone
#'   boundaries and performance metrics. Provides confidence intervals for
#'   grey-zone size and definite classification rates.
#' @param bootstrap_samples Number of bootstrap samples for confidence
#'   interval estimation.
#' @param confidence_level Confidence level for intervals around performance
#'   metrics and grey-zone boundaries.
#' @param grey_zone_action Recommended clinical action for cases in the grey
#'   zone. This affects interpretation of diagnostic performance and workflow
#'   design.
#' @param reflex_test_name Name of the reflex/confirmatory test used for
#'   grey-zone cases. For example: FISH for HER2 2+, HPV testing for ASCUS
#'   cytology.
#' @param plot_grey_zone_roc Display ROC curve with grey-zone boundaries
#'   highlighted and performance metrics for definite vs all classifications
#'   shown.
#' @param plot_threshold_distributions Show distribution of predictor scores
#'   for positive and negative cases with grey-zone boundaries marked.
#'   Visualizes overlap and uncertainty.
#' @param plot_grey_zone_size Plot showing how varying grey-zone width affects
#'   the trade-off between percentage of definite classifications and their
#'   accuracy.
#' @param plot_uncertainty_map Create heatmap showing prediction uncertainty
#'   across the score range. Useful for AI models with calibrated confidence
#'   estimates.
#' @param plot_cost_surface Visualize expected costs across different
#'   grey-zone boundary configurations. Helps identify cost-optimal grey-zone
#'   width.
#' @param fuzzy_membership Use fuzzy set theory to model gradual transition
#'   between definite positive, grey zone, and definite negative. Provides soft
#'   boundaries instead of hard cutoffs.
#' @param bayesian_grey_zone Use Bayesian approach to define grey zone based
#'   on posterior probability intervals. Incorporates prior information and
#'   uncertainty quantification.
#' @param stratified_grey_zone Perform grey-zone analysis stratified by
#'   important covariates to assess whether grey-zone boundaries should vary by
#'   subpopulation.
#' @param stratify_by Variable for stratified analysis. Each level gets
#'   separate grey-zone analysis.
#' @param clinical_scenario Clinical scenario for context-specific
#'   interpretation and recommendations.
#' @param missing_handling Method for handling missing predictor or outcome
#'   data.
#' @param random_seed Random seed for bootstrap and other stochastic
#'   procedures.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$greyZoneSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$greyZoneBoundaries} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$definitePerformanceTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$allCasesPerformanceTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$greyZoneCharacteristics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$classificationBreakdown} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$costAnalysisTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$tradeoffAnalysisTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$stratifiedGreyZoneTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$greyZoneROCPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$thresholdDistributionsPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$greyZoneSizePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$uncertaintyMapPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$costSurfacePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$clinicalRecommendations} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$greyZoneSummary$asDF}
#'
#' \code{as.data.frame(results$greyZoneSummary)}
#'
#' @export
greyzoneroc <- function(
    data,
    predictor,
    outcome,
    positive_level,
    grey_zone_method = "fixed_width",
    grey_zone_width = 0.1,
    lower_grey_boundary = 0.45,
    upper_grey_boundary = 0.55,
    confidence_threshold = 0.8,
    cost_false_positive = 1,
    cost_false_negative = 1,
    cost_grey_zone = 0.3,
    calculate_definite_performance = TRUE,
    calculate_all_cases_performance = TRUE,
    grey_zone_characteristics = TRUE,
    optimal_threshold = "youden",
    clinical_threshold = 0.5,
    prediction_intervals = FALSE,
    bootstrap_grey_zone = TRUE,
    bootstrap_samples = 1000,
    confidence_level = 0.95,
    grey_zone_action = "reflex",
    reflex_test_name = "Confirmatory test",
    plot_grey_zone_roc = TRUE,
    plot_threshold_distributions = TRUE,
    plot_grey_zone_size = TRUE,
    plot_uncertainty_map = FALSE,
    plot_cost_surface = FALSE,
    fuzzy_membership = FALSE,
    bayesian_grey_zone = FALSE,
    stratified_grey_zone = FALSE,
    stratify_by,
    clinical_scenario = "general",
    missing_handling = "complete",
    random_seed = 123) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("greyzoneroc requires jmvcore to be installed (restart may be required)")

    if ( ! missing(predictor)) predictor <- jmvcore::resolveQuo(jmvcore::enquo(predictor))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(stratify_by)) stratify_by <- jmvcore::resolveQuo(jmvcore::enquo(stratify_by))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(predictor), predictor, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(stratify_by), stratify_by, NULL))

    for (v in outcome) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in stratify_by) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- greyzonerocOptions$new(
        predictor = predictor,
        outcome = outcome,
        positive_level = positive_level,
        grey_zone_method = grey_zone_method,
        grey_zone_width = grey_zone_width,
        lower_grey_boundary = lower_grey_boundary,
        upper_grey_boundary = upper_grey_boundary,
        confidence_threshold = confidence_threshold,
        cost_false_positive = cost_false_positive,
        cost_false_negative = cost_false_negative,
        cost_grey_zone = cost_grey_zone,
        calculate_definite_performance = calculate_definite_performance,
        calculate_all_cases_performance = calculate_all_cases_performance,
        grey_zone_characteristics = grey_zone_characteristics,
        optimal_threshold = optimal_threshold,
        clinical_threshold = clinical_threshold,
        prediction_intervals = prediction_intervals,
        bootstrap_grey_zone = bootstrap_grey_zone,
        bootstrap_samples = bootstrap_samples,
        confidence_level = confidence_level,
        grey_zone_action = grey_zone_action,
        reflex_test_name = reflex_test_name,
        plot_grey_zone_roc = plot_grey_zone_roc,
        plot_threshold_distributions = plot_threshold_distributions,
        plot_grey_zone_size = plot_grey_zone_size,
        plot_uncertainty_map = plot_uncertainty_map,
        plot_cost_surface = plot_cost_surface,
        fuzzy_membership = fuzzy_membership,
        bayesian_grey_zone = bayesian_grey_zone,
        stratified_grey_zone = stratified_grey_zone,
        stratify_by = stratify_by,
        clinical_scenario = clinical_scenario,
        missing_handling = missing_handling,
        random_seed = random_seed)

    analysis <- greyzonerocClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

