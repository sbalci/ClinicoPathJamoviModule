
# This file is automatically generated, you probably don't want to edit this

ihcpredictOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcpredictOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            useStoredModel = "stored",
            trainingFile = "",
            trainingDiagnosis = "Diagnosis",
            catVars = NULL,
            contVars = NULL,
            caseId = NULL,
            predictionMethod = "hybrid",
            confidenceThreshold = 0.5,
            highConfidenceThreshold = 0.75,
            lowConfidenceThreshold = 0.25,
            panelWeight = 0.5,
            distanceWeight = 0.3,
            silhouetteWeight = 0.2,
            showAlternatives = TRUE,
            nAlternatives = 3,
            showEvidence = TRUE,
            flagLowConfidence = TRUE,
            showMarkerComparison = TRUE,
            validateMarkers = TRUE,
            requireAllMarkers = TRUE,
            scaleContVars = TRUE,
            handleMissing = "pairwise",
            exportPredictions = FALSE,
            predictionVarName = "Predicted_Diagnosis",
            confidenceVarName = "Prediction_Confidence",
            showPredictionPlot = TRUE,
            showConfidencePlot = TRUE,
            colorPalette = "colorblind",
            fontSize = "medium",
            plotContrast = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="ihcpredict",
                requiresData=TRUE,
                ...)

            private$..useStoredModel <- jmvcore::OptionList$new(
                "useStoredModel",
                useStoredModel,
                options=list(
                    "stored",
                    "file"),
                default="stored")
            private$..trainingFile <- jmvcore::OptionString$new(
                "trainingFile",
                trainingFile,
                default="")
            private$..trainingDiagnosis <- jmvcore::OptionString$new(
                "trainingDiagnosis",
                trainingDiagnosis,
                default="Diagnosis")
            private$..catVars <- jmvcore::OptionVariables$new(
                "catVars",
                catVars,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..contVars <- jmvcore::OptionVariables$new(
                "contVars",
                contVars,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..caseId <- jmvcore::OptionVariable$new(
                "caseId",
                caseId,
                suggested=list(
                    "nominal",
                    "id"),
                permitted=list(
                    "factor",
                    "id"),
                default=NULL)
            private$..predictionMethod <- jmvcore::OptionList$new(
                "predictionMethod",
                predictionMethod,
                options=list(
                    "hybrid",
                    "distance",
                    "rules",
                    "cluster"),
                default="hybrid")
            private$..confidenceThreshold <- jmvcore::OptionNumber$new(
                "confidenceThreshold",
                confidenceThreshold,
                min=0,
                max=1,
                default=0.5)
            private$..highConfidenceThreshold <- jmvcore::OptionNumber$new(
                "highConfidenceThreshold",
                highConfidenceThreshold,
                min=0,
                max=1,
                default=0.75)
            private$..lowConfidenceThreshold <- jmvcore::OptionNumber$new(
                "lowConfidenceThreshold",
                lowConfidenceThreshold,
                min=0,
                max=1,
                default=0.25)
            private$..panelWeight <- jmvcore::OptionNumber$new(
                "panelWeight",
                panelWeight,
                min=0,
                max=1,
                default=0.5)
            private$..distanceWeight <- jmvcore::OptionNumber$new(
                "distanceWeight",
                distanceWeight,
                min=0,
                max=1,
                default=0.3)
            private$..silhouetteWeight <- jmvcore::OptionNumber$new(
                "silhouetteWeight",
                silhouetteWeight,
                min=0,
                max=1,
                default=0.2)
            private$..showAlternatives <- jmvcore::OptionBool$new(
                "showAlternatives",
                showAlternatives,
                default=TRUE)
            private$..nAlternatives <- jmvcore::OptionInteger$new(
                "nAlternatives",
                nAlternatives,
                min=1,
                max=5,
                default=3)
            private$..showEvidence <- jmvcore::OptionBool$new(
                "showEvidence",
                showEvidence,
                default=TRUE)
            private$..flagLowConfidence <- jmvcore::OptionBool$new(
                "flagLowConfidence",
                flagLowConfidence,
                default=TRUE)
            private$..showMarkerComparison <- jmvcore::OptionBool$new(
                "showMarkerComparison",
                showMarkerComparison,
                default=TRUE)
            private$..validateMarkers <- jmvcore::OptionBool$new(
                "validateMarkers",
                validateMarkers,
                default=TRUE)
            private$..requireAllMarkers <- jmvcore::OptionBool$new(
                "requireAllMarkers",
                requireAllMarkers,
                default=TRUE)
            private$..scaleContVars <- jmvcore::OptionBool$new(
                "scaleContVars",
                scaleContVars,
                default=TRUE)
            private$..handleMissing <- jmvcore::OptionList$new(
                "handleMissing",
                handleMissing,
                options=list(
                    "complete",
                    "pairwise"),
                default="pairwise")
            private$..exportPredictions <- jmvcore::OptionBool$new(
                "exportPredictions",
                exportPredictions,
                default=FALSE)
            private$..predictionVarName <- jmvcore::OptionString$new(
                "predictionVarName",
                predictionVarName,
                default="Predicted_Diagnosis")
            private$..confidenceVarName <- jmvcore::OptionString$new(
                "confidenceVarName",
                confidenceVarName,
                default="Prediction_Confidence")
            private$..showPredictionPlot <- jmvcore::OptionBool$new(
                "showPredictionPlot",
                showPredictionPlot,
                default=TRUE)
            private$..showConfidencePlot <- jmvcore::OptionBool$new(
                "showConfidencePlot",
                showConfidencePlot,
                default=TRUE)
            private$..colorPalette <- jmvcore::OptionList$new(
                "colorPalette",
                colorPalette,
                options=list(
                    "default",
                    "colorblind",
                    "viridis",
                    "high_contrast"),
                default="colorblind")
            private$..fontSize <- jmvcore::OptionList$new(
                "fontSize",
                fontSize,
                options=list(
                    "small",
                    "medium",
                    "large",
                    "extra_large"),
                default="medium")
            private$..plotContrast <- jmvcore::OptionBool$new(
                "plotContrast",
                plotContrast,
                default=FALSE)

            self$.addOption(private$..useStoredModel)
            self$.addOption(private$..trainingFile)
            self$.addOption(private$..trainingDiagnosis)
            self$.addOption(private$..catVars)
            self$.addOption(private$..contVars)
            self$.addOption(private$..caseId)
            self$.addOption(private$..predictionMethod)
            self$.addOption(private$..confidenceThreshold)
            self$.addOption(private$..highConfidenceThreshold)
            self$.addOption(private$..lowConfidenceThreshold)
            self$.addOption(private$..panelWeight)
            self$.addOption(private$..distanceWeight)
            self$.addOption(private$..silhouetteWeight)
            self$.addOption(private$..showAlternatives)
            self$.addOption(private$..nAlternatives)
            self$.addOption(private$..showEvidence)
            self$.addOption(private$..flagLowConfidence)
            self$.addOption(private$..showMarkerComparison)
            self$.addOption(private$..validateMarkers)
            self$.addOption(private$..requireAllMarkers)
            self$.addOption(private$..scaleContVars)
            self$.addOption(private$..handleMissing)
            self$.addOption(private$..exportPredictions)
            self$.addOption(private$..predictionVarName)
            self$.addOption(private$..confidenceVarName)
            self$.addOption(private$..showPredictionPlot)
            self$.addOption(private$..showConfidencePlot)
            self$.addOption(private$..colorPalette)
            self$.addOption(private$..fontSize)
            self$.addOption(private$..plotContrast)
        }),
    active = list(
        useStoredModel = function() private$..useStoredModel$value,
        trainingFile = function() private$..trainingFile$value,
        trainingDiagnosis = function() private$..trainingDiagnosis$value,
        catVars = function() private$..catVars$value,
        contVars = function() private$..contVars$value,
        caseId = function() private$..caseId$value,
        predictionMethod = function() private$..predictionMethod$value,
        confidenceThreshold = function() private$..confidenceThreshold$value,
        highConfidenceThreshold = function() private$..highConfidenceThreshold$value,
        lowConfidenceThreshold = function() private$..lowConfidenceThreshold$value,
        panelWeight = function() private$..panelWeight$value,
        distanceWeight = function() private$..distanceWeight$value,
        silhouetteWeight = function() private$..silhouetteWeight$value,
        showAlternatives = function() private$..showAlternatives$value,
        nAlternatives = function() private$..nAlternatives$value,
        showEvidence = function() private$..showEvidence$value,
        flagLowConfidence = function() private$..flagLowConfidence$value,
        showMarkerComparison = function() private$..showMarkerComparison$value,
        validateMarkers = function() private$..validateMarkers$value,
        requireAllMarkers = function() private$..requireAllMarkers$value,
        scaleContVars = function() private$..scaleContVars$value,
        handleMissing = function() private$..handleMissing$value,
        exportPredictions = function() private$..exportPredictions$value,
        predictionVarName = function() private$..predictionVarName$value,
        confidenceVarName = function() private$..confidenceVarName$value,
        showPredictionPlot = function() private$..showPredictionPlot$value,
        showConfidencePlot = function() private$..showConfidencePlot$value,
        colorPalette = function() private$..colorPalette$value,
        fontSize = function() private$..fontSize$value,
        plotContrast = function() private$..plotContrast$value),
    private = list(
        ..useStoredModel = NA,
        ..trainingFile = NA,
        ..trainingDiagnosis = NA,
        ..catVars = NA,
        ..contVars = NA,
        ..caseId = NA,
        ..predictionMethod = NA,
        ..confidenceThreshold = NA,
        ..highConfidenceThreshold = NA,
        ..lowConfidenceThreshold = NA,
        ..panelWeight = NA,
        ..distanceWeight = NA,
        ..silhouetteWeight = NA,
        ..showAlternatives = NA,
        ..nAlternatives = NA,
        ..showEvidence = NA,
        ..flagLowConfidence = NA,
        ..showMarkerComparison = NA,
        ..validateMarkers = NA,
        ..requireAllMarkers = NA,
        ..scaleContVars = NA,
        ..handleMissing = NA,
        ..exportPredictions = NA,
        ..predictionVarName = NA,
        ..confidenceVarName = NA,
        ..showPredictionPlot = NA,
        ..showConfidencePlot = NA,
        ..colorPalette = NA,
        ..fontSize = NA,
        ..plotContrast = NA)
)

ihcpredictResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcpredictResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        modelSummary = function() private$.items[["modelSummary"]],
        validationResults = function() private$.items[["validationResults"]],
        predictions = function() private$.items[["predictions"]],
        alternativeDiagnoses = function() private$.items[["alternativeDiagnoses"]],
        predictionEvidence = function() private$.items[["predictionEvidence"]],
        lowConfidenceCases = function() private$.items[["lowConfidenceCases"]],
        markerComparison = function() private$.items[["markerComparison"]],
        predictionSummary = function() private$.items[["predictionSummary"]],
        confidenceByDiagnosis = function() private$.items[["confidenceByDiagnosis"]],
        predictionPlot = function() private$.items[["predictionPlot"]],
        confidencePlot = function() private$.items[["confidencePlot"]],
        markerHeatmap = function() private$.items[["markerHeatmap"]],
        clinicalGuidance = function() private$.items[["clinicalGuidance"]],
        technicalDetails = function() private$.items[["technicalDetails"]],
        exportSummary = function() private$.items[["exportSummary"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="IHC Diagnostic Prediction",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions"))
            self$add(jmvcore::Html$new(
                options=options,
                name="modelSummary",
                title="Reference Model Summary",
                visible=TRUE,
                clearWith=list(
                    "useStoredModel",
                    "trainingFile",
                    "trainingDiagnosis")))
            self$add(jmvcore::Table$new(
                options=options,
                name="validationResults",
                title="Marker Validation",
                visible="(validateMarkers)",
                clearWith=list(
                    "catVars",
                    "contVars",
                    "trainingFile"),
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="in_training", 
                        `title`="In Training Set", 
                        `type`="text"),
                    list(
                        `name`="in_query", 
                        `title`="In Query Set", 
                        `type`="text"),
                    list(
                        `name`="type_match", 
                        `title`="Data Type Match", 
                        `type`="text"),
                    list(
                        `name`="status", 
                        `title`="Validation Status", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="predictions",
                title="Diagnostic Predictions",
                visible=TRUE,
                clearWith=list(
                    "catVars",
                    "contVars",
                    "predictionMethod",
                    "confidenceThreshold",
                    "panelWeight",
                    "distanceWeight",
                    "silhouetteWeight"),
                columns=list(
                    list(
                        `name`="case_id", 
                        `title`="Case ID", 
                        `type`="text"),
                    list(
                        `name`="predicted_diagnosis", 
                        `title`="Predicted Diagnosis", 
                        `type`="text"),
                    list(
                        `name`="confidence", 
                        `title`="Confidence Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="confidence_level", 
                        `title`="Confidence Level", 
                        `type`="text"),
                    list(
                        `name`="prediction_method", 
                        `title`="Method Used", 
                        `type`="text"),
                    list(
                        `name`="recommendation", 
                        `title`="Clinical Recommendation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="alternativeDiagnoses",
                title="Alternative Diagnoses (Differential)",
                visible="(showAlternatives)",
                clearWith=list(
                    "catVars",
                    "contVars",
                    "predictionMethod",
                    "nAlternatives"),
                columns=list(
                    list(
                        `name`="case_id", 
                        `title`="Case ID", 
                        `type`="text"),
                    list(
                        `name`="rank", 
                        `title`="Rank", 
                        `type`="integer"),
                    list(
                        `name`="alternative_diagnosis", 
                        `title`="Alternative Diagnosis", 
                        `type`="text"),
                    list(
                        `name`="confidence", 
                        `title`="Confidence Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="difference_from_primary", 
                        `title`="Difference from Primary", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="predictionEvidence",
                title="Prediction Evidence Details",
                visible="(showEvidence)",
                clearWith=list(
                    "catVars",
                    "contVars",
                    "predictionMethod"),
                columns=list(
                    list(
                        `name`="case_id", 
                        `title`="Case ID", 
                        `type`="text"),
                    list(
                        `name`="predicted_diagnosis", 
                        `title`="Predicted Diagnosis", 
                        `type`="text"),
                    list(
                        `name`="panel_match", 
                        `title`="Panel Match", 
                        `type`="text"),
                    list(
                        `name`="panel_ppv", 
                        `title`="Panel PPV", 
                        `type`="number", 
                        `format`="zto,pc"),
                    list(
                        `name`="assigned_cluster", 
                        `title`="Assigned Cluster", 
                        `type`="text"),
                    list(
                        `name`="cluster_purity", 
                        `title`="Cluster Purity", 
                        `type`="number", 
                        `format`="zto,pc"),
                    list(
                        `name`="distance_to_centroid", 
                        `title`="Distance to Centroid", 
                        `type`="number"),
                    list(
                        `name`="silhouette_score", 
                        `title`="Silhouette Score", 
                        `type`="number"),
                    list(
                        `name`="overall_confidence", 
                        `title`="Overall Confidence", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="lowConfidenceCases",
                title="Low Confidence Predictions (Review Required)",
                visible="(flagLowConfidence)",
                clearWith=list(
                    "catVars",
                    "contVars",
                    "predictionMethod",
                    "lowConfidenceThreshold"),
                columns=list(
                    list(
                        `name`="case_id", 
                        `title`="Case ID", 
                        `type`="text"),
                    list(
                        `name`="predicted_diagnosis", 
                        `title`="Predicted Diagnosis", 
                        `type`="text"),
                    list(
                        `name`="confidence", 
                        `title`="Confidence Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="quality_flag", 
                        `title`="Quality Flag", 
                        `type`="text"),
                    list(
                        `name`="primary_issue", 
                        `title`="Primary Issue", 
                        `type`="text"),
                    list(
                        `name`="recommendation", 
                        `title`="Recommendation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="markerComparison",
                title="Marker Expression Comparison",
                visible="(showMarkerComparison)",
                clearWith=list(
                    "catVars",
                    "contVars",
                    "predictionMethod"),
                columns=list(
                    list(
                        `name`="case_id", 
                        `title`="Case ID", 
                        `type`="text"),
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="query_value", 
                        `title`="Query Case Value", 
                        `type`="text"),
                    list(
                        `name`="predicted_diagnosis", 
                        `title`="Predicted Diagnosis", 
                        `type`="text"),
                    list(
                        `name`="centroid_value", 
                        `title`="Centroid Value", 
                        `type`="text"),
                    list(
                        `name`="match_status", 
                        `title`="Match Status", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="predictionSummary",
                title="Prediction Summary Statistics",
                visible=TRUE,
                clearWith=list(
                    "catVars",
                    "contVars",
                    "predictionMethod"),
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="confidenceByDiagnosis",
                title="Confidence Statistics by Predicted Diagnosis",
                visible=TRUE,
                clearWith=list(
                    "catVars",
                    "contVars",
                    "predictionMethod"),
                columns=list(
                    list(
                        `name`="diagnosis", 
                        `title`="Predicted Diagnosis", 
                        `type`="text"),
                    list(
                        `name`="n_cases", 
                        `title`="N Cases", 
                        `type`="integer"),
                    list(
                        `name`="mean_confidence", 
                        `title`="Mean Confidence", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="median_confidence", 
                        `title`="Median Confidence", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="min_confidence", 
                        `title`="Min Confidence", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="max_confidence", 
                        `title`="Max Confidence", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="n_high_confidence", 
                        `title`="N High Confidence", 
                        `type`="integer"),
                    list(
                        `name`="n_low_confidence", 
                        `title`="N Low Confidence", 
                        `type`="integer"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="predictionPlot",
                title="Prediction Visualization (PCA/MCA)",
                width=800,
                height=700,
                renderFun=".plotPredictions",
                visible="(showPredictionPlot)",
                clearWith=list(
                    "catVars",
                    "contVars",
                    "predictionMethod",
                    "colorPalette",
                    "fontSize",
                    "plotContrast")))
            self$add(jmvcore::Image$new(
                options=options,
                name="confidencePlot",
                title="Confidence Score Distribution",
                width=700,
                height=500,
                renderFun=".plotConfidenceDistribution",
                visible="(showConfidencePlot)",
                clearWith=list(
                    "predictionMethod",
                    "highConfidenceThreshold",
                    "lowConfidenceThreshold",
                    "colorPalette",
                    "fontSize",
                    "plotContrast")))
            self$add(jmvcore::Image$new(
                options=options,
                name="markerHeatmap",
                title="Query Cases vs Training Centroids Heatmap",
                width=900,
                height=700,
                renderFun=".plotMarkerHeatmap",
                visible="(showMarkerComparison)",
                clearWith=list(
                    "catVars",
                    "contVars",
                    "predictionMethod",
                    "colorPalette",
                    "fontSize",
                    "plotContrast")))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalGuidance",
                title="Clinical Interpretation and Next Steps",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="technicalDetails",
                title="Technical Details",
                visible=TRUE))
            self$add(jmvcore::Preformatted$new(
                options=options,
                name="exportSummary",
                title="Export Summary (Copy-Ready Report)",
                visible=TRUE,
                clearWith=list(
                    "catVars",
                    "contVars",
                    "predictionMethod")))}))

ihcpredictBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcpredictBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "ihcpredict",
                version = c(1,0,0),
                options = options,
                results = ihcpredictResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' IHC Diagnostic Prediction
#'
#' Predicts diagnoses for cases with unknown diagnoses based on IHC marker 
#' expression patterns,
#' using a trained reference model from previously analyzed cases with known 
#' diagnoses.
#' 
#' **Requirements:**
#' - Training dataset analyzed with \code{ihccluster} (with known diagnoses)
#' - Query dataset with same IHC markers (unknown diagnoses to predict)
#' - Marker names and data types must match between datasets
#' 
#' **Output:**
#' - Predicted diagnosis per case with confidence level
#' - Alternative diagnoses (differential)
#' - Evidence supporting each prediction
#' - Flags for atypical/low-confidence cases
#' 
#' @param data The query data as a data frame (cases with unknown diagnoses).
#' @param useStoredModel Source of the trained reference model
#' @param trainingFile Path to CSV file with training cases (must include
#'   Diagnosis column)
#' @param trainingDiagnosis Name of the diagnosis variable in training dataset
#' @param catVars Binary (pos/neg) or ordinal (0/1/2/3) stain results - must
#'   match training markers
#' @param contVars H-scores (0-300), \% positivity (0-100) - must match
#'   training markers
#' @param caseId Case identifier for tracking predictions
#' @param predictionMethod Algorithm for predicting diagnoses
#' @param confidenceThreshold Minimum confidence score to accept prediction
#'   (0-1)
#' @param highConfidenceThreshold Threshold for "High Confidence"
#'   classification
#' @param lowConfidenceThreshold Threshold below which cases are flagged as
#'   very low confidence
#' @param panelWeight Weight for rule-based panel matches (hybrid method only)
#' @param distanceWeight Weight for distance to centroid (hybrid method only)
#' @param silhouetteWeight Weight for silhouette score (hybrid method only)
#' @param showAlternatives Display differential diagnosis with top 3
#'   alternatives
#' @param nAlternatives Number of alternative diagnoses to report
#' @param showEvidence Display detailed evidence supporting each prediction
#' @param flagLowConfidence Create separate table for cases requiring review
#' @param showMarkerComparison Compare query case markers to cluster centroids
#' @param validateMarkers Check that query markers match training markers
#' @param requireAllMarkers Error if any training markers are missing from
#'   query data
#' @param scaleContVars Z-score continuous markers using training set
#'   parameters
#' @param handleMissing How to handle missing marker values in query data
#' @param exportPredictions Save predicted diagnoses and confidence scores to
#'   dataset
#' @param predictionVarName Name for exported prediction variable
#' @param confidenceVarName Name for exported confidence score variable
#' @param showPredictionPlot Display PCA/MCA plot with query cases and
#'   training clusters
#' @param showConfidencePlot Display histogram of prediction confidence scores
#' @param colorPalette Color palette for plots
#' @param fontSize Base font size for all text elements
#' @param plotContrast Enable high contrast mode for better visibility
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$validationResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$predictions} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$alternativeDiagnoses} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$predictionEvidence} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$lowConfidenceCases} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$markerComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$predictionSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$confidenceByDiagnosis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$predictionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$confidencePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$markerHeatmap} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$clinicalGuidance} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$technicalDetails} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$exportSummary} \tab \tab \tab \tab \tab a preformatted \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$validationResults$asDF}
#'
#' \code{as.data.frame(results$validationResults)}
#'
#' @export
ihcpredict <- function(
    data,
    useStoredModel = "stored",
    trainingFile = "",
    trainingDiagnosis = "Diagnosis",
    catVars = NULL,
    contVars = NULL,
    caseId = NULL,
    predictionMethod = "hybrid",
    confidenceThreshold = 0.5,
    highConfidenceThreshold = 0.75,
    lowConfidenceThreshold = 0.25,
    panelWeight = 0.5,
    distanceWeight = 0.3,
    silhouetteWeight = 0.2,
    showAlternatives = TRUE,
    nAlternatives = 3,
    showEvidence = TRUE,
    flagLowConfidence = TRUE,
    showMarkerComparison = TRUE,
    validateMarkers = TRUE,
    requireAllMarkers = TRUE,
    scaleContVars = TRUE,
    handleMissing = "pairwise",
    exportPredictions = FALSE,
    predictionVarName = "Predicted_Diagnosis",
    confidenceVarName = "Prediction_Confidence",
    showPredictionPlot = TRUE,
    showConfidencePlot = TRUE,
    colorPalette = "colorblind",
    fontSize = "medium",
    plotContrast = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("ihcpredict requires jmvcore to be installed (restart may be required)")

    if ( ! missing(catVars)) catVars <- jmvcore::resolveQuo(jmvcore::enquo(catVars))
    if ( ! missing(contVars)) contVars <- jmvcore::resolveQuo(jmvcore::enquo(contVars))
    if ( ! missing(caseId)) caseId <- jmvcore::resolveQuo(jmvcore::enquo(caseId))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(catVars), catVars, NULL),
            `if`( ! missing(contVars), contVars, NULL),
            `if`( ! missing(caseId), caseId, NULL))

    for (v in catVars) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- ihcpredictOptions$new(
        useStoredModel = useStoredModel,
        trainingFile = trainingFile,
        trainingDiagnosis = trainingDiagnosis,
        catVars = catVars,
        contVars = contVars,
        caseId = caseId,
        predictionMethod = predictionMethod,
        confidenceThreshold = confidenceThreshold,
        highConfidenceThreshold = highConfidenceThreshold,
        lowConfidenceThreshold = lowConfidenceThreshold,
        panelWeight = panelWeight,
        distanceWeight = distanceWeight,
        silhouetteWeight = silhouetteWeight,
        showAlternatives = showAlternatives,
        nAlternatives = nAlternatives,
        showEvidence = showEvidence,
        flagLowConfidence = flagLowConfidence,
        showMarkerComparison = showMarkerComparison,
        validateMarkers = validateMarkers,
        requireAllMarkers = requireAllMarkers,
        scaleContVars = scaleContVars,
        handleMissing = handleMissing,
        exportPredictions = exportPredictions,
        predictionVarName = predictionVarName,
        confidenceVarName = confidenceVarName,
        showPredictionPlot = showPredictionPlot,
        showConfidencePlot = showConfidencePlot,
        colorPalette = colorPalette,
        fontSize = fontSize,
        plotContrast = plotContrast)

    analysis <- ihcpredictClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

