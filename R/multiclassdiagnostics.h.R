
# This file is automatically generated, you probably don't want to edit this

multiclassdiagnosticsOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "multiclassdiagnosticsOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            predicted = NULL,
            actual = NULL,
            positiveClass = NULL,
            confidenceLevel = 0.95,
            showROC = TRUE,
            showConfusion = TRUE,
            showPerClass = TRUE,
            showOverall = TRUE,
            compareModels = FALSE,
            predicted2 = NULL,
            modelNames = "Model 1,Model 2",
            deLongTest = TRUE,
            mcnemarTest = TRUE,
            plotTheme = "default",
            saveResults = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="multiclassdiagnostics",
                requiresData=TRUE,
                ...)

            private$..predicted <- jmvcore::OptionVariable$new(
                "predicted",
                predicted,
                required=TRUE,
                suggested=list(
                    "nominal",
                    "ordinal"))
            private$..actual <- jmvcore::OptionVariable$new(
                "actual",
                actual,
                required=TRUE,
                suggested=list(
                    "nominal",
                    "ordinal"))
            private$..positiveClass <- jmvcore::OptionLevel$new(
                "positiveClass",
                positiveClass,
                variable="(actual)")
            private$..confidenceLevel <- jmvcore::OptionNumber$new(
                "confidenceLevel",
                confidenceLevel,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..showROC <- jmvcore::OptionBool$new(
                "showROC",
                showROC,
                default=TRUE)
            private$..showConfusion <- jmvcore::OptionBool$new(
                "showConfusion",
                showConfusion,
                default=TRUE)
            private$..showPerClass <- jmvcore::OptionBool$new(
                "showPerClass",
                showPerClass,
                default=TRUE)
            private$..showOverall <- jmvcore::OptionBool$new(
                "showOverall",
                showOverall,
                default=TRUE)
            private$..compareModels <- jmvcore::OptionBool$new(
                "compareModels",
                compareModels,
                default=FALSE)
            private$..predicted2 <- jmvcore::OptionVariable$new(
                "predicted2",
                predicted2,
                suggested=list(
                    "nominal",
                    "ordinal"))
            private$..modelNames <- jmvcore::OptionString$new(
                "modelNames",
                modelNames,
                default="Model 1,Model 2")
            private$..deLongTest <- jmvcore::OptionBool$new(
                "deLongTest",
                deLongTest,
                default=TRUE)
            private$..mcnemarTest <- jmvcore::OptionBool$new(
                "mcnemarTest",
                mcnemarTest,
                default=TRUE)
            private$..plotTheme <- jmvcore::OptionList$new(
                "plotTheme",
                plotTheme,
                options=list(
                    "default",
                    "minimal",
                    "classic"),
                default="default")
            private$..saveResults <- jmvcore::OptionBool$new(
                "saveResults",
                saveResults,
                default=FALSE)

            self$.addOption(private$..predicted)
            self$.addOption(private$..actual)
            self$.addOption(private$..positiveClass)
            self$.addOption(private$..confidenceLevel)
            self$.addOption(private$..showROC)
            self$.addOption(private$..showConfusion)
            self$.addOption(private$..showPerClass)
            self$.addOption(private$..showOverall)
            self$.addOption(private$..compareModels)
            self$.addOption(private$..predicted2)
            self$.addOption(private$..modelNames)
            self$.addOption(private$..deLongTest)
            self$.addOption(private$..mcnemarTest)
            self$.addOption(private$..plotTheme)
            self$.addOption(private$..saveResults)
        }),
    active = list(
        predicted = function() private$..predicted$value,
        actual = function() private$..actual$value,
        positiveClass = function() private$..positiveClass$value,
        confidenceLevel = function() private$..confidenceLevel$value,
        showROC = function() private$..showROC$value,
        showConfusion = function() private$..showConfusion$value,
        showPerClass = function() private$..showPerClass$value,
        showOverall = function() private$..showOverall$value,
        compareModels = function() private$..compareModels$value,
        predicted2 = function() private$..predicted2$value,
        modelNames = function() private$..modelNames$value,
        deLongTest = function() private$..deLongTest$value,
        mcnemarTest = function() private$..mcnemarTest$value,
        plotTheme = function() private$..plotTheme$value,
        saveResults = function() private$..saveResults$value),
    private = list(
        ..predicted = NA,
        ..actual = NA,
        ..positiveClass = NA,
        ..confidenceLevel = NA,
        ..showROC = NA,
        ..showConfusion = NA,
        ..showPerClass = NA,
        ..showOverall = NA,
        ..compareModels = NA,
        ..predicted2 = NA,
        ..modelNames = NA,
        ..deLongTest = NA,
        ..mcnemarTest = NA,
        ..plotTheme = NA,
        ..saveResults = NA)
)

multiclassdiagnosticsResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "multiclassdiagnosticsResults",
    inherit = jmvcore::Group,
    active = list(
        confusionMatrix = function() private$.items[["confusionMatrix"]],
        perClassMetrics = function() private$.items[["perClassMetrics"]],
        overallMetrics = function() private$.items[["overallMetrics"]],
        modelComparison = function() private$.items[["modelComparison"]],
        deLongResults = function() private$.items[["deLongResults"]],
        mcnemarResults = function() private$.items[["mcnemarResults"]],
        rocPlot = function() private$.items[["rocPlot"]],
        confusionPlot = function() private$.items[["confusionPlot"]],
        metricsPlot = function() private$.items[["metricsPlot"]],
        modelComparisonPlot = function() private$.items[["modelComparisonPlot"]],
        text = function() private$.items[["text"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Multi-class Diagnostic Performance Results",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "pROC",
                    "psych",
                    "tidyr"))
            self$add(jmvcore::Table$new(
                options=options,
                name="confusionMatrix",
                title="Confusion Matrix",
                visible="(showConfusion)",
                columns=list(
                    list(
                        `name`="actual_class", 
                        `title`="Actual Class", 
                        `type`="text"),
                    list(
                        `name`=".total[predicted]", 
                        `title`="Total", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="perClassMetrics",
                title="Per-Class Performance Metrics",
                visible="(showPerClass)",
                columns=list(
                    list(
                        `name`="class", 
                        `title`="Class", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="ppv", 
                        `title`="PPV", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="npv", 
                        `title`="NPV", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="f1", 
                        `title`="F1 Score", 
                        `type`="number"),
                    list(
                        `name`="youden", 
                        `title`="Youden Index", 
                        `type`="number"),
                    list(
                        `name`="auc", 
                        `title`="AUC", 
                        `type`="number", 
                        `format`="zto(3)"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="overallMetrics",
                title="Overall Performance Metrics",
                visible="(showOverall)",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelComparison",
                title="Model Comparison",
                visible="(compareModels)",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="model1", 
                        `title`="Model 1", 
                        `type`="number"),
                    list(
                        `name`="model2", 
                        `title`="Model 2", 
                        `type`="number"),
                    list(
                        `name`="difference", 
                        `title`="Difference", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto(3)"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="deLongResults",
                title="DeLong Test Results",
                visible="(compareModels && deLongTest)",
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="z_statistic", 
                        `title`="Z Statistic", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto(3)"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="mcnemarResults",
                title="McNemar Test Results",
                visible="(compareModels && mcnemarTest)",
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="chi_squared", 
                        `title`="Chi-squared", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto(3)"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="rocPlot",
                title="ROC Curves",
                visible="(showROC)",
                width=600,
                height=500,
                renderFun=".rocPlot"))
            self$add(jmvcore::Image$new(
                options=options,
                name="confusionPlot",
                title="Confusion Matrix Heatmap",
                visible="(showConfusion)",
                width=500,
                height=500,
                renderFun=".confusionPlot"))
            self$add(jmvcore::Image$new(
                options=options,
                name="metricsPlot",
                title="Performance Metrics Comparison",
                visible="(showPerClass)",
                width=600,
                height=400,
                renderFun=".metricsPlot"))
            self$add(jmvcore::Image$new(
                options=options,
                name="modelComparisonPlot",
                title="Model Comparison Plot",
                visible="(compareModels)",
                width=600,
                height=400,
                renderFun=".modelComparisonPlot"))
            self$add(jmvcore::Preformatted$new(
                options=options,
                name="text",
                title="Analysis Summary"))}))

multiclassdiagnosticsBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "multiclassdiagnosticsBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "multiclassdiagnostics",
                version = c(0,0,31),
                options = options,
                results = multiclassdiagnosticsResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Multi-class Diagnostic Performance Evaluation
#'
#' Comprehensive evaluation of multi-class classification performance 
#' including per-class and overall metrics, ROC curves, confusion matrices, 
#' and model comparison capabilities.
#' 
#' @param data .
#' @param predicted Variable containing predicted class labels
#' @param actual Variable containing true class labels
#' @param positiveClass For binary classification, specify which class is
#'   considered positive
#' @param confidenceLevel Confidence level for intervals
#' @param showROC Display ROC curves for each class (one-vs-rest)
#' @param showConfusion Display confusion matrix
#' @param showPerClass Show sensitivity, specificity, PPV, NPV for each class
#' @param showOverall Show overall accuracy, kappa, and weighted metrics
#' @param compareModels Enable model comparison
#' @param predicted2 Predicted classes for second model (for comparison)
#' @param modelNames Names for the models being compared (comma-separated)
#' @param deLongTest Perform DeLong test for ROC curve comparison (binary
#'   classification only)
#' @param mcnemarTest Perform McNemar test for paired model comparison
#' @param plotTheme Theme for plots
#' @param saveResults Save detailed results to file
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$confusionMatrix} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$perClassMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$overallMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$deLongResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$mcnemarResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$rocPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$confusionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$metricsPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$modelComparisonPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$text} \tab \tab \tab \tab \tab a preformatted \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$confusionMatrix$asDF}
#'
#' \code{as.data.frame(results$confusionMatrix)}
#'
#' @export
multiclassdiagnostics <- function(
    data,
    predicted,
    actual,
    positiveClass,
    confidenceLevel = 0.95,
    showROC = TRUE,
    showConfusion = TRUE,
    showPerClass = TRUE,
    showOverall = TRUE,
    compareModels = FALSE,
    predicted2,
    modelNames = "Model 1,Model 2",
    deLongTest = TRUE,
    mcnemarTest = TRUE,
    plotTheme = "default",
    saveResults = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("multiclassdiagnostics requires jmvcore to be installed (restart may be required)")

    if ( ! missing(predicted)) predicted <- jmvcore::resolveQuo(jmvcore::enquo(predicted))
    if ( ! missing(actual)) actual <- jmvcore::resolveQuo(jmvcore::enquo(actual))
    if ( ! missing(predicted2)) predicted2 <- jmvcore::resolveQuo(jmvcore::enquo(predicted2))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(predicted), predicted, NULL),
            `if`( ! missing(actual), actual, NULL),
            `if`( ! missing(predicted2), predicted2, NULL))


    options <- multiclassdiagnosticsOptions$new(
        predicted = predicted,
        actual = actual,
        positiveClass = positiveClass,
        confidenceLevel = confidenceLevel,
        showROC = showROC,
        showConfusion = showConfusion,
        showPerClass = showPerClass,
        showOverall = showOverall,
        compareModels = compareModels,
        predicted2 = predicted2,
        modelNames = modelNames,
        deLongTest = deLongTest,
        mcnemarTest = mcnemarTest,
        plotTheme = plotTheme,
        saveResults = saveResults)

    analysis <- multiclassdiagnosticsClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

