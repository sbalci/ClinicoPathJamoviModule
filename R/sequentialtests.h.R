
# This file is automatically generated, you probably don't want to edit this

sequentialtestsOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "sequentialtestsOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            preset = "custom",
            test1_name = "Screening Test",
            test1_sens = 0.95,
            test1_spec = 0.7,
            test1_cost = 0,
            test2_name = "Confirmatory Test",
            test2_sens = 0.8,
            test2_spec = 0.98,
            test2_cost = 0,
            strategy = "serial_positive",
            prevalence = 0.1,
            population_size = 1000,
            show_explanation = FALSE,
            show_formulas = FALSE,
            show_cost_analysis = FALSE,
            show_nomogram = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="sequentialtests",
                requiresData=FALSE,
                ...)

            private$..preset <- jmvcore::OptionList$new(
                "preset",
                preset,
                options=list(
                    "custom",
                    "covid_screening_confirmation",
                    "breast_cancer_screening",
                    "mi_emergency_parallel",
                    "tb_screening_confirmation",
                    "prostate_screening_exclusion",
                    "hiv_screening_confirmation",
                    "stroke_emergency_parallel"),
                default="custom")
            private$..test1_name <- jmvcore::OptionString$new(
                "test1_name",
                test1_name,
                default="Screening Test")
            private$..test1_sens <- jmvcore::OptionNumber$new(
                "test1_sens",
                test1_sens,
                default=0.95,
                min=0.01,
                max=0.99)
            private$..test1_spec <- jmvcore::OptionNumber$new(
                "test1_spec",
                test1_spec,
                default=0.7,
                min=0.01,
                max=0.99)
            private$..test1_cost <- jmvcore::OptionNumber$new(
                "test1_cost",
                test1_cost,
                default=0,
                min=0)
            private$..test2_name <- jmvcore::OptionString$new(
                "test2_name",
                test2_name,
                default="Confirmatory Test")
            private$..test2_sens <- jmvcore::OptionNumber$new(
                "test2_sens",
                test2_sens,
                default=0.8,
                min=0.01,
                max=0.99)
            private$..test2_spec <- jmvcore::OptionNumber$new(
                "test2_spec",
                test2_spec,
                default=0.98,
                min=0.01,
                max=0.99)
            private$..test2_cost <- jmvcore::OptionNumber$new(
                "test2_cost",
                test2_cost,
                default=0,
                min=0)
            private$..strategy <- jmvcore::OptionList$new(
                "strategy",
                strategy,
                options=list(
                    "serial_positive",
                    "serial_negative",
                    "parallel"),
                default="serial_positive")
            private$..prevalence <- jmvcore::OptionNumber$new(
                "prevalence",
                prevalence,
                default=0.1,
                min=0.001,
                max=0.999)
            private$..population_size <- jmvcore::OptionInteger$new(
                "population_size",
                population_size,
                default=1000,
                min=100,
                max=100000)
            private$..show_explanation <- jmvcore::OptionBool$new(
                "show_explanation",
                show_explanation,
                default=FALSE)
            private$..show_formulas <- jmvcore::OptionBool$new(
                "show_formulas",
                show_formulas,
                default=FALSE)
            private$..show_cost_analysis <- jmvcore::OptionBool$new(
                "show_cost_analysis",
                show_cost_analysis,
                default=FALSE)
            private$..show_nomogram <- jmvcore::OptionBool$new(
                "show_nomogram",
                show_nomogram,
                default=FALSE)

            self$.addOption(private$..preset)
            self$.addOption(private$..test1_name)
            self$.addOption(private$..test1_sens)
            self$.addOption(private$..test1_spec)
            self$.addOption(private$..test1_cost)
            self$.addOption(private$..test2_name)
            self$.addOption(private$..test2_sens)
            self$.addOption(private$..test2_spec)
            self$.addOption(private$..test2_cost)
            self$.addOption(private$..strategy)
            self$.addOption(private$..prevalence)
            self$.addOption(private$..population_size)
            self$.addOption(private$..show_explanation)
            self$.addOption(private$..show_formulas)
            self$.addOption(private$..show_cost_analysis)
            self$.addOption(private$..show_nomogram)
        }),
    active = list(
        preset = function() private$..preset$value,
        test1_name = function() private$..test1_name$value,
        test1_sens = function() private$..test1_sens$value,
        test1_spec = function() private$..test1_spec$value,
        test1_cost = function() private$..test1_cost$value,
        test2_name = function() private$..test2_name$value,
        test2_sens = function() private$..test2_sens$value,
        test2_spec = function() private$..test2_spec$value,
        test2_cost = function() private$..test2_cost$value,
        strategy = function() private$..strategy$value,
        prevalence = function() private$..prevalence$value,
        population_size = function() private$..population_size$value,
        show_explanation = function() private$..show_explanation$value,
        show_formulas = function() private$..show_formulas$value,
        show_cost_analysis = function() private$..show_cost_analysis$value,
        show_nomogram = function() private$..show_nomogram$value),
    private = list(
        ..preset = NA,
        ..test1_name = NA,
        ..test1_sens = NA,
        ..test1_spec = NA,
        ..test1_cost = NA,
        ..test2_name = NA,
        ..test2_sens = NA,
        ..test2_spec = NA,
        ..test2_cost = NA,
        ..strategy = NA,
        ..prevalence = NA,
        ..population_size = NA,
        ..show_explanation = NA,
        ..show_formulas = NA,
        ..show_cost_analysis = NA,
        ..show_nomogram = NA)
)

sequentialtestsResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "sequentialtestsResults",
    inherit = jmvcore::Group,
    active = list(
        plain_summary = function() private$.items[["plain_summary"]],
        summary_table = function() private$.items[["summary_table"]],
        individual_tests_table = function() private$.items[["individual_tests_table"]],
        population_flow_table = function() private$.items[["population_flow_table"]],
        cost_analysis_table = function() private$.items[["cost_analysis_table"]],
        explanation_text = function() private$.items[["explanation_text"]],
        formulas_text = function() private$.items[["formulas_text"]],
        plot_flow_diagram = function() private$.items[["plot_flow_diagram"]],
        plot_performance = function() private$.items[["plot_performance"]],
        plot_probability = function() private$.items[["plot_probability"]],
        plot_population_flow = function() private$.items[["plot_population_flow"]],
        plot_sensitivity_analysis = function() private$.items[["plot_sensitivity_analysis"]],
        clinical_guidance = function() private$.items[["clinical_guidance"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Sequential Testing Analysis",
                refs=list(
                    "DiagnosticTests",
                    "Fagan",
                    "Fagan2",
                    "sensspecwiki",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="plain_summary",
                title="Summary (Plain Language)",
                visible="(show_explanation)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="summary_table",
                title="Summary of Testing Strategy",
                rows=1,
                columns=list(
                    list(
                        `name`="strategy_name", 
                        `title`="Testing Strategy", 
                        `type`="text"),
                    list(
                        `name`="prevalence", 
                        `title`="Disease Prevalence", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="first_test", 
                        `title`="First Test", 
                        `type`="text"),
                    list(
                        `name`="second_test", 
                        `title`="Second Test", 
                        `type`="text"),
                    list(
                        `name`="combined_sens", 
                        `title`="Combined Sensitivity", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="combined_spec", 
                        `title`="Combined Specificity", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="combined_ppv", 
                        `title`="Combined PPV", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="combined_npv", 
                        `title`="Combined NPV", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="nnt", 
                        `title`="Number Needed to Screen", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="individual_tests_table",
                title="Individual Test Performance",
                rows=0,
                columns=list(
                    list(
                        `name`="test_name", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="ppv", 
                        `title`="PPV", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="npv", 
                        `title`="NPV", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="plr", 
                        `title`="Positive LR", 
                        `type`="number"),
                    list(
                        `name`="nlr", 
                        `title`="Negative LR", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="population_flow_table",
                title="Population Flow Analysis",
                rows=0,
                columns=list(
                    list(
                        `name`="stage", 
                        `title`="Testing Stage", 
                        `type`="text"),
                    list(
                        `name`="total_n", 
                        `title`="Total Subjects", 
                        `type`="number"),
                    list(
                        `name`="disease_pos", 
                        `title`="Disease Positive", 
                        `type`="number"),
                    list(
                        `name`="disease_neg", 
                        `title`="Disease Negative", 
                        `type`="number"),
                    list(
                        `name`="test_pos", 
                        `title`="Test Positive", 
                        `type`="number"),
                    list(
                        `name`="test_neg", 
                        `title`="Test Negative", 
                        `type`="number"),
                    list(
                        `name`="true_pos", 
                        `title`="True Positives", 
                        `type`="number"),
                    list(
                        `name`="false_pos", 
                        `title`="False Positives", 
                        `type`="number"),
                    list(
                        `name`="false_neg", 
                        `title`="False Negatives", 
                        `type`="number"),
                    list(
                        `name`="true_neg", 
                        `title`="True Negatives", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="cost_analysis_table",
                title="Cost Analysis (Per 1000 Patients)",
                visible="(show_cost_analysis)",
                rows=0,
                columns=list(
                    list(
                        `name`="item", 
                        `title`="Item", 
                        `type`="text"),
                    list(
                        `name`="unit_cost", 
                        `title`="Unit Cost", 
                        `type`="number"),
                    list(
                        `name`="number_tests", 
                        `title`="Number of Tests", 
                        `type`="integer"),
                    list(
                        `name`="total_cost", 
                        `title`="Total Cost", 
                        `type`="number"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="explanation_text",
                title="Explanation",
                visible="(show_explanation)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="formulas_text",
                title="Formulas Used",
                visible="(show_formulas)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot_flow_diagram",
                title="Testing Strategy Flow Diagram",
                width=600,
                height=400,
                renderFun=".plot_flow_diagram",
                visible="(show_nomogram)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot_performance",
                title="Test Performance Comparison",
                width=600,
                height=400,
                renderFun=".plot_performance",
                visible="(show_nomogram)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot_probability",
                title="Probability Transformation",
                width=600,
                height=400,
                renderFun=".plot_probability",
                visible="(show_nomogram)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot_population_flow",
                title="Population Flow Visualization",
                width=600,
                height=400,
                renderFun=".plot_population_flow",
                visible="(show_nomogram)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot_sensitivity_analysis",
                title="Sensitivity Analysis: PPV/NPV vs Prevalence",
                width=600,
                height=400,
                renderFun=".plot_sensitivity_analysis",
                visible="(show_nomogram)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinical_guidance",
                title="Clinical Guidance"))}))

sequentialtestsBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "sequentialtestsBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "sequentialtests",
                version = c(0,0,32),
                options = options,
                results = sequentialtestsResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'na')
        }))

#' Sequential Testing Analysis
#'
#' Analyzes how diagnostic accuracy changes when applying two tests in 
#' sequence,
#' comparing three different testing strategies: serial positive 
#' (confirmation),
#' serial negative (exclusion), and parallel testing. Provides comprehensive
#' analysis including population flow, cost implications, and Fagan nomograms.
#' 
#' This analysis is particularly useful for:
#' • Designing diagnostic protocols and clinical pathways
#' • Optimizing test sequencing for specific clinical contexts
#' • Understanding trade-offs between sensitivity and specificity
#' • Evaluating cost-effectiveness of different testing strategies
#' • Teaching sequential testing concepts and Bayesian probability
#' 
#'
#' @examples
#' # COVID-19 testing: Rapid antigen followed by RT-PCR confirmation
#' # Shows how serial positive strategy improves specificity
#' data(sequential_testing_examples)
#' covid_example <- sequential_testing_examples[
#'   sequential_testing_examples$scenario == "COVID-19 Testing" &
#'   sequential_testing_examples$clinical_setting == "Community screening", ]
#'
#' # Cancer screening: Mammography followed by tissue biopsy
#' # Demonstrates cost-effective screening with definitive diagnosis
#' breast_cancer <- sequential_testing_examples[
#'   sequential_testing_examples$scenario == "Breast Cancer Screening", ]
#'
#' # Emergency medicine: Parallel testing for rapid diagnosis
#' # Shows how parallel strategy maximizes sensitivity
#' emergency_example <- sequential_testing_examples[
#'   sequential_testing_examples$scenario == "Myocardial Infarction Rule-out", ]
#'
#' # Strategy comparison across different prevalence settings
#' data(strategy_comparison)
#'
#' # Cost-effectiveness analysis for resource planning
#' data(cost_effectiveness_examples)
#'
#' # Load example datasets for realistic clinical scenarios
#' data(sequential_testing_examples)  # 15+ clinical scenarios across specialties
#' data(strategy_comparison)          # Strategy performance comparisons
#' data(cost_effectiveness_examples)  # Economic analysis examples
#' data(teaching_examples)            # Educational scenarios
#' data(common_test_combinations)     # Reference test characteristics
#'
#' @param preset Select a clinical preset or use custom values. Presets load
#'   evidence-based test parameters and optimal strategies from medical
#'   literature.
#' @param test1_name .
#' @param test1_sens .
#' @param test1_spec .
#' @param test1_cost .
#' @param test2_name .
#' @param test2_sens .
#' @param test2_spec .
#' @param test2_cost .
#' @param strategy .
#' @param prevalence .
#' @param population_size Population size used to illustrate population flow
#'   counts. Does not affect probabilities.
#' @param show_explanation .
#' @param show_formulas .
#' @param show_cost_analysis .
#' @param show_nomogram .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$plain_summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary_table} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$individual_tests_table} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$population_flow_table} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$cost_analysis_table} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$explanation_text} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$formulas_text} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$plot_flow_diagram} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$plot_performance} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$plot_probability} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$plot_population_flow} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$plot_sensitivity_analysis} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$clinical_guidance} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summary_table$asDF}
#'
#' \code{as.data.frame(results$summary_table)}
#'
#' @export
sequentialtests <- function(
    preset = "custom",
    test1_name = "Screening Test",
    test1_sens = 0.95,
    test1_spec = 0.7,
    test1_cost = 0,
    test2_name = "Confirmatory Test",
    test2_sens = 0.8,
    test2_spec = 0.98,
    test2_cost = 0,
    strategy = "serial_positive",
    prevalence = 0.1,
    population_size = 1000,
    show_explanation = FALSE,
    show_formulas = FALSE,
    show_cost_analysis = FALSE,
    show_nomogram = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("sequentialtests requires jmvcore to be installed (restart may be required)")


    options <- sequentialtestsOptions$new(
        preset = preset,
        test1_name = test1_name,
        test1_sens = test1_sens,
        test1_spec = test1_spec,
        test1_cost = test1_cost,
        test2_name = test2_name,
        test2_sens = test2_sens,
        test2_spec = test2_spec,
        test2_cost = test2_cost,
        strategy = strategy,
        prevalence = prevalence,
        population_size = population_size,
        show_explanation = show_explanation,
        show_formulas = show_formulas,
        show_cost_analysis = show_cost_analysis,
        show_nomogram = show_nomogram)

    analysis <- sequentialtestsClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

