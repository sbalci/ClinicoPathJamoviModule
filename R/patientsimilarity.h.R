
# This file is automatically generated, you probably don't want to edit this

patientsimilarityOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "patientsimilarityOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            vars = NULL,
            method = "tsne",
            dimensions = "2",
            colorBy = NULL,
            perplexity = 30,
            iterations = 1000,
            umapNeighbors = 15,
            umapMinDist = 0.1,
            performClustering = FALSE,
            clusterMethod = "kmeans",
            nClusters = 3,
            showClusterStats = TRUE,
            survivalAnalysis = FALSE,
            survivalTime = NULL,
            survivalEvent = NULL,
            survivalEventLevel = NULL,
            scaleVars = TRUE,
            removeOutliers = FALSE,
            showLoadings = FALSE,
            show3DPlot = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="patientsimilarity",
                requiresData=TRUE,
                ...)

            private$..vars <- jmvcore::OptionVariables$new(
                "vars",
                vars,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..method <- jmvcore::OptionList$new(
                "method",
                method,
                options=list(
                    "pca",
                    "tsne",
                    "umap",
                    "mds"),
                default="tsne")
            private$..dimensions <- jmvcore::OptionList$new(
                "dimensions",
                dimensions,
                options=list(
                    "2",
                    "3"),
                default="2")
            private$..colorBy <- jmvcore::OptionVariable$new(
                "colorBy",
                colorBy,
                suggested=list(
                    "nominal",
                    "ordinal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..perplexity <- jmvcore::OptionNumber$new(
                "perplexity",
                perplexity,
                default=30,
                min=5,
                max=100)
            private$..iterations <- jmvcore::OptionInteger$new(
                "iterations",
                iterations,
                default=1000,
                min=250,
                max=5000)
            private$..umapNeighbors <- jmvcore::OptionInteger$new(
                "umapNeighbors",
                umapNeighbors,
                default=15,
                min=2,
                max=100)
            private$..umapMinDist <- jmvcore::OptionNumber$new(
                "umapMinDist",
                umapMinDist,
                default=0.1,
                min=0.001,
                max=0.99)
            private$..performClustering <- jmvcore::OptionBool$new(
                "performClustering",
                performClustering,
                default=FALSE)
            private$..clusterMethod <- jmvcore::OptionList$new(
                "clusterMethod",
                clusterMethod,
                options=list(
                    "kmeans",
                    "hclust",
                    "dbscan"),
                default="kmeans")
            private$..nClusters <- jmvcore::OptionInteger$new(
                "nClusters",
                nClusters,
                default=3,
                min=2,
                max=10)
            private$..showClusterStats <- jmvcore::OptionBool$new(
                "showClusterStats",
                showClusterStats,
                default=TRUE)
            private$..survivalAnalysis <- jmvcore::OptionBool$new(
                "survivalAnalysis",
                survivalAnalysis,
                default=FALSE)
            private$..survivalTime <- jmvcore::OptionVariable$new(
                "survivalTime",
                survivalTime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..survivalEvent <- jmvcore::OptionVariable$new(
                "survivalEvent",
                survivalEvent,
                suggested=list(
                    "nominal",
                    "ordinal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..survivalEventLevel <- jmvcore::OptionLevel$new(
                "survivalEventLevel",
                survivalEventLevel,
                variable="(survivalEvent)")
            private$..scaleVars <- jmvcore::OptionBool$new(
                "scaleVars",
                scaleVars,
                default=TRUE)
            private$..removeOutliers <- jmvcore::OptionBool$new(
                "removeOutliers",
                removeOutliers,
                default=FALSE)
            private$..showLoadings <- jmvcore::OptionBool$new(
                "showLoadings",
                showLoadings,
                default=FALSE)
            private$..show3DPlot <- jmvcore::OptionBool$new(
                "show3DPlot",
                show3DPlot,
                default=FALSE)
            private$..exportClusters <- jmvcore::OptionOutput$new(
                "exportClusters")
            private$..exportCoordinates <- jmvcore::OptionOutput$new(
                "exportCoordinates")

            self$.addOption(private$..vars)
            self$.addOption(private$..method)
            self$.addOption(private$..dimensions)
            self$.addOption(private$..colorBy)
            self$.addOption(private$..perplexity)
            self$.addOption(private$..iterations)
            self$.addOption(private$..umapNeighbors)
            self$.addOption(private$..umapMinDist)
            self$.addOption(private$..performClustering)
            self$.addOption(private$..clusterMethod)
            self$.addOption(private$..nClusters)
            self$.addOption(private$..showClusterStats)
            self$.addOption(private$..survivalAnalysis)
            self$.addOption(private$..survivalTime)
            self$.addOption(private$..survivalEvent)
            self$.addOption(private$..survivalEventLevel)
            self$.addOption(private$..scaleVars)
            self$.addOption(private$..removeOutliers)
            self$.addOption(private$..showLoadings)
            self$.addOption(private$..show3DPlot)
            self$.addOption(private$..exportClusters)
            self$.addOption(private$..exportCoordinates)
        }),
    active = list(
        vars = function() private$..vars$value,
        method = function() private$..method$value,
        dimensions = function() private$..dimensions$value,
        colorBy = function() private$..colorBy$value,
        perplexity = function() private$..perplexity$value,
        iterations = function() private$..iterations$value,
        umapNeighbors = function() private$..umapNeighbors$value,
        umapMinDist = function() private$..umapMinDist$value,
        performClustering = function() private$..performClustering$value,
        clusterMethod = function() private$..clusterMethod$value,
        nClusters = function() private$..nClusters$value,
        showClusterStats = function() private$..showClusterStats$value,
        survivalAnalysis = function() private$..survivalAnalysis$value,
        survivalTime = function() private$..survivalTime$value,
        survivalEvent = function() private$..survivalEvent$value,
        survivalEventLevel = function() private$..survivalEventLevel$value,
        scaleVars = function() private$..scaleVars$value,
        removeOutliers = function() private$..removeOutliers$value,
        showLoadings = function() private$..showLoadings$value,
        show3DPlot = function() private$..show3DPlot$value,
        exportClusters = function() private$..exportClusters$value,
        exportCoordinates = function() private$..exportCoordinates$value),
    private = list(
        ..vars = NA,
        ..method = NA,
        ..dimensions = NA,
        ..colorBy = NA,
        ..perplexity = NA,
        ..iterations = NA,
        ..umapNeighbors = NA,
        ..umapMinDist = NA,
        ..performClustering = NA,
        ..clusterMethod = NA,
        ..nClusters = NA,
        ..showClusterStats = NA,
        ..survivalAnalysis = NA,
        ..survivalTime = NA,
        ..survivalEvent = NA,
        ..survivalEventLevel = NA,
        ..scaleVars = NA,
        ..removeOutliers = NA,
        ..showLoadings = NA,
        ..show3DPlot = NA,
        ..exportClusters = NA,
        ..exportCoordinates = NA)
)

patientsimilarityResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "patientsimilarityResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        summaryText = function() private$.items[["summaryText"]],
        projectionPlot = function() private$.items[["projectionPlot"]],
        projection3D = function() private$.items[["projection3D"]],
        varianceTable = function() private$.items[["varianceTable"]],
        loadingsTable = function() private$.items[["loadingsTable"]],
        clusterHeading = function() private$.items[["clusterHeading"]],
        clusterSummary = function() private$.items[["clusterSummary"]],
        clusterCharacteristics = function() private$.items[["clusterCharacteristics"]],
        clusterOutcomes = function() private$.items[["clusterOutcomes"]],
        clusterQuality = function() private$.items[["clusterQuality"]],
        survivalHeading = function() private$.items[["survivalHeading"]],
        survivalTable = function() private$.items[["survivalTable"]],
        survivalPlot = function() private$.items[["survivalPlot"]],
        survivalComparison = function() private$.items[["survivalComparison"]],
        exportClusters = function() private$.items[["exportClusters"]],
        exportCoordinates = function() private$.items[["exportCoordinates"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Patient Similarity Clustering",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "Rtsne",
                    "umap",
                    "survival",
                    "urvminer",
                    "dbscan",
                    "cluster",
                    "survival",
                    "plotly",
                    "survminer"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible="(vars)",
                refs=list(
                    "ClinicoPathJamoviModule")))
            self$add(jmvcore::Preformatted$new(
                options=options,
                name="summaryText",
                title="Analysis Summary",
                visible=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="projectionPlot",
                title="",
                width=700,
                height=600,
                renderFun=".projectionPlot",
                visible=TRUE,
                requiresData=TRUE,
                clearWith=list(
                    "vars",
                    "method",
                    "dimensions",
                    "colorBy")))
            self$add(jmvcore::Image$new(
                options=options,
                name="projection3D",
                title="Interactive 3D Projection",
                width=800,
                height=700,
                renderFun=".projection3D",
                visible="(show3DPlot)",
                requiresData=TRUE,
                clearWith=list(
                    "vars",
                    "method",
                    "dimensions")))
            self$add(jmvcore::Table$new(
                options=options,
                name="varianceTable",
                title="Variance Explained",
                visible="(method:pca)",
                rows=0,
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="variance", 
                        `title`="Variance", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cumulative", 
                        `title`="Cumulative", 
                        `type`="number", 
                        `format`="pc"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="loadingsTable",
                title="Variable Loadings",
                visible="(showLoadings)",
                rows=0,
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="dim1", 
                        `title`="Dim 1", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="dim2", 
                        `title`="Dim 2", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="dim3", 
                        `title`="Dim 3", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(dimensions:3)"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="clusterHeading",
                title="Cluster Analysis Results",
                visible="(performClustering)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="clusterSummary",
                title="Cluster Summary",
                visible="(performClustering)",
                rows=0,
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="percentage", 
                        `title`="%", 
                        `type`="number", 
                        `format`="pc"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="clusterCharacteristics",
                title="Cluster Characteristics (Mean Values)",
                visible="(performClustering && showClusterStats)",
                rows=0,
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="clusterOutcomes",
                title="Outcome Distribution by Cluster",
                visible="(performClustering)",
                rows=0,
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="outcome_summary", 
                        `title`="", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="clusterQuality",
                title="Cluster Quality Metrics",
                visible="(performClustering)",
                rows=1,
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="survivalHeading",
                title="Survival Analysis by Cluster",
                visible="(survivalAnalysis)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="survivalTable",
                title="Survival Summary by Cluster",
                visible="(survivalAnalysis)",
                rows=0,
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="median_survival", 
                        `title`="Median Survival", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlot",
                title="Kaplan-Meier Curves by Cluster",
                width=650,
                height=500,
                renderFun=".survivalPlot",
                visible="(survivalAnalysis)",
                requiresData=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="survivalComparison",
                title="Log-Rank Test",
                visible="(survivalAnalysis)",
                rows=1,
                columns=list(
                    list(
                        `name`="chisq", 
                        `title`="Chi-square", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="pvalue", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Output$new(
                options=options,
                name="exportClusters",
                title="Cluster Assignments",
                varTitle="`Cluster`",
                varDescription="Patient cluster assignments from similarity analysis",
                clearWith=list(
                    "vars",
                    "method",
                    "performClustering")))
            self$add(jmvcore::Output$new(
                options=options,
                name="exportCoordinates",
                title="Projection Coordinates",
                varTitle="`Coord`",
                varDescription="Projection coordinates (2D or 3D)",
                clearWith=list(
                    "vars",
                    "method",
                    "dimensions")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Interpretation Guide",
                visible=TRUE,
                refs=list(
                    "ClinicoPathJamoviModule")))}))

patientsimilarityBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "patientsimilarityBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "patientsimilarity",
                version = c(0,0,31),
                options = options,
                results = patientsimilarityResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'none')
        }))

#' Patient Similarity Clustering
#'
#' Visualizes patient similarity using dimensionality reduction techniques 
#' (PCA, t-SNE, UMAP, MDS). Projects high-dimensional patient data into 2D or 
#' 3D space to reveal natural patient groupings and subpopulations. Inspired 
#' by Orange Data Mining's interactive projection widgets, adapted for jamovi 
#' with comprehensive cluster analysis and statistical validation.
#'
#' @examples
#' # Example 1: Basic t-SNE visualization
#' library(Rtsne)
#' data(iris)
#'
#' patientsimilarity(
#'     data = iris,
#'     vars = c("Sepal.Length", "Sepal.Width", "Petal.Length", "Petal.Width"),
#'     method = "tsne",
#'     colorBy = "Species"
#' )
#'
#' # Example 2: UMAP with cluster analysis
#' patientsimilarity(
#'     data = clinical_data,
#'     vars = c("age", "tumor_size", "grade", "ki67"),
#'     method = "umap",
#'     colorBy = "survival_status",
#'     performClustering = TRUE,
#'     nClusters = 3,
#'     showClusterStats = TRUE
#' )
#'
#' # Example 3: PCA with survival comparison
#' patientsimilarity(
#'     data = pathology_data,
#'     vars = c("age", "stage", "nodes", "size"),
#'     method = "pca",
#'     colorBy = "death",
#'     dimensions = 3,
#'     survivalTime = "months",
#'     survivalEvent = "death"
#' )
#'
#' @param data The dataset to be analyzed, provided as a data frame.
#' @param vars Continuous variables to use for calculating patient similarity.
#'   These will be used to compute distances between patients. Categorical
#'   variables should be converted to numeric or one-hot encoded.
#' @param method Method for dimensionality reduction: - PCA: Linear method,
#'   preserves global structure - t-SNE: Non-linear, excellent for
#'   visualization, preserves local structure - UMAP: Non-linear, preserves both
#'   local and global structure, faster than t-SNE - MDS: Classical method,
#'   preserves pairwise distances
#' @param dimensions Number of dimensions for projection. 2D is easier to
#'   interpret, 3D can reveal additional structure.
#' @param colorBy Variable to use for coloring points. Typically an outcome
#'   variable (e.g., disease status, survival, response) to see if it
#'   corresponds to natural patient groupings.
#' @param perplexity Perplexity parameter for t-SNE. Roughly corresponds to
#'   the number of nearest neighbors considered. Typical values: 5-50. Higher
#'   values preserve more global structure.
#' @param iterations Number of iterations for t-SNE optimization. More
#'   iterations improve convergence but take longer.
#' @param umapNeighbors Number of nearest neighbors for UMAP. Controls local
#'   vs global structure. Smaller values preserve local structure, larger values
#'   preserve global.
#' @param umapMinDist Minimum distance between points in UMAP. Controls how
#'   tightly points are packed. Smaller values create tighter clusters.
#' @param performClustering Automatically identify patient clusters using
#'   k-means or hierarchical clustering on the reduced-dimension space.
#' @param clusterMethod Method for clustering patients in the reduced space.
#' @param nClusters Number of clusters for k-means or hierarchical clustering.
#'   For DBSCAN, this is ignored.
#' @param showClusterStats Display summary statistics for each cluster
#'   including size, characteristics, and outcome distribution.
#' @param survivalAnalysis If survival data is available, compare survival
#'   across discovered clusters. Useful for identifying prognostic patient
#'   subtypes.
#' @param survivalTime Time to event or censoring for survival analysis.
#' @param survivalEvent Event indicator (1=event, 0=censored).
#' @param survivalEventLevel Level indicating the event occurred.
#' @param scaleVars Standardize variables to mean=0, sd=1 before analysis.
#'   Recommended when variables have different scales.
#' @param removeOutliers Remove outliers before analysis using IQR method. May
#'   improve visualization quality.
#' @param showLoadings Show how original variables contribute to each
#'   dimension. Only available for PCA and MDS.
#' @param show3DPlot Generate interactive 3D plot using plotly (if
#'   dimensions=3).
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summaryText} \tab \tab \tab \tab \tab a preformatted \cr
#'   \code{results$projectionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$projection3D} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$varianceTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$loadingsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clusterHeading} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$clusterSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clusterCharacteristics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clusterOutcomes} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clusterQuality} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$survivalHeading} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$survivalTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$survivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$survivalComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$exportClusters} \tab \tab \tab \tab \tab an output \cr
#'   \code{results$exportCoordinates} \tab \tab \tab \tab \tab an output \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$varianceTable$asDF}
#'
#' \code{as.data.frame(results$varianceTable)}
#'
#' @export
patientsimilarity <- function(
    data,
    vars = NULL,
    method = "tsne",
    dimensions = "2",
    colorBy = NULL,
    perplexity = 30,
    iterations = 1000,
    umapNeighbors = 15,
    umapMinDist = 0.1,
    performClustering = FALSE,
    clusterMethod = "kmeans",
    nClusters = 3,
    showClusterStats = TRUE,
    survivalAnalysis = FALSE,
    survivalTime = NULL,
    survivalEvent = NULL,
    survivalEventLevel,
    scaleVars = TRUE,
    removeOutliers = FALSE,
    showLoadings = FALSE,
    show3DPlot = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("patientsimilarity requires jmvcore to be installed (restart may be required)")

    if ( ! missing(vars)) vars <- jmvcore::resolveQuo(jmvcore::enquo(vars))
    if ( ! missing(colorBy)) colorBy <- jmvcore::resolveQuo(jmvcore::enquo(colorBy))
    if ( ! missing(survivalTime)) survivalTime <- jmvcore::resolveQuo(jmvcore::enquo(survivalTime))
    if ( ! missing(survivalEvent)) survivalEvent <- jmvcore::resolveQuo(jmvcore::enquo(survivalEvent))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(vars), vars, NULL),
            `if`( ! missing(colorBy), colorBy, NULL),
            `if`( ! missing(survivalTime), survivalTime, NULL),
            `if`( ! missing(survivalEvent), survivalEvent, NULL))


    options <- patientsimilarityOptions$new(
        vars = vars,
        method = method,
        dimensions = dimensions,
        colorBy = colorBy,
        perplexity = perplexity,
        iterations = iterations,
        umapNeighbors = umapNeighbors,
        umapMinDist = umapMinDist,
        performClustering = performClustering,
        clusterMethod = clusterMethod,
        nClusters = nClusters,
        showClusterStats = showClusterStats,
        survivalAnalysis = survivalAnalysis,
        survivalTime = survivalTime,
        survivalEvent = survivalEvent,
        survivalEventLevel = survivalEventLevel,
        scaleVars = scaleVars,
        removeOutliers = removeOutliers,
        showLoadings = showLoadings,
        show3DPlot = show3DPlot)

    analysis <- patientsimilarityClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

