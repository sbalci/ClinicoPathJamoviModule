
# This file is automatically generated, you probably don't want to edit this

markovmultistateOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "markovmultistateOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            event = NULL,
            subject = NULL,
            covs = NULL,
            modelType = "homogeneous",
            transitionMatrix = "progressive",
            baselineHazard = "exponential",
            estimationMethod = "ml",
            timeUnits = "auto",
            predictionTimes = "1, 3, 5",
            transitionTimes = "0.5, 1, 2, 3, 5",
            conf = 0.95,
            maxIterations = 1000,
            tolerance = 0.000001,
            showTransitionIntensities = TRUE,
            showTransitionProbs = TRUE,
            showStateProbabilities = TRUE,
            showMeanSojournTimes = TRUE,
            showExpectedRewards = FALSE,
            showModelFit = TRUE,
            showPredictions = TRUE,
            showEducational = TRUE,
            plotStateProbs = TRUE,
            plotTransitionProbs = FALSE,
            plotHazardRatios = FALSE,
            plotModelDiagnostics = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="markovmultistate",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event <- jmvcore::OptionVariable$new(
                "event",
                event,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..subject <- jmvcore::OptionVariable$new(
                "subject",
                subject,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..covs <- jmvcore::OptionVariables$new(
                "covs",
                covs,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..modelType <- jmvcore::OptionList$new(
                "modelType",
                modelType,
                options=list(
                    "homogeneous",
                    "nonhomogeneous",
                    "semimarkov",
                    "cox",
                    "illnessdeath",
                    "progressive"),
                default="homogeneous")
            private$..transitionMatrix <- jmvcore::OptionList$new(
                "transitionMatrix",
                transitionMatrix,
                options=list(
                    "reversible",
                    "progressive",
                    "illnessdeath",
                    "competing",
                    "custom"),
                default="progressive")
            private$..baselineHazard <- jmvcore::OptionList$new(
                "baselineHazard",
                baselineHazard,
                options=list(
                    "exponential",
                    "weibull",
                    "piecewise",
                    "splines",
                    "semiparametric"),
                default="exponential")
            private$..estimationMethod <- jmvcore::OptionList$new(
                "estimationMethod",
                estimationMethod,
                options=list(
                    "ml",
                    "pl",
                    "em",
                    "bayesian"),
                default="ml")
            private$..timeUnits <- jmvcore::OptionList$new(
                "timeUnits",
                timeUnits,
                options=list(
                    "days",
                    "months",
                    "years",
                    "auto"),
                default="auto")
            private$..predictionTimes <- jmvcore::OptionString$new(
                "predictionTimes",
                predictionTimes,
                default="1, 3, 5")
            private$..transitionTimes <- jmvcore::OptionString$new(
                "transitionTimes",
                transitionTimes,
                default="0.5, 1, 2, 3, 5")
            private$..conf <- jmvcore::OptionNumber$new(
                "conf",
                conf,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..maxIterations <- jmvcore::OptionNumber$new(
                "maxIterations",
                maxIterations,
                min=100,
                max=10000,
                default=1000)
            private$..tolerance <- jmvcore::OptionNumber$new(
                "tolerance",
                tolerance,
                min=1e-8,
                max=0.001,
                default=0.000001)
            private$..showTransitionIntensities <- jmvcore::OptionBool$new(
                "showTransitionIntensities",
                showTransitionIntensities,
                default=TRUE)
            private$..showTransitionProbs <- jmvcore::OptionBool$new(
                "showTransitionProbs",
                showTransitionProbs,
                default=TRUE)
            private$..showStateProbabilities <- jmvcore::OptionBool$new(
                "showStateProbabilities",
                showStateProbabilities,
                default=TRUE)
            private$..showMeanSojournTimes <- jmvcore::OptionBool$new(
                "showMeanSojournTimes",
                showMeanSojournTimes,
                default=TRUE)
            private$..showExpectedRewards <- jmvcore::OptionBool$new(
                "showExpectedRewards",
                showExpectedRewards,
                default=FALSE)
            private$..showModelFit <- jmvcore::OptionBool$new(
                "showModelFit",
                showModelFit,
                default=TRUE)
            private$..showPredictions <- jmvcore::OptionBool$new(
                "showPredictions",
                showPredictions,
                default=TRUE)
            private$..showEducational <- jmvcore::OptionBool$new(
                "showEducational",
                showEducational,
                default=TRUE)
            private$..plotStateProbs <- jmvcore::OptionBool$new(
                "plotStateProbs",
                plotStateProbs,
                default=TRUE)
            private$..plotTransitionProbs <- jmvcore::OptionBool$new(
                "plotTransitionProbs",
                plotTransitionProbs,
                default=FALSE)
            private$..plotHazardRatios <- jmvcore::OptionBool$new(
                "plotHazardRatios",
                plotHazardRatios,
                default=FALSE)
            private$..plotModelDiagnostics <- jmvcore::OptionBool$new(
                "plotModelDiagnostics",
                plotModelDiagnostics,
                default=FALSE)

            self$.addOption(private$..time)
            self$.addOption(private$..event)
            self$.addOption(private$..subject)
            self$.addOption(private$..covs)
            self$.addOption(private$..modelType)
            self$.addOption(private$..transitionMatrix)
            self$.addOption(private$..baselineHazard)
            self$.addOption(private$..estimationMethod)
            self$.addOption(private$..timeUnits)
            self$.addOption(private$..predictionTimes)
            self$.addOption(private$..transitionTimes)
            self$.addOption(private$..conf)
            self$.addOption(private$..maxIterations)
            self$.addOption(private$..tolerance)
            self$.addOption(private$..showTransitionIntensities)
            self$.addOption(private$..showTransitionProbs)
            self$.addOption(private$..showStateProbabilities)
            self$.addOption(private$..showMeanSojournTimes)
            self$.addOption(private$..showExpectedRewards)
            self$.addOption(private$..showModelFit)
            self$.addOption(private$..showPredictions)
            self$.addOption(private$..showEducational)
            self$.addOption(private$..plotStateProbs)
            self$.addOption(private$..plotTransitionProbs)
            self$.addOption(private$..plotHazardRatios)
            self$.addOption(private$..plotModelDiagnostics)
        }),
    active = list(
        time = function() private$..time$value,
        event = function() private$..event$value,
        subject = function() private$..subject$value,
        covs = function() private$..covs$value,
        modelType = function() private$..modelType$value,
        transitionMatrix = function() private$..transitionMatrix$value,
        baselineHazard = function() private$..baselineHazard$value,
        estimationMethod = function() private$..estimationMethod$value,
        timeUnits = function() private$..timeUnits$value,
        predictionTimes = function() private$..predictionTimes$value,
        transitionTimes = function() private$..transitionTimes$value,
        conf = function() private$..conf$value,
        maxIterations = function() private$..maxIterations$value,
        tolerance = function() private$..tolerance$value,
        showTransitionIntensities = function() private$..showTransitionIntensities$value,
        showTransitionProbs = function() private$..showTransitionProbs$value,
        showStateProbabilities = function() private$..showStateProbabilities$value,
        showMeanSojournTimes = function() private$..showMeanSojournTimes$value,
        showExpectedRewards = function() private$..showExpectedRewards$value,
        showModelFit = function() private$..showModelFit$value,
        showPredictions = function() private$..showPredictions$value,
        showEducational = function() private$..showEducational$value,
        plotStateProbs = function() private$..plotStateProbs$value,
        plotTransitionProbs = function() private$..plotTransitionProbs$value,
        plotHazardRatios = function() private$..plotHazardRatios$value,
        plotModelDiagnostics = function() private$..plotModelDiagnostics$value),
    private = list(
        ..time = NA,
        ..event = NA,
        ..subject = NA,
        ..covs = NA,
        ..modelType = NA,
        ..transitionMatrix = NA,
        ..baselineHazard = NA,
        ..estimationMethod = NA,
        ..timeUnits = NA,
        ..predictionTimes = NA,
        ..transitionTimes = NA,
        ..conf = NA,
        ..maxIterations = NA,
        ..tolerance = NA,
        ..showTransitionIntensities = NA,
        ..showTransitionProbs = NA,
        ..showStateProbabilities = NA,
        ..showMeanSojournTimes = NA,
        ..showExpectedRewards = NA,
        ..showModelFit = NA,
        ..showPredictions = NA,
        ..showEducational = NA,
        ..plotStateProbs = NA,
        ..plotTransitionProbs = NA,
        ..plotHazardRatios = NA,
        ..plotModelDiagnostics = NA)
)

markovmultistateResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "markovmultistateResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        educationalInfo = function() private$.items[["educationalInfo"]],
        modelSummary = function() private$.items[["modelSummary"]],
        transitionIntensities = function() private$.items[["transitionIntensities"]],
        transitionProbabilities = function() private$.items[["transitionProbabilities"]],
        stateProbabilities = function() private$.items[["stateProbabilities"]],
        meanSojournTimes = function() private$.items[["meanSojournTimes"]],
        covariateEffects = function() private$.items[["covariateEffects"]],
        modelFitStatistics = function() private$.items[["modelFitStatistics"]],
        predictionsTable = function() private$.items[["predictionsTable"]],
        methodsInfo = function() private$.items[["methodsInfo"]],
        interpretationGuide = function() private$.items[["interpretationGuide"]],
        stateTransitionDiagram = function() private$.items[["stateTransitionDiagram"]],
        stateProbabilityPlot = function() private$.items[["stateProbabilityPlot"]],
        transitionProbabilityPlot = function() private$.items[["transitionProbabilityPlot"]],
        hazardRatioPlot = function() private$.items[["hazardRatioPlot"]],
        diagnosticsPlot = function() private$.items[["diagnosticsPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Markov Multi-State Models",
                refs=list(
                    "mstate",
                    "msm",
                    "survival",
                    "diagram",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="To Do",
                clearWith=list(
                    "time",
                    "event",
                    "subject")))
            self$add(jmvcore::Html$new(
                options=options,
                name="educationalInfo",
                title="Multi-State Models Guide",
                visible="(showEducational)",
                clearWith=list(
                    "modelType",
                    "transitionMatrix")))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                rows=1,
                columns=list(
                    list(
                        `name`="model_type", 
                        `title`="Model Type", 
                        `type`="text"),
                    list(
                        `name`="n_states", 
                        `title`="States", 
                        `type`="number"),
                    list(
                        `name`="n_subjects", 
                        `title`="Subjects", 
                        `type`="number"),
                    list(
                        `name`="n_transitions", 
                        `title`="Transitions", 
                        `type`="number"),
                    list(
                        `name`="loglik", 
                        `title`="Log-likelihood", 
                        `type`="number"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number"),
                    list(
                        `name`="convergence", 
                        `title`="Convergence", 
                        `type`="text")),
                clearWith=list(
                    "time",
                    "event",
                    "subject",
                    "modelType")))
            self$add(jmvcore::Table$new(
                options=options,
                name="transitionIntensities",
                title="Transition Intensities (Q-matrix)",
                visible="(showTransitionIntensities)",
                columns=list(
                    list(
                        `name`="from_state", 
                        `title`="From State", 
                        `type`="text"),
                    list(
                        `name`="to_state", 
                        `title`="To State", 
                        `type`="text"),
                    list(
                        `name`="intensity", 
                        `title`="Intensity", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="pvalue", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Rate", 
                        `type`="text")),
                clearWith=list(
                    "modelType",
                    "baselineHazard")))
            self$add(jmvcore::Table$new(
                options=options,
                name="transitionProbabilities",
                title="Transition Probabilities",
                visible="(showTransitionProbs)",
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="from_state", 
                        `title`="From", 
                        `type`="text"),
                    list(
                        `name`="to_state", 
                        `title`="To", 
                        `type`="text"),
                    list(
                        `name`="probability", 
                        `title`="P(transition)", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="risk_level", 
                        `title`="Risk", 
                        `type`="text")),
                clearWith=list(
                    "transitionTimes",
                    "modelType")))
            self$add(jmvcore::Table$new(
                options=options,
                name="stateProbabilities",
                title="State Occupation Probabilities",
                visible="(showStateProbabilities)",
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="state", 
                        `title`="State", 
                        `type`="text"),
                    list(
                        `name`="probability", 
                        `title`="P(state)", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="prevalent_cases", 
                        `title`="Expected N", 
                        `type`="number")),
                clearWith=list(
                    "predictionTimes",
                    "modelType")))
            self$add(jmvcore::Table$new(
                options=options,
                name="meanSojournTimes",
                title="Mean Sojourn Times",
                visible="(showMeanSojournTimes)",
                columns=list(
                    list(
                        `name`="state", 
                        `title`="State", 
                        `type`="text"),
                    list(
                        `name`="mean_time", 
                        `title`="Mean Time", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="median_time", 
                        `title`="Median Time", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Duration", 
                        `type`="text")),
                clearWith=list(
                    "modelType",
                    "timeUnits")))
            self$add(jmvcore::Table$new(
                options=options,
                name="covariateEffects",
                title="Covariate Effects on Transitions",
                visible="(covs)",
                columns=list(
                    list(
                        `name`="transition", 
                        `title`="Transition", 
                        `type`="text"),
                    list(
                        `name`="covariate", 
                        `title`="Covariate", 
                        `type`="text"),
                    list(
                        `name`="coefficient", 
                        `title`="Coefficient", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="hazard_ratio", 
                        `title`="HR", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="pvalue", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Effect", 
                        `type`="text")),
                clearWith=list(
                    "covs",
                    "modelType")))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelFitStatistics",
                title="Model Fit and Diagnostics",
                visible="(showModelFit)",
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="number"),
                    list(
                        `name`="pvalue", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Assessment", 
                        `type`="text")),
                clearWith=list(
                    "modelType",
                    "estimationMethod")))
            self$add(jmvcore::Table$new(
                options=options,
                name="predictionsTable",
                title="Individual Predictions",
                visible="(showPredictions)",
                columns=list(
                    list(
                        `name`="subject_id", 
                        `title`="Subject", 
                        `type`="text"),
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="current_state", 
                        `title`="Current State", 
                        `type`="text"),
                    list(
                        `name`="most_likely_state", 
                        `title`="Predicted State", 
                        `type`="text"),
                    list(
                        `name`="probability", 
                        `title`="Probability", 
                        `type`="number"),
                    list(
                        `name`="confidence_interval", 
                        `title`="95% CI", 
                        `type`="text"),
                    list(
                        `name`="risk_category", 
                        `title`="Risk", 
                        `type`="text")),
                clearWith=list(
                    "predictionTimes",
                    "subject")))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodsInfo",
                title="Statistical Methods",
                clearWith=list(
                    "modelType",
                    "estimationMethod")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretationGuide",
                title="Clinical Interpretation Guide",
                clearWith=list(
                    "modelType",
                    "transitionMatrix")))
            self$add(jmvcore::Image$new(
                options=options,
                name="stateTransitionDiagram",
                title="State Transition Diagram",
                width=800,
                height=600,
                renderFun=".stateTransitionDiagram",
                requiresData=TRUE,
                clearWith=list(
                    "transitionMatrix",
                    "modelType")))
            self$add(jmvcore::Image$new(
                options=options,
                name="stateProbabilityPlot",
                title="State Occupation Probabilities",
                width=800,
                height=600,
                renderFun=".stateProbabilityPlot",
                visible="(plotStateProbs)",
                requiresData=TRUE,
                clearWith=list(
                    "time",
                    "event",
                    "modelType")))
            self$add(jmvcore::Image$new(
                options=options,
                name="transitionProbabilityPlot",
                title="Transition Probability Matrix",
                width=700,
                height=700,
                renderFun=".transitionProbabilityPlot",
                visible="(plotTransitionProbs)",
                requiresData=TRUE,
                clearWith=list(
                    "transitionTimes",
                    "modelType")))
            self$add(jmvcore::Image$new(
                options=options,
                name="hazardRatioPlot",
                title="Covariate Hazard Ratios",
                width=700,
                height=500,
                renderFun=".hazardRatioPlot",
                visible="(plotHazardRatios)",
                requiresData=TRUE,
                clearWith=list(
                    "covs",
                    "modelType")))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagnosticsPlot",
                title="Model Diagnostics",
                width=800,
                height=600,
                renderFun=".diagnosticsPlot",
                visible="(plotModelDiagnostics)",
                requiresData=TRUE,
                clearWith=list(
                    "modelType",
                    "estimationMethod")))}))

markovmultistateBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "markovmultistateBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "markovmultistate",
                version = c(0,0,1),
                options = options,
                results = markovmultistateResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Markov Multi-State Models
#'
#' Fits Markov multi-state models for analyzing transitions between different 
#' health states over time. Supports homogeneous and non-homogeneous models 
#' with covariate effects using mstate and msm packages.
#' 
#'
#' @examples
#' \donttest{
#' # example will be added
#'}
#' @param data The data as a data frame.
#' @param time Follow-up time variable
#' @param event Event/state variable indicating transitions between states
#' @param subject Subject identifier for longitudinal tracking
#' @param covs Covariates affecting transition intensities
#' @param modelType Type of multi-state model to fit
#' @param transitionMatrix Structure of allowed transitions between states
#' @param baselineHazard Baseline hazard function specification
#' @param estimationMethod Method for parameter estimation
#' @param timeUnits Time scale for analysis and reporting
#' @param predictionTimes Comma-separated list of time points for state
#'   predictions
#' @param transitionTimes Time points for transition probability estimation
#' @param conf Confidence level for confidence intervals
#' @param maxIterations Maximum iterations for model fitting
#' @param tolerance Convergence tolerance for optimization
#' @param showTransitionIntensities Display estimated transition intensity
#'   matrix
#' @param showTransitionProbs Display transition probability matrices at
#'   specified times
#' @param showStateProbabilities Display state occupation probabilities over
#'   time
#' @param showMeanSojournTimes Display expected time spent in each state
#' @param showExpectedRewards Display expected rewards/utilities for health
#'   economics
#' @param showModelFit Display model fit statistics and diagnostics
#' @param showPredictions Display individual and population-level predictions
#' @param showEducational Display educational information about multi-state
#'   models
#' @param plotStateProbs Display state probability plots over time
#' @param plotTransitionProbs Display transition probability heatmaps
#' @param plotHazardRatios Display hazard ratio plots for covariates
#' @param plotModelDiagnostics Display model diagnostic plots and residuals
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$educationalInfo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$transitionIntensities} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$transitionProbabilities} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$stateProbabilities} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$meanSojournTimes} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$covariateEffects} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelFitStatistics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$predictionsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$methodsInfo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$interpretationGuide} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$stateTransitionDiagram} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$stateProbabilityPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$transitionProbabilityPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$hazardRatioPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$diagnosticsPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelSummary$asDF}
#'
#' \code{as.data.frame(results$modelSummary)}
#'
#' @export
markovmultistate <- function(
    data,
    time,
    event,
    subject,
    covs,
    modelType = "homogeneous",
    transitionMatrix = "progressive",
    baselineHazard = "exponential",
    estimationMethod = "ml",
    timeUnits = "auto",
    predictionTimes = "1, 3, 5",
    transitionTimes = "0.5, 1, 2, 3, 5",
    conf = 0.95,
    maxIterations = 1000,
    tolerance = 0.000001,
    showTransitionIntensities = TRUE,
    showTransitionProbs = TRUE,
    showStateProbabilities = TRUE,
    showMeanSojournTimes = TRUE,
    showExpectedRewards = FALSE,
    showModelFit = TRUE,
    showPredictions = TRUE,
    showEducational = TRUE,
    plotStateProbs = TRUE,
    plotTransitionProbs = FALSE,
    plotHazardRatios = FALSE,
    plotModelDiagnostics = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("markovmultistate requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(event)) event <- jmvcore::resolveQuo(jmvcore::enquo(event))
    if ( ! missing(subject)) subject <- jmvcore::resolveQuo(jmvcore::enquo(subject))
    if ( ! missing(covs)) covs <- jmvcore::resolveQuo(jmvcore::enquo(covs))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(event), event, NULL),
            `if`( ! missing(subject), subject, NULL),
            `if`( ! missing(covs), covs, NULL))


    options <- markovmultistateOptions$new(
        time = time,
        event = event,
        subject = subject,
        covs = covs,
        modelType = modelType,
        transitionMatrix = transitionMatrix,
        baselineHazard = baselineHazard,
        estimationMethod = estimationMethod,
        timeUnits = timeUnits,
        predictionTimes = predictionTimes,
        transitionTimes = transitionTimes,
        conf = conf,
        maxIterations = maxIterations,
        tolerance = tolerance,
        showTransitionIntensities = showTransitionIntensities,
        showTransitionProbs = showTransitionProbs,
        showStateProbabilities = showStateProbabilities,
        showMeanSojournTimes = showMeanSojournTimes,
        showExpectedRewards = showExpectedRewards,
        showModelFit = showModelFit,
        showPredictions = showPredictions,
        showEducational = showEducational,
        plotStateProbs = plotStateProbs,
        plotTransitionProbs = plotTransitionProbs,
        plotHazardRatios = plotHazardRatios,
        plotModelDiagnostics = plotModelDiagnostics)

    analysis <- markovmultistateClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

