
# This file is automatically generated, you probably don't want to edit this

timeupdatedsurvivalOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "timeupdatedsurvivalOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            timeVar = NULL,
            statusVar = NULL,
            covariates = NULL,
            timeVaryingCovs = NULL,
            stratificationVar = NULL,
            modelType = "dynreg",
            timePoints = "6,12,24,36,60",
            bandwidthMethod = "auto",
            manualBandwidth = 1,
            confidenceLevel = 0.95,
            plotType = "coefficients",
            showTable = TRUE,
            showPlots = TRUE,
            showGoFTests = TRUE,
            showExplanations = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="timeupdatedsurvival",
                requiresData=TRUE,
                ...)

            private$..timeVar <- jmvcore::OptionVariable$new(
                "timeVar",
                timeVar,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..statusVar <- jmvcore::OptionVariable$new(
                "statusVar",
                statusVar,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..timeVaryingCovs <- jmvcore::OptionVariables$new(
                "timeVaryingCovs",
                timeVaryingCovs,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..stratificationVar <- jmvcore::OptionVariable$new(
                "stratificationVar",
                stratificationVar,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..modelType <- jmvcore::OptionList$new(
                "modelType",
                modelType,
                options=list(
                    "dynreg",
                    "aalen",
                    "coxaalen",
                    "timevarycox",
                    "flexparam"),
                default="dynreg")
            private$..timePoints <- jmvcore::OptionString$new(
                "timePoints",
                timePoints,
                default="6,12,24,36,60")
            private$..bandwidthMethod <- jmvcore::OptionList$new(
                "bandwidthMethod",
                bandwidthMethod,
                options=list(
                    "auto",
                    "cv",
                    "manual"),
                default="auto")
            private$..manualBandwidth <- jmvcore::OptionNumber$new(
                "manualBandwidth",
                manualBandwidth,
                default=1)
            private$..confidenceLevel <- jmvcore::OptionNumber$new(
                "confidenceLevel",
                confidenceLevel,
                default=0.95,
                min=0.01,
                max=0.99)
            private$..plotType <- jmvcore::OptionList$new(
                "plotType",
                plotType,
                options=list(
                    "coefficients",
                    "cumulative",
                    "hazards",
                    "survival",
                    "all"),
                default="coefficients")
            private$..showTable <- jmvcore::OptionBool$new(
                "showTable",
                showTable,
                default=TRUE)
            private$..showPlots <- jmvcore::OptionBool$new(
                "showPlots",
                showPlots,
                default=TRUE)
            private$..showGoFTests <- jmvcore::OptionBool$new(
                "showGoFTests",
                showGoFTests,
                default=TRUE)
            private$..showExplanations <- jmvcore::OptionBool$new(
                "showExplanations",
                showExplanations,
                default=TRUE)

            self$.addOption(private$..timeVar)
            self$.addOption(private$..statusVar)
            self$.addOption(private$..covariates)
            self$.addOption(private$..timeVaryingCovs)
            self$.addOption(private$..stratificationVar)
            self$.addOption(private$..modelType)
            self$.addOption(private$..timePoints)
            self$.addOption(private$..bandwidthMethod)
            self$.addOption(private$..manualBandwidth)
            self$.addOption(private$..confidenceLevel)
            self$.addOption(private$..plotType)
            self$.addOption(private$..showTable)
            self$.addOption(private$..showPlots)
            self$.addOption(private$..showGoFTests)
            self$.addOption(private$..showExplanations)
        }),
    active = list(
        timeVar = function() private$..timeVar$value,
        statusVar = function() private$..statusVar$value,
        covariates = function() private$..covariates$value,
        timeVaryingCovs = function() private$..timeVaryingCovs$value,
        stratificationVar = function() private$..stratificationVar$value,
        modelType = function() private$..modelType$value,
        timePoints = function() private$..timePoints$value,
        bandwidthMethod = function() private$..bandwidthMethod$value,
        manualBandwidth = function() private$..manualBandwidth$value,
        confidenceLevel = function() private$..confidenceLevel$value,
        plotType = function() private$..plotType$value,
        showTable = function() private$..showTable$value,
        showPlots = function() private$..showPlots$value,
        showGoFTests = function() private$..showGoFTests$value,
        showExplanations = function() private$..showExplanations$value),
    private = list(
        ..timeVar = NA,
        ..statusVar = NA,
        ..covariates = NA,
        ..timeVaryingCovs = NA,
        ..stratificationVar = NA,
        ..modelType = NA,
        ..timePoints = NA,
        ..bandwidthMethod = NA,
        ..manualBandwidth = NA,
        ..confidenceLevel = NA,
        ..plotType = NA,
        ..showTable = NA,
        ..showPlots = NA,
        ..showGoFTests = NA,
        ..showExplanations = NA)
)

timeupdatedsurvivalResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "timeupdatedsurvivalResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        modelSummary = function() private$.items[["modelSummary"]],
        timeVaryingEffects = function() private$.items[["timeVaryingEffects"]],
        survivalEstimates = function() private$.items[["survivalEstimates"]],
        goodnessOfFit = function() private$.items[["goodnessOfFit"]],
        timeVaryingPlots = function() private$.items[["timeVaryingPlots"]],
        survivalPlots = function() private$.items[["survivalPlots"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Time-Updated Survival Estimates",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Analysis Instructions",
                visible="(showExplanations)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                visible="(showTable)",
                rows=1,
                clearWith=list(
                    "timeVar",
                    "statusVar",
                    "covariates",
                    "modelType"),
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="zvalue", 
                        `title`="Z-value", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="pvalue", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto:4"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="timeVaryingEffects",
                title="Time-Varying Effects",
                visible="(showTable)",
                rows=1,
                clearWith=list(
                    "timeVar",
                    "statusVar",
                    "covariates",
                    "timeVaryingCovs",
                    "modelType"),
                columns=list(
                    list(
                        `name`="timepoint", 
                        `title`="Time", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="coefficient", 
                        `title`="Coefficient", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto:4"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="survivalEstimates",
                title="Time-Updated Survival Estimates",
                visible="(showTable)",
                rows=1,
                clearWith=list(
                    "timeVar",
                    "statusVar",
                    "covariates",
                    "timePoints",
                    "modelType"),
                columns=list(
                    list(
                        `name`="time", 
                        `title`="Time", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="survival", 
                        `title`="Survival Probability", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="hazard", 
                        `title`="Hazard Rate", 
                        `type`="number", 
                        `format`="zto:4"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="goodnessOfFit",
                title="Goodness-of-Fit Tests",
                visible="(showGoFTests)",
                rows=1,
                clearWith=list(
                    "timeVar",
                    "statusVar",
                    "covariates",
                    "modelType"),
                columns=list(
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Test Statistic", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="pvalue", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="timeVaryingPlots",
                title="Time-Varying Effects Plot",
                visible="(showPlots)",
                requiresData=TRUE,
                width=700,
                height=500,
                renderFun=".plotTimeVarying",
                clearWith=list(
                    "timeVar",
                    "statusVar",
                    "covariates",
                    "timeVaryingCovs",
                    "modelType",
                    "plotType")))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlots",
                title="Time-Updated Survival Plot",
                visible="(showPlots)",
                requiresData=TRUE,
                width=700,
                height=500,
                renderFun=".plotSurvival",
                clearWith=list(
                    "timeVar",
                    "statusVar",
                    "covariates",
                    "timePoints",
                    "modelType",
                    "plotType")))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Method and Interpretation",
                visible="(showExplanations)"))}))

timeupdatedsurvivalBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "timeupdatedsurvivalBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "timeupdatedsurvival",
                version = c(0,0,1),
                options = options,
                results = timeupdatedsurvivalResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Time-Updated Survival Estimates
#'
#' Performs time-updated survival estimates using dynamic regression models  
#' for survival data. This analysis allows for time-varying effects of 
#' covariates,  dynamic hazard functions, and temporal changes in survival 
#' relationships.  Multiple modeling approaches are supported including Aalen 
#' additive models,  Cox-Aalen hybrid models, and dynamic regression with 
#' time-updated coefficients.
#'
#' @examples
#' # example will be added
#'
#' @param data The data as a data frame.
#' @param timeVar Survival time variable (numeric)
#' @param statusVar Event indicator (0=censored, 1=event)
#' @param covariates Predictive variables for time-updated regression analysis
#' @param timeVaryingCovs Variables with time-varying effects
#' @param stratificationVar Variable for stratified analysis
#' @param modelType Type of time-updated survival model
#' @param timePoints Comma-separated time points for survival estimates (e.g.,
#'   6,12,24,60)
#' @param bandwidthMethod Method for bandwidth selection in smoothing
#' @param manualBandwidth Bandwidth value for manual specification
#' @param confidenceLevel Confidence level for intervals
#' @param plotType Type of plots to display
#' @param showTable Display time-updated parameter estimates table
#' @param showPlots Display time-updated survival plots
#' @param showGoFTests Display model goodness-of-fit assessments
#' @param showExplanations Display interpretation and methodology explanations
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$timeVaryingEffects} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$survivalEstimates} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$goodnessOfFit} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$timeVaryingPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$survivalPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelSummary$asDF}
#'
#' \code{as.data.frame(results$modelSummary)}
#'
#' @export
timeupdatedsurvival <- function(
    data,
    timeVar,
    statusVar,
    covariates,
    timeVaryingCovs,
    stratificationVar,
    modelType = "dynreg",
    timePoints = "6,12,24,36,60",
    bandwidthMethod = "auto",
    manualBandwidth = 1,
    confidenceLevel = 0.95,
    plotType = "coefficients",
    showTable = TRUE,
    showPlots = TRUE,
    showGoFTests = TRUE,
    showExplanations = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("timeupdatedsurvival requires jmvcore to be installed (restart may be required)")

    if ( ! missing(timeVar)) timeVar <- jmvcore::resolveQuo(jmvcore::enquo(timeVar))
    if ( ! missing(statusVar)) statusVar <- jmvcore::resolveQuo(jmvcore::enquo(statusVar))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(timeVaryingCovs)) timeVaryingCovs <- jmvcore::resolveQuo(jmvcore::enquo(timeVaryingCovs))
    if ( ! missing(stratificationVar)) stratificationVar <- jmvcore::resolveQuo(jmvcore::enquo(stratificationVar))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(timeVar), timeVar, NULL),
            `if`( ! missing(statusVar), statusVar, NULL),
            `if`( ! missing(covariates), covariates, NULL),
            `if`( ! missing(timeVaryingCovs), timeVaryingCovs, NULL),
            `if`( ! missing(stratificationVar), stratificationVar, NULL))

    for (v in stratificationVar) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- timeupdatedsurvivalOptions$new(
        timeVar = timeVar,
        statusVar = statusVar,
        covariates = covariates,
        timeVaryingCovs = timeVaryingCovs,
        stratificationVar = stratificationVar,
        modelType = modelType,
        timePoints = timePoints,
        bandwidthMethod = bandwidthMethod,
        manualBandwidth = manualBandwidth,
        confidenceLevel = confidenceLevel,
        plotType = plotType,
        showTable = showTable,
        showPlots = showPlots,
        showGoFTests = showGoFTests,
        showExplanations = showExplanations)

    analysis <- timeupdatedsurvivalClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

