
# This file is automatically generated, you probably don't want to edit this

rmstOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "rmstOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            outcome = NULL,
            explanatory = NULL,
            outcomeLevel = "1",
            tau_method = "auto",
            tau_value = 365,
            tau_percentile = 80,
            confidence_level = 0.95,
            bootstrap_ci = FALSE,
            bootstrap_n = 1000,
            show_rmst_table = TRUE,
            show_rmst_plot = TRUE,
            show_difference_test = TRUE,
            show_ratio_test = FALSE,
            show_tau_analysis = FALSE,
            showSummaries = FALSE,
            showExplanations = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="rmst",
                requiresData=TRUE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..explanatory <- jmvcore::OptionVariable$new(
                "explanatory",
                explanatory,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..outcomeLevel <- jmvcore::OptionString$new(
                "outcomeLevel",
                outcomeLevel,
                default="1")
            private$..tau_method <- jmvcore::OptionList$new(
                "tau_method",
                tau_method,
                options=list(
                    "auto",
                    "manual",
                    "percentile"),
                default="auto")
            private$..tau_value <- jmvcore::OptionNumber$new(
                "tau_value",
                tau_value,
                min=0.1,
                default=365)
            private$..tau_percentile <- jmvcore::OptionNumber$new(
                "tau_percentile",
                tau_percentile,
                min=10,
                max=90,
                default=80)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..bootstrap_ci <- jmvcore::OptionBool$new(
                "bootstrap_ci",
                bootstrap_ci,
                default=FALSE)
            private$..bootstrap_n <- jmvcore::OptionInteger$new(
                "bootstrap_n",
                bootstrap_n,
                min=100,
                max=10000,
                default=1000)
            private$..show_rmst_table <- jmvcore::OptionBool$new(
                "show_rmst_table",
                show_rmst_table,
                default=TRUE)
            private$..show_rmst_plot <- jmvcore::OptionBool$new(
                "show_rmst_plot",
                show_rmst_plot,
                default=TRUE)
            private$..show_difference_test <- jmvcore::OptionBool$new(
                "show_difference_test",
                show_difference_test,
                default=TRUE)
            private$..show_ratio_test <- jmvcore::OptionBool$new(
                "show_ratio_test",
                show_ratio_test,
                default=FALSE)
            private$..show_tau_analysis <- jmvcore::OptionBool$new(
                "show_tau_analysis",
                show_tau_analysis,
                default=FALSE)
            private$..showSummaries <- jmvcore::OptionBool$new(
                "showSummaries",
                showSummaries,
                default=FALSE)
            private$..showExplanations <- jmvcore::OptionBool$new(
                "showExplanations",
                showExplanations,
                default=FALSE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..outcome)
            self$.addOption(private$..explanatory)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..tau_method)
            self$.addOption(private$..tau_value)
            self$.addOption(private$..tau_percentile)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..bootstrap_ci)
            self$.addOption(private$..bootstrap_n)
            self$.addOption(private$..show_rmst_table)
            self$.addOption(private$..show_rmst_plot)
            self$.addOption(private$..show_difference_test)
            self$.addOption(private$..show_ratio_test)
            self$.addOption(private$..show_tau_analysis)
            self$.addOption(private$..showSummaries)
            self$.addOption(private$..showExplanations)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        outcome = function() private$..outcome$value,
        explanatory = function() private$..explanatory$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        tau_method = function() private$..tau_method$value,
        tau_value = function() private$..tau_value$value,
        tau_percentile = function() private$..tau_percentile$value,
        confidence_level = function() private$..confidence_level$value,
        bootstrap_ci = function() private$..bootstrap_ci$value,
        bootstrap_n = function() private$..bootstrap_n$value,
        show_rmst_table = function() private$..show_rmst_table$value,
        show_rmst_plot = function() private$..show_rmst_plot$value,
        show_difference_test = function() private$..show_difference_test$value,
        show_ratio_test = function() private$..show_ratio_test$value,
        show_tau_analysis = function() private$..show_tau_analysis$value,
        showSummaries = function() private$..showSummaries$value,
        showExplanations = function() private$..showExplanations$value),
    private = list(
        ..elapsedtime = NA,
        ..outcome = NA,
        ..explanatory = NA,
        ..outcomeLevel = NA,
        ..tau_method = NA,
        ..tau_value = NA,
        ..tau_percentile = NA,
        ..confidence_level = NA,
        ..bootstrap_ci = NA,
        ..bootstrap_n = NA,
        ..show_rmst_table = NA,
        ..show_rmst_plot = NA,
        ..show_difference_test = NA,
        ..show_ratio_test = NA,
        ..show_tau_analysis = NA,
        ..showSummaries = NA,
        ..showExplanations = NA)
)

rmstResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "rmstResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        rmstTable = function() private$.items[["rmstTable"]],
        comparisonTable = function() private$.items[["comparisonTable"]],
        rmstPlot = function() private$.items[["rmstPlot"]],
        tauAnalysisPlot = function() private$.items[["tauAnalysisPlot"]],
        tauAnalysisTable = function() private$.items[["tauAnalysisTable"]],
        analysisSummary = function() private$.items[["analysisSummary"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Restricted Mean Survival Time Tests",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="rmstTable",
                title="Restricted Mean Survival Time Analysis",
                visible="(show_rmst_table)",
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="rmst", 
                        `title`="RMST", 
                        `type`="number"),
                    list(
                        `name`="rmst_se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="rmst_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="rmst_upper", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="comparisonTable",
                title="Group Comparisons",
                visible="(show_difference_test || show_ratio_test)",
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="test_type", 
                        `title`="Test Type", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="z_score", 
                        `title`="Z", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="rmstPlot",
                title="Survival Curves with RMST Areas",
                visible="(show_rmst_plot)",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="tauAnalysisPlot",
                title="Tau Sensitivity Analysis",
                visible="(show_tau_analysis)",
                requiresData=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="tauAnalysisTable",
                title="Tau Sensitivity Results",
                visible="(show_tau_analysis)",
                columns=list(
                    list(
                        `name`="tau", 
                        `title`="Tau", 
                        `type`="number"),
                    list(
                        `name`="rmst_diff", 
                        `title`="RMST Difference", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="analysisSummary",
                title="Analysis Summary",
                visible="(showSummaries)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Methodology",
                visible="(showExplanations)"))}))

rmstBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "rmstBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "rmst",
                version = c(1,0,0),
                options = options,
                results = rmstResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Restricted Mean Survival Time Tests
#'
#' Performs restricted mean survival time (RMST) analysis for comparing  
#' survival distributions between groups. RMST provides a clinically 
#' meaningful  measure of survival benefit by estimating the area under the 
#' survival curve  up to a specific time point (tau), representing the average 
#' survival time  within the restriction period.
#' 
#'
#' @examples
#' # Example usage will be added
#'
#' @param data The data as a data frame.
#' @param elapsedtime Time variable for survival analysis
#' @param outcome Event indicator variable
#' @param explanatory Grouping variable for comparison
#' @param outcomeLevel Level of the outcome variable that represents the event
#'   of interest.
#' @param tau_method Method for selecting the restriction time tau.
#' @param tau_value Manual specification of restriction time tau (used when
#'   method is 'manual').
#' @param tau_percentile Percentile of maximum follow-up time to use as tau
#'   (used when method is 'percentile').
#' @param confidence_level Confidence level for all confidence intervals.
#' @param bootstrap_ci Use bootstrap method for confidence intervals (more
#'   robust for small samples).
#' @param bootstrap_n Number of bootstrap iterations for confidence interval
#'   estimation.
#' @param show_rmst_table Display table with RMST estimates and confidence
#'   intervals by group.
#' @param show_rmst_plot Display survival curves with highlighted RMST areas.
#' @param show_difference_test Perform statistical test for difference in RMST
#'   between groups.
#' @param show_ratio_test Perform statistical test for ratio of RMST between
#'   groups.
#' @param show_tau_analysis Display sensitivity analysis across different tau
#'   values.
#' @param showSummaries Generate natural language summary of results.
#' @param showExplanations Show detailed methodology explanations.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$rmstTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$comparisonTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$rmstPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$tauAnalysisPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$tauAnalysisTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$analysisSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$rmstTable$asDF}
#'
#' \code{as.data.frame(results$rmstTable)}
#'
#' @export
rmst <- function(
    data,
    elapsedtime,
    outcome,
    explanatory,
    outcomeLevel = "1",
    tau_method = "auto",
    tau_value = 365,
    tau_percentile = 80,
    confidence_level = 0.95,
    bootstrap_ci = FALSE,
    bootstrap_n = 1000,
    show_rmst_table = TRUE,
    show_rmst_plot = TRUE,
    show_difference_test = TRUE,
    show_ratio_test = FALSE,
    show_tau_analysis = FALSE,
    showSummaries = FALSE,
    showExplanations = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("rmst requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(explanatory)) explanatory <- jmvcore::resolveQuo(jmvcore::enquo(explanatory))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(elapsedtime), elapsedtime, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(explanatory), explanatory, NULL))


    options <- rmstOptions$new(
        elapsedtime = elapsedtime,
        outcome = outcome,
        explanatory = explanatory,
        outcomeLevel = outcomeLevel,
        tau_method = tau_method,
        tau_value = tau_value,
        tau_percentile = tau_percentile,
        confidence_level = confidence_level,
        bootstrap_ci = bootstrap_ci,
        bootstrap_n = bootstrap_n,
        show_rmst_table = show_rmst_table,
        show_rmst_plot = show_rmst_plot,
        show_difference_test = show_difference_test,
        show_ratio_test = show_ratio_test,
        show_tau_analysis = show_tau_analysis,
        showSummaries = showSummaries,
        showExplanations = showExplanations)

    analysis <- rmstClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

