
# This file is automatically generated, you probably don't want to edit this

ihcbasicOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcbasicOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            markers = NULL,
            id = NULL,
            computeHScore = FALSE,
            clusterMethod = "hierarchical",
            nClusters = 3,
            distanceMetric = "gower",
            linkageMethod = "ward.D2",
            standardizeData = TRUE,
            showDendrogram = TRUE,
            showHeatmap = TRUE,
            silhouetteAnalysis = TRUE,
            scoringScale = "standard", ...) {

            super$initialize(
                package="ClinicoPath",
                name="ihcbasic",
                requiresData=TRUE,
                ...)

            private$..markers <- jmvcore::OptionVariables$new(
                "markers",
                markers,
                suggested=list(
                    "ordinal",
                    "nominal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..id <- jmvcore::OptionVariable$new(
                "id",
                id,
                suggested=list(
                    "nominal",
                    "id"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..computeHScore <- jmvcore::OptionBool$new(
                "computeHScore",
                computeHScore,
                default=FALSE)
            private$..clusterMethod <- jmvcore::OptionList$new(
                "clusterMethod",
                clusterMethod,
                options=list(
                    "hierarchical",
                    "kmeans",
                    "pam"),
                default="hierarchical")
            private$..nClusters <- jmvcore::OptionInteger$new(
                "nClusters",
                nClusters,
                min=2,
                max=10,
                default=3)
            private$..distanceMetric <- jmvcore::OptionList$new(
                "distanceMetric",
                distanceMetric,
                options=list(
                    "gower",
                    "jaccard"),
                default="gower")
            private$..linkageMethod <- jmvcore::OptionList$new(
                "linkageMethod",
                linkageMethod,
                options=list(
                    "ward.D2",
                    "complete",
                    "average"),
                default="ward.D2")
            private$..standardizeData <- jmvcore::OptionBool$new(
                "standardizeData",
                standardizeData,
                default=TRUE)
            private$..showDendrogram <- jmvcore::OptionBool$new(
                "showDendrogram",
                showDendrogram,
                default=TRUE)
            private$..showHeatmap <- jmvcore::OptionBool$new(
                "showHeatmap",
                showHeatmap,
                default=TRUE)
            private$..silhouetteAnalysis <- jmvcore::OptionBool$new(
                "silhouetteAnalysis",
                silhouetteAnalysis,
                default=TRUE)
            private$..scoringScale <- jmvcore::OptionList$new(
                "scoringScale",
                scoringScale,
                options=list(
                    "standard",
                    "binary",
                    "hscore"),
                default="standard")

            self$.addOption(private$..markers)
            self$.addOption(private$..id)
            self$.addOption(private$..computeHScore)
            self$.addOption(private$..clusterMethod)
            self$.addOption(private$..nClusters)
            self$.addOption(private$..distanceMetric)
            self$.addOption(private$..linkageMethod)
            self$.addOption(private$..standardizeData)
            self$.addOption(private$..showDendrogram)
            self$.addOption(private$..showHeatmap)
            self$.addOption(private$..silhouetteAnalysis)
            self$.addOption(private$..scoringScale)
        }),
    active = list(
        markers = function() private$..markers$value,
        id = function() private$..id$value,
        computeHScore = function() private$..computeHScore$value,
        clusterMethod = function() private$..clusterMethod$value,
        nClusters = function() private$..nClusters$value,
        distanceMetric = function() private$..distanceMetric$value,
        linkageMethod = function() private$..linkageMethod$value,
        standardizeData = function() private$..standardizeData$value,
        showDendrogram = function() private$..showDendrogram$value,
        showHeatmap = function() private$..showHeatmap$value,
        silhouetteAnalysis = function() private$..silhouetteAnalysis$value,
        scoringScale = function() private$..scoringScale$value),
    private = list(
        ..markers = NA,
        ..id = NA,
        ..computeHScore = NA,
        ..clusterMethod = NA,
        ..nClusters = NA,
        ..distanceMetric = NA,
        ..linkageMethod = NA,
        ..standardizeData = NA,
        ..showDendrogram = NA,
        ..showHeatmap = NA,
        ..silhouetteAnalysis = NA,
        ..scoringScale = NA)
)

ihcbasicResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcbasicResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        clinicalSummary = function() private$.items[["clinicalSummary"]],
        reportText = function() private$.items[["reportText"]],
        clusterSummary = function() private$.items[["clusterSummary"]],
        hscoreTable = function() private$.items[["hscoreTable"]],
        silhouetteTable = function() private$.items[["silhouetteTable"]],
        markerSummary = function() private$.items[["markerSummary"]],
        dendrogramPlot = function() private$.items[["dendrogramPlot"]],
        heatmapPlot = function() private$.items[["heatmapPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Basic IHC Analysis",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Analysis Overview",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalSummary",
                title="Clinical Interpretation",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="reportText",
                title="Copy-Ready Report",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="clusterSummary",
                title="Clustering Results",
                visible=TRUE,
                clearWith=list(
                    "markers",
                    "clusterMethod",
                    "nClusters"),
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="integer"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="percentage", 
                        `title`="%", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="pattern", 
                        `title`="Expression Pattern", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="hscoreTable",
                title="H-Score Summary",
                visible="(computeHScore)",
                clearWith=list(
                    "markers"),
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="mean", 
                        `title`="Mean H-Score", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="sd", 
                        `title`="SD", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="median", 
                        `title`="Median", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="range", 
                        `title`="Range", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="silhouetteTable",
                title="Cluster Quality Assessment",
                visible="(silhouetteAnalysis)",
                clearWith=list(
                    "markers",
                    "clusterMethod",
                    "nClusters"),
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="avg_width", 
                        `title`="Avg Silhouette Width", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="interpretation", 
                        `title`="Quality", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="markerSummary",
                title="Marker Expression by Cluster",
                visible=TRUE,
                clearWith=list(
                    "markers",
                    "clusterMethod",
                    "nClusters"),
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="p_value", 
                        `title`="P-value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="significance", 
                        `title`="Sig.", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="dendrogramPlot",
                title="Hierarchical Clustering Dendrogram",
                visible="(showDendrogram && clusterMethod:hierarchical)",
                renderFun=".plotDendrogram",
                clearWith=list(
                    "markers",
                    "clusterMethod",
                    "nClusters",
                    "linkageMethod"),
                width=800,
                height=600))
            self$add(jmvcore::Image$new(
                options=options,
                name="heatmapPlot",
                title="Expression Heatmap",
                visible="(showHeatmap)",
                renderFun=".plotHeatmap",
                clearWith=list(
                    "markers",
                    "clusterMethod",
                    "nClusters"),
                width=800,
                height=600))}))

ihcbasicBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcbasicBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "ihcbasic",
                version = c(1,0,0),
                options = options,
                results = ihcbasicResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Basic IHC Analysis
#'
#' Essential IHC expression analysis with clustering and H-score calculation. 
#' Designed for routine clinical use with simplified options.
#' 
#'
#' @examples
#' data \%>\%
#' ihcbasic(
#'     markers = c("ER", "PR", "HER2", "Ki67"),
#'     clusterMethod = "hierarchical",
#'     nClusters = 3,
#'     computeHScore = TRUE
#' )
#'
#' @param data the data as a data frame
#' @param markers IHC marker variables (categorical 0-3 or continuous
#'   H-scores)
#' @param id Optional case/sample identifier for labeling
#' @param computeHScore Generate H-score statistics (mean, median, range) for
#'   each marker. H-scores represent staining intensity multiplied by percentage
#'   of positive cells, providing a comprehensive measure of protein expression
#'   (range 0-300).
#' @param clusterMethod Method for clustering samples by IHC expression
#'   patterns. Hierarchical clustering builds tree-like relationships and works
#'   well for small to medium datasets. K-means is faster for large datasets but
#'   assumes spherical clusters. PAM (Partitioning Around Medoids) is more
#'   robust to outliers.
#' @param nClusters Number of distinct IHC expression patterns to identify.
#'   Start with 2-3 patterns for initial exploration. More patterns may reveal
#'   tumor heterogeneity but require larger sample sizes (rule of thumb: at
#'   least 3-5 samples per pattern).
#' @param distanceMetric How to measure similarity between samples. Gower
#'   distance works with different IHC scoring scales (0-3, H-scores, binary)
#'   and is recommended for most analyses. Jaccard distance only considers
#'   presence/absence of staining.
#' @param linkageMethod How to form groups in hierarchical clustering. Ward's
#'   method creates well-balanced groups and is recommended for most IHC
#'   analyses. Complete linkage creates tight, compact clusters. Average linkage
#'   provides a moderate approach between the two.
#' @param standardizeData Recommended when markers use different scales (e.g.,
#'   mixing 0-3 scores with H-scores). Puts all markers on the same scale so no
#'   single marker dominates the analysis. Disable for binary data or when all
#'   markers use the same scale.
#' @param showDendrogram Shows the hierarchical relationship between samples
#'   as a tree diagram. Helps visualize how expression patterns relate to each
#'   other and identify the optimal number of groups.
#' @param showHeatmap Visual representation of IHC staining patterns across
#'   all samples. Each row represents a patient sample, each column represents a
#'   marker. Colors indicate expression levels, with samples grouped by similar
#'   patterns.
#' @param silhouetteAnalysis Recommended: Evaluates how well-separated the
#'   expression patterns are. Higher scores indicate more reliable, clinically
#'   meaningful patterns. Helps determine if the identified patterns are real or
#'   due to noise.
#' @param scoringScale The IHC scoring system used in your data. Standard 0-3
#'   scale is most common (0=no staining, 1=weak, 2=moderate, 3=strong
#'   staining). Binary scoring records only presence/absence. H-score combines
#'   intensity and percentage of positive cells (range 0-300).
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$clinicalSummary} \tab \tab \tab \tab \tab Plain-language summary with clinical context \cr
#'   \code{results$reportText} \tab \tab \tab \tab \tab Pre-formatted text for clinical reports \cr
#'   \code{results$clusterSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$hscoreTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$silhouetteTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$markerSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$dendrogramPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$heatmapPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$clusterSummary$asDF}
#'
#' \code{as.data.frame(results$clusterSummary)}
#'
#' @export
ihcbasic <- function(
    data,
    markers,
    id = NULL,
    computeHScore = FALSE,
    clusterMethod = "hierarchical",
    nClusters = 3,
    distanceMetric = "gower",
    linkageMethod = "ward.D2",
    standardizeData = TRUE,
    showDendrogram = TRUE,
    showHeatmap = TRUE,
    silhouetteAnalysis = TRUE,
    scoringScale = "standard") {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("ihcbasic requires jmvcore to be installed (restart may be required)")

    if ( ! missing(markers)) markers <- jmvcore::resolveQuo(jmvcore::enquo(markers))
    if ( ! missing(id)) id <- jmvcore::resolveQuo(jmvcore::enquo(id))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(markers), markers, NULL),
            `if`( ! missing(id), id, NULL))


    options <- ihcbasicOptions$new(
        markers = markers,
        id = id,
        computeHScore = computeHScore,
        clusterMethod = clusterMethod,
        nClusters = nClusters,
        distanceMetric = distanceMetric,
        linkageMethod = linkageMethod,
        standardizeData = standardizeData,
        showDendrogram = showDendrogram,
        showHeatmap = showHeatmap,
        silhouetteAnalysis = silhouetteAnalysis,
        scoringScale = scoringScale)

    analysis <- ihcbasicClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

