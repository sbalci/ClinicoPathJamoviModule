
# This file is automatically generated, you probably don't want to edit this

coefplotOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "coefplotOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            dep = NULL,
            covs = NULL,
            model_type = "linear",
            time_var = NULL,
            include_intercept = FALSE,
            coef_selection = "all",
            specific_coefs = "",
            ci_level = 0.95,
            inner_ci_level = 0.8,
            sort_coefs = "natural",
            decreasing_sort = TRUE,
            horizontal_plot = TRUE,
            point_size = 3,
            line_thickness = 1,
            standardize = FALSE,
            robust_se = FALSE,
            exp_transform = FALSE,
            compare_models = FALSE,
            model2_covs = NULL,
            model3_covs = NULL,
            model_names = "Model 1, Model 2, Model 3",
            show_coefficient_plot = TRUE,
            show_model_summary = TRUE,
            show_coefficient_table = FALSE,
            custom_title = "",
            custom_x_label = "", ...) {

            super$initialize(
                package="ClinicoPath",
                name="coefplot",
                requiresData=TRUE,
                ...)

            private$..dep <- jmvcore::OptionVariable$new(
                "dep",
                dep,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..covs <- jmvcore::OptionVariables$new(
                "covs",
                covs,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..model_type <- jmvcore::OptionList$new(
                "model_type",
                model_type,
                options=list(
                    "linear",
                    "logistic",
                    "cox",
                    "poisson"),
                default="linear")
            private$..time_var <- jmvcore::OptionVariable$new(
                "time_var",
                time_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..include_intercept <- jmvcore::OptionBool$new(
                "include_intercept",
                include_intercept,
                default=FALSE)
            private$..coef_selection <- jmvcore::OptionList$new(
                "coef_selection",
                coef_selection,
                options=list(
                    "all",
                    "specific",
                    "exclude"),
                default="all")
            private$..specific_coefs <- jmvcore::OptionString$new(
                "specific_coefs",
                specific_coefs,
                default="")
            private$..ci_level <- jmvcore::OptionNumber$new(
                "ci_level",
                ci_level,
                min=0.8,
                max=0.99,
                default=0.95)
            private$..inner_ci_level <- jmvcore::OptionNumber$new(
                "inner_ci_level",
                inner_ci_level,
                min=0.5,
                max=0.95,
                default=0.8)
            private$..sort_coefs <- jmvcore::OptionList$new(
                "sort_coefs",
                sort_coefs,
                options=list(
                    "natural",
                    "magnitude",
                    "alphabetical"),
                default="natural")
            private$..decreasing_sort <- jmvcore::OptionBool$new(
                "decreasing_sort",
                decreasing_sort,
                default=TRUE)
            private$..horizontal_plot <- jmvcore::OptionBool$new(
                "horizontal_plot",
                horizontal_plot,
                default=TRUE)
            private$..point_size <- jmvcore::OptionNumber$new(
                "point_size",
                point_size,
                min=1,
                max=10,
                default=3)
            private$..line_thickness <- jmvcore::OptionNumber$new(
                "line_thickness",
                line_thickness,
                min=0.5,
                max=3,
                default=1)
            private$..standardize <- jmvcore::OptionBool$new(
                "standardize",
                standardize,
                default=FALSE)
            private$..robust_se <- jmvcore::OptionBool$new(
                "robust_se",
                robust_se,
                default=FALSE)
            private$..exp_transform <- jmvcore::OptionBool$new(
                "exp_transform",
                exp_transform,
                default=FALSE)
            private$..compare_models <- jmvcore::OptionBool$new(
                "compare_models",
                compare_models,
                default=FALSE)
            private$..model2_covs <- jmvcore::OptionVariables$new(
                "model2_covs",
                model2_covs,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..model3_covs <- jmvcore::OptionVariables$new(
                "model3_covs",
                model3_covs,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..model_names <- jmvcore::OptionString$new(
                "model_names",
                model_names,
                default="Model 1, Model 2, Model 3")
            private$..show_coefficient_plot <- jmvcore::OptionBool$new(
                "show_coefficient_plot",
                show_coefficient_plot,
                default=TRUE)
            private$..show_model_summary <- jmvcore::OptionBool$new(
                "show_model_summary",
                show_model_summary,
                default=TRUE)
            private$..show_coefficient_table <- jmvcore::OptionBool$new(
                "show_coefficient_table",
                show_coefficient_table,
                default=FALSE)
            private$..custom_title <- jmvcore::OptionString$new(
                "custom_title",
                custom_title,
                default="")
            private$..custom_x_label <- jmvcore::OptionString$new(
                "custom_x_label",
                custom_x_label,
                default="")

            self$.addOption(private$..dep)
            self$.addOption(private$..covs)
            self$.addOption(private$..model_type)
            self$.addOption(private$..time_var)
            self$.addOption(private$..include_intercept)
            self$.addOption(private$..coef_selection)
            self$.addOption(private$..specific_coefs)
            self$.addOption(private$..ci_level)
            self$.addOption(private$..inner_ci_level)
            self$.addOption(private$..sort_coefs)
            self$.addOption(private$..decreasing_sort)
            self$.addOption(private$..horizontal_plot)
            self$.addOption(private$..point_size)
            self$.addOption(private$..line_thickness)
            self$.addOption(private$..standardize)
            self$.addOption(private$..robust_se)
            self$.addOption(private$..exp_transform)
            self$.addOption(private$..compare_models)
            self$.addOption(private$..model2_covs)
            self$.addOption(private$..model3_covs)
            self$.addOption(private$..model_names)
            self$.addOption(private$..show_coefficient_plot)
            self$.addOption(private$..show_model_summary)
            self$.addOption(private$..show_coefficient_table)
            self$.addOption(private$..custom_title)
            self$.addOption(private$..custom_x_label)
        }),
    active = list(
        dep = function() private$..dep$value,
        covs = function() private$..covs$value,
        model_type = function() private$..model_type$value,
        time_var = function() private$..time_var$value,
        include_intercept = function() private$..include_intercept$value,
        coef_selection = function() private$..coef_selection$value,
        specific_coefs = function() private$..specific_coefs$value,
        ci_level = function() private$..ci_level$value,
        inner_ci_level = function() private$..inner_ci_level$value,
        sort_coefs = function() private$..sort_coefs$value,
        decreasing_sort = function() private$..decreasing_sort$value,
        horizontal_plot = function() private$..horizontal_plot$value,
        point_size = function() private$..point_size$value,
        line_thickness = function() private$..line_thickness$value,
        standardize = function() private$..standardize$value,
        robust_se = function() private$..robust_se$value,
        exp_transform = function() private$..exp_transform$value,
        compare_models = function() private$..compare_models$value,
        model2_covs = function() private$..model2_covs$value,
        model3_covs = function() private$..model3_covs$value,
        model_names = function() private$..model_names$value,
        show_coefficient_plot = function() private$..show_coefficient_plot$value,
        show_model_summary = function() private$..show_model_summary$value,
        show_coefficient_table = function() private$..show_coefficient_table$value,
        custom_title = function() private$..custom_title$value,
        custom_x_label = function() private$..custom_x_label$value),
    private = list(
        ..dep = NA,
        ..covs = NA,
        ..model_type = NA,
        ..time_var = NA,
        ..include_intercept = NA,
        ..coef_selection = NA,
        ..specific_coefs = NA,
        ..ci_level = NA,
        ..inner_ci_level = NA,
        ..sort_coefs = NA,
        ..decreasing_sort = NA,
        ..horizontal_plot = NA,
        ..point_size = NA,
        ..line_thickness = NA,
        ..standardize = NA,
        ..robust_se = NA,
        ..exp_transform = NA,
        ..compare_models = NA,
        ..model2_covs = NA,
        ..model3_covs = NA,
        ..model_names = NA,
        ..show_coefficient_plot = NA,
        ..show_model_summary = NA,
        ..show_coefficient_table = NA,
        ..custom_title = NA,
        ..custom_x_label = NA)
)

coefplotResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "coefplotResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        coefficient_plot = function() private$.items[["coefficient_plot"]],
        model_summary = function() private$.items[["model_summary"]],
        coefficient_table = function() private$.items[["coefficient_table"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Coefficient Plots",
                refs=list(
                    "coefplot",
                    "jtools",
                    "ggplot2",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                clearWith=list(
                    "dep",
                    "covs",
                    "model_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="coefficient_plot",
                title="Coefficient Plot",
                width=700,
                height=500,
                renderFun=".plot",
                visible="(show_coefficient_plot)",
                clearWith=list(
                    "dep",
                    "covs",
                    "model_type",
                    "time_var",
                    "include_intercept",
                    "coef_selection",
                    "specific_coefs",
                    "ci_level",
                    "inner_ci_level",
                    "sort_coefs",
                    "decreasing_sort",
                    "horizontal_plot",
                    "point_size",
                    "line_thickness",
                    "standardize",
                    "robust_se",
                    "exp_transform",
                    "compare_models",
                    "model2_covs",
                    "model3_covs",
                    "model_names",
                    "custom_title",
                    "custom_x_label")))
            self$add(jmvcore::Html$new(
                options=options,
                name="model_summary",
                title="Model Summary",
                visible="(show_model_summary)",
                clearWith=list(
                    "dep",
                    "covs",
                    "model_type",
                    "time_var",
                    "standardize",
                    "robust_se")))
            self$add(jmvcore::Html$new(
                options=options,
                name="coefficient_table",
                title="Coefficient Table",
                visible="(show_coefficient_table)",
                clearWith=list(
                    "dep",
                    "covs",
                    "model_type",
                    "time_var",
                    "include_intercept",
                    "ci_level",
                    "standardize",
                    "robust_se",
                    "exp_transform")))}))

coefplotBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "coefplotBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "coefplot",
                version = c(0,0,3),
                options = options,
                results = coefplotResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Coefficient Plots
#'
#' Creates professional coefficient plots (forest plots) for regression 
#' models. Visualizes coefficients and confidence intervals from linear, 
#' logistic, and  Cox regression models. Supports multiple models comparison, 
#' custom coefficient selection, standardized coefficients, and various 
#' styling options. Essential  for presenting regression results in clinical 
#' research and epidemiological studies.
#'
#' @examples
#' \donttest{
#' # example will be added
#'}
#' @param data The data as a data frame for regression analysis.
#' @param dep The outcome variable for regression analysis. Can be continuous
#'   (linear regression), binary (logistic regression), or time-to-event.
#' @param covs Independent variables (predictors) to include in the regression
#'   model. These will be displayed as coefficients in the plot.
#' @param model_type Type of regression model to fit: - Linear: For continuous
#'   outcomes - Logistic: For binary outcomes (odds ratios) - Cox: For survival
#'   analysis (hazard ratios) - Poisson: For count outcomes (rate ratios)
#' @param time_var Time-to-event variable for Cox regression. Only required
#'   when  model type is set to Cox regression.
#' @param include_intercept Include the intercept term in the coefficient
#'   plot. Usually  excluded as it's often not of primary interest.
#' @param coef_selection How to select which coefficients to display in the
#'   plot.
#' @param specific_coefs Comma-separated list of coefficient names to include
#'   or exclude  (depending on selection method). Leave blank to use all
#'   coefficients.
#' @param ci_level Confidence level for coefficient confidence intervals
#'   (e.g., 0.95 for 95\% CI).
#' @param inner_ci_level Optional inner confidence interval for enhanced
#'   visualization. Set to 0 to disable inner CI. Common values are 0.8 or 0.9.
#' @param sort_coefs How to order coefficients in the plot. Magnitude sorting
#'   can help identify the most important predictors.
#' @param decreasing_sort When sorting by magnitude or alphabetically, use
#'   decreasing order.
#' @param horizontal_plot Display coefficients horizontally (default) or
#'   vertically. Horizontal layout is typically preferred for readability.
#' @param point_size Size of the coefficient points in the plot.
#' @param line_thickness Thickness of the confidence interval lines.
#' @param standardize Standardize coefficients by scaling predictors to have
#'   mean 0 and SD 1. Useful for comparing effect sizes across variables with
#'   different scales.
#' @param robust_se Use robust (sandwich) standard errors for confidence
#'   intervals. Recommended when there are concerns about heteroscedasticity.
#' @param exp_transform Exponentiate coefficients to show odds ratios
#'   (logistic), hazard ratios (Cox), or rate ratios (Poisson). Automatically
#'   enabled for logistic and Cox models.
#' @param compare_models Create comparison plots for multiple model
#'   specifications. Useful for sensitivity analysis or model selection.
#' @param model2_covs Covariates for second model comparison. Only used when
#'   comparing models.
#' @param model3_covs Covariates for third model comparison. Only used when
#'   comparing models.
#' @param model_names Comma-separated names for models when comparing multiple
#'   models. Will be used in the legend.
#' @param show_coefficient_plot Display the main coefficient plot with
#'   confidence intervals.
#' @param show_model_summary Display statistical summary of the fitted
#'   model(s) including R-squared, AIC, and other fit statistics.
#' @param show_coefficient_table Display detailed table of coefficients,
#'   standard errors, and p-values.
#' @param custom_title Custom title for the coefficient plot. Leave blank for
#'   automatic title.
#' @param custom_x_label Custom label for x-axis. Leave blank for automatic
#'   label based on model type.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$coefficient_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$model_summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$coefficient_table} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' @export
coefplot <- function(
    data,
    dep = NULL,
    covs = NULL,
    model_type = "linear",
    time_var = NULL,
    include_intercept = FALSE,
    coef_selection = "all",
    specific_coefs = "",
    ci_level = 0.95,
    inner_ci_level = 0.8,
    sort_coefs = "natural",
    decreasing_sort = TRUE,
    horizontal_plot = TRUE,
    point_size = 3,
    line_thickness = 1,
    standardize = FALSE,
    robust_se = FALSE,
    exp_transform = FALSE,
    compare_models = FALSE,
    model2_covs = NULL,
    model3_covs = NULL,
    model_names = "Model 1, Model 2, Model 3",
    show_coefficient_plot = TRUE,
    show_model_summary = TRUE,
    show_coefficient_table = FALSE,
    custom_title = "",
    custom_x_label = "") {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("coefplot requires jmvcore to be installed (restart may be required)")

    if ( ! missing(dep)) dep <- jmvcore::resolveQuo(jmvcore::enquo(dep))
    if ( ! missing(covs)) covs <- jmvcore::resolveQuo(jmvcore::enquo(covs))
    if ( ! missing(time_var)) time_var <- jmvcore::resolveQuo(jmvcore::enquo(time_var))
    if ( ! missing(model2_covs)) model2_covs <- jmvcore::resolveQuo(jmvcore::enquo(model2_covs))
    if ( ! missing(model3_covs)) model3_covs <- jmvcore::resolveQuo(jmvcore::enquo(model3_covs))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(dep), dep, NULL),
            `if`( ! missing(covs), covs, NULL),
            `if`( ! missing(time_var), time_var, NULL),
            `if`( ! missing(model2_covs), model2_covs, NULL),
            `if`( ! missing(model3_covs), model3_covs, NULL))


    options <- coefplotOptions$new(
        dep = dep,
        covs = covs,
        model_type = model_type,
        time_var = time_var,
        include_intercept = include_intercept,
        coef_selection = coef_selection,
        specific_coefs = specific_coefs,
        ci_level = ci_level,
        inner_ci_level = inner_ci_level,
        sort_coefs = sort_coefs,
        decreasing_sort = decreasing_sort,
        horizontal_plot = horizontal_plot,
        point_size = point_size,
        line_thickness = line_thickness,
        standardize = standardize,
        robust_se = robust_se,
        exp_transform = exp_transform,
        compare_models = compare_models,
        model2_covs = model2_covs,
        model3_covs = model3_covs,
        model_names = model_names,
        show_coefficient_plot = show_coefficient_plot,
        show_model_summary = show_model_summary,
        show_coefficient_table = show_coefficient_table,
        custom_title = custom_title,
        custom_x_label = custom_x_label)

    analysis <- coefplotClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

