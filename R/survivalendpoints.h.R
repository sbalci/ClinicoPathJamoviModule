
# This file is automatically generated, you probably don't want to edit this

survivalendpointsOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "survivalendpointsOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            patientId = NULL,
            startDate = NULL,
            lastFollowup = NULL,
            deathEvent = NULL,
            progressionEvent = NULL,
            treatmentEnd = NULL,
            responseDate = NULL,
            timeUnit = "months",
            inputType = "dates",
            calculatePFS = TRUE,
            calculateOS = TRUE,
            calculateTTP = FALSE,
            calculateDOR = FALSE,
            calculateTOT = FALSE,
            showDerivedData = TRUE,
            showSummaryStats = TRUE,
            showEventRates = TRUE,
            showKMPlot = TRUE,
            showMilestones = FALSE,
            milestones = "6,12,24",
            exportEndpoints = FALSE,
            showUsageGuide = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="survivalendpoints",
                requiresData=TRUE,
                ...)

            private$..patientId <- jmvcore::OptionVariable$new(
                "patientId",
                patientId,
                required=TRUE)
            private$..startDate <- jmvcore::OptionVariable$new(
                "startDate",
                startDate,
                required=TRUE,
                suggested=list(
                    "continuous"))
            private$..lastFollowup <- jmvcore::OptionVariable$new(
                "lastFollowup",
                lastFollowup,
                required=TRUE,
                suggested=list(
                    "continuous"))
            private$..deathEvent <- jmvcore::OptionVariable$new(
                "deathEvent",
                deathEvent,
                suggested=list(
                    "nominal",
                    "ordinal"))
            private$..progressionEvent <- jmvcore::OptionVariable$new(
                "progressionEvent",
                progressionEvent,
                suggested=list(
                    "nominal",
                    "ordinal"))
            private$..treatmentEnd <- jmvcore::OptionVariable$new(
                "treatmentEnd",
                treatmentEnd,
                suggested=list(
                    "continuous"))
            private$..responseDate <- jmvcore::OptionVariable$new(
                "responseDate",
                responseDate,
                suggested=list(
                    "continuous"))
            private$..timeUnit <- jmvcore::OptionList$new(
                "timeUnit",
                timeUnit,
                options=list(
                    "days",
                    "weeks",
                    "months",
                    "years"),
                default="months")
            private$..inputType <- jmvcore::OptionList$new(
                "inputType",
                inputType,
                options=list(
                    "dates",
                    "numeric"),
                default="dates")
            private$..calculatePFS <- jmvcore::OptionBool$new(
                "calculatePFS",
                calculatePFS,
                default=TRUE)
            private$..calculateOS <- jmvcore::OptionBool$new(
                "calculateOS",
                calculateOS,
                default=TRUE)
            private$..calculateTTP <- jmvcore::OptionBool$new(
                "calculateTTP",
                calculateTTP,
                default=FALSE)
            private$..calculateDOR <- jmvcore::OptionBool$new(
                "calculateDOR",
                calculateDOR,
                default=FALSE)
            private$..calculateTOT <- jmvcore::OptionBool$new(
                "calculateTOT",
                calculateTOT,
                default=FALSE)
            private$..showDerivedData <- jmvcore::OptionBool$new(
                "showDerivedData",
                showDerivedData,
                default=TRUE)
            private$..showSummaryStats <- jmvcore::OptionBool$new(
                "showSummaryStats",
                showSummaryStats,
                default=TRUE)
            private$..showEventRates <- jmvcore::OptionBool$new(
                "showEventRates",
                showEventRates,
                default=TRUE)
            private$..showKMPlot <- jmvcore::OptionBool$new(
                "showKMPlot",
                showKMPlot,
                default=TRUE)
            private$..showMilestones <- jmvcore::OptionBool$new(
                "showMilestones",
                showMilestones,
                default=FALSE)
            private$..milestones <- jmvcore::OptionString$new(
                "milestones",
                milestones,
                default="6,12,24")
            private$..exportEndpoints <- jmvcore::OptionBool$new(
                "exportEndpoints",
                exportEndpoints,
                default=FALSE)
            private$..showUsageGuide <- jmvcore::OptionBool$new(
                "showUsageGuide",
                showUsageGuide,
                default=TRUE)

            self$.addOption(private$..patientId)
            self$.addOption(private$..startDate)
            self$.addOption(private$..lastFollowup)
            self$.addOption(private$..deathEvent)
            self$.addOption(private$..progressionEvent)
            self$.addOption(private$..treatmentEnd)
            self$.addOption(private$..responseDate)
            self$.addOption(private$..timeUnit)
            self$.addOption(private$..inputType)
            self$.addOption(private$..calculatePFS)
            self$.addOption(private$..calculateOS)
            self$.addOption(private$..calculateTTP)
            self$.addOption(private$..calculateDOR)
            self$.addOption(private$..calculateTOT)
            self$.addOption(private$..showDerivedData)
            self$.addOption(private$..showSummaryStats)
            self$.addOption(private$..showEventRates)
            self$.addOption(private$..showKMPlot)
            self$.addOption(private$..showMilestones)
            self$.addOption(private$..milestones)
            self$.addOption(private$..exportEndpoints)
            self$.addOption(private$..showUsageGuide)
        }),
    active = list(
        patientId = function() private$..patientId$value,
        startDate = function() private$..startDate$value,
        lastFollowup = function() private$..lastFollowup$value,
        deathEvent = function() private$..deathEvent$value,
        progressionEvent = function() private$..progressionEvent$value,
        treatmentEnd = function() private$..treatmentEnd$value,
        responseDate = function() private$..responseDate$value,
        timeUnit = function() private$..timeUnit$value,
        inputType = function() private$..inputType$value,
        calculatePFS = function() private$..calculatePFS$value,
        calculateOS = function() private$..calculateOS$value,
        calculateTTP = function() private$..calculateTTP$value,
        calculateDOR = function() private$..calculateDOR$value,
        calculateTOT = function() private$..calculateTOT$value,
        showDerivedData = function() private$..showDerivedData$value,
        showSummaryStats = function() private$..showSummaryStats$value,
        showEventRates = function() private$..showEventRates$value,
        showKMPlot = function() private$..showKMPlot$value,
        showMilestones = function() private$..showMilestones$value,
        milestones = function() private$..milestones$value,
        exportEndpoints = function() private$..exportEndpoints$value,
        showUsageGuide = function() private$..showUsageGuide$value),
    private = list(
        ..patientId = NA,
        ..startDate = NA,
        ..lastFollowup = NA,
        ..deathEvent = NA,
        ..progressionEvent = NA,
        ..treatmentEnd = NA,
        ..responseDate = NA,
        ..timeUnit = NA,
        ..inputType = NA,
        ..calculatePFS = NA,
        ..calculateOS = NA,
        ..calculateTTP = NA,
        ..calculateDOR = NA,
        ..calculateTOT = NA,
        ..showDerivedData = NA,
        ..showSummaryStats = NA,
        ..showEventRates = NA,
        ..showKMPlot = NA,
        ..showMilestones = NA,
        ..milestones = NA,
        ..exportEndpoints = NA,
        ..showUsageGuide = NA)
)

survivalendpointsResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "survivalendpointsResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        dataInfo = function() private$.items[["dataInfo"]],
        derivedEndpoints = function() private$.items[["derivedEndpoints"]],
        summaryStats = function() private$.items[["summaryStats"]],
        eventRates = function() private$.items[["eventRates"]],
        milestoneTable = function() private$.items[["milestoneTable"]],
        kmPlot = function() private$.items[["kmPlot"]],
        usageGuide = function() private$.items[["usageGuide"]],
        exportMessage = function() private$.items[["exportMessage"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Survival Endpoint Derivation")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="dataInfo",
                title="Data Summary",
                rows=0,
                clearWith=list(
                    "patientId",
                    "startDate",
                    "lastFollowup"),
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="derivedEndpoints",
                title="Derived Survival Endpoints",
                visible="(showDerivedData)",
                clearWith=list(
                    "patientId",
                    "startDate",
                    "lastFollowup",
                    "deathEvent",
                    "progressionEvent"),
                rows=0,
                columns=list(
                    list(
                        `name`="patientId", 
                        `title`="Patient ID", 
                        `type`="text"),
                    list(
                        `name`="pfs_time", 
                        `title`="PFS Time", 
                        `type`="number", 
                        `format`="dp:2", 
                        `visible`="(calculatePFS)"),
                    list(
                        `name`="pfs_event", 
                        `title`="PFS Event", 
                        `type`="integer", 
                        `visible`="(calculatePFS)"),
                    list(
                        `name`="os_time", 
                        `title`="OS Time", 
                        `type`="number", 
                        `format`="dp:2", 
                        `visible`="(calculateOS)"),
                    list(
                        `name`="os_event", 
                        `title`="OS Event", 
                        `type`="integer", 
                        `visible`="(calculateOS)"),
                    list(
                        `name`="ttp_time", 
                        `title`="TTP Time", 
                        `type`="number", 
                        `format`="dp:2", 
                        `visible`="(calculateTTP)"),
                    list(
                        `name`="ttp_event", 
                        `title`="TTP Event", 
                        `type`="integer", 
                        `visible`="(calculateTTP)"),
                    list(
                        `name`="dor_time", 
                        `title`="DOR Time", 
                        `type`="number", 
                        `format`="dp:2", 
                        `visible`="(calculateDOR)"),
                    list(
                        `name`="dor_event", 
                        `title`="DOR Event", 
                        `type`="integer", 
                        `visible`="(calculateDOR)"),
                    list(
                        `name`="tot_time", 
                        `title`="Time on Treatment", 
                        `type`="number", 
                        `format`="dp:2", 
                        `visible`="(calculateTOT)"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="summaryStats",
                title="Summary Statistics by Endpoint",
                visible="(showSummaryStats)",
                clearWith=list(
                    "calculatePFS",
                    "calculateOS",
                    "calculateTTP",
                    "calculateDOR"),
                rows=0,
                columns=list(
                    list(
                        `name`="endpoint", 
                        `title`="Endpoint", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="censored", 
                        `title`="Censored", 
                        `type`="integer"),
                    list(
                        `name`="median_time", 
                        `title`="Median Time", 
                        `type`="number", 
                        `format`="dp:2"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="dp:2"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="dp:2"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="eventRates",
                title="Event Rates and Censoring",
                visible="(showEventRates)",
                clearWith=list(
                    "calculatePFS",
                    "calculateOS"),
                rows=0,
                columns=list(
                    list(
                        `name`="endpoint", 
                        `title`="Endpoint", 
                        `type`="text"),
                    list(
                        `name`="total", 
                        `title`="Total Patients", 
                        `type`="integer"),
                    list(
                        `name`="events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="event_rate", 
                        `title`="Event Rate (%)", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="censoring_rate", 
                        `title`="Censoring Rate (%)", 
                        `type`="number", 
                        `format`="dp:1"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="milestoneTable",
                title="Milestone Survival Analysis",
                visible="(showMilestones)",
                clearWith=list(
                    "milestones",
                    "calculatePFS",
                    "calculateOS"),
                rows=0,
                columns=list(
                    list(
                        `name`="endpoint", 
                        `title`="Endpoint", 
                        `type`="text"),
                    list(
                        `name`="milestone", 
                        `title`="Milestone Time", 
                        `type`="number", 
                        `format`="dp:1"),
                    list(
                        `name`="survival_prob", 
                        `title`="Survival Probability", 
                        `type`="number", 
                        `format`="dp:3"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="dp:3"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="dp:3"),
                    list(
                        `name`="n_at_risk", 
                        `title`="N at Risk", 
                        `type`="integer"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="kmPlot",
                title="Kaplan-Meier Curves",
                visible="(showKMPlot)",
                renderFun=".kmPlot",
                clearWith=list(
                    "calculatePFS",
                    "calculateOS",
                    "calculateTTP"),
                width=700,
                height=500))
            self$add(jmvcore::Html$new(
                options=options,
                name="usageGuide",
                title="Usage Guide for Survival Analysis",
                visible="(showUsageGuide)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="exportMessage",
                title="Export Information",
                visible="(exportEndpoints)"))}))

survivalendpointsBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "survivalendpointsBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "survivalendpoints",
                version = c(0,0,32),
                options = options,
                results = survivalendpointsResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Survival Endpoint Derivation
#'
#' Derives common survival endpoints (PFS, OS, TTP, DOR) from clinical trial 
#' timeline data. Automatically calculates time-to-event and event status 
#' variables for use in survival analysis. Designed for seamless integration 
#' with swimmer/waterfall plot data.
#' 
#'
#' @examples
#' data <- data.frame(
#'     patient = c("P01", "P02", "P03"),
#'     start_date = as.Date(c("2023-01-01", "2023-02-01", "2023-03-01")),
#'     end_date = as.Date(c("2023-06-15", "2023-08-20", "2023-09-10")),
#'     last_followup = as.Date(c("2024-01-01", "2023-12-01", "2024-02-01")),
#'     death = c(0, 1, 0),
#'     progression = c(1, 1, 0)
#' )
#'
#' survivalendpoints(
#'     data = data,
#'     patientId = "patient",
#'     startDate = "start_date",
#'     lastFollowup = "last_followup",
#'     deathEvent = "death",
#'     progressionEvent = "progression"
#' )
#'
#' @param data the data as a data frame
#' @param patientId Patient identifier variable
#' @param startDate Treatment start date or baseline time (Date or numeric)
#' @param lastFollowup Last follow-up date or time
#' @param deathEvent Death event indicator (0=alive, 1=dead)
#' @param progressionEvent Disease progression indicator (0=no progression,
#'   1=progression)
#' @param treatmentEnd Treatment end date (optional, for time on treatment
#'   calculation)
#' @param responseDate Date of confirmed response (optional, for DOR
#'   calculation)
#' @param timeUnit Unit for time calculations (for numeric time variables)
#' @param inputType Type of input data (dates or numeric time values)
#' @param calculatePFS Calculate progression-free survival (time to
#'   progression or death)
#' @param calculateOS Calculate overall survival (time to death)
#' @param calculateTTP Calculate time to progression (censors death without
#'   progression)
#' @param calculateDOR Calculate duration of response (requires response date)
#' @param calculateTOT Calculate time on treatment (requires treatment end
#'   date)
#' @param showDerivedData Display table with all derived survival endpoints
#' @param showSummaryStats Display summary statistics for each endpoint
#' @param showEventRates Display event rates and censoring proportions
#' @param showKMPlot Display simple Kaplan-Meier curves for derived endpoints
#' @param showMilestones Calculate survival at specific time milestones
#' @param milestones Comma-separated milestone times (in selected time unit)
#' @param exportEndpoints Export derived endpoints to CSV for use in survival
#'   modules
#' @param showUsageGuide Display guide for using derived endpoints in survival
#'   analysis
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$dataInfo} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$derivedEndpoints} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$summaryStats} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$eventRates} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$milestoneTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$kmPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$usageGuide} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$exportMessage} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$dataInfo$asDF}
#'
#' \code{as.data.frame(results$dataInfo)}
#'
#' @export
survivalendpoints <- function(
    data,
    patientId,
    startDate,
    lastFollowup,
    deathEvent,
    progressionEvent,
    treatmentEnd,
    responseDate,
    timeUnit = "months",
    inputType = "dates",
    calculatePFS = TRUE,
    calculateOS = TRUE,
    calculateTTP = FALSE,
    calculateDOR = FALSE,
    calculateTOT = FALSE,
    showDerivedData = TRUE,
    showSummaryStats = TRUE,
    showEventRates = TRUE,
    showKMPlot = TRUE,
    showMilestones = FALSE,
    milestones = "6,12,24",
    exportEndpoints = FALSE,
    showUsageGuide = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("survivalendpoints requires jmvcore to be installed (restart may be required)")

    if ( ! missing(patientId)) patientId <- jmvcore::resolveQuo(jmvcore::enquo(patientId))
    if ( ! missing(startDate)) startDate <- jmvcore::resolveQuo(jmvcore::enquo(startDate))
    if ( ! missing(lastFollowup)) lastFollowup <- jmvcore::resolveQuo(jmvcore::enquo(lastFollowup))
    if ( ! missing(deathEvent)) deathEvent <- jmvcore::resolveQuo(jmvcore::enquo(deathEvent))
    if ( ! missing(progressionEvent)) progressionEvent <- jmvcore::resolveQuo(jmvcore::enquo(progressionEvent))
    if ( ! missing(treatmentEnd)) treatmentEnd <- jmvcore::resolveQuo(jmvcore::enquo(treatmentEnd))
    if ( ! missing(responseDate)) responseDate <- jmvcore::resolveQuo(jmvcore::enquo(responseDate))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(patientId), patientId, NULL),
            `if`( ! missing(startDate), startDate, NULL),
            `if`( ! missing(lastFollowup), lastFollowup, NULL),
            `if`( ! missing(deathEvent), deathEvent, NULL),
            `if`( ! missing(progressionEvent), progressionEvent, NULL),
            `if`( ! missing(treatmentEnd), treatmentEnd, NULL),
            `if`( ! missing(responseDate), responseDate, NULL))


    options <- survivalendpointsOptions$new(
        patientId = patientId,
        startDate = startDate,
        lastFollowup = lastFollowup,
        deathEvent = deathEvent,
        progressionEvent = progressionEvent,
        treatmentEnd = treatmentEnd,
        responseDate = responseDate,
        timeUnit = timeUnit,
        inputType = inputType,
        calculatePFS = calculatePFS,
        calculateOS = calculateOS,
        calculateTTP = calculateTTP,
        calculateDOR = calculateDOR,
        calculateTOT = calculateTOT,
        showDerivedData = showDerivedData,
        showSummaryStats = showSummaryStats,
        showEventRates = showEventRates,
        showKMPlot = showKMPlot,
        showMilestones = showMilestones,
        milestones = milestones,
        exportEndpoints = exportEndpoints,
        showUsageGuide = showUsageGuide)

    analysis <- survivalendpointsClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

