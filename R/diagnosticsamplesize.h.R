
# This file is automatically generated, you probably don't want to edit this

diagnosticsamplesizeOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "diagnosticsamplesizeOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            study_purpose = "diagnostic",
            target_sensitivity = 0.9,
            target_specificity = 0.9,
            prevalence = 0.1,
            ci_width = 0.1,
            alpha = 0.05,
            nonresponse_rate = 0,
            show_statement = TRUE,
            show_methodology = TRUE,
            show_references = FALSE,
            show_comparison_table = FALSE,
            comparison_prevalences = "0.05, 0.10, 0.20, 0.30, 0.50",
            show_method_comparison = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="diagnosticsamplesize",
                requiresData=FALSE,
                ...)

            private$..study_purpose <- jmvcore::OptionList$new(
                "study_purpose",
                study_purpose,
                options=list(
                    "diagnostic",
                    "screening_sens",
                    "screening_spec"),
                default="diagnostic")
            private$..target_sensitivity <- jmvcore::OptionNumber$new(
                "target_sensitivity",
                target_sensitivity,
                min=0.5,
                max=0.99,
                default=0.9)
            private$..target_specificity <- jmvcore::OptionNumber$new(
                "target_specificity",
                target_specificity,
                min=0.5,
                max=0.99,
                default=0.9)
            private$..prevalence <- jmvcore::OptionNumber$new(
                "prevalence",
                prevalence,
                min=0.01,
                max=0.99,
                default=0.1)
            private$..ci_width <- jmvcore::OptionNumber$new(
                "ci_width",
                ci_width,
                min=0.05,
                max=0.3,
                default=0.1)
            private$..alpha <- jmvcore::OptionNumber$new(
                "alpha",
                alpha,
                min=0.01,
                max=0.1,
                default=0.05)
            private$..nonresponse_rate <- jmvcore::OptionNumber$new(
                "nonresponse_rate",
                nonresponse_rate,
                min=0,
                max=50,
                default=0)
            private$..show_statement <- jmvcore::OptionBool$new(
                "show_statement",
                show_statement,
                default=TRUE)
            private$..show_methodology <- jmvcore::OptionBool$new(
                "show_methodology",
                show_methodology,
                default=TRUE)
            private$..show_references <- jmvcore::OptionBool$new(
                "show_references",
                show_references,
                default=FALSE)
            private$..show_comparison_table <- jmvcore::OptionBool$new(
                "show_comparison_table",
                show_comparison_table,
                default=FALSE)
            private$..comparison_prevalences <- jmvcore::OptionString$new(
                "comparison_prevalences",
                comparison_prevalences,
                default="0.05, 0.10, 0.20, 0.30, 0.50")
            private$..show_method_comparison <- jmvcore::OptionBool$new(
                "show_method_comparison",
                show_method_comparison,
                default=FALSE)

            self$.addOption(private$..study_purpose)
            self$.addOption(private$..target_sensitivity)
            self$.addOption(private$..target_specificity)
            self$.addOption(private$..prevalence)
            self$.addOption(private$..ci_width)
            self$.addOption(private$..alpha)
            self$.addOption(private$..nonresponse_rate)
            self$.addOption(private$..show_statement)
            self$.addOption(private$..show_methodology)
            self$.addOption(private$..show_references)
            self$.addOption(private$..show_comparison_table)
            self$.addOption(private$..comparison_prevalences)
            self$.addOption(private$..show_method_comparison)
        }),
    active = list(
        study_purpose = function() private$..study_purpose$value,
        target_sensitivity = function() private$..target_sensitivity$value,
        target_specificity = function() private$..target_specificity$value,
        prevalence = function() private$..prevalence$value,
        ci_width = function() private$..ci_width$value,
        alpha = function() private$..alpha$value,
        nonresponse_rate = function() private$..nonresponse_rate$value,
        show_statement = function() private$..show_statement$value,
        show_methodology = function() private$..show_methodology$value,
        show_references = function() private$..show_references$value,
        show_comparison_table = function() private$..show_comparison_table$value,
        comparison_prevalences = function() private$..comparison_prevalences$value,
        show_method_comparison = function() private$..show_method_comparison$value),
    private = list(
        ..study_purpose = NA,
        ..target_sensitivity = NA,
        ..target_specificity = NA,
        ..prevalence = NA,
        ..ci_width = NA,
        ..alpha = NA,
        ..nonresponse_rate = NA,
        ..show_statement = NA,
        ..show_methodology = NA,
        ..show_references = NA,
        ..show_comparison_table = NA,
        ..comparison_prevalences = NA,
        ..show_method_comparison = NA)
)

diagnosticsamplesizeResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "diagnosticsamplesizeResults",
    inherit = jmvcore::Group,
    active = list(
        sample_size_summary = function() private$.items[["sample_size_summary"]],
        sample_size_statement = function() private$.items[["sample_size_statement"]],
        prevalence_table = function() private$.items[["prevalence_table"]],
        method_comparison = function() private$.items[["method_comparison"]],
        methodology = function() private$.items[["methodology"]],
        references = function() private$.items[["references"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Diagnostic Test Sample Size Calculator")
            self$add(jmvcore::Table$new(
                options=options,
                name="sample_size_summary",
                title="Sample Size Calculation Results",
                rows=0,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="target_value", 
                        `title`="Target Value", 
                        `type`="number"),
                    list(
                        `name`="n_cases", 
                        `title`="N (Cases/Controls)", 
                        `type`="integer"),
                    list(
                        `name`="n_total", 
                        `title`="Total N Required", 
                        `type`="integer"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="sample_size_statement",
                title="Sample Size Justification Statement",
                visible="(show_statement)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="prevalence_table",
                title="Sample Size Across Prevalence Levels",
                visible="(show_comparison_table)",
                rows=0,
                columns=list(
                    list(
                        `name`="prevalence", 
                        `title`="Prevalence", 
                        `type`="number"),
                    list(
                        `name`="n_sens_total", 
                        `title`="N for Sensitivity", 
                        `type`="integer"),
                    list(
                        `name`="n_spec_total", 
                        `title`="N for Specificity", 
                        `type`="integer"),
                    list(
                        `name`="n_required", 
                        `title`="Required N (Max)", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="method_comparison",
                title="CI Method Comparison",
                visible="(show_method_comparison)",
                rows=0,
                columns=list(
                    list(
                        `name`="method", 
                        `title`="CI Method", 
                        `type`="text"),
                    list(
                        `name`="n_sensitivity", 
                        `title`="N for Sensitivity", 
                        `type`="integer"),
                    list(
                        `name`="n_specificity", 
                        `title`="N for Specificity", 
                        `type`="integer"),
                    list(
                        `name`="n_total", 
                        `title`="Total N Required", 
                        `type`="integer"),
                    list(
                        `name`="relative_efficiency", 
                        `title`="Relative Efficiency (%)", 
                        `type`="number"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodology",
                title="Methodology",
                visible="(show_methodology)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="references",
                title="References",
                visible="(show_references)"))}))

diagnosticsamplesizeBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "diagnosticsamplesizeBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "diagnosticsamplesize",
                version = c(1,0,0),
                options = options,
                results = diagnosticsamplesizeResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'na')
        }))

#' Diagnostic Test Sample Size Calculator
#'
#' 
#' @param study_purpose .
#' @param target_sensitivity .
#' @param target_specificity .
#' @param prevalence .
#' @param ci_width .
#' @param alpha .
#' @param nonresponse_rate .
#' @param show_statement .
#' @param show_methodology .
#' @param show_references .
#' @param show_comparison_table .
#' @param comparison_prevalences .
#' @param show_method_comparison .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$sample_size_summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$sample_size_statement} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$prevalence_table} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$method_comparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$methodology} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$references} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$sample_size_summary$asDF}
#'
#' \code{as.data.frame(results$sample_size_summary)}
#'
#' @export
diagnosticsamplesize <- function(
    study_purpose = "diagnostic",
    target_sensitivity = 0.9,
    target_specificity = 0.9,
    prevalence = 0.1,
    ci_width = 0.1,
    alpha = 0.05,
    nonresponse_rate = 0,
    show_statement = TRUE,
    show_methodology = TRUE,
    show_references = FALSE,
    show_comparison_table = FALSE,
    comparison_prevalences = "0.05, 0.10, 0.20, 0.30, 0.50",
    show_method_comparison = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("diagnosticsamplesize requires jmvcore to be installed (restart may be required)")


    options <- diagnosticsamplesizeOptions$new(
        study_purpose = study_purpose,
        target_sensitivity = target_sensitivity,
        target_specificity = target_specificity,
        prevalence = prevalence,
        ci_width = ci_width,
        alpha = alpha,
        nonresponse_rate = nonresponse_rate,
        show_statement = show_statement,
        show_methodology = show_methodology,
        show_references = show_references,
        show_comparison_table = show_comparison_table,
        comparison_prevalences = comparison_prevalences,
        show_method_comparison = show_method_comparison)

    analysis <- diagnosticsamplesizeClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

