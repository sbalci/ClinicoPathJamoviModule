
# This file is automatically generated, you probably don't want to edit this

mixedeffectscoxOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "mixedeffectscoxOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            outcome = NULL,
            fixed_effects = NULL,
            random_effects = NULL,
            outcomeLevel = "1",
            random_structure = "random_intercept",
            correlation_structure = "independent",
            variance_structure = "homoscedastic",
            estimation_method = "reml",
            sparse_matrix = TRUE,
            ties_method = "efron",
            offset_variable = NULL,
            weights_variable = NULL,
            confidence_level = 0.95,
            max_iterations = 100,
            convergence_tolerance = 0.000001,
            random_effects_prediction = TRUE,
            variance_components_test = TRUE,
            bootstrap_ci = FALSE,
            bootstrap_samples = 500,
            show_model_summary = TRUE,
            show_fixed_effects = TRUE,
            show_random_effects = TRUE,
            show_diagnostics = TRUE,
            show_comparison = TRUE,
            show_residual_plots = TRUE,
            show_random_effects_plots = TRUE,
            show_survival_plots = TRUE,
            show_forest_plot = TRUE,
            showSummaries = FALSE,
            showExplanations = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="mixedeffectscox",
                requiresData=TRUE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..fixed_effects <- jmvcore::OptionVariables$new(
                "fixed_effects",
                fixed_effects,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..random_effects <- jmvcore::OptionVariables$new(
                "random_effects",
                random_effects,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..outcomeLevel <- jmvcore::OptionString$new(
                "outcomeLevel",
                outcomeLevel,
                default="1")
            private$..random_structure <- jmvcore::OptionList$new(
                "random_structure",
                random_structure,
                options=list(
                    "random_intercept",
                    "random_slope",
                    "random_intercept_slope",
                    "nested_random",
                    "crossed_random"),
                default="random_intercept")
            private$..correlation_structure <- jmvcore::OptionList$new(
                "correlation_structure",
                correlation_structure,
                options=list(
                    "independent",
                    "exchangeable",
                    "ar1",
                    "unstructured"),
                default="independent")
            private$..variance_structure <- jmvcore::OptionList$new(
                "variance_structure",
                variance_structure,
                options=list(
                    "homoscedastic",
                    "heteroscedastic_group",
                    "power_variance",
                    "exponential_variance"),
                default="homoscedastic")
            private$..estimation_method <- jmvcore::OptionList$new(
                "estimation_method",
                estimation_method,
                options=list(
                    "reml",
                    "ml",
                    "penalized",
                    "laplace"),
                default="reml")
            private$..sparse_matrix <- jmvcore::OptionBool$new(
                "sparse_matrix",
                sparse_matrix,
                default=TRUE)
            private$..ties_method <- jmvcore::OptionList$new(
                "ties_method",
                ties_method,
                options=list(
                    "efron",
                    "breslow",
                    "exact"),
                default="efron")
            private$..offset_variable <- jmvcore::OptionVariable$new(
                "offset_variable",
                offset_variable,
                permitted=list(
                    "numeric"))
            private$..weights_variable <- jmvcore::OptionVariable$new(
                "weights_variable",
                weights_variable,
                permitted=list(
                    "numeric"))
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..max_iterations <- jmvcore::OptionNumber$new(
                "max_iterations",
                max_iterations,
                min=10,
                max=1000,
                default=100)
            private$..convergence_tolerance <- jmvcore::OptionNumber$new(
                "convergence_tolerance",
                convergence_tolerance,
                min=1e-8,
                max=0.01,
                default=0.000001)
            private$..random_effects_prediction <- jmvcore::OptionBool$new(
                "random_effects_prediction",
                random_effects_prediction,
                default=TRUE)
            private$..variance_components_test <- jmvcore::OptionBool$new(
                "variance_components_test",
                variance_components_test,
                default=TRUE)
            private$..bootstrap_ci <- jmvcore::OptionBool$new(
                "bootstrap_ci",
                bootstrap_ci,
                default=FALSE)
            private$..bootstrap_samples <- jmvcore::OptionNumber$new(
                "bootstrap_samples",
                bootstrap_samples,
                min=100,
                max=2000,
                default=500)
            private$..show_model_summary <- jmvcore::OptionBool$new(
                "show_model_summary",
                show_model_summary,
                default=TRUE)
            private$..show_fixed_effects <- jmvcore::OptionBool$new(
                "show_fixed_effects",
                show_fixed_effects,
                default=TRUE)
            private$..show_random_effects <- jmvcore::OptionBool$new(
                "show_random_effects",
                show_random_effects,
                default=TRUE)
            private$..show_diagnostics <- jmvcore::OptionBool$new(
                "show_diagnostics",
                show_diagnostics,
                default=TRUE)
            private$..show_comparison <- jmvcore::OptionBool$new(
                "show_comparison",
                show_comparison,
                default=TRUE)
            private$..show_residual_plots <- jmvcore::OptionBool$new(
                "show_residual_plots",
                show_residual_plots,
                default=TRUE)
            private$..show_random_effects_plots <- jmvcore::OptionBool$new(
                "show_random_effects_plots",
                show_random_effects_plots,
                default=TRUE)
            private$..show_survival_plots <- jmvcore::OptionBool$new(
                "show_survival_plots",
                show_survival_plots,
                default=TRUE)
            private$..show_forest_plot <- jmvcore::OptionBool$new(
                "show_forest_plot",
                show_forest_plot,
                default=TRUE)
            private$..showSummaries <- jmvcore::OptionBool$new(
                "showSummaries",
                showSummaries,
                default=FALSE)
            private$..showExplanations <- jmvcore::OptionBool$new(
                "showExplanations",
                showExplanations,
                default=FALSE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..outcome)
            self$.addOption(private$..fixed_effects)
            self$.addOption(private$..random_effects)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..random_structure)
            self$.addOption(private$..correlation_structure)
            self$.addOption(private$..variance_structure)
            self$.addOption(private$..estimation_method)
            self$.addOption(private$..sparse_matrix)
            self$.addOption(private$..ties_method)
            self$.addOption(private$..offset_variable)
            self$.addOption(private$..weights_variable)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..max_iterations)
            self$.addOption(private$..convergence_tolerance)
            self$.addOption(private$..random_effects_prediction)
            self$.addOption(private$..variance_components_test)
            self$.addOption(private$..bootstrap_ci)
            self$.addOption(private$..bootstrap_samples)
            self$.addOption(private$..show_model_summary)
            self$.addOption(private$..show_fixed_effects)
            self$.addOption(private$..show_random_effects)
            self$.addOption(private$..show_diagnostics)
            self$.addOption(private$..show_comparison)
            self$.addOption(private$..show_residual_plots)
            self$.addOption(private$..show_random_effects_plots)
            self$.addOption(private$..show_survival_plots)
            self$.addOption(private$..show_forest_plot)
            self$.addOption(private$..showSummaries)
            self$.addOption(private$..showExplanations)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        outcome = function() private$..outcome$value,
        fixed_effects = function() private$..fixed_effects$value,
        random_effects = function() private$..random_effects$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        random_structure = function() private$..random_structure$value,
        correlation_structure = function() private$..correlation_structure$value,
        variance_structure = function() private$..variance_structure$value,
        estimation_method = function() private$..estimation_method$value,
        sparse_matrix = function() private$..sparse_matrix$value,
        ties_method = function() private$..ties_method$value,
        offset_variable = function() private$..offset_variable$value,
        weights_variable = function() private$..weights_variable$value,
        confidence_level = function() private$..confidence_level$value,
        max_iterations = function() private$..max_iterations$value,
        convergence_tolerance = function() private$..convergence_tolerance$value,
        random_effects_prediction = function() private$..random_effects_prediction$value,
        variance_components_test = function() private$..variance_components_test$value,
        bootstrap_ci = function() private$..bootstrap_ci$value,
        bootstrap_samples = function() private$..bootstrap_samples$value,
        show_model_summary = function() private$..show_model_summary$value,
        show_fixed_effects = function() private$..show_fixed_effects$value,
        show_random_effects = function() private$..show_random_effects$value,
        show_diagnostics = function() private$..show_diagnostics$value,
        show_comparison = function() private$..show_comparison$value,
        show_residual_plots = function() private$..show_residual_plots$value,
        show_random_effects_plots = function() private$..show_random_effects_plots$value,
        show_survival_plots = function() private$..show_survival_plots$value,
        show_forest_plot = function() private$..show_forest_plot$value,
        showSummaries = function() private$..showSummaries$value,
        showExplanations = function() private$..showExplanations$value),
    private = list(
        ..elapsedtime = NA,
        ..outcome = NA,
        ..fixed_effects = NA,
        ..random_effects = NA,
        ..outcomeLevel = NA,
        ..random_structure = NA,
        ..correlation_structure = NA,
        ..variance_structure = NA,
        ..estimation_method = NA,
        ..sparse_matrix = NA,
        ..ties_method = NA,
        ..offset_variable = NA,
        ..weights_variable = NA,
        ..confidence_level = NA,
        ..max_iterations = NA,
        ..convergence_tolerance = NA,
        ..random_effects_prediction = NA,
        ..variance_components_test = NA,
        ..bootstrap_ci = NA,
        ..bootstrap_samples = NA,
        ..show_model_summary = NA,
        ..show_fixed_effects = NA,
        ..show_random_effects = NA,
        ..show_diagnostics = NA,
        ..show_comparison = NA,
        ..show_residual_plots = NA,
        ..show_random_effects_plots = NA,
        ..show_survival_plots = NA,
        ..show_forest_plot = NA,
        ..showSummaries = NA,
        ..showExplanations = NA)
)

mixedeffectscoxResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "mixedeffectscoxResults",
    inherit = jmvcore::Group,
    active = list(
        modelSummary = function() private$.items[["modelSummary"]],
        fixedEffects = function() private$.items[["fixedEffects"]],
        randomEffects = function() private$.items[["randomEffects"]],
        varianceComponents = function() private$.items[["varianceComponents"]],
        randomEffectsPredictions = function() private$.items[["randomEffectsPredictions"]],
        diagnostics = function() private$.items[["diagnostics"]],
        modelComparison = function() private$.items[["modelComparison"]],
        convergenceInfo = function() private$.items[["convergenceInfo"]],
        hierarchicalStructure = function() private$.items[["hierarchicalStructure"]],
        iccAnalysis = function() private$.items[["iccAnalysis"]],
        residualPlots = function() private$.items[["residualPlots"]],
        randomEffectsPlots = function() private$.items[["randomEffectsPlots"]],
        survivalPlots = function() private$.items[["survivalPlots"]],
        forestPlot = function() private$.items[["forestPlot"]],
        clusterAnalysisPlots = function() private$.items[["clusterAnalysisPlots"]],
        summaryTable = function() private$.items[["summaryTable"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Mixed-Effects Cox Models")
            self$add(jmvcore::Table$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                visible="(show_model_summary)",
                columns=list(
                    list(
                        `name`="term", 
                        `title`="", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text")),
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "fixed_effects",
                    "random_effects",
                    "random_structure",
                    "estimation_method")))
            self$add(jmvcore::Table$new(
                options=options,
                name="fixedEffects",
                title="Fixed Effects Coefficients",
                visible="(show_fixed_effects)",
                columns=list(
                    list(
                        `name`="term", 
                        `title`="Term", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="z", 
                        `title`="z", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="pvalue", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="ciLower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ciUpper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="hazard_ratio", 
                        `title`="HR", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="hr_lower", 
                        `title`="HR Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="hr_upper", 
                        `title`="HR Upper", 
                        `type`="number", 
                        `format`="zto")),
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "fixed_effects",
                    "random_effects",
                    "random_structure",
                    "estimation_method")))
            self$add(jmvcore::Table$new(
                options=options,
                name="randomEffects",
                title="Random Effects and Variance Components",
                visible="(show_random_effects)",
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="variance", 
                        `title`="Variance", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="std_dev", 
                        `title`="Std Dev", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="proportion", 
                        `title`="Proportion of Total", 
                        `type`="number", 
                        `format`="zto,pc"),
                    list(
                        `name`="icc", 
                        `title`="ICC", 
                        `type`="number", 
                        `format`="zto")),
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "fixed_effects",
                    "random_effects",
                    "random_structure",
                    "estimation_method")))
            self$add(jmvcore::Table$new(
                options=options,
                name="varianceComponents",
                title="Variance Components Tests",
                visible="(show_random_effects && variance_components_test)",
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="chi_square", 
                        `title`="Chi-square", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="pvalue", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="significance", 
                        `title`="Significance", 
                        `type`="text")),
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "fixed_effects",
                    "random_effects",
                    "random_structure",
                    "estimation_method")))
            self$add(jmvcore::Table$new(
                options=options,
                name="randomEffectsPredictions",
                title="Random Effects Predictions (BLUPs)",
                visible="(show_random_effects && random_effects_prediction)",
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="blup", 
                        `title`="BLUP", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="se_blup", 
                        `title`="SE(BLUP)", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="pred_lower", 
                        `title`="Lower PI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="pred_upper", 
                        `title`="Upper PI", 
                        `type`="number", 
                        `format`="zto")),
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "fixed_effects",
                    "random_effects",
                    "random_structure",
                    "estimation_method")))
            self$add(jmvcore::Table$new(
                options=options,
                name="diagnostics",
                title="Model Diagnostics",
                visible="(show_diagnostics)",
                columns=list(
                    list(
                        `name`="measure", 
                        `title`="Measure", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text")),
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "fixed_effects",
                    "random_effects",
                    "random_structure",
                    "estimation_method")))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelComparison",
                title="Model Comparison",
                visible="(show_comparison)",
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="loglik", 
                        `title`="Log-Likelihood", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="lrt_statistic", 
                        `title`="LRT Statistic", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="lrt_pvalue", 
                        `title`="LRT p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="selected", 
                        `title`="Selected", 
                        `type`="text")),
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "fixed_effects",
                    "random_effects",
                    "random_structure",
                    "estimation_method")))
            self$add(jmvcore::Table$new(
                options=options,
                name="convergenceInfo",
                title="Convergence Information",
                visible="(show_model_summary)",
                columns=list(
                    list(
                        `name`="criterion", 
                        `title`="Criterion", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text")),
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "fixed_effects",
                    "random_effects",
                    "random_structure",
                    "estimation_method")))
            self$add(jmvcore::Table$new(
                options=options,
                name="hierarchicalStructure",
                title="Hierarchical Structure Analysis",
                visible="(show_random_effects)",
                columns=list(
                    list(
                        `name`="level", 
                        `title`="Level", 
                        `type`="text"),
                    list(
                        `name`="groups", 
                        `title`="Number of Groups", 
                        `type`="integer"),
                    list(
                        `name`="observations", 
                        `title`="Observations per Group", 
                        `type`="text"),
                    list(
                        `name`="min_obs", 
                        `title`="Min Obs", 
                        `type`="integer"),
                    list(
                        `name`="max_obs", 
                        `title`="Max Obs", 
                        `type`="integer"),
                    list(
                        `name`="mean_obs", 
                        `title`="Mean Obs", 
                        `type`="number", 
                        `format`="zto")),
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "fixed_effects",
                    "random_effects",
                    "random_structure",
                    "estimation_method")))
            self$add(jmvcore::Table$new(
                options=options,
                name="iccAnalysis",
                title="Intraclass Correlation Analysis",
                visible="(show_random_effects)",
                columns=list(
                    list(
                        `name`="random_effect", 
                        `title`="Random Effect", 
                        `type`="text"),
                    list(
                        `name`="icc", 
                        `title`="ICC", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="icc_lower", 
                        `title`="ICC Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="icc_upper", 
                        `title`="ICC Upper", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text")),
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "fixed_effects",
                    "random_effects",
                    "random_structure",
                    "estimation_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="residualPlots",
                title="Residual Diagnostic Plots",
                width=800,
                height=600,
                visible="(show_residual_plots)",
                renderFun=".plotResiduals",
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "fixed_effects",
                    "random_effects",
                    "random_structure",
                    "estimation_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="randomEffectsPlots",
                title="Random Effects Distribution Plots",
                width=800,
                height=600,
                visible="(show_random_effects_plots)",
                renderFun=".plotRandomEffects",
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "fixed_effects",
                    "random_effects",
                    "random_structure",
                    "estimation_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlots",
                title="Survival Curves by Groups",
                width=800,
                height=600,
                visible="(show_survival_plots)",
                renderFun=".plotSurvival",
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "fixed_effects",
                    "random_effects",
                    "random_structure",
                    "estimation_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="forestPlot",
                title="Forest Plot",
                width=800,
                height=600,
                visible="(show_forest_plot)",
                renderFun=".plotForest",
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "fixed_effects",
                    "random_effects",
                    "random_structure",
                    "estimation_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="clusterAnalysisPlots",
                title="Cluster Analysis Plots",
                width=800,
                height=600,
                visible="(show_random_effects_plots)",
                renderFun=".plotClusterAnalysis",
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "fixed_effects",
                    "random_effects",
                    "random_structure",
                    "estimation_method")))
            self$add(jmvcore::Html$new(
                options=options,
                name="summaryTable",
                title="Analysis Summary",
                visible="(showSummaries)",
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "fixed_effects",
                    "random_effects",
                    "random_structure",
                    "estimation_method")))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Method Explanation",
                visible="(showExplanations)"))}))

mixedeffectscoxBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "mixedeffectscoxBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "mixedeffectscox",
                version = c(1,0,0),
                options = options,
                results = mixedeffectscoxResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Mixed-Effects Cox Models
#'
#' Implements mixed-effects Cox proportional hazards models for hierarchical  
#' survival data with random effects. Accounts for clustering, repeated  
#' measurements, and unobserved heterogeneity using the coxme framework for  
#' multi-level survival analysis in clinical research.
#' 
#'
#' @examples
#' # Mixed-effects Cox model with random intercept
#' mixedeffectscox(
#'     data = hierarchical_data,
#'     elapsedtime = "time",
#'     outcome = "status",
#'     outcomeLevel = "1",
#'     fixed_effects = c("age", "treatment"),
#'     random_effects = c("hospital"),
#'     random_structure = "random_intercept"
#' )
#'
#' @param data the data as a data frame
#' @param elapsedtime Survival time or follow-up duration variable
#' @param outcome Event indicator variable (0/1, FALSE/TRUE, or factor)
#' @param fixed_effects Fixed effect covariates for the Cox model
#' @param random_effects Random effect grouping variables (clusters, subjects)
#' @param outcomeLevel Level of outcome variable indicating event occurrence
#' @param random_structure Structure of random effects in the model
#' @param correlation_structure Correlation structure for random effects
#' @param variance_structure Variance structure specification
#' @param estimation_method Method for estimating variance components
#' @param sparse_matrix Use sparse matrix methods for large datasets
#' @param ties_method Method for handling tied event times
#' @param offset_variable Optional offset variable for the model
#' @param weights_variable Optional case weights variable
#' @param confidence_level Confidence level for intervals
#' @param max_iterations Maximum number of iterations
#' @param convergence_tolerance Convergence tolerance for estimation
#' @param random_effects_prediction Compute and display random effects
#'   predictions (BLUPs)
#' @param variance_components_test Test significance of variance components
#' @param bootstrap_ci Compute bootstrap confidence intervals
#' @param bootstrap_samples Number of bootstrap samples
#' @param show_model_summary Display comprehensive model summary
#' @param show_fixed_effects Display fixed effects coefficients table
#' @param show_random_effects Display random effects and variance components
#' @param show_diagnostics Display model diagnostics
#' @param show_comparison Compare mixed-effects vs standard Cox models
#' @param show_residual_plots Display residual diagnostic plots
#' @param show_random_effects_plots Display random effects distribution plots
#' @param show_survival_plots Display survival curves by groups
#' @param show_forest_plot Display forest plot of hazard ratios
#' @param showSummaries Generate natural language summaries
#' @param showExplanations Show detailed methodology explanations
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$fixedEffects} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$randomEffects} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$varianceComponents} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$randomEffectsPredictions} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$diagnostics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$convergenceInfo} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$hierarchicalStructure} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$iccAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$residualPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$randomEffectsPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$survivalPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$forestPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$clusterAnalysisPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$summaryTable} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelSummary$asDF}
#'
#' \code{as.data.frame(results$modelSummary)}
#'
#' @export
mixedeffectscox <- function(
    data,
    elapsedtime,
    outcome,
    fixed_effects,
    random_effects,
    outcomeLevel = "1",
    random_structure = "random_intercept",
    correlation_structure = "independent",
    variance_structure = "homoscedastic",
    estimation_method = "reml",
    sparse_matrix = TRUE,
    ties_method = "efron",
    offset_variable,
    weights_variable,
    confidence_level = 0.95,
    max_iterations = 100,
    convergence_tolerance = 0.000001,
    random_effects_prediction = TRUE,
    variance_components_test = TRUE,
    bootstrap_ci = FALSE,
    bootstrap_samples = 500,
    show_model_summary = TRUE,
    show_fixed_effects = TRUE,
    show_random_effects = TRUE,
    show_diagnostics = TRUE,
    show_comparison = TRUE,
    show_residual_plots = TRUE,
    show_random_effects_plots = TRUE,
    show_survival_plots = TRUE,
    show_forest_plot = TRUE,
    showSummaries = FALSE,
    showExplanations = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("mixedeffectscox requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(fixed_effects)) fixed_effects <- jmvcore::resolveQuo(jmvcore::enquo(fixed_effects))
    if ( ! missing(random_effects)) random_effects <- jmvcore::resolveQuo(jmvcore::enquo(random_effects))
    if ( ! missing(offset_variable)) offset_variable <- jmvcore::resolveQuo(jmvcore::enquo(offset_variable))
    if ( ! missing(weights_variable)) weights_variable <- jmvcore::resolveQuo(jmvcore::enquo(weights_variable))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(elapsedtime), elapsedtime, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(fixed_effects), fixed_effects, NULL),
            `if`( ! missing(random_effects), random_effects, NULL),
            `if`( ! missing(offset_variable), offset_variable, NULL),
            `if`( ! missing(weights_variable), weights_variable, NULL))


    options <- mixedeffectscoxOptions$new(
        elapsedtime = elapsedtime,
        outcome = outcome,
        fixed_effects = fixed_effects,
        random_effects = random_effects,
        outcomeLevel = outcomeLevel,
        random_structure = random_structure,
        correlation_structure = correlation_structure,
        variance_structure = variance_structure,
        estimation_method = estimation_method,
        sparse_matrix = sparse_matrix,
        ties_method = ties_method,
        offset_variable = offset_variable,
        weights_variable = weights_variable,
        confidence_level = confidence_level,
        max_iterations = max_iterations,
        convergence_tolerance = convergence_tolerance,
        random_effects_prediction = random_effects_prediction,
        variance_components_test = variance_components_test,
        bootstrap_ci = bootstrap_ci,
        bootstrap_samples = bootstrap_samples,
        show_model_summary = show_model_summary,
        show_fixed_effects = show_fixed_effects,
        show_random_effects = show_random_effects,
        show_diagnostics = show_diagnostics,
        show_comparison = show_comparison,
        show_residual_plots = show_residual_plots,
        show_random_effects_plots = show_random_effects_plots,
        show_survival_plots = show_survival_plots,
        show_forest_plot = show_forest_plot,
        showSummaries = showSummaries,
        showExplanations = showExplanations)

    analysis <- mixedeffectscoxClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

