
# This file is automatically generated, you probably don't want to edit this

modelperformanceOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "modelperformanceOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            modelType = "cox",
            outcome = NULL,
            outcomeLevel = NULL,
            timeVar = NULL,
            model1vars = NULL,
            model1name = "Model 1",
            model2vars = NULL,
            model2name = "Model 2",
            model3vars = NULL,
            model3name = "Model 3",
            model4vars = NULL,
            model4name = "Model 4",
            model5vars = NULL,
            model5name = "Model 5",
            showAIC = TRUE,
            showRSquared = TRUE,
            showCIndex = TRUE,
            showLogLik = FALSE,
            showMCC = TRUE,
            crossValidation = FALSE,
            cvFolds = 5,
            showForestPlot = TRUE,
            showROC = FALSE,
            showCalibration = FALSE,
            autoRecommend = TRUE,
            recommendBy = "aic", ...) {

            super$initialize(
                package="ClinicoPath",
                name="modelperformance",
                requiresData=TRUE,
                ...)

            private$..modelType <- jmvcore::OptionList$new(
                "modelType",
                modelType,
                options=list(
                    "cox",
                    "logistic",
                    "linear"),
                default="cox")
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..outcomeLevel <- jmvcore::OptionLevel$new(
                "outcomeLevel",
                outcomeLevel,
                variable="(outcome)")
            private$..timeVar <- jmvcore::OptionVariable$new(
                "timeVar",
                timeVar,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..model1vars <- jmvcore::OptionVariables$new(
                "model1vars",
                model1vars,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..model1name <- jmvcore::OptionString$new(
                "model1name",
                model1name,
                default="Model 1")
            private$..model2vars <- jmvcore::OptionVariables$new(
                "model2vars",
                model2vars,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..model2name <- jmvcore::OptionString$new(
                "model2name",
                model2name,
                default="Model 2")
            private$..model3vars <- jmvcore::OptionVariables$new(
                "model3vars",
                model3vars,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..model3name <- jmvcore::OptionString$new(
                "model3name",
                model3name,
                default="Model 3")
            private$..model4vars <- jmvcore::OptionVariables$new(
                "model4vars",
                model4vars,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..model4name <- jmvcore::OptionString$new(
                "model4name",
                model4name,
                default="Model 4")
            private$..model5vars <- jmvcore::OptionVariables$new(
                "model5vars",
                model5vars,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..model5name <- jmvcore::OptionString$new(
                "model5name",
                model5name,
                default="Model 5")
            private$..showAIC <- jmvcore::OptionBool$new(
                "showAIC",
                showAIC,
                default=TRUE)
            private$..showRSquared <- jmvcore::OptionBool$new(
                "showRSquared",
                showRSquared,
                default=TRUE)
            private$..showCIndex <- jmvcore::OptionBool$new(
                "showCIndex",
                showCIndex,
                default=TRUE)
            private$..showLogLik <- jmvcore::OptionBool$new(
                "showLogLik",
                showLogLik,
                default=FALSE)
            private$..showMCC <- jmvcore::OptionBool$new(
                "showMCC",
                showMCC,
                default=TRUE)
            private$..crossValidation <- jmvcore::OptionBool$new(
                "crossValidation",
                crossValidation,
                default=FALSE)
            private$..cvFolds <- jmvcore::OptionInteger$new(
                "cvFolds",
                cvFolds,
                default=5,
                min=3,
                max=10)
            private$..showForestPlot <- jmvcore::OptionBool$new(
                "showForestPlot",
                showForestPlot,
                default=TRUE)
            private$..showROC <- jmvcore::OptionBool$new(
                "showROC",
                showROC,
                default=FALSE)
            private$..showCalibration <- jmvcore::OptionBool$new(
                "showCalibration",
                showCalibration,
                default=FALSE)
            private$..autoRecommend <- jmvcore::OptionBool$new(
                "autoRecommend",
                autoRecommend,
                default=TRUE)
            private$..recommendBy <- jmvcore::OptionList$new(
                "recommendBy",
                recommendBy,
                options=list(
                    "aic",
                    "bic",
                    "cindex",
                    "cv"),
                default="aic")

            self$.addOption(private$..modelType)
            self$.addOption(private$..outcome)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..timeVar)
            self$.addOption(private$..model1vars)
            self$.addOption(private$..model1name)
            self$.addOption(private$..model2vars)
            self$.addOption(private$..model2name)
            self$.addOption(private$..model3vars)
            self$.addOption(private$..model3name)
            self$.addOption(private$..model4vars)
            self$.addOption(private$..model4name)
            self$.addOption(private$..model5vars)
            self$.addOption(private$..model5name)
            self$.addOption(private$..showAIC)
            self$.addOption(private$..showRSquared)
            self$.addOption(private$..showCIndex)
            self$.addOption(private$..showLogLik)
            self$.addOption(private$..showMCC)
            self$.addOption(private$..crossValidation)
            self$.addOption(private$..cvFolds)
            self$.addOption(private$..showForestPlot)
            self$.addOption(private$..showROC)
            self$.addOption(private$..showCalibration)
            self$.addOption(private$..autoRecommend)
            self$.addOption(private$..recommendBy)
        }),
    active = list(
        modelType = function() private$..modelType$value,
        outcome = function() private$..outcome$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        timeVar = function() private$..timeVar$value,
        model1vars = function() private$..model1vars$value,
        model1name = function() private$..model1name$value,
        model2vars = function() private$..model2vars$value,
        model2name = function() private$..model2name$value,
        model3vars = function() private$..model3vars$value,
        model3name = function() private$..model3name$value,
        model4vars = function() private$..model4vars$value,
        model4name = function() private$..model4name$value,
        model5vars = function() private$..model5vars$value,
        model5name = function() private$..model5name$value,
        showAIC = function() private$..showAIC$value,
        showRSquared = function() private$..showRSquared$value,
        showCIndex = function() private$..showCIndex$value,
        showLogLik = function() private$..showLogLik$value,
        showMCC = function() private$..showMCC$value,
        crossValidation = function() private$..crossValidation$value,
        cvFolds = function() private$..cvFolds$value,
        showForestPlot = function() private$..showForestPlot$value,
        showROC = function() private$..showROC$value,
        showCalibration = function() private$..showCalibration$value,
        autoRecommend = function() private$..autoRecommend$value,
        recommendBy = function() private$..recommendBy$value),
    private = list(
        ..modelType = NA,
        ..outcome = NA,
        ..outcomeLevel = NA,
        ..timeVar = NA,
        ..model1vars = NA,
        ..model1name = NA,
        ..model2vars = NA,
        ..model2name = NA,
        ..model3vars = NA,
        ..model3name = NA,
        ..model4vars = NA,
        ..model4name = NA,
        ..model5vars = NA,
        ..model5name = NA,
        ..showAIC = NA,
        ..showRSquared = NA,
        ..showCIndex = NA,
        ..showLogLik = NA,
        ..showMCC = NA,
        ..crossValidation = NA,
        ..cvFolds = NA,
        ..showForestPlot = NA,
        ..showROC = NA,
        ..showCalibration = NA,
        ..autoRecommend = NA,
        ..recommendBy = NA)
)

modelperformanceResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "modelperformanceResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        comparisonTable = function() private$.items[["comparisonTable"]],
        cvTable = function() private$.items[["cvTable"]],
        forestPlot = function() private$.items[["forestPlot"]],
        rocPlot = function() private$.items[["rocPlot"]],
        calibrationPlot = function() private$.items[["calibrationPlot"]],
        recommendation = function() private$.items[["recommendation"]],
        modelDetails = function() private$.items[["modelDetails"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Multi-Model Performance Comparison",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "survival",
                    "pROC",
                    "DescTools"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="comparisonTable",
                title="Model Performance Comparison",
                rows=0,
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="nvars", 
                        `title`="N Vars", 
                        `type`="integer"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(showAIC)"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(showAIC)"),
                    list(
                        `name`="rsquared", 
                        `title`="R\u00B2", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(showRSquared)"),
                    list(
                        `name`="cindex", 
                        `title`="C-index", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(showCIndex)"),
                    list(
                        `name`="loglik", 
                        `title`="Log-Lik", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(showLogLik)"),
                    list(
                        `name`="mcc", 
                        `title`="MCC", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(showMCC)"),
                    list(
                        `name`="recommended", 
                        `title`="Best", 
                        `type`="text")),
                refs=list(
                    "Matthews1975",
                    "Saito2015")))
            self$add(jmvcore::Table$new(
                options=options,
                name="cvTable",
                title="Cross-Validation Performance",
                visible="(crossValidation)",
                rows=0,
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="cv_metric", 
                        `title`="CV Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cv_se", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="forestPlot",
                title="Forest Plot - Model Comparison",
                width=700,
                height=500,
                renderFun=".forestPlot",
                visible="(showForestPlot)",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="rocPlot",
                title="ROC Curves - Model Comparison",
                width=650,
                height=550,
                renderFun=".rocPlot",
                visible="(showROC)",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="calibrationPlot",
                title="Calibration Plot",
                width=600,
                height=500,
                renderFun=".calibrationPlot",
                visible="(showCalibration)",
                requiresData=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="recommendation",
                title="Model Recommendation",
                visible="(autoRecommend)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="modelDetails",
                title="Detailed Model Summaries",
                visible=TRUE))}))

modelperformanceBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "modelperformanceBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "modelperformance",
                version = c(0,0,31),
                options = options,
                results = modelperformanceResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Multi-Model Performance Comparison
#'
#' Compare performance of multiple statistical models side-by-side. Supports 
#' Cox proportional hazards, logistic regression, and linear regression 
#' models. Provides unified comparison tables with AIC, BIC, RÂ², C-index, and 
#' other metrics. Inspired by Orange Data Mining's Test & Score widget, 
#' adapted for clinical research with comprehensive model diagnostics.
#'
#' @examples
#' # Example: Compare Cox models
#' modelperformance(
#'     data = cancer_data,
#'     modelType = "cox",
#'     outcome = "death",
#'     timeVar = "months",
#'     model1vars = c("age", "stage"),
#'     model2vars = c("age", "stage", "grade"),
#'     model3vars = c("age", "stage", "grade", "ki67")
#' )
#'
#' @param data .
#' @param modelType .
#' @param outcome .
#' @param outcomeLevel .
#' @param timeVar .
#' @param model1vars .
#' @param model1name .
#' @param model2vars .
#' @param model2name .
#' @param model3vars .
#' @param model3name .
#' @param model4vars .
#' @param model4name .
#' @param model5vars .
#' @param model5name .
#' @param showAIC .
#' @param showRSquared .
#' @param showCIndex .
#' @param showLogLik .
#' @param showMCC Matthews Correlation Coefficient (MCC) - a balanced metric
#'   for binary classification, especially useful for imbalanced datasets.
#'   Ranges from -1 (total disagreement) to +1 (perfect prediction).
#' @param crossValidation .
#' @param cvFolds .
#' @param showForestPlot .
#' @param showROC .
#' @param showCalibration .
#' @param autoRecommend .
#' @param recommendBy .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$comparisonTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$cvTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$forestPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$rocPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$calibrationPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$recommendation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelDetails} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$comparisonTable$asDF}
#'
#' \code{as.data.frame(results$comparisonTable)}
#'
#' @export
modelperformance <- function(
    data,
    modelType = "cox",
    outcome = NULL,
    outcomeLevel,
    timeVar = NULL,
    model1vars = NULL,
    model1name = "Model 1",
    model2vars = NULL,
    model2name = "Model 2",
    model3vars = NULL,
    model3name = "Model 3",
    model4vars = NULL,
    model4name = "Model 4",
    model5vars = NULL,
    model5name = "Model 5",
    showAIC = TRUE,
    showRSquared = TRUE,
    showCIndex = TRUE,
    showLogLik = FALSE,
    showMCC = TRUE,
    crossValidation = FALSE,
    cvFolds = 5,
    showForestPlot = TRUE,
    showROC = FALSE,
    showCalibration = FALSE,
    autoRecommend = TRUE,
    recommendBy = "aic") {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("modelperformance requires jmvcore to be installed (restart may be required)")

    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(timeVar)) timeVar <- jmvcore::resolveQuo(jmvcore::enquo(timeVar))
    if ( ! missing(model1vars)) model1vars <- jmvcore::resolveQuo(jmvcore::enquo(model1vars))
    if ( ! missing(model2vars)) model2vars <- jmvcore::resolveQuo(jmvcore::enquo(model2vars))
    if ( ! missing(model3vars)) model3vars <- jmvcore::resolveQuo(jmvcore::enquo(model3vars))
    if ( ! missing(model4vars)) model4vars <- jmvcore::resolveQuo(jmvcore::enquo(model4vars))
    if ( ! missing(model5vars)) model5vars <- jmvcore::resolveQuo(jmvcore::enquo(model5vars))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(timeVar), timeVar, NULL),
            `if`( ! missing(model1vars), model1vars, NULL),
            `if`( ! missing(model2vars), model2vars, NULL),
            `if`( ! missing(model3vars), model3vars, NULL),
            `if`( ! missing(model4vars), model4vars, NULL),
            `if`( ! missing(model5vars), model5vars, NULL))


    options <- modelperformanceOptions$new(
        modelType = modelType,
        outcome = outcome,
        outcomeLevel = outcomeLevel,
        timeVar = timeVar,
        model1vars = model1vars,
        model1name = model1name,
        model2vars = model2vars,
        model2name = model2name,
        model3vars = model3vars,
        model3name = model3name,
        model4vars = model4vars,
        model4name = model4name,
        model5vars = model5vars,
        model5name = model5name,
        showAIC = showAIC,
        showRSquared = showRSquared,
        showCIndex = showCIndex,
        showLogLik = showLogLik,
        showMCC = showMCC,
        crossValidation = crossValidation,
        cvFolds = cvFolds,
        showForestPlot = showForestPlot,
        showROC = showROC,
        showCalibration = showCalibration,
        autoRecommend = autoRecommend,
        recommendBy = recommendBy)

    analysis <- modelperformanceClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

