
# This file is automatically generated, you probably don't want to edit this

concordanceindexOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "concordanceindexOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            event = NULL,
            event_code = NULL,
            predictor = NULL,
            reverse_direction = FALSE,
            predictor_formula = "",
            cindex_method = "harrell",
            time_dependent = FALSE,
            evaluation_times = "12, 36, 60",
            confidence_intervals = FALSE,
            ci_method = "bootstrap",
            bootstrap_samples = 500,
            confidence_level = 0.95,
            compare_models = FALSE,
            additional_predictors = NULL,
            model_names = "Model 1, Model 2, Model 3",
            compare_test = FALSE,
            competing_risks = FALSE,
            cause_specific = FALSE,
            decompose_cindex = FALSE,
            risk_groups = 3,
            somers_d = FALSE,
            goodman_kruskal_gamma = FALSE,
            stratified_cindex = FALSE,
            stratify_by = NULL,
            plot_cindex_over_time = FALSE,
            plot_model_comparison = FALSE,
            plot_risk_group_kaplan_meier = FALSE,
            plot_decomposition = FALSE,
            clinical_application = "general",
            show_interpretation = TRUE,
            external_validation = FALSE,
            restricted_time = FALSE,
            max_time = 60,
            handle_ties = "average",
            missing_handling = "complete",
            random_seed = 123, ...) {

            super$initialize(
                package="ClinicoPath",
                name="concordanceindex",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event <- jmvcore::OptionVariable$new(
                "event",
                event,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..event_code <- jmvcore::OptionLevel$new(
                "event_code",
                event_code,
                variable="(event)")
            private$..predictor <- jmvcore::OptionVariable$new(
                "predictor",
                predictor,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..reverse_direction <- jmvcore::OptionBool$new(
                "reverse_direction",
                reverse_direction,
                default=FALSE)
            private$..predictor_formula <- jmvcore::OptionString$new(
                "predictor_formula",
                predictor_formula,
                default="")
            private$..cindex_method <- jmvcore::OptionList$new(
                "cindex_method",
                cindex_method,
                options=list(
                    "harrell",
                    "uno",
                    "gonen_heller"),
                default="harrell")
            private$..time_dependent <- jmvcore::OptionBool$new(
                "time_dependent",
                time_dependent,
                default=FALSE)
            private$..evaluation_times <- jmvcore::OptionString$new(
                "evaluation_times",
                evaluation_times,
                default="12, 36, 60")
            private$..confidence_intervals <- jmvcore::OptionBool$new(
                "confidence_intervals",
                confidence_intervals,
                default=FALSE)
            private$..ci_method <- jmvcore::OptionList$new(
                "ci_method",
                ci_method,
                options=list(
                    "bootstrap",
                    "asymptotic"),
                default="bootstrap")
            private$..bootstrap_samples <- jmvcore::OptionInteger$new(
                "bootstrap_samples",
                bootstrap_samples,
                default=500,
                min=100,
                max=5000)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.8,
                max=0.99)
            private$..compare_models <- jmvcore::OptionBool$new(
                "compare_models",
                compare_models,
                default=FALSE)
            private$..additional_predictors <- jmvcore::OptionVariables$new(
                "additional_predictors",
                additional_predictors,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..model_names <- jmvcore::OptionString$new(
                "model_names",
                model_names,
                default="Model 1, Model 2, Model 3")
            private$..compare_test <- jmvcore::OptionBool$new(
                "compare_test",
                compare_test,
                default=FALSE)
            private$..competing_risks <- jmvcore::OptionBool$new(
                "competing_risks",
                competing_risks,
                default=FALSE)
            private$..cause_specific <- jmvcore::OptionBool$new(
                "cause_specific",
                cause_specific,
                default=FALSE)
            private$..decompose_cindex <- jmvcore::OptionBool$new(
                "decompose_cindex",
                decompose_cindex,
                default=FALSE)
            private$..risk_groups <- jmvcore::OptionInteger$new(
                "risk_groups",
                risk_groups,
                default=3,
                min=2,
                max=10)
            private$..somers_d <- jmvcore::OptionBool$new(
                "somers_d",
                somers_d,
                default=FALSE)
            private$..goodman_kruskal_gamma <- jmvcore::OptionBool$new(
                "goodman_kruskal_gamma",
                goodman_kruskal_gamma,
                default=FALSE)
            private$..stratified_cindex <- jmvcore::OptionBool$new(
                "stratified_cindex",
                stratified_cindex,
                default=FALSE)
            private$..stratify_by <- jmvcore::OptionVariable$new(
                "stratify_by",
                stratify_by,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..plot_cindex_over_time <- jmvcore::OptionBool$new(
                "plot_cindex_over_time",
                plot_cindex_over_time,
                default=FALSE)
            private$..plot_model_comparison <- jmvcore::OptionBool$new(
                "plot_model_comparison",
                plot_model_comparison,
                default=FALSE)
            private$..plot_risk_group_kaplan_meier <- jmvcore::OptionBool$new(
                "plot_risk_group_kaplan_meier",
                plot_risk_group_kaplan_meier,
                default=FALSE)
            private$..plot_decomposition <- jmvcore::OptionBool$new(
                "plot_decomposition",
                plot_decomposition,
                default=FALSE)
            private$..clinical_application <- jmvcore::OptionList$new(
                "clinical_application",
                clinical_application,
                options=list(
                    "general",
                    "staging",
                    "risk_score",
                    "biomarker",
                    "ml_model"),
                default="general")
            private$..show_interpretation <- jmvcore::OptionBool$new(
                "show_interpretation",
                show_interpretation,
                default=TRUE)
            private$..external_validation <- jmvcore::OptionBool$new(
                "external_validation",
                external_validation,
                default=FALSE)
            private$..restricted_time <- jmvcore::OptionBool$new(
                "restricted_time",
                restricted_time,
                default=FALSE)
            private$..max_time <- jmvcore::OptionNumber$new(
                "max_time",
                max_time,
                default=60,
                min=0)
            private$..handle_ties <- jmvcore::OptionList$new(
                "handle_ties",
                handle_ties,
                options=list(
                    "average",
                    "exclude",
                    "random"),
                default="average")
            private$..missing_handling <- jmvcore::OptionList$new(
                "missing_handling",
                missing_handling,
                options=list(
                    "complete",
                    "imputation"),
                default="complete")
            private$..random_seed <- jmvcore::OptionInteger$new(
                "random_seed",
                random_seed,
                default=123,
                min=1,
                max=999999)

            self$.addOption(private$..time)
            self$.addOption(private$..event)
            self$.addOption(private$..event_code)
            self$.addOption(private$..predictor)
            self$.addOption(private$..reverse_direction)
            self$.addOption(private$..predictor_formula)
            self$.addOption(private$..cindex_method)
            self$.addOption(private$..time_dependent)
            self$.addOption(private$..evaluation_times)
            self$.addOption(private$..confidence_intervals)
            self$.addOption(private$..ci_method)
            self$.addOption(private$..bootstrap_samples)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..compare_models)
            self$.addOption(private$..additional_predictors)
            self$.addOption(private$..model_names)
            self$.addOption(private$..compare_test)
            self$.addOption(private$..competing_risks)
            self$.addOption(private$..cause_specific)
            self$.addOption(private$..decompose_cindex)
            self$.addOption(private$..risk_groups)
            self$.addOption(private$..somers_d)
            self$.addOption(private$..goodman_kruskal_gamma)
            self$.addOption(private$..stratified_cindex)
            self$.addOption(private$..stratify_by)
            self$.addOption(private$..plot_cindex_over_time)
            self$.addOption(private$..plot_model_comparison)
            self$.addOption(private$..plot_risk_group_kaplan_meier)
            self$.addOption(private$..plot_decomposition)
            self$.addOption(private$..clinical_application)
            self$.addOption(private$..show_interpretation)
            self$.addOption(private$..external_validation)
            self$.addOption(private$..restricted_time)
            self$.addOption(private$..max_time)
            self$.addOption(private$..handle_ties)
            self$.addOption(private$..missing_handling)
            self$.addOption(private$..random_seed)
        }),
    active = list(
        time = function() private$..time$value,
        event = function() private$..event$value,
        event_code = function() private$..event_code$value,
        predictor = function() private$..predictor$value,
        reverse_direction = function() private$..reverse_direction$value,
        predictor_formula = function() private$..predictor_formula$value,
        cindex_method = function() private$..cindex_method$value,
        time_dependent = function() private$..time_dependent$value,
        evaluation_times = function() private$..evaluation_times$value,
        confidence_intervals = function() private$..confidence_intervals$value,
        ci_method = function() private$..ci_method$value,
        bootstrap_samples = function() private$..bootstrap_samples$value,
        confidence_level = function() private$..confidence_level$value,
        compare_models = function() private$..compare_models$value,
        additional_predictors = function() private$..additional_predictors$value,
        model_names = function() private$..model_names$value,
        compare_test = function() private$..compare_test$value,
        competing_risks = function() private$..competing_risks$value,
        cause_specific = function() private$..cause_specific$value,
        decompose_cindex = function() private$..decompose_cindex$value,
        risk_groups = function() private$..risk_groups$value,
        somers_d = function() private$..somers_d$value,
        goodman_kruskal_gamma = function() private$..goodman_kruskal_gamma$value,
        stratified_cindex = function() private$..stratified_cindex$value,
        stratify_by = function() private$..stratify_by$value,
        plot_cindex_over_time = function() private$..plot_cindex_over_time$value,
        plot_model_comparison = function() private$..plot_model_comparison$value,
        plot_risk_group_kaplan_meier = function() private$..plot_risk_group_kaplan_meier$value,
        plot_decomposition = function() private$..plot_decomposition$value,
        clinical_application = function() private$..clinical_application$value,
        show_interpretation = function() private$..show_interpretation$value,
        external_validation = function() private$..external_validation$value,
        restricted_time = function() private$..restricted_time$value,
        max_time = function() private$..max_time$value,
        handle_ties = function() private$..handle_ties$value,
        missing_handling = function() private$..missing_handling$value,
        random_seed = function() private$..random_seed$value),
    private = list(
        ..time = NA,
        ..event = NA,
        ..event_code = NA,
        ..predictor = NA,
        ..reverse_direction = NA,
        ..predictor_formula = NA,
        ..cindex_method = NA,
        ..time_dependent = NA,
        ..evaluation_times = NA,
        ..confidence_intervals = NA,
        ..ci_method = NA,
        ..bootstrap_samples = NA,
        ..confidence_level = NA,
        ..compare_models = NA,
        ..additional_predictors = NA,
        ..model_names = NA,
        ..compare_test = NA,
        ..competing_risks = NA,
        ..cause_specific = NA,
        ..decompose_cindex = NA,
        ..risk_groups = NA,
        ..somers_d = NA,
        ..goodman_kruskal_gamma = NA,
        ..stratified_cindex = NA,
        ..stratify_by = NA,
        ..plot_cindex_over_time = NA,
        ..plot_model_comparison = NA,
        ..plot_risk_group_kaplan_meier = NA,
        ..plot_decomposition = NA,
        ..clinical_application = NA,
        ..show_interpretation = NA,
        ..external_validation = NA,
        ..restricted_time = NA,
        ..max_time = NA,
        ..handle_ties = NA,
        ..missing_handling = NA,
        ..random_seed = NA)
)

concordanceindexResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "concordanceindexResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        cindexSummary = function() private$.items[["cindexSummary"]],
        somersD = function() private$.items[["somersD"]],
        timeDependentCindex = function() private$.items[["timeDependentCindex"]],
        modelComparison = function() private$.items[["modelComparison"]],
        pairwiseTests = function() private$.items[["pairwiseTests"]],
        decomposition = function() private$.items[["decomposition"]],
        stratifiedCindex = function() private$.items[["stratifiedCindex"]],
        cindexOverTimePlot = function() private$.items[["cindexOverTimePlot"]],
        modelComparisonPlot = function() private$.items[["modelComparisonPlot"]],
        riskGroupKMPlot = function() private$.items[["riskGroupKMPlot"]],
        decompositionPlot = function() private$.items[["decompositionPlot"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Concordance Index (Harrell's C-index)")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="cindexSummary",
                title="Concordance Index Summary",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="predictor", 
                        `title`="Predictor", 
                        `type`="text"),
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"),
                    list(
                        `name`="n_pairs", 
                        `title`="N Pairs", 
                        `type`="integer"),
                    list(
                        `name`="concordant", 
                        `title`="Concordant", 
                        `type`="integer"),
                    list(
                        `name`="discordant", 
                        `title`="Discordant", 
                        `type`="integer"),
                    list(
                        `name`="tied", 
                        `title`="Tied", 
                        `type`="integer"),
                    list(
                        `name`="cindex", 
                        `title`="C-index", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cindex_se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="cindex_ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cindex_ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="somersD",
                title="Somers' D Statistic",
                visible="(somers_d)",
                rows=1,
                columns=list(
                    list(
                        `name`="somers_d", 
                        `title`="Somers' D", 
                        `type`="number"),
                    list(
                        `name`="d_se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="d_ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number"),
                    list(
                        `name`="d_ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="timeDependentCindex",
                title="Time-Dependent C-index",
                visible="(time_dependent)",
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="number"),
                    list(
                        `name`="n_at_risk", 
                        `title`="N At Risk", 
                        `type`="integer"),
                    list(
                        `name`="cindex", 
                        `title`="C-index", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cindex_se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="cindex_ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cindex_ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelComparison",
                title="Model Comparison (C-index)",
                visible="(compare_models)",
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="cindex", 
                        `title`="C-index", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cindex_se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="cindex_ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cindex_ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="rank", 
                        `title`="Rank", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="pairwiseTests",
                title="Pairwise Model Comparison Tests",
                visible="(compare_models && compare_test)",
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="cindex_diff", 
                        `title`="C-index Difference", 
                        `type`="number"),
                    list(
                        `name`="se_diff", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="z_statistic", 
                        `title`="Z", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="P-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="conclusion", 
                        `title`="Conclusion", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="decomposition",
                title="C-index Decomposition by Risk Groups",
                visible="(decompose_cindex)",
                columns=list(
                    list(
                        `name`="risk_group", 
                        `title`="Risk Group", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="n_events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="median_predictor", 
                        `title`="Median Risk", 
                        `type`="number"),
                    list(
                        `name`="contribution", 
                        `title`="C-index Contribution", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="percent_pairs", 
                        `title`="Percent of Pairs", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="stratifiedCindex",
                title="Stratified C-index",
                visible="(stratified_cindex)",
                columns=list(
                    list(
                        `name`="stratum", 
                        `title`="Stratum", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="n_events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="cindex", 
                        `title`="C-index", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cindex_ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cindex_ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="cindexOverTimePlot",
                title="C-index Over Time",
                width=600,
                height=500,
                renderFun=".plotCindexOverTime",
                visible="(plot_cindex_over_time && time_dependent)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="modelComparisonPlot",
                title="Model Comparison",
                width=600,
                height=500,
                renderFun=".plotModelComparison",
                visible="(plot_model_comparison && compare_models)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="riskGroupKMPlot",
                title="Kaplan-Meier Curves by Risk Groups",
                width=600,
                height=500,
                renderFun=".plotRiskGroupKM",
                visible="(plot_risk_group_kaplan_meier)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="decompositionPlot",
                title="C-index Decomposition",
                width=600,
                height=500,
                renderFun=".plotDecomposition",
                visible="(plot_decomposition && decompose_cindex)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation",
                visible="(show_interpretation)"))}))

concordanceindexBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "concordanceindexBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "concordanceindex",
                version = c(0,0,32),
                options = options,
                results = concordanceindexResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Concordance Index (Harrell's C-index)
#'
#' Harrell's concordance index (C-index) for evaluating discrimination ability 
#' of survival prediction models. The C-index measures the proportion of all 
#' comparable pairs of patients in which the model correctly ranks their 
#' survival times - a generalization of the ROC curve's AUC to censored 
#' survival data. Values range from 0.5 (no discrimination) to 1.0 (perfect 
#' discrimination), with 0.7-0.8 considered good and >0.8 considered 
#' excellent. Unlike time-dependent ROC which evaluates at specific time 
#' points, the C-index provides a global measure across the entire follow-up 
#' period. Supports time-dependent concordance for dynamic predictions, 
#' competing risks extensions, stratified analysis, and comparison between 
#' models. Essential for validating Cox regression models, machine learning 
#' survival predictions, and prognostic scores. The C-index accounts for 
#' censoring through appropriate pair weighting and can be decomposed to 
#' identify which risk groups contribute most to discrimination.
#' 
#'
#' @examples
#' result <- concordanceindex(
#'     data = validation_data,
#'     time = "follow_up_months",
#'     event = "death",
#'     predictor = "risk_score"
#' )
#'
#' @param data The data as a data frame.
#' @param time Time-to-event or censoring variable (days, months, years). For
#'   time-dependent concordance, this is the follow-up time.
#' @param event Binary event indicator (1 = event, 0 = censored). For
#'   competing risks, can be multi-level factor with different event types.
#' @param event_code Which level represents the event of interest (e.g.,
#'   death, progression).
#' @param predictor Continuous predictor variable used for ranking patients.
#'   Can be a risk score, linear predictor from Cox model, or predicted
#'   probability. Higher values should indicate higher risk (or use
#'   reverse_direction option).
#' @param reverse_direction If predictor is protective (lower values = higher
#'   risk), reverse the direction for concordance calculation. Example: survival
#'   probability where lower values indicate worse prognosis.
#' @param predictor_formula Formula for Cox model if predictor not directly
#'   provided. Example: "~ age + stage + grade". Model will be fitted and linear
#'   predictor used.
#' @param cindex_method Method for C-index calculation. Harrell's is standard,
#'   Uno's uses inverse probability weighting for censoring, GÃ¶nen-Heller is
#'   bias-free estimator for proportional hazards models (doesn't require
#'   follow-up information).
#' @param time_dependent Calculate time-dependent C-index at specific time
#'   horizons. Evaluates discrimination for predictions at particular time
#'   points rather than globally across follow-up.
#' @param evaluation_times Comma-separated time points for time-dependent
#'   C-index evaluation. Example: "12, 24, 36, 60" for 1, 2, 3, and 5 years in
#'   months.
#' @param confidence_intervals Calculate confidence intervals for C-index
#'   using bootstrap or asymptotic standard errors.
#' @param ci_method Method for confidence interval estimation. Bootstrap is
#'   more accurate but computationally intensive.
#' @param bootstrap_samples Number of bootstrap samples for CI estimation.
#' @param confidence_level Confidence level for interval estimation.
#' @param compare_models Compare C-index across multiple prediction models to
#'   identify best discriminating model.
#' @param additional_predictors Additional predictor variables (risk scores)
#'   for model comparison.
#' @param model_names Comma-separated names for models being compared.
#' @param compare_test Perform statistical test for differences in C-index
#'   between models.
#' @param competing_risks Use competing risks framework for C-index
#'   calculation when multiple event types can occur. Requires cause-specific
#'   hazard approach.
#' @param cause_specific For competing risks, calculate cause-specific C-index
#'   for event of interest treating other events as censoring.
#' @param decompose_cindex Decompose C-index to show contribution from
#'   different risk strata. Identifies which patient groups contribute most to
#'   discrimination.
#' @param risk_groups Number of risk groups for C-index decomposition (e.g., 3
#'   = low/medium/high, 4 = quartiles, 10 = deciles).
#' @param somers_d Calculate Somers' D rank correlation (D = 2*(C-index -
#'   0.5)). Ranges from -1 to +1, interpretable as correlation between predictor
#'   and outcome.
#' @param goodman_kruskal_gamma Calculate Goodman-Kruskal gamma statistic for
#'   ordinal association. Related to C-index but uses different pair weighting.
#' @param stratified_cindex Calculate C-index stratified by important
#'   subgroups to assess consistency across populations.
#' @param stratify_by Variable for stratified analysis (e.g., treatment arm,
#'   center, age group).
#' @param plot_cindex_over_time Plot time-dependent C-index across follow-up
#'   period. Shows how discrimination changes with prediction horizon.
#' @param plot_model_comparison Bar plot comparing C-index across multiple
#'   models with confidence intervals.
#' @param plot_risk_group_kaplan_meier Display Kaplan-Meier curves stratified
#'   by risk groups defined by predictor quantiles. Visual assessment of
#'   separation = discrimination.
#' @param plot_decomposition Visualize contribution of different risk strata
#'   to overall C-index.
#' @param clinical_application Clinical application context for interpretation
#'   guidance.
#' @param show_interpretation Provide interpretation of C-index with clinical
#'   context and recommendations.
#' @param external_validation Indicate this is external validation (model from
#'   different cohort).
#' @param restricted_time Restrict C-index calculation to specific follow-up
#'   period to avoid issues with long-term censoring.
#' @param max_time Maximum follow-up time for restricted C-index calculation.
#'   Pairs beyond this time are not considered.
#' @param handle_ties Method for handling tied predictor values in concordance
#'   calculation.
#' @param missing_handling Method for handling missing predictor or outcome
#'   data.
#' @param random_seed Random seed for bootstrap and other stochastic
#'   procedures.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$cindexSummary} \tab \tab \tab \tab \tab Overall C-index with confidence intervals \cr
#'   \code{results$somersD} \tab \tab \tab \tab \tab Somers' D rank correlation \cr
#'   \code{results$timeDependentCindex} \tab \tab \tab \tab \tab C-index evaluated at specific time points \cr
#'   \code{results$modelComparison} \tab \tab \tab \tab \tab Comparison of C-index across multiple models \cr
#'   \code{results$pairwiseTests} \tab \tab \tab \tab \tab Statistical tests comparing C-index between models \cr
#'   \code{results$decomposition} \tab \tab \tab \tab \tab Contribution of risk strata to overall C-index \cr
#'   \code{results$stratifiedCindex} \tab \tab \tab \tab \tab C-index by subgroup \cr
#'   \code{results$cindexOverTimePlot} \tab \tab \tab \tab \tab Time-dependent C-index across follow-up \cr
#'   \code{results$modelComparisonPlot} \tab \tab \tab \tab \tab Bar plot comparing C-index across models \cr
#'   \code{results$riskGroupKMPlot} \tab \tab \tab \tab \tab Survival curves stratified by predictor quantiles \cr
#'   \code{results$decompositionPlot} \tab \tab \tab \tab \tab Contribution of risk strata to discrimination \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$cindexSummary$asDF}
#'
#' \code{as.data.frame(results$cindexSummary)}
#'
#' @export
concordanceindex <- function(
    data,
    time,
    event,
    event_code,
    predictor,
    reverse_direction = FALSE,
    predictor_formula = "",
    cindex_method = "harrell",
    time_dependent = FALSE,
    evaluation_times = "12, 36, 60",
    confidence_intervals = FALSE,
    ci_method = "bootstrap",
    bootstrap_samples = 500,
    confidence_level = 0.95,
    compare_models = FALSE,
    additional_predictors,
    model_names = "Model 1, Model 2, Model 3",
    compare_test = FALSE,
    competing_risks = FALSE,
    cause_specific = FALSE,
    decompose_cindex = FALSE,
    risk_groups = 3,
    somers_d = FALSE,
    goodman_kruskal_gamma = FALSE,
    stratified_cindex = FALSE,
    stratify_by,
    plot_cindex_over_time = FALSE,
    plot_model_comparison = FALSE,
    plot_risk_group_kaplan_meier = FALSE,
    plot_decomposition = FALSE,
    clinical_application = "general",
    show_interpretation = TRUE,
    external_validation = FALSE,
    restricted_time = FALSE,
    max_time = 60,
    handle_ties = "average",
    missing_handling = "complete",
    random_seed = 123) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("concordanceindex requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(event)) event <- jmvcore::resolveQuo(jmvcore::enquo(event))
    if ( ! missing(predictor)) predictor <- jmvcore::resolveQuo(jmvcore::enquo(predictor))
    if ( ! missing(additional_predictors)) additional_predictors <- jmvcore::resolveQuo(jmvcore::enquo(additional_predictors))
    if ( ! missing(stratify_by)) stratify_by <- jmvcore::resolveQuo(jmvcore::enquo(stratify_by))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(event), event, NULL),
            `if`( ! missing(predictor), predictor, NULL),
            `if`( ! missing(additional_predictors), additional_predictors, NULL),
            `if`( ! missing(stratify_by), stratify_by, NULL))

    for (v in stratify_by) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- concordanceindexOptions$new(
        time = time,
        event = event,
        event_code = event_code,
        predictor = predictor,
        reverse_direction = reverse_direction,
        predictor_formula = predictor_formula,
        cindex_method = cindex_method,
        time_dependent = time_dependent,
        evaluation_times = evaluation_times,
        confidence_intervals = confidence_intervals,
        ci_method = ci_method,
        bootstrap_samples = bootstrap_samples,
        confidence_level = confidence_level,
        compare_models = compare_models,
        additional_predictors = additional_predictors,
        model_names = model_names,
        compare_test = compare_test,
        competing_risks = competing_risks,
        cause_specific = cause_specific,
        decompose_cindex = decompose_cindex,
        risk_groups = risk_groups,
        somers_d = somers_d,
        goodman_kruskal_gamma = goodman_kruskal_gamma,
        stratified_cindex = stratified_cindex,
        stratify_by = stratify_by,
        plot_cindex_over_time = plot_cindex_over_time,
        plot_model_comparison = plot_model_comparison,
        plot_risk_group_kaplan_meier = plot_risk_group_kaplan_meier,
        plot_decomposition = plot_decomposition,
        clinical_application = clinical_application,
        show_interpretation = show_interpretation,
        external_validation = external_validation,
        restricted_time = restricted_time,
        max_time = max_time,
        handle_ties = handle_ties,
        missing_handling = missing_handling,
        random_seed = random_seed)

    analysis <- concordanceindexClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

