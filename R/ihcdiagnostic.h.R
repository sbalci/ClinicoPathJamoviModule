
# This file is automatically generated, you probably don't want to edit this

ihcdiagnosticOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcdiagnosticOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            markers = NULL,
            diagnosis = NULL,
            id = NULL,
            differentialDiagnosis = TRUE,
            antibodyOptimization = FALSE,
            calculateDiagnosticMetrics = TRUE,
            clusterMethod = "hierarchical",
            cutpointMethod = "optimal",
            confidenceLevel = 0.95,
            crossValidation = TRUE,
            minimumGroupSize = 10, ...) {

            super$initialize(
                package="ClinicoPath",
                name="ihcdiagnostic",
                requiresData=TRUE,
                ...)

            private$..markers <- jmvcore::OptionVariables$new(
                "markers",
                markers,
                suggested=list(
                    "ordinal",
                    "nominal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..diagnosis <- jmvcore::OptionVariable$new(
                "diagnosis",
                diagnosis,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..id <- jmvcore::OptionVariable$new(
                "id",
                id,
                suggested=list(
                    "nominal",
                    "id"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..differentialDiagnosis <- jmvcore::OptionBool$new(
                "differentialDiagnosis",
                differentialDiagnosis,
                default=TRUE)
            private$..antibodyOptimization <- jmvcore::OptionBool$new(
                "antibodyOptimization",
                antibodyOptimization,
                default=FALSE)
            private$..calculateDiagnosticMetrics <- jmvcore::OptionBool$new(
                "calculateDiagnosticMetrics",
                calculateDiagnosticMetrics,
                default=TRUE)
            private$..clusterMethod <- jmvcore::OptionList$new(
                "clusterMethod",
                clusterMethod,
                options=list(
                    "hierarchical",
                    "pam"),
                default="hierarchical")
            private$..cutpointMethod <- jmvcore::OptionList$new(
                "cutpointMethod",
                cutpointMethod,
                options=list(
                    "optimal",
                    "clinical",
                    "median"),
                default="optimal")
            private$..confidenceLevel <- jmvcore::OptionNumber$new(
                "confidenceLevel",
                confidenceLevel,
                min=0.8,
                max=0.99,
                default=0.95)
            private$..crossValidation <- jmvcore::OptionBool$new(
                "crossValidation",
                crossValidation,
                default=TRUE)
            private$..minimumGroupSize <- jmvcore::OptionInteger$new(
                "minimumGroupSize",
                minimumGroupSize,
                min=5,
                max=50,
                default=10)

            self$.addOption(private$..markers)
            self$.addOption(private$..diagnosis)
            self$.addOption(private$..id)
            self$.addOption(private$..differentialDiagnosis)
            self$.addOption(private$..antibodyOptimization)
            self$.addOption(private$..calculateDiagnosticMetrics)
            self$.addOption(private$..clusterMethod)
            self$.addOption(private$..cutpointMethod)
            self$.addOption(private$..confidenceLevel)
            self$.addOption(private$..crossValidation)
            self$.addOption(private$..minimumGroupSize)
        }),
    active = list(
        markers = function() private$..markers$value,
        diagnosis = function() private$..diagnosis$value,
        id = function() private$..id$value,
        differentialDiagnosis = function() private$..differentialDiagnosis$value,
        antibodyOptimization = function() private$..antibodyOptimization$value,
        calculateDiagnosticMetrics = function() private$..calculateDiagnosticMetrics$value,
        clusterMethod = function() private$..clusterMethod$value,
        cutpointMethod = function() private$..cutpointMethod$value,
        confidenceLevel = function() private$..confidenceLevel$value,
        crossValidation = function() private$..crossValidation$value,
        minimumGroupSize = function() private$..minimumGroupSize$value),
    private = list(
        ..markers = NA,
        ..diagnosis = NA,
        ..id = NA,
        ..differentialDiagnosis = NA,
        ..antibodyOptimization = NA,
        ..calculateDiagnosticMetrics = NA,
        ..clusterMethod = NA,
        ..cutpointMethod = NA,
        ..confidenceLevel = NA,
        ..crossValidation = NA,
        ..minimumGroupSize = NA)
)

ihcdiagnosticResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcdiagnosticResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        diagnosticPerformance = function() private$.items[["diagnosticPerformance"]],
        differentialResults = function() private$.items[["differentialResults"]],
        confusionMatrix = function() private$.items[["confusionMatrix"]],
        panelOptimization = function() private$.items[["panelOptimization"]],
        rocPlot = function() private$.items[["rocPlot"]],
        diagnosticPlot = function() private$.items[["diagnosticPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="IHC Diagnostic Analysis",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Diagnostic Analysis Overview",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="diagnosticPerformance",
                title="Diagnostic Performance by Marker",
                visible="(calculateDiagnosticMetrics)",
                clearWith=list(
                    "markers",
                    "diagnosis"),
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="cutpoint", 
                        `title`="Cutpoint", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity (%)", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity (%)", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="ppv", 
                        `title`="PPV (%)", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="npv", 
                        `title`="NPV (%)", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="accuracy", 
                        `title`="Accuracy (%)", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="auc", 
                        `title`="AUC", 
                        `type`="number", 
                        `format`="zto:3"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="differentialResults",
                title="Differential Diagnosis Results",
                visible="(differentialDiagnosis)",
                clearWith=list(
                    "markers",
                    "diagnosis",
                    "clusterMethod"),
                columns=list(
                    list(
                        `name`="case_id", 
                        `title`="Case", 
                        `type`="text"),
                    list(
                        `name`="predicted", 
                        `title`="Predicted", 
                        `type`="text"),
                    list(
                        `name`="actual", 
                        `title`="Actual", 
                        `type`="text"),
                    list(
                        `name`="confidence", 
                        `title`="Confidence (%)", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="integer"),
                    list(
                        `name`="correct", 
                        `title`="Correct", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="confusionMatrix",
                title="Confusion Matrix",
                visible="(differentialDiagnosis)",
                clearWith=list(
                    "markers",
                    "diagnosis"),
                columns=list(
                    list(
                        `name`="actual", 
                        `title`="Actual \\\\ Predicted", 
                        `type`="text"),
                    list(
                        `name`="total", 
                        `title`="Total", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="panelOptimization",
                title="Antibody Panel Optimization",
                visible="(antibodyOptimization)",
                clearWith=list(
                    "markers",
                    "diagnosis"),
                columns=list(
                    list(
                        `name`="panel_size", 
                        `title`="Panel Size", 
                        `type`="integer"),
                    list(
                        `name`="markers_included", 
                        `title`="Markers", 
                        `type`="text"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity (%)", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity (%)", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="accuracy", 
                        `title`="Accuracy (%)", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="recommendation", 
                        `title`="Recommendation", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="rocPlot",
                title="ROC Curves",
                visible="(calculateDiagnosticMetrics)",
                renderFun=".plotROC",
                clearWith=list(
                    "markers",
                    "diagnosis"),
                width=800,
                height=600))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagnosticPlot",
                title="Diagnostic Performance Comparison",
                visible="(calculateDiagnosticMetrics)",
                renderFun=".plotDiagnosticPerformance",
                clearWith=list(
                    "markers",
                    "diagnosis"),
                width=800,
                height=500))}))

ihcdiagnosticBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcdiagnosticBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "ihcdiagnostic",
                version = c(1,0,0),
                options = options,
                results = ihcdiagnosticResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' IHC Diagnostic Analysis
#'
#' Diagnostic performance analysis and clinical classification using IHC 
#' markers. Designed for differential diagnosis and antibody panel 
#' optimization.
#' 
#'
#' @examples
#' data \%>\%
#' ihcdiagnostic(
#'     markers = c("ER", "PR", "HER2", "Ki67"),
#'     diagnosis = "tumor_type",
#'     differentialDiagnosis = TRUE
#' )
#'
#' @param data the data as a data frame
#' @param markers IHC marker variables for diagnostic analysis
#' @param diagnosis Reference diagnosis for validation and performance
#'   assessment
#' @param id Case identifier for tracking
#' @param differentialDiagnosis Use clustering to predict diagnosis based on
#'   IHC patterns
#' @param antibodyOptimization Evaluate individual and combined antibody
#'   performance
#' @param calculateDiagnosticMetrics Calculate sensitivity, specificity, PPV,
#'   NPV for each marker
#' @param clusterMethod Clustering method for differential diagnosis
#' @param cutpointMethod Method for determining positive/negative cutpoints
#' @param confidenceLevel Confidence level for diagnostic performance
#'   intervals
#' @param crossValidation Perform cross-validation for diagnostic performance
#' @param minimumGroupSize Minimum samples per diagnostic group for analysis
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$diagnosticPerformance} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$differentialResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$confusionMatrix} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$panelOptimization} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$rocPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$diagnosticPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$diagnosticPerformance$asDF}
#'
#' \code{as.data.frame(results$diagnosticPerformance)}
#'
#' @export
ihcdiagnostic <- function(
    data,
    markers,
    diagnosis,
    id = NULL,
    differentialDiagnosis = TRUE,
    antibodyOptimization = FALSE,
    calculateDiagnosticMetrics = TRUE,
    clusterMethod = "hierarchical",
    cutpointMethod = "optimal",
    confidenceLevel = 0.95,
    crossValidation = TRUE,
    minimumGroupSize = 10) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("ihcdiagnostic requires jmvcore to be installed (restart may be required)")

    if ( ! missing(markers)) markers <- jmvcore::resolveQuo(jmvcore::enquo(markers))
    if ( ! missing(diagnosis)) diagnosis <- jmvcore::resolveQuo(jmvcore::enquo(diagnosis))
    if ( ! missing(id)) id <- jmvcore::resolveQuo(jmvcore::enquo(id))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(markers), markers, NULL),
            `if`( ! missing(diagnosis), diagnosis, NULL),
            `if`( ! missing(id), id, NULL))

    for (v in diagnosis) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- ihcdiagnosticOptions$new(
        markers = markers,
        diagnosis = diagnosis,
        id = id,
        differentialDiagnosis = differentialDiagnosis,
        antibodyOptimization = antibodyOptimization,
        calculateDiagnosticMetrics = calculateDiagnosticMetrics,
        clusterMethod = clusterMethod,
        cutpointMethod = cutpointMethod,
        confidenceLevel = confidenceLevel,
        crossValidation = crossValidation,
        minimumGroupSize = minimumGroupSize)

    analysis <- ihcdiagnosticClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

