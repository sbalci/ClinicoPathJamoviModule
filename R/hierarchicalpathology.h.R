
# This file is automatically generated, you probably don't want to edit this

hierarchicalpathologyOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "hierarchicalpathologyOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            dependent = NULL,
            level_3 = NULL,
            level_2 = NULL,
            level_1 = NULL,
            covariates = NULL,
            model_type = "linear",
            descriptives = TRUE,
            variance_components = TRUE,
            icc_analysis = TRUE,
            random_effects = TRUE,
            model_comparison = FALSE,
            diagnostics = TRUE,
            confidence_level = 0.95,
            optimizer = "bobyqa",
            max_iterations = 1000, ...) {

            super$initialize(
                package="ClinicoPath",
                name="hierarchicalpathology",
                requiresData=TRUE,
                ...)

            private$..dependent <- jmvcore::OptionVariable$new(
                "dependent",
                dependent,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..level_3 <- jmvcore::OptionVariable$new(
                "level_3",
                level_3,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..level_2 <- jmvcore::OptionVariable$new(
                "level_2",
                level_2,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..level_1 <- jmvcore::OptionVariable$new(
                "level_1",
                level_1,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..model_type <- jmvcore::OptionList$new(
                "model_type",
                model_type,
                options=list(
                    "linear",
                    "logistic",
                    "poisson",
                    "negative_binomial"),
                default="linear")
            private$..descriptives <- jmvcore::OptionBool$new(
                "descriptives",
                descriptives,
                default=TRUE)
            private$..variance_components <- jmvcore::OptionBool$new(
                "variance_components",
                variance_components,
                default=TRUE)
            private$..icc_analysis <- jmvcore::OptionBool$new(
                "icc_analysis",
                icc_analysis,
                default=TRUE)
            private$..random_effects <- jmvcore::OptionBool$new(
                "random_effects",
                random_effects,
                default=TRUE)
            private$..model_comparison <- jmvcore::OptionBool$new(
                "model_comparison",
                model_comparison,
                default=FALSE)
            private$..diagnostics <- jmvcore::OptionBool$new(
                "diagnostics",
                diagnostics,
                default=TRUE)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..optimizer <- jmvcore::OptionList$new(
                "optimizer",
                optimizer,
                options=list(
                    "bobyqa",
                    "Nelder_Mead",
                    "nlminb"),
                default="bobyqa")
            private$..max_iterations <- jmvcore::OptionInteger$new(
                "max_iterations",
                max_iterations,
                min=100,
                max=10000,
                default=1000)

            self$.addOption(private$..dependent)
            self$.addOption(private$..level_3)
            self$.addOption(private$..level_2)
            self$.addOption(private$..level_1)
            self$.addOption(private$..covariates)
            self$.addOption(private$..model_type)
            self$.addOption(private$..descriptives)
            self$.addOption(private$..variance_components)
            self$.addOption(private$..icc_analysis)
            self$.addOption(private$..random_effects)
            self$.addOption(private$..model_comparison)
            self$.addOption(private$..diagnostics)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..optimizer)
            self$.addOption(private$..max_iterations)
        }),
    active = list(
        dependent = function() private$..dependent$value,
        level_3 = function() private$..level_3$value,
        level_2 = function() private$..level_2$value,
        level_1 = function() private$..level_1$value,
        covariates = function() private$..covariates$value,
        model_type = function() private$..model_type$value,
        descriptives = function() private$..descriptives$value,
        variance_components = function() private$..variance_components$value,
        icc_analysis = function() private$..icc_analysis$value,
        random_effects = function() private$..random_effects$value,
        model_comparison = function() private$..model_comparison$value,
        diagnostics = function() private$..diagnostics$value,
        confidence_level = function() private$..confidence_level$value,
        optimizer = function() private$..optimizer$value,
        max_iterations = function() private$..max_iterations$value),
    private = list(
        ..dependent = NA,
        ..level_3 = NA,
        ..level_2 = NA,
        ..level_1 = NA,
        ..covariates = NA,
        ..model_type = NA,
        ..descriptives = NA,
        ..variance_components = NA,
        ..icc_analysis = NA,
        ..random_effects = NA,
        ..model_comparison = NA,
        ..diagnostics = NA,
        ..confidence_level = NA,
        ..optimizer = NA,
        ..max_iterations = NA)
)

hierarchicalpathologyResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "hierarchicalpathologyResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        descriptives = function() private$.items[["descriptives"]],
        modelresults = function() private$.items[["modelresults"]],
        randomeffects = function() private$.items[["randomeffects"]],
        variancecomponents = function() private$.items[["variancecomponents"]],
        icc = function() private$.items[["icc"]],
        modelcomparison = function() private$.items[["modelcomparison"]],
        diagnosticplot = function() private$.items[["diagnosticplot"]],
        residualplot = function() private$.items[["residualplot"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Hierarchical Mixed-Effects Models")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Getting Started",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="descriptives",
                title="Descriptive Statistics by Level",
                visible="(descriptives)",
                clearWith=list(
                    "dependent",
                    "level_3",
                    "level_2",
                    "level_1"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelresults",
                title="Fixed Effects Results",
                clearWith=list(
                    "dependent",
                    "level_3",
                    "level_2",
                    "level_1",
                    "covariates",
                    "model_type"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="randomeffects",
                title="Random Effects Summary",
                visible="(random_effects)",
                clearWith=list(
                    "dependent",
                    "level_3",
                    "level_2",
                    "level_1",
                    "model_type"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="variancecomponents",
                title="Variance Components",
                visible="(variance_components)",
                clearWith=list(
                    "dependent",
                    "level_3",
                    "level_2",
                    "level_1",
                    "model_type"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="icc",
                title="Intraclass Correlation Coefficients",
                visible="(icc_analysis)",
                clearWith=list(
                    "dependent",
                    "level_3",
                    "level_2",
                    "level_1",
                    "model_type"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelcomparison",
                title="Model Comparison",
                visible="(model_comparison)",
                clearWith=list(
                    "dependent",
                    "level_3",
                    "level_2",
                    "level_1",
                    "covariates",
                    "model_type"),
                columns=list()))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagnosticplot",
                title="Model Diagnostic Plots",
                width=800,
                height=600,
                visible="(diagnostics)",
                requiresData=TRUE,
                clearWith=list(
                    "dependent",
                    "level_3",
                    "level_2",
                    "level_1",
                    "model_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="residualplot",
                title="Hierarchical Residual Plots",
                width=600,
                height=500,
                visible="(diagnostics)",
                requiresData=TRUE,
                clearWith=list(
                    "dependent",
                    "level_3",
                    "level_2",
                    "level_1",
                    "model_type")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation and Guidelines",
                visible=TRUE))}))

hierarchicalpathologyBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "hierarchicalpathologyBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "hierarchicalpathology",
                version = c(1,0,0),
                options = options,
                results = hierarchicalpathologyResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = TRUE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Hierarchical Mixed-Effects Models
#'
#' Hierarchical (multilevel) mixed-effects models for analyzing nested 
#' pathology data structures. Essential for WSI analysis with Patient > 
#' Slide > ROI > Cell hierarchies, and prevents Type I errors from ignoring 
#' clustering effects.
#' 
#'
#' @examples
#' data('histopathology')
#'
#' hierarchicalpathology(data = histopathology,
#'                      dependent = measurement,
#'                      level_3 = patient_id,
#'                      level_2 = slide_id,
#'                      level_1 = roi_id)
#'
#' @param data the data as a data frame
#' @param dependent The dependent variable from \code{data}, variable must be
#'   numeric
#' @param level_3 Highest level grouping variable (e.g., Patient ID,
#'   Institution)
#' @param level_2 Intermediate level grouping variable (e.g., Slide ID, Sample
#'   ID)
#' @param level_1 Lowest level grouping variable (e.g., ROI ID, Field ID)
#' @param covariates Optional covariates for fixed effects (age, treatment,
#'   etc.)
#' @param model_type Type of mixed-effects model based on outcome variable
#' @param descriptives Show descriptive statistics by hierarchical level
#' @param variance_components Calculate and display variance components
#' @param icc_analysis Calculate Intraclass Correlation Coefficients
#' @param random_effects Display random effects variance and standard
#'   deviations
#' @param model_comparison Compare nested models with likelihood ratio tests
#' @param diagnostics Generate diagnostic plots and residual analysis
#' @param confidence_level Confidence level for parameter estimates and
#'   intervals
#' @param optimizer Optimization algorithm for model fitting
#' @param max_iterations Maximum number of iterations for model convergence
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab Instructions for hierarchical mixed-effects modeling \cr
#'   \code{results$descriptives} \tab \tab \tab \tab \tab Summary statistics for each hierarchical level \cr
#'   \code{results$modelresults} \tab \tab \tab \tab \tab Fixed effects parameter estimates and tests \cr
#'   \code{results$randomeffects} \tab \tab \tab \tab \tab Random effects variance components \cr
#'   \code{results$variancecomponents} \tab \tab \tab \tab \tab Partition of variance across hierarchical levels \cr
#'   \code{results$icc} \tab \tab \tab \tab \tab ICC values indicating clustering effects \cr
#'   \code{results$modelcomparison} \tab \tab \tab \tab \tab Likelihood ratio tests comparing nested models \cr
#'   \code{results$diagnosticplot} \tab \tab \tab \tab \tab Residual plots and diagnostic checks \cr
#'   \code{results$residualplot} \tab \tab \tab \tab \tab Residuals plotted by hierarchical level \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab Clinical context and interpretation for hierarchical models \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$descriptives$asDF}
#'
#' \code{as.data.frame(results$descriptives)}
#'
#' @export
hierarchicalpathology <- function(
    data,
    dependent,
    level_3,
    level_2,
    level_1,
    covariates,
    model_type = "linear",
    descriptives = TRUE,
    variance_components = TRUE,
    icc_analysis = TRUE,
    random_effects = TRUE,
    model_comparison = FALSE,
    diagnostics = TRUE,
    confidence_level = 0.95,
    optimizer = "bobyqa",
    max_iterations = 1000) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("hierarchicalpathology requires jmvcore to be installed (restart may be required)")

    if ( ! missing(dependent)) dependent <- jmvcore::resolveQuo(jmvcore::enquo(dependent))
    if ( ! missing(level_3)) level_3 <- jmvcore::resolveQuo(jmvcore::enquo(level_3))
    if ( ! missing(level_2)) level_2 <- jmvcore::resolveQuo(jmvcore::enquo(level_2))
    if ( ! missing(level_1)) level_1 <- jmvcore::resolveQuo(jmvcore::enquo(level_1))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(dependent), dependent, NULL),
            `if`( ! missing(level_3), level_3, NULL),
            `if`( ! missing(level_2), level_2, NULL),
            `if`( ! missing(level_1), level_1, NULL),
            `if`( ! missing(covariates), covariates, NULL))

    for (v in level_3) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in level_2) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in level_1) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- hierarchicalpathologyOptions$new(
        dependent = dependent,
        level_3 = level_3,
        level_2 = level_2,
        level_1 = level_1,
        covariates = covariates,
        model_type = model_type,
        descriptives = descriptives,
        variance_components = variance_components,
        icc_analysis = icc_analysis,
        random_effects = random_effects,
        model_comparison = model_comparison,
        diagnostics = diagnostics,
        confidence_level = confidence_level,
        optimizer = optimizer,
        max_iterations = max_iterations)

    analysis <- hierarchicalpathologyClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

