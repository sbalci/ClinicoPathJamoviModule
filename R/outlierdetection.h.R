
# This file is automatically generated, you probably don't want to edit this

outlierdetectionOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "outlierdetectionOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            vars = NULL,
            method_category = "composite",
            univariate_methods = "zscore_robust",
            multivariate_methods = "mahalanobis",
            composite_threshold = 0.5,
            zscore_threshold = 3.29,
            iqr_multiplier = 1.7,
            confidence_level = 0.999,
            show_outlier_table = TRUE,
            show_method_comparison = TRUE,
            show_exclusion_summary = TRUE,
            show_visualization = TRUE,
            show_interpretation = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="outlierdetection",
                requiresData=TRUE,
                ...)

            private$..vars <- jmvcore::OptionVariables$new(
                "vars",
                vars,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..method_category <- jmvcore::OptionList$new(
                "method_category",
                method_category,
                options=list(
                    "univariate",
                    "multivariate",
                    "composite",
                    "all"),
                default="composite")
            private$..univariate_methods <- jmvcore::OptionList$new(
                "univariate_methods",
                univariate_methods,
                options=list(
                    "zscore_robust",
                    "zscore",
                    "iqr",
                    "eti",
                    "hdi"),
                default="zscore_robust")
            private$..multivariate_methods <- jmvcore::OptionList$new(
                "multivariate_methods",
                multivariate_methods,
                options=list(
                    "mahalanobis",
                    "mahalanobis_robust",
                    "mcd",
                    "optics",
                    "lof"),
                default="mahalanobis")
            private$..composite_threshold <- jmvcore::OptionNumber$new(
                "composite_threshold",
                composite_threshold,
                min=0.1,
                max=1,
                default=0.5)
            private$..zscore_threshold <- jmvcore::OptionNumber$new(
                "zscore_threshold",
                zscore_threshold,
                min=1,
                max=5,
                default=3.29)
            private$..iqr_multiplier <- jmvcore::OptionNumber$new(
                "iqr_multiplier",
                iqr_multiplier,
                min=1,
                max=3,
                default=1.7)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.9,
                max=0.999,
                default=0.999)
            private$..show_outlier_table <- jmvcore::OptionBool$new(
                "show_outlier_table",
                show_outlier_table,
                default=TRUE)
            private$..show_method_comparison <- jmvcore::OptionBool$new(
                "show_method_comparison",
                show_method_comparison,
                default=TRUE)
            private$..show_exclusion_summary <- jmvcore::OptionBool$new(
                "show_exclusion_summary",
                show_exclusion_summary,
                default=TRUE)
            private$..show_visualization <- jmvcore::OptionBool$new(
                "show_visualization",
                show_visualization,
                default=TRUE)
            private$..show_interpretation <- jmvcore::OptionBool$new(
                "show_interpretation",
                show_interpretation,
                default=TRUE)

            self$.addOption(private$..vars)
            self$.addOption(private$..method_category)
            self$.addOption(private$..univariate_methods)
            self$.addOption(private$..multivariate_methods)
            self$.addOption(private$..composite_threshold)
            self$.addOption(private$..zscore_threshold)
            self$.addOption(private$..iqr_multiplier)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..show_outlier_table)
            self$.addOption(private$..show_method_comparison)
            self$.addOption(private$..show_exclusion_summary)
            self$.addOption(private$..show_visualization)
            self$.addOption(private$..show_interpretation)
        }),
    active = list(
        vars = function() private$..vars$value,
        method_category = function() private$..method_category$value,
        univariate_methods = function() private$..univariate_methods$value,
        multivariate_methods = function() private$..multivariate_methods$value,
        composite_threshold = function() private$..composite_threshold$value,
        zscore_threshold = function() private$..zscore_threshold$value,
        iqr_multiplier = function() private$..iqr_multiplier$value,
        confidence_level = function() private$..confidence_level$value,
        show_outlier_table = function() private$..show_outlier_table$value,
        show_method_comparison = function() private$..show_method_comparison$value,
        show_exclusion_summary = function() private$..show_exclusion_summary$value,
        show_visualization = function() private$..show_visualization$value,
        show_interpretation = function() private$..show_interpretation$value),
    private = list(
        ..vars = NA,
        ..method_category = NA,
        ..univariate_methods = NA,
        ..multivariate_methods = NA,
        ..composite_threshold = NA,
        ..zscore_threshold = NA,
        ..iqr_multiplier = NA,
        ..confidence_level = NA,
        ..show_outlier_table = NA,
        ..show_method_comparison = NA,
        ..show_exclusion_summary = NA,
        ..show_visualization = NA,
        ..show_interpretation = NA)
)

outlierdetectionResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "outlierdetectionResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        plot = function() private$.items[["plot"]],
        outlier_table = function() private$.items[["outlier_table"]],
        method_comparison = function() private$.items[["method_comparison"]],
        exclusion_summary = function() private$.items[["exclusion_summary"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Advanced Outlier Detection",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "performance",
                    "anomalydetection",
                    "lofoutlier"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Instructions",
                visible=FALSE))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot",
                title="Advanced Outlier Detection Plot",
                width=800,
                height=600,
                renderFun=".plot",
                visible="(show_visualization)",
                requiresData=TRUE,
                clearWith=list(
                    "vars",
                    "method_category",
                    "univariate_methods",
                    "multivariate_methods",
                    "composite_threshold",
                    "zscore_threshold",
                    "iqr_multiplier",
                    "confidence_level")))
            self$add(jmvcore::Html$new(
                options=options,
                name="outlier_table",
                title="Outlier Detection Results",
                visible="(show_outlier_table)",
                clearWith=list(
                    "vars",
                    "method_category",
                    "univariate_methods",
                    "multivariate_methods",
                    "composite_threshold",
                    "zscore_threshold",
                    "iqr_multiplier",
                    "confidence_level")))
            self$add(jmvcore::Html$new(
                options=options,
                name="method_comparison",
                title="Method Comparison",
                visible="(show_method_comparison)",
                clearWith=list(
                    "vars",
                    "method_category",
                    "composite_threshold",
                    "zscore_threshold",
                    "iqr_multiplier",
                    "confidence_level")))
            self$add(jmvcore::Html$new(
                options=options,
                name="exclusion_summary",
                title="Exclusion Recommendations",
                visible="(show_exclusion_summary)",
                clearWith=list(
                    "vars",
                    "method_category",
                    "univariate_methods",
                    "multivariate_methods",
                    "composite_threshold",
                    "zscore_threshold",
                    "iqr_multiplier",
                    "confidence_level")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Analysis Interpretation",
                visible="(show_interpretation)",
                clearWith=list(
                    "vars",
                    "method_category",
                    "univariate_methods",
                    "multivariate_methods")))}))

outlierdetectionBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "outlierdetectionBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "outlierdetection",
                version = c(0,0,31),
                options = options,
                results = outlierdetectionResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Advanced Outlier Detection
#'
#' Advanced outlier detection using multiple statistical methods from the 
#' easystats performance package.
#' This module provides comprehensive outlier detection through univariate 
#' methods (Z-scores, IQR, confidence intervals),
#' multivariate methods (Mahalanobis distance, MCD, OPTICS, LOF), and 
#' composite scoring across multiple algorithms.
#' Complements existing data quality assessment modules with state-of-the-art 
#' outlier detection capabilities.
#' Perfect for clinical research data quality control and preprocessing.
#' 
#'
#' @examples
#' \donttest{
#' # Example:
#' # 1. Select variables for outlier detection analysis.
#' # 2. Choose detection methods (univariate, multivariate, or composite).
#' # 3. Configure thresholds and visualization options.
#' # 4. Review outlier results and exclusion recommendations.
#'}
#' @param data The data as a data frame.
#' @param vars Continuous variables to analyze for outliers. The module will
#'   detect outliers based on the selected variables using the chosen detection
#'   methods.
#' @param method_category Category of outlier detection methods to use.
#'   CLINICAL GUIDANCE: Univariate methods analyze each variable separately
#'   (ideal for lab values, vital signs). Multivariate methods consider
#'   relationships between variables (useful for correlated biomarkers).
#'   Composite combines multiple approaches for robust detection (recommended
#'   for most clinical data). Examples: Use univariate for hemoglobin levels,
#'   multivariate for complete blood count panels.
#' @param univariate_methods Specific univariate method for outlier detection
#'   when univariate category is selected.
#' @param multivariate_methods Specific multivariate method for outlier
#'   detection when multivariate category is selected.
#' @param composite_threshold Threshold for composite outlier score (0.1-1.0).
#'   Default 0.5 means observations  classified as outliers by at least half of
#'   the methods are considered outliers.
#' @param zscore_threshold Threshold for Z-score based methods. CLINICAL
#'   EXAMPLES: 3.0 = 99.7\% confidence (standard screening for most lab values),
#'   3.29 = 99.9\% confidence (stringent, for critical values like cardiac
#'   enzymes), 2.5 = 98.8\% confidence (sensitive detection for research).
#'   Recommended: 3.29 for clinical quality control.
#' @param iqr_multiplier Multiplier for IQR-based outlier detection. CLINICAL
#'   EXAMPLES: 1.5 = Tukey's standard (sensitive, may flag ~0.7\% of normal
#'   data), 1.7 = conservative (recommended for clinical screening), 2.0 = very
#'   conservative (for critical biomarkers). Useful for non-normal distributions
#'   common in clinical data.
#' @param confidence_level Confidence level for interval-based methods (ETI,
#'   HDI). Default 99.9\% identifies the most extreme observations.
#' @param show_outlier_table Display a comprehensive table of outlier
#'   detection results including outlier scores, distances, and classification
#'   for each observation.
#' @param show_method_comparison Compare results across different detection
#'   methods when using composite approach.
#' @param show_exclusion_summary Provide summary of observations recommended
#'   for exclusion and impact analysis.
#' @param show_visualization Generate plots showing outlier detection results
#'   and distribution of outlier scores.
#' @param show_interpretation Display detailed interpretation of outlier
#'   detection results and methodological notes.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$outlier_table} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$method_comparison} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$exclusion_summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' @export
outlierdetection <- function(
    data,
    vars,
    method_category = "composite",
    univariate_methods = "zscore_robust",
    multivariate_methods = "mahalanobis",
    composite_threshold = 0.5,
    zscore_threshold = 3.29,
    iqr_multiplier = 1.7,
    confidence_level = 0.999,
    show_outlier_table = TRUE,
    show_method_comparison = TRUE,
    show_exclusion_summary = TRUE,
    show_visualization = TRUE,
    show_interpretation = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("outlierdetection requires jmvcore to be installed (restart may be required)")

    if ( ! missing(vars)) vars <- jmvcore::resolveQuo(jmvcore::enquo(vars))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(vars), vars, NULL))


    options <- outlierdetectionOptions$new(
        vars = vars,
        method_category = method_category,
        univariate_methods = univariate_methods,
        multivariate_methods = multivariate_methods,
        composite_threshold = composite_threshold,
        zscore_threshold = zscore_threshold,
        iqr_multiplier = iqr_multiplier,
        confidence_level = confidence_level,
        show_outlier_table = show_outlier_table,
        show_method_comparison = show_method_comparison,
        show_exclusion_summary = show_exclusion_summary,
        show_visualization = show_visualization,
        show_interpretation = show_interpretation)

    analysis <- outlierdetectionClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

