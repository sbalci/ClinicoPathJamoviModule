
# This file is automatically generated, you probably don't want to edit this

flexcompriskOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "flexcompriskOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            event = NULL,
            covs = NULL,
            eventOfInterest = 1,
            modelType = "splines",
            splineType = "rcs",
            splineDf = 4,
            timeInteractions = NULL,
            validationType = "cv",
            cvFolds = 5,
            bootstrapSamples = 500,
            predictionTimes = "1, 3, 5",
            conf = 0.95,
            showModelComparison = TRUE,
            showValidationResults = TRUE,
            showPredictions = TRUE,
            showEducational = TRUE,
            plotCumulativeIncidence = TRUE,
            plotModelComparison = FALSE,
            plotValidation = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="flexcomprisk",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event <- jmvcore::OptionVariable$new(
                "event",
                event,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..covs <- jmvcore::OptionVariables$new(
                "covs",
                covs,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..eventOfInterest <- jmvcore::OptionNumber$new(
                "eventOfInterest",
                eventOfInterest,
                min=1,
                max=10,
                default=1)
            private$..modelType <- jmvcore::OptionList$new(
                "modelType",
                modelType,
                options=list(
                    "splines",
                    "forest",
                    "timevarying",
                    "causespecific",
                    "finegray",
                    "ensemble"),
                default="splines")
            private$..splineType <- jmvcore::OptionList$new(
                "splineType",
                splineType,
                options=list(
                    "ns",
                    "rcs",
                    "bs",
                    "ps"),
                default="rcs")
            private$..splineDf <- jmvcore::OptionNumber$new(
                "splineDf",
                splineDf,
                min=2,
                max=10,
                default=4)
            private$..timeInteractions <- jmvcore::OptionVariables$new(
                "timeInteractions",
                timeInteractions,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..validationType <- jmvcore::OptionList$new(
                "validationType",
                validationType,
                options=list(
                    "cv",
                    "bootstrap",
                    "split",
                    "none"),
                default="cv")
            private$..cvFolds <- jmvcore::OptionNumber$new(
                "cvFolds",
                cvFolds,
                min=3,
                max=10,
                default=5)
            private$..bootstrapSamples <- jmvcore::OptionNumber$new(
                "bootstrapSamples",
                bootstrapSamples,
                min=100,
                max=2000,
                default=500)
            private$..predictionTimes <- jmvcore::OptionString$new(
                "predictionTimes",
                predictionTimes,
                default="1, 3, 5")
            private$..conf <- jmvcore::OptionNumber$new(
                "conf",
                conf,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..showModelComparison <- jmvcore::OptionBool$new(
                "showModelComparison",
                showModelComparison,
                default=TRUE)
            private$..showValidationResults <- jmvcore::OptionBool$new(
                "showValidationResults",
                showValidationResults,
                default=TRUE)
            private$..showPredictions <- jmvcore::OptionBool$new(
                "showPredictions",
                showPredictions,
                default=TRUE)
            private$..showEducational <- jmvcore::OptionBool$new(
                "showEducational",
                showEducational,
                default=TRUE)
            private$..plotCumulativeIncidence <- jmvcore::OptionBool$new(
                "plotCumulativeIncidence",
                plotCumulativeIncidence,
                default=TRUE)
            private$..plotModelComparison <- jmvcore::OptionBool$new(
                "plotModelComparison",
                plotModelComparison,
                default=FALSE)
            private$..plotValidation <- jmvcore::OptionBool$new(
                "plotValidation",
                plotValidation,
                default=FALSE)

            self$.addOption(private$..time)
            self$.addOption(private$..event)
            self$.addOption(private$..covs)
            self$.addOption(private$..eventOfInterest)
            self$.addOption(private$..modelType)
            self$.addOption(private$..splineType)
            self$.addOption(private$..splineDf)
            self$.addOption(private$..timeInteractions)
            self$.addOption(private$..validationType)
            self$.addOption(private$..cvFolds)
            self$.addOption(private$..bootstrapSamples)
            self$.addOption(private$..predictionTimes)
            self$.addOption(private$..conf)
            self$.addOption(private$..showModelComparison)
            self$.addOption(private$..showValidationResults)
            self$.addOption(private$..showPredictions)
            self$.addOption(private$..showEducational)
            self$.addOption(private$..plotCumulativeIncidence)
            self$.addOption(private$..plotModelComparison)
            self$.addOption(private$..plotValidation)
        }),
    active = list(
        time = function() private$..time$value,
        event = function() private$..event$value,
        covs = function() private$..covs$value,
        eventOfInterest = function() private$..eventOfInterest$value,
        modelType = function() private$..modelType$value,
        splineType = function() private$..splineType$value,
        splineDf = function() private$..splineDf$value,
        timeInteractions = function() private$..timeInteractions$value,
        validationType = function() private$..validationType$value,
        cvFolds = function() private$..cvFolds$value,
        bootstrapSamples = function() private$..bootstrapSamples$value,
        predictionTimes = function() private$..predictionTimes$value,
        conf = function() private$..conf$value,
        showModelComparison = function() private$..showModelComparison$value,
        showValidationResults = function() private$..showValidationResults$value,
        showPredictions = function() private$..showPredictions$value,
        showEducational = function() private$..showEducational$value,
        plotCumulativeIncidence = function() private$..plotCumulativeIncidence$value,
        plotModelComparison = function() private$..plotModelComparison$value,
        plotValidation = function() private$..plotValidation$value),
    private = list(
        ..time = NA,
        ..event = NA,
        ..covs = NA,
        ..eventOfInterest = NA,
        ..modelType = NA,
        ..splineType = NA,
        ..splineDf = NA,
        ..timeInteractions = NA,
        ..validationType = NA,
        ..cvFolds = NA,
        ..bootstrapSamples = NA,
        ..predictionTimes = NA,
        ..conf = NA,
        ..showModelComparison = NA,
        ..showValidationResults = NA,
        ..showPredictions = NA,
        ..showEducational = NA,
        ..plotCumulativeIncidence = NA,
        ..plotModelComparison = NA,
        ..plotValidation = NA)
)

flexcompriskResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "flexcompriskResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        educationalInfo = function() private$.items[["educationalInfo"]],
        modelSummary = function() private$.items[["modelSummary"]],
        coefficientsTable = function() private$.items[["coefficientsTable"]],
        predictionsTable = function() private$.items[["predictionsTable"]],
        modelComparisonTable = function() private$.items[["modelComparisonTable"]],
        validationResults = function() private$.items[["validationResults"]],
        timeVaryingEffects = function() private$.items[["timeVaryingEffects"]],
        methodsInfo = function() private$.items[["methodsInfo"]],
        recommendationsInfo = function() private$.items[["recommendationsInfo"]],
        cifPlot = function() private$.items[["cifPlot"]],
        modelComparisonPlot = function() private$.items[["modelComparisonPlot"]],
        validationPlot = function() private$.items[["validationPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Flexible Competing Risks Models",
                refs=list(
                    "riskRegression",
                    "survival",
                    "splines",
                    "randomForestSRC",
                    "ClinicoPathJamoviModule",
                    "tools",
                    "scales"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="To Do",
                clearWith=list(
                    "time",
                    "event",
                    "covs")))
            self$add(jmvcore::Html$new(
                options=options,
                name="educationalInfo",
                title="Flexible Competing Risks Guide",
                visible="(showEducational)",
                clearWith=list(
                    "time",
                    "event")))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                rows=1,
                columns=list(
                    list(
                        `name`="model_type", 
                        `title`="Model Type", 
                        `type`="text"),
                    list(
                        `name`="n_events", 
                        `title`="Events", 
                        `type`="number"),
                    list(
                        `name`="n_competing", 
                        `title`="Competing", 
                        `type`="number"),
                    list(
                        `name`="n_censored", 
                        `title`="Censored", 
                        `type`="number"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number")),
                clearWith=list(
                    "time",
                    "event",
                    "covs",
                    "modelType")))
            self$add(jmvcore::Table$new(
                options=options,
                name="coefficientsTable",
                title="Model Coefficients",
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="z_value", 
                        `title`="z-value", 
                        `type`="number"),
                    list(
                        `name`="pvalue", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Effect", 
                        `type`="text")),
                clearWith=list(
                    "time",
                    "event",
                    "covs",
                    "modelType")))
            self$add(jmvcore::Table$new(
                options=options,
                name="predictionsTable",
                title="Cumulative Incidence Predictions",
                visible="(showPredictions)",
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="cif_estimate", 
                        `title`="CIF", 
                        `type`="number"),
                    list(
                        `name`="cif_se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="cif_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="cif_upper", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="risk_level", 
                        `title`="Risk Level", 
                        `type`="text")),
                clearWith=list(
                    "time",
                    "event",
                    "covs",
                    "predictionTimes")))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelComparisonTable",
                title="Model Performance Comparison",
                visible="(showModelComparison)",
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="c_index", 
                        `title`="C-Index", 
                        `type`="number"),
                    list(
                        `name`="ibs", 
                        `title`="IBS", 
                        `type`="number"),
                    list(
                        `name`="auc", 
                        `title`="AUC (5-year)", 
                        `type`="number"),
                    list(
                        `name`="brier_score", 
                        `title`="Brier Score", 
                        `type`="number"),
                    list(
                        `name`="rank", 
                        `title`="Rank", 
                        `type`="text")),
                clearWith=list(
                    "modelType",
                    "showModelComparison")))
            self$add(jmvcore::Table$new(
                options=options,
                name="validationResults",
                title="Validation Results",
                visible="(showValidationResults)",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Validation Metric", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="cv_mean", 
                        `title`="CV Mean", 
                        `type`="number"),
                    list(
                        `name`="cv_se", 
                        `title`="CV SE", 
                        `type`="number"),
                    list(
                        `name`="optimism", 
                        `title`="Optimism", 
                        `type`="number"),
                    list(
                        `name`="corrected", 
                        `title`="Corrected", 
                        `type`="number")),
                clearWith=list(
                    "validationType",
                    "cvFolds")))
            self$add(jmvcore::Table$new(
                options=options,
                name="timeVaryingEffects",
                title="Time-Varying Effects",
                visible="(timeInteractions)",
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="effect", 
                        `title`="Effect", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="pvalue", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Trend", 
                        `type`="text")),
                clearWith=list(
                    "timeInteractions",
                    "time",
                    "event")))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodsInfo",
                title="Statistical Methods",
                clearWith=list(
                    "modelType",
                    "validationType")))
            self$add(jmvcore::Html$new(
                options=options,
                name="recommendationsInfo",
                title="Model Selection Recommendations",
                clearWith=list(
                    "modelType",
                    "showModelComparison")))
            self$add(jmvcore::Image$new(
                options=options,
                name="cifPlot",
                title="Cumulative Incidence Functions",
                width=800,
                height=600,
                renderFun=".cifPlot",
                visible="(plotCumulativeIncidence)",
                requiresData=TRUE,
                clearWith=list(
                    "time",
                    "event",
                    "covs",
                    "modelType")))
            self$add(jmvcore::Image$new(
                options=options,
                name="modelComparisonPlot",
                title="Model Performance Comparison",
                width=700,
                height=500,
                renderFun=".modelComparisonPlot",
                visible="(plotModelComparison)",
                requiresData=TRUE,
                clearWith=list(
                    "modelType",
                    "showModelComparison")))
            self$add(jmvcore::Image$new(
                options=options,
                name="validationPlot",
                title="Model Validation and Calibration",
                width=700,
                height=500,
                renderFun=".validationPlot",
                visible="(plotValidation)",
                requiresData=TRUE,
                clearWith=list(
                    "validationType",
                    "time",
                    "event")))}))

flexcompriskBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "flexcompriskBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "flexcomprisk",
                version = c(0,0,1),
                options = options,
                results = flexcompriskResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Flexible Competing Risks Models
#'
#' Performs flexible competing risks analysis using advanced regression  
#' techniques including spline-based hazards, time-varying effects, and  
#' robust prediction models with comprehensive model validation.
#' 
#'
#' @examples
#' \donttest{
#' # example will be added
#'}
#' @param data The data as a data frame.
#' @param time Follow-up time variable
#' @param event Event type variable (0=censored, 1=event of interest,
#'   2=competing event, etc.)
#' @param covs Covariates to include in the model
#' @param eventOfInterest Numeric code for the event of interest (primary
#'   event)
#' @param modelType Type of flexible competing risks model to fit
#' @param splineType Type of splines for flexible parametric models
#' @param splineDf Degrees of freedom for spline functions
#' @param timeInteractions Variables with time-varying effects (interactions
#'   with time)
#' @param validationType Method for model validation and performance
#'   assessment
#' @param cvFolds Number of folds for cross-validation
#' @param bootstrapSamples Number of bootstrap samples for validation
#' @param predictionTimes Comma-separated list of time points for prediction
#' @param conf Confidence level for confidence intervals
#' @param showModelComparison Compare performance across different model types
#' @param showValidationResults Display cross-validation and bootstrap results
#' @param showPredictions Display predicted cumulative incidence at specified
#'   time points
#' @param showEducational Display educational information about flexible
#'   competing risks models
#' @param plotCumulativeIncidence Display cumulative incidence function plots
#' @param plotModelComparison Display performance comparison plots across
#'   models
#' @param plotValidation Display validation and calibration plots
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$educationalInfo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$coefficientsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$predictionsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelComparisonTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$validationResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$timeVaryingEffects} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$methodsInfo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$recommendationsInfo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$cifPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$modelComparisonPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$validationPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelSummary$asDF}
#'
#' \code{as.data.frame(results$modelSummary)}
#'
#' @export
flexcomprisk <- function(
    data,
    time,
    event,
    covs,
    eventOfInterest = 1,
    modelType = "splines",
    splineType = "rcs",
    splineDf = 4,
    timeInteractions,
    validationType = "cv",
    cvFolds = 5,
    bootstrapSamples = 500,
    predictionTimes = "1, 3, 5",
    conf = 0.95,
    showModelComparison = TRUE,
    showValidationResults = TRUE,
    showPredictions = TRUE,
    showEducational = TRUE,
    plotCumulativeIncidence = TRUE,
    plotModelComparison = FALSE,
    plotValidation = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("flexcomprisk requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(event)) event <- jmvcore::resolveQuo(jmvcore::enquo(event))
    if ( ! missing(covs)) covs <- jmvcore::resolveQuo(jmvcore::enquo(covs))
    if ( ! missing(timeInteractions)) timeInteractions <- jmvcore::resolveQuo(jmvcore::enquo(timeInteractions))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(event), event, NULL),
            `if`( ! missing(covs), covs, NULL),
            `if`( ! missing(timeInteractions), timeInteractions, NULL))


    options <- flexcompriskOptions$new(
        time = time,
        event = event,
        covs = covs,
        eventOfInterest = eventOfInterest,
        modelType = modelType,
        splineType = splineType,
        splineDf = splineDf,
        timeInteractions = timeInteractions,
        validationType = validationType,
        cvFolds = cvFolds,
        bootstrapSamples = bootstrapSamples,
        predictionTimes = predictionTimes,
        conf = conf,
        showModelComparison = showModelComparison,
        showValidationResults = showValidationResults,
        showPredictions = showPredictions,
        showEducational = showEducational,
        plotCumulativeIncidence = plotCumulativeIncidence,
        plotModelComparison = plotModelComparison,
        plotValidation = plotValidation)

    analysis <- flexcompriskClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

