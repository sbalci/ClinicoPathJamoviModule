
# This file is automatically generated, you probably don't want to edit this

spatialanalysisOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "spatialanalysisOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            coords_x = NULL,
            coords_y = NULL,
            cell_types = NULL,
            groups = NULL,
            roi_id = NULL,
            perform_ripley = TRUE,
            perform_nnd = TRUE,
            perform_hotspot = TRUE,
            perform_interaction = TRUE,
            show_plots = TRUE,
            analysis_scope = "comprehensive",
            distance_method = "euclidean",
            correction_method = "both",
            significance_level = 0.05,
            min_points = 10, ...) {

            super$initialize(
                package="ClinicoPath",
                name="spatialanalysis",
                requiresData=TRUE,
                ...)

            private$..coords_x <- jmvcore::OptionVariable$new(
                "coords_x",
                coords_x,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..coords_y <- jmvcore::OptionVariable$new(
                "coords_y",
                coords_y,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..cell_types <- jmvcore::OptionVariable$new(
                "cell_types",
                cell_types,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..groups <- jmvcore::OptionVariable$new(
                "groups",
                groups,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..roi_id <- jmvcore::OptionVariable$new(
                "roi_id",
                roi_id,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..perform_ripley <- jmvcore::OptionBool$new(
                "perform_ripley",
                perform_ripley,
                default=TRUE)
            private$..perform_nnd <- jmvcore::OptionBool$new(
                "perform_nnd",
                perform_nnd,
                default=TRUE)
            private$..perform_hotspot <- jmvcore::OptionBool$new(
                "perform_hotspot",
                perform_hotspot,
                default=TRUE)
            private$..perform_interaction <- jmvcore::OptionBool$new(
                "perform_interaction",
                perform_interaction,
                default=TRUE)
            private$..show_plots <- jmvcore::OptionBool$new(
                "show_plots",
                show_plots,
                default=TRUE)
            private$..analysis_scope <- jmvcore::OptionList$new(
                "analysis_scope",
                analysis_scope,
                options=list(
                    "basic",
                    "comprehensive",
                    "clinical"),
                default="comprehensive")
            private$..distance_method <- jmvcore::OptionList$new(
                "distance_method",
                distance_method,
                options=list(
                    "euclidean",
                    "manhattan"),
                default="euclidean")
            private$..correction_method <- jmvcore::OptionList$new(
                "correction_method",
                correction_method,
                options=list(
                    "border",
                    "isotropic",
                    "both"),
                default="both")
            private$..significance_level <- jmvcore::OptionNumber$new(
                "significance_level",
                significance_level,
                min=0.001,
                max=0.1,
                default=0.05)
            private$..min_points <- jmvcore::OptionInteger$new(
                "min_points",
                min_points,
                min=5,
                max=100,
                default=10)

            self$.addOption(private$..coords_x)
            self$.addOption(private$..coords_y)
            self$.addOption(private$..cell_types)
            self$.addOption(private$..groups)
            self$.addOption(private$..roi_id)
            self$.addOption(private$..perform_ripley)
            self$.addOption(private$..perform_nnd)
            self$.addOption(private$..perform_hotspot)
            self$.addOption(private$..perform_interaction)
            self$.addOption(private$..show_plots)
            self$.addOption(private$..analysis_scope)
            self$.addOption(private$..distance_method)
            self$.addOption(private$..correction_method)
            self$.addOption(private$..significance_level)
            self$.addOption(private$..min_points)
        }),
    active = list(
        coords_x = function() private$..coords_x$value,
        coords_y = function() private$..coords_y$value,
        cell_types = function() private$..cell_types$value,
        groups = function() private$..groups$value,
        roi_id = function() private$..roi_id$value,
        perform_ripley = function() private$..perform_ripley$value,
        perform_nnd = function() private$..perform_nnd$value,
        perform_hotspot = function() private$..perform_hotspot$value,
        perform_interaction = function() private$..perform_interaction$value,
        show_plots = function() private$..show_plots$value,
        analysis_scope = function() private$..analysis_scope$value,
        distance_method = function() private$..distance_method$value,
        correction_method = function() private$..correction_method$value,
        significance_level = function() private$..significance_level$value,
        min_points = function() private$..min_points$value),
    private = list(
        ..coords_x = NA,
        ..coords_y = NA,
        ..cell_types = NA,
        ..groups = NA,
        ..roi_id = NA,
        ..perform_ripley = NA,
        ..perform_nnd = NA,
        ..perform_hotspot = NA,
        ..perform_interaction = NA,
        ..show_plots = NA,
        ..analysis_scope = NA,
        ..distance_method = NA,
        ..correction_method = NA,
        ..significance_level = NA,
        ..min_points = NA)
)

spatialanalysisResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "spatialanalysisResults",
    inherit = jmvcore::Group,
    active = list(
        text = function() private$.items[["text"]],
        summary = function() private$.items[["summary"]],
        ripley = function() private$.items[["ripley"]],
        nearestneighbor = function() private$.items[["nearestneighbor"]],
        hotspots = function() private$.items[["hotspots"]],
        interaction = function() private$.items[["interaction"]],
        spatialplot = function() private$.items[["spatialplot"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Spatial Statistics from Coordinates")
            self$add(jmvcore::Html$new(
                options=options,
                name="text",
                title="Getting Started",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="summary",
                title="Spatial Summary Statistics",
                columns=list(
                    list(
                        `name`="measure", 
                        `title`="Measure", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="description", 
                        `title`="Description", 
                        `type`="text")),
                clearWith=list(
                    "coords_x",
                    "coords_y",
                    "cell_types",
                    "roi_id")))
            self$add(jmvcore::Table$new(
                options=options,
                name="ripley",
                title="Ripley's K-function Analysis",
                columns=list(
                    list(
                        `name`="distance", 
                        `title`="Distance (r)", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="k_observed", 
                        `title`="K(r) Observed", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="k_theoretical", 
                        `title`="K(r) Theoretical", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="l_observed", 
                        `title`="L(r) Observed", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="l_theoretical", 
                        `title`="L(r) Theoretical", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="interpretation", 
                        `title`="Pattern", 
                        `type`="text")),
                visible="(perform_ripley)",
                clearWith=list(
                    "coords_x",
                    "coords_y",
                    "perform_ripley",
                    "correction_method")))
            self$add(jmvcore::Table$new(
                options=options,
                name="nearestneighbor",
                title="Nearest Neighbor Analysis",
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="expected", 
                        `title`="Expected", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ratio", 
                        `title`="R", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text")),
                visible="(perform_nnd)",
                clearWith=list(
                    "coords_x",
                    "coords_y",
                    "perform_nnd",
                    "distance_method")))
            self$add(jmvcore::Table$new(
                options=options,
                name="hotspots",
                title="Hotspot Detection Results",
                columns=list(
                    list(
                        `name`="measure", 
                        `title`="Measure", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text")),
                visible="(perform_hotspot)",
                clearWith=list(
                    "coords_x",
                    "coords_y",
                    "perform_hotspot")))
            self$add(jmvcore::Table$new(
                options=options,
                name="interaction",
                title="Multi-type Spatial Interaction",
                columns=list(
                    list(
                        `name`="type_i", 
                        `title`="Type i", 
                        `type`="text"),
                    list(
                        `name`="type_j", 
                        `title`="Type j", 
                        `type`="text"),
                    list(
                        `name`="distance", 
                        `title`="Distance (r)", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="pcf_observed", 
                        `title`="g(r) Observed", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="pcf_theoretical", 
                        `title`="g(r) Expected", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="interaction_type", 
                        `title`="Interaction", 
                        `type`="text"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text")),
                visible="(perform_interaction && cell_types)",
                clearWith=list(
                    "coords_x",
                    "coords_y",
                    "cell_types",
                    "perform_interaction")))
            self$add(jmvcore::Image$new(
                options=options,
                name="spatialplot",
                title="Spatial Distribution Plot",
                width=600,
                height=600,
                visible="(show_plots)",
                requiresData=TRUE,
                clearWith=list(
                    "coords_x",
                    "coords_y",
                    "cell_types",
                    "show_plots")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation and Context",
                visible=TRUE))}))

spatialanalysisBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "spatialanalysisBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "spatialanalysis",
                version = c(1,0,0),
                options = options,
                results = spatialanalysisResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Spatial Statistics from Coordinates
#'
#' 
#' @param data the data as a data frame
#' @param coords_x X coordinate variable (numeric). Must contain spatial
#'   position data for each observation.
#' @param coords_y Y coordinate variable (numeric). Must contain spatial
#'   position data for each observation.
#' @param cell_types Optional cell type variable for multi-type spatial
#'   analysis.  Should be a factor or character variable identifying different
#'   cell populations.
#' @param groups Optional grouping variable for comparing spatial patterns
#'   between conditions  (e.g., treatment vs control, tumor vs normal).
#' @param roi_id Optional ROI identifier for analyzing multiple tissue regions
#'   separately.
#' @param perform_ripley Perform Ripley's K-function analysis to detect
#'   spatial clustering or dispersion patterns.
#' @param perform_nnd Calculate nearest neighbor distances and perform
#'   Clark-Evans test for spatial randomness.
#' @param perform_hotspot Detect spatial hotspots using kernel density
#'   estimation and statistical thresholds.
#' @param perform_interaction Perform multi-type spatial interaction analysis
#'   when cell types are specified.
#' @param show_plots Create spatial distribution plots showing coordinate data
#'   with optional cell type coloring.
#' @param analysis_scope Analysis scope: basic (core statistics),
#'   comprehensive (all methods),  or clinical (pathology-focused
#'   interpretation).
#' @param distance_method Distance calculation method for spatial analysis.
#' @param correction_method Edge correction method for handling boundary
#'   effects in spatial analysis.
#' @param significance_level Alpha level for statistical significance testing.
#' @param min_points Minimum number of complete coordinate pairs required to
#'   perform spatial analysis.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$text} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab Basic spatial metrics including point counts, density, and study area \cr
#'   \code{results$ripley} \tab \tab \tab \tab \tab Spatial clustering analysis at multiple distance scales \cr
#'   \code{results$nearestneighbor} \tab \tab \tab \tab \tab Nearest neighbor distances and Clark-Evans randomness test \cr
#'   \code{results$hotspots} \tab \tab \tab \tab \tab Spatial hotspot analysis using kernel density estimation \cr
#'   \code{results$interaction} \tab \tab \tab \tab \tab Cross-type spatial relationships and interaction patterns \cr
#'   \code{results$spatialplot} \tab \tab \tab \tab \tab Visualization of spatial coordinate data with optional cell type coloring \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab Clinical significance and pathology applications of spatial patterns \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summary$asDF}
#'
#' \code{as.data.frame(results$summary)}
#'
#' @export
spatialanalysis <- function(
    data,
    coords_x,
    coords_y,
    cell_types,
    groups,
    roi_id,
    perform_ripley = TRUE,
    perform_nnd = TRUE,
    perform_hotspot = TRUE,
    perform_interaction = TRUE,
    show_plots = TRUE,
    analysis_scope = "comprehensive",
    distance_method = "euclidean",
    correction_method = "both",
    significance_level = 0.05,
    min_points = 10) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("spatialanalysis requires jmvcore to be installed (restart may be required)")

    if ( ! missing(coords_x)) coords_x <- jmvcore::resolveQuo(jmvcore::enquo(coords_x))
    if ( ! missing(coords_y)) coords_y <- jmvcore::resolveQuo(jmvcore::enquo(coords_y))
    if ( ! missing(cell_types)) cell_types <- jmvcore::resolveQuo(jmvcore::enquo(cell_types))
    if ( ! missing(groups)) groups <- jmvcore::resolveQuo(jmvcore::enquo(groups))
    if ( ! missing(roi_id)) roi_id <- jmvcore::resolveQuo(jmvcore::enquo(roi_id))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(coords_x), coords_x, NULL),
            `if`( ! missing(coords_y), coords_y, NULL),
            `if`( ! missing(cell_types), cell_types, NULL),
            `if`( ! missing(groups), groups, NULL),
            `if`( ! missing(roi_id), roi_id, NULL))

    for (v in cell_types) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in groups) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in roi_id) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- spatialanalysisOptions$new(
        coords_x = coords_x,
        coords_y = coords_y,
        cell_types = cell_types,
        groups = groups,
        roi_id = roi_id,
        perform_ripley = perform_ripley,
        perform_nnd = perform_nnd,
        perform_hotspot = perform_hotspot,
        perform_interaction = perform_interaction,
        show_plots = show_plots,
        analysis_scope = analysis_scope,
        distance_method = distance_method,
        correction_method = correction_method,
        significance_level = significance_level,
        min_points = min_points)

    analysis <- spatialanalysisClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

