
# This file is automatically generated, you probably don't want to edit this

pcacoxOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "pcacoxOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            status = NULL,
            predictors = NULL,
            clinical_vars = NULL,
            pca_method = "supervised",
            n_components = 5,
            component_selection = "cv",
            cv_folds = 10,
            variance_threshold = 0.8,
            scaling = TRUE,
            centering = TRUE,
            survival_weighting = TRUE,
            permutation_test = FALSE,
            n_permutations = 100,
            bootstrap_validation = TRUE,
            n_bootstrap = 100,
            plot_scree = TRUE,
            plot_loadings = TRUE,
            plot_biplot = TRUE,
            plot_survival = TRUE,
            risk_score = TRUE,
            pathway_analysis = FALSE,
            feature_importance = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="pcacox",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..status <- jmvcore::OptionVariable$new(
                "status",
                status,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..predictors <- jmvcore::OptionVariables$new(
                "predictors",
                predictors,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..clinical_vars <- jmvcore::OptionVariables$new(
                "clinical_vars",
                clinical_vars,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..pca_method <- jmvcore::OptionList$new(
                "pca_method",
                pca_method,
                options=list(
                    "supervised",
                    "standard",
                    "sparse",
                    "kernel"),
                default="supervised")
            private$..n_components <- jmvcore::OptionInteger$new(
                "n_components",
                n_components,
                default=5,
                min=1,
                max=50)
            private$..component_selection <- jmvcore::OptionList$new(
                "component_selection",
                component_selection,
                options=list(
                    "cv",
                    "fixed",
                    "variance",
                    "significance"),
                default="cv")
            private$..cv_folds <- jmvcore::OptionInteger$new(
                "cv_folds",
                cv_folds,
                default=10,
                min=3,
                max=20)
            private$..variance_threshold <- jmvcore::OptionNumber$new(
                "variance_threshold",
                variance_threshold,
                default=0.8,
                min=0.5,
                max=0.99)
            private$..scaling <- jmvcore::OptionBool$new(
                "scaling",
                scaling,
                default=TRUE)
            private$..centering <- jmvcore::OptionBool$new(
                "centering",
                centering,
                default=TRUE)
            private$..survival_weighting <- jmvcore::OptionBool$new(
                "survival_weighting",
                survival_weighting,
                default=TRUE)
            private$..permutation_test <- jmvcore::OptionBool$new(
                "permutation_test",
                permutation_test,
                default=FALSE)
            private$..n_permutations <- jmvcore::OptionInteger$new(
                "n_permutations",
                n_permutations,
                default=100,
                min=50,
                max=1000)
            private$..bootstrap_validation <- jmvcore::OptionBool$new(
                "bootstrap_validation",
                bootstrap_validation,
                default=TRUE)
            private$..n_bootstrap <- jmvcore::OptionInteger$new(
                "n_bootstrap",
                n_bootstrap,
                default=100,
                min=50,
                max=1000)
            private$..plot_scree <- jmvcore::OptionBool$new(
                "plot_scree",
                plot_scree,
                default=TRUE)
            private$..plot_loadings <- jmvcore::OptionBool$new(
                "plot_loadings",
                plot_loadings,
                default=TRUE)
            private$..plot_biplot <- jmvcore::OptionBool$new(
                "plot_biplot",
                plot_biplot,
                default=TRUE)
            private$..plot_survival <- jmvcore::OptionBool$new(
                "plot_survival",
                plot_survival,
                default=TRUE)
            private$..risk_score <- jmvcore::OptionBool$new(
                "risk_score",
                risk_score,
                default=TRUE)
            private$..pathway_analysis <- jmvcore::OptionBool$new(
                "pathway_analysis",
                pathway_analysis,
                default=FALSE)
            private$..feature_importance <- jmvcore::OptionBool$new(
                "feature_importance",
                feature_importance,
                default=TRUE)

            self$.addOption(private$..time)
            self$.addOption(private$..status)
            self$.addOption(private$..predictors)
            self$.addOption(private$..clinical_vars)
            self$.addOption(private$..pca_method)
            self$.addOption(private$..n_components)
            self$.addOption(private$..component_selection)
            self$.addOption(private$..cv_folds)
            self$.addOption(private$..variance_threshold)
            self$.addOption(private$..scaling)
            self$.addOption(private$..centering)
            self$.addOption(private$..survival_weighting)
            self$.addOption(private$..permutation_test)
            self$.addOption(private$..n_permutations)
            self$.addOption(private$..bootstrap_validation)
            self$.addOption(private$..n_bootstrap)
            self$.addOption(private$..plot_scree)
            self$.addOption(private$..plot_loadings)
            self$.addOption(private$..plot_biplot)
            self$.addOption(private$..plot_survival)
            self$.addOption(private$..risk_score)
            self$.addOption(private$..pathway_analysis)
            self$.addOption(private$..feature_importance)
        }),
    active = list(
        time = function() private$..time$value,
        status = function() private$..status$value,
        predictors = function() private$..predictors$value,
        clinical_vars = function() private$..clinical_vars$value,
        pca_method = function() private$..pca_method$value,
        n_components = function() private$..n_components$value,
        component_selection = function() private$..component_selection$value,
        cv_folds = function() private$..cv_folds$value,
        variance_threshold = function() private$..variance_threshold$value,
        scaling = function() private$..scaling$value,
        centering = function() private$..centering$value,
        survival_weighting = function() private$..survival_weighting$value,
        permutation_test = function() private$..permutation_test$value,
        n_permutations = function() private$..n_permutations$value,
        bootstrap_validation = function() private$..bootstrap_validation$value,
        n_bootstrap = function() private$..n_bootstrap$value,
        plot_scree = function() private$..plot_scree$value,
        plot_loadings = function() private$..plot_loadings$value,
        plot_biplot = function() private$..plot_biplot$value,
        plot_survival = function() private$..plot_survival$value,
        risk_score = function() private$..risk_score$value,
        pathway_analysis = function() private$..pathway_analysis$value,
        feature_importance = function() private$..feature_importance$value),
    private = list(
        ..time = NA,
        ..status = NA,
        ..predictors = NA,
        ..clinical_vars = NA,
        ..pca_method = NA,
        ..n_components = NA,
        ..component_selection = NA,
        ..cv_folds = NA,
        ..variance_threshold = NA,
        ..scaling = NA,
        ..centering = NA,
        ..survival_weighting = NA,
        ..permutation_test = NA,
        ..n_permutations = NA,
        ..bootstrap_validation = NA,
        ..n_bootstrap = NA,
        ..plot_scree = NA,
        ..plot_loadings = NA,
        ..plot_biplot = NA,
        ..plot_survival = NA,
        ..risk_score = NA,
        ..pathway_analysis = NA,
        ..feature_importance = NA)
)

pcacoxResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "pcacoxResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        summary = function() private$.items[["summary"]],
        pcaSummary = function() private$.items[["pcaSummary"]],
        coxResults = function() private$.items[["coxResults"]],
        componentLoadings = function() private$.items[["componentLoadings"]],
        modelPerformance = function() private$.items[["modelPerformance"]],
        featureImportance = function() private$.items[["featureImportance"]],
        riskScore = function() private$.items[["riskScore"]],
        screePlot = function() private$.items[["screePlot"]],
        loadingsPlot = function() private$.items[["loadingsPlot"]],
        biplot = function() private$.items[["biplot"]],
        survivalPlot = function() private$.items[["survivalPlot"]],
        crossValidation = function() private$.items[["crossValidation"]],
        bootstrapValidation = function() private$.items[["bootstrapValidation"]],
        permutationTest = function() private$.items[["permutationTest"]],
        pathwayAnalysis = function() private$.items[["pathwayAnalysis"]],
        technicalDetails = function() private$.items[["technicalDetails"]],
        clinicalInterpretation = function() private$.items[["clinicalInterpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Principal Component Cox Models")
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Instructions",
                clearWith=list(
                    "time",
                    "status",
                    "predictors")))
            self$add(jmvcore::Html$new(
                options=options,
                name="summary",
                title="Analysis Summary",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="pcaSummary",
                title="PCA Summary",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="eigenvalue", 
                        `title`="Eigenvalue", 
                        `type`="number"),
                    list(
                        `name`="prop_variance", 
                        `title`="Prop. Variance", 
                        `type`="number"),
                    list(
                        `name`="cumul_variance", 
                        `title`="Cumul. Variance", 
                        `type`="number"),
                    list(
                        `name`="selected", 
                        `title`="Selected", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="coxResults",
                title="Cox Model Results",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="coefficient", 
                        `title`="Coefficient", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="z_value", 
                        `title`="z value", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="hr", 
                        `title`="Hazard Ratio", 
                        `type`="number"),
                    list(
                        `name`="hr_lower", 
                        `title`="HR Lower", 
                        `type`="number"),
                    list(
                        `name`="hr_upper", 
                        `title`="HR Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="componentLoadings",
                title="Component Loadings (Top Features)",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="feature", 
                        `title`="Feature", 
                        `type`="text"),
                    list(
                        `name`="loading", 
                        `title`="Loading", 
                        `type`="number"),
                    list(
                        `name`="abs_loading", 
                        `title`="Abs. Loading", 
                        `type`="number"),
                    list(
                        `name`="rank", 
                        `title`="Rank", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelPerformance",
                title="Model Performance",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="featureImportance",
                title="Feature Importance Rankings",
                visible="(feature_importance)",
                rows=1,
                columns=list(
                    list(
                        `name`="feature", 
                        `title`="Feature", 
                        `type`="text"),
                    list(
                        `name`="importance_score", 
                        `title`="Importance", 
                        `type`="number"),
                    list(
                        `name`="rank", 
                        `title`="Rank", 
                        `type`="integer"),
                    list(
                        `name`="contributing_pcs", 
                        `title`="Main PCs", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="riskScore",
                title="Risk Score Analysis",
                visible="(risk_score)",
                rows=1,
                columns=list(
                    list(
                        `name`="risk_group", 
                        `title`="Risk Group", 
                        `type`="text"),
                    list(
                        `name`="n_patients", 
                        `title`="N Patients", 
                        `type`="integer"),
                    list(
                        `name`="n_events", 
                        `title`="N Events", 
                        `type`="integer"),
                    list(
                        `name`="median_survival", 
                        `title`="Median Survival", 
                        `type`="number"),
                    list(
                        `name`="hr_vs_low", 
                        `title`="HR vs Low Risk", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="screePlot",
                title="Scree Plot - Explained Variance",
                width=600,
                height=400,
                renderFun=".plotScree",
                visible="(plot_scree)",
                clearWith=list(
                    "predictors",
                    "n_components",
                    "pca_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="loadingsPlot",
                title="Component Loadings",
                width=700,
                height=500,
                renderFun=".plotLoadings",
                visible="(plot_loadings)",
                clearWith=list(
                    "predictors",
                    "n_components",
                    "pca_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="biplot",
                title="PCA Biplot",
                width=700,
                height=500,
                renderFun=".plotBiplot",
                visible="(plot_biplot)",
                clearWith=list(
                    "predictors",
                    "n_components",
                    "pca_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlot",
                title="Survival by Principal Component Scores",
                width=700,
                height=500,
                renderFun=".plotSurvival",
                visible="(plot_survival)",
                clearWith=list(
                    "time",
                    "status",
                    "predictors",
                    "n_components")))
            self$add(jmvcore::Html$new(
                options=options,
                name="crossValidation",
                title="Cross-Validation Results",
                visible="(component_selection:cv)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="bootstrapValidation",
                title="Bootstrap Validation",
                visible="(bootstrap_validation)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="permutationTest",
                title="Permutation Test Results",
                visible="(permutation_test)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="pathwayAnalysis",
                title="Pathway Enrichment Analysis",
                visible="(pathway_analysis)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="technicalDetails",
                title="Technical Details",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalInterpretation",
                title="Clinical Interpretation",
                visible=TRUE))}))

pcacoxBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "pcacoxBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "pcacox",
                version = c(0,0,3),
                options = options,
                results = pcacoxResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Principal Component Cox Models
#'
#' Principal Component Analysis for Cox regression with high-dimensional 
#' predictors.
#' Reduces dimensionality while preserving survival-relevant information using 
#' supervised PCA.
#' 
#'
#' @examples
#' \donttest{
#' # Example usage
#' pcacox(
#'     data = highdim_data,
#'     time = survival_time,
#'     status = event_status,
#'     predictors = high_dimensional_variables,
#'     n_components = 5
#' )
#'}
#' @param data The data as a data frame.
#' @param time Survival time variable
#' @param status Event status variable
#' @param predictors Variables for principal component analysis
#' @param clinical_vars Clinical predictors to retain in model
#' @param pca_method PCA methodology for dimensionality reduction
#' @param n_components Number of PCs to include in Cox model
#' @param component_selection Selection criteria for PCs
#' @param cv_folds K-fold CV parameter
#' @param variance_threshold Proportion of variance threshold
#' @param scaling Center and scale variables
#' @param centering Center variables to zero mean
#' @param survival_weighting Use survival information in PCA
#' @param permutation_test Test component significance via permutation
#' @param n_permutations Permutation sample size
#' @param bootstrap_validation Assess model stability via bootstrap
#' @param n_bootstrap Bootstrap sample size
#' @param plot_scree Generate scree plot
#' @param plot_loadings Generate loading visualizations
#' @param plot_biplot Generate biplot visualization
#' @param plot_survival Generate survival stratification plots
#' @param risk_score Calculate combined risk score
#' @param pathway_analysis Analyze biological pathways
#' @param feature_importance Rank features by contribution
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$pcaSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$coxResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$componentLoadings} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelPerformance} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$featureImportance} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$riskScore} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$screePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$loadingsPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$biplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$survivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$crossValidation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$bootstrapValidation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$permutationTest} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$pathwayAnalysis} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$technicalDetails} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$clinicalInterpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$pcaSummary$asDF}
#'
#' \code{as.data.frame(results$pcaSummary)}
#'
#' @export
pcacox <- function(
    data,
    time,
    status,
    predictors,
    clinical_vars,
    pca_method = "supervised",
    n_components = 5,
    component_selection = "cv",
    cv_folds = 10,
    variance_threshold = 0.8,
    scaling = TRUE,
    centering = TRUE,
    survival_weighting = TRUE,
    permutation_test = FALSE,
    n_permutations = 100,
    bootstrap_validation = TRUE,
    n_bootstrap = 100,
    plot_scree = TRUE,
    plot_loadings = TRUE,
    plot_biplot = TRUE,
    plot_survival = TRUE,
    risk_score = TRUE,
    pathway_analysis = FALSE,
    feature_importance = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("pcacox requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(status)) status <- jmvcore::resolveQuo(jmvcore::enquo(status))
    if ( ! missing(predictors)) predictors <- jmvcore::resolveQuo(jmvcore::enquo(predictors))
    if ( ! missing(clinical_vars)) clinical_vars <- jmvcore::resolveQuo(jmvcore::enquo(clinical_vars))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(status), status, NULL),
            `if`( ! missing(predictors), predictors, NULL),
            `if`( ! missing(clinical_vars), clinical_vars, NULL))


    options <- pcacoxOptions$new(
        time = time,
        status = status,
        predictors = predictors,
        clinical_vars = clinical_vars,
        pca_method = pca_method,
        n_components = n_components,
        component_selection = component_selection,
        cv_folds = cv_folds,
        variance_threshold = variance_threshold,
        scaling = scaling,
        centering = centering,
        survival_weighting = survival_weighting,
        permutation_test = permutation_test,
        n_permutations = n_permutations,
        bootstrap_validation = bootstrap_validation,
        n_bootstrap = n_bootstrap,
        plot_scree = plot_scree,
        plot_loadings = plot_loadings,
        plot_biplot = plot_biplot,
        plot_survival = plot_survival,
        risk_score = risk_score,
        pathway_analysis = pathway_analysis,
        feature_importance = feature_importance)

    analysis <- pcacoxClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

