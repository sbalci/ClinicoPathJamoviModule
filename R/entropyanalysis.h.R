
# This file is automatically generated, you probably don't want to edit this

entropyanalysisOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "entropyanalysisOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            outcome = NULL,
            probability_vars = NULL,
            predictor_var = NULL,
            calculate_entropy = TRUE,
            calculate_conditional_entropy = TRUE,
            calculate_mutual_information = TRUE,
            calculate_kl_divergence = FALSE,
            uncertainty_threshold = 0.5,
            normalize_entropy = TRUE,
            binning_method = "equal_width",
            n_bins = 10,
            show_case_level = FALSE,
            flag_uncertain = TRUE,
            plot_entropy_distribution = TRUE,
            plot_uncertainty_by_class = TRUE,
            plot_mi_heatmap = FALSE,
            random_seed = 42, ...) {

            super$initialize(
                package="ClinicoPath",
                name="entropyanalysis",
                requiresData=TRUE,
                ...)

            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..probability_vars <- jmvcore::OptionVariables$new(
                "probability_vars",
                probability_vars,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..predictor_var <- jmvcore::OptionVariable$new(
                "predictor_var",
                predictor_var,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..calculate_entropy <- jmvcore::OptionBool$new(
                "calculate_entropy",
                calculate_entropy,
                default=TRUE)
            private$..calculate_conditional_entropy <- jmvcore::OptionBool$new(
                "calculate_conditional_entropy",
                calculate_conditional_entropy,
                default=TRUE)
            private$..calculate_mutual_information <- jmvcore::OptionBool$new(
                "calculate_mutual_information",
                calculate_mutual_information,
                default=TRUE)
            private$..calculate_kl_divergence <- jmvcore::OptionBool$new(
                "calculate_kl_divergence",
                calculate_kl_divergence,
                default=FALSE)
            private$..uncertainty_threshold <- jmvcore::OptionNumber$new(
                "uncertainty_threshold",
                uncertainty_threshold,
                min=0,
                max=2,
                default=0.5)
            private$..normalize_entropy <- jmvcore::OptionBool$new(
                "normalize_entropy",
                normalize_entropy,
                default=TRUE)
            private$..binning_method <- jmvcore::OptionList$new(
                "binning_method",
                binning_method,
                options=list(
                    "equal_width",
                    "equal_freq",
                    "sturges"),
                default="equal_width")
            private$..n_bins <- jmvcore::OptionNumber$new(
                "n_bins",
                n_bins,
                min=2,
                max=50,
                default=10)
            private$..show_case_level <- jmvcore::OptionBool$new(
                "show_case_level",
                show_case_level,
                default=FALSE)
            private$..flag_uncertain <- jmvcore::OptionBool$new(
                "flag_uncertain",
                flag_uncertain,
                default=TRUE)
            private$..plot_entropy_distribution <- jmvcore::OptionBool$new(
                "plot_entropy_distribution",
                plot_entropy_distribution,
                default=TRUE)
            private$..plot_uncertainty_by_class <- jmvcore::OptionBool$new(
                "plot_uncertainty_by_class",
                plot_uncertainty_by_class,
                default=TRUE)
            private$..plot_mi_heatmap <- jmvcore::OptionBool$new(
                "plot_mi_heatmap",
                plot_mi_heatmap,
                default=FALSE)
            private$..random_seed <- jmvcore::OptionNumber$new(
                "random_seed",
                random_seed,
                min=1,
                max=999999,
                default=42)

            self$.addOption(private$..outcome)
            self$.addOption(private$..probability_vars)
            self$.addOption(private$..predictor_var)
            self$.addOption(private$..calculate_entropy)
            self$.addOption(private$..calculate_conditional_entropy)
            self$.addOption(private$..calculate_mutual_information)
            self$.addOption(private$..calculate_kl_divergence)
            self$.addOption(private$..uncertainty_threshold)
            self$.addOption(private$..normalize_entropy)
            self$.addOption(private$..binning_method)
            self$.addOption(private$..n_bins)
            self$.addOption(private$..show_case_level)
            self$.addOption(private$..flag_uncertain)
            self$.addOption(private$..plot_entropy_distribution)
            self$.addOption(private$..plot_uncertainty_by_class)
            self$.addOption(private$..plot_mi_heatmap)
            self$.addOption(private$..random_seed)
        }),
    active = list(
        outcome = function() private$..outcome$value,
        probability_vars = function() private$..probability_vars$value,
        predictor_var = function() private$..predictor_var$value,
        calculate_entropy = function() private$..calculate_entropy$value,
        calculate_conditional_entropy = function() private$..calculate_conditional_entropy$value,
        calculate_mutual_information = function() private$..calculate_mutual_information$value,
        calculate_kl_divergence = function() private$..calculate_kl_divergence$value,
        uncertainty_threshold = function() private$..uncertainty_threshold$value,
        normalize_entropy = function() private$..normalize_entropy$value,
        binning_method = function() private$..binning_method$value,
        n_bins = function() private$..n_bins$value,
        show_case_level = function() private$..show_case_level$value,
        flag_uncertain = function() private$..flag_uncertain$value,
        plot_entropy_distribution = function() private$..plot_entropy_distribution$value,
        plot_uncertainty_by_class = function() private$..plot_uncertainty_by_class$value,
        plot_mi_heatmap = function() private$..plot_mi_heatmap$value,
        random_seed = function() private$..random_seed$value),
    private = list(
        ..outcome = NA,
        ..probability_vars = NA,
        ..predictor_var = NA,
        ..calculate_entropy = NA,
        ..calculate_conditional_entropy = NA,
        ..calculate_mutual_information = NA,
        ..calculate_kl_divergence = NA,
        ..uncertainty_threshold = NA,
        ..normalize_entropy = NA,
        ..binning_method = NA,
        ..n_bins = NA,
        ..show_case_level = NA,
        ..flag_uncertain = NA,
        ..plot_entropy_distribution = NA,
        ..plot_uncertainty_by_class = NA,
        ..plot_mi_heatmap = NA,
        ..random_seed = NA)
)

entropyanalysisResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "entropyanalysisResults",
    inherit = jmvcore::Group,
    active = list(
        instructionsText = function() private$.items[["instructionsText"]],
        summaryTable = function() private$.items[["summaryTable"]],
        entropyTable = function() private$.items[["entropyTable"]],
        mutualInfoTable = function() private$.items[["mutualInfoTable"]],
        conditionalEntropyTable = function() private$.items[["conditionalEntropyTable"]],
        klDivergenceTable = function() private$.items[["klDivergenceTable"]],
        caseLevelTable = function() private$.items[["caseLevelTable"]],
        entropyDistPlot = function() private$.items[["entropyDistPlot"]],
        uncertaintyByClassPlot = function() private$.items[["uncertaintyByClassPlot"]],
        interpretationText = function() private$.items[["interpretationText"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Entropy and Mutual Information Analysis")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructionsText",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="summaryTable",
                title="Summary Statistics",
                rows=1,
                visible=TRUE,
                clearWith=list(
                    "outcome",
                    "probability_vars"),
                columns=list(
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="mean_entropy", 
                        `title`="Mean Entropy", 
                        `type`="number"),
                    list(
                        `name`="median_entropy", 
                        `title`="Median Entropy", 
                        `type`="number"),
                    list(
                        `name`="sd_entropy", 
                        `title`="SD Entropy", 
                        `type`="number"),
                    list(
                        `name`="high_uncertainty_n", 
                        `title`="High Uncertainty Cases", 
                        `type`="integer"),
                    list(
                        `name`="high_uncertainty_pct", 
                        `title`="High Uncertainty %", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="entropyTable",
                title="Entropy by True Class",
                visible="(calculate_entropy)",
                clearWith=list(
                    "outcome",
                    "probability_vars",
                    "normalize_entropy"),
                columns=list(
                    list(
                        `name`="class", 
                        `title`="True Class", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="mean_entropy", 
                        `title`="Mean Entropy", 
                        `type`="number"),
                    list(
                        `name`="sd_entropy", 
                        `title`="SD Entropy", 
                        `type`="number"),
                    list(
                        `name`="pct_high_uncertainty", 
                        `title`="% High Uncertainty", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="mutualInfoTable",
                title="Mutual Information",
                visible="(calculate_mutual_information)",
                clearWith=list(
                    "outcome",
                    "predictor_var",
                    "probability_vars"),
                columns=list(
                    list(
                        `name`="variable_pair", 
                        `title`="Variable Pair", 
                        `type`="text"),
                    list(
                        `name`="mutual_information", 
                        `title`="I(X;Y)", 
                        `type`="number"),
                    list(
                        `name`="normalized_mi", 
                        `title`="Normalized MI", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="conditionalEntropyTable",
                title="Conditional Entropy H(Y|X)",
                visible="(calculate_conditional_entropy)",
                clearWith=list(
                    "outcome",
                    "predictor_var"),
                columns=list(
                    list(
                        `name`="condition", 
                        `title`="Condition", 
                        `type`="text"),
                    list(
                        `name`="entropy", 
                        `title`="H(Y|X)", 
                        `type`="number"),
                    list(
                        `name`="uncertainty_reduction", 
                        `title`="Uncertainty Reduction", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="klDivergenceTable",
                title="KL Divergence from Uniform Distribution",
                visible="(calculate_kl_divergence)",
                clearWith=list(
                    "outcome",
                    "probability_vars"),
                columns=list(
                    list(
                        `name`="case_id", 
                        `title`="Case", 
                        `type`="integer"),
                    list(
                        `name`="kl_divergence", 
                        `title`="KL Divergence", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="caseLevelTable",
                title="Case-Level Entropy",
                visible="(show_case_level)",
                clearWith=list(
                    "outcome",
                    "probability_vars",
                    "normalize_entropy"),
                columns=list(
                    list(
                        `name`="case_id", 
                        `title`="Case ID", 
                        `type`="integer"),
                    list(
                        `name`="true_class", 
                        `title`="True Class", 
                        `type`="text"),
                    list(
                        `name`="predicted_class", 
                        `title`="Predicted Class", 
                        `type`="text"),
                    list(
                        `name`="entropy", 
                        `title`="Entropy", 
                        `type`="number"),
                    list(
                        `name`="max_prob", 
                        `title`="Max Probability", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="high_uncertainty", 
                        `title`="High Uncertainty", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="entropyDistPlot",
                title="Entropy Distribution",
                width=600,
                height=400,
                renderFun=".entropyDistPlot",
                visible="(plot_entropy_distribution)",
                clearWith=list(
                    "outcome",
                    "probability_vars")))
            self$add(jmvcore::Image$new(
                options=options,
                name="uncertaintyByClassPlot",
                title="Uncertainty by True Class",
                width=600,
                height=400,
                renderFun=".uncertaintyByClassPlot",
                visible="(plot_uncertainty_by_class)",
                clearWith=list(
                    "outcome",
                    "probability_vars")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretationText",
                title="Interpretation Guide",
                visible=TRUE))}))

entropyanalysisBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "entropyanalysisBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "entropyanalysis",
                version = c(0,0,32),
                options = options,
                results = entropyanalysisResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = TRUE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Entropy and Mutual Information Analysis
#'
#' Entropy and Mutual Information analysis quantifies uncertainty in AI 
#' predictions
#' and measures information gain from diagnostic tests or features.
#' 
#' Shannon Entropy quantifies prediction uncertainty (higher = more 
#' uncertain).
#' Mutual Information measures how much knowing one variable reduces 
#' uncertainty
#' about another.
#' 
#' Applications: AI triage systems ("defer to pathologist" decisions), feature
#' selection, test ordering optimization, multi-class uncertainty 
#' quantification.
#' 
#'
#' @examples
#' # Example with AI prediction probabilities
#' data <- data.frame(
#'   true_class = factor(sample(c("A", "B", "C"), 100, replace=TRUE)),
#'   prob_A = runif(100),
#'   prob_B = runif(100),
#'   prob_C = runif(100)
#' )
#'
#' entropyanalysis(
#'   data = data,
#'   outcome = 'true_class',
#'   probability_vars = c('prob_A', 'prob_B', 'prob_C'),
#'   uncertainty_threshold = 0.5
#' )
#'
#' @param data the data as a data frame
#' @param outcome a string naming the true outcome/class variable
#' @param probability_vars vector of predicted probability variables (one per
#'   class)
#' @param predictor_var optional single predictor for mutual information
#'   calculation
#' @param calculate_entropy calculate Shannon entropy for each prediction
#' @param calculate_conditional_entropy calculate conditional entropy H(Y|X)
#' @param calculate_mutual_information calculate mutual information I(X;Y)
#' @param calculate_kl_divergence calculate Kullback-Leibler divergence from
#'   uniform distribution
#' @param uncertainty_threshold entropy threshold for flagging
#'   high-uncertainty predictions
#' @param normalize_entropy normalize entropy to (0 to 1) scale (divide by
#'   log(n_classes))
#' @param binning_method binning method for continuous variables in MI
#'   calculation
#' @param n_bins number of bins for discretizing continuous variables
#' @param show_case_level show entropy for each individual case
#' @param flag_uncertain identify cases exceeding uncertainty threshold
#' @param plot_entropy_distribution plot histogram of entropy values
#' @param plot_uncertainty_by_class plot entropy distribution for each true
#'   class
#' @param plot_mi_heatmap plot heatmap of pairwise mutual information (for
#'   multiple features)
#' @param random_seed random seed for reproducibility
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructionsText} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summaryTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$entropyTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$mutualInfoTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$conditionalEntropyTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$klDivergenceTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$caseLevelTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$entropyDistPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$uncertaintyByClassPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$interpretationText} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summaryTable$asDF}
#'
#' \code{as.data.frame(results$summaryTable)}
#'
#' @export
entropyanalysis <- function(
    data,
    outcome,
    probability_vars,
    predictor_var,
    calculate_entropy = TRUE,
    calculate_conditional_entropy = TRUE,
    calculate_mutual_information = TRUE,
    calculate_kl_divergence = FALSE,
    uncertainty_threshold = 0.5,
    normalize_entropy = TRUE,
    binning_method = "equal_width",
    n_bins = 10,
    show_case_level = FALSE,
    flag_uncertain = TRUE,
    plot_entropy_distribution = TRUE,
    plot_uncertainty_by_class = TRUE,
    plot_mi_heatmap = FALSE,
    random_seed = 42) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("entropyanalysis requires jmvcore to be installed (restart may be required)")

    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(probability_vars)) probability_vars <- jmvcore::resolveQuo(jmvcore::enquo(probability_vars))
    if ( ! missing(predictor_var)) predictor_var <- jmvcore::resolveQuo(jmvcore::enquo(predictor_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(probability_vars), probability_vars, NULL),
            `if`( ! missing(predictor_var), predictor_var, NULL))

    for (v in outcome) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- entropyanalysisOptions$new(
        outcome = outcome,
        probability_vars = probability_vars,
        predictor_var = predictor_var,
        calculate_entropy = calculate_entropy,
        calculate_conditional_entropy = calculate_conditional_entropy,
        calculate_mutual_information = calculate_mutual_information,
        calculate_kl_divergence = calculate_kl_divergence,
        uncertainty_threshold = uncertainty_threshold,
        normalize_entropy = normalize_entropy,
        binning_method = binning_method,
        n_bins = n_bins,
        show_case_level = show_case_level,
        flag_uncertain = flag_uncertain,
        plot_entropy_distribution = plot_entropy_distribution,
        plot_uncertainty_by_class = plot_uncertainty_by_class,
        plot_mi_heatmap = plot_mi_heatmap,
        random_seed = random_seed)

    analysis <- entropyanalysisClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

