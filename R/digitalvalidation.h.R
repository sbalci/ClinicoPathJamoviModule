
# This file is automatically generated, you probably don't want to edit this

digitalvalidationOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "digitalvalidationOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            reference = NULL,
            test = NULL,
            platform_var = NULL,
            validation_type = "both",
            acceptance_criteria = "fda_standard",
            custom_correlation_threshold = 0.9,
            custom_icc_threshold = 0.75,
            bias_assessment = TRUE,
            decision_threshold1 = 0,
            decision_threshold2 = 0,
            decision_threshold3 = 0,
            bootstrap_ci = TRUE,
            bootstrap_n = 1000,
            show_validation_plots = TRUE,
            generate_report = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="digitalvalidation",
                requiresData=TRUE,
                ...)

            private$..reference <- jmvcore::OptionVariable$new(
                "reference",
                reference,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..test <- jmvcore::OptionVariable$new(
                "test",
                test,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..platform_var <- jmvcore::OptionVariable$new(
                "platform_var",
                platform_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..validation_type <- jmvcore::OptionList$new(
                "validation_type",
                validation_type,
                options=list(
                    "analytical",
                    "clinical",
                    "both"),
                default="both")
            private$..acceptance_criteria <- jmvcore::OptionList$new(
                "acceptance_criteria",
                acceptance_criteria,
                options=list(
                    "fda_strict",
                    "fda_standard",
                    "clsi_ep09",
                    "custom"),
                default="fda_standard")
            private$..custom_correlation_threshold <- jmvcore::OptionNumber$new(
                "custom_correlation_threshold",
                custom_correlation_threshold,
                min=0.7,
                max=0.99,
                default=0.9)
            private$..custom_icc_threshold <- jmvcore::OptionNumber$new(
                "custom_icc_threshold",
                custom_icc_threshold,
                min=0.5,
                max=0.99,
                default=0.75)
            private$..bias_assessment <- jmvcore::OptionBool$new(
                "bias_assessment",
                bias_assessment,
                default=TRUE)
            private$..decision_threshold1 <- jmvcore::OptionNumber$new(
                "decision_threshold1",
                decision_threshold1,
                default=0)
            private$..decision_threshold2 <- jmvcore::OptionNumber$new(
                "decision_threshold2",
                decision_threshold2,
                default=0)
            private$..decision_threshold3 <- jmvcore::OptionNumber$new(
                "decision_threshold3",
                decision_threshold3,
                default=0)
            private$..bootstrap_ci <- jmvcore::OptionBool$new(
                "bootstrap_ci",
                bootstrap_ci,
                default=TRUE)
            private$..bootstrap_n <- jmvcore::OptionInteger$new(
                "bootstrap_n",
                bootstrap_n,
                min=500,
                max=5000,
                default=1000)
            private$..show_validation_plots <- jmvcore::OptionBool$new(
                "show_validation_plots",
                show_validation_plots,
                default=TRUE)
            private$..generate_report <- jmvcore::OptionBool$new(
                "generate_report",
                generate_report,
                default=TRUE)

            self$.addOption(private$..reference)
            self$.addOption(private$..test)
            self$.addOption(private$..platform_var)
            self$.addOption(private$..validation_type)
            self$.addOption(private$..acceptance_criteria)
            self$.addOption(private$..custom_correlation_threshold)
            self$.addOption(private$..custom_icc_threshold)
            self$.addOption(private$..bias_assessment)
            self$.addOption(private$..decision_threshold1)
            self$.addOption(private$..decision_threshold2)
            self$.addOption(private$..decision_threshold3)
            self$.addOption(private$..bootstrap_ci)
            self$.addOption(private$..bootstrap_n)
            self$.addOption(private$..show_validation_plots)
            self$.addOption(private$..generate_report)
        }),
    active = list(
        reference = function() private$..reference$value,
        test = function() private$..test$value,
        platform_var = function() private$..platform_var$value,
        validation_type = function() private$..validation_type$value,
        acceptance_criteria = function() private$..acceptance_criteria$value,
        custom_correlation_threshold = function() private$..custom_correlation_threshold$value,
        custom_icc_threshold = function() private$..custom_icc_threshold$value,
        bias_assessment = function() private$..bias_assessment$value,
        decision_threshold1 = function() private$..decision_threshold1$value,
        decision_threshold2 = function() private$..decision_threshold2$value,
        decision_threshold3 = function() private$..decision_threshold3$value,
        bootstrap_ci = function() private$..bootstrap_ci$value,
        bootstrap_n = function() private$..bootstrap_n$value,
        show_validation_plots = function() private$..show_validation_plots$value,
        generate_report = function() private$..generate_report$value),
    private = list(
        ..reference = NA,
        ..test = NA,
        ..platform_var = NA,
        ..validation_type = NA,
        ..acceptance_criteria = NA,
        ..custom_correlation_threshold = NA,
        ..custom_icc_threshold = NA,
        ..bias_assessment = NA,
        ..decision_threshold1 = NA,
        ..decision_threshold2 = NA,
        ..decision_threshold3 = NA,
        ..bootstrap_ci = NA,
        ..bootstrap_n = NA,
        ..show_validation_plots = NA,
        ..generate_report = NA)
)

digitalvalidationResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "digitalvalidationResults",
    inherit = jmvcore::Group,
    active = list(
        interpretation = function() private$.items[["interpretation"]],
        performancetable = function() private$.items[["performancetable"]],
        biastable = function() private$.items[["biastable"]],
        agreementtable = function() private$.items[["agreementtable"]],
        thresholdtable = function() private$.items[["thresholdtable"]],
        validationplot = function() private$.items[["validationplot"]],
        blandaltmanplot = function() private$.items[["blandaltmanplot"]],
        residualplot = function() private$.items[["residualplot"]],
        validationreport = function() private$.items[["validationreport"]],
        acceptancesummary = function() private$.items[["acceptancesummary"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Digital Pathology Validation",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Validation Framework and Guidelines",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="performancetable",
                title="Performance Metrics",
                columns=list(),
                clearWith=list(
                    "reference",
                    "test",
                    "validation_type")))
            self$add(jmvcore::Table$new(
                options=options,
                name="biastable",
                title="Bias Assessment",
                columns=list(),
                visible="(bias_assessment)",
                clearWith=list(
                    "reference",
                    "test",
                    "bias_assessment")))
            self$add(jmvcore::Table$new(
                options=options,
                name="agreementtable",
                title="Agreement Statistics",
                columns=list(),
                clearWith=list(
                    "reference",
                    "test",
                    "acceptance_criteria")))
            self$add(jmvcore::Table$new(
                options=options,
                name="thresholdtable",
                title="Clinical Decision Impact",
                columns=list(),
                visible="(decision_threshold1 > 0 || decision_threshold2 > 0 || decision_threshold3 > 0)",
                clearWith=list(
                    "reference",
                    "test",
                    "decision_threshold1",
                    "decision_threshold2",
                    "decision_threshold3")))
            self$add(jmvcore::Image$new(
                options=options,
                name="validationplot",
                title="Method Comparison Plot",
                width=600,
                height=500,
                visible="(show_validation_plots)",
                requiresData=TRUE,
                clearWith=list(
                    "reference",
                    "test",
                    "show_validation_plots")))
            self$add(jmvcore::Image$new(
                options=options,
                name="blandaltmanplot",
                title="Bland-Altman Agreement Plot",
                width=600,
                height=500,
                visible="(show_validation_plots)",
                requiresData=TRUE,
                clearWith=list(
                    "reference",
                    "test",
                    "show_validation_plots")))
            self$add(jmvcore::Image$new(
                options=options,
                name="residualplot",
                title="Residual Analysis Plot",
                width=500,
                height=400,
                visible="(show_validation_plots && bias_assessment)",
                requiresData=TRUE,
                clearWith=list(
                    "reference",
                    "test",
                    "bias_assessment")))
            self$add(jmvcore::Html$new(
                options=options,
                name="validationreport",
                title="Comprehensive Validation Report",
                visible="(generate_report)",
                clearWith=list(
                    "generate_report")))
            self$add(jmvcore::Table$new(
                options=options,
                name="acceptancesummary",
                title="Acceptance Criteria Summary",
                columns=list(),
                clearWith=list(
                    "acceptance_criteria",
                    "custom_correlation_threshold",
                    "custom_icc_threshold")))}))

digitalvalidationBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "digitalvalidationBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "digitalvalidation",
                version = c(1,0,0),
                options = options,
                results = digitalvalidationResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Digital Pathology Validation
#'
#' 
#' @param data the data as a data frame
#' @param reference reference/gold standard measurements
#' @param test test method measurements to be validated
#' @param platform_var platform or batch identifier for stratified analysis
#' @param validation_type type of validation analysis to perform
#' @param acceptance_criteria regulatory acceptance criteria for validation
#' @param custom_correlation_threshold minimum acceptable correlation
#'   coefficient
#' @param custom_icc_threshold minimum acceptable ICC value
#' @param bias_assessment perform systematic and proportional bias assessment
#' @param decision_threshold1 first clinical threshold for decision impact
#'   analysis
#' @param decision_threshold2 second clinical threshold for decision impact
#'   analysis
#' @param decision_threshold3 third clinical threshold for decision impact
#'   analysis
#' @param bootstrap_ci use bootstrap method for robust confidence intervals
#' @param bootstrap_n number of bootstrap replicates
#' @param show_validation_plots display validation and residual plots
#' @param generate_report generate comprehensive validation report
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$performancetable} \tab \tab \tab \tab \tab Comprehensive validation performance metrics \cr
#'   \code{results$biastable} \tab \tab \tab \tab \tab Systematic and proportional bias analysis \cr
#'   \code{results$agreementtable} \tab \tab \tab \tab \tab ICC, CCC, and correlation measures \cr
#'   \code{results$thresholdtable} \tab \tab \tab \tab \tab Impact at different clinical thresholds \cr
#'   \code{results$validationplot} \tab \tab \tab \tab \tab Scatter plot with regression and agreement lines \cr
#'   \code{results$blandaltmanplot} \tab \tab \tab \tab \tab Agreement analysis with limits of agreement \cr
#'   \code{results$residualplot} \tab \tab \tab \tab \tab Residual patterns for bias detection \cr
#'   \code{results$validationreport} \tab \tab \tab \tab \tab Complete validation report with regulatory framework \cr
#'   \code{results$acceptancesummary} \tab \tab \tab \tab \tab Pass/fail status for regulatory criteria \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$performancetable$asDF}
#'
#' \code{as.data.frame(results$performancetable)}
#'
#' @export
digitalvalidation <- function(
    data,
    reference,
    test,
    platform_var,
    validation_type = "both",
    acceptance_criteria = "fda_standard",
    custom_correlation_threshold = 0.9,
    custom_icc_threshold = 0.75,
    bias_assessment = TRUE,
    decision_threshold1 = 0,
    decision_threshold2 = 0,
    decision_threshold3 = 0,
    bootstrap_ci = TRUE,
    bootstrap_n = 1000,
    show_validation_plots = TRUE,
    generate_report = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("digitalvalidation requires jmvcore to be installed (restart may be required)")

    if ( ! missing(reference)) reference <- jmvcore::resolveQuo(jmvcore::enquo(reference))
    if ( ! missing(test)) test <- jmvcore::resolveQuo(jmvcore::enquo(test))
    if ( ! missing(platform_var)) platform_var <- jmvcore::resolveQuo(jmvcore::enquo(platform_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(reference), reference, NULL),
            `if`( ! missing(test), test, NULL),
            `if`( ! missing(platform_var), platform_var, NULL))

    for (v in platform_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- digitalvalidationOptions$new(
        reference = reference,
        test = test,
        platform_var = platform_var,
        validation_type = validation_type,
        acceptance_criteria = acceptance_criteria,
        custom_correlation_threshold = custom_correlation_threshold,
        custom_icc_threshold = custom_icc_threshold,
        bias_assessment = bias_assessment,
        decision_threshold1 = decision_threshold1,
        decision_threshold2 = decision_threshold2,
        decision_threshold3 = decision_threshold3,
        bootstrap_ci = bootstrap_ci,
        bootstrap_n = bootstrap_n,
        show_validation_plots = show_validation_plots,
        generate_report = generate_report)

    analysis <- digitalvalidationClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

