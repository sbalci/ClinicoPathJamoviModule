
# This file is automatically generated, you probably don't want to edit this

timedependentdcaOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "timedependentdcaOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            event = NULL,
            predictor = NULL,
            time_points = "365, 730, 1095",
            threshold_range_min = 0.01,
            threshold_range_max = 0.99,
            threshold_steps = 100,
            reference_strategy = "both",
            estimate_survival = "kaplan_meier",
            smoothing = FALSE,
            use_bootstrap = FALSE,
            bootstrap_iterations = 500,
            ci_level = 0.95,
            plot_net_benefit = FALSE,
            plot_by_timepoint = FALSE,
            plot_interventions_avoided = FALSE,
            random_seed = 42, ...) {

            super$initialize(
                package="ClinicoPath",
                name="timedependentdca",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event <- jmvcore::OptionVariable$new(
                "event",
                event,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..predictor <- jmvcore::OptionVariable$new(
                "predictor",
                predictor,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..time_points <- jmvcore::OptionString$new(
                "time_points",
                time_points,
                default="365, 730, 1095")
            private$..threshold_range_min <- jmvcore::OptionNumber$new(
                "threshold_range_min",
                threshold_range_min,
                min=0,
                max=0.5,
                default=0.01)
            private$..threshold_range_max <- jmvcore::OptionNumber$new(
                "threshold_range_max",
                threshold_range_max,
                min=0.5,
                max=0.99,
                default=0.99)
            private$..threshold_steps <- jmvcore::OptionNumber$new(
                "threshold_steps",
                threshold_steps,
                min=10,
                max=200,
                default=100)
            private$..reference_strategy <- jmvcore::OptionList$new(
                "reference_strategy",
                reference_strategy,
                options=list(
                    "treat_all",
                    "treat_none",
                    "both"),
                default="both")
            private$..estimate_survival <- jmvcore::OptionList$new(
                "estimate_survival",
                estimate_survival,
                options=list(
                    "kaplan_meier",
                    "cox",
                    "direct"),
                default="kaplan_meier")
            private$..smoothing <- jmvcore::OptionBool$new(
                "smoothing",
                smoothing,
                default=FALSE)
            private$..use_bootstrap <- jmvcore::OptionBool$new(
                "use_bootstrap",
                use_bootstrap,
                default=FALSE)
            private$..bootstrap_iterations <- jmvcore::OptionNumber$new(
                "bootstrap_iterations",
                bootstrap_iterations,
                min=100,
                max=10000,
                default=500)
            private$..ci_level <- jmvcore::OptionNumber$new(
                "ci_level",
                ci_level,
                min=0.8,
                max=0.99,
                default=0.95)
            private$..plot_net_benefit <- jmvcore::OptionBool$new(
                "plot_net_benefit",
                plot_net_benefit,
                default=FALSE)
            private$..plot_by_timepoint <- jmvcore::OptionBool$new(
                "plot_by_timepoint",
                plot_by_timepoint,
                default=FALSE)
            private$..plot_interventions_avoided <- jmvcore::OptionBool$new(
                "plot_interventions_avoided",
                plot_interventions_avoided,
                default=FALSE)
            private$..random_seed <- jmvcore::OptionNumber$new(
                "random_seed",
                random_seed,
                min=1,
                max=999999,
                default=42)

            self$.addOption(private$..time)
            self$.addOption(private$..event)
            self$.addOption(private$..predictor)
            self$.addOption(private$..time_points)
            self$.addOption(private$..threshold_range_min)
            self$.addOption(private$..threshold_range_max)
            self$.addOption(private$..threshold_steps)
            self$.addOption(private$..reference_strategy)
            self$.addOption(private$..estimate_survival)
            self$.addOption(private$..smoothing)
            self$.addOption(private$..use_bootstrap)
            self$.addOption(private$..bootstrap_iterations)
            self$.addOption(private$..ci_level)
            self$.addOption(private$..plot_net_benefit)
            self$.addOption(private$..plot_by_timepoint)
            self$.addOption(private$..plot_interventions_avoided)
            self$.addOption(private$..random_seed)
        }),
    active = list(
        time = function() private$..time$value,
        event = function() private$..event$value,
        predictor = function() private$..predictor$value,
        time_points = function() private$..time_points$value,
        threshold_range_min = function() private$..threshold_range_min$value,
        threshold_range_max = function() private$..threshold_range_max$value,
        threshold_steps = function() private$..threshold_steps$value,
        reference_strategy = function() private$..reference_strategy$value,
        estimate_survival = function() private$..estimate_survival$value,
        smoothing = function() private$..smoothing$value,
        use_bootstrap = function() private$..use_bootstrap$value,
        bootstrap_iterations = function() private$..bootstrap_iterations$value,
        ci_level = function() private$..ci_level$value,
        plot_net_benefit = function() private$..plot_net_benefit$value,
        plot_by_timepoint = function() private$..plot_by_timepoint$value,
        plot_interventions_avoided = function() private$..plot_interventions_avoided$value,
        random_seed = function() private$..random_seed$value),
    private = list(
        ..time = NA,
        ..event = NA,
        ..predictor = NA,
        ..time_points = NA,
        ..threshold_range_min = NA,
        ..threshold_range_max = NA,
        ..threshold_steps = NA,
        ..reference_strategy = NA,
        ..estimate_survival = NA,
        ..smoothing = NA,
        ..use_bootstrap = NA,
        ..bootstrap_iterations = NA,
        ..ci_level = NA,
        ..plot_net_benefit = NA,
        ..plot_by_timepoint = NA,
        ..plot_interventions_avoided = NA,
        ..random_seed = NA)
)

timedependentdcaResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "timedependentdcaResults",
    inherit = jmvcore::Group,
    active = list(
        instructionsText = function() private$.items[["instructionsText"]],
        notices = function() private$.items[["notices"]],
        netBenefitTable = function() private$.items[["netBenefitTable"]],
        summaryTable = function() private$.items[["summaryTable"]],
        interventionsTable = function() private$.items[["interventionsTable"]],
        netBenefitPlot = function() private$.items[["netBenefitPlot"]],
        interventionsPlot = function() private$.items[["interventionsPlot"]],
        interpretationText = function() private$.items[["interpretationText"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Time-Dependent Decision Curve Analysis")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructionsText",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="notices",
                title="Notices",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="netBenefitTable",
                title="Net Benefit at Selected Time Points",
                visible=TRUE,
                clearWith=list(
                    "time",
                    "event",
                    "predictor",
                    "time_points",
                    "use_bootstrap",
                    "bootstrap_iterations",
                    "ci_level"),
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="number", 
                        `combineBelow`=TRUE),
                    list(
                        `name`="threshold", 
                        `title`="Threshold", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="net_benefit", 
                        `title`="Net Benefit", 
                        `type`="number"),
                    list(
                        `name`="nb_lower", 
                        `title`="NB Lower CI", 
                        `type`="number", 
                        `visible`="(use_bootstrap)"),
                    list(
                        `name`="nb_upper", 
                        `title`="NB Upper CI", 
                        `type`="number", 
                        `visible`="(use_bootstrap)"),
                    list(
                        `name`="nb_treat_all", 
                        `title`="NB (Treat All)", 
                        `type`="number", 
                        `visible`="(reference_strategy:both || reference_strategy:treat_all)"),
                    list(
                        `name`="nb_treat_none", 
                        `title`="NB (Treat None)", 
                        `type`="number", 
                        `visible`="(reference_strategy:both || reference_strategy:treat_none)"),
                    list(
                        `name`="improvement", 
                        `title`="Improvement", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="summaryTable",
                title="Summary Statistics by Time Point",
                visible=TRUE,
                clearWith=list(
                    "time",
                    "event",
                    "predictor",
                    "time_points"),
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="number"),
                    list(
                        `name`="n_at_risk", 
                        `title`="N at Risk", 
                        `type`="integer"),
                    list(
                        `name`="n_events", 
                        `title`="N Events", 
                        `type`="integer"),
                    list(
                        `name`="event_rate", 
                        `title`="Event Rate", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="max_net_benefit", 
                        `title`="Max Net Benefit", 
                        `type`="number"),
                    list(
                        `name`="optimal_threshold", 
                        `title`="Optimal Threshold", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="interventionsTable",
                title="Interventions Avoided (per 100 patients)",
                visible=TRUE,
                clearWith=list(
                    "time",
                    "event",
                    "predictor",
                    "time_points"),
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="number", 
                        `combineBelow`=TRUE),
                    list(
                        `name`="threshold", 
                        `title`="Threshold", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interventions_avoided", 
                        `title`="Interventions Avoided", 
                        `type`="number"),
                    list(
                        `name`="events_detected", 
                        `title`="Events Detected (%)", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="netBenefitPlot",
                title="Time-Dependent Net Benefit Curves",
                width=700,
                height=500,
                renderFun=".netBenefitPlot",
                visible="(plot_net_benefit)",
                clearWith=list(
                    "time",
                    "event",
                    "predictor",
                    "time_points",
                    "reference_strategy",
                    "use_bootstrap",
                    "bootstrap_iterations",
                    "ci_level",
                    "smoothing",
                    "plot_by_timepoint")))
            self$add(jmvcore::Image$new(
                options=options,
                name="interventionsPlot",
                title="Interventions Avoided",
                width=700,
                height=500,
                renderFun=".interventionsPlot",
                visible="(plot_interventions_avoided)",
                clearWith=list(
                    "time",
                    "event",
                    "predictor",
                    "time_points",
                    "smoothing",
                    "use_bootstrap",
                    "bootstrap_iterations",
                    "ci_level")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretationText",
                title="Interpretation Guide",
                visible=TRUE))}))

timedependentdcaBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "timedependentdcaBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "timedependentdca",
                version = c(0,0,32),
                options = options,
                results = timedependentdcaResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = TRUE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Time-Dependent Decision Curve Analysis
#'
#' Perform time-dependent Decision Curve Analysis (DCA) for survival data 
#' using the dcurves package. This method extends standard DCA to evaluate
#' the clinical utility of prognostic models with time-to-event outcomes.
#' It calculates net benefit at specific time points, accounting for
#' censoring and time-varying risk predictions. It's essential for evaluating
#' survival models, recurrence prediction models, and other longitudinal 
#' outcomes. 
#' Common applications: Serial biopsy surveillance, recurrence vs death 
#' prediction,
#' time-varying treatment decisions.
#' 
#'
#' @examples
#' # Example with survival outcome
#' library(survival)
#' data <- lung
#'
#' timedependentdca(
#'   data = data,
#'   time = 'time',
#'   event = 'status',
#'   predictor = 'ph.ecog',
#'   time_points = c(180, 365, 730),
#'   reference_strategy = 'treat_all'
#' )
#'
#' @param data the data as a data frame
#' @param time a string naming the time-to-event variable
#' @param event a string naming the event indicator (1=event, 0=censored)
#' @param predictor a string naming the risk score or prediction variable
#' @param time_points comma-separated time points at which to calculate net
#'   benefit (e.g., "365, 730" for 1 and 2 years)
#' @param threshold_range_min minimum threshold probability for decision curve
#' @param threshold_range_max maximum threshold probability for decision curve
#' @param threshold_steps number of threshold probabilities to evaluate
#' @param reference_strategy reference strategy for comparison
#' @param estimate_survival method for estimating event probabilities from
#'   predictor
#' @param smoothing apply LOESS smoothing to decision curves for visualization
#' @param use_bootstrap calculate 95\% confidence intervals for net benefit
#'   using bootstrap resampling (computationally intensive)
#' @param bootstrap_iterations number of bootstrap iterations for confidence
#'   interval calculation
#' @param ci_level confidence level for bootstrap intervals (e.g., 0.95 for
#'   95\% CI)
#' @param plot_net_benefit plot net benefit curves across threshold
#'   probabilities
#' @param plot_by_timepoint create separate plots for each time point (vs.
#'   overlay)
#' @param plot_interventions_avoided plot number of interventions avoided per
#'   100 patients
#' @param random_seed random seed for reproducible bootstrap sampling
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructionsText} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$notices} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$netBenefitTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$summaryTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$interventionsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$netBenefitPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$interventionsPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$interpretationText} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$netBenefitTable$asDF}
#'
#' \code{as.data.frame(results$netBenefitTable)}
#'
#' @export
timedependentdca <- function(
    data,
    time,
    event,
    predictor,
    time_points = "365, 730, 1095",
    threshold_range_min = 0.01,
    threshold_range_max = 0.99,
    threshold_steps = 100,
    reference_strategy = "both",
    estimate_survival = "kaplan_meier",
    smoothing = FALSE,
    use_bootstrap = FALSE,
    bootstrap_iterations = 500,
    ci_level = 0.95,
    plot_net_benefit = FALSE,
    plot_by_timepoint = FALSE,
    plot_interventions_avoided = FALSE,
    random_seed = 42) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("timedependentdca requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(event)) event <- jmvcore::resolveQuo(jmvcore::enquo(event))
    if ( ! missing(predictor)) predictor <- jmvcore::resolveQuo(jmvcore::enquo(predictor))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(event), event, NULL),
            `if`( ! missing(predictor), predictor, NULL))


    options <- timedependentdcaOptions$new(
        time = time,
        event = event,
        predictor = predictor,
        time_points = time_points,
        threshold_range_min = threshold_range_min,
        threshold_range_max = threshold_range_max,
        threshold_steps = threshold_steps,
        reference_strategy = reference_strategy,
        estimate_survival = estimate_survival,
        smoothing = smoothing,
        use_bootstrap = use_bootstrap,
        bootstrap_iterations = bootstrap_iterations,
        ci_level = ci_level,
        plot_net_benefit = plot_net_benefit,
        plot_by_timepoint = plot_by_timepoint,
        plot_interventions_avoided = plot_interventions_avoided,
        random_seed = random_seed)

    analysis <- timedependentdcaClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

