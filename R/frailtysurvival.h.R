
# This file is automatically generated, you probably don't want to edit this

frailtysurvivalOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "frailtysurvivalOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time_var = NULL,
            status_var = NULL,
            cluster_var = NULL,
            covariates = NULL,
            strata_vars = NULL,
            frailty_type = "shared",
            frailty_distribution = "gamma",
            estimation_method = "penalized_likelihood",
            confidence_level = 0.95,
            baseline_hazard = "cox",
            random_effects = NULL,
            test_frailty = TRUE,
            variance_components = TRUE,
            cluster_diagnostics = TRUE,
            prediction_intervals = FALSE,
            survival_curves = TRUE,
            residual_analysis = TRUE,
            model_comparison = TRUE,
            mcmc_iterations = 10000,
            burnin_samples = 2000,
            convergence_diagnostics = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="frailtysurvival",
                requiresData=FALSE,
                ...)

            private$..time_var <- jmvcore::OptionVariable$new(
                "time_var",
                time_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..status_var <- jmvcore::OptionVariable$new(
                "status_var",
                status_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..cluster_var <- jmvcore::OptionVariable$new(
                "cluster_var",
                cluster_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "id"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..strata_vars <- jmvcore::OptionVariables$new(
                "strata_vars",
                strata_vars,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..frailty_type <- jmvcore::OptionList$new(
                "frailty_type",
                frailty_type,
                options=list(
                    "shared",
                    "correlated",
                    "nested",
                    "additive",
                    "multiplicative"),
                default="shared")
            private$..frailty_distribution <- jmvcore::OptionList$new(
                "frailty_distribution",
                frailty_distribution,
                options=list(
                    "gamma",
                    "lognormal",
                    "positive_stable",
                    "inverse_gaussian"),
                default="gamma")
            private$..estimation_method <- jmvcore::OptionList$new(
                "estimation_method",
                estimation_method,
                options=list(
                    "penalized_likelihood",
                    "em_algorithm",
                    "laplace_approximation",
                    "mcmc"),
                default="penalized_likelihood")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.8,
                max=0.99)
            private$..baseline_hazard <- jmvcore::OptionList$new(
                "baseline_hazard",
                baseline_hazard,
                options=list(
                    "cox",
                    "weibull",
                    "exponential",
                    "gompertz",
                    "lognormal"),
                default="cox")
            private$..random_effects <- jmvcore::OptionVariables$new(
                "random_effects",
                random_effects,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "id"),
                default=NULL)
            private$..test_frailty <- jmvcore::OptionBool$new(
                "test_frailty",
                test_frailty,
                default=TRUE)
            private$..variance_components <- jmvcore::OptionBool$new(
                "variance_components",
                variance_components,
                default=TRUE)
            private$..cluster_diagnostics <- jmvcore::OptionBool$new(
                "cluster_diagnostics",
                cluster_diagnostics,
                default=TRUE)
            private$..prediction_intervals <- jmvcore::OptionBool$new(
                "prediction_intervals",
                prediction_intervals,
                default=FALSE)
            private$..survival_curves <- jmvcore::OptionBool$new(
                "survival_curves",
                survival_curves,
                default=TRUE)
            private$..residual_analysis <- jmvcore::OptionBool$new(
                "residual_analysis",
                residual_analysis,
                default=TRUE)
            private$..model_comparison <- jmvcore::OptionBool$new(
                "model_comparison",
                model_comparison,
                default=TRUE)
            private$..mcmc_iterations <- jmvcore::OptionInteger$new(
                "mcmc_iterations",
                mcmc_iterations,
                default=10000,
                min=1000,
                max=50000)
            private$..burnin_samples <- jmvcore::OptionInteger$new(
                "burnin_samples",
                burnin_samples,
                default=2000,
                min=500,
                max=20000)
            private$..convergence_diagnostics <- jmvcore::OptionBool$new(
                "convergence_diagnostics",
                convergence_diagnostics,
                default=TRUE)

            self$.addOption(private$..time_var)
            self$.addOption(private$..status_var)
            self$.addOption(private$..cluster_var)
            self$.addOption(private$..covariates)
            self$.addOption(private$..strata_vars)
            self$.addOption(private$..frailty_type)
            self$.addOption(private$..frailty_distribution)
            self$.addOption(private$..estimation_method)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..baseline_hazard)
            self$.addOption(private$..random_effects)
            self$.addOption(private$..test_frailty)
            self$.addOption(private$..variance_components)
            self$.addOption(private$..cluster_diagnostics)
            self$.addOption(private$..prediction_intervals)
            self$.addOption(private$..survival_curves)
            self$.addOption(private$..residual_analysis)
            self$.addOption(private$..model_comparison)
            self$.addOption(private$..mcmc_iterations)
            self$.addOption(private$..burnin_samples)
            self$.addOption(private$..convergence_diagnostics)
        }),
    active = list(
        time_var = function() private$..time_var$value,
        status_var = function() private$..status_var$value,
        cluster_var = function() private$..cluster_var$value,
        covariates = function() private$..covariates$value,
        strata_vars = function() private$..strata_vars$value,
        frailty_type = function() private$..frailty_type$value,
        frailty_distribution = function() private$..frailty_distribution$value,
        estimation_method = function() private$..estimation_method$value,
        confidence_level = function() private$..confidence_level$value,
        baseline_hazard = function() private$..baseline_hazard$value,
        random_effects = function() private$..random_effects$value,
        test_frailty = function() private$..test_frailty$value,
        variance_components = function() private$..variance_components$value,
        cluster_diagnostics = function() private$..cluster_diagnostics$value,
        prediction_intervals = function() private$..prediction_intervals$value,
        survival_curves = function() private$..survival_curves$value,
        residual_analysis = function() private$..residual_analysis$value,
        model_comparison = function() private$..model_comparison$value,
        mcmc_iterations = function() private$..mcmc_iterations$value,
        burnin_samples = function() private$..burnin_samples$value,
        convergence_diagnostics = function() private$..convergence_diagnostics$value),
    private = list(
        ..time_var = NA,
        ..status_var = NA,
        ..cluster_var = NA,
        ..covariates = NA,
        ..strata_vars = NA,
        ..frailty_type = NA,
        ..frailty_distribution = NA,
        ..estimation_method = NA,
        ..confidence_level = NA,
        ..baseline_hazard = NA,
        ..random_effects = NA,
        ..test_frailty = NA,
        ..variance_components = NA,
        ..cluster_diagnostics = NA,
        ..prediction_intervals = NA,
        ..survival_curves = NA,
        ..residual_analysis = NA,
        ..model_comparison = NA,
        ..mcmc_iterations = NA,
        ..burnin_samples = NA,
        ..convergence_diagnostics = NA)
)

frailtysurvivalResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "frailtysurvivalResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        model_summary = function() private$.items[["model_summary"]],
        frailty_effects = function() private$.items[["frailty_effects"]],
        variance_components_table = function() private$.items[["variance_components_table"]],
        covariate_effects = function() private$.items[["covariate_effects"]],
        frailty_test = function() private$.items[["frailty_test"]],
        model_comparison_table = function() private$.items[["model_comparison_table"]],
        cluster_summary = function() private$.items[["cluster_summary"]],
        convergence_summary = function() private$.items[["convergence_summary"]],
        survival_curves_plot = function() private$.items[["survival_curves_plot"]],
        frailty_distribution_plot = function() private$.items[["frailty_distribution_plot"]],
        cluster_effects_plot = function() private$.items[["cluster_effects_plot"]],
        residual_plots = function() private$.items[["residual_plots"]],
        variance_components_plot = function() private$.items[["variance_components_plot"]],
        mcmc_diagnostics_plot = function() private$.items[["mcmc_diagnostics_plot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Frailty & Random Effects Survival Models",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Analysis Instructions",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="model_summary",
                title="Frailty Model Summary",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="frailty_effects",
                title="Frailty Effects Analysis",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="variance_components_table",
                title="Variance Components",
                visible="(variance_components)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="covariate_effects",
                title="Covariate Effects",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="frailty_test",
                title="Test for Frailty Effects",
                visible="(test_frailty)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="model_comparison_table",
                title="Model Comparison",
                visible="(model_comparison)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="cluster_summary",
                title="Cluster-Level Summary",
                visible="(cluster_diagnostics)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="convergence_summary",
                title="Convergence Diagnostics",
                visible="(convergence_diagnostics && estimation_method == 'mcmc')"))
            self$add(jmvcore::Image$new(
                options=options,
                name="survival_curves_plot",
                title="Cluster-Specific Survival Curves",
                width=800,
                height=600,
                renderFun=".plot_survival_curves",
                visible="(survival_curves)",
                clearWith=list(
                    "time_var",
                    "status_var",
                    "cluster_var",
                    "frailty_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="frailty_distribution_plot",
                title="Frailty Distribution",
                width=800,
                height=600,
                renderFun=".plot_frailty_distribution",
                visible=TRUE,
                clearWith=list(
                    "cluster_var",
                    "frailty_type",
                    "frailty_distribution")))
            self$add(jmvcore::Image$new(
                options=options,
                name="cluster_effects_plot",
                title="Cluster Effects Plot",
                width=800,
                height=600,
                renderFun=".plot_cluster_effects",
                visible="(cluster_diagnostics)",
                clearWith=list(
                    "cluster_var",
                    "frailty_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="residual_plots",
                title="Model Residuals",
                width=800,
                height=600,
                renderFun=".plot_residuals",
                visible="(residual_analysis)",
                clearWith=list(
                    "time_var",
                    "status_var",
                    "covariates",
                    "frailty_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="variance_components_plot",
                title="Variance Components Visualization",
                width=800,
                height=600,
                renderFun=".plot_variance_components",
                visible="(variance_components)",
                clearWith=list(
                    "cluster_var",
                    "random_effects",
                    "frailty_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="mcmc_diagnostics_plot",
                title="MCMC Diagnostics",
                width=800,
                height=600,
                renderFun=".plot_mcmc_diagnostics",
                visible="(convergence_diagnostics && estimation_method == 'mcmc')",
                clearWith=list(
                    "estimation_method",
                    "mcmc_iterations",
                    "burnin_samples")))}))

frailtysurvivalBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "frailtysurvivalBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "frailtysurvival",
                version = c(0,0,3),
                options = options,
                results = frailtysurvivalResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'na')
        }))

#' Frailty & Random Effects Survival Models
#'
#' Frailty and random effects survival models for clustered data analysis.
#' Includes gamma frailty, shared frailty, and correlated frailty models
#' for multi-center studies, family studies, and recurrent events.
#' 
#'
#' @examples
#' # Example: Multi-center survival with shared frailty
#' frailtysurvival(
#'     data = multicenter_data,
#'     time_var = followup_time,
#'     status_var = death_event,
#'     cluster_var = center_id,
#'     covariates = c("age", "stage", "treatment"),
#'     frailty_type = "shared"
#' )
#'
#' @param time_var Survival time variable
#' @param status_var Event status indicator variable
#' @param cluster_var Variable defining clusters for frailty modeling
#' @param covariates Covariates to include in the survival model
#' @param strata_vars Variables for stratifying the baseline hazard
#' @param frailty_type Frailty model type for cluster dependencies
#' @param frailty_distribution Probability distribution for frailty effects
#' @param estimation_method Statistical estimation approach
#' @param confidence_level Confidence level for parameter estimates
#' @param baseline_hazard Baseline hazard function choice
#' @param random_effects Additional random effects variables
#' @param test_frailty Whether to test for significant frailty
#' @param variance_components Whether to analyze variance components
#' @param cluster_diagnostics Whether to generate cluster diagnostics
#' @param prediction_intervals Whether to compute prediction intervals
#' @param survival_curves Whether to plot cluster-specific curves
#' @param residual_analysis Whether to include residual analysis
#' @param model_comparison Whether to compare with standard models
#' @param mcmc_iterations MCMC sampling iterations
#' @param burnin_samples MCMC burn-in period
#' @param convergence_diagnostics Whether to assess MCMC convergence
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$model_summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$frailty_effects} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$variance_components_table} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$covariate_effects} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$frailty_test} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$model_comparison_table} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$cluster_summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$convergence_summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$survival_curves_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$frailty_distribution_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$cluster_effects_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$residual_plots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$variance_components_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$mcmc_diagnostics_plot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' @export
frailtysurvival <- function(
    time_var,
    status_var,
    cluster_var,
    covariates = NULL,
    strata_vars = NULL,
    frailty_type = "shared",
    frailty_distribution = "gamma",
    estimation_method = "penalized_likelihood",
    confidence_level = 0.95,
    baseline_hazard = "cox",
    random_effects = NULL,
    test_frailty = TRUE,
    variance_components = TRUE,
    cluster_diagnostics = TRUE,
    prediction_intervals = FALSE,
    survival_curves = TRUE,
    residual_analysis = TRUE,
    model_comparison = TRUE,
    mcmc_iterations = 10000,
    burnin_samples = 2000,
    convergence_diagnostics = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("frailtysurvival requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time_var)) time_var <- jmvcore::resolveQuo(jmvcore::enquo(time_var))
    if ( ! missing(status_var)) status_var <- jmvcore::resolveQuo(jmvcore::enquo(status_var))
    if ( ! missing(cluster_var)) cluster_var <- jmvcore::resolveQuo(jmvcore::enquo(cluster_var))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(strata_vars)) strata_vars <- jmvcore::resolveQuo(jmvcore::enquo(strata_vars))
    if ( ! missing(random_effects)) random_effects <- jmvcore::resolveQuo(jmvcore::enquo(random_effects))

    options <- frailtysurvivalOptions$new(
        time_var = time_var,
        status_var = status_var,
        cluster_var = cluster_var,
        covariates = covariates,
        strata_vars = strata_vars,
        frailty_type = frailty_type,
        frailty_distribution = frailty_distribution,
        estimation_method = estimation_method,
        confidence_level = confidence_level,
        baseline_hazard = baseline_hazard,
        random_effects = random_effects,
        test_frailty = test_frailty,
        variance_components = variance_components,
        cluster_diagnostics = cluster_diagnostics,
        prediction_intervals = prediction_intervals,
        survival_curves = survival_curves,
        residual_analysis = residual_analysis,
        model_comparison = model_comparison,
        mcmc_iterations = mcmc_iterations,
        burnin_samples = burnin_samples,
        convergence_diagnostics = convergence_diagnostics)

    analysis <- frailtysurvivalClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

