
# This file is automatically generated, you probably don't want to edit this

jjoncoplotOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jjoncoplotOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            sampleVar = NULL,
            geneVars = NULL,
            clinicalVars = NULL,
            mutationTypeVar = NULL,
            clinicalPreset = "custom",
            plotType = "oncoplot",
            topn = 10,
            genesToInclude = "",
            genesToIgnore = "",
            maxSamples = 50,
            sortBy = "hierarchical",
            colorScheme = "default",
            showMutationLoad = FALSE,
            showGeneFreq = FALSE,
            drawMarginalPlots = FALSE,
            showTMB = FALSE,
            log10TransformTMB = TRUE,
            showClinicalAnnotation = FALSE,
            plotWidth = 800,
            plotHeight = 600,
            fontSize = 10,
            showLegend = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="jjoncoplot",
                requiresData=TRUE,
                ...)

            private$..sampleVar <- jmvcore::OptionVariable$new(
                "sampleVar",
                sampleVar,
                suggested=list(
                    "nominal",
                    "id"),
                permitted=list(
                    "numeric",
                    "factor",
                    "id"))
            private$..geneVars <- jmvcore::OptionVariables$new(
                "geneVars",
                geneVars,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..clinicalVars <- jmvcore::OptionVariables$new(
                "clinicalVars",
                clinicalVars,
                suggested=list(
                    "nominal",
                    "ordinal",
                    "continuous"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..mutationTypeVar <- jmvcore::OptionVariable$new(
                "mutationTypeVar",
                mutationTypeVar,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..clinicalPreset <- jmvcore::OptionList$new(
                "clinicalPreset",
                clinicalPreset,
                options=list(
                    "custom",
                    "tumor_profiling",
                    "biomarker_discovery",
                    "therapeutic_targets",
                    "pathway_analysis"),
                default="custom")
            private$..plotType <- jmvcore::OptionList$new(
                "plotType",
                plotType,
                options=list(
                    "oncoplot",
                    "frequency",
                    "cooccurrence"),
                default="oncoplot")
            private$..topn <- jmvcore::OptionNumber$new(
                "topn",
                topn,
                default=10,
                min=3,
                max=50)
            private$..genesToInclude <- jmvcore::OptionString$new(
                "genesToInclude",
                genesToInclude,
                default="")
            private$..genesToIgnore <- jmvcore::OptionString$new(
                "genesToIgnore",
                genesToIgnore,
                default="")
            private$..maxSamples <- jmvcore::OptionNumber$new(
                "maxSamples",
                maxSamples,
                default=50,
                min=10,
                max=500)
            private$..sortBy <- jmvcore::OptionList$new(
                "sortBy",
                sortBy,
                options=list(
                    "hierarchical",
                    "mutation_count",
                    "sample_id",
                    "clinical"),
                default="hierarchical")
            private$..colorScheme <- jmvcore::OptionList$new(
                "colorScheme",
                colorScheme,
                options=list(
                    "default",
                    "mutation_type",
                    "clinical",
                    "viridis",
                    "high_contrast"),
                default="default")
            private$..showMutationLoad <- jmvcore::OptionBool$new(
                "showMutationLoad",
                showMutationLoad,
                default=FALSE)
            private$..showGeneFreq <- jmvcore::OptionBool$new(
                "showGeneFreq",
                showGeneFreq,
                default=FALSE)
            private$..drawMarginalPlots <- jmvcore::OptionBool$new(
                "drawMarginalPlots",
                drawMarginalPlots,
                default=FALSE)
            private$..showTMB <- jmvcore::OptionBool$new(
                "showTMB",
                showTMB,
                default=FALSE)
            private$..log10TransformTMB <- jmvcore::OptionBool$new(
                "log10TransformTMB",
                log10TransformTMB,
                default=TRUE)
            private$..showClinicalAnnotation <- jmvcore::OptionBool$new(
                "showClinicalAnnotation",
                showClinicalAnnotation,
                default=FALSE)
            private$..plotWidth <- jmvcore::OptionNumber$new(
                "plotWidth",
                plotWidth,
                default=800,
                min=400,
                max=1600)
            private$..plotHeight <- jmvcore::OptionNumber$new(
                "plotHeight",
                plotHeight,
                default=600,
                min=300,
                max=1200)
            private$..fontSize <- jmvcore::OptionNumber$new(
                "fontSize",
                fontSize,
                default=10,
                min=6,
                max=16)
            private$..showLegend <- jmvcore::OptionBool$new(
                "showLegend",
                showLegend,
                default=FALSE)

            self$.addOption(private$..sampleVar)
            self$.addOption(private$..geneVars)
            self$.addOption(private$..clinicalVars)
            self$.addOption(private$..mutationTypeVar)
            self$.addOption(private$..clinicalPreset)
            self$.addOption(private$..plotType)
            self$.addOption(private$..topn)
            self$.addOption(private$..genesToInclude)
            self$.addOption(private$..genesToIgnore)
            self$.addOption(private$..maxSamples)
            self$.addOption(private$..sortBy)
            self$.addOption(private$..colorScheme)
            self$.addOption(private$..showMutationLoad)
            self$.addOption(private$..showGeneFreq)
            self$.addOption(private$..drawMarginalPlots)
            self$.addOption(private$..showTMB)
            self$.addOption(private$..log10TransformTMB)
            self$.addOption(private$..showClinicalAnnotation)
            self$.addOption(private$..plotWidth)
            self$.addOption(private$..plotHeight)
            self$.addOption(private$..fontSize)
            self$.addOption(private$..showLegend)
        }),
    active = list(
        sampleVar = function() private$..sampleVar$value,
        geneVars = function() private$..geneVars$value,
        clinicalVars = function() private$..clinicalVars$value,
        mutationTypeVar = function() private$..mutationTypeVar$value,
        clinicalPreset = function() private$..clinicalPreset$value,
        plotType = function() private$..plotType$value,
        topn = function() private$..topn$value,
        genesToInclude = function() private$..genesToInclude$value,
        genesToIgnore = function() private$..genesToIgnore$value,
        maxSamples = function() private$..maxSamples$value,
        sortBy = function() private$..sortBy$value,
        colorScheme = function() private$..colorScheme$value,
        showMutationLoad = function() private$..showMutationLoad$value,
        showGeneFreq = function() private$..showGeneFreq$value,
        drawMarginalPlots = function() private$..drawMarginalPlots$value,
        showTMB = function() private$..showTMB$value,
        log10TransformTMB = function() private$..log10TransformTMB$value,
        showClinicalAnnotation = function() private$..showClinicalAnnotation$value,
        plotWidth = function() private$..plotWidth$value,
        plotHeight = function() private$..plotHeight$value,
        fontSize = function() private$..fontSize$value,
        showLegend = function() private$..showLegend$value),
    private = list(
        ..sampleVar = NA,
        ..geneVars = NA,
        ..clinicalVars = NA,
        ..mutationTypeVar = NA,
        ..clinicalPreset = NA,
        ..plotType = NA,
        ..topn = NA,
        ..genesToInclude = NA,
        ..genesToIgnore = NA,
        ..maxSamples = NA,
        ..sortBy = NA,
        ..colorScheme = NA,
        ..showMutationLoad = NA,
        ..showGeneFreq = NA,
        ..drawMarginalPlots = NA,
        ..showTMB = NA,
        ..log10TransformTMB = NA,
        ..showClinicalAnnotation = NA,
        ..plotWidth = NA,
        ..plotHeight = NA,
        ..fontSize = NA,
        ..showLegend = NA)
)

jjoncoplotResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jjoncoplotResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        setupGuidance = function() private$.items[["setupGuidance"]],
        main = function() private$.items[["main"]],
        mutationSummary = function() private$.items[["mutationSummary"]],
        sampleSummary = function() private$.items[["sampleSummary"]],
        clinicalSummary = function() private$.items[["clinicalSummary"]],
        cooccurrence = function() private$.items[["cooccurrence"]],
        plotInfo = function() private$.items[["plotInfo"]],
        clinicalSummaryText = function() private$.items[["clinicalSummaryText"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Genomic Landscape Visualization",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="setupGuidance",
                title="Setup Guidance",
                visible=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="main",
                title="Genomic Landscape Plot",
                width=800,
                height=600,
                requiresData=TRUE,
                renderFun=".plotMain",
                refs="jjoncoplot",
                clearWith=list(
                    "geneVars",
                    "sampleVar",
                    "clinicalVars",
                    "mutationTypeVar",
                    "plotType",
                    "topn",
                    "genesToInclude",
                    "genesToIgnore",
                    "maxSamples",
                    "sortBy",
                    "colorScheme",
                    "drawMarginalPlots",
                    "showTMB",
                    "log10TransformTMB",
                    "showGeneFreq")))
            self$add(jmvcore::Table$new(
                options=options,
                name="mutationSummary",
                title="Mutation Summary",
                rows=0,
                clearWith=list(
                    "geneVars",
                    "sampleVar",
                    "mutationTypeVar",
                    "topn",
                    "genesToInclude",
                    "genesToIgnore",
                    "maxSamples"),
                columns=list(
                    list(
                        `name`="gene", 
                        `title`="Gene", 
                        `type`="text"),
                    list(
                        `name`="mutated_samples", 
                        `title`="Mutated Samples", 
                        `type`="integer"),
                    list(
                        `name`="total_samples", 
                        `title`="Total Samples", 
                        `type`="integer"),
                    list(
                        `name`="mutation_frequency", 
                        `title`="Mutation Frequency", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="mutation_type", 
                        `title`="Most Common Type", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="sampleSummary",
                title="Sample Summary",
                rows=0,
                clearWith=list(
                    "geneVars",
                    "sampleVar",
                    "topn",
                    "genesToInclude",
                    "genesToIgnore",
                    "maxSamples",
                    "sortBy"),
                columns=list(
                    list(
                        `name`="sample", 
                        `title`="Sample ID", 
                        `type`="text"),
                    list(
                        `name`="total_mutations", 
                        `title`="Total Mutations", 
                        `type`="integer"),
                    list(
                        `name`="genes_mutated", 
                        `title`="Genes Mutated", 
                        `type`="integer"),
                    list(
                        `name`="mutation_burden", 
                        `title`="Mutation Burden", 
                        `type`="number", 
                        `format`="pc"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="clinicalSummary",
                title="Clinical Annotation Summary",
                rows=0,
                clearWith=list(
                    "clinicalVars",
                    "sampleVar"),
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Clinical Variable", 
                        `type`="text"),
                    list(
                        `name`="categories", 
                        `title`="Categories/Range", 
                        `type`="text"),
                    list(
                        `name`="missing", 
                        `title`="Missing Values", 
                        `type`="integer"),
                    list(
                        `name`="complete", 
                        `title`="Complete Values", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="cooccurrence",
                title="Gene Co-occurrence Analysis",
                rows=0,
                clearWith=list(
                    "geneVars",
                    "sampleVar",
                    "plotType",
                    "topn",
                    "genesToInclude",
                    "genesToIgnore",
                    "maxSamples"),
                columns=list(
                    list(
                        `name`="gene1", 
                        `title`="Gene 1", 
                        `type`="text"),
                    list(
                        `name`="gene2", 
                        `title`="Gene 2", 
                        `type`="text"),
                    list(
                        `name`="cooccurrence_count", 
                        `title`="Co-occurring Samples", 
                        `type`="integer"),
                    list(
                        `name`="exclusivity_count", 
                        `title`="Mutually Exclusive Samples", 
                        `type`="integer"),
                    list(
                        `name`="association_type", 
                        `title`="Association", 
                        `type`="text"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="plotInfo",
                title="Plot Information",
                rows=0,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalSummaryText",
                title="Clinical Summary for Reports",
                visible=TRUE))}))

jjoncoplotBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jjoncoplotBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "jjoncoplot",
                version = c(0,0,1),
                options = options,
                results = jjoncoplotResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Genomic Landscape Visualization
#'
#' Creates oncoplots (mutation landscapes) to visualize genomic alterations 
#' across genes and samples with optional clinical annotations.
#'
#' @examples
#' \donttest{
#' data <- data.frame(
#'     SampleID = paste0("S", 1:10),
#'     TP53 = c(1, 0, 1, 0, 1, 0, 0, 1, 0, 1),
#'     KRAS = c(0, 1, 0, 1, 0, 1, 1, 0, 1, 0),
#'     PIK3CA = c(1, 1, 0, 0, 1, 0, 1, 1, 0, 0)
#' )
#' jjoncoplot(
#'     data = data,
#'     sampleVar = "SampleID",
#'     geneVars = c("TP53", "KRAS", "PIK3CA")
#' )
#'}
#' @param data The data as a data frame.
#' @param sampleVar Variable containing sample identifiers.
#' @param geneVars Variables representing genes or mutations (0/1 or
#'   categorical values).
#' @param clinicalVars Optional clinical variables for annotation (e.g., age,
#'   stage, treatment).
#' @param mutationTypeVar Variable containing mutation type information (e.g.,
#'   SNV, CNV, Fusion).
#' @param clinicalPreset Predefined clinical analysis configurations optimized
#'   for specific research goals.
#' @param plotType Type of genomic visualization to generate.
#' @param topn Number of most frequently mutated genes to display.
#' @param genesToInclude Comma-separated list of specific genes to include
#'   (overrides topn).
#' @param genesToIgnore Comma-separated list of genes to exclude from
#'   analysis.
#' @param maxSamples Maximum number of samples to display.
#' @param sortBy Method for sorting samples in the plot.
#' @param colorScheme Color scheme for the oncoplot visualization.
#' @param showMutationLoad Display mutation load bar plot alongside oncoplot.
#' @param showGeneFreq Display gene mutation frequency alongside oncoplot.
#' @param drawMarginalPlots Integrate gene frequency and TMB plots as margins
#'   of the main oncoplot.
#' @param showTMB Display tumor mutation burden (TMB) bar plot.
#' @param log10TransformTMB Apply log10 transformation to TMB values for
#'   better visualization.
#' @param showClinicalAnnotation Display clinical annotations as heatmap.
#' @param plotWidth Width of the plot in pixels.
#' @param plotHeight Height of the plot in pixels.
#' @param fontSize Font size for plot labels.
#' @param showLegend Display plot legend.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$setupGuidance} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$main} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$mutationSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$sampleSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clinicalSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$cooccurrence} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$plotInfo} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clinicalSummaryText} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$mutationSummary$asDF}
#'
#' \code{as.data.frame(results$mutationSummary)}
#'
#' @export
jjoncoplot <- function(
    data,
    sampleVar,
    geneVars,
    clinicalVars = NULL,
    mutationTypeVar = NULL,
    clinicalPreset = "custom",
    plotType = "oncoplot",
    topn = 10,
    genesToInclude = "",
    genesToIgnore = "",
    maxSamples = 50,
    sortBy = "hierarchical",
    colorScheme = "default",
    showMutationLoad = FALSE,
    showGeneFreq = FALSE,
    drawMarginalPlots = FALSE,
    showTMB = FALSE,
    log10TransformTMB = TRUE,
    showClinicalAnnotation = FALSE,
    plotWidth = 800,
    plotHeight = 600,
    fontSize = 10,
    showLegend = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("jjoncoplot requires jmvcore to be installed (restart may be required)")

    if ( ! missing(sampleVar)) sampleVar <- jmvcore::resolveQuo(jmvcore::enquo(sampleVar))
    if ( ! missing(geneVars)) geneVars <- jmvcore::resolveQuo(jmvcore::enquo(geneVars))
    if ( ! missing(clinicalVars)) clinicalVars <- jmvcore::resolveQuo(jmvcore::enquo(clinicalVars))
    if ( ! missing(mutationTypeVar)) mutationTypeVar <- jmvcore::resolveQuo(jmvcore::enquo(mutationTypeVar))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(sampleVar), sampleVar, NULL),
            `if`( ! missing(geneVars), geneVars, NULL),
            `if`( ! missing(clinicalVars), clinicalVars, NULL),
            `if`( ! missing(mutationTypeVar), mutationTypeVar, NULL))

    for (v in mutationTypeVar) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- jjoncoplotOptions$new(
        sampleVar = sampleVar,
        geneVars = geneVars,
        clinicalVars = clinicalVars,
        mutationTypeVar = mutationTypeVar,
        clinicalPreset = clinicalPreset,
        plotType = plotType,
        topn = topn,
        genesToInclude = genesToInclude,
        genesToIgnore = genesToIgnore,
        maxSamples = maxSamples,
        sortBy = sortBy,
        colorScheme = colorScheme,
        showMutationLoad = showMutationLoad,
        showGeneFreq = showGeneFreq,
        drawMarginalPlots = drawMarginalPlots,
        showTMB = showTMB,
        log10TransformTMB = log10TransformTMB,
        showClinicalAnnotation = showClinicalAnnotation,
        plotWidth = plotWidth,
        plotHeight = plotHeight,
        fontSize = fontSize,
        showLegend = showLegend)

    analysis <- jjoncoplotClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

