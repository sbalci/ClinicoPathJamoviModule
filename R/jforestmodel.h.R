
# This file is automatically generated, you probably don't want to edit this

jforestmodelOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jforestmodelOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            dependent_var = NULL,
            predictor_vars = NULL,
            model_type = "lm",
            time_var = NULL,
            event_var = NULL,
            family = "binomial",
            exponentiate = FALSE,
            show_p_values = TRUE,
            show_confidence_intervals = TRUE,
            confidence_level = 0.95,
            factor_separate_line = TRUE,
            covariates = NULL,
            sort_variables = "none",
            plot_title = "Forest Plot",
            x_axis_label = "",
            point_size = 2,
            line_size = 0.5,
            color_scheme = "default",
            custom_color = "#2E8B57",
            show_reference_line = TRUE,
            reference_value = 0,
            panel_width_ratio = "1:1:1",
            show_summary = TRUE,
            show_interpretation = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="jforestmodel",
                requiresData=TRUE,
                ...)

            private$..dependent_var <- jmvcore::OptionVariable$new(
                "dependent_var",
                dependent_var,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"))
            private$..predictor_vars <- jmvcore::OptionVariables$new(
                "predictor_vars",
                predictor_vars)
            private$..model_type <- jmvcore::OptionList$new(
                "model_type",
                model_type,
                options=list(
                    "lm",
                    "glm",
                    "coxph",
                    "custom"),
                default="lm")
            private$..time_var <- jmvcore::OptionVariable$new(
                "time_var",
                time_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event_var <- jmvcore::OptionVariable$new(
                "event_var",
                event_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..family <- jmvcore::OptionList$new(
                "family",
                family,
                options=list(
                    "binomial",
                    "poisson",
                    "gaussian",
                    "gamma"),
                default="binomial")
            private$..exponentiate <- jmvcore::OptionBool$new(
                "exponentiate",
                exponentiate,
                default=FALSE)
            private$..show_p_values <- jmvcore::OptionBool$new(
                "show_p_values",
                show_p_values,
                default=TRUE)
            private$..show_confidence_intervals <- jmvcore::OptionBool$new(
                "show_confidence_intervals",
                show_confidence_intervals,
                default=TRUE)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..factor_separate_line <- jmvcore::OptionBool$new(
                "factor_separate_line",
                factor_separate_line,
                default=TRUE)
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates)
            private$..sort_variables <- jmvcore::OptionList$new(
                "sort_variables",
                sort_variables,
                options=list(
                    "none",
                    "coefficient",
                    "pvalue",
                    "alphabetical"),
                default="none")
            private$..plot_title <- jmvcore::OptionString$new(
                "plot_title",
                plot_title,
                default="Forest Plot")
            private$..x_axis_label <- jmvcore::OptionString$new(
                "x_axis_label",
                x_axis_label,
                default="")
            private$..point_size <- jmvcore::OptionNumber$new(
                "point_size",
                point_size,
                min=0.5,
                max=5,
                default=2)
            private$..line_size <- jmvcore::OptionNumber$new(
                "line_size",
                line_size,
                min=0.1,
                max=2,
                default=0.5)
            private$..color_scheme <- jmvcore::OptionList$new(
                "color_scheme",
                color_scheme,
                options=list(
                    "default",
                    "blue",
                    "red",
                    "green",
                    "purple",
                    "custom"),
                default="default")
            private$..custom_color <- jmvcore::OptionString$new(
                "custom_color",
                custom_color,
                default="#2E8B57")
            private$..show_reference_line <- jmvcore::OptionBool$new(
                "show_reference_line",
                show_reference_line,
                default=TRUE)
            private$..reference_value <- jmvcore::OptionNumber$new(
                "reference_value",
                reference_value,
                default=0)
            private$..panel_width_ratio <- jmvcore::OptionString$new(
                "panel_width_ratio",
                panel_width_ratio,
                default="1:1:1")
            private$..show_summary <- jmvcore::OptionBool$new(
                "show_summary",
                show_summary,
                default=TRUE)
            private$..show_interpretation <- jmvcore::OptionBool$new(
                "show_interpretation",
                show_interpretation,
                default=TRUE)

            self$.addOption(private$..dependent_var)
            self$.addOption(private$..predictor_vars)
            self$.addOption(private$..model_type)
            self$.addOption(private$..time_var)
            self$.addOption(private$..event_var)
            self$.addOption(private$..family)
            self$.addOption(private$..exponentiate)
            self$.addOption(private$..show_p_values)
            self$.addOption(private$..show_confidence_intervals)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..factor_separate_line)
            self$.addOption(private$..covariates)
            self$.addOption(private$..sort_variables)
            self$.addOption(private$..plot_title)
            self$.addOption(private$..x_axis_label)
            self$.addOption(private$..point_size)
            self$.addOption(private$..line_size)
            self$.addOption(private$..color_scheme)
            self$.addOption(private$..custom_color)
            self$.addOption(private$..show_reference_line)
            self$.addOption(private$..reference_value)
            self$.addOption(private$..panel_width_ratio)
            self$.addOption(private$..show_summary)
            self$.addOption(private$..show_interpretation)
        }),
    active = list(
        dependent_var = function() private$..dependent_var$value,
        predictor_vars = function() private$..predictor_vars$value,
        model_type = function() private$..model_type$value,
        time_var = function() private$..time_var$value,
        event_var = function() private$..event_var$value,
        family = function() private$..family$value,
        exponentiate = function() private$..exponentiate$value,
        show_p_values = function() private$..show_p_values$value,
        show_confidence_intervals = function() private$..show_confidence_intervals$value,
        confidence_level = function() private$..confidence_level$value,
        factor_separate_line = function() private$..factor_separate_line$value,
        covariates = function() private$..covariates$value,
        sort_variables = function() private$..sort_variables$value,
        plot_title = function() private$..plot_title$value,
        x_axis_label = function() private$..x_axis_label$value,
        point_size = function() private$..point_size$value,
        line_size = function() private$..line_size$value,
        color_scheme = function() private$..color_scheme$value,
        custom_color = function() private$..custom_color$value,
        show_reference_line = function() private$..show_reference_line$value,
        reference_value = function() private$..reference_value$value,
        panel_width_ratio = function() private$..panel_width_ratio$value,
        show_summary = function() private$..show_summary$value,
        show_interpretation = function() private$..show_interpretation$value),
    private = list(
        ..dependent_var = NA,
        ..predictor_vars = NA,
        ..model_type = NA,
        ..time_var = NA,
        ..event_var = NA,
        ..family = NA,
        ..exponentiate = NA,
        ..show_p_values = NA,
        ..show_confidence_intervals = NA,
        ..confidence_level = NA,
        ..factor_separate_line = NA,
        ..covariates = NA,
        ..sort_variables = NA,
        ..plot_title = NA,
        ..x_axis_label = NA,
        ..point_size = NA,
        ..line_size = NA,
        ..color_scheme = NA,
        ..custom_color = NA,
        ..show_reference_line = NA,
        ..reference_value = NA,
        ..panel_width_ratio = NA,
        ..show_summary = NA,
        ..show_interpretation = NA)
)

jforestmodelResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jforestmodelResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        model_summary = function() private$.items[["model_summary"]],
        coefficients_table = function() private$.items[["coefficients_table"]],
        forest_plot = function() private$.items[["forest_plot"]],
        model_diagnostics = function() private$.items[["model_diagnostics"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Forest Plot Visualization",
                refs=list(
                    "ClinicoPathJamoviModule",
                    ".step",
                    "survival",
                    "forestmodel"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Analysis Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="model_summary",
                title="Model Summary",
                visible="(show_summary)",
                columns=list(
                    list(
                        `name`="Attribute", 
                        `title`="Attribute", 
                        `type`="text"),
                    list(
                        `name`="Value", 
                        `title`="Value", 
                        `type`="text")),
                clearWith=list(
                    "dependent_var",
                    "predictor_vars",
                    "model_type",
                    "family")))
            self$add(jmvcore::Table$new(
                options=options,
                name="coefficients_table",
                title="Model Coefficients",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="Variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="Coefficient", 
                        `title`="Coefficient", 
                        `type`="number"),
                    list(
                        `name`="SE", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="CI_Lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="CI_Upper", 
                        `title`="CI Upper", 
                        `type`="number"),
                    list(
                        `name`="P_Value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue")),
                clearWith=list(
                    "dependent_var",
                    "predictor_vars",
                    "model_type",
                    "confidence_level",
                    "exponentiate")))
            self$add(jmvcore::Image$new(
                options=options,
                name="forest_plot",
                title="Forest Plot",
                width=600,
                height=400,
                renderFun=".plot_forest",
                visible=TRUE,
                clearWith=list(
                    "dependent_var",
                    "predictor_vars",
                    "model_type",
                    "exponentiate",
                    "show_p_values",
                    "show_confidence_intervals",
                    "confidence_level",
                    "factor_separate_line",
                    "sort_variables",
                    "point_size",
                    "line_size",
                    "color_scheme",
                    "custom_color",
                    "show_reference_line",
                    "reference_value")))
            self$add(jmvcore::Table$new(
                options=options,
                name="model_diagnostics",
                title="Model Diagnostics",
                visible="(model_type:lm || model_type:glm)",
                columns=list(
                    list(
                        `name`="Diagnostic", 
                        `title`="Diagnostic", 
                        `type`="text"),
                    list(
                        `name`="Value", 
                        `title`="Value", 
                        `type`="text"),
                    list(
                        `name`="Interpretation", 
                        `title`="Interpretation", 
                        `type`="text")),
                clearWith=list(
                    "dependent_var",
                    "predictor_vars",
                    "model_type")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation",
                visible="(show_interpretation)"))}))

jforestmodelBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jforestmodelBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "jforestmodel",
                version = c(1,0,0),
                options = options,
                results = jforestmodelResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Forest Plot Visualization
#'
#' Create professional forest plots from regression models including linear,
#' logistic, and survival models. Visualize coefficients, confidence 
#' intervals,
#' and effect sizes with customizable formatting and layout options.
#' 
#' @param data Dataset containing variables for regression modeling
#' @param dependent_var Outcome variable for regression modeling
#' @param predictor_vars Independent variables to include in the model
#' @param model_type Type of regression model to fit
#' @param time_var Time-to-event variable for Cox regression
#' @param event_var Event indicator (0=censored, 1=event) for Cox regression
#' @param family Distribution family for GLM models
#' @param exponentiate Transform coefficients to odds ratios or hazard ratios
#' @param show_p_values Display p-values in the forest plot
#' @param show_confidence_intervals Display confidence intervals as horizontal
#'   lines
#' @param confidence_level Confidence level for intervals
#' @param factor_separate_line Display each factor level on a separate line
#' @param covariates Optional subset of variables to include in plot
#' @param sort_variables How to sort variables in the plot
#' @param plot_title Custom title for the forest plot
#' @param x_axis_label Custom label for x-axis (auto-generated if empty)
#' @param point_size Size of coefficient points
#' @param line_size Thickness of confidence interval lines
#' @param color_scheme Color scheme for the plot
#' @param custom_color Custom color (hex code) when using custom color scheme
#' @param show_reference_line Display vertical reference line at null effect
#' @param reference_value Value for reference line (0 for linear, 1 for
#'   exponentiated)
#' @param panel_width_ratio Ratio of panel widths (labels:plot:values)
#' @param show_summary Display model summary information
#' @param show_interpretation Provide interpretation guidance
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$model_summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$coefficients_table} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$forest_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$model_diagnostics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$model_summary$asDF}
#'
#' \code{as.data.frame(results$model_summary)}
#'
#' @export
jforestmodel <- function(
    data,
    dependent_var,
    predictor_vars,
    model_type = "lm",
    time_var,
    event_var,
    family = "binomial",
    exponentiate = FALSE,
    show_p_values = TRUE,
    show_confidence_intervals = TRUE,
    confidence_level = 0.95,
    factor_separate_line = TRUE,
    covariates,
    sort_variables = "none",
    plot_title = "Forest Plot",
    x_axis_label = "",
    point_size = 2,
    line_size = 0.5,
    color_scheme = "default",
    custom_color = "#2E8B57",
    show_reference_line = TRUE,
    reference_value = 0,
    panel_width_ratio = "1:1:1",
    show_summary = TRUE,
    show_interpretation = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("jforestmodel requires jmvcore to be installed (restart may be required)")

    if ( ! missing(dependent_var)) dependent_var <- jmvcore::resolveQuo(jmvcore::enquo(dependent_var))
    if ( ! missing(predictor_vars)) predictor_vars <- jmvcore::resolveQuo(jmvcore::enquo(predictor_vars))
    if ( ! missing(time_var)) time_var <- jmvcore::resolveQuo(jmvcore::enquo(time_var))
    if ( ! missing(event_var)) event_var <- jmvcore::resolveQuo(jmvcore::enquo(event_var))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(dependent_var), dependent_var, NULL),
            `if`( ! missing(predictor_vars), predictor_vars, NULL),
            `if`( ! missing(time_var), time_var, NULL),
            `if`( ! missing(event_var), event_var, NULL),
            `if`( ! missing(covariates), covariates, NULL))


    options <- jforestmodelOptions$new(
        dependent_var = dependent_var,
        predictor_vars = predictor_vars,
        model_type = model_type,
        time_var = time_var,
        event_var = event_var,
        family = family,
        exponentiate = exponentiate,
        show_p_values = show_p_values,
        show_confidence_intervals = show_confidence_intervals,
        confidence_level = confidence_level,
        factor_separate_line = factor_separate_line,
        covariates = covariates,
        sort_variables = sort_variables,
        plot_title = plot_title,
        x_axis_label = x_axis_label,
        point_size = point_size,
        line_size = line_size,
        color_scheme = color_scheme,
        custom_color = custom_color,
        show_reference_line = show_reference_line,
        reference_value = reference_value,
        panel_width_ratio = panel_width_ratio,
        show_summary = show_summary,
        show_interpretation = show_interpretation)

    analysis <- jforestmodelClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

