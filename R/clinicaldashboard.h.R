
# This file is automatically generated, you probably don't want to edit this

clinicaldashboardOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinicaldashboardOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            patientId = NULL,
            timeVar = NULL,
            outcomeVars = NULL,
            groupVar = NULL,
            dashboardType = "population",
            timeWindow = "last_90_days",
            showTrends = TRUE,
            showAlerts = TRUE,
            alertThresholds = "",
            showSummaryStats = TRUE,
            showDistributions = TRUE,
            realTimeUpdate = FALSE,
            exportDashboard = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="clinicaldashboard",
                requiresData=TRUE,
                ...)

            private$..patientId <- jmvcore::OptionVariable$new(
                "patientId",
                patientId,
                suggested=list(
                    "id"),
                permitted=list(
                    "factor",
                    "id"))
            private$..timeVar <- jmvcore::OptionVariable$new(
                "timeVar",
                timeVar,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcomeVars <- jmvcore::OptionVariables$new(
                "outcomeVars",
                outcomeVars,
                suggested=list(
                    "continuous",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..groupVar <- jmvcore::OptionVariable$new(
                "groupVar",
                groupVar,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..dashboardType <- jmvcore::OptionList$new(
                "dashboardType",
                dashboardType,
                options=list(
                    "patient",
                    "population",
                    "quality",
                    "outcomes"),
                default="population")
            private$..timeWindow <- jmvcore::OptionList$new(
                "timeWindow",
                timeWindow,
                options=list(
                    "last_30_days",
                    "last_90_days",
                    "last_year",
                    "all_time"),
                default="last_90_days")
            private$..showTrends <- jmvcore::OptionBool$new(
                "showTrends",
                showTrends,
                default=TRUE)
            private$..showAlerts <- jmvcore::OptionBool$new(
                "showAlerts",
                showAlerts,
                default=TRUE)
            private$..alertThresholds <- jmvcore::OptionString$new(
                "alertThresholds",
                alertThresholds,
                default="")
            private$..showSummaryStats <- jmvcore::OptionBool$new(
                "showSummaryStats",
                showSummaryStats,
                default=TRUE)
            private$..showDistributions <- jmvcore::OptionBool$new(
                "showDistributions",
                showDistributions,
                default=TRUE)
            private$..realTimeUpdate <- jmvcore::OptionBool$new(
                "realTimeUpdate",
                realTimeUpdate,
                default=FALSE)
            private$..exportDashboard <- jmvcore::OptionBool$new(
                "exportDashboard",
                exportDashboard,
                default=FALSE)

            self$.addOption(private$..patientId)
            self$.addOption(private$..timeVar)
            self$.addOption(private$..outcomeVars)
            self$.addOption(private$..groupVar)
            self$.addOption(private$..dashboardType)
            self$.addOption(private$..timeWindow)
            self$.addOption(private$..showTrends)
            self$.addOption(private$..showAlerts)
            self$.addOption(private$..alertThresholds)
            self$.addOption(private$..showSummaryStats)
            self$.addOption(private$..showDistributions)
            self$.addOption(private$..realTimeUpdate)
            self$.addOption(private$..exportDashboard)
        }),
    active = list(
        patientId = function() private$..patientId$value,
        timeVar = function() private$..timeVar$value,
        outcomeVars = function() private$..outcomeVars$value,
        groupVar = function() private$..groupVar$value,
        dashboardType = function() private$..dashboardType$value,
        timeWindow = function() private$..timeWindow$value,
        showTrends = function() private$..showTrends$value,
        showAlerts = function() private$..showAlerts$value,
        alertThresholds = function() private$..alertThresholds$value,
        showSummaryStats = function() private$..showSummaryStats$value,
        showDistributions = function() private$..showDistributions$value,
        realTimeUpdate = function() private$..realTimeUpdate$value,
        exportDashboard = function() private$..exportDashboard$value),
    private = list(
        ..patientId = NA,
        ..timeVar = NA,
        ..outcomeVars = NA,
        ..groupVar = NA,
        ..dashboardType = NA,
        ..timeWindow = NA,
        ..showTrends = NA,
        ..showAlerts = NA,
        ..alertThresholds = NA,
        ..showSummaryStats = NA,
        ..showDistributions = NA,
        ..realTimeUpdate = NA,
        ..exportDashboard = NA)
)

clinicaldashboardResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinicaldashboardResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        summaryMetrics = function() private$.items[["summaryMetrics"]],
        clinicalAlerts = function() private$.items[["clinicalAlerts"]],
        outcomeStats = function() private$.items[["outcomeStats"]],
        trendPlot = function() private$.items[["trendPlot"]],
        distributionPlot = function() private$.items[["distributionPlot"]],
        dashboardSummary = function() private$.items[["dashboardSummary"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Interactive Clinical Dashboard",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "tools"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="summaryMetrics",
                title="Summary Metrics",
                visible="(showSummaryStats)",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="current_value", 
                        `title`="Current Value", 
                        `type`="text"),
                    list(
                        `name`="trend", 
                        `title`="Trend", 
                        `type`="text"),
                    list(
                        `name`="status", 
                        `title`="Status", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="clinicalAlerts",
                title="Clinical Alerts",
                visible="(showAlerts)",
                columns=list(
                    list(
                        `name`="alert_type", 
                        `title`="Alert Type", 
                        `type`="text"),
                    list(
                        `name`="patient_id", 
                        `title`="Patient ID", 
                        `type`="text"),
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"),
                    list(
                        `name`="threshold", 
                        `title`="Threshold", 
                        `type`="text"),
                    list(
                        `name`="severity", 
                        `title`="Severity", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="outcomeStats",
                title="Outcome Statistics",
                visible="(outcomeVars && showSummaryStats)",
                columns=list(
                    list(
                        `name`="outcome", 
                        `title`="Outcome", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="mean", 
                        `title`="Mean", 
                        `type`="number"),
                    list(
                        `name`="sd", 
                        `title`="SD", 
                        `type`="number"),
                    list(
                        `name`="median", 
                        `title`="Median", 
                        `type`="number"),
                    list(
                        `name`="q25", 
                        `title`="Q1", 
                        `type`="number"),
                    list(
                        `name`="q75", 
                        `title`="Q3", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="trendPlot",
                title="Trend Analysis",
                visible="(showTrends && timeVar)",
                width=700,
                height=400,
                renderFun=".trendPlot"))
            self$add(jmvcore::Image$new(
                options=options,
                name="distributionPlot",
                title="Outcome Distributions",
                visible="(showDistributions && outcomeVars)",
                width=600,
                height=400,
                renderFun=".distributionPlot"))
            self$add(jmvcore::Html$new(
                options=options,
                name="dashboardSummary",
                title="Dashboard Summary",
                visible=TRUE))}))

clinicaldashboardBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinicaldashboardBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "clinicaldashboard",
                version = c(1,0,0),
                options = options,
                results = clinicaldashboardResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Interactive Clinical Dashboard
#'
#' 
#' @param data .
#' @param patientId .
#' @param timeVar .
#' @param outcomeVars .
#' @param groupVar .
#' @param dashboardType .
#' @param timeWindow .
#' @param showTrends .
#' @param showAlerts .
#' @param alertThresholds .
#' @param showSummaryStats .
#' @param showDistributions .
#' @param realTimeUpdate .
#' @param exportDashboard .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summaryMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clinicalAlerts} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$outcomeStats} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$trendPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$distributionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$dashboardSummary} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summaryMetrics$asDF}
#'
#' \code{as.data.frame(results$summaryMetrics)}
#'
#' @export
clinicaldashboard <- function(
    data,
    patientId,
    timeVar,
    outcomeVars,
    groupVar,
    dashboardType = "population",
    timeWindow = "last_90_days",
    showTrends = TRUE,
    showAlerts = TRUE,
    alertThresholds = "",
    showSummaryStats = TRUE,
    showDistributions = TRUE,
    realTimeUpdate = FALSE,
    exportDashboard = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("clinicaldashboard requires jmvcore to be installed (restart may be required)")

    if ( ! missing(patientId)) patientId <- jmvcore::resolveQuo(jmvcore::enquo(patientId))
    if ( ! missing(timeVar)) timeVar <- jmvcore::resolveQuo(jmvcore::enquo(timeVar))
    if ( ! missing(outcomeVars)) outcomeVars <- jmvcore::resolveQuo(jmvcore::enquo(outcomeVars))
    if ( ! missing(groupVar)) groupVar <- jmvcore::resolveQuo(jmvcore::enquo(groupVar))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(patientId), patientId, NULL),
            `if`( ! missing(timeVar), timeVar, NULL),
            `if`( ! missing(outcomeVars), outcomeVars, NULL),
            `if`( ! missing(groupVar), groupVar, NULL))

    for (v in groupVar) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- clinicaldashboardOptions$new(
        patientId = patientId,
        timeVar = timeVar,
        outcomeVars = outcomeVars,
        groupVar = groupVar,
        dashboardType = dashboardType,
        timeWindow = timeWindow,
        showTrends = showTrends,
        showAlerts = showAlerts,
        alertThresholds = alertThresholds,
        showSummaryStats = showSummaryStats,
        showDistributions = showDistributions,
        realTimeUpdate = realTimeUpdate,
        exportDashboard = exportDashboard)

    analysis <- clinicaldashboardClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

