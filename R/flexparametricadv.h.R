
# This file is automatically generated, you probably don't want to edit this

flexparametricadvOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "flexparametricadvOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            status = NULL,
            covariates = NULL,
            group = NULL,
            model_type = "royston_parmar",
            spline_function = "log_hazard",
            spline_df = 3,
            knot_placement = "quantiles",
            custom_knots = NULL,
            boundary_knots = "automatic",
            time_ratio = FALSE,
            relative_survival = FALSE,
            expected_rates = NULL,
            prediction_times = "1, 2, 5, 10",
            extrapolation_time = 20,
            confidence_level = 0.95,
            model_comparison = TRUE,
            goodness_of_fit = TRUE,
            hazard_analysis = TRUE,
            derivative_analysis = FALSE,
            bootstrap_validation = FALSE,
            bootstrap_samples = 500, ...) {

            super$initialize(
                package="ClinicoPath",
                name="flexparametricadv",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..status <- jmvcore::OptionVariable$new(
                "status",
                status,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..group <- jmvcore::OptionVariable$new(
                "group",
                group,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..model_type <- jmvcore::OptionList$new(
                "model_type",
                model_type,
                options=list(
                    "royston_parmar",
                    "restricted_cubic",
                    "natural_splines",
                    "b_splines",
                    "transformation_model"),
                default="royston_parmar")
            private$..spline_function <- jmvcore::OptionList$new(
                "spline_function",
                spline_function,
                options=list(
                    "log_hazard",
                    "log_odds",
                    "probit",
                    "log_survival"),
                default="log_hazard")
            private$..spline_df <- jmvcore::OptionInteger$new(
                "spline_df",
                spline_df,
                min=1,
                max=10,
                default=3)
            private$..knot_placement <- jmvcore::OptionList$new(
                "knot_placement",
                knot_placement,
                options=list(
                    "quantiles",
                    "equal_time",
                    "automatic",
                    "custom"),
                default="quantiles")
            private$..custom_knots <- jmvcore::OptionString$new(
                "custom_knots",
                custom_knots)
            private$..boundary_knots <- jmvcore::OptionList$new(
                "boundary_knots",
                boundary_knots,
                options=list(
                    "automatic",
                    "percentiles",
                    "custom"),
                default="automatic")
            private$..time_ratio <- jmvcore::OptionBool$new(
                "time_ratio",
                time_ratio,
                default=FALSE)
            private$..relative_survival <- jmvcore::OptionBool$new(
                "relative_survival",
                relative_survival,
                default=FALSE)
            private$..expected_rates <- jmvcore::OptionVariable$new(
                "expected_rates",
                expected_rates,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..prediction_times <- jmvcore::OptionString$new(
                "prediction_times",
                prediction_times,
                default="1, 2, 5, 10")
            private$..extrapolation_time <- jmvcore::OptionNumber$new(
                "extrapolation_time",
                extrapolation_time,
                min=0,
                default=20)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.8,
                max=0.99,
                default=0.95)
            private$..model_comparison <- jmvcore::OptionBool$new(
                "model_comparison",
                model_comparison,
                default=TRUE)
            private$..goodness_of_fit <- jmvcore::OptionBool$new(
                "goodness_of_fit",
                goodness_of_fit,
                default=TRUE)
            private$..hazard_analysis <- jmvcore::OptionBool$new(
                "hazard_analysis",
                hazard_analysis,
                default=TRUE)
            private$..derivative_analysis <- jmvcore::OptionBool$new(
                "derivative_analysis",
                derivative_analysis,
                default=FALSE)
            private$..bootstrap_validation <- jmvcore::OptionBool$new(
                "bootstrap_validation",
                bootstrap_validation,
                default=FALSE)
            private$..bootstrap_samples <- jmvcore::OptionInteger$new(
                "bootstrap_samples",
                bootstrap_samples,
                min=100,
                max=2000,
                default=500)

            self$.addOption(private$..time)
            self$.addOption(private$..status)
            self$.addOption(private$..covariates)
            self$.addOption(private$..group)
            self$.addOption(private$..model_type)
            self$.addOption(private$..spline_function)
            self$.addOption(private$..spline_df)
            self$.addOption(private$..knot_placement)
            self$.addOption(private$..custom_knots)
            self$.addOption(private$..boundary_knots)
            self$.addOption(private$..time_ratio)
            self$.addOption(private$..relative_survival)
            self$.addOption(private$..expected_rates)
            self$.addOption(private$..prediction_times)
            self$.addOption(private$..extrapolation_time)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..model_comparison)
            self$.addOption(private$..goodness_of_fit)
            self$.addOption(private$..hazard_analysis)
            self$.addOption(private$..derivative_analysis)
            self$.addOption(private$..bootstrap_validation)
            self$.addOption(private$..bootstrap_samples)
        }),
    active = list(
        time = function() private$..time$value,
        status = function() private$..status$value,
        covariates = function() private$..covariates$value,
        group = function() private$..group$value,
        model_type = function() private$..model_type$value,
        spline_function = function() private$..spline_function$value,
        spline_df = function() private$..spline_df$value,
        knot_placement = function() private$..knot_placement$value,
        custom_knots = function() private$..custom_knots$value,
        boundary_knots = function() private$..boundary_knots$value,
        time_ratio = function() private$..time_ratio$value,
        relative_survival = function() private$..relative_survival$value,
        expected_rates = function() private$..expected_rates$value,
        prediction_times = function() private$..prediction_times$value,
        extrapolation_time = function() private$..extrapolation_time$value,
        confidence_level = function() private$..confidence_level$value,
        model_comparison = function() private$..model_comparison$value,
        goodness_of_fit = function() private$..goodness_of_fit$value,
        hazard_analysis = function() private$..hazard_analysis$value,
        derivative_analysis = function() private$..derivative_analysis$value,
        bootstrap_validation = function() private$..bootstrap_validation$value,
        bootstrap_samples = function() private$..bootstrap_samples$value),
    private = list(
        ..time = NA,
        ..status = NA,
        ..covariates = NA,
        ..group = NA,
        ..model_type = NA,
        ..spline_function = NA,
        ..spline_df = NA,
        ..knot_placement = NA,
        ..custom_knots = NA,
        ..boundary_knots = NA,
        ..time_ratio = NA,
        ..relative_survival = NA,
        ..expected_rates = NA,
        ..prediction_times = NA,
        ..extrapolation_time = NA,
        ..confidence_level = NA,
        ..model_comparison = NA,
        ..goodness_of_fit = NA,
        ..hazard_analysis = NA,
        ..derivative_analysis = NA,
        ..bootstrap_validation = NA,
        ..bootstrap_samples = NA)
)

flexparametricadvResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "flexparametricadvResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        modelSummary = function() private$.items[["modelSummary"]],
        parameterEstimates = function() private$.items[["parameterEstimates"]],
        splineBasisSummary = function() private$.items[["splineBasisSummary"]],
        survivalPredictions = function() private$.items[["survivalPredictions"]],
        timeRatioAnalysis = function() private$.items[["timeRatioAnalysis"]],
        relativeSurvivalAnalysis = function() private$.items[["relativeSurvivalAnalysis"]],
        modelComparison = function() private$.items[["modelComparison"]],
        goodnessOfFitTests = function() private$.items[["goodnessOfFitTests"]],
        hazardAnalysis = function() private$.items[["hazardAnalysis"]],
        derivativeAnalysis = function() private$.items[["derivativeAnalysis"]],
        bootstrapValidation = function() private$.items[["bootstrapValidation"]],
        flexibleSurvivalPlot = function() private$.items[["flexibleSurvivalPlot"]],
        hazardFunctionPlot = function() private$.items[["hazardFunctionPlot"]],
        splineBasisPlot = function() private$.items[["splineBasisPlot"]],
        residualPlots = function() private$.items[["residualPlots"]],
        modelComparisonPlot = function() private$.items[["modelComparisonPlot"]],
        derivativePlot = function() private$.items[["derivativePlot"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Advanced Flexible Parametric Survival Models",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Analysis Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                visible=TRUE,
                rows=1,
                clearWith=list(
                    "time",
                    "status",
                    "model_type",
                    "spline_df"),
                columns=list(
                    list(
                        `name`="characteristic", 
                        `title`="Characteristic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="parameterEstimates",
                title="Parameter Estimates",
                visible=TRUE,
                rows=1,
                clearWith=list(
                    "covariates",
                    "model_type",
                    "spline_df"),
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="standard_error", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="confidence_interval", 
                        `title`="Confidence Interval", 
                        `type`="text"),
                    list(
                        `name`="z_value", 
                        `title`="z-value", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="interpretation", 
                        `title`="Clinical Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="splineBasisSummary",
                title="Spline Basis Summary",
                visible=TRUE,
                rows=1,
                clearWith=list(
                    "spline_df",
                    "knot_placement",
                    "model_type"),
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"),
                    list(
                        `name`="description", 
                        `title`="Description", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="survivalPredictions",
                title="Survival Predictions",
                visible=TRUE,
                rows=1,
                clearWith=list(
                    "prediction_times",
                    "model_type"),
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="survival_probability", 
                        `title`="Survival Probability", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="confidence_interval", 
                        `title`="Confidence Interval", 
                        `type`="text"),
                    list(
                        `name`="hazard_rate", 
                        `title`="Hazard Rate", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="hazard_ratio", 
                        `title`="Hazard Ratio", 
                        `type`="number", 
                        `format`="zto:4", 
                        `visible`="(covariates)"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="timeRatioAnalysis",
                title="Time Ratio Analysis",
                visible="(time_ratio)",
                rows=1,
                clearWith=list(
                    "time_ratio",
                    "covariates"),
                columns=list(
                    list(
                        `name`="covariate", 
                        `title`="Covariate", 
                        `type`="text"),
                    list(
                        `name`="time_ratio", 
                        `title`="Time Ratio", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="confidence_interval", 
                        `title`="Confidence Interval", 
                        `type`="text"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="relativeSurvivalAnalysis",
                title="Relative Survival Analysis",
                visible="(relative_survival)",
                rows=1,
                clearWith=list(
                    "relative_survival",
                    "expected_rates"),
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="observed_survival", 
                        `title`="Observed Survival", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="expected_survival", 
                        `title`="Expected Survival", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="relative_survival", 
                        `title`="Relative Survival", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="excess_mortality", 
                        `title`="Excess Mortality Rate", 
                        `type`="number", 
                        `format`="zto:4"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelComparison",
                title="Model Comparison",
                visible="(model_comparison)",
                rows=1,
                clearWith=list(
                    "model_comparison",
                    "spline_df"),
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="parameters", 
                        `title`="Parameters", 
                        `type`="integer"),
                    list(
                        `name`="log_likelihood", 
                        `title`="Log-Likelihood", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="likelihood_ratio_test", 
                        `title`="LR Test p-value", 
                        `type`="number", 
                        `format`="zto:4"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="goodnessOfFitTests",
                title="Goodness of Fit Tests",
                visible="(goodness_of_fit)",
                rows=1,
                clearWith=list(
                    "goodness_of_fit",
                    "model_type"),
                columns=list(
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Test Statistic", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="conclusion", 
                        `title`="Conclusion", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="hazardAnalysis",
                title="Hazard Function Analysis",
                visible="(hazard_analysis)",
                rows=1,
                clearWith=list(
                    "hazard_analysis",
                    "prediction_times"),
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="hazard_rate", 
                        `title`="Hazard Rate", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="hazard_confidence_interval", 
                        `title`="Hazard CI", 
                        `type`="text"),
                    list(
                        `name`="hazard_pattern", 
                        `title`="Hazard Pattern", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="derivativeAnalysis",
                title="Hazard Derivative Analysis",
                visible="(derivative_analysis)",
                rows=1,
                clearWith=list(
                    "derivative_analysis",
                    "prediction_times"),
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="first_derivative", 
                        `title`="First Derivative", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="second_derivative", 
                        `title`="Second Derivative", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="acceleration_pattern", 
                        `title`="Acceleration Pattern", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="bootstrapValidation",
                title="Bootstrap Validation Results",
                visible="(bootstrap_validation)",
                rows=1,
                clearWith=list(
                    "bootstrap_validation",
                    "bootstrap_samples"),
                columns=list(
                    list(
                        `name`="validation_metric", 
                        `title`="Validation Metric", 
                        `type`="text"),
                    list(
                        `name`="original_estimate", 
                        `title`="Original", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="bootstrap_mean", 
                        `title`="Bootstrap Mean", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="bootstrap_se", 
                        `title`="Bootstrap SE", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="bias", 
                        `title`="Bias", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="percentile_ci", 
                        `title`="Percentile CI", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="flexibleSurvivalPlot",
                title="Flexible Survival Curves",
                visible=TRUE,
                requiresData=TRUE,
                width=900,
                height=600,
                renderFun=".plotFlexibleSurvival",
                clearWith=list(
                    "time",
                    "status",
                    "model_type",
                    "spline_df")))
            self$add(jmvcore::Image$new(
                options=options,
                name="hazardFunctionPlot",
                title="Hazard Function Plot",
                visible="(hazard_analysis)",
                requiresData=TRUE,
                width=800,
                height=600,
                renderFun=".plotHazardFunction",
                clearWith=list(
                    "hazard_analysis",
                    "model_type",
                    "spline_df")))
            self$add(jmvcore::Image$new(
                options=options,
                name="splineBasisPlot",
                title="Spline Basis Functions Plot",
                visible=TRUE,
                requiresData=TRUE,
                width=800,
                height=600,
                renderFun=".plotSplineBasis",
                clearWith=list(
                    "spline_df",
                    "knot_placement",
                    "model_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="residualPlots",
                title="Model Residuals Plot",
                visible="(goodness_of_fit)",
                requiresData=TRUE,
                width=900,
                height=700,
                renderFun=".plotResiduals",
                clearWith=list(
                    "goodness_of_fit",
                    "model_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="modelComparisonPlot",
                title="Model Comparison Plot",
                visible="(model_comparison)",
                requiresData=TRUE,
                width=800,
                height=600,
                renderFun=".plotModelComparison",
                clearWith=list(
                    "model_comparison",
                    "spline_df")))
            self$add(jmvcore::Image$new(
                options=options,
                name="derivativePlot",
                title="Hazard Derivative Plot",
                visible="(derivative_analysis)",
                requiresData=TRUE,
                width=800,
                height=600,
                renderFun=".plotDerivatives",
                clearWith=list(
                    "derivative_analysis",
                    "model_type")))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Method and Clinical Interpretation",
                visible=TRUE))}))

flexparametricadvBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "flexparametricadvBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "flexparametricadv",
                version = c(1,0,0),
                options = options,
                results = flexparametricadvResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Advanced Flexible Parametric Survival Models
#'
#' Advanced flexible parametric survival models using Royston-Parmar 
#' framework,  spline-based hazard and survival functions, and transformation 
#' models.  Provides smooth survival curves with clinical interpretability and 
#' extrapolation capabilities.
#' 
#'
#' @examples
#' data \%>\%
#' flexparametricadv(
#'     time = "time_variable",
#'     status = "status_variable",
#'     covariates = c("age", "treatment"),
#'     spline_df = 3,
#'     model_type = "royston_parmar"
#' )
#'
#' @param data the data as a data frame
#' @param time Time-to-event or follow-up time variable (numeric)
#' @param status Event indicator variable (1/TRUE = event occurred, 0/FALSE =
#'   censored)
#' @param covariates Optional covariates for covariate-adjusted flexible
#'   parametric models
#' @param group Optional grouping variable for stratified analysis
#' @param model_type Type of flexible parametric model to fit
#' @param spline_function Function to be modeled with splines (scale
#'   parameter)
#' @param spline_df Degrees of freedom for spline basis functions
#' @param knot_placement Method for placing internal knots
#' @param custom_knots Comma-separated list of custom knot positions (when
#'   custom knot placement selected)
#' @param boundary_knots Boundary knot placement method
#' @param time_ratio Include time ratio (acceleration factor) analysis
#' @param relative_survival Perform relative survival analysis (requires
#'   expected survival rates)
#' @param expected_rates Variable containing expected survival rates for
#'   relative survival analysis
#' @param prediction_times Comma-separated list of time points for survival
#'   predictions
#' @param extrapolation_time Maximum time for survival curve extrapolation
#' @param confidence_level Confidence level for confidence intervals
#' @param model_comparison Compare flexible parametric models with standard
#'   parametric models
#' @param goodness_of_fit Perform goodness of fit tests and model diagnostics
#' @param hazard_analysis Generate hazard function estimates and plots
#' @param derivative_analysis Include analysis of hazard function derivatives
#'   (acceleration/deceleration)
#' @param bootstrap_validation Perform bootstrap validation of model
#'   predictions
#' @param bootstrap_samples Number of bootstrap samples for validation (when
#'   bootstrap enabled)
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$parameterEstimates} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$splineBasisSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$survivalPredictions} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$timeRatioAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$relativeSurvivalAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$goodnessOfFitTests} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$hazardAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$derivativeAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$bootstrapValidation} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$flexibleSurvivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$hazardFunctionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$splineBasisPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$residualPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$modelComparisonPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$derivativePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelSummary$asDF}
#'
#' \code{as.data.frame(results$modelSummary)}
#'
#' @export
flexparametricadv <- function(
    data,
    time,
    status,
    covariates,
    group,
    model_type = "royston_parmar",
    spline_function = "log_hazard",
    spline_df = 3,
    knot_placement = "quantiles",
    custom_knots,
    boundary_knots = "automatic",
    time_ratio = FALSE,
    relative_survival = FALSE,
    expected_rates,
    prediction_times = "1, 2, 5, 10",
    extrapolation_time = 20,
    confidence_level = 0.95,
    model_comparison = TRUE,
    goodness_of_fit = TRUE,
    hazard_analysis = TRUE,
    derivative_analysis = FALSE,
    bootstrap_validation = FALSE,
    bootstrap_samples = 500) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("flexparametricadv requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(status)) status <- jmvcore::resolveQuo(jmvcore::enquo(status))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(group)) group <- jmvcore::resolveQuo(jmvcore::enquo(group))
    if ( ! missing(expected_rates)) expected_rates <- jmvcore::resolveQuo(jmvcore::enquo(expected_rates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(status), status, NULL),
            `if`( ! missing(covariates), covariates, NULL),
            `if`( ! missing(group), group, NULL),
            `if`( ! missing(expected_rates), expected_rates, NULL))

    for (v in group) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- flexparametricadvOptions$new(
        time = time,
        status = status,
        covariates = covariates,
        group = group,
        model_type = model_type,
        spline_function = spline_function,
        spline_df = spline_df,
        knot_placement = knot_placement,
        custom_knots = custom_knots,
        boundary_knots = boundary_knots,
        time_ratio = time_ratio,
        relative_survival = relative_survival,
        expected_rates = expected_rates,
        prediction_times = prediction_times,
        extrapolation_time = extrapolation_time,
        confidence_level = confidence_level,
        model_comparison = model_comparison,
        goodness_of_fit = goodness_of_fit,
        hazard_analysis = hazard_analysis,
        derivative_analysis = derivative_analysis,
        bootstrap_validation = bootstrap_validation,
        bootstrap_samples = bootstrap_samples)

    analysis <- flexparametricadvClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

