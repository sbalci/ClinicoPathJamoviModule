
# This file is automatically generated, you probably don't want to edit this

ihcthresholdOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcthresholdOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            sampleArea = NULL,
            threshold = NULL,
            positiveCells = NULL,
            negativeCells = NULL,
            totalCells = NULL,
            stainType = "ki67",
            tissueType = "other",
            optimizationMethod = "cv",
            showSummaryTable = TRUE,
            showThresholdComparison = TRUE,
            showOptimalThreshold = TRUE,
            showPlot = TRUE,
            plotType = "line",
            showMethodology = TRUE,
            showReferences = FALSE,
            confidenceLevel = 0.95,
            minSampleAreas = 5, ...) {

            super$initialize(
                package="ClinicoPath",
                name="ihcthreshold",
                requiresData=TRUE,
                ...)

            private$..sampleArea <- jmvcore::OptionVariable$new(
                "sampleArea",
                sampleArea,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..threshold <- jmvcore::OptionVariable$new(
                "threshold",
                threshold,
                suggested=list(
                    "ordinal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..positiveCells <- jmvcore::OptionVariable$new(
                "positiveCells",
                positiveCells,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..negativeCells <- jmvcore::OptionVariable$new(
                "negativeCells",
                negativeCells,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..totalCells <- jmvcore::OptionVariable$new(
                "totalCells",
                totalCells,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..stainType <- jmvcore::OptionList$new(
                "stainType",
                stainType,
                options=list(
                    "ki67",
                    "her2",
                    "er",
                    "pr",
                    "pdl1",
                    "cd",
                    "custom"),
                default="ki67")
            private$..tissueType <- jmvcore::OptionList$new(
                "tissueType",
                tissueType,
                options=list(
                    "breast",
                    "lung",
                    "colon",
                    "prostate",
                    "other"),
                default="other")
            private$..optimizationMethod <- jmvcore::OptionList$new(
                "optimizationMethod",
                optimizationMethod,
                options=list(
                    "cv",
                    "variance",
                    "consistency"),
                default="cv")
            private$..showSummaryTable <- jmvcore::OptionBool$new(
                "showSummaryTable",
                showSummaryTable,
                default=TRUE)
            private$..showThresholdComparison <- jmvcore::OptionBool$new(
                "showThresholdComparison",
                showThresholdComparison,
                default=TRUE)
            private$..showOptimalThreshold <- jmvcore::OptionBool$new(
                "showOptimalThreshold",
                showOptimalThreshold,
                default=TRUE)
            private$..showPlot <- jmvcore::OptionBool$new(
                "showPlot",
                showPlot,
                default=TRUE)
            private$..plotType <- jmvcore::OptionList$new(
                "plotType",
                plotType,
                options=list(
                    "line",
                    "box",
                    "heatmap"),
                default="line")
            private$..showMethodology <- jmvcore::OptionBool$new(
                "showMethodology",
                showMethodology,
                default=TRUE)
            private$..showReferences <- jmvcore::OptionBool$new(
                "showReferences",
                showReferences,
                default=FALSE)
            private$..confidenceLevel <- jmvcore::OptionNumber$new(
                "confidenceLevel",
                confidenceLevel,
                min=0.8,
                max=0.99,
                default=0.95)
            private$..minSampleAreas <- jmvcore::OptionInteger$new(
                "minSampleAreas",
                minSampleAreas,
                min=3,
                max=20,
                default=5)

            self$.addOption(private$..sampleArea)
            self$.addOption(private$..threshold)
            self$.addOption(private$..positiveCells)
            self$.addOption(private$..negativeCells)
            self$.addOption(private$..totalCells)
            self$.addOption(private$..stainType)
            self$.addOption(private$..tissueType)
            self$.addOption(private$..optimizationMethod)
            self$.addOption(private$..showSummaryTable)
            self$.addOption(private$..showThresholdComparison)
            self$.addOption(private$..showOptimalThreshold)
            self$.addOption(private$..showPlot)
            self$.addOption(private$..plotType)
            self$.addOption(private$..showMethodology)
            self$.addOption(private$..showReferences)
            self$.addOption(private$..confidenceLevel)
            self$.addOption(private$..minSampleAreas)
        }),
    active = list(
        sampleArea = function() private$..sampleArea$value,
        threshold = function() private$..threshold$value,
        positiveCells = function() private$..positiveCells$value,
        negativeCells = function() private$..negativeCells$value,
        totalCells = function() private$..totalCells$value,
        stainType = function() private$..stainType$value,
        tissueType = function() private$..tissueType$value,
        optimizationMethod = function() private$..optimizationMethod$value,
        showSummaryTable = function() private$..showSummaryTable$value,
        showThresholdComparison = function() private$..showThresholdComparison$value,
        showOptimalThreshold = function() private$..showOptimalThreshold$value,
        showPlot = function() private$..showPlot$value,
        plotType = function() private$..plotType$value,
        showMethodology = function() private$..showMethodology$value,
        showReferences = function() private$..showReferences$value,
        confidenceLevel = function() private$..confidenceLevel$value,
        minSampleAreas = function() private$..minSampleAreas$value),
    private = list(
        ..sampleArea = NA,
        ..threshold = NA,
        ..positiveCells = NA,
        ..negativeCells = NA,
        ..totalCells = NA,
        ..stainType = NA,
        ..tissueType = NA,
        ..optimizationMethod = NA,
        ..showSummaryTable = NA,
        ..showThresholdComparison = NA,
        ..showOptimalThreshold = NA,
        ..showPlot = NA,
        ..plotType = NA,
        ..showMethodology = NA,
        ..showReferences = NA,
        ..confidenceLevel = NA,
        ..minSampleAreas = NA)
)

ihcthresholdResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcthresholdResults",
    inherit = jmvcore::Group,
    active = list(
        summaryTable = function() private$.items[["summaryTable"]],
        thresholdComparison = function() private$.items[["thresholdComparison"]],
        optimalThreshold = function() private$.items[["optimalThreshold"]],
        plot = function() private$.items[["plot"]],
        methodology = function() private$.items[["methodology"]],
        references = function() private$.items[["references"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="IHC Threshold Determination")
            self$add(jmvcore::Table$new(
                options=options,
                name="summaryTable",
                title="Summary Statistics",
                visible="(showSummaryTable)",
                rows=1,
                columns=list(
                    list(
                        `name`="n_areas", 
                        `title`="Sample Areas", 
                        `type`="integer"),
                    list(
                        `name`="n_thresholds", 
                        `title`="Thresholds Tested", 
                        `type`="integer"),
                    list(
                        `name`="total_cells_mean", 
                        `title`="Mean Cells/Area", 
                        `type`="number"),
                    list(
                        `name`="positive_range", 
                        `title`="Positive % Range", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="thresholdComparison",
                title="Threshold Comparison Table",
                visible="(showThresholdComparison)",
                rows=0,
                columns=list(
                    list(
                        `name`="threshold", 
                        `title`="Threshold", 
                        `type`="text"),
                    list(
                        `name`="mean_positive_ratio", 
                        `title`="Mean Positive %", 
                        `type`="number"),
                    list(
                        `name`="sd_positive_ratio", 
                        `title`="SD", 
                        `type`="number"),
                    list(
                        `name`="cv", 
                        `title`="CV", 
                        `type`="number"),
                    list(
                        `name`="min_ratio", 
                        `title`="Min %", 
                        `type`="number"),
                    list(
                        `name`="max_ratio", 
                        `title`="Max %", 
                        `type`="number"),
                    list(
                        `name`="consistency_score", 
                        `title`="Consistency", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="optimalThreshold",
                title="Optimal Threshold Analysis",
                visible="(showOptimalThreshold)",
                rows=1,
                columns=list(
                    list(
                        `name`="optimal_threshold", 
                        `title`="Recommended Threshold", 
                        `type`="text"),
                    list(
                        `name`="optimization_value", 
                        `title`="Optimization Value", 
                        `type`="number"),
                    list(
                        `name`="mean_positive_pct", 
                        `title`="Mean Positive %", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot",
                title="Threshold Analysis Plot",
                visible="(showPlot)",
                renderFun=".plot",
                requiresData=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodology",
                title="Methodology & Clinical Interpretation",
                visible="(showMethodology)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="references",
                title="References",
                visible="(showReferences)"))}))

ihcthresholdBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcthresholdBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "ihcthreshold",
                version = c(1,0,0),
                options = options,
                results = ihcthresholdResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' IHC Threshold Determination
#'
#' 
#' @param data .
#' @param sampleArea Identifier for each sample area examined (e.g., field1,
#'   field2, etc.). Multiple areas should be randomly selected across the
#'   tissue.
#' @param threshold Threshold level tested (e.g., 1, 2, 3 or actual intensity
#'   values like 100, 150, 200). Multiple thresholds should be tested to find
#'   optimal discrimination.
#' @param positiveCells Number of cells classified as positive at this
#'   threshold level.
#' @param negativeCells Number of cells classified as negative at this
#'   threshold level.
#' @param totalCells Total number of cells counted. If not provided,
#'   calculated as positive + negative.
#' @param stainType Type of immunohistochemical stain being analyzed.
#' @param tissueType .
#' @param optimizationMethod Method for selecting optimal threshold: - CV:
#'   Choose threshold with lowest coefficient of variation across samples -
#'   Variance: Choose threshold with minimum variance in positive ratio -
#'   Consistency: Choose threshold where positive/negative ratio is most
#'   consistent
#' @param showSummaryTable .
#' @param showThresholdComparison Compare positive ratios across thresholds
#'   and sample areas.
#' @param showOptimalThreshold Display detailed analysis of optimal threshold
#'   selection.
#' @param showPlot Visualize positive ratios across thresholds and sample
#'   areas.
#' @param plotType .
#' @param showMethodology .
#' @param showReferences .
#' @param confidenceLevel .
#' @param minSampleAreas Minimum number of sample areas needed for reliable
#'   threshold determination. Kayser et al. (2009) recommend at least 5 areas.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$summaryTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$thresholdComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$optimalThreshold} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$methodology} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$references} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summaryTable$asDF}
#'
#' \code{as.data.frame(results$summaryTable)}
#'
#' @export
ihcthreshold <- function(
    data,
    sampleArea,
    threshold,
    positiveCells,
    negativeCells,
    totalCells = NULL,
    stainType = "ki67",
    tissueType = "other",
    optimizationMethod = "cv",
    showSummaryTable = TRUE,
    showThresholdComparison = TRUE,
    showOptimalThreshold = TRUE,
    showPlot = TRUE,
    plotType = "line",
    showMethodology = TRUE,
    showReferences = FALSE,
    confidenceLevel = 0.95,
    minSampleAreas = 5) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("ihcthreshold requires jmvcore to be installed (restart may be required)")

    if ( ! missing(sampleArea)) sampleArea <- jmvcore::resolveQuo(jmvcore::enquo(sampleArea))
    if ( ! missing(threshold)) threshold <- jmvcore::resolveQuo(jmvcore::enquo(threshold))
    if ( ! missing(positiveCells)) positiveCells <- jmvcore::resolveQuo(jmvcore::enquo(positiveCells))
    if ( ! missing(negativeCells)) negativeCells <- jmvcore::resolveQuo(jmvcore::enquo(negativeCells))
    if ( ! missing(totalCells)) totalCells <- jmvcore::resolveQuo(jmvcore::enquo(totalCells))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(sampleArea), sampleArea, NULL),
            `if`( ! missing(threshold), threshold, NULL),
            `if`( ! missing(positiveCells), positiveCells, NULL),
            `if`( ! missing(negativeCells), negativeCells, NULL),
            `if`( ! missing(totalCells), totalCells, NULL))


    options <- ihcthresholdOptions$new(
        sampleArea = sampleArea,
        threshold = threshold,
        positiveCells = positiveCells,
        negativeCells = negativeCells,
        totalCells = totalCells,
        stainType = stainType,
        tissueType = tissueType,
        optimizationMethod = optimizationMethod,
        showSummaryTable = showSummaryTable,
        showThresholdComparison = showThresholdComparison,
        showOptimalThreshold = showOptimalThreshold,
        showPlot = showPlot,
        plotType = plotType,
        showMethodology = showMethodology,
        showReferences = showReferences,
        confidenceLevel = confidenceLevel,
        minSampleAreas = minSampleAreas)

    analysis <- ihcthresholdClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

