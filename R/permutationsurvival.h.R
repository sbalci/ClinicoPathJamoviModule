
# This file is automatically generated, you probably don't want to edit this

permutationsurvivalOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "permutationsurvivalOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            outcome = NULL,
            explanatory = NULL,
            outcomeLevel = "1",
            permutation_method = "approximate",
            n_permutations = 10000,
            test_statistic = "logrank",
            stratify_variable = NULL,
            confidence_level = 0.95,
            multiple_comparison = "holm",
            show_permutation_distribution = FALSE,
            show_survival_curves = TRUE,
            show_test_progression = FALSE,
            seed_value = 123,
            showSummaries = FALSE,
            showExplanations = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="permutationsurvival",
                requiresData=TRUE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..explanatory <- jmvcore::OptionVariable$new(
                "explanatory",
                explanatory,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..outcomeLevel <- jmvcore::OptionString$new(
                "outcomeLevel",
                outcomeLevel,
                default="1")
            private$..permutation_method <- jmvcore::OptionList$new(
                "permutation_method",
                permutation_method,
                options=list(
                    "exact",
                    "approximate",
                    "stratified"),
                default="approximate")
            private$..n_permutations <- jmvcore::OptionInteger$new(
                "n_permutations",
                n_permutations,
                min=100,
                max=100000,
                default=10000)
            private$..test_statistic <- jmvcore::OptionList$new(
                "test_statistic",
                test_statistic,
                options=list(
                    "logrank",
                    "wilcoxon",
                    "tarone_ware",
                    "max_deviation"),
                default="logrank")
            private$..stratify_variable <- jmvcore::OptionVariable$new(
                "stratify_variable",
                stratify_variable,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..multiple_comparison <- jmvcore::OptionList$new(
                "multiple_comparison",
                multiple_comparison,
                options=list(
                    "none",
                    "bonferroni",
                    "holm",
                    "hochberg",
                    "BH"),
                default="holm")
            private$..show_permutation_distribution <- jmvcore::OptionBool$new(
                "show_permutation_distribution",
                show_permutation_distribution,
                default=FALSE)
            private$..show_survival_curves <- jmvcore::OptionBool$new(
                "show_survival_curves",
                show_survival_curves,
                default=TRUE)
            private$..show_test_progression <- jmvcore::OptionBool$new(
                "show_test_progression",
                show_test_progression,
                default=FALSE)
            private$..seed_value <- jmvcore::OptionInteger$new(
                "seed_value",
                seed_value,
                min=1,
                max=1000000,
                default=123)
            private$..showSummaries <- jmvcore::OptionBool$new(
                "showSummaries",
                showSummaries,
                default=FALSE)
            private$..showExplanations <- jmvcore::OptionBool$new(
                "showExplanations",
                showExplanations,
                default=FALSE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..outcome)
            self$.addOption(private$..explanatory)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..permutation_method)
            self$.addOption(private$..n_permutations)
            self$.addOption(private$..test_statistic)
            self$.addOption(private$..stratify_variable)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..multiple_comparison)
            self$.addOption(private$..show_permutation_distribution)
            self$.addOption(private$..show_survival_curves)
            self$.addOption(private$..show_test_progression)
            self$.addOption(private$..seed_value)
            self$.addOption(private$..showSummaries)
            self$.addOption(private$..showExplanations)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        outcome = function() private$..outcome$value,
        explanatory = function() private$..explanatory$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        permutation_method = function() private$..permutation_method$value,
        n_permutations = function() private$..n_permutations$value,
        test_statistic = function() private$..test_statistic$value,
        stratify_variable = function() private$..stratify_variable$value,
        confidence_level = function() private$..confidence_level$value,
        multiple_comparison = function() private$..multiple_comparison$value,
        show_permutation_distribution = function() private$..show_permutation_distribution$value,
        show_survival_curves = function() private$..show_survival_curves$value,
        show_test_progression = function() private$..show_test_progression$value,
        seed_value = function() private$..seed_value$value,
        showSummaries = function() private$..showSummaries$value,
        showExplanations = function() private$..showExplanations$value),
    private = list(
        ..elapsedtime = NA,
        ..outcome = NA,
        ..explanatory = NA,
        ..outcomeLevel = NA,
        ..permutation_method = NA,
        ..n_permutations = NA,
        ..test_statistic = NA,
        ..stratify_variable = NA,
        ..confidence_level = NA,
        ..multiple_comparison = NA,
        ..show_permutation_distribution = NA,
        ..show_survival_curves = NA,
        ..show_test_progression = NA,
        ..seed_value = NA,
        ..showSummaries = NA,
        ..showExplanations = NA)
)

permutationsurvivalResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "permutationsurvivalResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        permutationTestsTable = function() private$.items[["permutationTestsTable"]],
        groupSummaryTable = function() private$.items[["groupSummaryTable"]],
        survivalPlot = function() private$.items[["survivalPlot"]],
        permutationDistributionPlot = function() private$.items[["permutationDistributionPlot"]],
        testProgressionPlot = function() private$.items[["testProgressionPlot"]],
        analysisSummary = function() private$.items[["analysisSummary"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Permutation Tests for Survival",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="permutationTestsTable",
                title="Permutation Test Results",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="test_statistic_name", 
                        `title`="Test Statistic", 
                        `type`="text"),
                    list(
                        `name`="observed_statistic", 
                        `title`="Observed", 
                        `type`="number"),
                    list(
                        `name`="n_permutations", 
                        `title`="N Permutations", 
                        `type`="integer"),
                    list(
                        `name`="p_value", 
                        `title`="p", 
                        `type`="number"),
                    list(
                        `name`="p_adjusted", 
                        `title`="Adjusted p", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="groupSummaryTable",
                title="Group Summary Statistics",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="median_survival", 
                        `title`="Median Survival", 
                        `type`="number"),
                    list(
                        `name`="median_ci_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="median_ci_upper", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlot",
                title="Survival Curves Comparison",
                visible="(show_survival_curves)",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="permutationDistributionPlot",
                title="Permutation Test Statistics Distribution",
                visible="(show_permutation_distribution)",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="testProgressionPlot",
                title="P-value Progression",
                visible="(show_test_progression)",
                requiresData=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="analysisSummary",
                title="Analysis Summary",
                visible="(showSummaries)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Methodology",
                visible="(showExplanations)"))}))

permutationsurvivalBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "permutationsurvivalBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "permutationsurvival",
                version = c(1,0,0),
                options = options,
                results = permutationsurvivalResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Permutation Tests for Survival
#'
#' Performs permutation-based tests for comparing survival distributions 
#' between groups. These tests provide non-parametric alternatives to 
#' traditional log-rank tests that do not rely on asymptotic theory, making 
#' them particularly suitable for small samples or when distributional 
#' assumptions are violated. Includes various permutation strategies and 
#' multiple comparison corrections for robust survival analysis.
#'
#' @examples
#' # Example usage will be added
#'
#' @param data The data as a data frame.
#' @param elapsedtime Time variable for survival analysis
#' @param outcome Event indicator variable
#' @param explanatory Grouping variable for comparison
#' @param outcomeLevel Level of the outcome variable that represents the event
#'   of interest.
#' @param permutation_method Method for generating permutations of group
#'   assignments.
#' @param n_permutations Number of permutations to generate for approximate
#'   tests.
#' @param test_statistic Test statistic to use for permutation testing.
#' @param stratify_variable Optional stratification variable for stratified
#'   permutation tests.
#' @param confidence_level Confidence level for all confidence intervals.
#' @param multiple_comparison Method for adjusting p-values for multiple
#'   comparisons.
#' @param show_permutation_distribution Display histogram of permutation test
#'   statistics.
#' @param show_survival_curves Display Kaplan-Meier survival curves for
#'   comparison groups.
#' @param show_test_progression Display progression of p-values as
#'   permutations accumulate.
#' @param seed_value Random seed for reproducible permutation results.
#' @param showSummaries Generate natural language summary of results.
#' @param showExplanations Show detailed methodology explanations.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$permutationTestsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$groupSummaryTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$survivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$permutationDistributionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$testProgressionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$analysisSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$permutationTestsTable$asDF}
#'
#' \code{as.data.frame(results$permutationTestsTable)}
#'
#' @export
permutationsurvival <- function(
    data,
    elapsedtime,
    outcome,
    explanatory,
    outcomeLevel = "1",
    permutation_method = "approximate",
    n_permutations = 10000,
    test_statistic = "logrank",
    stratify_variable,
    confidence_level = 0.95,
    multiple_comparison = "holm",
    show_permutation_distribution = FALSE,
    show_survival_curves = TRUE,
    show_test_progression = FALSE,
    seed_value = 123,
    showSummaries = FALSE,
    showExplanations = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("permutationsurvival requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(explanatory)) explanatory <- jmvcore::resolveQuo(jmvcore::enquo(explanatory))
    if ( ! missing(stratify_variable)) stratify_variable <- jmvcore::resolveQuo(jmvcore::enquo(stratify_variable))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(elapsedtime), elapsedtime, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(explanatory), explanatory, NULL),
            `if`( ! missing(stratify_variable), stratify_variable, NULL))


    options <- permutationsurvivalOptions$new(
        elapsedtime = elapsedtime,
        outcome = outcome,
        explanatory = explanatory,
        outcomeLevel = outcomeLevel,
        permutation_method = permutation_method,
        n_permutations = n_permutations,
        test_statistic = test_statistic,
        stratify_variable = stratify_variable,
        confidence_level = confidence_level,
        multiple_comparison = multiple_comparison,
        show_permutation_distribution = show_permutation_distribution,
        show_survival_curves = show_survival_curves,
        show_test_progression = show_test_progression,
        seed_value = seed_value,
        showSummaries = showSummaries,
        showExplanations = showExplanations)

    analysis <- permutationsurvivalClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

