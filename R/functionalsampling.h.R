
# This file is automatically generated, you probably don't want to edit this

functionalsamplingOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "functionalsamplingOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            x_coord = NULL,
            y_coord = NULL,
            event_type = NULL,
            rare_event = "Rare",
            frequency_threshold = 5,
            calculate_nnd = TRUE,
            test_randomness = TRUE,
            analyze_neighborhoods = TRUE,
            show_summary = TRUE,
            show_plot = TRUE,
            show_methodology = TRUE,
            show_references = FALSE,
            significance_level = 0.05, ...) {

            super$initialize(
                package="ClinicoPath",
                name="functionalsampling",
                requiresData=TRUE,
                ...)

            private$..x_coord <- jmvcore::OptionVariable$new(
                "x_coord",
                x_coord,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..y_coord <- jmvcore::OptionVariable$new(
                "y_coord",
                y_coord,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event_type <- jmvcore::OptionVariable$new(
                "event_type",
                event_type,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..rare_event <- jmvcore::OptionString$new(
                "rare_event",
                rare_event,
                default="Rare")
            private$..frequency_threshold <- jmvcore::OptionNumber$new(
                "frequency_threshold",
                frequency_threshold,
                min=0.1,
                max=50,
                default=5)
            private$..calculate_nnd <- jmvcore::OptionBool$new(
                "calculate_nnd",
                calculate_nnd,
                default=TRUE)
            private$..test_randomness <- jmvcore::OptionBool$new(
                "test_randomness",
                test_randomness,
                default=TRUE)
            private$..analyze_neighborhoods <- jmvcore::OptionBool$new(
                "analyze_neighborhoods",
                analyze_neighborhoods,
                default=TRUE)
            private$..show_summary <- jmvcore::OptionBool$new(
                "show_summary",
                show_summary,
                default=TRUE)
            private$..show_plot <- jmvcore::OptionBool$new(
                "show_plot",
                show_plot,
                default=TRUE)
            private$..show_methodology <- jmvcore::OptionBool$new(
                "show_methodology",
                show_methodology,
                default=TRUE)
            private$..show_references <- jmvcore::OptionBool$new(
                "show_references",
                show_references,
                default=FALSE)
            private$..significance_level <- jmvcore::OptionNumber$new(
                "significance_level",
                significance_level,
                min=0.01,
                max=0.1,
                default=0.05)

            self$.addOption(private$..x_coord)
            self$.addOption(private$..y_coord)
            self$.addOption(private$..event_type)
            self$.addOption(private$..rare_event)
            self$.addOption(private$..frequency_threshold)
            self$.addOption(private$..calculate_nnd)
            self$.addOption(private$..test_randomness)
            self$.addOption(private$..analyze_neighborhoods)
            self$.addOption(private$..show_summary)
            self$.addOption(private$..show_plot)
            self$.addOption(private$..show_methodology)
            self$.addOption(private$..show_references)
            self$.addOption(private$..significance_level)
        }),
    active = list(
        x_coord = function() private$..x_coord$value,
        y_coord = function() private$..y_coord$value,
        event_type = function() private$..event_type$value,
        rare_event = function() private$..rare_event$value,
        frequency_threshold = function() private$..frequency_threshold$value,
        calculate_nnd = function() private$..calculate_nnd$value,
        test_randomness = function() private$..test_randomness$value,
        analyze_neighborhoods = function() private$..analyze_neighborhoods$value,
        show_summary = function() private$..show_summary$value,
        show_plot = function() private$..show_plot$value,
        show_methodology = function() private$..show_methodology$value,
        show_references = function() private$..show_references$value,
        significance_level = function() private$..significance_level$value),
    private = list(
        ..x_coord = NA,
        ..y_coord = NA,
        ..event_type = NA,
        ..rare_event = NA,
        ..frequency_threshold = NA,
        ..calculate_nnd = NA,
        ..test_randomness = NA,
        ..analyze_neighborhoods = NA,
        ..show_summary = NA,
        ..show_plot = NA,
        ..show_methodology = NA,
        ..show_references = NA,
        ..significance_level = NA)
)

functionalsamplingResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "functionalsamplingResults",
    inherit = jmvcore::Group,
    active = list(
        summary = function() private$.items[["summary"]],
        nnd_table = function() private$.items[["nnd_table"]],
        randomness_test = function() private$.items[["randomness_test"]],
        functional_assessment = function() private$.items[["functional_assessment"]],
        plot = function() private$.items[["plot"]],
        methodology = function() private$.items[["methodology"]],
        references = function() private$.items[["references"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Functional Sampling - Rare Event Analysis")
            self$add(jmvcore::Table$new(
                options=options,
                name="summary",
                title="Rare Event Summary",
                visible="(show_summary)",
                rows=1,
                columns=list(
                    list(
                        `name`="total_events", 
                        `title`="Total Events", 
                        `type`="integer"),
                    list(
                        `name`="rare_events", 
                        `title`="Rare Events (N)", 
                        `type`="integer"),
                    list(
                        `name`="rare_frequency", 
                        `title`="Frequency (%)", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Classification", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="nnd_table",
                title="Nearest Neighbor Distance Analysis",
                visible="(calculate_nnd)",
                rows=1,
                columns=list(
                    list(
                        `name`="mean_nnd", 
                        `title`="Mean NND", 
                        `type`="number"),
                    list(
                        `name`="sd_nnd", 
                        `title`="SD", 
                        `type`="number"),
                    list(
                        `name`="cv_nnd", 
                        `title`="CV (%)", 
                        `type`="number"),
                    list(
                        `name`="consistency", 
                        `title`="Consistency", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="randomness_test",
                title="Spatial Randomness Test (Clark-Evans)",
                visible="(test_randomness)",
                rows=1,
                columns=list(
                    list(
                        `name`="R", 
                        `title`="R Statistic", 
                        `type`="number"),
                    list(
                        `name`="expected_R", 
                        `title`="Expected R", 
                        `type`="number"),
                    list(
                        `name`="z_score", 
                        `title`="Z Score", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="pattern", 
                        `title`="Spatial Pattern", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="functional_assessment",
                title="Functional/\"Catalyst\" Cell Assessment",
                visible="(analyze_neighborhoods)",
                rows=1,
                columns=list(
                    list(
                        `name`="criterion_1", 
                        `title`="Rarity (<5%)", 
                        `type`="text"),
                    list(
                        `name`="criterion_2", 
                        `title`="Random Distribution", 
                        `type`="text"),
                    list(
                        `name`="criterion_3", 
                        `title`="Regular Neighborhoods", 
                        `type`="text"),
                    list(
                        `name`="conclusion", 
                        `title`="Conclusion", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot",
                title="Spatial Distribution Plot",
                visible="(show_plot)",
                renderFun=".plot",
                requiresData=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodology",
                title="Methodology",
                visible="(show_methodology)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="references",
                title="References",
                visible="(show_references)"))}))

functionalsamplingBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "functionalsamplingBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "functionalsampling",
                version = c(1,0,0),
                options = options,
                results = functionalsamplingResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Functional Sampling - Rare Event Analysis
#'
#' 
#' @param data .
#' @param x_coord X spatial coordinate of events/cells.
#' @param y_coord Y spatial coordinate of events/cells.
#' @param event_type Type of event or cell. Used to identify rare events vs
#'   majority population.
#' @param rare_event Label identifying the rare event/cell type in the
#'   event_type variable.
#' @param frequency_threshold Maximum frequency to consider an event as "rare"
#'   (default 5\%).
#' @param calculate_nnd Calculate distances between each rare event and its
#'   nearest neighbor.
#' @param test_randomness Test if rare events are randomly distributed
#'   (Clark-Evans test).
#' @param analyze_neighborhoods Test if rare events have consistent distances
#'   to neighboring cells (catalyst function indicator).
#' @param show_summary .
#' @param show_plot .
#' @param show_methodology .
#' @param show_references .
#' @param significance_level .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$nnd_table} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$randomness_test} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$functional_assessment} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$methodology} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$references} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summary$asDF}
#'
#' \code{as.data.frame(results$summary)}
#'
#' @export
functionalsampling <- function(
    data,
    x_coord,
    y_coord,
    event_type,
    rare_event = "Rare",
    frequency_threshold = 5,
    calculate_nnd = TRUE,
    test_randomness = TRUE,
    analyze_neighborhoods = TRUE,
    show_summary = TRUE,
    show_plot = TRUE,
    show_methodology = TRUE,
    show_references = FALSE,
    significance_level = 0.05) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("functionalsampling requires jmvcore to be installed (restart may be required)")

    if ( ! missing(x_coord)) x_coord <- jmvcore::resolveQuo(jmvcore::enquo(x_coord))
    if ( ! missing(y_coord)) y_coord <- jmvcore::resolveQuo(jmvcore::enquo(y_coord))
    if ( ! missing(event_type)) event_type <- jmvcore::resolveQuo(jmvcore::enquo(event_type))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(x_coord), x_coord, NULL),
            `if`( ! missing(y_coord), y_coord, NULL),
            `if`( ! missing(event_type), event_type, NULL))

    for (v in event_type) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- functionalsamplingOptions$new(
        x_coord = x_coord,
        y_coord = y_coord,
        event_type = event_type,
        rare_event = rare_event,
        frequency_threshold = frequency_threshold,
        calculate_nnd = calculate_nnd,
        test_randomness = test_randomness,
        analyze_neighborhoods = analyze_neighborhoods,
        show_summary = show_summary,
        show_plot = show_plot,
        show_methodology = show_methodology,
        show_references = show_references,
        significance_level = significance_level)

    analysis <- functionalsamplingClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

