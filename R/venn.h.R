
# This file is automatically generated, you probably don't want to edit this

vennOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "vennOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            var1 = NULL,
            var1true = NULL,
            var2 = NULL,
            var2true = NULL,
            var3 = NULL,
            var3true = NULL,
            var4 = NULL,
            var4true = NULL,
            upsetType = "upsetR",
            sortBy = "freq",
            minSize = 0,
            showAnnotations = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="venn",
                requiresData=TRUE,
                ...)

            private$..var1 <- jmvcore::OptionVariable$new(
                "var1",
                var1,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..var1true <- jmvcore::OptionLevel$new(
                "var1true",
                var1true,
                variable="(var1)")
            private$..var2 <- jmvcore::OptionVariable$new(
                "var2",
                var2,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..var2true <- jmvcore::OptionLevel$new(
                "var2true",
                var2true,
                variable="(var2)")
            private$..var3 <- jmvcore::OptionVariable$new(
                "var3",
                var3,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..var3true <- jmvcore::OptionLevel$new(
                "var3true",
                var3true,
                variable="(var3)")
            private$..var4 <- jmvcore::OptionVariable$new(
                "var4",
                var4,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..var4true <- jmvcore::OptionLevel$new(
                "var4true",
                var4true,
                variable="(var4)")
            private$..upsetType <- jmvcore::OptionList$new(
                "upsetType",
                upsetType,
                options=list(
                    "upsetR",
                    "complexUpset"),
                default="upsetR")
            private$..sortBy <- jmvcore::OptionList$new(
                "sortBy",
                sortBy,
                options=list(
                    "freq",
                    "degree",
                    "none"),
                default="freq")
            private$..minSize <- jmvcore::OptionInteger$new(
                "minSize",
                minSize,
                min=0,
                default=0)
            private$..showAnnotations <- jmvcore::OptionBool$new(
                "showAnnotations",
                showAnnotations,
                default=FALSE)

            self$.addOption(private$..var1)
            self$.addOption(private$..var1true)
            self$.addOption(private$..var2)
            self$.addOption(private$..var2true)
            self$.addOption(private$..var3)
            self$.addOption(private$..var3true)
            self$.addOption(private$..var4)
            self$.addOption(private$..var4true)
            self$.addOption(private$..upsetType)
            self$.addOption(private$..sortBy)
            self$.addOption(private$..minSize)
            self$.addOption(private$..showAnnotations)
        }),
    active = list(
        var1 = function() private$..var1$value,
        var1true = function() private$..var1true$value,
        var2 = function() private$..var2$value,
        var2true = function() private$..var2true$value,
        var3 = function() private$..var3$value,
        var3true = function() private$..var3true$value,
        var4 = function() private$..var4$value,
        var4true = function() private$..var4true$value,
        upsetType = function() private$..upsetType$value,
        sortBy = function() private$..sortBy$value,
        minSize = function() private$..minSize$value,
        showAnnotations = function() private$..showAnnotations$value),
    private = list(
        ..var1 = NA,
        ..var1true = NA,
        ..var2 = NA,
        ..var2true = NA,
        ..var3 = NA,
        ..var3true = NA,
        ..var4 = NA,
        ..var4true = NA,
        ..upsetType = NA,
        ..sortBy = NA,
        ..minSize = NA,
        ..showAnnotations = NA)
)

vennResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "vennResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        summary = function() private$.items[["summary"]],
        plot = function() private$.items[["plot"]],
        plot2 = function() private$.items[["plot2"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Venn Diagram",
                refs=list(
                    "ClinicoPathJamoviModule"),
                clearWith=list(
                    "var1",
                    "var2",
                    "var3",
                    "var4",
                    "var1true",
                    "var2true",
                    "var3true",
                    "var4true"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="To Do"))
            self$add(jmvcore::Table$new(
                options=options,
                title="Summary of True Counts",
                name="summary",
                rows=0,
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="trueCount", 
                        `title`="True Count", 
                        `type`="integer"),
                    list(
                        `name`="falseCount", 
                        `title`="False Count", 
                        `type`="integer"),
                    list(
                        `name`="totalCount", 
                        `title`="Total Count", 
                        `type`="integer"),
                    list(
                        `name`="truePercentage", 
                        `title`="True %", 
                        `type`="number", 
                        `format`="pc"))))
            self$add(jmvcore::Image$new(
                options=options,
                title="Venn Diagram",
                name="plot",
                width=700,
                height=450,
                renderFun=".plot",
                requiresData=TRUE,
                refs=list(
                    "venn")))
            self$add(jmvcore::Image$new(
                options=options,
                title="Upset Diagram",
                name="plot2",
                width=700,
                height=450,
                renderFun=".plot2",
                requiresData=TRUE,
                refs=list(
                    "upset")))}))

vennBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "vennBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "venn",
                version = c(0,0,31),
                options = options,
                results = vennResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Venn Diagram
#'
#' 
#' @param data The dataset as a data frame containing the variables for
#'   analysis.
#' @param var1 A string naming the primary variable from \code{data} for the
#'   diagram.
#' @param var1true The level in \code{var1} that represents the positive
#'   condition.
#' @param var2 A string naming the secondary variable from \code{data} used in
#'   the diagram.
#' @param var2true The level in \code{var2} that represents the positive
#'   condition.
#' @param var3 An optional variable from \code{data} to include in the
#'   diagram.
#' @param var3true The level in \code{var3} that represents the positive
#'   condition.
#' @param var4 An optional variable from \code{data} for additional overlap
#'   analysis.
#' @param var4true The level in \code{var4} that represents the positive
#'   condition.
#' @param upsetType Choose between UpSetR (classic) or ComplexUpset (advanced
#'   with more features).
#' @param sortBy How to sort the intersections in the UpSet plot.
#' @param minSize Minimum size of intersections to display.
#' @param showAnnotations Add statistical annotations to the ComplexUpset
#'   plot.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$plot2} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summary$asDF}
#'
#' \code{as.data.frame(results$summary)}
#'
#' @export
venn <- function(
    data,
    var1,
    var1true,
    var2,
    var2true,
    var3,
    var3true,
    var4,
    var4true,
    upsetType = "upsetR",
    sortBy = "freq",
    minSize = 0,
    showAnnotations = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("venn requires jmvcore to be installed (restart may be required)")

    if ( ! missing(var1)) var1 <- jmvcore::resolveQuo(jmvcore::enquo(var1))
    if ( ! missing(var2)) var2 <- jmvcore::resolveQuo(jmvcore::enquo(var2))
    if ( ! missing(var3)) var3 <- jmvcore::resolveQuo(jmvcore::enquo(var3))
    if ( ! missing(var4)) var4 <- jmvcore::resolveQuo(jmvcore::enquo(var4))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(var1), var1, NULL),
            `if`( ! missing(var2), var2, NULL),
            `if`( ! missing(var3), var3, NULL),
            `if`( ! missing(var4), var4, NULL))

    for (v in var1) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in var2) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in var3) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in var4) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- vennOptions$new(
        var1 = var1,
        var1true = var1true,
        var2 = var2,
        var2true = var2true,
        var3 = var3,
        var3true = var3true,
        var4 = var4,
        var4true = var4true,
        upsetType = upsetType,
        sortBy = sortBy,
        minSize = minSize,
        showAnnotations = showAnnotations)

    analysis <- vennClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

