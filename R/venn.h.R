
# This file is automatically generated, you probably don't want to edit this

vennOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "vennOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            var1 = NULL,
            var1true = NULL,
            var2 = NULL,
            var2true = NULL,
            var3 = NULL,
            var3true = NULL,
            var4 = NULL,
            var4true = NULL,
            upsetType = "upsetR",
            sortBy = "freq",
            minSize = 0,
            showAnnotations = FALSE,
            vennEngine = "ggvenn",
            var5 = NULL,
            var5true = NULL,
            var6 = NULL,
            var6true = NULL,
            var7 = NULL,
            var7true = NULL,
            regionLabels = "count",
            labelPrecisionDigits = 1,
            setNameSize = 5,
            labelSize = 4,
            edgeSize = 1,
            edgeColor = "black",
            fillColorMapping = TRUE,
            colorPalette = "default", ...) {

            super$initialize(
                package="ClinicoPath",
                name="venn",
                requiresData=TRUE,
                ...)

            private$..var1 <- jmvcore::OptionVariable$new(
                "var1",
                var1,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..var1true <- jmvcore::OptionLevel$new(
                "var1true",
                var1true,
                variable="(var1)")
            private$..var2 <- jmvcore::OptionVariable$new(
                "var2",
                var2,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..var2true <- jmvcore::OptionLevel$new(
                "var2true",
                var2true,
                variable="(var2)")
            private$..var3 <- jmvcore::OptionVariable$new(
                "var3",
                var3,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..var3true <- jmvcore::OptionLevel$new(
                "var3true",
                var3true,
                variable="(var3)")
            private$..var4 <- jmvcore::OptionVariable$new(
                "var4",
                var4,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..var4true <- jmvcore::OptionLevel$new(
                "var4true",
                var4true,
                variable="(var4)")
            private$..upsetType <- jmvcore::OptionList$new(
                "upsetType",
                upsetType,
                options=list(
                    "upsetR",
                    "complexUpset"),
                default="upsetR")
            private$..sortBy <- jmvcore::OptionList$new(
                "sortBy",
                sortBy,
                options=list(
                    "freq",
                    "degree",
                    "none"),
                default="freq")
            private$..minSize <- jmvcore::OptionInteger$new(
                "minSize",
                minSize,
                min=0,
                default=0)
            private$..showAnnotations <- jmvcore::OptionBool$new(
                "showAnnotations",
                showAnnotations,
                default=FALSE)
            private$..vennEngine <- jmvcore::OptionList$new(
                "vennEngine",
                vennEngine,
                options=list(
                    "ggvenn",
                    "ggVennDiagram"),
                default="ggvenn")
            private$..var5 <- jmvcore::OptionVariable$new(
                "var5",
                var5,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..var5true <- jmvcore::OptionLevel$new(
                "var5true",
                var5true,
                variable="(var5)")
            private$..var6 <- jmvcore::OptionVariable$new(
                "var6",
                var6,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..var6true <- jmvcore::OptionLevel$new(
                "var6true",
                var6true,
                variable="(var6)")
            private$..var7 <- jmvcore::OptionVariable$new(
                "var7",
                var7,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..var7true <- jmvcore::OptionLevel$new(
                "var7true",
                var7true,
                variable="(var7)")
            private$..regionLabels <- jmvcore::OptionList$new(
                "regionLabels",
                regionLabels,
                options=list(
                    "count",
                    "percent",
                    "both",
                    "none"),
                default="count")
            private$..labelPrecisionDigits <- jmvcore::OptionInteger$new(
                "labelPrecisionDigits",
                labelPrecisionDigits,
                min=0,
                max=3,
                default=1)
            private$..setNameSize <- jmvcore::OptionNumber$new(
                "setNameSize",
                setNameSize,
                min=1,
                max=20,
                default=5)
            private$..labelSize <- jmvcore::OptionNumber$new(
                "labelSize",
                labelSize,
                min=1,
                max=20,
                default=4)
            private$..edgeSize <- jmvcore::OptionNumber$new(
                "edgeSize",
                edgeSize,
                min=0.1,
                max=5,
                default=1)
            private$..edgeColor <- jmvcore::OptionString$new(
                "edgeColor",
                edgeColor,
                default="black")
            private$..fillColorMapping <- jmvcore::OptionBool$new(
                "fillColorMapping",
                fillColorMapping,
                default=TRUE)
            private$..colorPalette <- jmvcore::OptionList$new(
                "colorPalette",
                colorPalette,
                options=list(
                    "default",
                    "Set1",
                    "Set2",
                    "Set3",
                    "Pastel1",
                    "Pastel2",
                    "Dark2",
                    "Accent",
                    "viridis",
                    "plasma",
                    "magma",
                    "inferno"),
                default="default")

            self$.addOption(private$..var1)
            self$.addOption(private$..var1true)
            self$.addOption(private$..var2)
            self$.addOption(private$..var2true)
            self$.addOption(private$..var3)
            self$.addOption(private$..var3true)
            self$.addOption(private$..var4)
            self$.addOption(private$..var4true)
            self$.addOption(private$..upsetType)
            self$.addOption(private$..sortBy)
            self$.addOption(private$..minSize)
            self$.addOption(private$..showAnnotations)
            self$.addOption(private$..vennEngine)
            self$.addOption(private$..var5)
            self$.addOption(private$..var5true)
            self$.addOption(private$..var6)
            self$.addOption(private$..var6true)
            self$.addOption(private$..var7)
            self$.addOption(private$..var7true)
            self$.addOption(private$..regionLabels)
            self$.addOption(private$..labelPrecisionDigits)
            self$.addOption(private$..setNameSize)
            self$.addOption(private$..labelSize)
            self$.addOption(private$..edgeSize)
            self$.addOption(private$..edgeColor)
            self$.addOption(private$..fillColorMapping)
            self$.addOption(private$..colorPalette)
        }),
    active = list(
        var1 = function() private$..var1$value,
        var1true = function() private$..var1true$value,
        var2 = function() private$..var2$value,
        var2true = function() private$..var2true$value,
        var3 = function() private$..var3$value,
        var3true = function() private$..var3true$value,
        var4 = function() private$..var4$value,
        var4true = function() private$..var4true$value,
        upsetType = function() private$..upsetType$value,
        sortBy = function() private$..sortBy$value,
        minSize = function() private$..minSize$value,
        showAnnotations = function() private$..showAnnotations$value,
        vennEngine = function() private$..vennEngine$value,
        var5 = function() private$..var5$value,
        var5true = function() private$..var5true$value,
        var6 = function() private$..var6$value,
        var6true = function() private$..var6true$value,
        var7 = function() private$..var7$value,
        var7true = function() private$..var7true$value,
        regionLabels = function() private$..regionLabels$value,
        labelPrecisionDigits = function() private$..labelPrecisionDigits$value,
        setNameSize = function() private$..setNameSize$value,
        labelSize = function() private$..labelSize$value,
        edgeSize = function() private$..edgeSize$value,
        edgeColor = function() private$..edgeColor$value,
        fillColorMapping = function() private$..fillColorMapping$value,
        colorPalette = function() private$..colorPalette$value),
    private = list(
        ..var1 = NA,
        ..var1true = NA,
        ..var2 = NA,
        ..var2true = NA,
        ..var3 = NA,
        ..var3true = NA,
        ..var4 = NA,
        ..var4true = NA,
        ..upsetType = NA,
        ..sortBy = NA,
        ..minSize = NA,
        ..showAnnotations = NA,
        ..vennEngine = NA,
        ..var5 = NA,
        ..var5true = NA,
        ..var6 = NA,
        ..var6true = NA,
        ..var7 = NA,
        ..var7true = NA,
        ..regionLabels = NA,
        ..labelPrecisionDigits = NA,
        ..setNameSize = NA,
        ..labelSize = NA,
        ..edgeSize = NA,
        ..edgeColor = NA,
        ..fillColorMapping = NA,
        ..colorPalette = NA)
)

vennResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "vennResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        aboutAnalysis = function() private$.items[["aboutAnalysis"]],
        clinicalSummary = function() private$.items[["clinicalSummary"]],
        summary = function() private$.items[["summary"]],
        plot = function() private$.items[["plot"]],
        plot2 = function() private$.items[["plot2"]],
        reportSentences = function() private$.items[["reportSentences"]],
        assumptions = function() private$.items[["assumptions"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Venn Diagram",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "ggvenn",
                    "UpSetR",
                    "ComplexUpset"),
                clearWith=list(
                    "var1",
                    "var2",
                    "var3",
                    "var4",
                    "var1true",
                    "var2true",
                    "var3true",
                    "var4true"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="To Do"))
            self$add(jmvcore::Html$new(
                options=options,
                name="aboutAnalysis",
                title="About This Analysis",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalSummary",
                title="Clinical Summary",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                title="Summary of True Counts",
                name="summary",
                rows=0,
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="trueCount", 
                        `title`="True Count", 
                        `type`="integer"),
                    list(
                        `name`="falseCount", 
                        `title`="False Count", 
                        `type`="integer"),
                    list(
                        `name`="totalCount", 
                        `title`="Total Count", 
                        `type`="integer"),
                    list(
                        `name`="truePercentage", 
                        `title`="True %", 
                        `type`="number", 
                        `format`="pc"))))
            self$add(jmvcore::Image$new(
                options=options,
                title="Venn Diagram",
                name="plot",
                width=700,
                height=450,
                renderFun=".plot",
                requiresData=TRUE,
                refs=list(
                    "venn")))
            self$add(jmvcore::Image$new(
                options=options,
                title="Upset Diagram",
                name="plot2",
                width=700,
                height=450,
                renderFun=".plot2",
                requiresData=TRUE,
                refs=list(
                    "upset")))
            self$add(jmvcore::Html$new(
                options=options,
                name="reportSentences",
                title="Copy-Ready Clinical Summary",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="assumptions",
                title="Interpretation Guide & Assumptions",
                visible=TRUE))}))

vennBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "vennBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "venn",
                version = c(0,0,31),
                options = options,
                results = vennResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Venn Diagram
#'
#' 
#' @param data The dataset as a data frame containing the variables for
#'   analysis.
#' @param var1 A string naming the primary variable from \code{data} for the
#'   diagram.
#' @param var1true The level in \code{var1} that represents the positive
#'   condition.
#' @param var2 A string naming the secondary variable from \code{data} used in
#'   the diagram.
#' @param var2true The level in \code{var2} that represents the positive
#'   condition.
#' @param var3 An optional variable from \code{data} to include in the
#'   diagram.
#' @param var3true The level in \code{var3} that represents the positive
#'   condition.
#' @param var4 An optional variable from \code{data} for additional overlap
#'   analysis.
#' @param var4true The level in \code{var4} that represents the positive
#'   condition.
#' @param upsetType Choose between UpSetR (classic) or ComplexUpset (advanced
#'   with more features).
#' @param sortBy How to sort the intersections in the UpSet plot.
#' @param minSize Minimum size of intersections to display.
#' @param showAnnotations Add percentage labels to intersection sizes in
#'   ComplexUpset plots or enhanced text scaling in UpSetR plots.
#' @param vennEngine Choose between ggvenn (classic, 2-4 sets) or
#'   ggVennDiagram (advanced, 2-7 sets with enhanced customization).
#' @param var5 Fifth variable for 5-set Venn diagrams (only available with
#'   ggVennDiagram engine).
#' @param var5true The level in \code{var5} that represents the positive
#'   condition.
#' @param var6 Sixth variable for 6-set Venn diagrams (only available with
#'   ggVennDiagram engine).
#' @param var6true The level in \code{var6} that represents the positive
#'   condition.
#' @param var7 Seventh variable for 7-set Venn diagrams (only available with
#'   ggVennDiagram engine).
#' @param var7true The level in \code{var7} that represents the positive
#'   condition.
#' @param regionLabels What to display in Venn diagram regions (ggVennDiagram
#'   only).
#' @param labelPrecisionDigits Number of decimal places for percentage labels
#'   (ggVennDiagram only).
#' @param setNameSize Font size for set names (ggVennDiagram only).
#' @param labelSize Font size for region labels (ggVennDiagram only).
#' @param edgeSize Width of set boundary lines (ggVennDiagram only).
#' @param edgeColor Color of set boundary lines (ggVennDiagram only).
#' @param fillColorMapping Map fill colors to intersection sizes
#'   (ggVennDiagram only).
#' @param colorPalette Color palette for Venn diagram regions (ggVennDiagram
#'   only).
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$aboutAnalysis} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$clinicalSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$plot2} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$reportSentences} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$assumptions} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summary$asDF}
#'
#' \code{as.data.frame(results$summary)}
#'
#' @export
venn <- function(
    data,
    var1,
    var1true,
    var2,
    var2true,
    var3,
    var3true,
    var4,
    var4true,
    upsetType = "upsetR",
    sortBy = "freq",
    minSize = 0,
    showAnnotations = FALSE,
    vennEngine = "ggvenn",
    var5,
    var5true,
    var6,
    var6true,
    var7,
    var7true,
    regionLabels = "count",
    labelPrecisionDigits = 1,
    setNameSize = 5,
    labelSize = 4,
    edgeSize = 1,
    edgeColor = "black",
    fillColorMapping = TRUE,
    colorPalette = "default") {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("venn requires jmvcore to be installed (restart may be required)")

    if ( ! missing(var1)) var1 <- jmvcore::resolveQuo(jmvcore::enquo(var1))
    if ( ! missing(var2)) var2 <- jmvcore::resolveQuo(jmvcore::enquo(var2))
    if ( ! missing(var3)) var3 <- jmvcore::resolveQuo(jmvcore::enquo(var3))
    if ( ! missing(var4)) var4 <- jmvcore::resolveQuo(jmvcore::enquo(var4))
    if ( ! missing(var5)) var5 <- jmvcore::resolveQuo(jmvcore::enquo(var5))
    if ( ! missing(var6)) var6 <- jmvcore::resolveQuo(jmvcore::enquo(var6))
    if ( ! missing(var7)) var7 <- jmvcore::resolveQuo(jmvcore::enquo(var7))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(var1), var1, NULL),
            `if`( ! missing(var2), var2, NULL),
            `if`( ! missing(var3), var3, NULL),
            `if`( ! missing(var4), var4, NULL),
            `if`( ! missing(var5), var5, NULL),
            `if`( ! missing(var6), var6, NULL),
            `if`( ! missing(var7), var7, NULL))

    for (v in var1) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in var2) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in var3) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in var4) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in var5) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in var6) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in var7) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- vennOptions$new(
        var1 = var1,
        var1true = var1true,
        var2 = var2,
        var2true = var2true,
        var3 = var3,
        var3true = var3true,
        var4 = var4,
        var4true = var4true,
        upsetType = upsetType,
        sortBy = sortBy,
        minSize = minSize,
        showAnnotations = showAnnotations,
        vennEngine = vennEngine,
        var5 = var5,
        var5true = var5true,
        var6 = var6,
        var6true = var6true,
        var7 = var7,
        var7true = var7true,
        regionLabels = regionLabels,
        labelPrecisionDigits = labelPrecisionDigits,
        setNameSize = setNameSize,
        labelSize = labelSize,
        edgeSize = edgeSize,
        edgeColor = edgeColor,
        fillColorMapping = fillColorMapping,
        colorPalette = colorPalette)

    analysis <- vennClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

