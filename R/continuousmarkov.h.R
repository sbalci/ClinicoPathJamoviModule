
# This file is automatically generated, you probably don't want to edit this

continuousmarkovOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "continuousmarkovOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            subject = NULL,
            time = NULL,
            state = NULL,
            covariates = NULL,
            time_covariates = NULL,
            model_structure = "full",
            baseline_hazard = "piecewise",
            n_intervals = 5,
            absorbing_states = "",
            initial_values = FALSE,
            optimization_method = "BFGS",
            calculate_sojourn = TRUE,
            transition_probabilities = TRUE,
            prevalence_estimates = TRUE,
            prediction_times = "1, 5, 10, 20",
            confidence_intervals = TRUE,
            bootstrap_se = FALSE,
            n_bootstrap = 100,
            plot_intensities = TRUE,
            plot_probabilities = TRUE,
            plot_prevalence = TRUE,
            model_selection = FALSE,
            goodness_of_fit = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="continuousmarkov",
                requiresData=TRUE,
                ...)

            private$..subject <- jmvcore::OptionVariable$new(
                "subject",
                subject,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..state <- jmvcore::OptionVariable$new(
                "state",
                state,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..time_covariates <- jmvcore::OptionVariables$new(
                "time_covariates",
                time_covariates,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..model_structure <- jmvcore::OptionList$new(
                "model_structure",
                model_structure,
                options=list(
                    "full",
                    "progressive",
                    "reversible",
                    "custom"),
                default="full")
            private$..baseline_hazard <- jmvcore::OptionList$new(
                "baseline_hazard",
                baseline_hazard,
                options=list(
                    "piecewise",
                    "exponential",
                    "weibull",
                    "spline"),
                default="piecewise")
            private$..n_intervals <- jmvcore::OptionInteger$new(
                "n_intervals",
                n_intervals,
                default=5,
                min=2,
                max=20)
            private$..absorbing_states <- jmvcore::OptionString$new(
                "absorbing_states",
                absorbing_states,
                default="")
            private$..initial_values <- jmvcore::OptionBool$new(
                "initial_values",
                initial_values,
                default=FALSE)
            private$..optimization_method <- jmvcore::OptionList$new(
                "optimization_method",
                optimization_method,
                options=list(
                    "BFGS",
                    "Nelder-Mead",
                    "CG",
                    "SANN"),
                default="BFGS")
            private$..calculate_sojourn <- jmvcore::OptionBool$new(
                "calculate_sojourn",
                calculate_sojourn,
                default=TRUE)
            private$..transition_probabilities <- jmvcore::OptionBool$new(
                "transition_probabilities",
                transition_probabilities,
                default=TRUE)
            private$..prevalence_estimates <- jmvcore::OptionBool$new(
                "prevalence_estimates",
                prevalence_estimates,
                default=TRUE)
            private$..prediction_times <- jmvcore::OptionString$new(
                "prediction_times",
                prediction_times,
                default="1, 5, 10, 20")
            private$..confidence_intervals <- jmvcore::OptionBool$new(
                "confidence_intervals",
                confidence_intervals,
                default=TRUE)
            private$..bootstrap_se <- jmvcore::OptionBool$new(
                "bootstrap_se",
                bootstrap_se,
                default=FALSE)
            private$..n_bootstrap <- jmvcore::OptionInteger$new(
                "n_bootstrap",
                n_bootstrap,
                default=100,
                min=50,
                max=1000)
            private$..plot_intensities <- jmvcore::OptionBool$new(
                "plot_intensities",
                plot_intensities,
                default=TRUE)
            private$..plot_probabilities <- jmvcore::OptionBool$new(
                "plot_probabilities",
                plot_probabilities,
                default=TRUE)
            private$..plot_prevalence <- jmvcore::OptionBool$new(
                "plot_prevalence",
                plot_prevalence,
                default=TRUE)
            private$..model_selection <- jmvcore::OptionBool$new(
                "model_selection",
                model_selection,
                default=FALSE)
            private$..goodness_of_fit <- jmvcore::OptionBool$new(
                "goodness_of_fit",
                goodness_of_fit,
                default=TRUE)

            self$.addOption(private$..subject)
            self$.addOption(private$..time)
            self$.addOption(private$..state)
            self$.addOption(private$..covariates)
            self$.addOption(private$..time_covariates)
            self$.addOption(private$..model_structure)
            self$.addOption(private$..baseline_hazard)
            self$.addOption(private$..n_intervals)
            self$.addOption(private$..absorbing_states)
            self$.addOption(private$..initial_values)
            self$.addOption(private$..optimization_method)
            self$.addOption(private$..calculate_sojourn)
            self$.addOption(private$..transition_probabilities)
            self$.addOption(private$..prevalence_estimates)
            self$.addOption(private$..prediction_times)
            self$.addOption(private$..confidence_intervals)
            self$.addOption(private$..bootstrap_se)
            self$.addOption(private$..n_bootstrap)
            self$.addOption(private$..plot_intensities)
            self$.addOption(private$..plot_probabilities)
            self$.addOption(private$..plot_prevalence)
            self$.addOption(private$..model_selection)
            self$.addOption(private$..goodness_of_fit)
        }),
    active = list(
        subject = function() private$..subject$value,
        time = function() private$..time$value,
        state = function() private$..state$value,
        covariates = function() private$..covariates$value,
        time_covariates = function() private$..time_covariates$value,
        model_structure = function() private$..model_structure$value,
        baseline_hazard = function() private$..baseline_hazard$value,
        n_intervals = function() private$..n_intervals$value,
        absorbing_states = function() private$..absorbing_states$value,
        initial_values = function() private$..initial_values$value,
        optimization_method = function() private$..optimization_method$value,
        calculate_sojourn = function() private$..calculate_sojourn$value,
        transition_probabilities = function() private$..transition_probabilities$value,
        prevalence_estimates = function() private$..prevalence_estimates$value,
        prediction_times = function() private$..prediction_times$value,
        confidence_intervals = function() private$..confidence_intervals$value,
        bootstrap_se = function() private$..bootstrap_se$value,
        n_bootstrap = function() private$..n_bootstrap$value,
        plot_intensities = function() private$..plot_intensities$value,
        plot_probabilities = function() private$..plot_probabilities$value,
        plot_prevalence = function() private$..plot_prevalence$value,
        model_selection = function() private$..model_selection$value,
        goodness_of_fit = function() private$..goodness_of_fit$value),
    private = list(
        ..subject = NA,
        ..time = NA,
        ..state = NA,
        ..covariates = NA,
        ..time_covariates = NA,
        ..model_structure = NA,
        ..baseline_hazard = NA,
        ..n_intervals = NA,
        ..absorbing_states = NA,
        ..initial_values = NA,
        ..optimization_method = NA,
        ..calculate_sojourn = NA,
        ..transition_probabilities = NA,
        ..prevalence_estimates = NA,
        ..prediction_times = NA,
        ..confidence_intervals = NA,
        ..bootstrap_se = NA,
        ..n_bootstrap = NA,
        ..plot_intensities = NA,
        ..plot_probabilities = NA,
        ..plot_prevalence = NA,
        ..model_selection = NA,
        ..goodness_of_fit = NA)
)

continuousmarkovResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "continuousmarkovResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        summary = function() private$.items[["summary"]],
        dataStructure = function() private$.items[["dataStructure"]],
        transitionMatrix = function() private$.items[["transitionMatrix"]],
        intensityMatrix = function() private$.items[["intensityMatrix"]],
        covariateEffects = function() private$.items[["covariateEffects"]],
        sojournTimes = function() private$.items[["sojournTimes"]],
        transitionProbabilities = function() private$.items[["transitionProbabilities"]],
        prevalenceTable = function() private$.items[["prevalenceTable"]],
        modelFit = function() private$.items[["modelFit"]],
        intensityPlot = function() private$.items[["intensityPlot"]],
        probabilityPlot = function() private$.items[["probabilityPlot"]],
        prevalencePlot = function() private$.items[["prevalencePlot"]],
        modelComparison = function() private$.items[["modelComparison"]],
        goodnessOfFit = function() private$.items[["goodnessOfFit"]],
        clinicalInterpretation = function() private$.items[["clinicalInterpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Continuous-Time Markov Models",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Instructions",
                clearWith=list(
                    "subject",
                    "time",
                    "state")))
            self$add(jmvcore::Html$new(
                options=options,
                name="summary",
                title="Model Summary",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="dataStructure",
                title="Data Structure Summary",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="transitionMatrix",
                title="Observed Transitions",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="from_state", 
                        `title`="From State", 
                        `type`="text"),
                    list(
                        `name`="to_state", 
                        `title`="To State", 
                        `type`="text"),
                    list(
                        `name`="n_transitions", 
                        `title`="Observed", 
                        `type`="integer"),
                    list(
                        `name`="total_time", 
                        `title`="Total Time", 
                        `type`="number"),
                    list(
                        `name`="rate", 
                        `title`="Crude Rate", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="intensityMatrix",
                title="Estimated Transition Intensities",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="from_state", 
                        `title`="From State", 
                        `type`="text"),
                    list(
                        `name`="to_state", 
                        `title`="To State", 
                        `type`="text"),
                    list(
                        `name`="intensity", 
                        `title`="Intensity", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="covariateEffects",
                title="Covariate Effects on Transitions",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="transition", 
                        `title`="Transition", 
                        `type`="text"),
                    list(
                        `name`="covariate", 
                        `title`="Covariate", 
                        `type`="text"),
                    list(
                        `name`="coefficient", 
                        `title`="Coefficient", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="hazard_ratio", 
                        `title`="Hazard Ratio", 
                        `type`="number"),
                    list(
                        `name`="hr_lower", 
                        `title`="HR Lower", 
                        `type`="number"),
                    list(
                        `name`="hr_upper", 
                        `title`="HR Upper", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="sojournTimes",
                title="Expected Sojourn Times",
                visible="(calculate_sojourn)",
                rows=1,
                columns=list(
                    list(
                        `name`="state", 
                        `title`="State", 
                        `type`="text"),
                    list(
                        `name`="sojourn_time", 
                        `title`="Expected Time", 
                        `type`="number"),
                    list(
                        `name`="sojourn_se", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="sojourn_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="sojourn_upper", 
                        `title`="CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="transitionProbabilities",
                title="Transition Probabilities P(t)",
                visible="(transition_probabilities)",
                rows=1,
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="from_state", 
                        `title`="From State", 
                        `type`="text"),
                    list(
                        `name`="to_state", 
                        `title`="To State", 
                        `type`="text"),
                    list(
                        `name`="probability", 
                        `title`="Probability", 
                        `type`="number"),
                    list(
                        `name`="prob_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="prob_upper", 
                        `title`="CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="prevalenceTable",
                title="State Prevalence Over Time",
                visible="(prevalence_estimates)",
                rows=1,
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="state", 
                        `title`="State", 
                        `type`="text"),
                    list(
                        `name`="prevalence", 
                        `title`="Prevalence", 
                        `type`="number"),
                    list(
                        `name`="prev_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="prev_upper", 
                        `title`="CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelFit",
                title="Model Fit Statistics",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="description", 
                        `title`="Description", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="intensityPlot",
                title="Transition Intensity Functions",
                width=700,
                height=500,
                renderFun=".plotIntensities",
                visible="(plot_intensities)",
                clearWith=list(
                    "subject",
                    "time",
                    "state",
                    "model_structure")))
            self$add(jmvcore::Image$new(
                options=options,
                name="probabilityPlot",
                title="Transition Probabilities Over Time",
                width=700,
                height=500,
                renderFun=".plotTransitionProbabilities",
                visible="(plot_probabilities)",
                clearWith=list(
                    "subject",
                    "time",
                    "state",
                    "prediction_times")))
            self$add(jmvcore::Image$new(
                options=options,
                name="prevalencePlot",
                title="State Prevalence Over Time",
                width=700,
                height=500,
                renderFun=".plotPrevalence",
                visible="(plot_prevalence)",
                clearWith=list(
                    "subject",
                    "time",
                    "state",
                    "prediction_times")))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelComparison",
                title="Model Selection Results",
                visible="(model_selection)",
                rows=1,
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="loglik", 
                        `title`="Log-Likelihood", 
                        `type`="number"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number"),
                    list(
                        `name`="n_params", 
                        `title`="Parameters", 
                        `type`="integer"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="goodnessOfFit",
                title="Goodness of Fit Assessment",
                visible="(goodness_of_fit)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalInterpretation",
                title="Clinical Interpretation",
                visible=TRUE))}))

continuousmarkovBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "continuousmarkovBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "continuousmarkov",
                version = c(0,0,3),
                options = options,
                results = continuousmarkovResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Continuous-Time Markov Models
#'
#' Continuous-time Markov models for analyzing longitudinal data with discrete 
#' states.
#' Handles irregularly observed data and estimates transition intensities 
#' between states.
#' 
#'
#' @examples
#' \donttest{
#' # Example usage
#' continuousmarkov(
#'     data = longitudinal_data,
#'     time = observation_time,
#'     state = state_variable,
#'     subject = patient_id,
#'     covariates = c(age, treatment)
#' )
#'}
#' @param data The data as a data frame.
#' @param subject Variable identifying individual subjects
#' @param time Time variable for observations
#' @param state Discrete state variable
#' @param covariates Variables affecting transition intensities
#' @param time_covariates Covariates that change over time
#' @param model_structure Defines which state transitions are possible
#' @param baseline_hazard Baseline hazard specification
#' @param n_intervals Time intervals for piecewise baseline
#' @param absorbing_states States from which no transitions are possible
#' @param initial_values Use custom initial parameter values
#' @param optimization_method Method for maximum likelihood estimation
#' @param calculate_sojourn Compute mean sojourn times
#' @param transition_probabilities Compute P(t) matrices over time
#' @param prevalence_estimates Estimate prevalence in each state
#' @param prediction_times Time points for probability predictions
#' @param confidence_intervals Include uncertainty estimates
#' @param bootstrap_se Bootstrap-based confidence intervals
#' @param n_bootstrap Bootstrap sample size
#' @param plot_intensities Generate intensity plots
#' @param plot_probabilities Generate probability plots
#' @param plot_prevalence Generate prevalence plots
#' @param model_selection Perform model comparison using AIC/BIC
#' @param goodness_of_fit Test model adequacy
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$dataStructure} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$transitionMatrix} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$intensityMatrix} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$covariateEffects} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$sojournTimes} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$transitionProbabilities} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$prevalenceTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelFit} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$intensityPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$probabilityPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$prevalencePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$modelComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$goodnessOfFit} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$clinicalInterpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$dataStructure$asDF}
#'
#' \code{as.data.frame(results$dataStructure)}
#'
#' @export
continuousmarkov <- function(
    data,
    subject,
    time,
    state,
    covariates,
    time_covariates,
    model_structure = "full",
    baseline_hazard = "piecewise",
    n_intervals = 5,
    absorbing_states = "",
    initial_values = FALSE,
    optimization_method = "BFGS",
    calculate_sojourn = TRUE,
    transition_probabilities = TRUE,
    prevalence_estimates = TRUE,
    prediction_times = "1, 5, 10, 20",
    confidence_intervals = TRUE,
    bootstrap_se = FALSE,
    n_bootstrap = 100,
    plot_intensities = TRUE,
    plot_probabilities = TRUE,
    plot_prevalence = TRUE,
    model_selection = FALSE,
    goodness_of_fit = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("continuousmarkov requires jmvcore to be installed (restart may be required)")

    if ( ! missing(subject)) subject <- jmvcore::resolveQuo(jmvcore::enquo(subject))
    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(state)) state <- jmvcore::resolveQuo(jmvcore::enquo(state))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(time_covariates)) time_covariates <- jmvcore::resolveQuo(jmvcore::enquo(time_covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(subject), subject, NULL),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(state), state, NULL),
            `if`( ! missing(covariates), covariates, NULL),
            `if`( ! missing(time_covariates), time_covariates, NULL))


    options <- continuousmarkovOptions$new(
        subject = subject,
        time = time,
        state = state,
        covariates = covariates,
        time_covariates = time_covariates,
        model_structure = model_structure,
        baseline_hazard = baseline_hazard,
        n_intervals = n_intervals,
        absorbing_states = absorbing_states,
        initial_values = initial_values,
        optimization_method = optimization_method,
        calculate_sojourn = calculate_sojourn,
        transition_probabilities = transition_probabilities,
        prevalence_estimates = prevalence_estimates,
        prediction_times = prediction_times,
        confidence_intervals = confidence_intervals,
        bootstrap_se = bootstrap_se,
        n_bootstrap = n_bootstrap,
        plot_intensities = plot_intensities,
        plot_probabilities = plot_probabilities,
        plot_prevalence = plot_prevalence,
        model_selection = model_selection,
        goodness_of_fit = goodness_of_fit)

    analysis <- continuousmarkovClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

