
# This file is automatically generated, you probably don't want to edit this

groupedbarOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "groupedbarOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            items = NULL,
            groups = NULL,
            values = NULL,
            facetby = NULL,
            statistic = "mean",
            plottype = "grouped",
            sortorder = "highest_first",
            grouporder = "data",
            customgrouporder = "",
            showvalues = TRUE,
            valueposition = "outside",
            showerrorbars = FALSE,
            errortype = "se",
            showconnectors = FALSE,
            colorscheme = "default",
            customcolors = "",
            referenceline = NULL,
            referencelinelabel = "",
            referenceband = "",
            title = "",
            subtitle = "",
            xlabel = "",
            ylabel = "",
            showlegend = TRUE,
            legendtitle = "",
            legendposition = "right",
            showstatistics = FALSE,
            testtype = "auto",
            posthoc = FALSE,
            padjust = "none",
            decimals = 1,
            highlightmax = FALSE,
            highlightmin = FALSE,
            highlightgroups = "",
            gridlines = TRUE,
            aspectratio = "auto",
            width = 10,
            height = 8,
            showTable = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="groupedbar",
                requiresData=TRUE,
                ...)

            private$..items <- jmvcore::OptionVariables$new(
                "items",
                items,
                suggested=list(
                    "nominal",
                    "ordinal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..groups <- jmvcore::OptionVariable$new(
                "groups",
                groups,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..values <- jmvcore::OptionVariable$new(
                "values",
                values,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..facetby <- jmvcore::OptionVariable$new(
                "facetby",
                facetby,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..statistic <- jmvcore::OptionList$new(
                "statistic",
                statistic,
                options=list(
                    "mean",
                    "median",
                    "sum",
                    "count",
                    "percentage",
                    "proportion",
                    "sd",
                    "se",
                    "min",
                    "max"),
                default="mean")
            private$..plottype <- jmvcore::OptionList$new(
                "plottype",
                plottype,
                options=list(
                    "grouped",
                    "stacked",
                    "stacked_percent",
                    "dodged",
                    "horizontal",
                    "cleveland"),
                default="grouped")
            private$..sortorder <- jmvcore::OptionList$new(
                "sortorder",
                sortorder,
                options=list(
                    "highest_first",
                    "highest_last",
                    "average",
                    "maximum",
                    "range",
                    "alphabetical",
                    "none"),
                default="highest_first")
            private$..grouporder <- jmvcore::OptionList$new(
                "grouporder",
                grouporder,
                options=list(
                    "data",
                    "alphabetical",
                    "mean",
                    "median",
                    "custom"),
                default="data")
            private$..customgrouporder <- jmvcore::OptionString$new(
                "customgrouporder",
                customgrouporder,
                default="")
            private$..showvalues <- jmvcore::OptionBool$new(
                "showvalues",
                showvalues,
                default=TRUE)
            private$..valueposition <- jmvcore::OptionList$new(
                "valueposition",
                valueposition,
                options=list(
                    "inside",
                    "outside",
                    "center"),
                default="outside")
            private$..showerrorbars <- jmvcore::OptionBool$new(
                "showerrorbars",
                showerrorbars,
                default=FALSE)
            private$..errortype <- jmvcore::OptionList$new(
                "errortype",
                errortype,
                options=list(
                    "se",
                    "sd",
                    "ci95",
                    "ci99",
                    "iqr",
                    "range"),
                default="se")
            private$..showconnectors <- jmvcore::OptionBool$new(
                "showconnectors",
                showconnectors,
                default=FALSE)
            private$..colorscheme <- jmvcore::OptionList$new(
                "colorscheme",
                colorscheme,
                options=list(
                    "default",
                    "clinical",
                    "blues",
                    "reds",
                    "diverging",
                    "viridis",
                    "colorblind",
                    "grayscale",
                    "custom"),
                default="default")
            private$..customcolors <- jmvcore::OptionString$new(
                "customcolors",
                customcolors,
                default="")
            private$..referenceline <- jmvcore::OptionNumber$new(
                "referenceline",
                referenceline)
            private$..referencelinelabel <- jmvcore::OptionString$new(
                "referencelinelabel",
                referencelinelabel,
                default="")
            private$..referenceband <- jmvcore::OptionString$new(
                "referenceband",
                referenceband,
                default="")
            private$..title <- jmvcore::OptionString$new(
                "title",
                title,
                default="")
            private$..subtitle <- jmvcore::OptionString$new(
                "subtitle",
                subtitle,
                default="")
            private$..xlabel <- jmvcore::OptionString$new(
                "xlabel",
                xlabel,
                default="")
            private$..ylabel <- jmvcore::OptionString$new(
                "ylabel",
                ylabel,
                default="")
            private$..showlegend <- jmvcore::OptionBool$new(
                "showlegend",
                showlegend,
                default=TRUE)
            private$..legendtitle <- jmvcore::OptionString$new(
                "legendtitle",
                legendtitle,
                default="")
            private$..legendposition <- jmvcore::OptionList$new(
                "legendposition",
                legendposition,
                options=list(
                    "top",
                    "bottom",
                    "right",
                    "left",
                    "none"),
                default="right")
            private$..showstatistics <- jmvcore::OptionBool$new(
                "showstatistics",
                showstatistics,
                default=FALSE)
            private$..testtype <- jmvcore::OptionList$new(
                "testtype",
                testtype,
                options=list(
                    "auto",
                    "anova",
                    "kruskal",
                    "chisq",
                    "fisher",
                    "ttest",
                    "wilcoxon",
                    "trend"),
                default="auto")
            private$..posthoc <- jmvcore::OptionBool$new(
                "posthoc",
                posthoc,
                default=FALSE)
            private$..padjust <- jmvcore::OptionList$new(
                "padjust",
                padjust,
                options=list(
                    "none",
                    "bonferroni",
                    "holm",
                    "fdr"),
                default="none")
            private$..decimals <- jmvcore::OptionInteger$new(
                "decimals",
                decimals,
                default=1,
                min=0,
                max=4)
            private$..highlightmax <- jmvcore::OptionBool$new(
                "highlightmax",
                highlightmax,
                default=FALSE)
            private$..highlightmin <- jmvcore::OptionBool$new(
                "highlightmin",
                highlightmin,
                default=FALSE)
            private$..highlightgroups <- jmvcore::OptionString$new(
                "highlightgroups",
                highlightgroups,
                default="")
            private$..gridlines <- jmvcore::OptionBool$new(
                "gridlines",
                gridlines,
                default=TRUE)
            private$..aspectratio <- jmvcore::OptionList$new(
                "aspectratio",
                aspectratio,
                options=list(
                    "auto",
                    "square",
                    "wide",
                    "tall",
                    "golden"),
                default="auto")
            private$..width <- jmvcore::OptionNumber$new(
                "width",
                width,
                default=10,
                min=5,
                max=20)
            private$..height <- jmvcore::OptionNumber$new(
                "height",
                height,
                default=8,
                min=4,
                max=20)
            private$..showTable <- jmvcore::OptionBool$new(
                "showTable",
                showTable,
                default=FALSE)

            self$.addOption(private$..items)
            self$.addOption(private$..groups)
            self$.addOption(private$..values)
            self$.addOption(private$..facetby)
            self$.addOption(private$..statistic)
            self$.addOption(private$..plottype)
            self$.addOption(private$..sortorder)
            self$.addOption(private$..grouporder)
            self$.addOption(private$..customgrouporder)
            self$.addOption(private$..showvalues)
            self$.addOption(private$..valueposition)
            self$.addOption(private$..showerrorbars)
            self$.addOption(private$..errortype)
            self$.addOption(private$..showconnectors)
            self$.addOption(private$..colorscheme)
            self$.addOption(private$..customcolors)
            self$.addOption(private$..referenceline)
            self$.addOption(private$..referencelinelabel)
            self$.addOption(private$..referenceband)
            self$.addOption(private$..title)
            self$.addOption(private$..subtitle)
            self$.addOption(private$..xlabel)
            self$.addOption(private$..ylabel)
            self$.addOption(private$..showlegend)
            self$.addOption(private$..legendtitle)
            self$.addOption(private$..legendposition)
            self$.addOption(private$..showstatistics)
            self$.addOption(private$..testtype)
            self$.addOption(private$..posthoc)
            self$.addOption(private$..padjust)
            self$.addOption(private$..decimals)
            self$.addOption(private$..highlightmax)
            self$.addOption(private$..highlightmin)
            self$.addOption(private$..highlightgroups)
            self$.addOption(private$..gridlines)
            self$.addOption(private$..aspectratio)
            self$.addOption(private$..width)
            self$.addOption(private$..height)
            self$.addOption(private$..showTable)
        }),
    active = list(
        items = function() private$..items$value,
        groups = function() private$..groups$value,
        values = function() private$..values$value,
        facetby = function() private$..facetby$value,
        statistic = function() private$..statistic$value,
        plottype = function() private$..plottype$value,
        sortorder = function() private$..sortorder$value,
        grouporder = function() private$..grouporder$value,
        customgrouporder = function() private$..customgrouporder$value,
        showvalues = function() private$..showvalues$value,
        valueposition = function() private$..valueposition$value,
        showerrorbars = function() private$..showerrorbars$value,
        errortype = function() private$..errortype$value,
        showconnectors = function() private$..showconnectors$value,
        colorscheme = function() private$..colorscheme$value,
        customcolors = function() private$..customcolors$value,
        referenceline = function() private$..referenceline$value,
        referencelinelabel = function() private$..referencelinelabel$value,
        referenceband = function() private$..referenceband$value,
        title = function() private$..title$value,
        subtitle = function() private$..subtitle$value,
        xlabel = function() private$..xlabel$value,
        ylabel = function() private$..ylabel$value,
        showlegend = function() private$..showlegend$value,
        legendtitle = function() private$..legendtitle$value,
        legendposition = function() private$..legendposition$value,
        showstatistics = function() private$..showstatistics$value,
        testtype = function() private$..testtype$value,
        posthoc = function() private$..posthoc$value,
        padjust = function() private$..padjust$value,
        decimals = function() private$..decimals$value,
        highlightmax = function() private$..highlightmax$value,
        highlightmin = function() private$..highlightmin$value,
        highlightgroups = function() private$..highlightgroups$value,
        gridlines = function() private$..gridlines$value,
        aspectratio = function() private$..aspectratio$value,
        width = function() private$..width$value,
        height = function() private$..height$value,
        showTable = function() private$..showTable$value),
    private = list(
        ..items = NA,
        ..groups = NA,
        ..values = NA,
        ..facetby = NA,
        ..statistic = NA,
        ..plottype = NA,
        ..sortorder = NA,
        ..grouporder = NA,
        ..customgrouporder = NA,
        ..showvalues = NA,
        ..valueposition = NA,
        ..showerrorbars = NA,
        ..errortype = NA,
        ..showconnectors = NA,
        ..colorscheme = NA,
        ..customcolors = NA,
        ..referenceline = NA,
        ..referencelinelabel = NA,
        ..referenceband = NA,
        ..title = NA,
        ..subtitle = NA,
        ..xlabel = NA,
        ..ylabel = NA,
        ..showlegend = NA,
        ..legendtitle = NA,
        ..legendposition = NA,
        ..showstatistics = NA,
        ..testtype = NA,
        ..posthoc = NA,
        ..padjust = NA,
        ..decimals = NA,
        ..highlightmax = NA,
        ..highlightmin = NA,
        ..highlightgroups = NA,
        ..gridlines = NA,
        ..aspectratio = NA,
        ..width = NA,
        ..height = NA,
        ..showTable = NA)
)

groupedbarResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "groupedbarResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        plot = function() private$.items[["plot"]],
        plotnotes = function() private$.items[["plotnotes"]],
        descriptives = function() private$.items[["descriptives"]],
        statistics = function() private$.items[["statistics"]],
        posthoctests = function() private$.items[["posthoctests"]],
        plotcode = function() private$.items[["plotcode"]],
        dataexport = function() private$.items[["dataexport"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Grouped Bar Chart Comparison",
                refs="ClinicoPath - ClinicoPathJamoviModule")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot",
                title="Main Plot",
                width=800,
                height=600,
                renderFun=".plot",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="plotnotes",
                title="Plot Notes",
                visible=FALSE))
            self$add(jmvcore::Table$new(
                options=options,
                name="descriptives",
                title="Descriptive Statistics",
                visible="(showTable)",
                columns=list(
                    list(
                        `name`="item", 
                        `title`="Item/Variable", 
                        `type`="text"),
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="statistic_value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number", 
                        `visible`="(showerrorbars && errortype:se)"),
                    list(
                        `name`="sd", 
                        `title`="SD", 
                        `type`="number", 
                        `visible`="(showerrorbars && errortype:sd)"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number", 
                        `visible`="(showerrorbars && (errortype:ci95 || errortype:ci99))"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number", 
                        `visible`="(showerrorbars && (errortype:ci95 || errortype:ci99))"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="statistics",
                title="Statistical Tests",
                visible="(showstatistics)",
                columns=list(
                    list(
                        `name`="item", 
                        `title`="Item/Variable", 
                        `type`="text"),
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="effect_size", 
                        `title`="Effect Size", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="posthoctests",
                title="Post-hoc Comparisons",
                visible="(posthoc && showstatistics)",
                columns=list(
                    list(
                        `name`="item", 
                        `title`="Item/Variable", 
                        `type`="text"),
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="difference", 
                        `title`="Difference", 
                        `type`="number"),
                    list(
                        `name`="p", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="p_adjusted", 
                        `title`="p (adjusted)", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="significant", 
                        `title`="Significant", 
                        `type`="text"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="plotcode",
                title="R Code",
                visible=FALSE))
            self$add(jmvcore::Html$new(
                options=options,
                name="dataexport",
                title="Data Export",
                visible=FALSE))}))

groupedbarBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "groupedbarBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "groupedbar",
                version = c(0,0,31),
                options = options,
                results = groupedbarResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Grouped Bar Chart Comparison
#'
#' Creates grouped bar charts to compare measurements, responses, or outcomes 
#' across different groups. Suitable for comparing lab values across disease 
#' groups,
#' treatment responses across hospitals, survey responses across demographics,
#' or any metric that varies by categorical groupings.
#' 
#'
#' @examples
#' \donttest{
#' # Example: Compare lab values across disease groups
#' groupedbar(
#'     data = clinicalData,
#'     items = c("glucose", "cholesterol", "creatinine"),
#'     groups = "disease_group",
#'     values = "measurement"
#' )
#'}
#' @param data The data as a data frame.
#' @param items The measurements, variables, or items to compare across
#'   groups. Can be categorical (for frequencies) or continuous (for summary
#'   statistics).
#' @param groups Variable containing group categories (e.g., disease groups,
#'   hospitals,  age groups, treatment arms, regions, etc.).
#' @param values Numeric variable containing measurement values. If NULL,
#'   frequencies or summary statistics will be calculated from the data.
#' @param facetby Optional variable to create separate panels (e.g., by
#'   gender, time point, location).
#' @param statistic Which summary statistic to display for continuous
#'   variables.
#' @param plottype Choose the bar chart layout style.
#' @param sortorder How to sort the items in the chart.
#' @param grouporder How to order the groups in the legend and bars.
#' @param customgrouporder Comma-separated list of group names in desired
#'   order  (e.g., "Control,Mild,Moderate,Severe").
#' @param showvalues Display numeric values on or next to bars.
#' @param valueposition Position of value labels relative to bars.
#' @param showerrorbars Display error bars for continuous variables.
#' @param errortype Type of error bars to display.
#' @param showconnectors Draw lines connecting values across groups to show
#'   patterns.
#' @param colorscheme Color palette for groups.
#' @param customcolors Comma-separated hex colors for each group (e.g.,
#'   "#1f77b4,#ff7f0e,#2ca02c").
#' @param referenceline Add a horizontal reference line at this value (e.g.,
#'   normal range limit, cutoff).
#' @param referencelinelabel Label for the reference line.
#' @param referenceband Add a reference band using format "min,max" (e.g.,
#'   "3.5,5.5" for normal range).
#' @param title Main title for the chart.
#' @param subtitle Subtitle or description for the chart.
#' @param xlabel Label for the x-axis.
#' @param ylabel Label for the y-axis.
#' @param showlegend Display legend for groups.
#' @param legendtitle Title for the legend.
#' @param legendposition Position of the legend.
#' @param showstatistics Perform and display statistical tests comparing
#'   groups.
#' @param testtype Statistical test for comparing groups.
#' @param posthoc Perform pairwise post-hoc comparisons when significant.
#' @param padjust Method for adjusting p-values in multiple comparisons.
#' @param decimals Number of decimal places for displayed values.
#' @param highlightmax Emphasize the highest value for each item.
#' @param highlightmin Emphasize the lowest value for each item.
#' @param highlightgroups Comma-separated list of group names to highlight.
#' @param gridlines Display background grid lines.
#' @param aspectratio Aspect ratio of the plot.
#' @param width Width of the plot in inches.
#' @param height Height of the plot in inches.
#' @param showTable Display a summary table below the plot.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$plotnotes} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$descriptives} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$statistics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$posthoctests} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$plotcode} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$dataexport} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$descriptives$asDF}
#'
#' \code{as.data.frame(results$descriptives)}
#'
#' @export
groupedbar <- function(
    data,
    items,
    groups,
    values = NULL,
    facetby = NULL,
    statistic = "mean",
    plottype = "grouped",
    sortorder = "highest_first",
    grouporder = "data",
    customgrouporder = "",
    showvalues = TRUE,
    valueposition = "outside",
    showerrorbars = FALSE,
    errortype = "se",
    showconnectors = FALSE,
    colorscheme = "default",
    customcolors = "",
    referenceline,
    referencelinelabel = "",
    referenceband = "",
    title = "",
    subtitle = "",
    xlabel = "",
    ylabel = "",
    showlegend = TRUE,
    legendtitle = "",
    legendposition = "right",
    showstatistics = FALSE,
    testtype = "auto",
    posthoc = FALSE,
    padjust = "none",
    decimals = 1,
    highlightmax = FALSE,
    highlightmin = FALSE,
    highlightgroups = "",
    gridlines = TRUE,
    aspectratio = "auto",
    width = 10,
    height = 8,
    showTable = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("groupedbar requires jmvcore to be installed (restart may be required)")

    if ( ! missing(items)) items <- jmvcore::resolveQuo(jmvcore::enquo(items))
    if ( ! missing(groups)) groups <- jmvcore::resolveQuo(jmvcore::enquo(groups))
    if ( ! missing(values)) values <- jmvcore::resolveQuo(jmvcore::enquo(values))
    if ( ! missing(facetby)) facetby <- jmvcore::resolveQuo(jmvcore::enquo(facetby))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(items), items, NULL),
            `if`( ! missing(groups), groups, NULL),
            `if`( ! missing(values), values, NULL),
            `if`( ! missing(facetby), facetby, NULL))

    for (v in groups) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in facetby) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- groupedbarOptions$new(
        items = items,
        groups = groups,
        values = values,
        facetby = facetby,
        statistic = statistic,
        plottype = plottype,
        sortorder = sortorder,
        grouporder = grouporder,
        customgrouporder = customgrouporder,
        showvalues = showvalues,
        valueposition = valueposition,
        showerrorbars = showerrorbars,
        errortype = errortype,
        showconnectors = showconnectors,
        colorscheme = colorscheme,
        customcolors = customcolors,
        referenceline = referenceline,
        referencelinelabel = referencelinelabel,
        referenceband = referenceband,
        title = title,
        subtitle = subtitle,
        xlabel = xlabel,
        ylabel = ylabel,
        showlegend = showlegend,
        legendtitle = legendtitle,
        legendposition = legendposition,
        showstatistics = showstatistics,
        testtype = testtype,
        posthoc = posthoc,
        padjust = padjust,
        decimals = decimals,
        highlightmax = highlightmax,
        highlightmin = highlightmin,
        highlightgroups = highlightgroups,
        gridlines = gridlines,
        aspectratio = aspectratio,
        width = width,
        height = height,
        showTable = showTable)

    analysis <- groupedbarClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

