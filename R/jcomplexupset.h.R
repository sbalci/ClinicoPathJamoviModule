
# This file is automatically generated, you probably don't want to edit this

jcomplexupsetOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jcomplexupsetOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            set_vars = NULL,
            value_var = NULL,
            min_size = 0,
            max_degree = 4,
            sort_by = "cardinality",
            sort_order = "descending",
            keep_empty_groups = FALSE,
            set_size_show = TRUE,
            intersection_size_show = TRUE,
            show_percentages = FALSE,
            annotations = "intersection_size",
            base_annotations_height = 2,
            intersections_height = 3,
            sets_width = 2,
            color_palette = "Set2",
            theme_style = "theme_minimal",
            matrix_color = "black",
            bar_color = "steelblue",
            text_size = 12,
            plot_title = "",
            plot_subtitle = "",
            show_statistics = TRUE,
            show_interpretation = TRUE,
            width_ratio = 0.3,
            height_ratio = 0.7, ...) {

            super$initialize(
                package="ClinicoPath",
                name="jcomplexupset",
                requiresData=TRUE,
                ...)

            private$..set_vars <- jmvcore::OptionVariables$new(
                "set_vars",
                set_vars,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..value_var <- jmvcore::OptionVariable$new(
                "value_var",
                value_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..min_size <- jmvcore::OptionNumber$new(
                "min_size",
                min_size,
                default=0,
                min=0)
            private$..max_degree <- jmvcore::OptionNumber$new(
                "max_degree",
                max_degree,
                default=4,
                min=1,
                max=10)
            private$..sort_by <- jmvcore::OptionList$new(
                "sort_by",
                sort_by,
                options=list(
                    "cardinality",
                    "degree",
                    "ratio"),
                default="cardinality")
            private$..sort_order <- jmvcore::OptionList$new(
                "sort_order",
                sort_order,
                options=list(
                    "descending",
                    "ascending"),
                default="descending")
            private$..keep_empty_groups <- jmvcore::OptionBool$new(
                "keep_empty_groups",
                keep_empty_groups,
                default=FALSE)
            private$..set_size_show <- jmvcore::OptionBool$new(
                "set_size_show",
                set_size_show,
                default=TRUE)
            private$..intersection_size_show <- jmvcore::OptionBool$new(
                "intersection_size_show",
                intersection_size_show,
                default=TRUE)
            private$..show_percentages <- jmvcore::OptionBool$new(
                "show_percentages",
                show_percentages,
                default=FALSE)
            private$..annotations <- jmvcore::OptionList$new(
                "annotations",
                annotations,
                options=list(
                    "none",
                    "intersection_size",
                    "intersection_ratio"),
                default="intersection_size")
            private$..base_annotations_height <- jmvcore::OptionNumber$new(
                "base_annotations_height",
                base_annotations_height,
                default=2,
                min=0.5,
                max=5)
            private$..intersections_height <- jmvcore::OptionNumber$new(
                "intersections_height",
                intersections_height,
                default=3,
                min=1,
                max=8)
            private$..sets_width <- jmvcore::OptionNumber$new(
                "sets_width",
                sets_width,
                default=2,
                min=0.5,
                max=5)
            private$..color_palette <- jmvcore::OptionList$new(
                "color_palette",
                color_palette,
                options=list(
                    "viridis",
                    "plasma",
                    "inferno",
                    "magma",
                    "Set1",
                    "Set2",
                    "Dark2",
                    "Paired"),
                default="Set2")
            private$..theme_style <- jmvcore::OptionList$new(
                "theme_style",
                theme_style,
                options=list(
                    "theme_minimal",
                    "theme_classic",
                    "theme_gray",
                    "theme_bw",
                    "theme_void"),
                default="theme_minimal")
            private$..matrix_color <- jmvcore::OptionString$new(
                "matrix_color",
                matrix_color,
                default="black")
            private$..bar_color <- jmvcore::OptionString$new(
                "bar_color",
                bar_color,
                default="steelblue")
            private$..text_size <- jmvcore::OptionNumber$new(
                "text_size",
                text_size,
                default=12,
                min=8,
                max=20)
            private$..plot_title <- jmvcore::OptionString$new(
                "plot_title",
                plot_title,
                default="")
            private$..plot_subtitle <- jmvcore::OptionString$new(
                "plot_subtitle",
                plot_subtitle,
                default="")
            private$..show_statistics <- jmvcore::OptionBool$new(
                "show_statistics",
                show_statistics,
                default=TRUE)
            private$..show_interpretation <- jmvcore::OptionBool$new(
                "show_interpretation",
                show_interpretation,
                default=TRUE)
            private$..width_ratio <- jmvcore::OptionNumber$new(
                "width_ratio",
                width_ratio,
                default=0.3,
                min=0.1,
                max=0.9)
            private$..height_ratio <- jmvcore::OptionNumber$new(
                "height_ratio",
                height_ratio,
                default=0.7,
                min=0.1,
                max=0.9)

            self$.addOption(private$..set_vars)
            self$.addOption(private$..value_var)
            self$.addOption(private$..min_size)
            self$.addOption(private$..max_degree)
            self$.addOption(private$..sort_by)
            self$.addOption(private$..sort_order)
            self$.addOption(private$..keep_empty_groups)
            self$.addOption(private$..set_size_show)
            self$.addOption(private$..intersection_size_show)
            self$.addOption(private$..show_percentages)
            self$.addOption(private$..annotations)
            self$.addOption(private$..base_annotations_height)
            self$.addOption(private$..intersections_height)
            self$.addOption(private$..sets_width)
            self$.addOption(private$..color_palette)
            self$.addOption(private$..theme_style)
            self$.addOption(private$..matrix_color)
            self$.addOption(private$..bar_color)
            self$.addOption(private$..text_size)
            self$.addOption(private$..plot_title)
            self$.addOption(private$..plot_subtitle)
            self$.addOption(private$..show_statistics)
            self$.addOption(private$..show_interpretation)
            self$.addOption(private$..width_ratio)
            self$.addOption(private$..height_ratio)
        }),
    active = list(
        set_vars = function() private$..set_vars$value,
        value_var = function() private$..value_var$value,
        min_size = function() private$..min_size$value,
        max_degree = function() private$..max_degree$value,
        sort_by = function() private$..sort_by$value,
        sort_order = function() private$..sort_order$value,
        keep_empty_groups = function() private$..keep_empty_groups$value,
        set_size_show = function() private$..set_size_show$value,
        intersection_size_show = function() private$..intersection_size_show$value,
        show_percentages = function() private$..show_percentages$value,
        annotations = function() private$..annotations$value,
        base_annotations_height = function() private$..base_annotations_height$value,
        intersections_height = function() private$..intersections_height$value,
        sets_width = function() private$..sets_width$value,
        color_palette = function() private$..color_palette$value,
        theme_style = function() private$..theme_style$value,
        matrix_color = function() private$..matrix_color$value,
        bar_color = function() private$..bar_color$value,
        text_size = function() private$..text_size$value,
        plot_title = function() private$..plot_title$value,
        plot_subtitle = function() private$..plot_subtitle$value,
        show_statistics = function() private$..show_statistics$value,
        show_interpretation = function() private$..show_interpretation$value,
        width_ratio = function() private$..width_ratio$value,
        height_ratio = function() private$..height_ratio$value),
    private = list(
        ..set_vars = NA,
        ..value_var = NA,
        ..min_size = NA,
        ..max_degree = NA,
        ..sort_by = NA,
        ..sort_order = NA,
        ..keep_empty_groups = NA,
        ..set_size_show = NA,
        ..intersection_size_show = NA,
        ..show_percentages = NA,
        ..annotations = NA,
        ..base_annotations_height = NA,
        ..intersections_height = NA,
        ..sets_width = NA,
        ..color_palette = NA,
        ..theme_style = NA,
        ..matrix_color = NA,
        ..bar_color = NA,
        ..text_size = NA,
        ..plot_title = NA,
        ..plot_subtitle = NA,
        ..show_statistics = NA,
        ..show_interpretation = NA,
        ..width_ratio = NA,
        ..height_ratio = NA)
)

jcomplexupsetResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jcomplexupsetResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        plot = function() private$.items[["plot"]],
        statistics = function() private$.items[["statistics"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Complex UpSet Plot Results")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE,
                refs=list()))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot",
                title="UpSet Plot",
                width=1000,
                height=700,
                renderFun=".plot",
                requiresData=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="statistics",
                title="Set Statistics",
                visible="(show_statistics)",
                refs=list()))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Interpretation",
                visible="(show_interpretation)",
                refs=list()))}))

jcomplexupsetBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jcomplexupsetBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "jcomplexupset",
                version = c(1,0,0),
                options = options,
                results = jcomplexupsetResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Complex UpSet Plot Visualization
#'
#' 
#' @param data R object to use
#' @param set_vars Variables representing set membership (binary columns)
#' @param value_var Optional variable for weighting intersections
#' @param min_size Minimum size for intersections to be displayed
#' @param max_degree Maximum number of sets in intersection
#' @param sort_by Method for sorting intersections
#' @param sort_order Order for sorting intersections
#' @param keep_empty_groups Show intersections with zero size
#' @param set_size_show Display individual set sizes
#' @param intersection_size_show Display intersection size values
#' @param show_percentages Display percentages instead of counts
#' @param annotations Type of annotation to add
#' @param base_annotations_height Height of annotation panels
#' @param intersections_height Height of intersections panel
#' @param sets_width Width of sets panel
#' @param color_palette Color palette for visualization
#' @param theme_style ggplot2 theme style
#' @param matrix_color Color for intersection matrix dots
#' @param bar_color Color for bars in plots
#' @param text_size Size of text elements
#' @param plot_title Title for the plot
#' @param plot_subtitle Subtitle for the plot
#' @param show_statistics Display summary statistics
#' @param show_interpretation Display result interpretation
#' @param width_ratio Ratio of sets width to total width
#' @param height_ratio Ratio of intersections height to total height
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$statistics} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' @export
jcomplexupset <- function(
    data,
    set_vars,
    value_var = NULL,
    min_size = 0,
    max_degree = 4,
    sort_by = "cardinality",
    sort_order = "descending",
    keep_empty_groups = FALSE,
    set_size_show = TRUE,
    intersection_size_show = TRUE,
    show_percentages = FALSE,
    annotations = "intersection_size",
    base_annotations_height = 2,
    intersections_height = 3,
    sets_width = 2,
    color_palette = "Set2",
    theme_style = "theme_minimal",
    matrix_color = "black",
    bar_color = "steelblue",
    text_size = 12,
    plot_title = "",
    plot_subtitle = "",
    show_statistics = TRUE,
    show_interpretation = TRUE,
    width_ratio = 0.3,
    height_ratio = 0.7) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("jcomplexupset requires jmvcore to be installed (restart may be required)")

    if ( ! missing(set_vars)) set_vars <- jmvcore::resolveQuo(jmvcore::enquo(set_vars))
    if ( ! missing(value_var)) value_var <- jmvcore::resolveQuo(jmvcore::enquo(value_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(set_vars), set_vars, NULL),
            `if`( ! missing(value_var), value_var, NULL))

    for (v in set_vars) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- jcomplexupsetOptions$new(
        set_vars = set_vars,
        value_var = value_var,
        min_size = min_size,
        max_degree = max_degree,
        sort_by = sort_by,
        sort_order = sort_order,
        keep_empty_groups = keep_empty_groups,
        set_size_show = set_size_show,
        intersection_size_show = intersection_size_show,
        show_percentages = show_percentages,
        annotations = annotations,
        base_annotations_height = base_annotations_height,
        intersections_height = intersections_height,
        sets_width = sets_width,
        color_palette = color_palette,
        theme_style = theme_style,
        matrix_color = matrix_color,
        bar_color = bar_color,
        text_size = text_size,
        plot_title = plot_title,
        plot_subtitle = plot_subtitle,
        show_statistics = show_statistics,
        show_interpretation = show_interpretation,
        width_ratio = width_ratio,
        height_ratio = height_ratio)

    analysis <- jcomplexupsetClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

