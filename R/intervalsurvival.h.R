
# This file is automatically generated, you probably don't want to edit this

intervalsurvivalOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "intervalsurvivalOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            left_time = NULL,
            right_time = NULL,
            status_var = NULL,
            covariates = NULL,
            stratification_vars = NULL,
            model_type = "aft_weibull",
            estimation_method = "em_algorithm",
            confidence_level = 0.95,
            convergence_tolerance = 0.0001,
            max_iterations = 500,
            baseline_hazard_smooth = FALSE,
            smoothing_bandwidth = 1,
            survival_curves = TRUE,
            hazard_function = FALSE,
            model_diagnostics = TRUE,
            residual_analysis = TRUE,
            goodness_of_fit = TRUE,
            model_comparison = FALSE,
            prediction_times = "12,24,36,60",
            bootstrap_samples = 200,
            mcmc_iterations = 5000,
            mcmc_burnin = 1000,
            imputation_method = "midpoint", ...) {

            super$initialize(
                package="ClinicoPath",
                name="intervalsurvival",
                requiresData=FALSE,
                ...)

            private$..left_time <- jmvcore::OptionVariable$new(
                "left_time",
                left_time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..right_time <- jmvcore::OptionVariable$new(
                "right_time",
                right_time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..status_var <- jmvcore::OptionVariable$new(
                "status_var",
                status_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..stratification_vars <- jmvcore::OptionVariables$new(
                "stratification_vars",
                stratification_vars,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..model_type <- jmvcore::OptionList$new(
                "model_type",
                model_type,
                options=list(
                    "cox_ph",
                    "aft_weibull",
                    "aft_lognormal",
                    "aft_loglogistic",
                    "aft_exponential",
                    "aft_gamma",
                    "nonparametric"),
                default="aft_weibull")
            private$..estimation_method <- jmvcore::OptionList$new(
                "estimation_method",
                estimation_method,
                options=list(
                    "npmle",
                    "em_algorithm",
                    "newton_raphson",
                    "mcmc"),
                default="em_algorithm")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.8,
                max=0.99)
            private$..convergence_tolerance <- jmvcore::OptionNumber$new(
                "convergence_tolerance",
                convergence_tolerance,
                default=0.0001,
                min=0.00001,
                max=0.01)
            private$..max_iterations <- jmvcore::OptionInteger$new(
                "max_iterations",
                max_iterations,
                default=500,
                min=50,
                max=2000)
            private$..baseline_hazard_smooth <- jmvcore::OptionBool$new(
                "baseline_hazard_smooth",
                baseline_hazard_smooth,
                default=FALSE)
            private$..smoothing_bandwidth <- jmvcore::OptionNumber$new(
                "smoothing_bandwidth",
                smoothing_bandwidth,
                default=1,
                min=0.1,
                max=10)
            private$..survival_curves <- jmvcore::OptionBool$new(
                "survival_curves",
                survival_curves,
                default=TRUE)
            private$..hazard_function <- jmvcore::OptionBool$new(
                "hazard_function",
                hazard_function,
                default=FALSE)
            private$..model_diagnostics <- jmvcore::OptionBool$new(
                "model_diagnostics",
                model_diagnostics,
                default=TRUE)
            private$..residual_analysis <- jmvcore::OptionBool$new(
                "residual_analysis",
                residual_analysis,
                default=TRUE)
            private$..goodness_of_fit <- jmvcore::OptionBool$new(
                "goodness_of_fit",
                goodness_of_fit,
                default=TRUE)
            private$..model_comparison <- jmvcore::OptionBool$new(
                "model_comparison",
                model_comparison,
                default=FALSE)
            private$..prediction_times <- jmvcore::OptionString$new(
                "prediction_times",
                prediction_times,
                default="12,24,36,60")
            private$..bootstrap_samples <- jmvcore::OptionInteger$new(
                "bootstrap_samples",
                bootstrap_samples,
                default=200,
                min=50,
                max=1000)
            private$..mcmc_iterations <- jmvcore::OptionInteger$new(
                "mcmc_iterations",
                mcmc_iterations,
                default=5000,
                min=1000,
                max=20000)
            private$..mcmc_burnin <- jmvcore::OptionInteger$new(
                "mcmc_burnin",
                mcmc_burnin,
                default=1000,
                min=200,
                max=5000)
            private$..imputation_method <- jmvcore::OptionList$new(
                "imputation_method",
                imputation_method,
                options=list(
                    "midpoint",
                    "random",
                    "conditional_mean",
                    "multiple_imputation"),
                default="midpoint")

            self$.addOption(private$..left_time)
            self$.addOption(private$..right_time)
            self$.addOption(private$..status_var)
            self$.addOption(private$..covariates)
            self$.addOption(private$..stratification_vars)
            self$.addOption(private$..model_type)
            self$.addOption(private$..estimation_method)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..convergence_tolerance)
            self$.addOption(private$..max_iterations)
            self$.addOption(private$..baseline_hazard_smooth)
            self$.addOption(private$..smoothing_bandwidth)
            self$.addOption(private$..survival_curves)
            self$.addOption(private$..hazard_function)
            self$.addOption(private$..model_diagnostics)
            self$.addOption(private$..residual_analysis)
            self$.addOption(private$..goodness_of_fit)
            self$.addOption(private$..model_comparison)
            self$.addOption(private$..prediction_times)
            self$.addOption(private$..bootstrap_samples)
            self$.addOption(private$..mcmc_iterations)
            self$.addOption(private$..mcmc_burnin)
            self$.addOption(private$..imputation_method)
        }),
    active = list(
        left_time = function() private$..left_time$value,
        right_time = function() private$..right_time$value,
        status_var = function() private$..status_var$value,
        covariates = function() private$..covariates$value,
        stratification_vars = function() private$..stratification_vars$value,
        model_type = function() private$..model_type$value,
        estimation_method = function() private$..estimation_method$value,
        confidence_level = function() private$..confidence_level$value,
        convergence_tolerance = function() private$..convergence_tolerance$value,
        max_iterations = function() private$..max_iterations$value,
        baseline_hazard_smooth = function() private$..baseline_hazard_smooth$value,
        smoothing_bandwidth = function() private$..smoothing_bandwidth$value,
        survival_curves = function() private$..survival_curves$value,
        hazard_function = function() private$..hazard_function$value,
        model_diagnostics = function() private$..model_diagnostics$value,
        residual_analysis = function() private$..residual_analysis$value,
        goodness_of_fit = function() private$..goodness_of_fit$value,
        model_comparison = function() private$..model_comparison$value,
        prediction_times = function() private$..prediction_times$value,
        bootstrap_samples = function() private$..bootstrap_samples$value,
        mcmc_iterations = function() private$..mcmc_iterations$value,
        mcmc_burnin = function() private$..mcmc_burnin$value,
        imputation_method = function() private$..imputation_method$value),
    private = list(
        ..left_time = NA,
        ..right_time = NA,
        ..status_var = NA,
        ..covariates = NA,
        ..stratification_vars = NA,
        ..model_type = NA,
        ..estimation_method = NA,
        ..confidence_level = NA,
        ..convergence_tolerance = NA,
        ..max_iterations = NA,
        ..baseline_hazard_smooth = NA,
        ..smoothing_bandwidth = NA,
        ..survival_curves = NA,
        ..hazard_function = NA,
        ..model_diagnostics = NA,
        ..residual_analysis = NA,
        ..goodness_of_fit = NA,
        ..model_comparison = NA,
        ..prediction_times = NA,
        ..bootstrap_samples = NA,
        ..mcmc_iterations = NA,
        ..mcmc_burnin = NA,
        ..imputation_method = NA)
)

intervalsurvivalResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "intervalsurvivalResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        data_summary = function() private$.items[["data_summary"]],
        model_results = function() private$.items[["model_results"]],
        covariate_effects = function() private$.items[["covariate_effects"]],
        survival_estimates = function() private$.items[["survival_estimates"]],
        hazard_estimates = function() private$.items[["hazard_estimates"]],
        model_diagnostics_summary = function() private$.items[["model_diagnostics_summary"]],
        goodness_of_fit_results = function() private$.items[["goodness_of_fit_results"]],
        model_comparison_table = function() private$.items[["model_comparison_table"]],
        residual_summary = function() private$.items[["residual_summary"]],
        survival_curves_plot = function() private$.items[["survival_curves_plot"]],
        hazard_plot = function() private$.items[["hazard_plot"]],
        interval_plot = function() private$.items[["interval_plot"]],
        residual_plots = function() private$.items[["residual_plots"]],
        model_comparison_plot = function() private$.items[["model_comparison_plot"]],
        convergence_plot = function() private$.items[["convergence_plot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Interval-Censored Survival Analysis",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "stringr"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Analysis Instructions",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="data_summary",
                title="Interval-Censored Data Summary",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="model_results",
                title="Model Estimation Results",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="covariate_effects",
                title="Covariate Effects",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="survival_estimates",
                title="Survival Function Estimates",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="hazard_estimates",
                title="Hazard Function Estimates",
                visible="(hazard_function)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="model_diagnostics_summary",
                title="Model Diagnostics",
                visible="(model_diagnostics)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="goodness_of_fit_results",
                title="Goodness of Fit Tests",
                visible="(goodness_of_fit)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="model_comparison_table",
                title="Model Comparison",
                visible="(model_comparison)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="residual_summary",
                title="Residual Analysis",
                visible="(residual_analysis)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="survival_curves_plot",
                title="Survival Probability Curves",
                width=800,
                height=600,
                renderFun=".plot_survival_curves",
                visible="(survival_curves)",
                clearWith=list(
                    "left_time",
                    "right_time",
                    "model_type",
                    "covariates")))
            self$add(jmvcore::Image$new(
                options=options,
                name="hazard_plot",
                title="Hazard Function Plot",
                width=800,
                height=600,
                renderFun=".plot_hazard_function",
                visible="(hazard_function)",
                clearWith=list(
                    "left_time",
                    "right_time",
                    "model_type",
                    "baseline_hazard_smooth")))
            self$add(jmvcore::Image$new(
                options=options,
                name="interval_plot",
                title="Interval Censoring Visualization",
                width=800,
                height=600,
                renderFun=".plot_intervals",
                visible=TRUE,
                clearWith=list(
                    "left_time",
                    "right_time",
                    "status_var")))
            self$add(jmvcore::Image$new(
                options=options,
                name="residual_plots",
                title="Residual Diagnostic Plots",
                width=800,
                height=600,
                renderFun=".plot_residuals",
                visible="(residual_analysis)",
                clearWith=list(
                    "model_type",
                    "covariates",
                    "estimation_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="model_comparison_plot",
                title="Model Comparison Visualization",
                width=800,
                height=600,
                renderFun=".plot_model_comparison",
                visible="(model_comparison)",
                clearWith=list(
                    "left_time",
                    "right_time",
                    "covariates")))
            self$add(jmvcore::Image$new(
                options=options,
                name="convergence_plot",
                title="Convergence Diagnostics",
                width=800,
                height=600,
                renderFun=".plot_convergence",
                visible="(estimation_method == 'mcmc')",
                clearWith=list(
                    "mcmc_iterations",
                    "mcmc_burnin",
                    "convergence_tolerance")))}))

intervalsurvivalBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "intervalsurvivalBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "intervalsurvival",
                version = c(0,0,3),
                options = options,
                results = intervalsurvivalResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'na')
        }))

#' Interval-Censored Survival Analysis
#'
#' Interval-censored survival analysis for data where the exact event time 
#' is unknown but falls within an interval. Common in periodic follow-up 
#' studies, screening programs, and clinical trials with scheduled visits.
#' 
#'
#' @examples
#' # Example: Tumor progression between visits
#' intervalsurvival(
#'     data = oncology_data,
#'     left_time = last_negative_visit,
#'     right_time = first_positive_visit,
#'     covariates = c("age", "stage", "treatment"),
#'     model_type = "aft_weibull"
#' )
#'
#' @param left_time Left boundary of the censoring interval
#' @param right_time Right boundary of the censoring interval
#' @param status_var Censoring status indicator variable
#' @param covariates Covariates to include in the survival model
#' @param stratification_vars Variables for stratifying the baseline hazard
#' @param model_type Model specification for interval-censored survival
#' @param estimation_method Method for parameter estimation
#' @param confidence_level Confidence level for parameter estimates
#' @param convergence_tolerance Convergence criterion for iterative algorithms
#' @param max_iterations Maximum number of algorithm iterations
#' @param baseline_hazard_smooth Whether to smooth the baseline hazard
#'   function
#' @param smoothing_bandwidth Bandwidth for baseline hazard smoothing
#' @param survival_curves Whether to plot survival curves
#' @param hazard_function Whether to plot hazard functions
#' @param model_diagnostics Whether to include model diagnostics
#' @param residual_analysis Whether to perform residual analysis
#' @param goodness_of_fit Whether to test model goodness-of-fit
#' @param model_comparison Whether to compare multiple models
#' @param prediction_times Time points for survival probability predictions
#' @param bootstrap_samples Number of bootstrap resamples
#' @param mcmc_iterations MCMC sampling iterations
#' @param mcmc_burnin MCMC burn-in period
#' @param imputation_method Imputation approach for incomplete intervals
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$data_summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$model_results} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$covariate_effects} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$survival_estimates} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$hazard_estimates} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$model_diagnostics_summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$goodness_of_fit_results} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$model_comparison_table} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$residual_summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$survival_curves_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$hazard_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$interval_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$residual_plots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$model_comparison_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$convergence_plot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' @export
intervalsurvival <- function(
    left_time,
    right_time,
    status_var = NULL,
    covariates = NULL,
    stratification_vars = NULL,
    model_type = "aft_weibull",
    estimation_method = "em_algorithm",
    confidence_level = 0.95,
    convergence_tolerance = 0.0001,
    max_iterations = 500,
    baseline_hazard_smooth = FALSE,
    smoothing_bandwidth = 1,
    survival_curves = TRUE,
    hazard_function = FALSE,
    model_diagnostics = TRUE,
    residual_analysis = TRUE,
    goodness_of_fit = TRUE,
    model_comparison = FALSE,
    prediction_times = "12,24,36,60",
    bootstrap_samples = 200,
    mcmc_iterations = 5000,
    mcmc_burnin = 1000,
    imputation_method = "midpoint") {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("intervalsurvival requires jmvcore to be installed (restart may be required)")

    if ( ! missing(left_time)) left_time <- jmvcore::resolveQuo(jmvcore::enquo(left_time))
    if ( ! missing(right_time)) right_time <- jmvcore::resolveQuo(jmvcore::enquo(right_time))
    if ( ! missing(status_var)) status_var <- jmvcore::resolveQuo(jmvcore::enquo(status_var))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(stratification_vars)) stratification_vars <- jmvcore::resolveQuo(jmvcore::enquo(stratification_vars))

    options <- intervalsurvivalOptions$new(
        left_time = left_time,
        right_time = right_time,
        status_var = status_var,
        covariates = covariates,
        stratification_vars = stratification_vars,
        model_type = model_type,
        estimation_method = estimation_method,
        confidence_level = confidence_level,
        convergence_tolerance = convergence_tolerance,
        max_iterations = max_iterations,
        baseline_hazard_smooth = baseline_hazard_smooth,
        smoothing_bandwidth = smoothing_bandwidth,
        survival_curves = survival_curves,
        hazard_function = hazard_function,
        model_diagnostics = model_diagnostics,
        residual_analysis = residual_analysis,
        goodness_of_fit = goodness_of_fit,
        model_comparison = model_comparison,
        prediction_times = prediction_times,
        bootstrap_samples = bootstrap_samples,
        mcmc_iterations = mcmc_iterations,
        mcmc_burnin = mcmc_burnin,
        imputation_method = imputation_method)

    analysis <- intervalsurvivalClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

