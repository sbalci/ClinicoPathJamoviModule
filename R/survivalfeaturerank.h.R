
# This file is automatically generated, you probably don't want to edit this

survivalfeaturerankOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "survivalfeaturerankOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            survtime = NULL,
            event = NULL,
            eventLevel = NULL,
            features = NULL,
            rankBy = "pvalue",
            showCI = TRUE,
            adjustPValues = FALSE,
            adjustMethod = "fdr",
            showForestPlot = TRUE,
            forestStyle = "standard",
            showTopKM = FALSE,
            topN = 5,
            kmLayout = "separate",
            endplot = 60,
            byplot = 12,
            risktable = FALSE,
            pplot = TRUE,
            showSummary = TRUE,
            alphaLevel = 0.05,
            showFullTable = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="survivalfeaturerank",
                requiresData=TRUE,
                ...)

            private$..survtime <- jmvcore::OptionVariable$new(
                "survtime",
                survtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..event <- jmvcore::OptionVariable$new(
                "event",
                event,
                suggested=list(
                    "ordinal",
                    "nominal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..eventLevel <- jmvcore::OptionLevel$new(
                "eventLevel",
                eventLevel,
                variable="(event)")
            private$..features <- jmvcore::OptionVariables$new(
                "features",
                features,
                suggested=list(
                    "ordinal",
                    "nominal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..rankBy <- jmvcore::OptionList$new(
                "rankBy",
                rankBy,
                options=list(
                    "pvalue",
                    "hazard",
                    "cindex"),
                default="pvalue")
            private$..showCI <- jmvcore::OptionBool$new(
                "showCI",
                showCI,
                default=TRUE)
            private$..adjustPValues <- jmvcore::OptionBool$new(
                "adjustPValues",
                adjustPValues,
                default=FALSE)
            private$..adjustMethod <- jmvcore::OptionList$new(
                "adjustMethod",
                adjustMethod,
                options=list(
                    "fdr",
                    "bonferroni",
                    "holm",
                    "by"),
                default="fdr")
            private$..showForestPlot <- jmvcore::OptionBool$new(
                "showForestPlot",
                showForestPlot,
                default=TRUE)
            private$..forestStyle <- jmvcore::OptionList$new(
                "forestStyle",
                forestStyle,
                options=list(
                    "standard",
                    "compact",
                    "publication"),
                default="standard")
            private$..showTopKM <- jmvcore::OptionBool$new(
                "showTopKM",
                showTopKM,
                default=FALSE)
            private$..topN <- jmvcore::OptionInteger$new(
                "topN",
                topN,
                default=5,
                min=1,
                max=20)
            private$..kmLayout <- jmvcore::OptionList$new(
                "kmLayout",
                kmLayout,
                options=list(
                    "separate",
                    "faceted"),
                default="separate")
            private$..endplot <- jmvcore::OptionInteger$new(
                "endplot",
                endplot,
                default=60)
            private$..byplot <- jmvcore::OptionInteger$new(
                "byplot",
                byplot,
                default=12)
            private$..risktable <- jmvcore::OptionBool$new(
                "risktable",
                risktable,
                default=FALSE)
            private$..pplot <- jmvcore::OptionBool$new(
                "pplot",
                pplot,
                default=TRUE)
            private$..showSummary <- jmvcore::OptionBool$new(
                "showSummary",
                showSummary,
                default=TRUE)
            private$..alphaLevel <- jmvcore::OptionNumber$new(
                "alphaLevel",
                alphaLevel,
                default=0.05,
                min=0.001,
                max=0.1)
            private$..showFullTable <- jmvcore::OptionBool$new(
                "showFullTable",
                showFullTable,
                default=TRUE)
            private$..exportRanking <- jmvcore::OptionOutput$new(
                "exportRanking")

            self$.addOption(private$..survtime)
            self$.addOption(private$..event)
            self$.addOption(private$..eventLevel)
            self$.addOption(private$..features)
            self$.addOption(private$..rankBy)
            self$.addOption(private$..showCI)
            self$.addOption(private$..adjustPValues)
            self$.addOption(private$..adjustMethod)
            self$.addOption(private$..showForestPlot)
            self$.addOption(private$..forestStyle)
            self$.addOption(private$..showTopKM)
            self$.addOption(private$..topN)
            self$.addOption(private$..kmLayout)
            self$.addOption(private$..endplot)
            self$.addOption(private$..byplot)
            self$.addOption(private$..risktable)
            self$.addOption(private$..pplot)
            self$.addOption(private$..showSummary)
            self$.addOption(private$..alphaLevel)
            self$.addOption(private$..showFullTable)
            self$.addOption(private$..exportRanking)
        }),
    active = list(
        survtime = function() private$..survtime$value,
        event = function() private$..event$value,
        eventLevel = function() private$..eventLevel$value,
        features = function() private$..features$value,
        rankBy = function() private$..rankBy$value,
        showCI = function() private$..showCI$value,
        adjustPValues = function() private$..adjustPValues$value,
        adjustMethod = function() private$..adjustMethod$value,
        showForestPlot = function() private$..showForestPlot$value,
        forestStyle = function() private$..forestStyle$value,
        showTopKM = function() private$..showTopKM$value,
        topN = function() private$..topN$value,
        kmLayout = function() private$..kmLayout$value,
        endplot = function() private$..endplot$value,
        byplot = function() private$..byplot$value,
        risktable = function() private$..risktable$value,
        pplot = function() private$..pplot$value,
        showSummary = function() private$..showSummary$value,
        alphaLevel = function() private$..alphaLevel$value,
        showFullTable = function() private$..showFullTable$value,
        exportRanking = function() private$..exportRanking$value),
    private = list(
        ..survtime = NA,
        ..event = NA,
        ..eventLevel = NA,
        ..features = NA,
        ..rankBy = NA,
        ..showCI = NA,
        ..adjustPValues = NA,
        ..adjustMethod = NA,
        ..showForestPlot = NA,
        ..forestStyle = NA,
        ..showTopKM = NA,
        ..topN = NA,
        ..kmLayout = NA,
        ..endplot = NA,
        ..byplot = NA,
        ..risktable = NA,
        ..pplot = NA,
        ..showSummary = NA,
        ..alphaLevel = NA,
        ..showFullTable = NA,
        ..exportRanking = NA)
)

survivalfeaturerankResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "survivalfeaturerankResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        summaryText = function() private$.items[["summaryText"]],
        rankingTable = function() private$.items[["rankingTable"]],
        forestPlot = function() private$.items[["forestPlot"]],
        topFeaturesHeading = function() private$.items[["topFeaturesHeading"]],
        kmPlot1 = function() private$.items[["kmPlot1"]],
        kmPlot2 = function() private$.items[["kmPlot2"]],
        kmPlot3 = function() private$.items[["kmPlot3"]],
        kmPlot4 = function() private$.items[["kmPlot4"]],
        kmPlot5 = function() private$.items[["kmPlot5"]],
        kmPlot6 = function() private$.items[["kmPlot6"]],
        kmPlot7 = function() private$.items[["kmPlot7"]],
        kmPlot8 = function() private$.items[["kmPlot8"]],
        kmPlot9 = function() private$.items[["kmPlot9"]],
        kmPlot10 = function() private$.items[["kmPlot10"]],
        exportRanking = function() private$.items[["exportRanking"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Survival Feature Ranking",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "survival",
                    "urvminer",
                    "survival",
                    "glue",
                    "survminer"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible="(features)",
                refs=list(
                    "ClinicoPathJamoviModule")))
            self$add(jmvcore::Preformatted$new(
                options=options,
                name="summaryText",
                title="Summary",
                visible="(showSummary)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="rankingTable",
                title="Feature Ranking Results",
                clearWith=list(
                    "survtime",
                    "event",
                    "eventLevel",
                    "features",
                    "rankBy",
                    "adjustPValues",
                    "adjustMethod"),
                columns=list(
                    list(
                        `name`="rank", 
                        `title`="Rank", 
                        `type`="integer", 
                        `visible`=TRUE),
                    list(
                        `name`="feature", 
                        `title`="Feature", 
                        `type`="text"),
                    list(
                        `name`="type", 
                        `title`="Type", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="hr", 
                        `title`="HR", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(showCI)"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(showCI)"),
                    list(
                        `name`="ci_text", 
                        `title`="95% CI", 
                        `type`="text", 
                        `visible`="(showCI)"),
                    list(
                        `name`="pvalue", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="adj_pvalue", 
                        `title`="Adjusted p", 
                        `type`="number", 
                        `format`="zto,pvalue", 
                        `visible`="(adjustPValues)"),
                    list(
                        `name`="cindex", 
                        `title`="C-index", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cindex_se", 
                        `title`="C-index SE", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`=FALSE),
                    list(
                        `name`="significant", 
                        `title`="Sig.", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="forestPlot",
                title="Forest Plot of All Features",
                width=700,
                height=500,
                renderFun=".forestPlot",
                visible="(showForestPlot)",
                requiresData=TRUE,
                clearWith=list(
                    "features",
                    "rankBy",
                    "forestStyle")))
            self$add(jmvcore::Html$new(
                options=options,
                name="topFeaturesHeading",
                title="Top Ranked Features - Kaplan-Meier Curves",
                visible="(showTopKM)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="kmPlot1",
                title="",
                width=600,
                height=500,
                renderFun=".kmPlot1",
                visible="(showTopKM)",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="kmPlot2",
                title="",
                width=600,
                height=500,
                renderFun=".kmPlot2",
                visible="(showTopKM)",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="kmPlot3",
                title="",
                width=600,
                height=500,
                renderFun=".kmPlot3",
                visible="(showTopKM)",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="kmPlot4",
                title="",
                width=600,
                height=500,
                renderFun=".kmPlot4",
                visible="(showTopKM)",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="kmPlot5",
                title="",
                width=600,
                height=500,
                renderFun=".kmPlot5",
                visible="(showTopKM)",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="kmPlot6",
                title="",
                width=600,
                height=500,
                renderFun=".kmPlot6",
                visible="(showTopKM)",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="kmPlot7",
                title="",
                width=600,
                height=500,
                renderFun=".kmPlot7",
                visible="(showTopKM)",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="kmPlot8",
                title="",
                width=600,
                height=500,
                renderFun=".kmPlot8",
                visible="(showTopKM)",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="kmPlot9",
                title="",
                width=600,
                height=500,
                renderFun=".kmPlot9",
                visible="(showTopKM)",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="kmPlot10",
                title="",
                width=600,
                height=500,
                renderFun=".kmPlot10",
                visible="(showTopKM)",
                requiresData=TRUE))
            self$add(jmvcore::Output$new(
                options=options,
                name="exportRanking",
                title="Feature Rankings",
                varTitle="`Feature_Rank`",
                varDescription="Exported feature ranking results",
                clearWith=list(
                    "features")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Interpretation Guide",
                visible=TRUE,
                refs=list(
                    "ClinicoPathJamoviModule")))}))

survivalfeaturerankBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "survivalfeaturerankBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "survivalfeaturerank",
                version = c(0,0,31),
                options = options,
                results = survivalfeaturerankResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'none')
        }))

#' Survival Feature Ranking
#'
#' Performs univariate survival analysis for multiple features to identify 
#' potential prognostic factors. This analysis runs a separate Cox 
#' proportional hazards model for each selected feature and ranks them by 
#' statistical significance, hazard ratio, or concordance index. Useful for 
#' biomarker screening, exploratory analysis, and feature selection before 
#' building multivariable models.
#'
#' @examples
#' # Example 1: Basic feature ranking
#' library(survival)
#' data(colon)
#'
#' survivalfeaturerank(
#'     data = colon,
#'     survtime = "time",
#'     event = "status",
#'     eventLevel = "1",
#'     features = c("sex", "obstruct", "perfor", "adhere", "nodes", "differ"),
#'     rankBy = "pvalue"
#' )
#'
#' # Example 2: Rank by hazard ratio with plots
#' survivalfeaturerank(
#'     data = colon,
#'     survtime = "time",
#'     event = "status",
#'     eventLevel = "1",
#'     features = c("sex", "obstruct", "perfor", "age", "nodes"),
#'     rankBy = "hazard",
#'     showForestPlot = TRUE,
#'     showTopKM = TRUE,
#'     topN = 3
#' )
#'
#' # Example 3: Rank by C-index for predictive power
#' survivalfeaturerank(
#'     data = colon,
#'     survtime = "time",
#'     event = "status",
#'     eventLevel = "1",
#'     features = c("age", "nodes", "extent", "surg"),
#'     rankBy = "cindex",
#'     showCI = TRUE,
#'     adjustPValues = TRUE,
#'     adjustMethod = "fdr"
#' )
#'
#' @param data The dataset to be analyzed, provided as a data frame.
#' @param survtime The numeric variable representing follow-up time until the
#'   event or censoring.
#' @param event The event indicator variable (e.g., death, recurrence). Should
#'   be coded as 1 = event, 0 = censored, or as a factor where one level
#'   represents the event.
#' @param eventLevel The level of the event variable that represents the event
#'   of interest. For numeric variables, typically "1". For factors, select the
#'   appropriate level.
#' @param features Variables to be tested individually for association with
#'   survival. Each variable will be tested in a separate univariate Cox model.
#'   Can include both categorical and continuous variables.
#' @param rankBy Criterion for ranking features: - pvalue: Sorts by
#'   statistical significance (smallest p-value first) - hazard: Sorts by effect
#'   size (hazard ratio furthest from 1) - cindex: Sorts by discriminative
#'   ability (highest C-index first)
#' @param showCI If true, displays 95\% confidence intervals for hazard ratios
#'   in the results table.
#' @param adjustPValues If true, applies multiple testing correction to
#'   p-values. Recommended when testing many features to control false discovery
#'   rate.
#' @param adjustMethod Method for p-value adjustment. FDR (Benjamini-Hochberg)
#'   is recommended for exploratory analysis. Bonferroni is most conservative.
#' @param showForestPlot If true, generates a forest plot showing hazard
#'   ratios and confidence intervals for all features, sorted by the ranking
#'   criterion.
#' @param forestStyle Visual style for the forest plot.
#' @param showTopKM If true, generates Kaplan-Meier survival curves for the
#'   top-ranked features. Useful for visualizing the survival differences for
#'   the most important predictors.
#' @param topN Number of top-ranked features for which to generate
#'   Kaplan-Meier plots. Only used if "Show Kaplan-Meier Plots for Top Features"
#'   is enabled.
#' @param kmLayout Layout for multiple Kaplan-Meier plots. Separate shows one
#'   plot per feature, faceted shows all in a grid.
#' @param endplot Maximum follow-up time to display on Kaplan-Meier plots.
#' @param byplot Interval for time axis labels on plots.
#' @param risktable If true, displays the number at risk below Kaplan-Meier
#'   plots.
#' @param pplot If true, displays log-rank test p-values on Kaplan-Meier
#'   plots.
#' @param showSummary If true, displays summary statistics including total
#'   number of features tested, number of significant features, and
#'   interpretation guidance.
#' @param alphaLevel Significance level for highlighting significant features
#'   in the results table.
#' @param showFullTable If true, shows results for all tested features. If
#'   false, shows only statistically significant features.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summaryText} \tab \tab \tab \tab \tab a preformatted \cr
#'   \code{results$rankingTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$forestPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$topFeaturesHeading} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$kmPlot1} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$kmPlot2} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$kmPlot3} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$kmPlot4} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$kmPlot5} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$kmPlot6} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$kmPlot7} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$kmPlot8} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$kmPlot9} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$kmPlot10} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$exportRanking} \tab \tab \tab \tab \tab an output \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$rankingTable$asDF}
#'
#' \code{as.data.frame(results$rankingTable)}
#'
#' @export
survivalfeaturerank <- function(
    data,
    survtime = NULL,
    event = NULL,
    eventLevel,
    features = NULL,
    rankBy = "pvalue",
    showCI = TRUE,
    adjustPValues = FALSE,
    adjustMethod = "fdr",
    showForestPlot = TRUE,
    forestStyle = "standard",
    showTopKM = FALSE,
    topN = 5,
    kmLayout = "separate",
    endplot = 60,
    byplot = 12,
    risktable = FALSE,
    pplot = TRUE,
    showSummary = TRUE,
    alphaLevel = 0.05,
    showFullTable = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("survivalfeaturerank requires jmvcore to be installed (restart may be required)")

    if ( ! missing(survtime)) survtime <- jmvcore::resolveQuo(jmvcore::enquo(survtime))
    if ( ! missing(event)) event <- jmvcore::resolveQuo(jmvcore::enquo(event))
    if ( ! missing(features)) features <- jmvcore::resolveQuo(jmvcore::enquo(features))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(survtime), survtime, NULL),
            `if`( ! missing(event), event, NULL),
            `if`( ! missing(features), features, NULL))


    options <- survivalfeaturerankOptions$new(
        survtime = survtime,
        event = event,
        eventLevel = eventLevel,
        features = features,
        rankBy = rankBy,
        showCI = showCI,
        adjustPValues = adjustPValues,
        adjustMethod = adjustMethod,
        showForestPlot = showForestPlot,
        forestStyle = forestStyle,
        showTopKM = showTopKM,
        topN = topN,
        kmLayout = kmLayout,
        endplot = endplot,
        byplot = byplot,
        risktable = risktable,
        pplot = pplot,
        showSummary = showSummary,
        alphaLevel = alphaLevel,
        showFullTable = showFullTable)

    analysis <- survivalfeaturerankClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

