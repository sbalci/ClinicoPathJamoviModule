
# This file is automatically generated, you probably don't want to edit this

modelvalOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "modelvalOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            outcome = NULL,
            predicted = NULL,
            validationType = "general",
            subgroup = NULL,
            showCalibrationLarge = TRUE,
            showCalibrationSlope = TRUE,
            showFlexibleCalibration = TRUE,
            calibrationGroups = 10,
            showDiscrimination = TRUE,
            showNetBenefit = TRUE,
            thresholdRange = "0.01, 0.99",
            showSubgroupAnalysis = FALSE,
            ciLevel = 0.95, ...) {

            super$initialize(
                package="ClinicoPath",
                name="modelval",
                requiresData=TRUE,
                ...)

            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..predicted <- jmvcore::OptionVariable$new(
                "predicted",
                predicted,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..validationType <- jmvcore::OptionList$new(
                "validationType",
                validationType,
                options=list(
                    "external",
                    "temporal",
                    "geographic",
                    "general"),
                default="general")
            private$..subgroup <- jmvcore::OptionVariable$new(
                "subgroup",
                subgroup,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..showCalibrationLarge <- jmvcore::OptionBool$new(
                "showCalibrationLarge",
                showCalibrationLarge,
                default=TRUE)
            private$..showCalibrationSlope <- jmvcore::OptionBool$new(
                "showCalibrationSlope",
                showCalibrationSlope,
                default=TRUE)
            private$..showFlexibleCalibration <- jmvcore::OptionBool$new(
                "showFlexibleCalibration",
                showFlexibleCalibration,
                default=TRUE)
            private$..calibrationGroups <- jmvcore::OptionInteger$new(
                "calibrationGroups",
                calibrationGroups,
                default=10,
                min=5,
                max=20)
            private$..showDiscrimination <- jmvcore::OptionBool$new(
                "showDiscrimination",
                showDiscrimination,
                default=TRUE)
            private$..showNetBenefit <- jmvcore::OptionBool$new(
                "showNetBenefit",
                showNetBenefit,
                default=TRUE)
            private$..thresholdRange <- jmvcore::OptionString$new(
                "thresholdRange",
                thresholdRange,
                default="0.01, 0.99")
            private$..showSubgroupAnalysis <- jmvcore::OptionBool$new(
                "showSubgroupAnalysis",
                showSubgroupAnalysis,
                default=FALSE)
            private$..ciLevel <- jmvcore::OptionNumber$new(
                "ciLevel",
                ciLevel,
                default=0.95,
                min=0.8,
                max=0.99)

            self$.addOption(private$..outcome)
            self$.addOption(private$..predicted)
            self$.addOption(private$..validationType)
            self$.addOption(private$..subgroup)
            self$.addOption(private$..showCalibrationLarge)
            self$.addOption(private$..showCalibrationSlope)
            self$.addOption(private$..showFlexibleCalibration)
            self$.addOption(private$..calibrationGroups)
            self$.addOption(private$..showDiscrimination)
            self$.addOption(private$..showNetBenefit)
            self$.addOption(private$..thresholdRange)
            self$.addOption(private$..showSubgroupAnalysis)
            self$.addOption(private$..ciLevel)
        }),
    active = list(
        outcome = function() private$..outcome$value,
        predicted = function() private$..predicted$value,
        validationType = function() private$..validationType$value,
        subgroup = function() private$..subgroup$value,
        showCalibrationLarge = function() private$..showCalibrationLarge$value,
        showCalibrationSlope = function() private$..showCalibrationSlope$value,
        showFlexibleCalibration = function() private$..showFlexibleCalibration$value,
        calibrationGroups = function() private$..calibrationGroups$value,
        showDiscrimination = function() private$..showDiscrimination$value,
        showNetBenefit = function() private$..showNetBenefit$value,
        thresholdRange = function() private$..thresholdRange$value,
        showSubgroupAnalysis = function() private$..showSubgroupAnalysis$value,
        ciLevel = function() private$..ciLevel$value),
    private = list(
        ..outcome = NA,
        ..predicted = NA,
        ..validationType = NA,
        ..subgroup = NA,
        ..showCalibrationLarge = NA,
        ..showCalibrationSlope = NA,
        ..showFlexibleCalibration = NA,
        ..calibrationGroups = NA,
        ..showDiscrimination = NA,
        ..showNetBenefit = NA,
        ..thresholdRange = NA,
        ..showSubgroupAnalysis = NA,
        ..ciLevel = NA)
)

modelvalResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "modelvalResults",
    inherit = jmvcore::Group,
    active = list(
        validationSummary = function() private$.items[["validationSummary"]],
        calibrationMetrics = function() private$.items[["calibrationMetrics"]],
        discriminationMetrics = function() private$.items[["discriminationMetrics"]],
        netBenefitSummary = function() private$.items[["netBenefitSummary"]],
        subgroupPerformance = function() private$.items[["subgroupPerformance"]],
        calibrationPlot = function() private$.items[["calibrationPlot"]],
        rocPlot = function() private$.items[["rocPlot"]],
        dcaPlot = function() private$.items[["dcaPlot"]],
        subgroupCalibrationPlot = function() private$.items[["subgroupCalibrationPlot"]],
        recommendations = function() private$.items[["recommendations"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Model Validation Dashboard",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "pROC",
                    "rms",
                    "dcurves"))
            self$add(jmvcore::Html$new(
                options=options,
                name="validationSummary",
                title="Validation Summary"))
            self$add(jmvcore::Table$new(
                options=options,
                name="calibrationMetrics",
                title="Calibration Metrics",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="ciLower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="ciUpper", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="discriminationMetrics",
                title="Discrimination Metrics",
                visible="(showDiscrimination)",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="ciLower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="ciUpper", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="netBenefitSummary",
                title="Net Benefit Summary",
                visible="(showNetBenefit)",
                columns=list(
                    list(
                        `name`="threshold", 
                        `title`="Threshold", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="netBenefit", 
                        `title`="Net Benefit", 
                        `type`="number"),
                    list(
                        `name`="treatAll", 
                        `title`="Treat All", 
                        `type`="number"),
                    list(
                        `name`="treatNone", 
                        `title`="Treat None", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="subgroupPerformance",
                title="Subgroup Performance",
                visible="(showSubgroupAnalysis && subgroup)",
                columns=list(
                    list(
                        `name`="subgroup", 
                        `title`="Subgroup", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="auc", 
                        `title`="AUC", 
                        `type`="number"),
                    list(
                        `name`="brier", 
                        `title`="Brier", 
                        `type`="number"),
                    list(
                        `name`="calSlope", 
                        `title`="Cal. Slope", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="calibrationPlot",
                title="Calibration Plot",
                width=600,
                height=600,
                renderFun=".calibrationPlot",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="rocPlot",
                title="ROC Curve",
                width=500,
                height=500,
                renderFun=".rocPlot",
                visible="(showDiscrimination)",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="dcaPlot",
                title="Decision Curve Analysis",
                width=600,
                height=500,
                renderFun=".dcaPlot",
                visible="(showNetBenefit)",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="subgroupCalibrationPlot",
                title="Calibration by Subgroup",
                width=700,
                height=600,
                renderFun=".subgroupCalibrationPlot",
                visible="(showSubgroupAnalysis && subgroup)",
                requiresData=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="recommendations",
                title="Validation Recommendations"))}))

modelvalBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "modelvalBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "modelval",
                version = c(0,0,32),
                options = options,
                results = modelvalResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = TRUE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Model Validation Dashboard
#'
#' Comprehensive validation dashboard for clinical prediction models. Assess 
#' calibration, discrimination, and clinical utility using predicted 
#' probabilities from existing models. Supports external validation, temporal 
#' validation, and subgroup analysis.
#' 
#'
#' @examples
#' # Example usage:
#' # data <- your_data
#' # ClinicoPath::modelval(
#' #   data = data,
#' #   outcome = "disease",
#' #   predicted = "risk_score",
#' #   validationType = "external",
#' #   subgroup = "hospital"
#' # )
#'
#' @param data The data as a data frame.
#' @param outcome Binary outcome variable (observed events: yes/no).
#' @param predicted Predicted probabilities from the existing model (0-1
#'   scale).
#' @param validationType Type of validation being performed.
#' @param subgroup Variable for subgroup analysis (e.g., hospital, time
#'   period, sex).
#' @param showCalibrationLarge Test if predicted probabilities are
#'   systematically too high or low.
#' @param showCalibrationSlope Assess if model predictions are too extreme
#'   (slope != 1).
#' @param showFlexibleCalibration Display smooth calibration curve using
#'   loess/splines.
#' @param calibrationGroups Number of groups for calibration plot (typically
#'   10).
#' @param showDiscrimination Display AUC, Brier score, and scaled Brier score.
#' @param showNetBenefit Perform decision curve analysis for clinical utility.
#' @param thresholdRange Min and max threshold probabilities
#'   (comma-separated).
#' @param showSubgroupAnalysis Compare model performance across subgroups.
#' @param ciLevel Confidence level for intervals (0.80-0.99).
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$validationSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$calibrationMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$discriminationMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$netBenefitSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$subgroupPerformance} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$calibrationPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$rocPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$dcaPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$subgroupCalibrationPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$recommendations} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$calibrationMetrics$asDF}
#'
#' \code{as.data.frame(results$calibrationMetrics)}
#'
#' @export
modelval <- function(
    data,
    outcome,
    predicted,
    validationType = "general",
    subgroup,
    showCalibrationLarge = TRUE,
    showCalibrationSlope = TRUE,
    showFlexibleCalibration = TRUE,
    calibrationGroups = 10,
    showDiscrimination = TRUE,
    showNetBenefit = TRUE,
    thresholdRange = "0.01, 0.99",
    showSubgroupAnalysis = FALSE,
    ciLevel = 0.95) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("modelval requires jmvcore to be installed (restart may be required)")

    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(predicted)) predicted <- jmvcore::resolveQuo(jmvcore::enquo(predicted))
    if ( ! missing(subgroup)) subgroup <- jmvcore::resolveQuo(jmvcore::enquo(subgroup))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(predicted), predicted, NULL),
            `if`( ! missing(subgroup), subgroup, NULL))

    for (v in outcome) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in subgroup) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- modelvalOptions$new(
        outcome = outcome,
        predicted = predicted,
        validationType = validationType,
        subgroup = subgroup,
        showCalibrationLarge = showCalibrationLarge,
        showCalibrationSlope = showCalibrationSlope,
        showFlexibleCalibration = showFlexibleCalibration,
        calibrationGroups = calibrationGroups,
        showDiscrimination = showDiscrimination,
        showNetBenefit = showNetBenefit,
        thresholdRange = thresholdRange,
        showSubgroupAnalysis = showSubgroupAnalysis,
        ciLevel = ciLevel)

    analysis <- modelvalClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

