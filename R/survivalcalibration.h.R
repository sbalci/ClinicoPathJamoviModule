
# This file is automatically generated, you probably don't want to edit this

survivalcalibrationOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "survivalcalibrationOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            event = NULL,
            predicted = NULL,
            linearPredictor = NULL,
            validationSet = NULL,
            calibrationTime = 60,
            calibrationTimes = "12,36,60",
            nGroups = 10,
            validationMethod = "bootstrap",
            nBootstrap = 100,
            nFolds = 10,
            showCalibrationPlot = TRUE,
            showCindexPlot = TRUE,
            showBrierPlot = TRUE,
            showGroupedCalibration = TRUE,
            smoothCalibration = TRUE,
            ciLevel = 0.95,
            tripodReport = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="survivalcalibration",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event <- jmvcore::OptionVariable$new(
                "event",
                event,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..predicted <- jmvcore::OptionVariable$new(
                "predicted",
                predicted,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..linearPredictor <- jmvcore::OptionVariable$new(
                "linearPredictor",
                linearPredictor,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..validationSet <- jmvcore::OptionVariable$new(
                "validationSet",
                validationSet,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..calibrationTime <- jmvcore::OptionNumber$new(
                "calibrationTime",
                calibrationTime,
                default=60,
                min=1)
            private$..calibrationTimes <- jmvcore::OptionString$new(
                "calibrationTimes",
                calibrationTimes,
                default="12,36,60")
            private$..nGroups <- jmvcore::OptionInteger$new(
                "nGroups",
                nGroups,
                default=10,
                min=5,
                max=20)
            private$..validationMethod <- jmvcore::OptionList$new(
                "validationMethod",
                validationMethod,
                options=list(
                    "none",
                    "bootstrap",
                    "kfold"),
                default="bootstrap")
            private$..nBootstrap <- jmvcore::OptionInteger$new(
                "nBootstrap",
                nBootstrap,
                default=100,
                min=50,
                max=500)
            private$..nFolds <- jmvcore::OptionInteger$new(
                "nFolds",
                nFolds,
                default=10,
                min=3,
                max=20)
            private$..showCalibrationPlot <- jmvcore::OptionBool$new(
                "showCalibrationPlot",
                showCalibrationPlot,
                default=TRUE)
            private$..showCindexPlot <- jmvcore::OptionBool$new(
                "showCindexPlot",
                showCindexPlot,
                default=TRUE)
            private$..showBrierPlot <- jmvcore::OptionBool$new(
                "showBrierPlot",
                showBrierPlot,
                default=TRUE)
            private$..showGroupedCalibration <- jmvcore::OptionBool$new(
                "showGroupedCalibration",
                showGroupedCalibration,
                default=TRUE)
            private$..smoothCalibration <- jmvcore::OptionBool$new(
                "smoothCalibration",
                smoothCalibration,
                default=TRUE)
            private$..ciLevel <- jmvcore::OptionNumber$new(
                "ciLevel",
                ciLevel,
                default=0.95,
                min=0.8,
                max=0.99)
            private$..tripodReport <- jmvcore::OptionBool$new(
                "tripodReport",
                tripodReport,
                default=TRUE)

            self$.addOption(private$..time)
            self$.addOption(private$..event)
            self$.addOption(private$..predicted)
            self$.addOption(private$..linearPredictor)
            self$.addOption(private$..validationSet)
            self$.addOption(private$..calibrationTime)
            self$.addOption(private$..calibrationTimes)
            self$.addOption(private$..nGroups)
            self$.addOption(private$..validationMethod)
            self$.addOption(private$..nBootstrap)
            self$.addOption(private$..nFolds)
            self$.addOption(private$..showCalibrationPlot)
            self$.addOption(private$..showCindexPlot)
            self$.addOption(private$..showBrierPlot)
            self$.addOption(private$..showGroupedCalibration)
            self$.addOption(private$..smoothCalibration)
            self$.addOption(private$..ciLevel)
            self$.addOption(private$..tripodReport)
        }),
    active = list(
        time = function() private$..time$value,
        event = function() private$..event$value,
        predicted = function() private$..predicted$value,
        linearPredictor = function() private$..linearPredictor$value,
        validationSet = function() private$..validationSet$value,
        calibrationTime = function() private$..calibrationTime$value,
        calibrationTimes = function() private$..calibrationTimes$value,
        nGroups = function() private$..nGroups$value,
        validationMethod = function() private$..validationMethod$value,
        nBootstrap = function() private$..nBootstrap$value,
        nFolds = function() private$..nFolds$value,
        showCalibrationPlot = function() private$..showCalibrationPlot$value,
        showCindexPlot = function() private$..showCindexPlot$value,
        showBrierPlot = function() private$..showBrierPlot$value,
        showGroupedCalibration = function() private$..showGroupedCalibration$value,
        smoothCalibration = function() private$..smoothCalibration$value,
        ciLevel = function() private$..ciLevel$value,
        tripodReport = function() private$..tripodReport$value),
    private = list(
        ..time = NA,
        ..event = NA,
        ..predicted = NA,
        ..linearPredictor = NA,
        ..validationSet = NA,
        ..calibrationTime = NA,
        ..calibrationTimes = NA,
        ..nGroups = NA,
        ..validationMethod = NA,
        ..nBootstrap = NA,
        ..nFolds = NA,
        ..showCalibrationPlot = NA,
        ..showCindexPlot = NA,
        ..showBrierPlot = NA,
        ..showGroupedCalibration = NA,
        ..smoothCalibration = NA,
        ..ciLevel = NA,
        ..tripodReport = NA)
)

survivalcalibrationResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "survivalcalibrationResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        performanceMetrics = function() private$.items[["performanceMetrics"]],
        calibrationMetrics = function() private$.items[["calibrationMetrics"]],
        discriminationMetrics = function() private$.items[["discriminationMetrics"]],
        validationSummary = function() private$.items[["validationSummary"]],
        calibrationPlot = function() private$.items[["calibrationPlot"]],
        groupedCalibrationPlot = function() private$.items[["groupedCalibrationPlot"]],
        cindexPlot = function() private$.items[["cindexPlot"]],
        brierPlot = function() private$.items[["brierPlot"]],
        tripodReport = function() private$.items[["tripodReport"]],
        clinicalInterpretation = function() private$.items[["clinicalInterpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Time-Dependent Survival Calibration",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "janitor",
                    "labelled",
                    "glue",
                    "survival",
                    "rms",
                    "pec",
                    "riskRegression",
                    "scales"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                clearWith=list(
                    "time",
                    "event",
                    "predicted")))
            self$add(jmvcore::Table$new(
                options=options,
                name="performanceMetrics",
                title="Performance Metrics",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="calibrationMetrics",
                title="Calibration Metrics",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time Point (months)", 
                        `type`="number"),
                    list(
                        `name`="cal_slope", 
                        `title`="Calibration Slope", 
                        `type`="number"),
                    list(
                        `name`="cal_intercept", 
                        `title`="Calibration Intercept", 
                        `type`="number"),
                    list(
                        `name`="eo_ratio", 
                        `title`="E:O Ratio", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Status", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="discriminationMetrics",
                title="Discrimination Metrics",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="apparent", 
                        `title`="Apparent", 
                        `type`="number"),
                    list(
                        `name`="validated", 
                        `title`="Validated", 
                        `type`="number"),
                    list(
                        `name`="optimism", 
                        `title`="Optimism", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Performance", 
                        `type`="text"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="validationSummary",
                title="Validation Summary",
                visible=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="calibrationPlot",
                title="Calibration Plot",
                width=700,
                height=500,
                renderFun=".calibrationPlot",
                visible="(showCalibrationPlot)",
                clearWith=list(
                    "time",
                    "event",
                    "predicted",
                    "calibrationTime",
                    "nGroups")))
            self$add(jmvcore::Image$new(
                options=options,
                name="groupedCalibrationPlot",
                title="Grouped Calibration Curves",
                width=700,
                height=500,
                renderFun=".groupedCalibrationPlot",
                visible="(showGroupedCalibration)",
                clearWith=list(
                    "time",
                    "event",
                    "predicted",
                    "calibrationTimes")))
            self$add(jmvcore::Image$new(
                options=options,
                name="cindexPlot",
                title="Time-Dependent C-Index",
                width=700,
                height=400,
                renderFun=".cindexPlot",
                visible="(showCindexPlot)",
                clearWith=list(
                    "time",
                    "event",
                    "predicted")))
            self$add(jmvcore::Image$new(
                options=options,
                name="brierPlot",
                title="Brier Score Over Time",
                width=700,
                height=400,
                renderFun=".brierPlot",
                visible="(showBrierPlot)",
                clearWith=list(
                    "time",
                    "event",
                    "predicted")))
            self$add(jmvcore::Html$new(
                options=options,
                name="tripodReport",
                title="TRIPOD Validation Report",
                visible="(tripodReport)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalInterpretation",
                title="Clinical Interpretation",
                visible=TRUE))}))

survivalcalibrationBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "survivalcalibrationBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "survivalcalibration",
                version = c(1,0,0),
                options = options,
                results = survivalcalibrationResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = TRUE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Time-Dependent Survival Calibration
#'
#' Evaluate survival model performance with time-dependent calibration 
#' metrics. Assess calibration, discrimination, and predictive accuracy at 
#' specific time points using bootstrap validation and cross-validation. 
#' TRIPOD-compliant reporting.
#' 
#'
#' @examples
#' # Example usage:
#' # data <- your_data
#' # ClinicoPath::survivalcalibration(
#' #   data = data,
#' #   time = "survival_time",
#' #   event = "status",
#' #   predicted = "pred_5yr_surv",
#' #   calibrationTime = 60,
#' #   validationMethod = "bootstrap"
#' # )
#'
#' @param data The data as a data frame.
#' @param time Time to event or censoring (in months).
#' @param event Event indicator (0 = censored, 1 = event).
#' @param predicted Predicted survival probability at calibration time (0-1
#'   scale).
#' @param linearPredictor Linear predictor from Cox model (alternative to
#'   predicted probability).
#' @param validationSet Grouping variable for training/validation/external
#'   sets.
#' @param calibrationTime Time point (in months) for calibration assessment
#'   (e.g., 60 = 5 years).
#' @param calibrationTimes Comma-separated time points (in months) for
#'   calibration curves.
#' @param nGroups Number of groups (deciles) for grouped calibration curves.
#' @param validationMethod Internal validation method to assess model
#'   performance.
#' @param nBootstrap Number of bootstrap samples for optimism correction.
#' @param nFolds Number of folds for cross-validation.
#' @param showCalibrationPlot Display calibration plot (observed vs predicted
#'   survival).
#' @param showCindexPlot Display C-index over time with confidence intervals.
#' @param showBrierPlot Display Brier score over time (prediction error).
#' @param showGroupedCalibration Display calibration curves stratified by risk
#'   groups.
#' @param smoothCalibration Use loess smoothing for calibration curves.
#' @param ciLevel Confidence level for intervals (0.80-0.99).
#' @param tripodReport Generate TRIPOD-compliant validation report.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$performanceMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$calibrationMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$discriminationMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$validationSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$calibrationPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$groupedCalibrationPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$cindexPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$brierPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$tripodReport} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$clinicalInterpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$performanceMetrics$asDF}
#'
#' \code{as.data.frame(results$performanceMetrics)}
#'
#' @export
survivalcalibration <- function(
    data,
    time,
    event,
    predicted,
    linearPredictor,
    validationSet,
    calibrationTime = 60,
    calibrationTimes = "12,36,60",
    nGroups = 10,
    validationMethod = "bootstrap",
    nBootstrap = 100,
    nFolds = 10,
    showCalibrationPlot = TRUE,
    showCindexPlot = TRUE,
    showBrierPlot = TRUE,
    showGroupedCalibration = TRUE,
    smoothCalibration = TRUE,
    ciLevel = 0.95,
    tripodReport = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("survivalcalibration requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(event)) event <- jmvcore::resolveQuo(jmvcore::enquo(event))
    if ( ! missing(predicted)) predicted <- jmvcore::resolveQuo(jmvcore::enquo(predicted))
    if ( ! missing(linearPredictor)) linearPredictor <- jmvcore::resolveQuo(jmvcore::enquo(linearPredictor))
    if ( ! missing(validationSet)) validationSet <- jmvcore::resolveQuo(jmvcore::enquo(validationSet))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(event), event, NULL),
            `if`( ! missing(predicted), predicted, NULL),
            `if`( ! missing(linearPredictor), linearPredictor, NULL),
            `if`( ! missing(validationSet), validationSet, NULL))

    for (v in validationSet) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- survivalcalibrationOptions$new(
        time = time,
        event = event,
        predicted = predicted,
        linearPredictor = linearPredictor,
        validationSet = validationSet,
        calibrationTime = calibrationTime,
        calibrationTimes = calibrationTimes,
        nGroups = nGroups,
        validationMethod = validationMethod,
        nBootstrap = nBootstrap,
        nFolds = nFolds,
        showCalibrationPlot = showCalibrationPlot,
        showCindexPlot = showCindexPlot,
        showBrierPlot = showBrierPlot,
        showGroupedCalibration = showGroupedCalibration,
        smoothCalibration = smoothCalibration,
        ciLevel = ciLevel,
        tripodReport = tripodReport)

    analysis <- survivalcalibrationClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

