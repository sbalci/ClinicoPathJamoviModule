
# This file is automatically generated, you probably don't want to edit this

batcheffectOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "batcheffectOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            features = NULL,
            batch_var = NULL,
            biological_var = NULL,
            perform_pca = TRUE,
            perform_combat = TRUE,
            feature_quality = TRUE,
            redundancy_analysis = TRUE,
            variance_threshold = 0.01,
            correlation_threshold = 0.95,
            outlier_method = "robust",
            outlier_threshold = 3,
            pca_components = 3,
            missing_threshold = 20,
            show_plots = TRUE,
            combat_parametric = TRUE,
            save_corrected = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="batcheffect",
                requiresData=TRUE,
                ...)

            private$..features <- jmvcore::OptionVariables$new(
                "features",
                features,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..batch_var <- jmvcore::OptionVariable$new(
                "batch_var",
                batch_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..biological_var <- jmvcore::OptionVariable$new(
                "biological_var",
                biological_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..perform_pca <- jmvcore::OptionBool$new(
                "perform_pca",
                perform_pca,
                default=TRUE)
            private$..perform_combat <- jmvcore::OptionBool$new(
                "perform_combat",
                perform_combat,
                default=TRUE)
            private$..feature_quality <- jmvcore::OptionBool$new(
                "feature_quality",
                feature_quality,
                default=TRUE)
            private$..redundancy_analysis <- jmvcore::OptionBool$new(
                "redundancy_analysis",
                redundancy_analysis,
                default=TRUE)
            private$..variance_threshold <- jmvcore::OptionNumber$new(
                "variance_threshold",
                variance_threshold,
                min=0,
                max=1,
                default=0.01)
            private$..correlation_threshold <- jmvcore::OptionNumber$new(
                "correlation_threshold",
                correlation_threshold,
                min=0.5,
                max=1,
                default=0.95)
            private$..outlier_method <- jmvcore::OptionList$new(
                "outlier_method",
                outlier_method,
                options=list(
                    "iqr",
                    "zscore",
                    "robust",
                    "isolation_forest"),
                default="robust")
            private$..outlier_threshold <- jmvcore::OptionNumber$new(
                "outlier_threshold",
                outlier_threshold,
                min=1,
                max=5,
                default=3)
            private$..pca_components <- jmvcore::OptionInteger$new(
                "pca_components",
                pca_components,
                min=2,
                max=10,
                default=3)
            private$..missing_threshold <- jmvcore::OptionNumber$new(
                "missing_threshold",
                missing_threshold,
                min=0,
                max=100,
                default=20)
            private$..show_plots <- jmvcore::OptionBool$new(
                "show_plots",
                show_plots,
                default=TRUE)
            private$..combat_parametric <- jmvcore::OptionBool$new(
                "combat_parametric",
                combat_parametric,
                default=TRUE)
            private$..save_corrected <- jmvcore::OptionBool$new(
                "save_corrected",
                save_corrected,
                default=FALSE)

            self$.addOption(private$..features)
            self$.addOption(private$..batch_var)
            self$.addOption(private$..biological_var)
            self$.addOption(private$..perform_pca)
            self$.addOption(private$..perform_combat)
            self$.addOption(private$..feature_quality)
            self$.addOption(private$..redundancy_analysis)
            self$.addOption(private$..variance_threshold)
            self$.addOption(private$..correlation_threshold)
            self$.addOption(private$..outlier_method)
            self$.addOption(private$..outlier_threshold)
            self$.addOption(private$..pca_components)
            self$.addOption(private$..missing_threshold)
            self$.addOption(private$..show_plots)
            self$.addOption(private$..combat_parametric)
            self$.addOption(private$..save_corrected)
        }),
    active = list(
        features = function() private$..features$value,
        batch_var = function() private$..batch_var$value,
        biological_var = function() private$..biological_var$value,
        perform_pca = function() private$..perform_pca$value,
        perform_combat = function() private$..perform_combat$value,
        feature_quality = function() private$..feature_quality$value,
        redundancy_analysis = function() private$..redundancy_analysis$value,
        variance_threshold = function() private$..variance_threshold$value,
        correlation_threshold = function() private$..correlation_threshold$value,
        outlier_method = function() private$..outlier_method$value,
        outlier_threshold = function() private$..outlier_threshold$value,
        pca_components = function() private$..pca_components$value,
        missing_threshold = function() private$..missing_threshold$value,
        show_plots = function() private$..show_plots$value,
        combat_parametric = function() private$..combat_parametric$value,
        save_corrected = function() private$..save_corrected$value),
    private = list(
        ..features = NA,
        ..batch_var = NA,
        ..biological_var = NA,
        ..perform_pca = NA,
        ..perform_combat = NA,
        ..feature_quality = NA,
        ..redundancy_analysis = NA,
        ..variance_threshold = NA,
        ..correlation_threshold = NA,
        ..outlier_method = NA,
        ..outlier_threshold = NA,
        ..pca_components = NA,
        ..missing_threshold = NA,
        ..show_plots = NA,
        ..combat_parametric = NA,
        ..save_corrected = NA)
)

batcheffectResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "batcheffectResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        summary = function() private$.items[["summary"]],
        batch_detection = function() private$.items[["batch_detection"]],
        feature_quality = function() private$.items[["feature_quality"]],
        redundancy = function() private$.items[["redundancy"]],
        combat_results = function() private$.items[["combat_results"]],
        pca_plot = function() private$.items[["pca_plot"]],
        quality_plot = function() private$.items[["quality_plot"]],
        correlation_plot = function() private$.items[["correlation_plot"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Batch Effect Control & Quality Assessment",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Getting Started",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="summary",
                title="Data Quality Summary",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Quality Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"),
                    list(
                        `name`="status", 
                        `title`="Status", 
                        `type`="text"),
                    list(
                        `name`="recommendation", 
                        `title`="Recommendation", 
                        `type`="text")),
                clearWith=list(
                    "features",
                    "batch_var",
                    "biological_var")))
            self$add(jmvcore::Table$new(
                options=options,
                name="batch_detection",
                title="Batch Effect Detection Results",
                columns=list(
                    list(
                        `name`="test", 
                        `title`="Test/Metric", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="effect_size", 
                        `title`="Effect Size", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text")),
                clearWith=list(
                    "features",
                    "batch_var",
                    "perform_pca")))
            self$add(jmvcore::Table$new(
                options=options,
                name="feature_quality",
                title="Feature Quality Assessment",
                visible="(feature_quality)",
                columns=list(
                    list(
                        `name`="feature", 
                        `title`="Feature", 
                        `type`="text"),
                    list(
                        `name`="missing_pct", 
                        `title`="Missing %", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="variance", 
                        `title`="Variance", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="outliers", 
                        `title`="Outliers", 
                        `type`="integer"),
                    list(
                        `name`="distribution", 
                        `title`="Distribution", 
                        `type`="text"),
                    list(
                        `name`="quality_score", 
                        `title`="Quality Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="recommendation", 
                        `title`="Recommendation", 
                        `type`="text")),
                clearWith=list(
                    "features",
                    "outlier_method",
                    "variance_threshold")))
            self$add(jmvcore::Table$new(
                options=options,
                name="redundancy",
                title="Feature Redundancy Analysis",
                visible="(redundancy_analysis)",
                columns=list(
                    list(
                        `name`="feature_pair", 
                        `title`="Feature Pair", 
                        `type`="text"),
                    list(
                        `name`="correlation", 
                        `title`="Correlation", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="vif", 
                        `title`="VIF", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="redundancy_type", 
                        `title`="Redundancy Type", 
                        `type`="text"),
                    list(
                        `name`="recommendation", 
                        `title`="Recommendation", 
                        `type`="text")),
                clearWith=list(
                    "features",
                    "correlation_threshold")))
            self$add(jmvcore::Table$new(
                options=options,
                name="combat_results",
                title="ComBat Correction Results",
                visible="(perform_combat)",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="before_correction", 
                        `title`="Before Correction", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="after_correction", 
                        `title`="After Correction", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="improvement", 
                        `title`="Improvement %", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text")),
                clearWith=list(
                    "features",
                    "batch_var",
                    "biological_var",
                    "perform_combat")))
            self$add(jmvcore::Image$new(
                options=options,
                name="pca_plot",
                title="PCA Batch Effect Visualization",
                width=800,
                height=600,
                visible="(show_plots && perform_pca)",
                requiresData=TRUE,
                clearWith=list(
                    "features",
                    "batch_var",
                    "biological_var",
                    "pca_components")))
            self$add(jmvcore::Image$new(
                options=options,
                name="quality_plot",
                title="Feature Quality Plots",
                width=800,
                height=600,
                visible="(show_plots && feature_quality)",
                requiresData=TRUE,
                clearWith=list(
                    "features",
                    "outlier_method",
                    "missing_threshold")))
            self$add(jmvcore::Image$new(
                options=options,
                name="correlation_plot",
                title="Feature Correlation Heatmap",
                width=800,
                height=600,
                visible="(show_plots && redundancy_analysis)",
                requiresData=TRUE,
                clearWith=list(
                    "features",
                    "correlation_threshold")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation and Guidelines",
                visible=TRUE))}))

batcheffectBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "batcheffectBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "batcheffect",
                version = c(1,0,0),
                options = options,
                results = batcheffectResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = TRUE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Batch Effect Control & Quality Assessment
#'
#' Advanced batch effect detection and correction for tabular data analysis.
#' Essential for digital pathology and multi-institutional studies where
#' technical variation can confound biological signals ("garbage in, garbage 
#' out").
#' 
#' Implements PCA visualization, ComBat correction, feature quality 
#' assessment,
#' and comprehensive quality control metrics for high-dimensional data.
#' 
#'
#' @examples
#' data('your_data')
#'
#' batcheffect(data = your_data,
#'            features = feature_variables,
#'            batch_var = batch_id,
#'            biological_var = treatment_group,
#'            perform_pca = TRUE,
#'            perform_combat = TRUE)
#'
#' @param data the data as a data frame
#' @param features Numeric feature variables to assess for batch effects
#'   (e.g., biomarkers, image features)
#' @param batch_var Categorical variable indicating batch/technical groups
#'   (e.g., institution, date, instrument)
#' @param biological_var Optional biological grouping variable to preserve
#'   during batch correction
#' @param perform_pca Perform Principal Component Analysis to visualize batch
#'   effects
#' @param perform_combat Apply ComBat correction to remove batch effects while
#'   preserving biological variation
#' @param feature_quality Assess individual feature quality including
#'   distribution analysis and outlier detection
#' @param redundancy_analysis Analyze feature redundancy and correlation
#'   structure
#' @param variance_threshold Threshold for removing low-variance features (0 =
#'   no filtering)
#' @param correlation_threshold Threshold for identifying highly correlated
#'   redundant features
#' @param outlier_method Method for outlier detection in feature quality
#'   assessment
#' @param outlier_threshold Threshold for outlier detection (standard
#'   deviations or IQR multiplier)
#' @param pca_components Number of principal components to compute and
#'   visualize
#' @param missing_threshold Maximum percentage of missing values allowed per
#'   feature
#' @param show_plots Generate diagnostic plots including PCA plots and quality
#'   assessments
#' @param combat_parametric Use parametric ComBat (faster) vs non-parametric
#'   (more robust)
#' @param save_corrected Add ComBat-corrected features to the dataset
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab Instructions for batch effect analysis and quality control \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab Overall summary of data quality and batch effect assessment \cr
#'   \code{results$batch_detection} \tab \tab \tab \tab \tab Statistical tests and metrics for batch effect detection \cr
#'   \code{results$feature_quality} \tab \tab \tab \tab \tab Quality metrics for individual features \cr
#'   \code{results$redundancy} \tab \tab \tab \tab \tab Analysis of highly correlated and redundant features \cr
#'   \code{results$combat_results} \tab \tab \tab \tab \tab Results and effectiveness of ComBat batch correction \cr
#'   \code{results$pca_plot} \tab \tab \tab \tab \tab PCA plots showing batch effects before and after correction \cr
#'   \code{results$quality_plot} \tab \tab \tab \tab \tab Distribution and quality assessment plots for features \cr
#'   \code{results$correlation_plot} \tab \tab \tab \tab \tab Correlation matrix heatmap for redundancy analysis \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab Clinical context and quality control recommendations \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summary$asDF}
#'
#' \code{as.data.frame(results$summary)}
#'
#' @export
batcheffect <- function(
    data,
    features,
    batch_var,
    biological_var,
    perform_pca = TRUE,
    perform_combat = TRUE,
    feature_quality = TRUE,
    redundancy_analysis = TRUE,
    variance_threshold = 0.01,
    correlation_threshold = 0.95,
    outlier_method = "robust",
    outlier_threshold = 3,
    pca_components = 3,
    missing_threshold = 20,
    show_plots = TRUE,
    combat_parametric = TRUE,
    save_corrected = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("batcheffect requires jmvcore to be installed (restart may be required)")

    if ( ! missing(features)) features <- jmvcore::resolveQuo(jmvcore::enquo(features))
    if ( ! missing(batch_var)) batch_var <- jmvcore::resolveQuo(jmvcore::enquo(batch_var))
    if ( ! missing(biological_var)) biological_var <- jmvcore::resolveQuo(jmvcore::enquo(biological_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(features), features, NULL),
            `if`( ! missing(batch_var), batch_var, NULL),
            `if`( ! missing(biological_var), biological_var, NULL))

    for (v in batch_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in biological_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- batcheffectOptions$new(
        features = features,
        batch_var = batch_var,
        biological_var = biological_var,
        perform_pca = perform_pca,
        perform_combat = perform_combat,
        feature_quality = feature_quality,
        redundancy_analysis = redundancy_analysis,
        variance_threshold = variance_threshold,
        correlation_threshold = correlation_threshold,
        outlier_method = outlier_method,
        outlier_threshold = outlier_threshold,
        pca_components = pca_components,
        missing_threshold = missing_threshold,
        show_plots = show_plots,
        combat_parametric = combat_parametric,
        save_corrected = save_corrected)

    analysis <- batcheffectClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

