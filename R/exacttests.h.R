
# This file is automatically generated, you probably don't want to edit this

exacttestsOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "exacttestsOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            rows = NULL,
            cols = NULL,
            counts = NULL,
            testType = "fisher",
            alternative = "two.sided",
            ciMethod = "clopper_pearson",
            ciWidth = 95,
            showCI = TRUE,
            correction = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="exacttests",
                requiresData=TRUE,
                ...)

            private$..rows <- jmvcore::OptionVariable$new(
                "rows",
                rows,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..cols <- jmvcore::OptionVariable$new(
                "cols",
                cols,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..counts <- jmvcore::OptionVariable$new(
                "counts",
                counts,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..testType <- jmvcore::OptionList$new(
                "testType",
                testType,
                options=list(
                    "fisher",
                    "binomial",
                    "mcnemar",
                    "barnard"),
                default="fisher")
            private$..alternative <- jmvcore::OptionList$new(
                "alternative",
                alternative,
                options=list(
                    "two.sided",
                    "greater",
                    "less"),
                default="two.sided")
            private$..ciMethod <- jmvcore::OptionList$new(
                "ciMethod",
                ciMethod,
                options=list(
                    "clopper_pearson",
                    "wilson",
                    "agresti_coull"),
                default="clopper_pearson")
            private$..ciWidth <- jmvcore::OptionNumber$new(
                "ciWidth",
                ciWidth,
                min=50,
                max=99.9,
                default=95)
            private$..showCI <- jmvcore::OptionBool$new(
                "showCI",
                showCI,
                default=TRUE)
            private$..correction <- jmvcore::OptionBool$new(
                "correction",
                correction,
                default=FALSE)

            self$.addOption(private$..rows)
            self$.addOption(private$..cols)
            self$.addOption(private$..counts)
            self$.addOption(private$..testType)
            self$.addOption(private$..alternative)
            self$.addOption(private$..ciMethod)
            self$.addOption(private$..ciWidth)
            self$.addOption(private$..showCI)
            self$.addOption(private$..correction)
        }),
    active = list(
        rows = function() private$..rows$value,
        cols = function() private$..cols$value,
        counts = function() private$..counts$value,
        testType = function() private$..testType$value,
        alternative = function() private$..alternative$value,
        ciMethod = function() private$..ciMethod$value,
        ciWidth = function() private$..ciWidth$value,
        showCI = function() private$..showCI$value,
        correction = function() private$..correction$value),
    private = list(
        ..rows = NA,
        ..cols = NA,
        ..counts = NA,
        ..testType = NA,
        ..alternative = NA,
        ..ciMethod = NA,
        ..ciWidth = NA,
        ..showCI = NA,
        ..correction = NA)
)

exacttestsResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "exacttestsResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        contingency = function() private$.items[["contingency"]],
        tests = function() private$.items[["tests"]],
        note = function() private$.items[["note"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Exact Tests for Small Samples")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="contingency",
                title="Contingency Table",
                visible="(rows && cols)",
                columns=list(
                    list(
                        `name`=".name", 
                        `title`="", 
                        `type`="text", 
                        `combineBelow`=TRUE))))
            self$add(jmvcore::Table$new(
                options=options,
                name="tests",
                title="Statistical Tests",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer", 
                        `visible`="(testType:fisher)"),
                    list(
                        `name`="p", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="ci", 
                        `title`="95% CI", 
                        `type`="text", 
                        `visible`="(showCI)"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="note",
                title="Note",
                visible=TRUE))}))

exacttestsBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "exacttestsBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "exacttests",
                version = c(1,0,0),
                options = options,
                results = exacttestsResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Exact Tests for Small Samples
#'
#' 
#' @param data .
#' @param rows .
#' @param cols .
#' @param counts .
#' @param testType .
#' @param alternative .
#' @param ciMethod .
#' @param ciWidth .
#' @param showCI .
#' @param correction .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$contingency} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$tests} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$note} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$contingency$asDF}
#'
#' \code{as.data.frame(results$contingency)}
#'
#' @export
exacttests <- function(
    data,
    rows,
    cols,
    counts,
    testType = "fisher",
    alternative = "two.sided",
    ciMethod = "clopper_pearson",
    ciWidth = 95,
    showCI = TRUE,
    correction = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("exacttests requires jmvcore to be installed (restart may be required)")

    if ( ! missing(rows)) rows <- jmvcore::resolveQuo(jmvcore::enquo(rows))
    if ( ! missing(cols)) cols <- jmvcore::resolveQuo(jmvcore::enquo(cols))
    if ( ! missing(counts)) counts <- jmvcore::resolveQuo(jmvcore::enquo(counts))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(rows), rows, NULL),
            `if`( ! missing(cols), cols, NULL),
            `if`( ! missing(counts), counts, NULL))

    for (v in rows) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in cols) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- exacttestsOptions$new(
        rows = rows,
        cols = cols,
        counts = counts,
        testType = testType,
        alternative = alternative,
        ciMethod = ciMethod,
        ciWidth = ciWidth,
        showCI = showCI,
        correction = correction)

    analysis <- exacttestsClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

