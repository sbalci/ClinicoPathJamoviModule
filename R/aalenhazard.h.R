
# This file is automatically generated, you probably don't want to edit this

aalenhazardOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "aalenhazardOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            outcome = NULL,
            covariates = NULL,
            outcomeLevel = "1",
            model_type = "additive",
            constant_effects = NULL,
            test_constant_effects = TRUE,
            bandwidth = 1,
            robust_se = TRUE,
            show_model_summary = TRUE,
            show_coefficients_table = TRUE,
            show_test_results = TRUE,
            show_cumulative_plots = TRUE,
            show_hazard_plots = TRUE,
            show_diagnostics = TRUE,
            showSummaries = FALSE,
            showExplanations = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="aalenhazard",
                requiresData=TRUE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..outcomeLevel <- jmvcore::OptionString$new(
                "outcomeLevel",
                outcomeLevel,
                default="1")
            private$..model_type <- jmvcore::OptionList$new(
                "model_type",
                model_type,
                options=list(
                    "additive",
                    "semiparametric",
                    "nonparametric"),
                default="additive")
            private$..constant_effects <- jmvcore::OptionVariables$new(
                "constant_effects",
                constant_effects,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..test_constant_effects <- jmvcore::OptionBool$new(
                "test_constant_effects",
                test_constant_effects,
                default=TRUE)
            private$..bandwidth <- jmvcore::OptionNumber$new(
                "bandwidth",
                bandwidth,
                min=0.01,
                max=2,
                default=1)
            private$..robust_se <- jmvcore::OptionBool$new(
                "robust_se",
                robust_se,
                default=TRUE)
            private$..show_model_summary <- jmvcore::OptionBool$new(
                "show_model_summary",
                show_model_summary,
                default=TRUE)
            private$..show_coefficients_table <- jmvcore::OptionBool$new(
                "show_coefficients_table",
                show_coefficients_table,
                default=TRUE)
            private$..show_test_results <- jmvcore::OptionBool$new(
                "show_test_results",
                show_test_results,
                default=TRUE)
            private$..show_cumulative_plots <- jmvcore::OptionBool$new(
                "show_cumulative_plots",
                show_cumulative_plots,
                default=TRUE)
            private$..show_hazard_plots <- jmvcore::OptionBool$new(
                "show_hazard_plots",
                show_hazard_plots,
                default=TRUE)
            private$..show_diagnostics <- jmvcore::OptionBool$new(
                "show_diagnostics",
                show_diagnostics,
                default=TRUE)
            private$..showSummaries <- jmvcore::OptionBool$new(
                "showSummaries",
                showSummaries,
                default=FALSE)
            private$..showExplanations <- jmvcore::OptionBool$new(
                "showExplanations",
                showExplanations,
                default=FALSE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..outcome)
            self$.addOption(private$..covariates)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..model_type)
            self$.addOption(private$..constant_effects)
            self$.addOption(private$..test_constant_effects)
            self$.addOption(private$..bandwidth)
            self$.addOption(private$..robust_se)
            self$.addOption(private$..show_model_summary)
            self$.addOption(private$..show_coefficients_table)
            self$.addOption(private$..show_test_results)
            self$.addOption(private$..show_cumulative_plots)
            self$.addOption(private$..show_hazard_plots)
            self$.addOption(private$..show_diagnostics)
            self$.addOption(private$..showSummaries)
            self$.addOption(private$..showExplanations)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        outcome = function() private$..outcome$value,
        covariates = function() private$..covariates$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        model_type = function() private$..model_type$value,
        constant_effects = function() private$..constant_effects$value,
        test_constant_effects = function() private$..test_constant_effects$value,
        bandwidth = function() private$..bandwidth$value,
        robust_se = function() private$..robust_se$value,
        show_model_summary = function() private$..show_model_summary$value,
        show_coefficients_table = function() private$..show_coefficients_table$value,
        show_test_results = function() private$..show_test_results$value,
        show_cumulative_plots = function() private$..show_cumulative_plots$value,
        show_hazard_plots = function() private$..show_hazard_plots$value,
        show_diagnostics = function() private$..show_diagnostics$value,
        showSummaries = function() private$..showSummaries$value,
        showExplanations = function() private$..showExplanations$value),
    private = list(
        ..elapsedtime = NA,
        ..outcome = NA,
        ..covariates = NA,
        ..outcomeLevel = NA,
        ..model_type = NA,
        ..constant_effects = NA,
        ..test_constant_effects = NA,
        ..bandwidth = NA,
        ..robust_se = NA,
        ..show_model_summary = NA,
        ..show_coefficients_table = NA,
        ..show_test_results = NA,
        ..show_cumulative_plots = NA,
        ..show_hazard_plots = NA,
        ..show_diagnostics = NA,
        ..showSummaries = NA,
        ..showExplanations = NA)
)

aalenhazardResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "aalenhazardResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        modelSummary = function() private$.items[["modelSummary"]],
        coefficientsTable = function() private$.items[["coefficientsTable"]],
        constantEffectsTest = function() private$.items[["constantEffectsTest"]],
        goodnessOfFit = function() private$.items[["goodnessOfFit"]],
        modelComparison = function() private$.items[["modelComparison"]],
        cumulativePlots = function() private$.items[["cumulativePlots"]],
        hazardPlots = function() private$.items[["hazardPlots"]],
        diagnosticPlots = function() private$.items[["diagnosticPlots"]],
        residualPlots = function() private$.items[["residualPlots"]],
        analysisSummary = function() private$.items[["analysisSummary"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Aalen's Additive Hazard Models")
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                visible="(show_model_summary)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="coefficientsTable",
                title="Cumulative Regression Coefficients",
                visible="(show_coefficients_table)",
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="cumulative_coeff", 
                        `title`="Cumulative \u03B2", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="z_value", 
                        `title`="z", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="constantEffectsTest",
                title="Test for Constant Effects",
                visible="(test_constant_effects && show_test_results)",
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="test_statistic", 
                        `title`="Test Statistic", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Result", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="goodnessOfFit",
                title="Model Goodness of Fit",
                visible="(show_test_results)",
                columns=list(
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelComparison",
                title="Model Comparison",
                visible="(show_model_summary)",
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="loglik", 
                        `title`="Log-Likelihood", 
                        `type`="number"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"),
                    list(
                        `name`="n_events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="n_obs", 
                        `title`="Observations", 
                        `type`="integer"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="cumulativePlots",
                title="Cumulative Regression Functions",
                visible="(show_cumulative_plots)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="hazardPlots",
                title="Estimated Hazard Functions",
                visible="(show_hazard_plots)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagnosticPlots",
                title="Model Diagnostics",
                visible="(show_diagnostics)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="residualPlots",
                title="Residual Analysis",
                visible="(show_diagnostics)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="analysisSummary",
                title="Analysis Summary",
                visible="(showSummaries)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Methodology",
                visible="(showExplanations)"))}))

aalenhazardBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "aalenhazardBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "aalenhazard",
                version = c(0,0,1),
                options = options,
                results = aalenhazardResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Aalen's Additive Hazard Models
#'
#' Implements Aalen's additive hazard regression models for survival data 
#' where covariate effects are additive rather than multiplicative. This 
#' approach is particularly useful when the proportional hazards assumption is 
#' violated, allowing for time-varying covariate effects and non-proportional 
#' hazards. The model estimates cumulative regression functions that can 
#' reveal how covariate effects change over time.
#'
#' @examples
#' # Example 1: Basic Aalen additive hazard model
#' library(timereg)
#' library(survival)
#'
#' aalenhazard(
#'     data = veteran_data,
#'     elapsedtime = "time",
#'     outcome = "status",
#'     outcomeLevel = "1",
#'     covariates = c("age", "karno", "diagtime"),
#'     model_type = "additive"
#' )
#'
#' # Example 2: Semi-parametric Aalen model with constant effects
#' aalenhazard(
#'     data = lung_data,
#'     elapsedtime = "time",
#'     outcome = "status",
#'     outcomeLevel = "2",
#'     covariates = c("age", "sex", "ph.ecog"),
#'     model_type = "semiparametric",
#'     constant_effects = c("sex"),
#'     show_cumulative_plots = TRUE
#' )
#'
#' @param data the data as a data frame
#' @param elapsedtime Survival time or follow-up duration variable
#' @param outcome Event indicator variable (0/1, FALSE/TRUE, or factor)
#' @param covariates Covariate variables for additive hazard modeling
#' @param outcomeLevel Level of outcome variable indicating event occurrence
#' @param model_type Type of Aalen hazard model to fit
#' @param constant_effects Variables to be treated as having constant
#'   (time-independent) effects
#' @param test_constant_effects Test whether covariate effects are constant
#'   over time
#' @param bandwidth Bandwidth parameter for kernel smoothing of cumulative
#'   coefficients
#' @param robust_se Use robust sandwich estimator for standard errors
#' @param show_model_summary Display model summary table
#' @param show_coefficients_table Display table of cumulative regression
#'   coefficients
#' @param show_test_results Display statistical test results
#' @param show_cumulative_plots Display plots of cumulative regression
#'   coefficients over time
#' @param show_hazard_plots Display estimated hazard function plots
#' @param show_diagnostics Display model diagnostic plots and residuals
#' @param showSummaries Generate natural language summaries of results
#' @param showExplanations Show detailed methodology explanations
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$coefficientsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$constantEffectsTest} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$goodnessOfFit} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$cumulativePlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$hazardPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$diagnosticPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$residualPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$analysisSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$coefficientsTable$asDF}
#'
#' \code{as.data.frame(results$coefficientsTable)}
#'
#' @export
aalenhazard <- function(
    data,
    elapsedtime,
    outcome,
    covariates,
    outcomeLevel = "1",
    model_type = "additive",
    constant_effects,
    test_constant_effects = TRUE,
    bandwidth = 1,
    robust_se = TRUE,
    show_model_summary = TRUE,
    show_coefficients_table = TRUE,
    show_test_results = TRUE,
    show_cumulative_plots = TRUE,
    show_hazard_plots = TRUE,
    show_diagnostics = TRUE,
    showSummaries = FALSE,
    showExplanations = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("aalenhazard requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(constant_effects)) constant_effects <- jmvcore::resolveQuo(jmvcore::enquo(constant_effects))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(elapsedtime), elapsedtime, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(covariates), covariates, NULL),
            `if`( ! missing(constant_effects), constant_effects, NULL))


    options <- aalenhazardOptions$new(
        elapsedtime = elapsedtime,
        outcome = outcome,
        covariates = covariates,
        outcomeLevel = outcomeLevel,
        model_type = model_type,
        constant_effects = constant_effects,
        test_constant_effects = test_constant_effects,
        bandwidth = bandwidth,
        robust_se = robust_se,
        show_model_summary = show_model_summary,
        show_coefficients_table = show_coefficients_table,
        show_test_results = show_test_results,
        show_cumulative_plots = show_cumulative_plots,
        show_hazard_plots = show_hazard_plots,
        show_diagnostics = show_diagnostics,
        showSummaries = showSummaries,
        showExplanations = showExplanations)

    analysis <- aalenhazardClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

