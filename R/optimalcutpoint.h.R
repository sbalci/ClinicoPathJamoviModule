
# This file is automatically generated, you probably don't want to edit this

optimalcutpointOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "optimalcutpointOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            biomarker = NULL,
            analysis_type = "binary",
            outcome = NULL,
            time_var = NULL,
            status_var = NULL,
            cutpoint_method = "youden",
            bootstrap_validation = FALSE,
            bootstrap_runs = 1000,
            cross_validation = FALSE,
            cv_folds = 10,
            performance_metrics = TRUE,
            survival_analysis = TRUE,
            confidence_level = 0.95,
            multiple_testing = "miller_siegmund",
            plot_roc = TRUE,
            plot_distribution = TRUE,
            plot_survival = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="optimalcutpoint",
                requiresData=TRUE,
                ...)

            private$..biomarker <- jmvcore::OptionVariable$new(
                "biomarker",
                biomarker,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..analysis_type <- jmvcore::OptionList$new(
                "analysis_type",
                analysis_type,
                options=list(
                    "binary",
                    "survival",
                    "continuous"),
                default="binary")
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..time_var <- jmvcore::OptionVariable$new(
                "time_var",
                time_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..status_var <- jmvcore::OptionVariable$new(
                "status_var",
                status_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..cutpoint_method <- jmvcore::OptionList$new(
                "cutpoint_method",
                cutpoint_method,
                options=list(
                    "youden",
                    "closest_topleft",
                    "roc01",
                    "maxstat",
                    "median",
                    "tertiles",
                    "quartiles",
                    "correlation"),
                default="youden")
            private$..bootstrap_validation <- jmvcore::OptionBool$new(
                "bootstrap_validation",
                bootstrap_validation,
                default=FALSE)
            private$..bootstrap_runs <- jmvcore::OptionInteger$new(
                "bootstrap_runs",
                bootstrap_runs,
                min=100,
                max=5000,
                default=1000)
            private$..cross_validation <- jmvcore::OptionBool$new(
                "cross_validation",
                cross_validation,
                default=FALSE)
            private$..cv_folds <- jmvcore::OptionInteger$new(
                "cv_folds",
                cv_folds,
                min=3,
                max=20,
                default=10)
            private$..performance_metrics <- jmvcore::OptionBool$new(
                "performance_metrics",
                performance_metrics,
                default=TRUE)
            private$..survival_analysis <- jmvcore::OptionBool$new(
                "survival_analysis",
                survival_analysis,
                default=TRUE)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..multiple_testing <- jmvcore::OptionList$new(
                "multiple_testing",
                multiple_testing,
                options=list(
                    "none",
                    "bonferroni",
                    "holm",
                    "miller_siegmund"),
                default="miller_siegmund")
            private$..plot_roc <- jmvcore::OptionBool$new(
                "plot_roc",
                plot_roc,
                default=TRUE)
            private$..plot_distribution <- jmvcore::OptionBool$new(
                "plot_distribution",
                plot_distribution,
                default=TRUE)
            private$..plot_survival <- jmvcore::OptionBool$new(
                "plot_survival",
                plot_survival,
                default=TRUE)

            self$.addOption(private$..biomarker)
            self$.addOption(private$..analysis_type)
            self$.addOption(private$..outcome)
            self$.addOption(private$..time_var)
            self$.addOption(private$..status_var)
            self$.addOption(private$..cutpoint_method)
            self$.addOption(private$..bootstrap_validation)
            self$.addOption(private$..bootstrap_runs)
            self$.addOption(private$..cross_validation)
            self$.addOption(private$..cv_folds)
            self$.addOption(private$..performance_metrics)
            self$.addOption(private$..survival_analysis)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..multiple_testing)
            self$.addOption(private$..plot_roc)
            self$.addOption(private$..plot_distribution)
            self$.addOption(private$..plot_survival)
        }),
    active = list(
        biomarker = function() private$..biomarker$value,
        analysis_type = function() private$..analysis_type$value,
        outcome = function() private$..outcome$value,
        time_var = function() private$..time_var$value,
        status_var = function() private$..status_var$value,
        cutpoint_method = function() private$..cutpoint_method$value,
        bootstrap_validation = function() private$..bootstrap_validation$value,
        bootstrap_runs = function() private$..bootstrap_runs$value,
        cross_validation = function() private$..cross_validation$value,
        cv_folds = function() private$..cv_folds$value,
        performance_metrics = function() private$..performance_metrics$value,
        survival_analysis = function() private$..survival_analysis$value,
        confidence_level = function() private$..confidence_level$value,
        multiple_testing = function() private$..multiple_testing$value,
        plot_roc = function() private$..plot_roc$value,
        plot_distribution = function() private$..plot_distribution$value,
        plot_survival = function() private$..plot_survival$value),
    private = list(
        ..biomarker = NA,
        ..analysis_type = NA,
        ..outcome = NA,
        ..time_var = NA,
        ..status_var = NA,
        ..cutpoint_method = NA,
        ..bootstrap_validation = NA,
        ..bootstrap_runs = NA,
        ..cross_validation = NA,
        ..cv_folds = NA,
        ..performance_metrics = NA,
        ..survival_analysis = NA,
        ..confidence_level = NA,
        ..multiple_testing = NA,
        ..plot_roc = NA,
        ..plot_distribution = NA,
        ..plot_survival = NA)
)

optimalcutpointResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "optimalcutpointResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        cutpointresults = function() private$.items[["cutpointresults"]],
        performance = function() private$.items[["performance"]],
        survival = function() private$.items[["survival"]],
        validation = function() private$.items[["validation"]],
        crossvalidation = function() private$.items[["crossvalidation"]],
        rocplot = function() private$.items[["rocplot"]],
        distributionplot = function() private$.items[["distributionplot"]],
        survivalplot = function() private$.items[["survivalplot"]],
        cutpointplot = function() private$.items[["cutpointplot"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Optimal Cutpoint Determination")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Getting Started",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="cutpointresults",
                title="Optimal Cutpoint Results",
                clearWith=list(
                    "biomarker",
                    "outcome",
                    "time_var",
                    "status_var",
                    "analysis_type",
                    "cutpoint_method"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="performance",
                title="Performance Metrics",
                visible="(performance_metrics && analysis_type:binary)",
                clearWith=list(
                    "biomarker",
                    "outcome",
                    "cutpoint_method",
                    "confidence_level"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="survival",
                title="Survival Analysis Results",
                visible="(survival_analysis && analysis_type:survival)",
                clearWith=list(
                    "biomarker",
                    "time_var",
                    "status_var",
                    "cutpoint_method"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="validation",
                title="Bootstrap Validation",
                visible="(bootstrap_validation)",
                clearWith=list(
                    "biomarker",
                    "outcome",
                    "time_var",
                    "status_var",
                    "cutpoint_method",
                    "bootstrap_runs"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="crossvalidation",
                title="Cross Validation Results",
                visible="(cross_validation)",
                clearWith=list(
                    "biomarker",
                    "outcome",
                    "cutpoint_method",
                    "cv_folds"),
                columns=list()))
            self$add(jmvcore::Image$new(
                options=options,
                name="rocplot",
                title="ROC Curve with Optimal Cutpoint",
                width=600,
                height=500,
                visible="(plot_roc && analysis_type:binary)",
                requiresData=TRUE,
                clearWith=list(
                    "biomarker",
                    "outcome",
                    "cutpoint_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="distributionplot",
                title="Biomarker Distribution",
                width=600,
                height=500,
                visible="(plot_distribution)",
                requiresData=TRUE,
                clearWith=list(
                    "biomarker",
                    "outcome",
                    "cutpoint_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalplot",
                title="Kaplan-Meier Curves",
                width=600,
                height=500,
                visible="(plot_survival && analysis_type:survival)",
                requiresData=TRUE,
                clearWith=list(
                    "biomarker",
                    "time_var",
                    "status_var",
                    "cutpoint_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="cutpointplot",
                title="Cutpoint Optimization Plot",
                width=600,
                height=500,
                visible=TRUE,
                requiresData=TRUE,
                clearWith=list(
                    "biomarker",
                    "outcome",
                    "cutpoint_method")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation and Guidelines",
                visible=TRUE))}))

optimalcutpointBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "optimalcutpointBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "optimalcutpoint",
                version = c(1,0,0),
                options = options,
                results = optimalcutpointResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = TRUE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Optimal Cutpoint Determination
#'
#' Determines optimal cutpoints for continuous biomarkers to maximize 
#' diagnostic or prognostic performance. Essential for converting 
#' continuous measurements to clinically actionable thresholds and 
#' preventing arbitrary cutpoint selection in pathology studies.
#' 
#'
#' @examples
#' data('histopathology')
#'
#' optimalcutpoint(data = histopathology,
#'                biomarker = ki67_score,
#'                outcome = tumor_grade,
#'                analysis_type = "binary")
#'
#' @param data the data as a data frame
#' @param biomarker Continuous biomarker variable for cutpoint optimization
#' @param analysis_type Type of analysis based on outcome variable
#' @param outcome Outcome variable for binary or continuous analysis
#' @param time_var Time-to-event variable for survival analysis
#' @param status_var Event status variable for survival analysis (0=censored,
#'   1=event)
#' @param cutpoint_method Method for cutpoint optimization
#' @param bootstrap_validation Perform bootstrap validation of cutpoint
#'   stability
#' @param bootstrap_runs Number of bootstrap runs for validation
#' @param cross_validation Perform cross-validation for cutpoint assessment
#' @param cv_folds Number of folds for cross-validation
#' @param performance_metrics Calculate comprehensive performance metrics
#' @param survival_analysis Perform survival analysis for optimal groups
#' @param confidence_level Confidence level for intervals and tests
#' @param multiple_testing Multiple testing correction for cutpoint selection
#' @param plot_roc Generate ROC curve with optimal cutpoint
#' @param plot_distribution Show biomarker distribution with cutpoint
#' @param plot_survival Generate Kaplan-Meier curves for optimal groups
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab Instructions for optimal cutpoint determination \cr
#'   \code{results$cutpointresults} \tab \tab \tab \tab \tab Optimal cutpoint values and associated metrics \cr
#'   \code{results$performance} \tab \tab \tab \tab \tab Diagnostic performance at optimal cutpoint \cr
#'   \code{results$survival} \tab \tab \tab \tab \tab Survival statistics for optimal groups \cr
#'   \code{results$validation} \tab \tab \tab \tab \tab Bootstrap validation of cutpoint stability \cr
#'   \code{results$crossvalidation} \tab \tab \tab \tab \tab Cross-validation performance assessment \cr
#'   \code{results$rocplot} \tab \tab \tab \tab \tab ROC curve showing optimal cutpoint \cr
#'   \code{results$distributionplot} \tab \tab \tab \tab \tab Distribution of biomarker with optimal cutpoint \cr
#'   \code{results$survivalplot} \tab \tab \tab \tab \tab Survival curves for optimal groups \cr
#'   \code{results$cutpointplot} \tab \tab \tab \tab \tab Visualization of cutpoint search process \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab Clinical context and interpretation for optimal cutpoints \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$cutpointresults$asDF}
#'
#' \code{as.data.frame(results$cutpointresults)}
#'
#' @export
optimalcutpoint <- function(
    data,
    biomarker,
    analysis_type = "binary",
    outcome,
    time_var,
    status_var,
    cutpoint_method = "youden",
    bootstrap_validation = FALSE,
    bootstrap_runs = 1000,
    cross_validation = FALSE,
    cv_folds = 10,
    performance_metrics = TRUE,
    survival_analysis = TRUE,
    confidence_level = 0.95,
    multiple_testing = "miller_siegmund",
    plot_roc = TRUE,
    plot_distribution = TRUE,
    plot_survival = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("optimalcutpoint requires jmvcore to be installed (restart may be required)")

    if ( ! missing(biomarker)) biomarker <- jmvcore::resolveQuo(jmvcore::enquo(biomarker))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(time_var)) time_var <- jmvcore::resolveQuo(jmvcore::enquo(time_var))
    if ( ! missing(status_var)) status_var <- jmvcore::resolveQuo(jmvcore::enquo(status_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(biomarker), biomarker, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(time_var), time_var, NULL),
            `if`( ! missing(status_var), status_var, NULL))


    options <- optimalcutpointOptions$new(
        biomarker = biomarker,
        analysis_type = analysis_type,
        outcome = outcome,
        time_var = time_var,
        status_var = status_var,
        cutpoint_method = cutpoint_method,
        bootstrap_validation = bootstrap_validation,
        bootstrap_runs = bootstrap_runs,
        cross_validation = cross_validation,
        cv_folds = cv_folds,
        performance_metrics = performance_metrics,
        survival_analysis = survival_analysis,
        confidence_level = confidence_level,
        multiple_testing = multiple_testing,
        plot_roc = plot_roc,
        plot_distribution = plot_distribution,
        plot_survival = plot_survival)

    analysis <- optimalcutpointClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

