
# This file is automatically generated, you probably don't want to edit this

advancedanovaOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "advancedanovaOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            dependent = NULL,
            fixed = NULL,
            covariates = NULL,
            wls = NULL,
            model_type = "oneway",
            posthoc_method = "tukey",
            control_group = "",
            assumptions = TRUE,
            effect_sizes = TRUE,
            descriptives = TRUE,
            show_plots = TRUE,
            plot_type = "both",
            confidence_level = 0.95,
            alpha_level = 0.05,
            welch_correction = FALSE,
            robust_anova = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="advancedanova",
                requiresData=TRUE,
                ...)

            private$..dependent <- jmvcore::OptionVariable$new(
                "dependent",
                dependent,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..fixed <- jmvcore::OptionVariables$new(
                "fixed",
                fixed,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..wls <- jmvcore::OptionVariable$new(
                "wls",
                wls,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..model_type <- jmvcore::OptionList$new(
                "model_type",
                model_type,
                options=list(
                    "oneway",
                    "factorial",
                    "ancova",
                    "repeated"),
                default="oneway")
            private$..posthoc_method <- jmvcore::OptionList$new(
                "posthoc_method",
                posthoc_method,
                options=list(
                    "tukey",
                    "games_howell",
                    "dunnett",
                    "bonferroni",
                    "holm",
                    "all"),
                default="tukey")
            private$..control_group <- jmvcore::OptionString$new(
                "control_group",
                control_group,
                default="")
            private$..assumptions <- jmvcore::OptionBool$new(
                "assumptions",
                assumptions,
                default=TRUE)
            private$..effect_sizes <- jmvcore::OptionBool$new(
                "effect_sizes",
                effect_sizes,
                default=TRUE)
            private$..descriptives <- jmvcore::OptionBool$new(
                "descriptives",
                descriptives,
                default=TRUE)
            private$..show_plots <- jmvcore::OptionBool$new(
                "show_plots",
                show_plots,
                default=TRUE)
            private$..plot_type <- jmvcore::OptionList$new(
                "plot_type",
                plot_type,
                options=list(
                    "diagnostic",
                    "means",
                    "both"),
                default="both")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..alpha_level <- jmvcore::OptionNumber$new(
                "alpha_level",
                alpha_level,
                min=0.001,
                max=0.1,
                default=0.05)
            private$..welch_correction <- jmvcore::OptionBool$new(
                "welch_correction",
                welch_correction,
                default=FALSE)
            private$..robust_anova <- jmvcore::OptionBool$new(
                "robust_anova",
                robust_anova,
                default=FALSE)

            self$.addOption(private$..dependent)
            self$.addOption(private$..fixed)
            self$.addOption(private$..covariates)
            self$.addOption(private$..wls)
            self$.addOption(private$..model_type)
            self$.addOption(private$..posthoc_method)
            self$.addOption(private$..control_group)
            self$.addOption(private$..assumptions)
            self$.addOption(private$..effect_sizes)
            self$.addOption(private$..descriptives)
            self$.addOption(private$..show_plots)
            self$.addOption(private$..plot_type)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..alpha_level)
            self$.addOption(private$..welch_correction)
            self$.addOption(private$..robust_anova)
        }),
    active = list(
        dependent = function() private$..dependent$value,
        fixed = function() private$..fixed$value,
        covariates = function() private$..covariates$value,
        wls = function() private$..wls$value,
        model_type = function() private$..model_type$value,
        posthoc_method = function() private$..posthoc_method$value,
        control_group = function() private$..control_group$value,
        assumptions = function() private$..assumptions$value,
        effect_sizes = function() private$..effect_sizes$value,
        descriptives = function() private$..descriptives$value,
        show_plots = function() private$..show_plots$value,
        plot_type = function() private$..plot_type$value,
        confidence_level = function() private$..confidence_level$value,
        alpha_level = function() private$..alpha_level$value,
        welch_correction = function() private$..welch_correction$value,
        robust_anova = function() private$..robust_anova$value),
    private = list(
        ..dependent = NA,
        ..fixed = NA,
        ..covariates = NA,
        ..wls = NA,
        ..model_type = NA,
        ..posthoc_method = NA,
        ..control_group = NA,
        ..assumptions = NA,
        ..effect_sizes = NA,
        ..descriptives = NA,
        ..show_plots = NA,
        ..plot_type = NA,
        ..confidence_level = NA,
        ..alpha_level = NA,
        ..welch_correction = NA,
        ..robust_anova = NA)
)

advancedanovaResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "advancedanovaResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        descriptives = function() private$.items[["descriptives"]],
        assumptions = function() private$.items[["assumptions"]],
        anova = function() private$.items[["anova"]],
        tukey = function() private$.items[["tukey"]],
        gameshowell = function() private$.items[["gameshowell"]],
        dunnett = function() private$.items[["dunnett"]],
        bonferroni = function() private$.items[["bonferroni"]],
        anovaplot = function() private$.items[["anovaplot"]],
        diagnosticplot = function() private$.items[["diagnosticplot"]],
        meansplot = function() private$.items[["meansplot"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Advanced ANOVA Suite",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "car",
                    "pwr",
                    "PMCMRplus",
                    "multcomp"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Getting Started",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="descriptives",
                title="Descriptive Statistics",
                visible="(descriptives)",
                clearWith=list(
                    "dependent",
                    "fixed"),
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="mean", 
                        `title`="Mean", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="sd", 
                        `title`="SD", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="median", 
                        `title`="Median", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="min_val", 
                        `title`="Min", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="max_val", 
                        `title`="Max", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="assumptions",
                title="Assumption Checking",
                visible="(assumptions)",
                clearWith=list(
                    "dependent",
                    "fixed",
                    "model_type"),
                columns=list(
                    list(
                        `name`="assumption", 
                        `title`="Assumption", 
                        `type`="text"),
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="conclusion", 
                        `title`="Conclusion", 
                        `type`="text"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="anova",
                title="ANOVA Results",
                clearWith=list(
                    "dependent",
                    "fixed",
                    "model_type",
                    "effect_sizes"),
                columns=list(
                    list(
                        `name`="source", 
                        `title`="Source", 
                        `type`="text"),
                    list(
                        `name`="ss", 
                        `title`="Sum of Squares", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="ms", 
                        `title`="Mean Square", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="f_statistic", 
                        `title`="F", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="eta_squared", 
                        `title`="Effect Sizes", 
                        `type`="text"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="tukey",
                title="Tukey HSD Post Hoc Test",
                visible="(posthoc_method:tukey || posthoc_method:all)",
                clearWith=list(
                    "dependent",
                    "fixed",
                    "posthoc_method",
                    "alpha_level"),
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="mean_diff", 
                        `title`="Mean Difference", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="p_adjusted", 
                        `title`="Adjusted p", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="cohens_d", 
                        `title`="Cohen's d", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="interpretation", 
                        `title`="Effect Size", 
                        `type`="text"),
                    list(
                        `name`="significance", 
                        `title`="Significance", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="gameshowell",
                title="Games-Howell Post Hoc Test",
                visible="(posthoc_method:games_howell || posthoc_method:all)",
                clearWith=list(
                    "dependent",
                    "fixed",
                    "posthoc_method",
                    "alpha_level"),
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="mean_diff", 
                        `title`="Mean Difference", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="se_diff", 
                        `title`="SE Difference", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="t_statistic", 
                        `title`="t-statistic", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="p_adjusted", 
                        `title`="Adjusted p", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="cohens_d", 
                        `title`="Cohen's d", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="interpretation", 
                        `title`="Effect Size", 
                        `type`="text"),
                    list(
                        `name`="significance", 
                        `title`="Significance", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="dunnett",
                title="Dunnett's Test vs Control",
                visible="(posthoc_method:dunnett || posthoc_method:all)",
                clearWith=list(
                    "dependent",
                    "fixed",
                    "posthoc_method",
                    "control_group",
                    "alpha_level"),
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="std_error", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="t_statistic", 
                        `title`="t-statistic", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="p_adjusted", 
                        `title`="Adjusted p", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="cohens_d", 
                        `title`="Cohen's d", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="interpretation", 
                        `title`="Effect Size", 
                        `type`="text"),
                    list(
                        `name`="significance", 
                        `title`="Significance", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="bonferroni",
                title="Bonferroni Post Hoc Test",
                visible="(posthoc_method:bonferroni || posthoc_method:all)",
                clearWith=list(
                    "dependent",
                    "fixed",
                    "posthoc_method",
                    "alpha_level"),
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="mean_diff", 
                        `title`="Mean Difference", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="pooled_se", 
                        `title`="Pooled SE", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="t_statistic", 
                        `title`="t-statistic", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="p_adjusted", 
                        `title`="Adjusted p", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="cohens_d", 
                        `title`="Cohen's d", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="interpretation", 
                        `title`="Effect Size", 
                        `type`="text"),
                    list(
                        `name`="significance", 
                        `title`="Significance", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="anovaplot",
                title="ANOVA Comparison Plot",
                width=800,
                height=600,
                visible="(show_plots)",
                requiresData=TRUE,
                renderFun=".anovaplot",
                clearWith=list(
                    "dependent",
                    "fixed",
                    "show_plots")))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagnosticplot",
                title="Diagnostic Plots",
                width=800,
                height=600,
                visible="(show_plots && (plot_type:diagnostic || plot_type:both))",
                requiresData=TRUE,
                clearWith=list(
                    "dependent",
                    "fixed",
                    "show_plots",
                    "plot_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="meansplot",
                title="Group Means Plot",
                width=600,
                height=500,
                visible="(show_plots && (plot_type:means || plot_type:both))",
                requiresData=TRUE,
                clearWith=list(
                    "dependent",
                    "fixed",
                    "show_plots",
                    "plot_type",
                    "confidence_level")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation and Guidelines",
                visible=TRUE))}))

advancedanovaBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "advancedanovaBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "advancedanova",
                version = c(1,0,0),
                options = options,
                results = advancedanovaResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = TRUE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Advanced ANOVA Suite
#'
#' Advanced ANOVA analysis with comprehensive post hoc testing, 
#' effect sizes, and assumption checking. Addresses the critical issue 
#' where 68\% of pathology studies fail proper multiple comparisons.
#' 
#'
#' @examples
#' data('ToothGrowth')
#'
#' advancedanova(data = ToothGrowth,
#'              dependent = len,
#'              fixed = supp)
#'
#' @param data the data as a data frame
#' @param dependent The dependent variable from \code{data}, variable must be
#'   numeric
#' @param fixed The grouping variable(s) from \code{data}, variable(s) must be
#'   a factor
#' @param covariates Optional covariates for ANCOVA analysis
#' @param wls Optional weights for weighted least squares
#' @param model_type Type of ANOVA model to fit
#' @param posthoc_method Post hoc comparison method
#' @param control_group Control group for Dunnett's test comparisons
#' @param assumptions Check and report ANOVA assumptions
#' @param effect_sizes Calculate eta-squared, omega-squared, and Cohen's f
#' @param descriptives Show descriptive statistics for each group
#' @param show_plots Generate diagnostic and comparison plots
#' @param plot_type Type of plots to generate
#' @param confidence_level Confidence level for effect size confidence
#'   intervals
#' @param alpha_level Alpha level for significance testing
#' @param welch_correction Apply Welch correction for unequal variances
#' @param robust_anova Use robust ANOVA methods for non-normal data
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab Instructions for using the Advanced ANOVA Suite \cr
#'   \code{results$descriptives} \tab \tab \tab \tab \tab Descriptive statistics for each group \cr
#'   \code{results$assumptions} \tab \tab \tab \tab \tab Tests of ANOVA assumptions \cr
#'   \code{results$anova} \tab \tab \tab \tab \tab Main ANOVA results with effect sizes \cr
#'   \code{results$tukey} \tab \tab \tab \tab \tab Tukey Honestly Significant Difference test results \cr
#'   \code{results$gameshowell} \tab \tab \tab \tab \tab Games-Howell test for unequal variances \cr
#'   \code{results$dunnett} \tab \tab \tab \tab \tab Dunnett's test comparing treatments to control \cr
#'   \code{results$bonferroni} \tab \tab \tab \tab \tab Bonferroni-corrected pairwise comparisons \cr
#'   \code{results$anovaplot} \tab \tab \tab \tab \tab Violin plots with boxplots and group means \cr
#'   \code{results$diagnosticplot} \tab \tab \tab \tab \tab Residual plots and assumption checking \cr
#'   \code{results$meansplot} \tab \tab \tab \tab \tab Group means with confidence intervals \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab Clinical context and interpretation guidelines \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$descriptives$asDF}
#'
#' \code{as.data.frame(results$descriptives)}
#'
#' @export
advancedanova <- function(
    data,
    dependent,
    fixed,
    covariates,
    wls,
    model_type = "oneway",
    posthoc_method = "tukey",
    control_group = "",
    assumptions = TRUE,
    effect_sizes = TRUE,
    descriptives = TRUE,
    show_plots = TRUE,
    plot_type = "both",
    confidence_level = 0.95,
    alpha_level = 0.05,
    welch_correction = FALSE,
    robust_anova = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("advancedanova requires jmvcore to be installed (restart may be required)")

    if ( ! missing(dependent)) dependent <- jmvcore::resolveQuo(jmvcore::enquo(dependent))
    if ( ! missing(fixed)) fixed <- jmvcore::resolveQuo(jmvcore::enquo(fixed))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(wls)) wls <- jmvcore::resolveQuo(jmvcore::enquo(wls))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(dependent), dependent, NULL),
            `if`( ! missing(fixed), fixed, NULL),
            `if`( ! missing(covariates), covariates, NULL),
            `if`( ! missing(wls), wls, NULL))

    for (v in fixed) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- advancedanovaOptions$new(
        dependent = dependent,
        fixed = fixed,
        covariates = covariates,
        wls = wls,
        model_type = model_type,
        posthoc_method = posthoc_method,
        control_group = control_group,
        assumptions = assumptions,
        effect_sizes = effect_sizes,
        descriptives = descriptives,
        show_plots = show_plots,
        plot_type = plot_type,
        confidence_level = confidence_level,
        alpha_level = alpha_level,
        welch_correction = welch_correction,
        robust_anova = robust_anova)

    analysis <- advancedanovaClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

