
# This file is automatically generated, you probably don't want to edit this

recurrentsurvivalOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "recurrentsurvivalOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            subject_id = NULL,
            event_time = NULL,
            event_status = NULL,
            terminal_event = NULL,
            terminal_status = NULL,
            event_type = NULL,
            covariates = NULL,
            stratification_vars = NULL,
            model_type = "ag_model",
            time_scale = "gap_time",
            frailty_distribution = "gamma",
            robust_variance = TRUE,
            cluster_variable = NULL,
            baseline_hazard_smooth = FALSE,
            smoothing_bandwidth = 1,
            confidence_level = 0.95,
            max_events = 10,
            terminal_competing = TRUE,
            recurrence_plots = TRUE,
            gap_time_plots = FALSE,
            cumulative_hazard = TRUE,
            model_diagnostics = TRUE,
            goodness_of_fit = TRUE,
            prediction_times = "12,24,36,60",
            bootstrap_samples = 200,
            convergence_tolerance = 0.0001,
            max_iterations = 500, ...) {

            super$initialize(
                package="ClinicoPath",
                name="recurrentsurvival",
                requiresData=FALSE,
                ...)

            private$..subject_id <- jmvcore::OptionVariable$new(
                "subject_id",
                subject_id,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..event_time <- jmvcore::OptionVariable$new(
                "event_time",
                event_time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event_status <- jmvcore::OptionVariable$new(
                "event_status",
                event_status,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..terminal_event <- jmvcore::OptionVariable$new(
                "terminal_event",
                terminal_event,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..terminal_status <- jmvcore::OptionVariable$new(
                "terminal_status",
                terminal_status,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..event_type <- jmvcore::OptionVariable$new(
                "event_type",
                event_type,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..stratification_vars <- jmvcore::OptionVariables$new(
                "stratification_vars",
                stratification_vars,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..model_type <- jmvcore::OptionList$new(
                "model_type",
                model_type,
                options=list(
                    "ag_model",
                    "pwp_cp",
                    "pwp_gt",
                    "msm_model",
                    "frailty_gamma",
                    "frailty_lognormal",
                    "counting_process"),
                default="ag_model")
            private$..time_scale <- jmvcore::OptionList$new(
                "time_scale",
                time_scale,
                options=list(
                    "gap_time",
                    "calendar_time",
                    "counting_process"),
                default="gap_time")
            private$..frailty_distribution <- jmvcore::OptionList$new(
                "frailty_distribution",
                frailty_distribution,
                options=list(
                    "gamma",
                    "lognormal",
                    "gaussian",
                    "stable"),
                default="gamma")
            private$..robust_variance <- jmvcore::OptionBool$new(
                "robust_variance",
                robust_variance,
                default=TRUE)
            private$..cluster_variable <- jmvcore::OptionVariable$new(
                "cluster_variable",
                cluster_variable,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..baseline_hazard_smooth <- jmvcore::OptionBool$new(
                "baseline_hazard_smooth",
                baseline_hazard_smooth,
                default=FALSE)
            private$..smoothing_bandwidth <- jmvcore::OptionNumber$new(
                "smoothing_bandwidth",
                smoothing_bandwidth,
                default=1,
                min=0.1,
                max=10)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.8,
                max=0.99)
            private$..max_events <- jmvcore::OptionInteger$new(
                "max_events",
                max_events,
                default=10,
                min=2,
                max=50)
            private$..terminal_competing <- jmvcore::OptionBool$new(
                "terminal_competing",
                terminal_competing,
                default=TRUE)
            private$..recurrence_plots <- jmvcore::OptionBool$new(
                "recurrence_plots",
                recurrence_plots,
                default=TRUE)
            private$..gap_time_plots <- jmvcore::OptionBool$new(
                "gap_time_plots",
                gap_time_plots,
                default=FALSE)
            private$..cumulative_hazard <- jmvcore::OptionBool$new(
                "cumulative_hazard",
                cumulative_hazard,
                default=TRUE)
            private$..model_diagnostics <- jmvcore::OptionBool$new(
                "model_diagnostics",
                model_diagnostics,
                default=TRUE)
            private$..goodness_of_fit <- jmvcore::OptionBool$new(
                "goodness_of_fit",
                goodness_of_fit,
                default=TRUE)
            private$..prediction_times <- jmvcore::OptionString$new(
                "prediction_times",
                prediction_times,
                default="12,24,36,60")
            private$..bootstrap_samples <- jmvcore::OptionInteger$new(
                "bootstrap_samples",
                bootstrap_samples,
                default=200,
                min=50,
                max=1000)
            private$..convergence_tolerance <- jmvcore::OptionNumber$new(
                "convergence_tolerance",
                convergence_tolerance,
                default=0.0001,
                min=0.00001,
                max=0.01)
            private$..max_iterations <- jmvcore::OptionInteger$new(
                "max_iterations",
                max_iterations,
                default=500,
                min=50,
                max=2000)

            self$.addOption(private$..subject_id)
            self$.addOption(private$..event_time)
            self$.addOption(private$..event_status)
            self$.addOption(private$..terminal_event)
            self$.addOption(private$..terminal_status)
            self$.addOption(private$..event_type)
            self$.addOption(private$..covariates)
            self$.addOption(private$..stratification_vars)
            self$.addOption(private$..model_type)
            self$.addOption(private$..time_scale)
            self$.addOption(private$..frailty_distribution)
            self$.addOption(private$..robust_variance)
            self$.addOption(private$..cluster_variable)
            self$.addOption(private$..baseline_hazard_smooth)
            self$.addOption(private$..smoothing_bandwidth)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..max_events)
            self$.addOption(private$..terminal_competing)
            self$.addOption(private$..recurrence_plots)
            self$.addOption(private$..gap_time_plots)
            self$.addOption(private$..cumulative_hazard)
            self$.addOption(private$..model_diagnostics)
            self$.addOption(private$..goodness_of_fit)
            self$.addOption(private$..prediction_times)
            self$.addOption(private$..bootstrap_samples)
            self$.addOption(private$..convergence_tolerance)
            self$.addOption(private$..max_iterations)
        }),
    active = list(
        subject_id = function() private$..subject_id$value,
        event_time = function() private$..event_time$value,
        event_status = function() private$..event_status$value,
        terminal_event = function() private$..terminal_event$value,
        terminal_status = function() private$..terminal_status$value,
        event_type = function() private$..event_type$value,
        covariates = function() private$..covariates$value,
        stratification_vars = function() private$..stratification_vars$value,
        model_type = function() private$..model_type$value,
        time_scale = function() private$..time_scale$value,
        frailty_distribution = function() private$..frailty_distribution$value,
        robust_variance = function() private$..robust_variance$value,
        cluster_variable = function() private$..cluster_variable$value,
        baseline_hazard_smooth = function() private$..baseline_hazard_smooth$value,
        smoothing_bandwidth = function() private$..smoothing_bandwidth$value,
        confidence_level = function() private$..confidence_level$value,
        max_events = function() private$..max_events$value,
        terminal_competing = function() private$..terminal_competing$value,
        recurrence_plots = function() private$..recurrence_plots$value,
        gap_time_plots = function() private$..gap_time_plots$value,
        cumulative_hazard = function() private$..cumulative_hazard$value,
        model_diagnostics = function() private$..model_diagnostics$value,
        goodness_of_fit = function() private$..goodness_of_fit$value,
        prediction_times = function() private$..prediction_times$value,
        bootstrap_samples = function() private$..bootstrap_samples$value,
        convergence_tolerance = function() private$..convergence_tolerance$value,
        max_iterations = function() private$..max_iterations$value),
    private = list(
        ..subject_id = NA,
        ..event_time = NA,
        ..event_status = NA,
        ..terminal_event = NA,
        ..terminal_status = NA,
        ..event_type = NA,
        ..covariates = NA,
        ..stratification_vars = NA,
        ..model_type = NA,
        ..time_scale = NA,
        ..frailty_distribution = NA,
        ..robust_variance = NA,
        ..cluster_variable = NA,
        ..baseline_hazard_smooth = NA,
        ..smoothing_bandwidth = NA,
        ..confidence_level = NA,
        ..max_events = NA,
        ..terminal_competing = NA,
        ..recurrence_plots = NA,
        ..gap_time_plots = NA,
        ..cumulative_hazard = NA,
        ..model_diagnostics = NA,
        ..goodness_of_fit = NA,
        ..prediction_times = NA,
        ..bootstrap_samples = NA,
        ..convergence_tolerance = NA,
        ..max_iterations = NA)
)

recurrentsurvivalResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "recurrentsurvivalResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        data_summary = function() private$.items[["data_summary"]],
        model_results = function() private$.items[["model_results"]],
        covariate_effects = function() private$.items[["covariate_effects"]],
        recurrence_estimates = function() private$.items[["recurrence_estimates"]],
        gap_time_summary = function() private$.items[["gap_time_summary"]],
        terminal_event_summary = function() private$.items[["terminal_event_summary"]],
        frailty_estimates = function() private$.items[["frailty_estimates"]],
        model_diagnostics_summary = function() private$.items[["model_diagnostics_summary"]],
        goodness_of_fit_results = function() private$.items[["goodness_of_fit_results"]],
        event_frequency_table = function() private$.items[["event_frequency_table"]],
        recurrence_plots = function() private$.items[["recurrence_plots"]],
        gap_time_plots = function() private$.items[["gap_time_plots"]],
        cumulative_hazard_plot = function() private$.items[["cumulative_hazard_plot"]],
        event_timeline_plot = function() private$.items[["event_timeline_plot"]],
        residual_plots = function() private$.items[["residual_plots"]],
        frailty_distribution_plot = function() private$.items[["frailty_distribution_plot"]],
        multistate_diagram = function() private$.items[["multistate_diagram"]],
        model_comparison_plot = function() private$.items[["model_comparison_plot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Recurrent Event Survival Analysis")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Analysis Instructions",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="data_summary",
                title="Recurrent Event Data Summary",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="model_results",
                title="Model Estimation Results",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="covariate_effects",
                title="Covariate Effects",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="recurrence_estimates",
                title="Recurrence Function Estimates",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="gap_time_summary",
                title="Gap Time Analysis",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="terminal_event_summary",
                title="Terminal Event Analysis",
                visible="(terminal_event)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="frailty_estimates",
                title="Frailty Parameter Estimates",
                visible="(model_type == 'frailty_gamma' || model_type == 'frailty_lognormal')"))
            self$add(jmvcore::Html$new(
                options=options,
                name="model_diagnostics_summary",
                title="Model Diagnostics",
                visible="(model_diagnostics)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="goodness_of_fit_results",
                title="Goodness of Fit Tests",
                visible="(goodness_of_fit)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="event_frequency_table",
                title="Event Frequency Distribution",
                visible=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="recurrence_plots",
                title="Recurrence Function Plots",
                width=800,
                height=600,
                renderFun=".plot_recurrence_functions",
                visible="(recurrence_plots)",
                clearWith=list(
                    "subject_id",
                    "event_time",
                    "model_type",
                    "covariates")))
            self$add(jmvcore::Image$new(
                options=options,
                name="gap_time_plots",
                title="Gap Time Distribution Plots",
                width=800,
                height=600,
                renderFun=".plot_gap_time_distributions",
                visible="(gap_time_plots)",
                clearWith=list(
                    "subject_id",
                    "event_time",
                    "time_scale")))
            self$add(jmvcore::Image$new(
                options=options,
                name="cumulative_hazard_plot",
                title="Cumulative Hazard Function",
                width=800,
                height=600,
                renderFun=".plot_cumulative_hazard",
                visible="(cumulative_hazard)",
                clearWith=list(
                    "subject_id",
                    "event_time",
                    "model_type",
                    "baseline_hazard_smooth")))
            self$add(jmvcore::Image$new(
                options=options,
                name="event_timeline_plot",
                title="Event Timeline Visualization",
                width=1000,
                height=600,
                renderFun=".plot_event_timeline",
                visible=TRUE,
                clearWith=list(
                    "subject_id",
                    "event_time",
                    "event_type",
                    "terminal_event")))
            self$add(jmvcore::Image$new(
                options=options,
                name="residual_plots",
                title="Residual Diagnostic Plots",
                width=800,
                height=600,
                renderFun=".plot_residuals",
                visible="(model_diagnostics)",
                clearWith=list(
                    "model_type",
                    "covariates",
                    "time_scale")))
            self$add(jmvcore::Image$new(
                options=options,
                name="frailty_distribution_plot",
                title="Frailty Distribution Plot",
                width=800,
                height=600,
                renderFun=".plot_frailty_distribution",
                visible="(model_type == 'frailty_gamma' || model_type == 'frailty_lognormal')",
                clearWith=list(
                    "frailty_distribution",
                    "model_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="multistate_diagram",
                title="Multi-State Model Diagram",
                width=800,
                height=600,
                renderFun=".plot_multistate_diagram",
                visible="(model_type == 'msm_model')",
                clearWith=list(
                    "event_type",
                    "terminal_event")))
            self$add(jmvcore::Image$new(
                options=options,
                name="model_comparison_plot",
                title="Model Comparison",
                width=800,
                height=600,
                renderFun=".plot_model_comparison",
                visible="(goodness_of_fit)",
                clearWith=list(
                    "model_type",
                    "time_scale",
                    "covariates")))}))

recurrentsurvivalBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "recurrentsurvivalBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "recurrentsurvival",
                version = c(0,0,1),
                options = options,
                results = recurrentsurvivalResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'na')
        }))

#' Recurrent Event Survival Analysis
#'
#' Recurrent event survival analysis for subjects who can experience multiple 
#' events over time. Common in cancer recurrence, infections, 
#' hospitalizations, 
#' and chronic disease episodes. Handles gap time, calendar time, and counting 
#' process formulations.
#' 
#'
#' @examples
#' # Example: Cancer recurrence analysis
#' recurrentsurvival(
#'     data = cancer_data,
#'     subject_id = patient_id,
#'     event_time = recurrence_time,
#'     event_type = recurrence_type,
#'     terminal_event = death,
#'     covariates = c("age", "stage", "treatment"),
#'     model_type = "ag_model"
#' )
#'
#' @param subject_id Variable identifying unique subjects who can have
#'   multiple events
#' @param event_time Time variable for recurrent event occurrence
#' @param event_status Event status indicator for recurrent events
#' @param terminal_event Terminal event that stops the recurrence process
#' @param terminal_status Status indicator for terminal event
#' @param event_type Classification of different types of recurrent events
#' @param covariates Covariates to include in the recurrent event model
#' @param stratification_vars Variables for stratifying the baseline hazard
#' @param model_type Model specification for recurrent event data
#' @param time_scale Time scale specification for recurrent events
#' @param frailty_distribution Distribution assumption for frailty terms
#' @param robust_variance Whether to use robust variance estimation
#' @param cluster_variable Variable for clustering in variance estimation
#' @param baseline_hazard_smooth Whether to smooth the baseline hazard
#'   function
#' @param smoothing_bandwidth Bandwidth for baseline hazard smoothing
#' @param confidence_level Confidence level for parameter estimates
#' @param max_events Upper limit on events per subject for analysis
#' @param terminal_competing Whether to model terminal event as competing risk
#' @param recurrence_plots Whether to plot recurrence functions
#' @param gap_time_plots Whether to plot gap time distributions
#' @param cumulative_hazard Whether to plot cumulative hazard functions
#' @param model_diagnostics Whether to include model diagnostics
#' @param goodness_of_fit Whether to test model goodness-of-fit
#' @param prediction_times Time points for recurrence probability predictions
#' @param bootstrap_samples Number of bootstrap resamples
#' @param convergence_tolerance Convergence criterion for iterative algorithms
#' @param max_iterations Maximum number of algorithm iterations
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$data_summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$model_results} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$covariate_effects} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$recurrence_estimates} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$gap_time_summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$terminal_event_summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$frailty_estimates} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$model_diagnostics_summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$goodness_of_fit_results} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$event_frequency_table} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$recurrence_plots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$gap_time_plots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$cumulative_hazard_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$event_timeline_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$residual_plots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$frailty_distribution_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$multistate_diagram} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$model_comparison_plot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' @export
recurrentsurvival <- function(
    subject_id,
    event_time,
    event_status = NULL,
    terminal_event = NULL,
    terminal_status = NULL,
    event_type = NULL,
    covariates = NULL,
    stratification_vars = NULL,
    model_type = "ag_model",
    time_scale = "gap_time",
    frailty_distribution = "gamma",
    robust_variance = TRUE,
    cluster_variable = NULL,
    baseline_hazard_smooth = FALSE,
    smoothing_bandwidth = 1,
    confidence_level = 0.95,
    max_events = 10,
    terminal_competing = TRUE,
    recurrence_plots = TRUE,
    gap_time_plots = FALSE,
    cumulative_hazard = TRUE,
    model_diagnostics = TRUE,
    goodness_of_fit = TRUE,
    prediction_times = "12,24,36,60",
    bootstrap_samples = 200,
    convergence_tolerance = 0.0001,
    max_iterations = 500) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("recurrentsurvival requires jmvcore to be installed (restart may be required)")

    if ( ! missing(subject_id)) subject_id <- jmvcore::resolveQuo(jmvcore::enquo(subject_id))
    if ( ! missing(event_time)) event_time <- jmvcore::resolveQuo(jmvcore::enquo(event_time))
    if ( ! missing(event_status)) event_status <- jmvcore::resolveQuo(jmvcore::enquo(event_status))
    if ( ! missing(terminal_event)) terminal_event <- jmvcore::resolveQuo(jmvcore::enquo(terminal_event))
    if ( ! missing(terminal_status)) terminal_status <- jmvcore::resolveQuo(jmvcore::enquo(terminal_status))
    if ( ! missing(event_type)) event_type <- jmvcore::resolveQuo(jmvcore::enquo(event_type))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(stratification_vars)) stratification_vars <- jmvcore::resolveQuo(jmvcore::enquo(stratification_vars))
    if ( ! missing(cluster_variable)) cluster_variable <- jmvcore::resolveQuo(jmvcore::enquo(cluster_variable))

    options <- recurrentsurvivalOptions$new(
        subject_id = subject_id,
        event_time = event_time,
        event_status = event_status,
        terminal_event = terminal_event,
        terminal_status = terminal_status,
        event_type = event_type,
        covariates = covariates,
        stratification_vars = stratification_vars,
        model_type = model_type,
        time_scale = time_scale,
        frailty_distribution = frailty_distribution,
        robust_variance = robust_variance,
        cluster_variable = cluster_variable,
        baseline_hazard_smooth = baseline_hazard_smooth,
        smoothing_bandwidth = smoothing_bandwidth,
        confidence_level = confidence_level,
        max_events = max_events,
        terminal_competing = terminal_competing,
        recurrence_plots = recurrence_plots,
        gap_time_plots = gap_time_plots,
        cumulative_hazard = cumulative_hazard,
        model_diagnostics = model_diagnostics,
        goodness_of_fit = goodness_of_fit,
        prediction_times = prediction_times,
        bootstrap_samples = bootstrap_samples,
        convergence_tolerance = convergence_tolerance,
        max_iterations = max_iterations)

    analysis <- recurrentsurvivalClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

