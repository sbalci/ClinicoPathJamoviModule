
# This file is automatically generated, you probably don't want to edit this

eurostatmapOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "eurostatmapOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            dataset_id = "demo_r_gind3",
            indicator = NULL,
            geo_var = NULL,
            geo_level = "nuts2",
            year = 2022,
            map_type = "static",
            color_palette = "viridis",
            map_title = "Eurostat Map",
            use_local_data = FALSE,
            classification_method = "quantile",
            n_classes = 5,
            cache_data = TRUE,
            add_to_data = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="eurostatmap",
                requiresData=TRUE,
                ...)

            private$..dataset_id <- jmvcore::OptionString$new(
                "dataset_id",
                dataset_id,
                default="demo_r_gind3")
            private$..indicator <- jmvcore::OptionVariable$new(
                "indicator",
                indicator,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..geo_var <- jmvcore::OptionVariable$new(
                "geo_var",
                geo_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric",
                    "id"),
                default=NULL)
            private$..geo_level <- jmvcore::OptionList$new(
                "geo_level",
                geo_level,
                options=list(
                    "nuts0",
                    "nuts1",
                    "nuts2",
                    "nuts3"),
                default="nuts2")
            private$..year <- jmvcore::OptionNumber$new(
                "year",
                year,
                default=2022)
            private$..map_type <- jmvcore::OptionList$new(
                "map_type",
                map_type,
                options=list(
                    "static",
                    "interactive"),
                default="static")
            private$..color_palette <- jmvcore::OptionList$new(
                "color_palette",
                color_palette,
                options=list(
                    "viridis",
                    "plasma",
                    "blues",
                    "reds",
                    "greens"),
                default="viridis")
            private$..map_title <- jmvcore::OptionString$new(
                "map_title",
                map_title,
                default="Eurostat Map")
            private$..use_local_data <- jmvcore::OptionBool$new(
                "use_local_data",
                use_local_data,
                default=FALSE)
            private$..classification_method <- jmvcore::OptionList$new(
                "classification_method",
                classification_method,
                options=list(
                    "quantile",
                    "equal",
                    "jenks",
                    "pretty"),
                default="quantile")
            private$..n_classes <- jmvcore::OptionNumber$new(
                "n_classes",
                n_classes,
                default=5,
                min=3,
                max=10)
            private$..cache_data <- jmvcore::OptionBool$new(
                "cache_data",
                cache_data,
                default=TRUE)
            private$..add_to_data <- jmvcore::OptionBool$new(
                "add_to_data",
                add_to_data,
                default=FALSE)

            self$.addOption(private$..dataset_id)
            self$.addOption(private$..indicator)
            self$.addOption(private$..geo_var)
            self$.addOption(private$..geo_level)
            self$.addOption(private$..year)
            self$.addOption(private$..map_type)
            self$.addOption(private$..color_palette)
            self$.addOption(private$..map_title)
            self$.addOption(private$..use_local_data)
            self$.addOption(private$..classification_method)
            self$.addOption(private$..n_classes)
            self$.addOption(private$..cache_data)
            self$.addOption(private$..add_to_data)
        }),
    active = list(
        dataset_id = function() private$..dataset_id$value,
        indicator = function() private$..indicator$value,
        geo_var = function() private$..geo_var$value,
        geo_level = function() private$..geo_level$value,
        year = function() private$..year$value,
        map_type = function() private$..map_type$value,
        color_palette = function() private$..color_palette$value,
        map_title = function() private$..map_title$value,
        use_local_data = function() private$..use_local_data$value,
        classification_method = function() private$..classification_method$value,
        n_classes = function() private$..n_classes$value,
        cache_data = function() private$..cache_data$value,
        add_to_data = function() private$..add_to_data$value),
    private = list(
        ..dataset_id = NA,
        ..indicator = NA,
        ..geo_var = NA,
        ..geo_level = NA,
        ..year = NA,
        ..map_type = NA,
        ..color_palette = NA,
        ..map_title = NA,
        ..use_local_data = NA,
        ..classification_method = NA,
        ..n_classes = NA,
        ..cache_data = NA,
        ..add_to_data = NA)
)

eurostatmapResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "eurostatmapResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        plot = function() private$.items[["plot"]],
        info = function() private$.items[["info"]],
        summary = function() private$.items[["summary"]],
        downloaded_data = function() private$.items[["downloaded_data"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Eurostat Map",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "tmap",
                    "eurostat"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot",
                title="Map",
                width=700,
                height=500,
                renderFun=".plot",
                clearWith=list(
                    "dataset_id",
                    "indicator",
                    "geo_level",
                    "year",
                    "map_type",
                    "color_palette",
                    "map_title",
                    "use_local_data",
                    "classification_method",
                    "n_classes")))
            self$add(jmvcore::Table$new(
                options=options,
                name="info",
                title="Dataset Information",
                rows=1,
                clearWith=list(
                    "dataset_id",
                    "use_local_data"),
                columns=list(
                    list(
                        `name`="dataset", 
                        `title`="Dataset ID", 
                        `type`="text"),
                    list(
                        `name`="title", 
                        `title`="Dataset Title", 
                        `type`="text"),
                    list(
                        `name`="observations", 
                        `title`="Observations", 
                        `type`="integer"),
                    list(
                        `name`="last_update", 
                        `title`="Last Update", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="summary",
                title="Data Summary",
                rows=6,
                clearWith=list(
                    "dataset_id",
                    "indicator",
                    "year",
                    "use_local_data"),
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="downloaded_data",
                title="Downloaded Data",
                visible="(add_to_data && !use_local_data)",
                clearWith=list(
                    "dataset_id",
                    "year",
                    "use_local_data"),
                columns=list()))}))

eurostatmapBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "eurostatmapBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "eurostatmap",
                version = c(0,0,3),
                options = options,
                results = eurostatmapResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Eurostat Map
#'
#' Creates choropleth maps using Eurostat data. You can either use sample 
#' datasets by providing a Eurostat dataset ID, or import your own Eurostat 
#' CSV data.  For local data, ensure it contains a 'geo' column with NUTS 
#' geographic codes.
#' 
#' @param data The data as a data frame.
#' @param dataset_id The Eurostat dataset identifier to retrieve data from.
#' @param indicator The variable containing the indicator values to map.
#' @param geo_var The variable containing NUTS geographic codes (for local
#'   data).
#' @param geo_level The geographic level for mapping.
#' @param year The year for which to display data.
#' @param map_type Choose between static or interactive map visualization.
#' @param color_palette Color palette for the choropleth map.
#' @param map_title The title displayed on the map.
#' @param use_local_data Use local data instead of downloading from Eurostat.
#' @param classification_method Method for classifying data into color
#'   categories.
#' @param n_classes Number of classes for data classification.
#' @param cache_data Cache downloaded Eurostat data to avoid repeated
#'   downloads.
#' @param add_to_data Add the downloaded Eurostat data to jamovi's data
#'   spreadsheet.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$info} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$downloaded_data} \tab \tab \tab \tab \tab a table \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$info$asDF}
#'
#' \code{as.data.frame(results$info)}
#'
#' @export
eurostatmap <- function(
    data,
    dataset_id = "demo_r_gind3",
    indicator,
    geo_var = NULL,
    geo_level = "nuts2",
    year = 2022,
    map_type = "static",
    color_palette = "viridis",
    map_title = "Eurostat Map",
    use_local_data = FALSE,
    classification_method = "quantile",
    n_classes = 5,
    cache_data = TRUE,
    add_to_data = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("eurostatmap requires jmvcore to be installed (restart may be required)")

    if ( ! missing(indicator)) indicator <- jmvcore::resolveQuo(jmvcore::enquo(indicator))
    if ( ! missing(geo_var)) geo_var <- jmvcore::resolveQuo(jmvcore::enquo(geo_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(indicator), indicator, NULL),
            `if`( ! missing(geo_var), geo_var, NULL))


    options <- eurostatmapOptions$new(
        dataset_id = dataset_id,
        indicator = indicator,
        geo_var = geo_var,
        geo_level = geo_level,
        year = year,
        map_type = map_type,
        color_palette = color_palette,
        map_title = map_title,
        use_local_data = use_local_data,
        classification_method = classification_method,
        n_classes = n_classes,
        cache_data = cache_data,
        add_to_data = add_to_data)

    analysis <- eurostatmapClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

