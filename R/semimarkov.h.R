
# This file is automatically generated, you probably don't want to edit this

semimarkovOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "semimarkovOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            event = NULL,
            subject = NULL,
            covs = NULL,
            modelType = "parametric",
            transitionStructure = "progressive",
            distributionType = "weibull",
            estimationMethod = "ml",
            timeScale = "auto",
            predictionHorizons = "1, 3, 5, 10",
            timePoints = "0.5, 1, 2, 3, 5",
            conf = 0.95,
            maxIterations = 1000,
            tolerance = 0.000001,
            bootstrapSamples = 500,
            showTransitionRates = TRUE,
            showSojournDistribution = TRUE,
            showTransitionProbs = TRUE,
            showStateProbabilities = TRUE,
            showReliabilityAnalysis = FALSE,
            showModelDiagnostics = TRUE,
            showPredictions = TRUE,
            showEducational = TRUE,
            plotSojournDistributions = TRUE,
            plotTransitionIntensities = FALSE,
            plotStateProbabilities = TRUE,
            plotReliabilityFunctions = FALSE,
            plotModelDiagnostics = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="semimarkov",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event <- jmvcore::OptionVariable$new(
                "event",
                event,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..subject <- jmvcore::OptionVariable$new(
                "subject",
                subject,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..covs <- jmvcore::OptionVariables$new(
                "covs",
                covs,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..modelType <- jmvcore::OptionList$new(
                "modelType",
                modelType,
                options=list(
                    "parametric",
                    "nonparametric",
                    "regression",
                    "competing",
                    "multiphase"),
                default="parametric")
            private$..transitionStructure <- jmvcore::OptionList$new(
                "transitionStructure",
                transitionStructure,
                options=list(
                    "progressive",
                    "reversible",
                    "illnessdeath",
                    "custom"),
                default="progressive")
            private$..distributionType <- jmvcore::OptionList$new(
                "distributionType",
                distributionType,
                options=list(
                    "exponential",
                    "weibull",
                    "gamma",
                    "lognormal",
                    "gengamma",
                    "nonparametric"),
                default="weibull")
            private$..estimationMethod <- jmvcore::OptionList$new(
                "estimationMethod",
                estimationMethod,
                options=list(
                    "ml",
                    "mm",
                    "bayesian",
                    "nonparametric"),
                default="ml")
            private$..timeScale <- jmvcore::OptionList$new(
                "timeScale",
                timeScale,
                options=list(
                    "days",
                    "months",
                    "years",
                    "auto"),
                default="auto")
            private$..predictionHorizons <- jmvcore::OptionString$new(
                "predictionHorizons",
                predictionHorizons,
                default="1, 3, 5, 10")
            private$..timePoints <- jmvcore::OptionString$new(
                "timePoints",
                timePoints,
                default="0.5, 1, 2, 3, 5")
            private$..conf <- jmvcore::OptionNumber$new(
                "conf",
                conf,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..maxIterations <- jmvcore::OptionNumber$new(
                "maxIterations",
                maxIterations,
                min=100,
                max=10000,
                default=1000)
            private$..tolerance <- jmvcore::OptionNumber$new(
                "tolerance",
                tolerance,
                min=1e-8,
                max=0.001,
                default=0.000001)
            private$..bootstrapSamples <- jmvcore::OptionNumber$new(
                "bootstrapSamples",
                bootstrapSamples,
                min=100,
                max=2000,
                default=500)
            private$..showTransitionRates <- jmvcore::OptionBool$new(
                "showTransitionRates",
                showTransitionRates,
                default=TRUE)
            private$..showSojournDistribution <- jmvcore::OptionBool$new(
                "showSojournDistribution",
                showSojournDistribution,
                default=TRUE)
            private$..showTransitionProbs <- jmvcore::OptionBool$new(
                "showTransitionProbs",
                showTransitionProbs,
                default=TRUE)
            private$..showStateProbabilities <- jmvcore::OptionBool$new(
                "showStateProbabilities",
                showStateProbabilities,
                default=TRUE)
            private$..showReliabilityAnalysis <- jmvcore::OptionBool$new(
                "showReliabilityAnalysis",
                showReliabilityAnalysis,
                default=FALSE)
            private$..showModelDiagnostics <- jmvcore::OptionBool$new(
                "showModelDiagnostics",
                showModelDiagnostics,
                default=TRUE)
            private$..showPredictions <- jmvcore::OptionBool$new(
                "showPredictions",
                showPredictions,
                default=TRUE)
            private$..showEducational <- jmvcore::OptionBool$new(
                "showEducational",
                showEducational,
                default=TRUE)
            private$..plotSojournDistributions <- jmvcore::OptionBool$new(
                "plotSojournDistributions",
                plotSojournDistributions,
                default=TRUE)
            private$..plotTransitionIntensities <- jmvcore::OptionBool$new(
                "plotTransitionIntensities",
                plotTransitionIntensities,
                default=FALSE)
            private$..plotStateProbabilities <- jmvcore::OptionBool$new(
                "plotStateProbabilities",
                plotStateProbabilities,
                default=TRUE)
            private$..plotReliabilityFunctions <- jmvcore::OptionBool$new(
                "plotReliabilityFunctions",
                plotReliabilityFunctions,
                default=FALSE)
            private$..plotModelDiagnostics <- jmvcore::OptionBool$new(
                "plotModelDiagnostics",
                plotModelDiagnostics,
                default=FALSE)

            self$.addOption(private$..time)
            self$.addOption(private$..event)
            self$.addOption(private$..subject)
            self$.addOption(private$..covs)
            self$.addOption(private$..modelType)
            self$.addOption(private$..transitionStructure)
            self$.addOption(private$..distributionType)
            self$.addOption(private$..estimationMethod)
            self$.addOption(private$..timeScale)
            self$.addOption(private$..predictionHorizons)
            self$.addOption(private$..timePoints)
            self$.addOption(private$..conf)
            self$.addOption(private$..maxIterations)
            self$.addOption(private$..tolerance)
            self$.addOption(private$..bootstrapSamples)
            self$.addOption(private$..showTransitionRates)
            self$.addOption(private$..showSojournDistribution)
            self$.addOption(private$..showTransitionProbs)
            self$.addOption(private$..showStateProbabilities)
            self$.addOption(private$..showReliabilityAnalysis)
            self$.addOption(private$..showModelDiagnostics)
            self$.addOption(private$..showPredictions)
            self$.addOption(private$..showEducational)
            self$.addOption(private$..plotSojournDistributions)
            self$.addOption(private$..plotTransitionIntensities)
            self$.addOption(private$..plotStateProbabilities)
            self$.addOption(private$..plotReliabilityFunctions)
            self$.addOption(private$..plotModelDiagnostics)
        }),
    active = list(
        time = function() private$..time$value,
        event = function() private$..event$value,
        subject = function() private$..subject$value,
        covs = function() private$..covs$value,
        modelType = function() private$..modelType$value,
        transitionStructure = function() private$..transitionStructure$value,
        distributionType = function() private$..distributionType$value,
        estimationMethod = function() private$..estimationMethod$value,
        timeScale = function() private$..timeScale$value,
        predictionHorizons = function() private$..predictionHorizons$value,
        timePoints = function() private$..timePoints$value,
        conf = function() private$..conf$value,
        maxIterations = function() private$..maxIterations$value,
        tolerance = function() private$..tolerance$value,
        bootstrapSamples = function() private$..bootstrapSamples$value,
        showTransitionRates = function() private$..showTransitionRates$value,
        showSojournDistribution = function() private$..showSojournDistribution$value,
        showTransitionProbs = function() private$..showTransitionProbs$value,
        showStateProbabilities = function() private$..showStateProbabilities$value,
        showReliabilityAnalysis = function() private$..showReliabilityAnalysis$value,
        showModelDiagnostics = function() private$..showModelDiagnostics$value,
        showPredictions = function() private$..showPredictions$value,
        showEducational = function() private$..showEducational$value,
        plotSojournDistributions = function() private$..plotSojournDistributions$value,
        plotTransitionIntensities = function() private$..plotTransitionIntensities$value,
        plotStateProbabilities = function() private$..plotStateProbabilities$value,
        plotReliabilityFunctions = function() private$..plotReliabilityFunctions$value,
        plotModelDiagnostics = function() private$..plotModelDiagnostics$value),
    private = list(
        ..time = NA,
        ..event = NA,
        ..subject = NA,
        ..covs = NA,
        ..modelType = NA,
        ..transitionStructure = NA,
        ..distributionType = NA,
        ..estimationMethod = NA,
        ..timeScale = NA,
        ..predictionHorizons = NA,
        ..timePoints = NA,
        ..conf = NA,
        ..maxIterations = NA,
        ..tolerance = NA,
        ..bootstrapSamples = NA,
        ..showTransitionRates = NA,
        ..showSojournDistribution = NA,
        ..showTransitionProbs = NA,
        ..showStateProbabilities = NA,
        ..showReliabilityAnalysis = NA,
        ..showModelDiagnostics = NA,
        ..showPredictions = NA,
        ..showEducational = NA,
        ..plotSojournDistributions = NA,
        ..plotTransitionIntensities = NA,
        ..plotStateProbabilities = NA,
        ..plotReliabilityFunctions = NA,
        ..plotModelDiagnostics = NA)
)

semimarkovResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "semimarkovResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        educationalInfo = function() private$.items[["educationalInfo"]],
        modelSummary = function() private$.items[["modelSummary"]],
        transitionRates = function() private$.items[["transitionRates"]],
        sojournDistribution = function() private$.items[["sojournDistribution"]],
        transitionProbabilities = function() private$.items[["transitionProbabilities"]],
        stateProbabilities = function() private$.items[["stateProbabilities"]],
        reliabilityAnalysis = function() private$.items[["reliabilityAnalysis"]],
        covariateEffects = function() private$.items[["covariateEffects"]],
        modelDiagnostics = function() private$.items[["modelDiagnostics"]],
        predictionsTable = function() private$.items[["predictionsTable"]],
        methodsInfo = function() private$.items[["methodsInfo"]],
        interpretationGuide = function() private$.items[["interpretationGuide"]],
        sojournDistributionPlot = function() private$.items[["sojournDistributionPlot"]],
        stateProbabilityPlot = function() private$.items[["stateProbabilityPlot"]],
        transitionIntensityPlot = function() private$.items[["transitionIntensityPlot"]],
        reliabilityPlot = function() private$.items[["reliabilityPlot"]],
        diagnosticsPlot = function() private$.items[["diagnosticsPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Semi-Markov Models",
                refs=list(
                    "SemiMarkov",
                    "survival",
                    "ReliabilityTheory",
                    "flexsurv",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="To Do",
                clearWith=list(
                    "time",
                    "event",
                    "subject")))
            self$add(jmvcore::Html$new(
                options=options,
                name="educationalInfo",
                title="Semi-Markov Models Guide",
                visible="(showEducational)",
                clearWith=list(
                    "modelType",
                    "transitionStructure")))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                rows=1,
                columns=list(
                    list(
                        `name`="model_type", 
                        `title`="Model Type", 
                        `type`="text"),
                    list(
                        `name`="n_states", 
                        `title`="States", 
                        `type`="number"),
                    list(
                        `name`="n_subjects", 
                        `title`="Subjects", 
                        `type`="number"),
                    list(
                        `name`="n_transitions", 
                        `title`="Transitions", 
                        `type`="number"),
                    list(
                        `name`="distribution", 
                        `title`="Distribution", 
                        `type`="text"),
                    list(
                        `name`="loglik", 
                        `title`="Log-likelihood", 
                        `type`="number"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number"),
                    list(
                        `name`="convergence", 
                        `title`="Convergence", 
                        `type`="text")),
                clearWith=list(
                    "time",
                    "event",
                    "subject",
                    "modelType")))
            self$add(jmvcore::Table$new(
                options=options,
                name="transitionRates",
                title="Transition Rate Parameters",
                visible="(showTransitionRates)",
                columns=list(
                    list(
                        `name`="transition", 
                        `title`="Transition", 
                        `type`="text"),
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="pvalue", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text")),
                clearWith=list(
                    "modelType",
                    "distributionType")))
            self$add(jmvcore::Table$new(
                options=options,
                name="sojournDistribution",
                title="Sojourn Time Distributions",
                visible="(showSojournDistribution)",
                columns=list(
                    list(
                        `name`="state", 
                        `title`="State", 
                        `type`="text"),
                    list(
                        `name`="distribution", 
                        `title`="Distribution", 
                        `type`="text"),
                    list(
                        `name`="parameter1", 
                        `title`="Parameter 1", 
                        `type`="number"),
                    list(
                        `name`="parameter2", 
                        `title`="Parameter 2", 
                        `type`="number"),
                    list(
                        `name`="mean_sojourn", 
                        `title`="Mean Time", 
                        `type`="number"),
                    list(
                        `name`="median_sojourn", 
                        `title`="Median Time", 
                        `type`="number"),
                    list(
                        `name`="variance_sojourn", 
                        `title`="Variance", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Duration", 
                        `type`="text")),
                clearWith=list(
                    "distributionType",
                    "modelType")))
            self$add(jmvcore::Table$new(
                options=options,
                name="transitionProbabilities",
                title="Transition Probabilities",
                visible="(showTransitionProbs)",
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="from_state", 
                        `title`="From State", 
                        `type`="text"),
                    list(
                        `name`="to_state", 
                        `title`="To State", 
                        `type`="text"),
                    list(
                        `name`="probability", 
                        `title`="Probability", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="cumulative", 
                        `title`="Cumulative", 
                        `type`="number")),
                clearWith=list(
                    "timePoints",
                    "modelType")))
            self$add(jmvcore::Table$new(
                options=options,
                name="stateProbabilities",
                title="State Occupation Probabilities",
                visible="(showStateProbabilities)",
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="state", 
                        `title`="State", 
                        `type`="text"),
                    list(
                        `name`="probability", 
                        `title`="Probability", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="expected_count", 
                        `title`="Expected N", 
                        `type`="number"),
                    list(
                        `name`="prevalence_rate", 
                        `title`="Prevalence", 
                        `type`="text")),
                clearWith=list(
                    "predictionHorizons",
                    "modelType")))
            self$add(jmvcore::Table$new(
                options=options,
                name="reliabilityAnalysis",
                title="Reliability Analysis",
                visible="(showReliabilityAnalysis)",
                columns=list(
                    list(
                        `name`="state", 
                        `title`="State", 
                        `type`="text"),
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="reliability", 
                        `title`="Reliability", 
                        `type`="number"),
                    list(
                        `name`="hazard_rate", 
                        `title`="Hazard Rate", 
                        `type`="number"),
                    list(
                        `name`="failure_rate", 
                        `title`="Failure Rate", 
                        `type`="number"),
                    list(
                        `name`="mtbf", 
                        `title`="MTBF", 
                        `type`="number"),
                    list(
                        `name`="survival_prob", 
                        `title`="Survival", 
                        `type`="number")),
                clearWith=list(
                    "distributionType",
                    "timePoints")))
            self$add(jmvcore::Table$new(
                options=options,
                name="covariateEffects",
                title="Covariate Effects",
                visible="(covs)",
                columns=list(
                    list(
                        `name`="transition", 
                        `title`="Transition", 
                        `type`="text"),
                    list(
                        `name`="covariate", 
                        `title`="Covariate", 
                        `type`="text"),
                    list(
                        `name`="coefficient", 
                        `title`="Coefficient", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="hazard_ratio", 
                        `title`="HR", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="pvalue", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="effect_size", 
                        `title`="Effect Size", 
                        `type`="text")),
                clearWith=list(
                    "covs",
                    "modelType")))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelDiagnostics",
                title="Model Diagnostics",
                visible="(showModelDiagnostics)",
                columns=list(
                    list(
                        `name`="diagnostic", 
                        `title`="Diagnostic Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="number"),
                    list(
                        `name`="pvalue", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="critical_value", 
                        `title`="Critical Value", 
                        `type`="number"),
                    list(
                        `name`="assessment", 
                        `title`="Assessment", 
                        `type`="text")),
                clearWith=list(
                    "modelType",
                    "estimationMethod")))
            self$add(jmvcore::Table$new(
                options=options,
                name="predictionsTable",
                title="State Predictions",
                visible="(showPredictions)",
                columns=list(
                    list(
                        `name`="subject_id", 
                        `title`="Subject", 
                        `type`="text"),
                    list(
                        `name`="current_state", 
                        `title`="Current State", 
                        `type`="text"),
                    list(
                        `name`="time_horizon", 
                        `title`="Time Horizon", 
                        `type`="number"),
                    list(
                        `name`="predicted_state", 
                        `title`="Most Likely State", 
                        `type`="text"),
                    list(
                        `name`="probability", 
                        `title`="Probability", 
                        `type`="number"),
                    list(
                        `name`="confidence_interval", 
                        `title`="95% CI", 
                        `type`="text"),
                    list(
                        `name`="risk_category", 
                        `title`="Risk Level", 
                        `type`="text")),
                clearWith=list(
                    "predictionHorizons",
                    "subject")))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodsInfo",
                title="Statistical Methods",
                clearWith=list(
                    "modelType",
                    "distributionType",
                    "estimationMethod")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretationGuide",
                title="Semi-Markov Model Interpretation",
                clearWith=list(
                    "modelType",
                    "transitionStructure")))
            self$add(jmvcore::Image$new(
                options=options,
                name="sojournDistributionPlot",
                title="Sojourn Time Distributions",
                width=800,
                height=600,
                renderFun=".sojournDistributionPlot",
                visible="(plotSojournDistributions)",
                requiresData=TRUE,
                clearWith=list(
                    "distributionType",
                    "modelType")))
            self$add(jmvcore::Image$new(
                options=options,
                name="stateProbabilityPlot",
                title="State Occupation Probabilities",
                width=800,
                height=600,
                renderFun=".stateProbabilityPlot",
                visible="(plotStateProbabilities)",
                requiresData=TRUE,
                clearWith=list(
                    "time",
                    "event",
                    "modelType")))
            self$add(jmvcore::Image$new(
                options=options,
                name="transitionIntensityPlot",
                title="Transition Intensity Functions",
                width=800,
                height=500,
                renderFun=".transitionIntensityPlot",
                visible="(plotTransitionIntensities)",
                requiresData=TRUE,
                clearWith=list(
                    "distributionType",
                    "timePoints")))
            self$add(jmvcore::Image$new(
                options=options,
                name="reliabilityPlot",
                title="Reliability and Hazard Functions",
                width=800,
                height=600,
                renderFun=".reliabilityPlot",
                visible="(plotReliabilityFunctions)",
                requiresData=TRUE,
                clearWith=list(
                    "distributionType",
                    "modelType")))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagnosticsPlot",
                title="Model Diagnostics",
                width=800,
                height=600,
                renderFun=".diagnosticsPlot",
                visible="(plotModelDiagnostics)",
                requiresData=TRUE,
                clearWith=list(
                    "modelType",
                    "estimationMethod")))}))

semimarkovBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "semimarkovBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "semimarkov",
                version = c(0,0,1),
                options = options,
                results = semimarkovResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Semi-Markov Models
#'
#' Fits Semi-Markov models where transition intensities depend on time since  
#' last transition rather than absolute time. Suitable for processes where the  
#' 'clock' resets at each transition using SemiMarkov package.
#' 
#'
#' @examples
#' \donttest{
#' # example will be added
#'}
#' @param data The data as a data frame.
#' @param time Follow-up time variable
#' @param event Event/state variable indicating transitions between states
#' @param subject Subject identifier for longitudinal tracking
#' @param covs Covariates affecting transition intensities
#' @param modelType Type of Semi-Markov model to fit
#' @param transitionStructure Structure of allowed transitions between states
#' @param distributionType Distribution for sojourn times in each state
#' @param estimationMethod Method for parameter estimation
#' @param timeScale Time scale for analysis and reporting
#' @param predictionHorizons Comma-separated list of time horizons for
#'   predictions
#' @param timePoints Time points for transition probability estimation
#' @param conf Confidence level for confidence intervals
#' @param maxIterations Maximum iterations for convergence
#' @param tolerance Convergence tolerance for optimization
#' @param bootstrapSamples Number of bootstrap samples for confidence
#'   intervals
#' @param showTransitionRates Display estimated transition rates and
#'   parameters
#' @param showSojournDistribution Display sojourn time distribution parameters
#' @param showTransitionProbs Display transition probabilities over time
#' @param showStateProbabilities Display state occupation probabilities
#' @param showReliabilityAnalysis Display reliability and survival function
#'   analysis
#' @param showModelDiagnostics Display goodness-of-fit and diagnostic tests
#' @param showPredictions Display future state predictions
#' @param showEducational Display educational information about Semi-Markov
#'   models
#' @param plotSojournDistributions Display sojourn time distribution plots
#' @param plotTransitionIntensities Display transition intensity functions
#'   over time
#' @param plotStateProbabilities Display state occupation probability plots
#' @param plotReliabilityFunctions Display reliability and hazard function
#'   plots
#' @param plotModelDiagnostics Display diagnostic and goodness-of-fit plots
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$educationalInfo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$transitionRates} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$sojournDistribution} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$transitionProbabilities} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$stateProbabilities} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$reliabilityAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$covariateEffects} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelDiagnostics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$predictionsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$methodsInfo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$interpretationGuide} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$sojournDistributionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$stateProbabilityPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$transitionIntensityPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$reliabilityPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$diagnosticsPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelSummary$asDF}
#'
#' \code{as.data.frame(results$modelSummary)}
#'
#' @export
semimarkov <- function(
    data,
    time,
    event,
    subject,
    covs,
    modelType = "parametric",
    transitionStructure = "progressive",
    distributionType = "weibull",
    estimationMethod = "ml",
    timeScale = "auto",
    predictionHorizons = "1, 3, 5, 10",
    timePoints = "0.5, 1, 2, 3, 5",
    conf = 0.95,
    maxIterations = 1000,
    tolerance = 0.000001,
    bootstrapSamples = 500,
    showTransitionRates = TRUE,
    showSojournDistribution = TRUE,
    showTransitionProbs = TRUE,
    showStateProbabilities = TRUE,
    showReliabilityAnalysis = FALSE,
    showModelDiagnostics = TRUE,
    showPredictions = TRUE,
    showEducational = TRUE,
    plotSojournDistributions = TRUE,
    plotTransitionIntensities = FALSE,
    plotStateProbabilities = TRUE,
    plotReliabilityFunctions = FALSE,
    plotModelDiagnostics = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("semimarkov requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(event)) event <- jmvcore::resolveQuo(jmvcore::enquo(event))
    if ( ! missing(subject)) subject <- jmvcore::resolveQuo(jmvcore::enquo(subject))
    if ( ! missing(covs)) covs <- jmvcore::resolveQuo(jmvcore::enquo(covs))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(event), event, NULL),
            `if`( ! missing(subject), subject, NULL),
            `if`( ! missing(covs), covs, NULL))


    options <- semimarkovOptions$new(
        time = time,
        event = event,
        subject = subject,
        covs = covs,
        modelType = modelType,
        transitionStructure = transitionStructure,
        distributionType = distributionType,
        estimationMethod = estimationMethod,
        timeScale = timeScale,
        predictionHorizons = predictionHorizons,
        timePoints = timePoints,
        conf = conf,
        maxIterations = maxIterations,
        tolerance = tolerance,
        bootstrapSamples = bootstrapSamples,
        showTransitionRates = showTransitionRates,
        showSojournDistribution = showSojournDistribution,
        showTransitionProbs = showTransitionProbs,
        showStateProbabilities = showStateProbabilities,
        showReliabilityAnalysis = showReliabilityAnalysis,
        showModelDiagnostics = showModelDiagnostics,
        showPredictions = showPredictions,
        showEducational = showEducational,
        plotSojournDistributions = plotSojournDistributions,
        plotTransitionIntensities = plotTransitionIntensities,
        plotStateProbabilities = plotStateProbabilities,
        plotReliabilityFunctions = plotReliabilityFunctions,
        plotModelDiagnostics = plotModelDiagnostics)

    analysis <- semimarkovClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

