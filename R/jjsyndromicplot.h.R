
# This file is automatically generated, you probably don't want to edit this

jjsyndromicplotOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jjsyndromicplotOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            vars = NULL,
            component = 1,
            cutoff = 0.5,
            center = TRUE,
            scale = TRUE,
            arrowsize = 10,
            textsize = 9,
            repel = TRUE,
            plotlegend = TRUE,
            plotcutoff = TRUE,
            varorder = "absdecreasing",
            colorlow = "steelblue1",
            colormid = "white",
            colorhigh = "firebrick1",
            plotwidth = 600,
            plotheight = 600, ...) {

            super$initialize(
                package="ClinicoPath",
                name="jjsyndromicplot",
                requiresData=TRUE,
                ...)

            private$..vars <- jmvcore::OptionVariables$new(
                "vars",
                vars,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..component <- jmvcore::OptionInteger$new(
                "component",
                component,
                min=1,
                max=20,
                default=1)
            private$..cutoff <- jmvcore::OptionNumber$new(
                "cutoff",
                cutoff,
                min=0,
                max=1,
                default=0.5)
            private$..center <- jmvcore::OptionBool$new(
                "center",
                center,
                default=TRUE)
            private$..scale <- jmvcore::OptionBool$new(
                "scale",
                scale,
                default=TRUE)
            private$..arrowsize <- jmvcore::OptionNumber$new(
                "arrowsize",
                arrowsize,
                min=1,
                max=30,
                default=10)
            private$..textsize <- jmvcore::OptionNumber$new(
                "textsize",
                textsize,
                min=4,
                max=20,
                default=9)
            private$..repel <- jmvcore::OptionBool$new(
                "repel",
                repel,
                default=TRUE)
            private$..plotlegend <- jmvcore::OptionBool$new(
                "plotlegend",
                plotlegend,
                default=TRUE)
            private$..plotcutoff <- jmvcore::OptionBool$new(
                "plotcutoff",
                plotcutoff,
                default=TRUE)
            private$..varorder <- jmvcore::OptionList$new(
                "varorder",
                varorder,
                options=list(
                    "absdecreasing",
                    "absincreasing",
                    "decreasing",
                    "increasing"),
                default="absdecreasing")
            private$..colorlow <- jmvcore::OptionString$new(
                "colorlow",
                colorlow,
                default="steelblue1")
            private$..colormid <- jmvcore::OptionString$new(
                "colormid",
                colormid,
                default="white")
            private$..colorhigh <- jmvcore::OptionString$new(
                "colorhigh",
                colorhigh,
                default="firebrick1")
            private$..plotwidth <- jmvcore::OptionInteger$new(
                "plotwidth",
                plotwidth,
                min=300,
                max=2000,
                default=600)
            private$..plotheight <- jmvcore::OptionInteger$new(
                "plotheight",
                plotheight,
                min=300,
                max=2000,
                default=600)

            self$.addOption(private$..vars)
            self$.addOption(private$..component)
            self$.addOption(private$..cutoff)
            self$.addOption(private$..center)
            self$.addOption(private$..scale)
            self$.addOption(private$..arrowsize)
            self$.addOption(private$..textsize)
            self$.addOption(private$..repel)
            self$.addOption(private$..plotlegend)
            self$.addOption(private$..plotcutoff)
            self$.addOption(private$..varorder)
            self$.addOption(private$..colorlow)
            self$.addOption(private$..colormid)
            self$.addOption(private$..colorhigh)
            self$.addOption(private$..plotwidth)
            self$.addOption(private$..plotheight)
        }),
    active = list(
        vars = function() private$..vars$value,
        component = function() private$..component$value,
        cutoff = function() private$..cutoff$value,
        center = function() private$..center$value,
        scale = function() private$..scale$value,
        arrowsize = function() private$..arrowsize$value,
        textsize = function() private$..textsize$value,
        repel = function() private$..repel$value,
        plotlegend = function() private$..plotlegend$value,
        plotcutoff = function() private$..plotcutoff$value,
        varorder = function() private$..varorder$value,
        colorlow = function() private$..colorlow$value,
        colormid = function() private$..colormid$value,
        colorhigh = function() private$..colorhigh$value,
        plotwidth = function() private$..plotwidth$value,
        plotheight = function() private$..plotheight$value),
    private = list(
        ..vars = NA,
        ..component = NA,
        ..cutoff = NA,
        ..center = NA,
        ..scale = NA,
        ..arrowsize = NA,
        ..textsize = NA,
        ..repel = NA,
        ..plotlegend = NA,
        ..plotcutoff = NA,
        ..varorder = NA,
        ..colorlow = NA,
        ..colormid = NA,
        ..colorhigh = NA,
        ..plotwidth = NA,
        ..plotheight = NA)
)

jjsyndromicplotResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jjsyndromicplotResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        loadings = function() private$.items[["loadings"]],
        plot = function() private$.items[["plot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Syndromic Plot (PCA Loadings)",
                refs=list(
                    "glue",
                    "ggrepel"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="loadings",
                title="Component Loadings",
                clearWith=list(
                    "vars",
                    "component",
                    "center",
                    "scale"),
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="loading", 
                        `title`="Loading", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="absloading", 
                        `title`="Absolute Loading", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot",
                title="Syndromic Plot",
                width=600,
                height=600,
                renderFun=".plot",
                requiresData=TRUE,
                clearWith=list(
                    "vars",
                    "component",
                    "cutoff",
                    "center",
                    "scale",
                    "arrowsize",
                    "textsize",
                    "repel",
                    "plotlegend",
                    "plotcutoff",
                    "varorder",
                    "colorlow",
                    "colormid",
                    "colorhigh",
                    "plotwidth",
                    "plotheight")))}))

jjsyndromicplotBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jjsyndromicplotBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "jjsyndromicplot",
                version = c(0,0,32),
                options = options,
                results = jjsyndromicplotResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Syndromic Plot (PCA Loadings)
#'
#' Syndromic plots visualize Principal Component Analysis (PCA) loadings using
#' a unique triangular design with directional arrows. This visualization 
#' method
#' was developed by Ferguson et al. (2013) for interpreting complex disease 
#' patterns.
#' 
#' Arrow width and color represent the magnitude and direction of variable 
#' loadings
#' on the selected principal component. Only variables with loadings above the
#' specified cutoff threshold are displayed.
#' 
#' The triangle center displays the component label and variance accounted for 
#' (VAF).
#' 
#'
#' @examples
#' # Example with mtcars dataset
#' data("mtcars")
#'
#' # Basic syndromic plot for first principal component
#' jjsyndromicplot(
#'   data = mtcars,
#'   vars = c("mpg", "disp", "hp", "drat", "wt", "qsec"),
#'   component = 1,
#'   cutoff = 0.5,
#'   center = TRUE,
#'   scale = TRUE
#' )
#'
#' # Customize appearance
#' jjsyndromicplot(
#'   data = mtcars,
#'   vars = c("mpg", "disp", "hp", "drat", "wt", "qsec"),
#'   component = 2,
#'   cutoff = 0.4,
#'   arrowsize = 15,
#'   textsize = 8,
#'   colorlow = "blue",
#'   colormid = "white",
#'   colorhigh = "red",
#'   varorder = "abs decreasing"
#' )
#'
#' @section References:
#' Ferguson AR, Irvine K-A, Gensel JC, et al. (2013). Derivation of Multivariate Syndromic Outcome Metrics for Consistent Testing across Multiple Models of Cervical Spinal Cord Injury in Rats. PLOS ONE, 8(3):e59712.
#'
#' Torres-Espin A, Chou A, Huie JR, et al. (2021). Reproducible analysis of disease space via principal components using the novel R package syndRomics. eLife, 10:e61812.
#'
#' @param data The data as a data frame.
#' @param vars Continuous variables to include in Principal Component
#'   Analysis. Select at least 3 numeric variables (e.g., biomarker levels,
#'   clinical measurements, gene expression values). PCA will identify patterns
#'   of correlation among these variables.
#' @param component Which principal component to visualize (1 = PC1, 2 = PC2,
#'   etc.). PC1 typically explains the most variance in the data.
#' @param cutoff Minimum absolute loading value to display a variable (0 to
#'   1). Variables with |loading| >= cutoff will be shown as arrows. Higher
#'   values show fewer, more important variables. Typical range: 0.3-0.6.
#' @param center Center variables to have mean = 0 before PCA. Recommended:
#'   TRUE for most analyses.
#' @param scale Scale variables to have standard deviation = 1 before PCA.
#'   Recommended: TRUE when variables have different units or scales.
#' @param arrowsize Controls the width of arrows proportional to loading
#'   magnitude. Higher values = thicker arrows. Range: 1-30.
#' @param textsize Font size for variable labels and loading values. Range:
#'   4-20.
#' @param repel Use ggrepel to prevent overlapping variable labels. Set to
#'   FALSE for fixed label positions.
#' @param plotlegend Display the color gradient legend at bottom of plot.
#' @param plotcutoff Highlight the cutoff threshold region in the legend.
#' @param varorder Order of variables around the circle (starting at 12
#'   o'clock, counterclockwise). 'abs decreasing' places strongest loadings
#'   first.
#' @param colorlow Color for negative loadings. Use color names or hex codes
#'   (e.g., "#0000FF").
#' @param colormid Midpoint color for zero loading. Usually white or light
#'   gray.
#' @param colorhigh Color for positive loadings. Use color names or hex codes
#'   (e.g., "#FF0000").
#' @param plotwidth Width of the plot in pixels.
#' @param plotheight Height of the plot in pixels.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$loadings} \tab \tab \tab \tab \tab Standardized loadings for the selected principal component \cr
#'   \code{results$plot} \tab \tab \tab \tab \tab Syndromic visualization of PCA loadings \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$loadings$asDF}
#'
#' \code{as.data.frame(results$loadings)}
#'
#' @export
jjsyndromicplot <- function(
    data,
    vars,
    component = 1,
    cutoff = 0.5,
    center = TRUE,
    scale = TRUE,
    arrowsize = 10,
    textsize = 9,
    repel = TRUE,
    plotlegend = TRUE,
    plotcutoff = TRUE,
    varorder = "absdecreasing",
    colorlow = "steelblue1",
    colormid = "white",
    colorhigh = "firebrick1",
    plotwidth = 600,
    plotheight = 600) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("jjsyndromicplot requires jmvcore to be installed (restart may be required)")

    if ( ! missing(vars)) vars <- jmvcore::resolveQuo(jmvcore::enquo(vars))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(vars), vars, NULL))


    options <- jjsyndromicplotOptions$new(
        vars = vars,
        component = component,
        cutoff = cutoff,
        center = center,
        scale = scale,
        arrowsize = arrowsize,
        textsize = textsize,
        repel = repel,
        plotlegend = plotlegend,
        plotcutoff = plotcutoff,
        varorder = varorder,
        colorlow = colorlow,
        colormid = colormid,
        colorhigh = colorhigh,
        plotwidth = plotwidth,
        plotheight = plotheight)

    analysis <- jjsyndromicplotClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

