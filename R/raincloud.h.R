
# This file is automatically generated, you probably don't want to edit this

raincloudOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "raincloudOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            dep_var = NULL,
            group_var = NULL,
            facet_var = NULL,
            color_var = NULL,
            show_violin = FALSE,
            show_boxplot = FALSE,
            show_dots = FALSE,
            dots_side = "left",
            violin_width = 0.7,
            box_width = 0.2,
            dots_size = 1.2,
            alpha_violin = 0.7,
            alpha_dots = 0.8,
            orientation = "horizontal",
            color_palette = "clinical",
            plot_theme = "clinical",
            plot_title = "Raincloud Plot - Distribution Visualization",
            x_label = "",
            y_label = "",
            show_statistics = FALSE,
            show_outliers = FALSE,
            outlier_method = "iqr",
            normality_test = FALSE,
            comparison_test = FALSE,
            comparison_method = "auto", ...) {

            super$initialize(
                package="ClinicoPath",
                name="raincloud",
                requiresData=TRUE,
                ...)

            private$..dep_var <- jmvcore::OptionVariable$new(
                "dep_var",
                dep_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..group_var <- jmvcore::OptionVariable$new(
                "group_var",
                group_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..facet_var <- jmvcore::OptionVariable$new(
                "facet_var",
                facet_var,
                default=NULL,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..color_var <- jmvcore::OptionVariable$new(
                "color_var",
                color_var,
                default=NULL,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..show_violin <- jmvcore::OptionBool$new(
                "show_violin",
                show_violin,
                default=FALSE)
            private$..show_boxplot <- jmvcore::OptionBool$new(
                "show_boxplot",
                show_boxplot,
                default=FALSE)
            private$..show_dots <- jmvcore::OptionBool$new(
                "show_dots",
                show_dots,
                default=FALSE)
            private$..dots_side <- jmvcore::OptionList$new(
                "dots_side",
                dots_side,
                options=list(
                    "left",
                    "right",
                    "both"),
                default="left")
            private$..violin_width <- jmvcore::OptionNumber$new(
                "violin_width",
                violin_width,
                min=0.1,
                max=2,
                default=0.7)
            private$..box_width <- jmvcore::OptionNumber$new(
                "box_width",
                box_width,
                min=0.05,
                max=1,
                default=0.2)
            private$..dots_size <- jmvcore::OptionNumber$new(
                "dots_size",
                dots_size,
                min=0.1,
                max=5,
                default=1.2)
            private$..alpha_violin <- jmvcore::OptionNumber$new(
                "alpha_violin",
                alpha_violin,
                min=0,
                max=1,
                default=0.7)
            private$..alpha_dots <- jmvcore::OptionNumber$new(
                "alpha_dots",
                alpha_dots,
                min=0,
                max=1,
                default=0.8)
            private$..orientation <- jmvcore::OptionList$new(
                "orientation",
                orientation,
                options=list(
                    "vertical",
                    "horizontal"),
                default="horizontal")
            private$..color_palette <- jmvcore::OptionList$new(
                "color_palette",
                color_palette,
                options=list(
                    "default",
                    "viridis",
                    "set1",
                    "set2",
                    "dark2",
                    "clinical",
                    "pastel",
                    "separator_prism",
                    "prism_floral",
                    "prism_candy_bright",
                    "prism_office",
                    "prism_pastels",
                    "prism_colorblind_safe",
                    "prism_ocean",
                    "prism_spring"),
                default="clinical")
            private$..plot_theme <- jmvcore::OptionList$new(
                "plot_theme",
                plot_theme,
                options=list(
                    "clinical",
                    "minimal",
                    "classic",
                    "publication",
                    "tidyquant",
                    "separator_theme",
                    "prism_default",
                    "prism_white",
                    "prism_publication"),
                default="clinical")
            private$..plot_title <- jmvcore::OptionString$new(
                "plot_title",
                plot_title,
                default="Raincloud Plot - Distribution Visualization")
            private$..x_label <- jmvcore::OptionString$new(
                "x_label",
                x_label,
                default="")
            private$..y_label <- jmvcore::OptionString$new(
                "y_label",
                y_label,
                default="")
            private$..show_statistics <- jmvcore::OptionBool$new(
                "show_statistics",
                show_statistics,
                default=FALSE)
            private$..show_outliers <- jmvcore::OptionBool$new(
                "show_outliers",
                show_outliers,
                default=FALSE)
            private$..outlier_method <- jmvcore::OptionList$new(
                "outlier_method",
                outlier_method,
                options=list(
                    "iqr",
                    "zscore",
                    "modified_zscore"),
                default="iqr")
            private$..normality_test <- jmvcore::OptionBool$new(
                "normality_test",
                normality_test,
                default=FALSE)
            private$..comparison_test <- jmvcore::OptionBool$new(
                "comparison_test",
                comparison_test,
                default=FALSE)
            private$..comparison_method <- jmvcore::OptionList$new(
                "comparison_method",
                comparison_method,
                options=list(
                    "auto",
                    "ttest",
                    "wilcoxon",
                    "anova",
                    "kruskal"),
                default="auto")

            self$.addOption(private$..dep_var)
            self$.addOption(private$..group_var)
            self$.addOption(private$..facet_var)
            self$.addOption(private$..color_var)
            self$.addOption(private$..show_violin)
            self$.addOption(private$..show_boxplot)
            self$.addOption(private$..show_dots)
            self$.addOption(private$..dots_side)
            self$.addOption(private$..violin_width)
            self$.addOption(private$..box_width)
            self$.addOption(private$..dots_size)
            self$.addOption(private$..alpha_violin)
            self$.addOption(private$..alpha_dots)
            self$.addOption(private$..orientation)
            self$.addOption(private$..color_palette)
            self$.addOption(private$..plot_theme)
            self$.addOption(private$..plot_title)
            self$.addOption(private$..x_label)
            self$.addOption(private$..y_label)
            self$.addOption(private$..show_statistics)
            self$.addOption(private$..show_outliers)
            self$.addOption(private$..outlier_method)
            self$.addOption(private$..normality_test)
            self$.addOption(private$..comparison_test)
            self$.addOption(private$..comparison_method)
        }),
    active = list(
        dep_var = function() private$..dep_var$value,
        group_var = function() private$..group_var$value,
        facet_var = function() private$..facet_var$value,
        color_var = function() private$..color_var$value,
        show_violin = function() private$..show_violin$value,
        show_boxplot = function() private$..show_boxplot$value,
        show_dots = function() private$..show_dots$value,
        dots_side = function() private$..dots_side$value,
        violin_width = function() private$..violin_width$value,
        box_width = function() private$..box_width$value,
        dots_size = function() private$..dots_size$value,
        alpha_violin = function() private$..alpha_violin$value,
        alpha_dots = function() private$..alpha_dots$value,
        orientation = function() private$..orientation$value,
        color_palette = function() private$..color_palette$value,
        plot_theme = function() private$..plot_theme$value,
        plot_title = function() private$..plot_title$value,
        x_label = function() private$..x_label$value,
        y_label = function() private$..y_label$value,
        show_statistics = function() private$..show_statistics$value,
        show_outliers = function() private$..show_outliers$value,
        outlier_method = function() private$..outlier_method$value,
        normality_test = function() private$..normality_test$value,
        comparison_test = function() private$..comparison_test$value,
        comparison_method = function() private$..comparison_method$value),
    private = list(
        ..dep_var = NA,
        ..group_var = NA,
        ..facet_var = NA,
        ..color_var = NA,
        ..show_violin = NA,
        ..show_boxplot = NA,
        ..show_dots = NA,
        ..dots_side = NA,
        ..violin_width = NA,
        ..box_width = NA,
        ..dots_size = NA,
        ..alpha_violin = NA,
        ..alpha_dots = NA,
        ..orientation = NA,
        ..color_palette = NA,
        ..plot_theme = NA,
        ..plot_title = NA,
        ..x_label = NA,
        ..y_label = NA,
        ..show_statistics = NA,
        ..show_outliers = NA,
        ..outlier_method = NA,
        ..normality_test = NA,
        ..comparison_test = NA,
        ..comparison_method = NA)
)

raincloudResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "raincloudResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        plot = function() private$.items[["plot"]],
        statistics = function() private$.items[["statistics"]],
        outliers = function() private$.items[["outliers"]],
        normality = function() private$.items[["normality"]],
        comparison = function() private$.items[["comparison"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Raincloud Plot")
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Instructions"))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot",
                title="Raincloud Plot",
                width=800,
                height=600,
                renderFun=".plot"))
            self$add(jmvcore::Html$new(
                options=options,
                name="statistics",
                title="Summary Statistics",
                visible="(show_statistics)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="outliers",
                title="Outlier Analysis",
                visible="(show_outliers)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="normality",
                title="Normality Tests",
                visible="(normality_test)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="comparison",
                title="Group Comparisons",
                visible="(comparison_test)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Interpretation Guide"))}))

raincloudBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "raincloudBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "raincloud",
                version = c(0,0,31),
                options = options,
                results = raincloudResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Raincloud Plot
#'
#' Creates Raincloud plots to visualize data distributions using ggdist 
#' package.
#' Raincloud plots combine three visualization techniques: half-violin plots 
#' showing 
#' distribution density, box plots showing summary statistics, and dot plots 
#' showing 
#' individual data points. This provides a comprehensive view of data 
#' distribution 
#' that reveals patterns traditional box plots might miss, including 
#' multimodality
#' and distribution shape. Based on the ggdist R-Bloggers tutorial.
#' 
#'
#' @examples
#' # Load example dataset
#' data(histopathology)
#'
#' # Basic raincloud plot
#' raincloud(
#'   data = histopathology,
#'   dep_var = "Age",
#'   group_var = "Group"
#' )
#'
#' # Advanced raincloud plot with faceting and custom colors
#' raincloud(
#'   data = histopathology,
#'   dep_var = "OverallTime",
#'   group_var = "Group",
#'   facet_var = "Sex",
#'   color_var = "Race",
#'   color_palette = "clinical",
#'   plot_theme = "publication"
#' )
#'
#' # Statistical analysis with outlier detection
#' raincloud(
#'   data = histopathology,
#'   dep_var = "Age",
#'   group_var = "Group",
#'   show_statistics = TRUE,
#'   show_outliers = TRUE,
#'   outlier_method = "iqr",
#'   normality_test = TRUE,
#'   comparison_test = TRUE
#' )
#'
#' # Customized visualization components
#' raincloud(
#'   data = histopathology,
#'   dep_var = "Age",
#'   group_var = "Group",
#'   show_violin = TRUE,
#'   show_boxplot = TRUE,
#'   show_dots = TRUE,
#'   dots_side = "left",
#'   orientation = "horizontal",
#'   violin_width = 0.8,
#'   alpha_violin = 0.6
#' )
#'
#' @param data The data as a data frame.
#' @param dep_var Continuous variable whose distribution will be visualized in
#'   the raincloud plot.
#' @param group_var Categorical variable for grouping. Each group will have
#'   its own raincloud visualization.
#' @param facet_var Optional variable for creating separate panels. Creates
#'   multiple raincloud plots  in a grid layout.
#' @param color_var Optional variable for coloring different elements. If not
#'   specified, uses grouping variable.
#' @param show_violin If TRUE, displays half-violin plot showing probability
#'   density distribution.
#' @param show_boxplot If TRUE, displays box plot with median, quartiles, and
#'   outliers.
#' @param show_dots If TRUE, displays individual data points as dots.
#' @param dots_side Position of data point dots relative to the violin plot.
#' @param violin_width Width scaling factor for the violin plot component.
#' @param box_width Width of the box plot component.
#' @param dots_size Size of individual data point dots.
#' @param alpha_violin Transparency level for violin plot (0 = transparent, 1
#'   = opaque).
#' @param alpha_dots Transparency level for data point dots.
#' @param orientation Orientation of the plot. Horizontal creates the classic
#'   "raincloud" appearance.
#' @param color_palette Color palette for different groups including GraphPad
#'   Prism palettes.
#' @param plot_theme Overall visual theme for the plot.
#' @param plot_title Custom title for the raincloud plot.
#' @param x_label Custom label for X-axis. If empty, uses variable name.
#' @param y_label Custom label for Y-axis. If empty, uses variable name.
#' @param show_statistics If TRUE, displays summary statistics table for each
#'   group.
#' @param show_outliers If TRUE, identifies and highlights outliers in the
#'   visualization.
#' @param outlier_method Method for detecting outliers when highlight outliers
#'   is enabled.
#' @param normality_test If TRUE, performs normality tests (Shapiro-Wilk) for
#'   each group.
#' @param comparison_test If TRUE, performs statistical tests to compare
#'   groups.
#' @param comparison_method Statistical test method for comparing groups.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$statistics} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$outliers} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$normality} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$comparison} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' @export
raincloud <- function(
    data,
    dep_var,
    group_var,
    facet_var = NULL,
    color_var = NULL,
    show_violin = FALSE,
    show_boxplot = FALSE,
    show_dots = FALSE,
    dots_side = "left",
    violin_width = 0.7,
    box_width = 0.2,
    dots_size = 1.2,
    alpha_violin = 0.7,
    alpha_dots = 0.8,
    orientation = "horizontal",
    color_palette = "clinical",
    plot_theme = "clinical",
    plot_title = "Raincloud Plot - Distribution Visualization",
    x_label = "",
    y_label = "",
    show_statistics = FALSE,
    show_outliers = FALSE,
    outlier_method = "iqr",
    normality_test = FALSE,
    comparison_test = FALSE,
    comparison_method = "auto") {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("raincloud requires jmvcore to be installed (restart may be required)")

    if ( ! missing(dep_var)) dep_var <- jmvcore::resolveQuo(jmvcore::enquo(dep_var))
    if ( ! missing(group_var)) group_var <- jmvcore::resolveQuo(jmvcore::enquo(group_var))
    if ( ! missing(facet_var)) facet_var <- jmvcore::resolveQuo(jmvcore::enquo(facet_var))
    if ( ! missing(color_var)) color_var <- jmvcore::resolveQuo(jmvcore::enquo(color_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(dep_var), dep_var, NULL),
            `if`( ! missing(group_var), group_var, NULL),
            `if`( ! missing(facet_var), facet_var, NULL),
            `if`( ! missing(color_var), color_var, NULL))


    options <- raincloudOptions$new(
        dep_var = dep_var,
        group_var = group_var,
        facet_var = facet_var,
        color_var = color_var,
        show_violin = show_violin,
        show_boxplot = show_boxplot,
        show_dots = show_dots,
        dots_side = dots_side,
        violin_width = violin_width,
        box_width = box_width,
        dots_size = dots_size,
        alpha_violin = alpha_violin,
        alpha_dots = alpha_dots,
        orientation = orientation,
        color_palette = color_palette,
        plot_theme = plot_theme,
        plot_title = plot_title,
        x_label = x_label,
        y_label = y_label,
        show_statistics = show_statistics,
        show_outliers = show_outliers,
        outlier_method = outlier_method,
        normality_test = normality_test,
        comparison_test = comparison_test,
        comparison_method = comparison_method)

    analysis <- raincloudClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

