
# This file is automatically generated, you probably don't want to edit this

condsurvivalOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "condsurvivalOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            status = NULL,
            group = NULL,
            id = NULL,
            conditional_times = "1, 2, 5",
            prediction_times = "1, 3, 5",
            survival_method = "kaplan_meier",
            parametric_dist = "weibull",
            confidence_level = 0.95,
            time_scale = "years",
            include_plots = TRUE,
            include_tables = TRUE,
            dynamic_prediction = FALSE,
            landmark_analysis = FALSE,
            clinical_interpretation = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="condsurvival",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..status <- jmvcore::OptionVariable$new(
                "status",
                status,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..group <- jmvcore::OptionVariable$new(
                "group",
                group,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..id <- jmvcore::OptionVariable$new(
                "id",
                id,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..conditional_times <- jmvcore::OptionString$new(
                "conditional_times",
                conditional_times,
                default="1, 2, 5")
            private$..prediction_times <- jmvcore::OptionString$new(
                "prediction_times",
                prediction_times,
                default="1, 3, 5")
            private$..survival_method <- jmvcore::OptionList$new(
                "survival_method",
                survival_method,
                options=list(
                    "kaplan_meier",
                    "fleming_harrington",
                    "parametric"),
                default="kaplan_meier")
            private$..parametric_dist <- jmvcore::OptionList$new(
                "parametric_dist",
                parametric_dist,
                options=list(
                    "weibull",
                    "exponential",
                    "lognormal",
                    "loglogistic"),
                default="weibull")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..time_scale <- jmvcore::OptionList$new(
                "time_scale",
                time_scale,
                options=list(
                    "days",
                    "months",
                    "years"),
                default="years")
            private$..include_plots <- jmvcore::OptionBool$new(
                "include_plots",
                include_plots,
                default=TRUE)
            private$..include_tables <- jmvcore::OptionBool$new(
                "include_tables",
                include_tables,
                default=TRUE)
            private$..dynamic_prediction <- jmvcore::OptionBool$new(
                "dynamic_prediction",
                dynamic_prediction,
                default=FALSE)
            private$..landmark_analysis <- jmvcore::OptionBool$new(
                "landmark_analysis",
                landmark_analysis,
                default=FALSE)
            private$..clinical_interpretation <- jmvcore::OptionBool$new(
                "clinical_interpretation",
                clinical_interpretation,
                default=TRUE)

            self$.addOption(private$..time)
            self$.addOption(private$..status)
            self$.addOption(private$..group)
            self$.addOption(private$..id)
            self$.addOption(private$..conditional_times)
            self$.addOption(private$..prediction_times)
            self$.addOption(private$..survival_method)
            self$.addOption(private$..parametric_dist)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..time_scale)
            self$.addOption(private$..include_plots)
            self$.addOption(private$..include_tables)
            self$.addOption(private$..dynamic_prediction)
            self$.addOption(private$..landmark_analysis)
            self$.addOption(private$..clinical_interpretation)
        }),
    active = list(
        time = function() private$..time$value,
        status = function() private$..status$value,
        group = function() private$..group$value,
        id = function() private$..id$value,
        conditional_times = function() private$..conditional_times$value,
        prediction_times = function() private$..prediction_times$value,
        survival_method = function() private$..survival_method$value,
        parametric_dist = function() private$..parametric_dist$value,
        confidence_level = function() private$..confidence_level$value,
        time_scale = function() private$..time_scale$value,
        include_plots = function() private$..include_plots$value,
        include_tables = function() private$..include_tables$value,
        dynamic_prediction = function() private$..dynamic_prediction$value,
        landmark_analysis = function() private$..landmark_analysis$value,
        clinical_interpretation = function() private$..clinical_interpretation$value),
    private = list(
        ..time = NA,
        ..status = NA,
        ..group = NA,
        ..id = NA,
        ..conditional_times = NA,
        ..prediction_times = NA,
        ..survival_method = NA,
        ..parametric_dist = NA,
        ..confidence_level = NA,
        ..time_scale = NA,
        ..include_plots = NA,
        ..include_tables = NA,
        ..dynamic_prediction = NA,
        ..landmark_analysis = NA,
        ..clinical_interpretation = NA)
)

condsurvivalResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "condsurvivalResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        dataOverview = function() private$.items[["dataOverview"]],
        conditionalSurvivalTable = function() private$.items[["conditionalSurvivalTable"]],
        conditionalImprovementTable = function() private$.items[["conditionalImprovementTable"]],
        dynamicPredictionTable = function() private$.items[["dynamicPredictionTable"]],
        landmarkAnalysisTable = function() private$.items[["landmarkAnalysisTable"]],
        modelFitStatistics = function() private$.items[["modelFitStatistics"]],
        groupComparisonTable = function() private$.items[["groupComparisonTable"]],
        conditionalSurvivalPlot = function() private$.items[["conditionalSurvivalPlot"]],
        conditionalImprovementPlot = function() private$.items[["conditionalImprovementPlot"]],
        dynamicPredictionPlot = function() private$.items[["dynamicPredictionPlot"]],
        landmarkPlot = function() private$.items[["landmarkPlot"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Conditional Survival Analysis",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Analysis Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="dataOverview",
                title="Data Overview",
                visible=TRUE,
                rows=1,
                clearWith=list(
                    "time",
                    "status",
                    "group"),
                columns=list(
                    list(
                        `name`="characteristic", 
                        `title`="Characteristic", 
                        `type`="text"),
                    list(
                        `name`="overall", 
                        `title`="Overall", 
                        `type`="text"),
                    list(
                        `name`="group1", 
                        `title`="Group 1", 
                        `type`="text", 
                        `visible`="(group)"),
                    list(
                        `name`="group2", 
                        `title`="Group 2", 
                        `type`="text", 
                        `visible`="(group)"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="conditionalSurvivalTable",
                title="Conditional Survival Probabilities",
                visible="(include_tables)",
                rows=1,
                clearWith=list(
                    "time",
                    "status",
                    "conditional_times",
                    "prediction_times"),
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text", 
                        `visible`="(group)"),
                    list(
                        `name`="conditional_time", 
                        `title`="Given Survival to", 
                        `type`="text"),
                    list(
                        `name`="additional_time", 
                        `title`="Additional Time", 
                        `type`="text"),
                    list(
                        `name`="conditional_prob", 
                        `title`="Conditional Probability", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="confidence_interval", 
                        `title`="Confidence Interval", 
                        `type`="text"),
                    list(
                        `name`="patients_at_risk", 
                        `title`="Patients at Risk", 
                        `type`="integer"),
                    list(
                        `name`="clinical_interpretation", 
                        `title`="Clinical Meaning", 
                        `type`="text", 
                        `visible`="(clinical_interpretation)"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="conditionalImprovementTable",
                title="Conditional Survival Improvement",
                visible="(include_tables)",
                rows=1,
                clearWith=list(
                    "time",
                    "status",
                    "conditional_times"),
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text", 
                        `visible`="(group)"),
                    list(
                        `name`="conditional_time", 
                        `title`="Time Point", 
                        `type`="text"),
                    list(
                        `name`="unconditional_prob", 
                        `title`="Unconditional", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="conditional_prob", 
                        `title`="Conditional", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="improvement", 
                        `title`="Improvement", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="improvement_percent", 
                        `title`="Improvement (%)", 
                        `type`="number", 
                        `format`="zto:1"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="dynamicPredictionTable",
                title="Dynamic Prediction Results",
                visible="(dynamic_prediction)",
                rows=1,
                clearWith=list(
                    "time",
                    "status",
                    "dynamic_prediction"),
                columns=list(
                    list(
                        `name`="patient_time", 
                        `title`="Patient Survival Time", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="prediction_time", 
                        `title`="Prediction Horizon", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="dynamic_probability", 
                        `title`="Dynamic Probability", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="confidence_interval", 
                        `title`="Confidence Interval", 
                        `type`="text"),
                    list(
                        `name`="risk_category", 
                        `title`="Risk Category", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="landmarkAnalysisTable",
                title="Landmark Analysis Results",
                visible="(landmark_analysis)",
                rows=1,
                clearWith=list(
                    "time",
                    "status",
                    "landmark_analysis"),
                columns=list(
                    list(
                        `name`="landmark_time", 
                        `title`="Landmark Time", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="patients_at_landmark", 
                        `title`="Patients at Landmark", 
                        `type`="integer"),
                    list(
                        `name`="events_after_landmark", 
                        `title`="Events After Landmark", 
                        `type`="integer"),
                    list(
                        `name`="landmark_survival", 
                        `title`="Survival from Landmark", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="confidence_interval", 
                        `title`="Confidence Interval", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelFitStatistics",
                title="Model Fit Statistics",
                visible="(survival_method:parametric)",
                rows=1,
                clearWith=list(
                    "survival_method",
                    "parametric_dist"),
                columns=list(
                    list(
                        `name`="distribution", 
                        `title`="Distribution", 
                        `type`="text"),
                    list(
                        `name`="log_likelihood", 
                        `title`="Log-Likelihood", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="parameters", 
                        `title`="Parameters", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="groupComparisonTable",
                title="Group Comparison Tests",
                visible="(group)",
                rows=1,
                clearWith=list(
                    "time",
                    "status",
                    "group"),
                columns=list(
                    list(
                        `name`="conditional_time", 
                        `title`="Conditional Time", 
                        `type`="text"),
                    list(
                        `name`="test_statistic", 
                        `title`="Test Statistic", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="significance", 
                        `title`="Significance", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="conditionalSurvivalPlot",
                title="Conditional Survival Curves",
                visible="(include_plots)",
                requiresData=TRUE,
                width=900,
                height=600,
                renderFun=".plotConditionalSurvival",
                clearWith=list(
                    "time",
                    "status",
                    "group",
                    "conditional_times")))
            self$add(jmvcore::Image$new(
                options=options,
                name="conditionalImprovementPlot",
                title="Conditional Survival Improvement Plot",
                visible="(include_plots)",
                requiresData=TRUE,
                width=800,
                height=600,
                renderFun=".plotConditionalImprovement",
                clearWith=list(
                    "time",
                    "status",
                    "conditional_times")))
            self$add(jmvcore::Image$new(
                options=options,
                name="dynamicPredictionPlot",
                title="Dynamic Prediction Plot",
                visible="(include_plots && dynamic_prediction)",
                requiresData=TRUE,
                width=800,
                height=600,
                renderFun=".plotDynamicPrediction",
                clearWith=list(
                    "time",
                    "status",
                    "dynamic_prediction")))
            self$add(jmvcore::Image$new(
                options=options,
                name="landmarkPlot",
                title="Landmark Analysis Plot",
                visible="(include_plots && landmark_analysis)",
                requiresData=TRUE,
                width=800,
                height=600,
                renderFun=".plotLandmarkAnalysis",
                clearWith=list(
                    "time",
                    "status",
                    "landmark_analysis")))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Method and Clinical Interpretation",
                visible=TRUE))}))

condsurvivalBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "condsurvivalBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "condsurvival",
                version = c(1,0,0),
                options = options,
                results = condsurvivalResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Conditional Survival Analysis
#'
#' Conditional survival analysis for calculating the probability of surviving 
#' an additional  time period given that a patient has already survived a 
#' certain time. Essential for  long-term prognosis and dynamic patient 
#' counseling in clinical practice.
#' 
#'
#' @examples
#' data \%>\%
#' condsurvival(
#'     time = "time_variable",
#'     status = "status_variable",
#'     group = "group_variable",
#'     conditional_times = c(1, 2, 5),
#'     prediction_times = c(1, 3, 5)
#' )
#'
#' @param data the data as a data frame
#' @param time Time-to-event or follow-up time variable (numeric)
#' @param status Event indicator variable (1/TRUE = event occurred, 0/FALSE =
#'   censored)
#' @param group Optional grouping variable for stratified conditional survival
#'   analysis
#' @param id Optional subject identifier for longitudinal analysis
#' @param conditional_times Comma-separated list of time points for
#'   conditional survival (e.g., "1, 2, 5")
#' @param prediction_times Comma-separated list of additional survival times
#'   to predict (e.g., "1, 3, 5")
#' @param survival_method Method for estimating baseline survival curves
#' @param parametric_dist Parametric distribution for survival modeling (when
#'   parametric method selected)
#' @param confidence_level Confidence level for confidence intervals
#' @param time_scale Time scale for interpretation and reporting
#' @param include_plots Generate conditional survival plots and visualizations
#' @param include_tables Include detailed conditional survival probability
#'   tables
#' @param dynamic_prediction Enable dynamic prediction capabilities for
#'   individual patients
#' @param landmark_analysis Perform landmark analysis to address immortal time
#'   bias
#' @param clinical_interpretation Include clinical interpretation guidance for
#'   conditional survival results
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$dataOverview} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$conditionalSurvivalTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$conditionalImprovementTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$dynamicPredictionTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$landmarkAnalysisTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelFitStatistics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$groupComparisonTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$conditionalSurvivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$conditionalImprovementPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$dynamicPredictionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$landmarkPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$dataOverview$asDF}
#'
#' \code{as.data.frame(results$dataOverview)}
#'
#' @export
condsurvival <- function(
    data,
    time,
    status,
    group,
    id,
    conditional_times = "1, 2, 5",
    prediction_times = "1, 3, 5",
    survival_method = "kaplan_meier",
    parametric_dist = "weibull",
    confidence_level = 0.95,
    time_scale = "years",
    include_plots = TRUE,
    include_tables = TRUE,
    dynamic_prediction = FALSE,
    landmark_analysis = FALSE,
    clinical_interpretation = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("condsurvival requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(status)) status <- jmvcore::resolveQuo(jmvcore::enquo(status))
    if ( ! missing(group)) group <- jmvcore::resolveQuo(jmvcore::enquo(group))
    if ( ! missing(id)) id <- jmvcore::resolveQuo(jmvcore::enquo(id))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(status), status, NULL),
            `if`( ! missing(group), group, NULL),
            `if`( ! missing(id), id, NULL))

    for (v in group) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in id) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- condsurvivalOptions$new(
        time = time,
        status = status,
        group = group,
        id = id,
        conditional_times = conditional_times,
        prediction_times = prediction_times,
        survival_method = survival_method,
        parametric_dist = parametric_dist,
        confidence_level = confidence_level,
        time_scale = time_scale,
        include_plots = include_plots,
        include_tables = include_tables,
        dynamic_prediction = dynamic_prediction,
        landmark_analysis = landmark_analysis,
        clinical_interpretation = clinical_interpretation)

    analysis <- condsurvivalClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

