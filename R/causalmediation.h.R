
# This file is automatically generated, you probably don't want to edit this

causalmediationOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "causalmediationOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            outcome = NULL,
            treatment = NULL,
            mediator = NULL,
            mediators = NULL,
            covariates = NULL,
            mediation_tier = "basic",
            boot_samples = 1000,
            conf_level = 0.95,
            mediator_model = "lm",
            outcome_model = "lm",
            multiple_mediators = NULL,
            show_dag = TRUE,
            cma_estimation = "rb",
            hd_method = "hdmax2",
            hd_fdr_threshold = 0.1,
            hd_top_mediators = 20,
            hd_penalty = "lasso",
            hd_parallel = TRUE,
            show_decomposition = TRUE,
            show_prop_mediated = TRUE,
            sensitivity_analysis = FALSE,
            rho_values = "0, 0.1, 0.2, 0.3",
            plot_effects = TRUE,
            plot_hd_manhattan = TRUE,
            plot_hd_volcano = TRUE,
            interaction_term = FALSE,
            random_seed = 42, ...) {

            super$initialize(
                package="ClinicoPath",
                name="causalmediation",
                requiresData=TRUE,
                ...)

            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..treatment <- jmvcore::OptionVariable$new(
                "treatment",
                treatment,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..mediator <- jmvcore::OptionVariable$new(
                "mediator",
                mediator,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..mediators <- jmvcore::OptionVariables$new(
                "mediators",
                mediators,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..mediation_tier <- jmvcore::OptionList$new(
                "mediation_tier",
                mediation_tier,
                options=list(
                    "basic",
                    "comprehensive",
                    "hd"),
                default="basic")
            private$..boot_samples <- jmvcore::OptionInteger$new(
                "boot_samples",
                boot_samples,
                default=1000,
                min=100,
                max=10000)
            private$..conf_level <- jmvcore::OptionNumber$new(
                "conf_level",
                conf_level,
                default=0.95,
                min=0.8,
                max=0.99)
            private$..mediator_model <- jmvcore::OptionList$new(
                "mediator_model",
                mediator_model,
                options=list(
                    "lm",
                    "glm_logit",
                    "glm_poisson"),
                default="lm")
            private$..outcome_model <- jmvcore::OptionList$new(
                "outcome_model",
                outcome_model,
                options=list(
                    "lm",
                    "glm_logit",
                    "survival"),
                default="lm")
            private$..multiple_mediators <- jmvcore::OptionVariables$new(
                "multiple_mediators",
                multiple_mediators,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..show_dag <- jmvcore::OptionBool$new(
                "show_dag",
                show_dag,
                default=TRUE)
            private$..cma_estimation <- jmvcore::OptionList$new(
                "cma_estimation",
                cma_estimation,
                options=list(
                    "rb",
                    "iorw",
                    "msm"),
                default="rb")
            private$..hd_method <- jmvcore::OptionList$new(
                "hd_method",
                hd_method,
                options=list(
                    "hdmax2",
                    "hima",
                    "bslmm"),
                default="hdmax2")
            private$..hd_fdr_threshold <- jmvcore::OptionNumber$new(
                "hd_fdr_threshold",
                hd_fdr_threshold,
                default=0.1,
                min=0.01,
                max=0.25)
            private$..hd_top_mediators <- jmvcore::OptionInteger$new(
                "hd_top_mediators",
                hd_top_mediators,
                default=20,
                min=5,
                max=100)
            private$..hd_penalty <- jmvcore::OptionList$new(
                "hd_penalty",
                hd_penalty,
                options=list(
                    "lasso",
                    "ridge",
                    "elastic_net"),
                default="lasso")
            private$..hd_parallel <- jmvcore::OptionBool$new(
                "hd_parallel",
                hd_parallel,
                default=TRUE)
            private$..show_decomposition <- jmvcore::OptionBool$new(
                "show_decomposition",
                show_decomposition,
                default=TRUE)
            private$..show_prop_mediated <- jmvcore::OptionBool$new(
                "show_prop_mediated",
                show_prop_mediated,
                default=TRUE)
            private$..sensitivity_analysis <- jmvcore::OptionBool$new(
                "sensitivity_analysis",
                sensitivity_analysis,
                default=FALSE)
            private$..rho_values <- jmvcore::OptionString$new(
                "rho_values",
                rho_values,
                default="0, 0.1, 0.2, 0.3")
            private$..plot_effects <- jmvcore::OptionBool$new(
                "plot_effects",
                plot_effects,
                default=TRUE)
            private$..plot_hd_manhattan <- jmvcore::OptionBool$new(
                "plot_hd_manhattan",
                plot_hd_manhattan,
                default=TRUE)
            private$..plot_hd_volcano <- jmvcore::OptionBool$new(
                "plot_hd_volcano",
                plot_hd_volcano,
                default=TRUE)
            private$..interaction_term <- jmvcore::OptionBool$new(
                "interaction_term",
                interaction_term,
                default=FALSE)
            private$..random_seed <- jmvcore::OptionInteger$new(
                "random_seed",
                random_seed,
                default=42,
                min=1,
                max=999999)

            self$.addOption(private$..outcome)
            self$.addOption(private$..treatment)
            self$.addOption(private$..mediator)
            self$.addOption(private$..mediators)
            self$.addOption(private$..covariates)
            self$.addOption(private$..mediation_tier)
            self$.addOption(private$..boot_samples)
            self$.addOption(private$..conf_level)
            self$.addOption(private$..mediator_model)
            self$.addOption(private$..outcome_model)
            self$.addOption(private$..multiple_mediators)
            self$.addOption(private$..show_dag)
            self$.addOption(private$..cma_estimation)
            self$.addOption(private$..hd_method)
            self$.addOption(private$..hd_fdr_threshold)
            self$.addOption(private$..hd_top_mediators)
            self$.addOption(private$..hd_penalty)
            self$.addOption(private$..hd_parallel)
            self$.addOption(private$..show_decomposition)
            self$.addOption(private$..show_prop_mediated)
            self$.addOption(private$..sensitivity_analysis)
            self$.addOption(private$..rho_values)
            self$.addOption(private$..plot_effects)
            self$.addOption(private$..plot_hd_manhattan)
            self$.addOption(private$..plot_hd_volcano)
            self$.addOption(private$..interaction_term)
            self$.addOption(private$..random_seed)
        }),
    active = list(
        outcome = function() private$..outcome$value,
        treatment = function() private$..treatment$value,
        mediator = function() private$..mediator$value,
        mediators = function() private$..mediators$value,
        covariates = function() private$..covariates$value,
        mediation_tier = function() private$..mediation_tier$value,
        boot_samples = function() private$..boot_samples$value,
        conf_level = function() private$..conf_level$value,
        mediator_model = function() private$..mediator_model$value,
        outcome_model = function() private$..outcome_model$value,
        multiple_mediators = function() private$..multiple_mediators$value,
        show_dag = function() private$..show_dag$value,
        cma_estimation = function() private$..cma_estimation$value,
        hd_method = function() private$..hd_method$value,
        hd_fdr_threshold = function() private$..hd_fdr_threshold$value,
        hd_top_mediators = function() private$..hd_top_mediators$value,
        hd_penalty = function() private$..hd_penalty$value,
        hd_parallel = function() private$..hd_parallel$value,
        show_decomposition = function() private$..show_decomposition$value,
        show_prop_mediated = function() private$..show_prop_mediated$value,
        sensitivity_analysis = function() private$..sensitivity_analysis$value,
        rho_values = function() private$..rho_values$value,
        plot_effects = function() private$..plot_effects$value,
        plot_hd_manhattan = function() private$..plot_hd_manhattan$value,
        plot_hd_volcano = function() private$..plot_hd_volcano$value,
        interaction_term = function() private$..interaction_term$value,
        random_seed = function() private$..random_seed$value),
    private = list(
        ..outcome = NA,
        ..treatment = NA,
        ..mediator = NA,
        ..mediators = NA,
        ..covariates = NA,
        ..mediation_tier = NA,
        ..boot_samples = NA,
        ..conf_level = NA,
        ..mediator_model = NA,
        ..outcome_model = NA,
        ..multiple_mediators = NA,
        ..show_dag = NA,
        ..cma_estimation = NA,
        ..hd_method = NA,
        ..hd_fdr_threshold = NA,
        ..hd_top_mediators = NA,
        ..hd_penalty = NA,
        ..hd_parallel = NA,
        ..show_decomposition = NA,
        ..show_prop_mediated = NA,
        ..sensitivity_analysis = NA,
        ..rho_values = NA,
        ..plot_effects = NA,
        ..plot_hd_manhattan = NA,
        ..plot_hd_volcano = NA,
        ..interaction_term = NA,
        ..random_seed = NA)
)

causalmediationResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "causalmediationResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        tierInfo = function() private$.items[["tierInfo"]],
        effectsTable = function() private$.items[["effectsTable"]],
        proportionMediated = function() private$.items[["proportionMediated"]],
        hdMediatorsTable = function() private$.items[["hdMediatorsTable"]],
        hdSummary = function() private$.items[["hdSummary"]],
        cmaResults = function() private$.items[["cmaResults"]],
        dagPlot = function() private$.items[["dagPlot"]],
        sensitivityTable = function() private$.items[["sensitivityTable"]],
        sensitivityPlot = function() private$.items[["sensitivityPlot"]],
        effectsPlot = function() private$.items[["effectsPlot"]],
        manhattanPlot = function() private$.items[["manhattanPlot"]],
        volcanoPlot = function() private$.items[["volcanoPlot"]],
        modelInfo = function() private$.items[["modelInfo"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Causal Mediation Analysis")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Preformatted$new(
                options=options,
                name="tierInfo",
                title="Mediation Tier Information",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="effectsTable",
                title="Mediation Effect Estimates",
                rows=0,
                visible="(show_decomposition)",
                columns=list(
                    list(
                        `name`="effect", 
                        `title`="Effect Type", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower", 
                        `superTitle`="95% CI", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper", 
                        `superTitle`="95% CI", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="proportionMediated",
                title="Proportion Mediated",
                rows=0,
                visible="(show_prop_mediated)",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower", 
                        `superTitle`="95% CI", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper", 
                        `superTitle`="95% CI", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="hdMediatorsTable",
                title="Significant Mediators (High-Dimensional)",
                rows=0,
                visible="(mediation_tier:hd)",
                columns=list(
                    list(
                        `name`="mediator", 
                        `title`="Mediator", 
                        `type`="text"),
                    list(
                        `name`="alpha", 
                        `title`="\u03B1 (X\u2192M)", 
                        `type`="number"),
                    list(
                        `name`="beta", 
                        `title`="\u03B2 (M\u2192Y)", 
                        `type`="number"),
                    list(
                        `name`="indirect_effect", 
                        `title`="Indirect Effect", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="fdr", 
                        `title`="FDR", 
                        `type`="number"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="hdSummary",
                title="HD Mediation Summary",
                visible="(mediation_tier:hd)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="cmaResults",
                title="CMAverse Analysis Results",
                visible="(mediation_tier:comprehensive)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="dagPlot",
                title="Directed Acyclic Graph (DAG)",
                width=600,
                height=450,
                renderFun=".plotDAG",
                visible="(show_dag)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="sensitivityTable",
                title="Sensitivity Analysis",
                rows=0,
                visible="(sensitivity_analysis)",
                columns=list(
                    list(
                        `name`="rho", 
                        `title`="\u03C1", 
                        `type`="number"),
                    list(
                        `name`="acme_lower", 
                        `title`="ACME Lower", 
                        `type`="number"),
                    list(
                        `name`="acme_upper", 
                        `title`="ACME Upper", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="sensitivityPlot",
                title="Sensitivity Analysis Plot",
                width=600,
                height=450,
                renderFun=".plotSensitivity",
                visible="(sensitivity_analysis)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="effectsPlot",
                title="Mediation Effects",
                width=600,
                height=450,
                renderFun=".plotEffects",
                visible="(plot_effects)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="manhattanPlot",
                title="Manhattan Plot (HD Mediators)",
                width=800,
                height=450,
                renderFun=".plotManhattan",
                visible="(plot_hd_manhattan)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="volcanoPlot",
                title="Volcano Plot (HD Mediators)",
                width=600,
                height=450,
                renderFun=".plotVolcano",
                visible="(plot_hd_volcano)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="modelInfo",
                title="Model Information",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Interpretation Guide",
                visible=TRUE))}))

causalmediationBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "causalmediationBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "causalmediation",
                version = c(0,0,32),
                options = options,
                results = causalmediationResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = TRUE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Causal Mediation Analysis
#'
#' Causal Mediation Analysis examines the mechanisms through which an
#' exposure affects an outcome. This module provides three tiers:
#' 
#' 1. **Basic Mediation**: Traditional mediation analysis (mediation package)
#' 2. **Comprehensive Mediation**: Multiple mediators with DAGs (CMAverse)
#' 3. **HIGH-DIMENSIONAL Mediation**: Omics-scale mediators (hdmax2)
#' 
#' Applications: Understanding pathways in cancer biology, clinical trials,
#' epidemiology, and precision medicine research.
#' 
#'
#' @examples
#' # Example: Basic mediation
#' causalmediation(
#'     data = mydata,
#'     outcome = 'survival_time',
#'     treatment = 'drug_exposure',
#'     mediator = 'biomarker_level',
#'     covariates = c('age', 'stage'),
#'     mediation_tier = 'basic'
#' )
#'
#' # Example: High-dimensional mediation with omics
#' causalmediation(
#'     data = omics_data,
#'     outcome = 'disease_status',
#'     treatment = 'environmental_exposure',
#'     mediators = methylation_probes,  # 50,000 probes
#'     mediation_tier = 'hd',
#'     hd_method = 'hdmax2'
#' )
#'
#' @param data the data as a data frame
#' @param outcome Outcome variable (Y)
#' @param treatment Treatment or exposure variable (X)
#' @param mediator Mediator variable for basic/comprehensive mediation (M)
#' @param mediators Multiple mediators for high-dimensional analysis
#' @param covariates Confounding variables (Z)
#' @param mediation_tier Tier of mediation analysis to perform
#' @param boot_samples Number of bootstrap samples for confidence intervals
#' @param conf_level Confidence level for intervals
#' @param mediator_model Model type for mediator regression
#' @param outcome_model Model type for outcome regression
#' @param multiple_mediators Multiple mediators for CMAverse analysis
#' @param show_dag Display directed acyclic graph
#' @param cma_estimation Estimation method for CMAverse
#' @param hd_method Method for high-dimensional mediation
#' @param hd_fdr_threshold False discovery rate threshold for HD mediation
#' @param hd_top_mediators Number of top mediators to display
#' @param hd_penalty Penalization method for variable selection
#' @param hd_parallel Enable parallel computing for HD analysis
#' @param show_decomposition Display total, direct, and indirect effects
#' @param show_prop_mediated Calculate proportion of effect mediated
#' @param sensitivity_analysis Perform sensitivity analysis for unmeasured
#'   confounding
#' @param rho_values Correlation values for sensitivity analysis
#' @param plot_effects Generate forest plot of effects
#' @param plot_hd_manhattan Generate Manhattan plot for HD mediation
#' @param plot_hd_volcano Generate volcano plot for HD mediation
#' @param interaction_term Model treatment-mediator interaction
#' @param random_seed Random seed for reproducibility
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$tierInfo} \tab \tab \tab \tab \tab a preformatted \cr
#'   \code{results$effectsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$proportionMediated} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$hdMediatorsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$hdSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$cmaResults} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$dagPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$sensitivityTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$sensitivityPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$effectsPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$manhattanPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$volcanoPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$modelInfo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$effectsTable$asDF}
#'
#' \code{as.data.frame(results$effectsTable)}
#'
#' @export
causalmediation <- function(
    data,
    outcome,
    treatment,
    mediator = NULL,
    mediators = NULL,
    covariates = NULL,
    mediation_tier = "basic",
    boot_samples = 1000,
    conf_level = 0.95,
    mediator_model = "lm",
    outcome_model = "lm",
    multiple_mediators = NULL,
    show_dag = TRUE,
    cma_estimation = "rb",
    hd_method = "hdmax2",
    hd_fdr_threshold = 0.1,
    hd_top_mediators = 20,
    hd_penalty = "lasso",
    hd_parallel = TRUE,
    show_decomposition = TRUE,
    show_prop_mediated = TRUE,
    sensitivity_analysis = FALSE,
    rho_values = "0, 0.1, 0.2, 0.3",
    plot_effects = TRUE,
    plot_hd_manhattan = TRUE,
    plot_hd_volcano = TRUE,
    interaction_term = FALSE,
    random_seed = 42) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("causalmediation requires jmvcore to be installed (restart may be required)")

    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(treatment)) treatment <- jmvcore::resolveQuo(jmvcore::enquo(treatment))
    if ( ! missing(mediator)) mediator <- jmvcore::resolveQuo(jmvcore::enquo(mediator))
    if ( ! missing(mediators)) mediators <- jmvcore::resolveQuo(jmvcore::enquo(mediators))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(multiple_mediators)) multiple_mediators <- jmvcore::resolveQuo(jmvcore::enquo(multiple_mediators))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(treatment), treatment, NULL),
            `if`( ! missing(mediator), mediator, NULL),
            `if`( ! missing(mediators), mediators, NULL),
            `if`( ! missing(covariates), covariates, NULL),
            `if`( ! missing(multiple_mediators), multiple_mediators, NULL))


    options <- causalmediationOptions$new(
        outcome = outcome,
        treatment = treatment,
        mediator = mediator,
        mediators = mediators,
        covariates = covariates,
        mediation_tier = mediation_tier,
        boot_samples = boot_samples,
        conf_level = conf_level,
        mediator_model = mediator_model,
        outcome_model = outcome_model,
        multiple_mediators = multiple_mediators,
        show_dag = show_dag,
        cma_estimation = cma_estimation,
        hd_method = hd_method,
        hd_fdr_threshold = hd_fdr_threshold,
        hd_top_mediators = hd_top_mediators,
        hd_penalty = hd_penalty,
        hd_parallel = hd_parallel,
        show_decomposition = show_decomposition,
        show_prop_mediated = show_prop_mediated,
        sensitivity_analysis = sensitivity_analysis,
        rho_values = rho_values,
        plot_effects = plot_effects,
        plot_hd_manhattan = plot_hd_manhattan,
        plot_hd_volcano = plot_hd_volcano,
        interaction_term = interaction_term,
        random_seed = random_seed)

    analysis <- causalmediationClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

