
# This file is automatically generated, you probably don't want to edit this

smoothtimevaryOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "smoothtimevaryOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            outcome = NULL,
            covariates = NULL,
            outcomeLevel = "1",
            time_varying_covariates = NULL,
            smoothing_method = "spline",
            spline_df = 4,
            bandwidth = 1,
            confidence_level = 0.95,
            test_constancy = TRUE,
            residual_analysis = TRUE,
            show_model_summary = TRUE,
            show_effects_table = TRUE,
            show_constancy_tests = TRUE,
            show_smooth_plots = TRUE,
            show_diagnostic_plots = TRUE,
            show_comparison_plots = TRUE,
            showSummaries = FALSE,
            showExplanations = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="smoothtimevary",
                requiresData=TRUE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..outcomeLevel <- jmvcore::OptionString$new(
                "outcomeLevel",
                outcomeLevel,
                default="1")
            private$..time_varying_covariates <- jmvcore::OptionVariables$new(
                "time_varying_covariates",
                time_varying_covariates,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..smoothing_method <- jmvcore::OptionList$new(
                "smoothing_method",
                smoothing_method,
                options=list(
                    "spline",
                    "loess",
                    "kernel",
                    "penalized_spline"),
                default="spline")
            private$..spline_df <- jmvcore::OptionNumber$new(
                "spline_df",
                spline_df,
                min=2,
                max=10,
                default=4)
            private$..bandwidth <- jmvcore::OptionNumber$new(
                "bandwidth",
                bandwidth,
                min=0.1,
                max=3,
                default=1)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..test_constancy <- jmvcore::OptionBool$new(
                "test_constancy",
                test_constancy,
                default=TRUE)
            private$..residual_analysis <- jmvcore::OptionBool$new(
                "residual_analysis",
                residual_analysis,
                default=TRUE)
            private$..show_model_summary <- jmvcore::OptionBool$new(
                "show_model_summary",
                show_model_summary,
                default=TRUE)
            private$..show_effects_table <- jmvcore::OptionBool$new(
                "show_effects_table",
                show_effects_table,
                default=TRUE)
            private$..show_constancy_tests <- jmvcore::OptionBool$new(
                "show_constancy_tests",
                show_constancy_tests,
                default=TRUE)
            private$..show_smooth_plots <- jmvcore::OptionBool$new(
                "show_smooth_plots",
                show_smooth_plots,
                default=TRUE)
            private$..show_diagnostic_plots <- jmvcore::OptionBool$new(
                "show_diagnostic_plots",
                show_diagnostic_plots,
                default=TRUE)
            private$..show_comparison_plots <- jmvcore::OptionBool$new(
                "show_comparison_plots",
                show_comparison_plots,
                default=TRUE)
            private$..showSummaries <- jmvcore::OptionBool$new(
                "showSummaries",
                showSummaries,
                default=FALSE)
            private$..showExplanations <- jmvcore::OptionBool$new(
                "showExplanations",
                showExplanations,
                default=FALSE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..outcome)
            self$.addOption(private$..covariates)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..time_varying_covariates)
            self$.addOption(private$..smoothing_method)
            self$.addOption(private$..spline_df)
            self$.addOption(private$..bandwidth)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..test_constancy)
            self$.addOption(private$..residual_analysis)
            self$.addOption(private$..show_model_summary)
            self$.addOption(private$..show_effects_table)
            self$.addOption(private$..show_constancy_tests)
            self$.addOption(private$..show_smooth_plots)
            self$.addOption(private$..show_diagnostic_plots)
            self$.addOption(private$..show_comparison_plots)
            self$.addOption(private$..showSummaries)
            self$.addOption(private$..showExplanations)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        outcome = function() private$..outcome$value,
        covariates = function() private$..covariates$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        time_varying_covariates = function() private$..time_varying_covariates$value,
        smoothing_method = function() private$..smoothing_method$value,
        spline_df = function() private$..spline_df$value,
        bandwidth = function() private$..bandwidth$value,
        confidence_level = function() private$..confidence_level$value,
        test_constancy = function() private$..test_constancy$value,
        residual_analysis = function() private$..residual_analysis$value,
        show_model_summary = function() private$..show_model_summary$value,
        show_effects_table = function() private$..show_effects_table$value,
        show_constancy_tests = function() private$..show_constancy_tests$value,
        show_smooth_plots = function() private$..show_smooth_plots$value,
        show_diagnostic_plots = function() private$..show_diagnostic_plots$value,
        show_comparison_plots = function() private$..show_comparison_plots$value,
        showSummaries = function() private$..showSummaries$value,
        showExplanations = function() private$..showExplanations$value),
    private = list(
        ..elapsedtime = NA,
        ..outcome = NA,
        ..covariates = NA,
        ..outcomeLevel = NA,
        ..time_varying_covariates = NA,
        ..smoothing_method = NA,
        ..spline_df = NA,
        ..bandwidth = NA,
        ..confidence_level = NA,
        ..test_constancy = NA,
        ..residual_analysis = NA,
        ..show_model_summary = NA,
        ..show_effects_table = NA,
        ..show_constancy_tests = NA,
        ..show_smooth_plots = NA,
        ..show_diagnostic_plots = NA,
        ..show_comparison_plots = NA,
        ..showSummaries = NA,
        ..showExplanations = NA)
)

smoothtimevaryResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "smoothtimevaryResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        modelSummary = function() private$.items[["modelSummary"]],
        effectsTable = function() private$.items[["effectsTable"]],
        constancyTests = function() private$.items[["constancyTests"]],
        modelComparison = function() private$.items[["modelComparison"]],
        smoothingParameters = function() private$.items[["smoothingParameters"]],
        goodnessOfFit = function() private$.items[["goodnessOfFit"]],
        smoothEffectPlots = function() private$.items[["smoothEffectPlots"]],
        diagnosticPlots = function() private$.items[["diagnosticPlots"]],
        residualPlots = function() private$.items[["residualPlots"]],
        comparisonPlots = function() private$.items[["comparisonPlots"]],
        smoothingPlots = function() private$.items[["smoothingPlots"]],
        analysisSummary = function() private$.items[["analysisSummary"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Smoothly Time-Varying Effects",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                visible="(show_model_summary)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="effectsTable",
                title="Smooth Time-Varying Effects",
                visible="(show_effects_table)",
                columns=list(
                    list(
                        `name`="covariate", 
                        `title`="Covariate", 
                        `type`="text"),
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="effect_estimate", 
                        `title`="\u03B2(t)", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="constancyTests",
                title="Tests for Effect Constancy",
                visible="(test_constancy && show_constancy_tests)",
                columns=list(
                    list(
                        `name`="covariate", 
                        `title`="Covariate", 
                        `type`="text"),
                    list(
                        `name`="test_statistic", 
                        `title`="Test Statistic", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number"),
                    list(
                        `name`="conclusion", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelComparison",
                title="Model Comparison",
                visible="(show_model_summary)",
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number"),
                    list(
                        `name`="loglik", 
                        `title`="Log-Likelihood", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="smoothingParameters",
                title="Smoothing Parameters",
                visible="(show_model_summary)",
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"),
                    list(
                        `name`="description", 
                        `title`="Description", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="goodnessOfFit",
                title="Goodness of Fit Statistics",
                visible="(show_model_summary)",
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="smoothEffectPlots",
                title="Smooth Time-Varying Effects",
                visible="(show_smooth_plots)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagnosticPlots",
                title="Model Diagnostics",
                visible="(show_diagnostic_plots)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="residualPlots",
                title="Residual Analysis",
                visible="(residual_analysis && show_diagnostic_plots)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="comparisonPlots",
                title="Model Comparison Plots",
                visible="(show_comparison_plots)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="smoothingPlots",
                title="Smoothing Method Comparison",
                visible="(show_diagnostic_plots)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="analysisSummary",
                title="Analysis Summary",
                visible="(showSummaries)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Methodology",
                visible="(showExplanations)"))}))

smoothtimevaryBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "smoothtimevaryBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "smoothtimevary",
                version = c(1,0,0),
                options = options,
                results = smoothtimevaryResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Smoothly Time-Varying Effects
#'
#' Implements smooth estimation of time-varying covariate effects in survival 
#' analysis using flexible spline-based methods. This approach provides 
#' continuous modeling of how covariate effects change over time, offering an 
#' alternative to step-function approaches in standard time-varying Cox models 
#' and complementing Aalen's additive hazard methodology.
#'
#' @examples
#' # Example 1: Spline-based time-varying effects
#' library(timereg)
#' library(survival)
#'
#' smoothtimevary(
#'     data = veteran_data,
#'     elapsedtime = "time",
#'     outcome = "status",
#'     outcomeLevel = "1",
#'     covariates = c("age", "karno"),
#'     time_varying_covariates = c("diagtime"),
#'     smoothing_method = "spline"
#' )
#'
#' @param data the data as a data frame
#' @param elapsedtime Survival time or follow-up duration variable
#' @param outcome Event indicator variable (0/1, FALSE/TRUE, or factor)
#' @param covariates Covariate variables for smooth time-varying effects
#'   modeling
#' @param outcomeLevel Level of outcome variable indicating event occurrence
#' @param time_varying_covariates Covariates to model with smooth time-varying
#'   effects
#' @param smoothing_method Method for smooth estimation of time-varying
#'   effects
#' @param spline_df Degrees of freedom for spline-based smoothing
#' @param bandwidth Bandwidth parameter for kernel or LOESS smoothing
#' @param confidence_level Confidence level for interval estimation
#' @param test_constancy Test whether covariate effects are constant over time
#' @param residual_analysis Perform comprehensive residual analysis and
#'   diagnostics
#' @param show_model_summary Display comprehensive model summary
#' @param show_effects_table Display table of smooth time-varying effects
#' @param show_constancy_tests Display statistical tests for effect constancy
#' @param show_smooth_plots Display plots of smooth time-varying effects
#' @param show_diagnostic_plots Display model diagnostic and residual plots
#' @param show_comparison_plots Display comparison with constant effects
#'   models
#' @param showSummaries Generate natural language summaries of the analysis
#'   results
#' @param showExplanations Show detailed explanations of the methodology and
#'   interpretation
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$effectsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$constancyTests} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$smoothingParameters} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$goodnessOfFit} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$smoothEffectPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$diagnosticPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$residualPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$comparisonPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$smoothingPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$analysisSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$effectsTable$asDF}
#'
#' \code{as.data.frame(results$effectsTable)}
#'
#' @export
smoothtimevary <- function(
    data,
    elapsedtime,
    outcome,
    covariates,
    outcomeLevel = "1",
    time_varying_covariates,
    smoothing_method = "spline",
    spline_df = 4,
    bandwidth = 1,
    confidence_level = 0.95,
    test_constancy = TRUE,
    residual_analysis = TRUE,
    show_model_summary = TRUE,
    show_effects_table = TRUE,
    show_constancy_tests = TRUE,
    show_smooth_plots = TRUE,
    show_diagnostic_plots = TRUE,
    show_comparison_plots = TRUE,
    showSummaries = FALSE,
    showExplanations = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("smoothtimevary requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(time_varying_covariates)) time_varying_covariates <- jmvcore::resolveQuo(jmvcore::enquo(time_varying_covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(elapsedtime), elapsedtime, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(covariates), covariates, NULL),
            `if`( ! missing(time_varying_covariates), time_varying_covariates, NULL))


    options <- smoothtimevaryOptions$new(
        elapsedtime = elapsedtime,
        outcome = outcome,
        covariates = covariates,
        outcomeLevel = outcomeLevel,
        time_varying_covariates = time_varying_covariates,
        smoothing_method = smoothing_method,
        spline_df = spline_df,
        bandwidth = bandwidth,
        confidence_level = confidence_level,
        test_constancy = test_constancy,
        residual_analysis = residual_analysis,
        show_model_summary = show_model_summary,
        show_effects_table = show_effects_table,
        show_constancy_tests = show_constancy_tests,
        show_smooth_plots = show_smooth_plots,
        show_diagnostic_plots = show_diagnostic_plots,
        show_comparison_plots = show_comparison_plots,
        showSummaries = showSummaries,
        showExplanations = showExplanations)

    analysis <- smoothtimevaryClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

