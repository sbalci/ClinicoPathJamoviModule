
# This file is automatically generated, you probably don't want to edit this

ihcclusterOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcclusterOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            catVars = NULL,
            contVars = NULL,
            caseId = NULL,
            spatialCompartment = NULL,
            performSpatialAnalysis = FALSE,
            spatialComparisonMode = "both",
            method = "pam",
            distanceMethod = "gower",
            linkageMethod = "ward",
            nClusters = 3,
            autoSelectK = TRUE,
            kRange = "medium",
            scaleContVars = TRUE,
            weights = "",
            handleMissing = "pairwise",
            consensusClustering = FALSE,
            nBootstrap = 100,
            seed = 42,
            showSilhouette = TRUE,
            showHeatmap = TRUE,
            heatmapScale = "row",
            showDendrogram = TRUE,
            showPCAPlot = TRUE,
            showBoxplots = TRUE,
            markerSummary = TRUE,
            clusterProfiles = TRUE,
            associationTests = TRUE,
            multipleTestingCorrection = "bonferroni",
            markerOptimization = FALSE,
            showMarkerCorrelation = FALSE,
            clusterQualityMetrics = TRUE,
            iterativeRefinement = FALSE,
            refinementIterations = 3,
            reproducibilityTest = FALSE,
            nSplits = 10,
            supervisedClustering = FALSE,
            supervisedVariable = NULL,
            calculateRatios = FALSE,
            ratioNumerator = NULL,
            ratioDenominator = NULL,
            ratioName = "Marker_Ratio",
            ratioClassification = FALSE,
            ratioLowCutoff = 1,
            ratioHighCutoff = 2,
            exportClusters = FALSE,
            knownDiagnosis = NULL,
            calculateDiagnosticMetrics = FALSE,
            identifyOptimalPanel = FALSE,
            panelSize = "pairs",
            flagOutliers = TRUE,
            outlierThreshold = 0.25,
            clinicalVars = NULL,
            survivalTime = NULL,
            survivalEvent = NULL,
            colorPalette = "default",
            fontSize = "medium",
            plotContrast = FALSE,
            showInterpretation = FALSE,
            showTechnicalNotes = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="ihccluster",
                requiresData=TRUE,
                ...)

            private$..catVars <- jmvcore::OptionVariables$new(
                "catVars",
                catVars,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..contVars <- jmvcore::OptionVariables$new(
                "contVars",
                contVars,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..caseId <- jmvcore::OptionVariable$new(
                "caseId",
                caseId,
                suggested=list(
                    "nominal",
                    "id"),
                permitted=list(
                    "factor",
                    "id"),
                default=NULL)
            private$..spatialCompartment <- jmvcore::OptionVariable$new(
                "spatialCompartment",
                spatialCompartment,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..performSpatialAnalysis <- jmvcore::OptionBool$new(
                "performSpatialAnalysis",
                performSpatialAnalysis,
                default=FALSE)
            private$..spatialComparisonMode <- jmvcore::OptionList$new(
                "spatialComparisonMode",
                spatialComparisonMode,
                options=list(
                    "between",
                    "within",
                    "both"),
                default="both")
            private$..method <- jmvcore::OptionList$new(
                "method",
                method,
                options=list(
                    "pam",
                    "hierarchical",
                    "dimreduce"),
                default="pam")
            private$..distanceMethod <- jmvcore::OptionList$new(
                "distanceMethod",
                distanceMethod,
                options=list(
                    "gower",
                    "jaccard"),
                default="gower")
            private$..linkageMethod <- jmvcore::OptionList$new(
                "linkageMethod",
                linkageMethod,
                options=list(
                    "ward",
                    "complete",
                    "average",
                    "single"),
                default="ward")
            private$..nClusters <- jmvcore::OptionInteger$new(
                "nClusters",
                nClusters,
                min=2,
                max=15,
                default=3)
            private$..autoSelectK <- jmvcore::OptionBool$new(
                "autoSelectK",
                autoSelectK,
                default=TRUE)
            private$..kRange <- jmvcore::OptionList$new(
                "kRange",
                kRange,
                options=list(
                    "small",
                    "medium",
                    "large"),
                default="medium")
            private$..scaleContVars <- jmvcore::OptionBool$new(
                "scaleContVars",
                scaleContVars,
                default=TRUE)
            private$..weights <- jmvcore::OptionString$new(
                "weights",
                weights,
                default="")
            private$..handleMissing <- jmvcore::OptionList$new(
                "handleMissing",
                handleMissing,
                options=list(
                    "complete",
                    "pairwise"),
                default="pairwise")
            private$..consensusClustering <- jmvcore::OptionBool$new(
                "consensusClustering",
                consensusClustering,
                default=FALSE)
            private$..nBootstrap <- jmvcore::OptionInteger$new(
                "nBootstrap",
                nBootstrap,
                min=50,
                max=1000,
                default=100)
            private$..seed <- jmvcore::OptionInteger$new(
                "seed",
                seed,
                default=42)
            private$..showSilhouette <- jmvcore::OptionBool$new(
                "showSilhouette",
                showSilhouette,
                default=TRUE)
            private$..showHeatmap <- jmvcore::OptionBool$new(
                "showHeatmap",
                showHeatmap,
                default=TRUE)
            private$..heatmapScale <- jmvcore::OptionList$new(
                "heatmapScale",
                heatmapScale,
                options=list(
                    "row",
                    "column",
                    "none"),
                default="row")
            private$..showDendrogram <- jmvcore::OptionBool$new(
                "showDendrogram",
                showDendrogram,
                default=TRUE)
            private$..showPCAPlot <- jmvcore::OptionBool$new(
                "showPCAPlot",
                showPCAPlot,
                default=TRUE)
            private$..showBoxplots <- jmvcore::OptionBool$new(
                "showBoxplots",
                showBoxplots,
                default=TRUE)
            private$..markerSummary <- jmvcore::OptionBool$new(
                "markerSummary",
                markerSummary,
                default=TRUE)
            private$..clusterProfiles <- jmvcore::OptionBool$new(
                "clusterProfiles",
                clusterProfiles,
                default=TRUE)
            private$..associationTests <- jmvcore::OptionBool$new(
                "associationTests",
                associationTests,
                default=TRUE)
            private$..multipleTestingCorrection <- jmvcore::OptionList$new(
                "multipleTestingCorrection",
                multipleTestingCorrection,
                options=list(
                    "none",
                    "bonferroni",
                    "fdr",
                    "holm"),
                default="bonferroni")
            private$..markerOptimization <- jmvcore::OptionBool$new(
                "markerOptimization",
                markerOptimization,
                default=FALSE)
            private$..showMarkerCorrelation <- jmvcore::OptionBool$new(
                "showMarkerCorrelation",
                showMarkerCorrelation,
                default=FALSE)
            private$..clusterQualityMetrics <- jmvcore::OptionBool$new(
                "clusterQualityMetrics",
                clusterQualityMetrics,
                default=TRUE)
            private$..iterativeRefinement <- jmvcore::OptionBool$new(
                "iterativeRefinement",
                iterativeRefinement,
                default=FALSE)
            private$..refinementIterations <- jmvcore::OptionInteger$new(
                "refinementIterations",
                refinementIterations,
                min=2,
                max=5,
                default=3)
            private$..reproducibilityTest <- jmvcore::OptionBool$new(
                "reproducibilityTest",
                reproducibilityTest,
                default=FALSE)
            private$..nSplits <- jmvcore::OptionInteger$new(
                "nSplits",
                nSplits,
                min=1,
                max=100,
                default=10)
            private$..supervisedClustering <- jmvcore::OptionBool$new(
                "supervisedClustering",
                supervisedClustering,
                default=FALSE)
            private$..supervisedVariable <- jmvcore::OptionVariable$new(
                "supervisedVariable",
                supervisedVariable,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..calculateRatios <- jmvcore::OptionBool$new(
                "calculateRatios",
                calculateRatios,
                default=FALSE)
            private$..ratioNumerator <- jmvcore::OptionVariable$new(
                "ratioNumerator",
                ratioNumerator,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..ratioDenominator <- jmvcore::OptionVariable$new(
                "ratioDenominator",
                ratioDenominator,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..ratioName <- jmvcore::OptionString$new(
                "ratioName",
                ratioName,
                default="Marker_Ratio")
            private$..ratioClassification <- jmvcore::OptionBool$new(
                "ratioClassification",
                ratioClassification,
                default=FALSE)
            private$..ratioLowCutoff <- jmvcore::OptionNumber$new(
                "ratioLowCutoff",
                ratioLowCutoff,
                default=1)
            private$..ratioHighCutoff <- jmvcore::OptionNumber$new(
                "ratioHighCutoff",
                ratioHighCutoff,
                default=2)
            private$..exportClusters <- jmvcore::OptionBool$new(
                "exportClusters",
                exportClusters,
                default=FALSE)
            private$..knownDiagnosis <- jmvcore::OptionVariable$new(
                "knownDiagnosis",
                knownDiagnosis,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..calculateDiagnosticMetrics <- jmvcore::OptionBool$new(
                "calculateDiagnosticMetrics",
                calculateDiagnosticMetrics,
                default=FALSE)
            private$..identifyOptimalPanel <- jmvcore::OptionBool$new(
                "identifyOptimalPanel",
                identifyOptimalPanel,
                default=FALSE)
            private$..panelSize <- jmvcore::OptionList$new(
                "panelSize",
                panelSize,
                options=list(
                    "pairs",
                    "triplets",
                    "both"),
                default="pairs")
            private$..flagOutliers <- jmvcore::OptionBool$new(
                "flagOutliers",
                flagOutliers,
                default=TRUE)
            private$..outlierThreshold <- jmvcore::OptionNumber$new(
                "outlierThreshold",
                outlierThreshold,
                min=0,
                max=0.5,
                default=0.25)
            private$..clinicalVars <- jmvcore::OptionVariables$new(
                "clinicalVars",
                clinicalVars,
                suggested=list(
                    "nominal",
                    "ordinal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..survivalTime <- jmvcore::OptionVariable$new(
                "survivalTime",
                survivalTime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..survivalEvent <- jmvcore::OptionVariable$new(
                "survivalEvent",
                survivalEvent,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..colorPalette <- jmvcore::OptionList$new(
                "colorPalette",
                colorPalette,
                options=list(
                    "default",
                    "colorblind",
                    "viridis",
                    "high_contrast"),
                default="default")
            private$..fontSize <- jmvcore::OptionList$new(
                "fontSize",
                fontSize,
                options=list(
                    "small",
                    "medium",
                    "large",
                    "extra_large"),
                default="medium")
            private$..plotContrast <- jmvcore::OptionBool$new(
                "plotContrast",
                plotContrast,
                default=FALSE)
            private$..showInterpretation <- jmvcore::OptionBool$new(
                "showInterpretation",
                showInterpretation,
                default=FALSE)
            private$..showTechnicalNotes <- jmvcore::OptionBool$new(
                "showTechnicalNotes",
                showTechnicalNotes,
                default=FALSE)

            self$.addOption(private$..catVars)
            self$.addOption(private$..contVars)
            self$.addOption(private$..caseId)
            self$.addOption(private$..spatialCompartment)
            self$.addOption(private$..performSpatialAnalysis)
            self$.addOption(private$..spatialComparisonMode)
            self$.addOption(private$..method)
            self$.addOption(private$..distanceMethod)
            self$.addOption(private$..linkageMethod)
            self$.addOption(private$..nClusters)
            self$.addOption(private$..autoSelectK)
            self$.addOption(private$..kRange)
            self$.addOption(private$..scaleContVars)
            self$.addOption(private$..weights)
            self$.addOption(private$..handleMissing)
            self$.addOption(private$..consensusClustering)
            self$.addOption(private$..nBootstrap)
            self$.addOption(private$..seed)
            self$.addOption(private$..showSilhouette)
            self$.addOption(private$..showHeatmap)
            self$.addOption(private$..heatmapScale)
            self$.addOption(private$..showDendrogram)
            self$.addOption(private$..showPCAPlot)
            self$.addOption(private$..showBoxplots)
            self$.addOption(private$..markerSummary)
            self$.addOption(private$..clusterProfiles)
            self$.addOption(private$..associationTests)
            self$.addOption(private$..multipleTestingCorrection)
            self$.addOption(private$..markerOptimization)
            self$.addOption(private$..showMarkerCorrelation)
            self$.addOption(private$..clusterQualityMetrics)
            self$.addOption(private$..iterativeRefinement)
            self$.addOption(private$..refinementIterations)
            self$.addOption(private$..reproducibilityTest)
            self$.addOption(private$..nSplits)
            self$.addOption(private$..supervisedClustering)
            self$.addOption(private$..supervisedVariable)
            self$.addOption(private$..calculateRatios)
            self$.addOption(private$..ratioNumerator)
            self$.addOption(private$..ratioDenominator)
            self$.addOption(private$..ratioName)
            self$.addOption(private$..ratioClassification)
            self$.addOption(private$..ratioLowCutoff)
            self$.addOption(private$..ratioHighCutoff)
            self$.addOption(private$..exportClusters)
            self$.addOption(private$..knownDiagnosis)
            self$.addOption(private$..calculateDiagnosticMetrics)
            self$.addOption(private$..identifyOptimalPanel)
            self$.addOption(private$..panelSize)
            self$.addOption(private$..flagOutliers)
            self$.addOption(private$..outlierThreshold)
            self$.addOption(private$..clinicalVars)
            self$.addOption(private$..survivalTime)
            self$.addOption(private$..survivalEvent)
            self$.addOption(private$..colorPalette)
            self$.addOption(private$..fontSize)
            self$.addOption(private$..plotContrast)
            self$.addOption(private$..showInterpretation)
            self$.addOption(private$..showTechnicalNotes)
        }),
    active = list(
        catVars = function() private$..catVars$value,
        contVars = function() private$..contVars$value,
        caseId = function() private$..caseId$value,
        spatialCompartment = function() private$..spatialCompartment$value,
        performSpatialAnalysis = function() private$..performSpatialAnalysis$value,
        spatialComparisonMode = function() private$..spatialComparisonMode$value,
        method = function() private$..method$value,
        distanceMethod = function() private$..distanceMethod$value,
        linkageMethod = function() private$..linkageMethod$value,
        nClusters = function() private$..nClusters$value,
        autoSelectK = function() private$..autoSelectK$value,
        kRange = function() private$..kRange$value,
        scaleContVars = function() private$..scaleContVars$value,
        weights = function() private$..weights$value,
        handleMissing = function() private$..handleMissing$value,
        consensusClustering = function() private$..consensusClustering$value,
        nBootstrap = function() private$..nBootstrap$value,
        seed = function() private$..seed$value,
        showSilhouette = function() private$..showSilhouette$value,
        showHeatmap = function() private$..showHeatmap$value,
        heatmapScale = function() private$..heatmapScale$value,
        showDendrogram = function() private$..showDendrogram$value,
        showPCAPlot = function() private$..showPCAPlot$value,
        showBoxplots = function() private$..showBoxplots$value,
        markerSummary = function() private$..markerSummary$value,
        clusterProfiles = function() private$..clusterProfiles$value,
        associationTests = function() private$..associationTests$value,
        multipleTestingCorrection = function() private$..multipleTestingCorrection$value,
        markerOptimization = function() private$..markerOptimization$value,
        showMarkerCorrelation = function() private$..showMarkerCorrelation$value,
        clusterQualityMetrics = function() private$..clusterQualityMetrics$value,
        iterativeRefinement = function() private$..iterativeRefinement$value,
        refinementIterations = function() private$..refinementIterations$value,
        reproducibilityTest = function() private$..reproducibilityTest$value,
        nSplits = function() private$..nSplits$value,
        supervisedClustering = function() private$..supervisedClustering$value,
        supervisedVariable = function() private$..supervisedVariable$value,
        calculateRatios = function() private$..calculateRatios$value,
        ratioNumerator = function() private$..ratioNumerator$value,
        ratioDenominator = function() private$..ratioDenominator$value,
        ratioName = function() private$..ratioName$value,
        ratioClassification = function() private$..ratioClassification$value,
        ratioLowCutoff = function() private$..ratioLowCutoff$value,
        ratioHighCutoff = function() private$..ratioHighCutoff$value,
        exportClusters = function() private$..exportClusters$value,
        knownDiagnosis = function() private$..knownDiagnosis$value,
        calculateDiagnosticMetrics = function() private$..calculateDiagnosticMetrics$value,
        identifyOptimalPanel = function() private$..identifyOptimalPanel$value,
        panelSize = function() private$..panelSize$value,
        flagOutliers = function() private$..flagOutliers$value,
        outlierThreshold = function() private$..outlierThreshold$value,
        clinicalVars = function() private$..clinicalVars$value,
        survivalTime = function() private$..survivalTime$value,
        survivalEvent = function() private$..survivalEvent$value,
        colorPalette = function() private$..colorPalette$value,
        fontSize = function() private$..fontSize$value,
        plotContrast = function() private$..plotContrast$value,
        showInterpretation = function() private$..showInterpretation$value,
        showTechnicalNotes = function() private$..showTechnicalNotes$value),
    private = list(
        ..catVars = NA,
        ..contVars = NA,
        ..caseId = NA,
        ..spatialCompartment = NA,
        ..performSpatialAnalysis = NA,
        ..spatialComparisonMode = NA,
        ..method = NA,
        ..distanceMethod = NA,
        ..linkageMethod = NA,
        ..nClusters = NA,
        ..autoSelectK = NA,
        ..kRange = NA,
        ..scaleContVars = NA,
        ..weights = NA,
        ..handleMissing = NA,
        ..consensusClustering = NA,
        ..nBootstrap = NA,
        ..seed = NA,
        ..showSilhouette = NA,
        ..showHeatmap = NA,
        ..heatmapScale = NA,
        ..showDendrogram = NA,
        ..showPCAPlot = NA,
        ..showBoxplots = NA,
        ..markerSummary = NA,
        ..clusterProfiles = NA,
        ..associationTests = NA,
        ..multipleTestingCorrection = NA,
        ..markerOptimization = NA,
        ..showMarkerCorrelation = NA,
        ..clusterQualityMetrics = NA,
        ..iterativeRefinement = NA,
        ..refinementIterations = NA,
        ..reproducibilityTest = NA,
        ..nSplits = NA,
        ..supervisedClustering = NA,
        ..supervisedVariable = NA,
        ..calculateRatios = NA,
        ..ratioNumerator = NA,
        ..ratioDenominator = NA,
        ..ratioName = NA,
        ..ratioClassification = NA,
        ..ratioLowCutoff = NA,
        ..ratioHighCutoff = NA,
        ..exportClusters = NA,
        ..knownDiagnosis = NA,
        ..calculateDiagnosticMetrics = NA,
        ..identifyOptimalPanel = NA,
        ..panelSize = NA,
        ..flagOutliers = NA,
        ..outlierThreshold = NA,
        ..clinicalVars = NA,
        ..survivalTime = NA,
        ..survivalEvent = NA,
        ..colorPalette = NA,
        ..fontSize = NA,
        ..plotContrast = NA,
        ..showInterpretation = NA,
        ..showTechnicalNotes = NA)
)

ihcclusterResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcclusterResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        binaryConversionNote = function() private$.items[["binaryConversionNote"]],
        summary = function() private$.items[["summary"]],
        clusterSizes = function() private$.items[["clusterSizes"]],
        silhouetteStats = function() private$.items[["silhouetteStats"]],
        clusterProfiles = function() private$.items[["clusterProfiles"]],
        markerSummary = function() private$.items[["markerSummary"]],
        associationTests = function() private$.items[["associationTests"]],
        clinicalComparison = function() private$.items[["clinicalComparison"]],
        consensusStats = function() private$.items[["consensusStats"]],
        reproducibilityStats = function() private$.items[["reproducibilityStats"]],
        supervisedSummary = function() private$.items[["supervisedSummary"]],
        supervisedResults = function() private$.items[["supervisedResults"]],
        ratioSummary = function() private$.items[["ratioSummary"]],
        ratioClassificationTable = function() private$.items[["ratioClassificationTable"]],
        markerImportance = function() private$.items[["markerImportance"]],
        clusterQuality = function() private$.items[["clusterQuality"]],
        refinementHistory = function() private$.items[["refinementHistory"]],
        markerPerformance = function() private$.items[["markerPerformance"]],
        optimalPanels = function() private$.items[["optimalPanels"]],
        outlierCases = function() private$.items[["outlierCases"]],
        silhouettePlot = function() private$.items[["silhouettePlot"]],
        heatmapPlot = function() private$.items[["heatmapPlot"]],
        dendrogramPlot = function() private$.items[["dendrogramPlot"]],
        pcaContributions = function() private$.items[["pcaContributions"]],
        pcaVariablePlot = function() private$.items[["pcaVariablePlot"]],
        pcaPlot = function() private$.items[["pcaPlot"]],
        boxplotPlot = function() private$.items[["boxplotPlot"]],
        markerCorrelationPlot = function() private$.items[["markerCorrelationPlot"]],
        survivalPlot = function() private$.items[["survivalPlot"]],
        medoidInfo = function() private$.items[["medoidInfo"]],
        interpretationGuide = function() private$.items[["interpretationGuide"]],
        technicalNotes = function() private$.items[["technicalNotes"]],
        executiveSummary = function() private$.items[["executiveSummary"]],
        spatialCompartmentSummary = function() private$.items[["spatialCompartmentSummary"]],
        spatialConcordance = function() private$.items[["spatialConcordance"]],
        spatialClusterComparison = function() private$.items[["spatialClusterComparison"]],
        spatialMarkerDifferences = function() private$.items[["spatialMarkerDifferences"]],
        spatialHeatmapPlot = function() private$.items[["spatialHeatmapPlot"]],
        sizes = function() private$.items[["sizes"]],
        distr = function() private$.items[["distr"]],
        assoc = function() private$.items[["assoc"]],
        text = function() private$.items[["text"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="IHC Clustering Analysis",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "proxy",
                    "cluster",
                    "FactoMineR",
                    "klaR",
                    "grDevices",
                    "factoextra",
                    "BiocManager",
                    "circlize",
                    "ComplexHeatmap",
                    "grid",
                    "survival",
                    "survminer",
                    "viridis",
                    "corrplot",
                    "pheatmap"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Instructions"))
            self$add(jmvcore::Html$new(
                options=options,
                name="binaryConversionNote",
                title="Binary Conversion Notice",
                visible=FALSE,
                refs=list(
                    "distanceMethod")))
            self$add(jmvcore::Html$new(
                options=options,
                name="summary",
                title="Analysis Summary",
                visible=TRUE,
                clearWith=list(
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "autoSelectK",
                    "kRange",
                    "scaleContVars",
                    "weights",
                    "handleMissing",
                    "consensusClustering",
                    "seed")))
            self$add(jmvcore::Table$new(
                options=options,
                name="clusterSizes",
                title="Cluster Sizes",
                visible=TRUE,
                clearWith=list(
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "autoSelectK",
                    "kRange",
                    "scaleContVars",
                    "weights",
                    "handleMissing",
                    "consensusClustering",
                    "seed"),
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="percent", 
                        `title`="Percentage", 
                        `type`="number", 
                        `format`="zto,pc"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="silhouetteStats",
                title="Silhouette Statistics",
                visible="(autoSelectK)",
                columns=list(
                    list(
                        `name`="k", 
                        `title`="k", 
                        `type`="integer"),
                    list(
                        `name`="avg_silhouette", 
                        `title`="Avg Silhouette", 
                        `type`="number"),
                    list(
                        `name`="selected", 
                        `title`="Selected", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="clusterProfiles",
                title="Cluster Profiles",
                visible="(clusterProfiles)",
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="summary", 
                        `title`="Summary", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="markerSummary",
                title="Marker Summary by Cluster",
                visible="(markerSummary)",
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="type", 
                        `title`="Type", 
                        `type`="text"),
                    list(
                        `name`="mean_median", 
                        `title`="Mean/Median", 
                        `type`="text"),
                    list(
                        `name`="sd_iqr", 
                        `title`="SD/IQR", 
                        `type`="text"),
                    list(
                        `name`="range", 
                        `title`="Range", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="associationTests",
                title="Marker-Cluster Associations",
                visible="(associationTests)",
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="p_adjusted", 
                        `title`="Adjusted p", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="effect_size", 
                        `title`="Effect Size", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="clinicalComparison",
                title="Clinical Variables by Cluster",
                visible="(clinicalVars)",
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="summary", 
                        `title`="Summary", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="consensusStats",
                title="Consensus Clustering Stability",
                visible="(consensusClustering)",
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="stability", 
                        `title`="Stability", 
                        `type`="number"),
                    list(
                        `name`="core_samples", 
                        `title`="Core Samples", 
                        `type`="integer"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="reproducibilityStats",
                title="Cluster Reproducibility (Random Split Validation)",
                visible="(reproducibilityTest)",
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="mean_kappa", 
                        `title`="Mean Cohen Kappa", 
                        `type`="number"),
                    list(
                        `name`="sd_kappa", 
                        `title`="SD Kappa", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"),
                    list(
                        `name`="n_splits", 
                        `title`="N Splits", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="supervisedSummary",
                title="Supervised Clustering Summary",
                visible="(supervisedClustering)",
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="n_cases", 
                        `title`="N Cases", 
                        `type`="integer"),
                    list(
                        `name`="n_clusters", 
                        `title`="N Clusters", 
                        `type`="integer"),
                    list(
                        `name`="avg_silhouette", 
                        `title`="Avg Silhouette", 
                        `type`="number"),
                    list(
                        `name`="status", 
                        `title`="Status", 
                        `type`="text"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="supervisedResults",
                title="Supervised Clustering Details",
                visible="(supervisedClustering)",
                refs=list(
                    "supervisedVariable")))
            self$add(jmvcore::Table$new(
                options=options,
                name="ratioSummary",
                title="Marker Ratio Summary",
                visible="(calculateRatios)",
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto")),
                refs=list(
                    "ratioNumerator",
                    "ratioDenominator",
                    "ratioName")))
            self$add(jmvcore::Table$new(
                options=options,
                name="ratioClassificationTable",
                title="Ratio Classification",
                visible="(calculateRatios && ratioClassification)",
                columns=list(
                    list(
                        `name`="category", 
                        `title`="Category", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N Cases", 
                        `type`="integer"),
                    list(
                        `name`="percent", 
                        `title`="Percent", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="range", 
                        `title`="Range", 
                        `type`="text")),
                refs=list(
                    "ratioLowCutoff",
                    "ratioHighCutoff")))
            self$add(jmvcore::Table$new(
                options=options,
                name="markerImportance",
                title="Marker Importance for Clustering",
                visible="(markerOptimization)",
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="importance", 
                        `title`="Importance Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="rank", 
                        `title`="Rank", 
                        `type`="integer"),
                    list(
                        `name`="correlation_max", 
                        `title`="Max Correlation", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="redundant_with", 
                        `title`="Redundant With", 
                        `type`="text"),
                    list(
                        `name`="recommendation", 
                        `title`="Recommendation", 
                        `type`="text")),
                clearWith=list(
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "autoSelectK")))
            self$add(jmvcore::Table$new(
                options=options,
                name="clusterQuality",
                title="Cluster Quality and Predictive Values",
                visible="(clusterQualityMetrics)",
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="size", 
                        `title`="Size", 
                        `type`="integer"),
                    list(
                        `name`="purity", 
                        `title`="Purity", 
                        `type`="number", 
                        `format`="zto,pc"),
                    list(
                        `name`="avg_silhouette", 
                        `title`="Avg Silhouette", 
                        `type`="number"),
                    list(
                        `name`="separation", 
                        `title`="Separation Index", 
                        `type`="number"),
                    list(
                        `name`="compactness", 
                        `title`="Compactness", 
                        `type`="number"),
                    list(
                        `name`="quality", 
                        `title`="Quality Rating", 
                        `type`="text")),
                clearWith=list(
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "autoSelectK")))
            self$add(jmvcore::Table$new(
                options=options,
                name="refinementHistory",
                title="Iterative Refinement History",
                visible="(iterativeRefinement)",
                columns=list(
                    list(
                        `name`="iteration", 
                        `title`="Iteration", 
                        `type`="integer"),
                    list(
                        `name`="n_markers", 
                        `title`="N Markers", 
                        `type`="integer"),
                    list(
                        `name`="markers_used", 
                        `title`="Markers Used", 
                        `type`="text"),
                    list(
                        `name`="silhouette", 
                        `title`="Avg Silhouette", 
                        `type`="number"),
                    list(
                        `name`="improvement", 
                        `title`="Improvement", 
                        `type`="text")),
                clearWith=list(
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "autoSelectK")))
            self$add(jmvcore::Table$new(
                options=options,
                name="markerPerformance",
                title="Marker Diagnostic Performance",
                visible="(calculateDiagnosticMetrics && knownDiagnosis)",
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="diagnosis", 
                        `title`="Diagnosis", 
                        `type`="text"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity", 
                        `type`="number", 
                        `format`="zto,pc"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity", 
                        `type`="number", 
                        `format`="zto,pc"),
                    list(
                        `name`="ppv", 
                        `title`="PPV", 
                        `type`="number", 
                        `format`="zto,pc"),
                    list(
                        `name`="npv", 
                        `title`="NPV", 
                        `type`="number", 
                        `format`="zto,pc"),
                    list(
                        `name`="accuracy", 
                        `title`="Accuracy", 
                        `type`="number", 
                        `format`="zto,pc")),
                clearWith=list(
                    "catVars",
                    "contVars",
                    "knownDiagnosis")))
            self$add(jmvcore::Table$new(
                options=options,
                name="optimalPanels",
                title="Optimal Antibody Panel Recommendations",
                visible="(identifyOptimalPanel && knownDiagnosis)",
                columns=list(
                    list(
                        `name`="rank", 
                        `title`="Rank", 
                        `type`="integer"),
                    list(
                        `name`="panel", 
                        `title`="Marker Panel", 
                        `type`="text"),
                    list(
                        `name`="target_diagnosis", 
                        `title`="Target Diagnosis", 
                        `type`="text"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity", 
                        `type`="number", 
                        `format`="zto,pc"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity", 
                        `type`="number", 
                        `format`="zto,pc"),
                    list(
                        `name`="ppv", 
                        `title`="PPV", 
                        `type`="number", 
                        `format`="zto,pc"),
                    list(
                        `name`="performance_score", 
                        `title`="Performance Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="recommendation", 
                        `title`="Recommendation", 
                        `type`="text")),
                clearWith=list(
                    "catVars",
                    "contVars",
                    "knownDiagnosis",
                    "panelSize")))
            self$add(jmvcore::Table$new(
                options=options,
                name="outlierCases",
                title="Cases with Atypical Immunoprofiles",
                visible="(flagOutliers)",
                columns=list(
                    list(
                        `name`="case_id", 
                        `title`="Case ID", 
                        `type`="text"),
                    list(
                        `name`="assigned_cluster", 
                        `title`="Assigned Cluster", 
                        `type`="text"),
                    list(
                        `name`="silhouette", 
                        `title`="Silhouette Score", 
                        `type`="number"),
                    list(
                        `name`="distance_to_center", 
                        `title`="Distance to Center", 
                        `type`="number"),
                    list(
                        `name`="nearest_alternative", 
                        `title`="Nearest Alternative Cluster", 
                        `type`="text"),
                    list(
                        `name`="quality_flag", 
                        `title`="Quality Flag", 
                        `type`="text"),
                    list(
                        `name`="recommendation", 
                        `title`="Recommendation", 
                        `type`="text")),
                clearWith=list(
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "autoSelectK",
                    "outlierThreshold")))
            self$add(jmvcore::Image$new(
                options=options,
                name="silhouettePlot",
                title="Silhouette Plot",
                width=700,
                height=500,
                renderFun=".plotSilhouette",
                visible="(showSilhouette)",
                clearWith=list(
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "autoSelectK",
                    "colorPalette",
                    "fontSize",
                    "plotContrast")))
            self$add(jmvcore::Image$new(
                options=options,
                name="heatmapPlot",
                title="Expression Heatmap",
                width=900,
                height=700,
                renderFun=".plotHeatmap",
                visible="(showHeatmap)",
                clearWith=list(
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "heatmapScale",
                    "autoSelectK",
                    "colorPalette",
                    "fontSize",
                    "plotContrast")))
            self$add(jmvcore::Image$new(
                options=options,
                name="dendrogramPlot",
                title="Dendrogram",
                width=800,
                height=600,
                renderFun=".plotDendrogram",
                visible="(showDendrogram && method:hierarchical)",
                clearWith=list(
                    "catVars",
                    "contVars",
                    "nClusters",
                    "autoSelectK",
                    "colorPalette",
                    "fontSize",
                    "plotContrast")))
            self$add(jmvcore::Table$new(
                options=options,
                name="pcaContributions",
                title="PCA/MCA Contributions",
                visible="(showPCAPlot)",
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="contribution", 
                        `title`="Contribution", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue")),
                clearWith=list(
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "autoSelectK")))
            self$add(jmvcore::Image$new(
                options=options,
                name="pcaVariablePlot",
                title="PCA/MCA Variable Factor Map (Correlation Circle)",
                width=700,
                height=600,
                renderFun=".plotPCAVariables",
                visible="(showPCAPlot)",
                clearWith=list(
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "autoSelectK",
                    "colorPalette",
                    "fontSize",
                    "plotContrast")))
            self$add(jmvcore::Image$new(
                options=options,
                name="pcaPlot",
                title="PCA/MCA Individual Factor Map",
                width=700,
                height=600,
                renderFun=".plotPCA",
                visible="(showPCAPlot)",
                clearWith=list(
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "autoSelectK",
                    "colorPalette",
                    "fontSize",
                    "plotContrast")))
            self$add(jmvcore::Image$new(
                options=options,
                name="boxplotPlot",
                title="Marker Distributions by Cluster",
                width=900,
                height=600,
                renderFun=".plotBoxplots",
                visible="(showBoxplots)",
                clearWith=list(
                    "contVars",
                    "nClusters",
                    "autoSelectK",
                    "colorPalette",
                    "fontSize",
                    "plotContrast")))
            self$add(jmvcore::Image$new(
                options=options,
                name="markerCorrelationPlot",
                title="Marker Correlation Matrix",
                width=800,
                height=700,
                renderFun=".plotMarkerCorrelation",
                visible="(showMarkerCorrelation)",
                clearWith=list(
                    "catVars",
                    "contVars",
                    "colorPalette",
                    "fontSize",
                    "plotContrast")))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlot",
                title="Survival Analysis by Cluster",
                width=700,
                height=600,
                renderFun=".plotSurvival",
                visible=FALSE,
                clearWith=list(
                    "survivalTime",
                    "survivalEvent",
                    "nClusters",
                    "autoSelectK",
                    "colorPalette",
                    "fontSize",
                    "plotContrast")))
            self$add(jmvcore::Table$new(
                options=options,
                name="medoidInfo",
                title="Cluster Medoids (Representative Cases)",
                visible="(method:pam)",
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="medoid_id", 
                        `title`="Medoid Case ID", 
                        `type`="text"),
                    list(
                        `name`="description", 
                        `title`="Profile Description", 
                        `type`="text"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretationGuide",
                title="Clinical Interpretation",
                visible="(showInterpretation)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="technicalNotes",
                title="Technical Notes",
                visible="(showTechnicalNotes)"))
            self$add(jmvcore::Preformatted$new(
                options=options,
                name="executiveSummary",
                title="Executive Summary (Copy-Ready)",
                visible=TRUE,
                clearWith=list(
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "autoSelectK")))
            self$add(jmvcore::Table$new(
                options=options,
                name="spatialCompartmentSummary",
                title="Spatial Compartment Summary",
                visible="(performSpatialAnalysis)",
                columns=list(
                    list(
                        `name`="compartment", 
                        `title`="Compartment", 
                        `type`="text"),
                    list(
                        `name`="n_cases", 
                        `title`="N Cases", 
                        `type`="integer"),
                    list(
                        `name`="n_clusters", 
                        `title`="N Clusters", 
                        `type`="integer"),
                    list(
                        `name`="avg_silhouette", 
                        `title`="Avg Silhouette", 
                        `type`="number"),
                    list(
                        `name`="quality", 
                        `title`="Quality", 
                        `type`="text")),
                clearWith=list(
                    "spatialCompartment",
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters")))
            self$add(jmvcore::Table$new(
                options=options,
                name="spatialConcordance",
                title="Inter-Compartment Cluster Concordance",
                visible="(performSpatialAnalysis && spatialComparisonMode:between || spatialComparisonMode:both)",
                columns=list(
                    list(
                        `name`="compartment1", 
                        `title`="Compartment 1", 
                        `type`="text"),
                    list(
                        `name`="compartment2", 
                        `title`="Compartment 2", 
                        `type`="text"),
                    list(
                        `name`="concordance", 
                        `title`="Concordance", 
                        `type`="number", 
                        `format`="zto,pc"),
                    list(
                        `name`="kappa", 
                        `title`="Cohen's Kappa", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text")),
                clearWith=list(
                    "spatialCompartment",
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters")))
            self$add(jmvcore::Table$new(
                options=options,
                name="spatialClusterComparison",
                title="Cluster Distribution by Compartment",
                visible="(performSpatialAnalysis)",
                columns=list(
                    list(
                        `name`="compartment", 
                        `title`="Compartment", 
                        `type`="text"),
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="percent", 
                        `title`="Percentage", 
                        `type`="number", 
                        `format`="zto,pc")),
                clearWith=list(
                    "spatialCompartment",
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters")))
            self$add(jmvcore::Table$new(
                options=options,
                name="spatialMarkerDifferences",
                title="Marker Expression Differences by Compartment",
                visible="(performSpatialAnalysis)",
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="compartment1", 
                        `title`="Compartment 1", 
                        `type`="text"),
                    list(
                        `name`="compartment2", 
                        `title`="Compartment 2", 
                        `type`="text"),
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="effect_size", 
                        `title`="Effect Size", 
                        `type`="text")),
                clearWith=list(
                    "spatialCompartment",
                    "catVars",
                    "contVars")))
            self$add(jmvcore::Image$new(
                options=options,
                name="spatialHeatmapPlot",
                title="Spatial Compartment Heatmap",
                width=1000,
                height=700,
                renderFun=".plotSpatialHeatmap",
                visible="(performSpatialAnalysis && showHeatmap)",
                clearWith=list(
                    "spatialCompartment",
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "heatmapScale",
                    "colorPalette",
                    "fontSize",
                    "plotContrast")))
            self$add(jmvcore::Table$new(
                options=options,
                name="sizes",
                title="Cluster Sizes (Legacy)",
                visible=FALSE,
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="distr",
                title="Distributions (Legacy)",
                visible=FALSE,
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="level", 
                        `title`="Level", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="pct", 
                        `title`="Percentage", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="assoc",
                title="Association Tests (Legacy)",
                visible=FALSE,
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="p", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Preformatted$new(
                options=options,
                name="text",
                title="Analysis Notes (Legacy)",
                visible=FALSE))}))

ihcclusterBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcclusterBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "ihccluster",
                version = c(2,0,0),
                options = options,
                results = ihcclusterResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' IHC Clustering Analysis
#'
#' Clusters cases based on immunohistochemistry (IHC) staining patterns.
#' 
#' **Variable Types:**
#' - Categorical: pos/neg, intensity levels (0/1/2/3), ordinal scales
#' - Continuous: H-scores (0-300), \% positivity (0-100), expression levels
#' - Mixed: Any combination of categorical and continuous markers
#' 
#' Uses Gower distance to handle mixed data types appropriately.
#' 
#' @param data The data as a data frame.
#' @param catVars Binary (pos/neg) or ordinal (0/1/2/3) stain results
#' @param contVars H-scores (0-300), \% positivity (0-100), or other
#'   continuous measures
#' @param caseId Case identifier for tracking
#' @param spatialCompartment Groups cases by spatial location (e.g.,
#'   Central/Invasive, Preinvasive/Invasive, Primary/Metastatic)
#' @param performSpatialAnalysis Compare clustering patterns across spatial
#'   compartments
#' @param spatialComparisonMode How to analyze spatial compartments
#' @param method Clustering algorithm to use
#' @param distanceMethod Distance metric for clustering
#' @param linkageMethod Hierarchical clustering linkage method
#' @param nClusters Leave blank for automatic selection using silhouette
#' @param autoSelectK Use silhouette width to find optimal number of clusters
#' @param kRange Range to test when auto-selecting k
#' @param scaleContVars Z-score continuous markers before clustering
#' @param weights Comma-separated weights for markers (e.g., "1,1,2,1" for 4
#'   markers)
#' @param handleMissing How to handle missing values
#' @param consensusClustering Use bootstrap resampling for stable clusters
#' @param nBootstrap Number of bootstrap samples for consensus
#' @param seed For reproducibility
#' @param showSilhouette Show silhouette width plot for cluster quality
#' @param showHeatmap Show clustered heatmap of IHC expression
#' @param heatmapScale How to scale heatmap values
#' @param showDendrogram Show dendrogram for hierarchical clustering
#' @param showPCAPlot Show dimension reduction plot with clusters
#' @param showBoxplots Show boxplots of continuous markers by cluster
#' @param markerSummary Summary statistics for each marker by cluster
#' @param clusterProfiles Characteristic features of each cluster
#' @param associationTests Test marker-cluster associations
#' @param multipleTestingCorrection Correction method for marker association
#'   tests
#' @param markerOptimization Analyze marker importance and identify optimal
#'   panel
#' @param showMarkerCorrelation Display correlation structure between markers
#' @param clusterQualityMetrics Calculate PPV, purity, and cluster quality
#'   measures
#' @param iterativeRefinement Perform iterative clustering with marker
#'   selection (advanced)
#' @param refinementIterations Number of iterative refinement cycles
#' @param reproducibilityTest Random split validation with Cohen kappa
#'   (Sterlacci 2019)
#' @param nSplits Number of random splits for reproducibility testing
#' @param supervisedClustering Cluster within each known diagnosis group
#'   separately
#' @param supervisedVariable Variable defining groups (e.g., histotype,
#'   diagnosis)
#' @param calculateRatios Calculate ratios between continuous markers (e.g.,
#'   CD4/CD8 ratio)
#' @param ratioNumerator Numerator marker for ratio calculation
#' @param ratioDenominator Denominator marker for ratio calculation
#' @param ratioName Name for the computed ratio variable
#' @param ratioClassification Classify ratio as Low/Intermediate/High using
#'   cutoffs
#' @param ratioLowCutoff Values ≤ this are classified as Low
#' @param ratioHighCutoff Values ≥ this are classified as High
#' @param exportClusters Save cluster assignments to dataset
#' @param knownDiagnosis Known diagnoses for calculating marker performance
#'   metrics (sensitivity, specificity, PPV, NPV)
#' @param calculateDiagnosticMetrics Compute sensitivity, specificity, PPV,
#'   NPV for each marker when diagnosis is known
#' @param identifyOptimalPanel Find minimal marker combinations with maximum
#'   diagnostic discrimination
#' @param panelSize Size of antibody panel combinations to evaluate
#' @param flagOutliers Identify cases with ambiguous/atypical immunoprofiles
#'   based on silhouette scores
#' @param outlierThreshold Silhouette score threshold below which cases are
#'   flagged as outliers
#' @param clinicalVars Clinical variables to compare across clusters
#' @param survivalTime Time variable for survival analysis
#' @param survivalEvent Event variable for survival analysis
#' @param colorPalette Color palette for plots (colorblind-safe options
#'   available)
#' @param fontSize Base font size for all text elements
#' @param plotContrast Enable high contrast mode for better visibility
#' @param showInterpretation Display clinical interpretation guide
#' @param showTechnicalNotes Display technical notes about the analysis
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$binaryConversionNote} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$clusterSizes} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$silhouetteStats} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clusterProfiles} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$markerSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$associationTests} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clinicalComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$consensusStats} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$reproducibilityStats} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$supervisedSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$supervisedResults} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$ratioSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$ratioClassificationTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$markerImportance} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clusterQuality} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$refinementHistory} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$markerPerformance} \tab \tab \tab \tab \tab Sensitivity, specificity, PPV, NPV for each marker by diagnosis \cr
#'   \code{results$optimalPanels} \tab \tab \tab \tab \tab Ranked marker combinations for differential diagnosis \cr
#'   \code{results$outlierCases} \tab \tab \tab \tab \tab Cases with ambiguous cluster assignment or low silhouette scores \cr
#'   \code{results$silhouettePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$heatmapPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$dendrogramPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$pcaContributions} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$pcaVariablePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$pcaPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$boxplotPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$markerCorrelationPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$survivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$medoidInfo} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$interpretationGuide} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$technicalNotes} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$executiveSummary} \tab \tab \tab \tab \tab a preformatted \cr
#'   \code{results$spatialCompartmentSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$spatialConcordance} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$spatialClusterComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$spatialMarkerDifferences} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$spatialHeatmapPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$sizes} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$distr} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$assoc} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$text} \tab \tab \tab \tab \tab a preformatted \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$clusterSizes$asDF}
#'
#' \code{as.data.frame(results$clusterSizes)}
#'
#' @export
ihccluster <- function(
    data,
    catVars = NULL,
    contVars = NULL,
    caseId = NULL,
    spatialCompartment = NULL,
    performSpatialAnalysis = FALSE,
    spatialComparisonMode = "both",
    method = "pam",
    distanceMethod = "gower",
    linkageMethod = "ward",
    nClusters = 3,
    autoSelectK = TRUE,
    kRange = "medium",
    scaleContVars = TRUE,
    weights = "",
    handleMissing = "pairwise",
    consensusClustering = FALSE,
    nBootstrap = 100,
    seed = 42,
    showSilhouette = TRUE,
    showHeatmap = TRUE,
    heatmapScale = "row",
    showDendrogram = TRUE,
    showPCAPlot = TRUE,
    showBoxplots = TRUE,
    markerSummary = TRUE,
    clusterProfiles = TRUE,
    associationTests = TRUE,
    multipleTestingCorrection = "bonferroni",
    markerOptimization = FALSE,
    showMarkerCorrelation = FALSE,
    clusterQualityMetrics = TRUE,
    iterativeRefinement = FALSE,
    refinementIterations = 3,
    reproducibilityTest = FALSE,
    nSplits = 10,
    supervisedClustering = FALSE,
    supervisedVariable = NULL,
    calculateRatios = FALSE,
    ratioNumerator = NULL,
    ratioDenominator = NULL,
    ratioName = "Marker_Ratio",
    ratioClassification = FALSE,
    ratioLowCutoff = 1,
    ratioHighCutoff = 2,
    exportClusters = FALSE,
    knownDiagnosis = NULL,
    calculateDiagnosticMetrics = FALSE,
    identifyOptimalPanel = FALSE,
    panelSize = "pairs",
    flagOutliers = TRUE,
    outlierThreshold = 0.25,
    clinicalVars = NULL,
    survivalTime = NULL,
    survivalEvent = NULL,
    colorPalette = "default",
    fontSize = "medium",
    plotContrast = FALSE,
    showInterpretation = FALSE,
    showTechnicalNotes = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("ihccluster requires jmvcore to be installed (restart may be required)")

    if ( ! missing(catVars)) catVars <- jmvcore::resolveQuo(jmvcore::enquo(catVars))
    if ( ! missing(contVars)) contVars <- jmvcore::resolveQuo(jmvcore::enquo(contVars))
    if ( ! missing(caseId)) caseId <- jmvcore::resolveQuo(jmvcore::enquo(caseId))
    if ( ! missing(spatialCompartment)) spatialCompartment <- jmvcore::resolveQuo(jmvcore::enquo(spatialCompartment))
    if ( ! missing(supervisedVariable)) supervisedVariable <- jmvcore::resolveQuo(jmvcore::enquo(supervisedVariable))
    if ( ! missing(ratioNumerator)) ratioNumerator <- jmvcore::resolveQuo(jmvcore::enquo(ratioNumerator))
    if ( ! missing(ratioDenominator)) ratioDenominator <- jmvcore::resolveQuo(jmvcore::enquo(ratioDenominator))
    if ( ! missing(knownDiagnosis)) knownDiagnosis <- jmvcore::resolveQuo(jmvcore::enquo(knownDiagnosis))
    if ( ! missing(clinicalVars)) clinicalVars <- jmvcore::resolveQuo(jmvcore::enquo(clinicalVars))
    if ( ! missing(survivalTime)) survivalTime <- jmvcore::resolveQuo(jmvcore::enquo(survivalTime))
    if ( ! missing(survivalEvent)) survivalEvent <- jmvcore::resolveQuo(jmvcore::enquo(survivalEvent))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(catVars), catVars, NULL),
            `if`( ! missing(contVars), contVars, NULL),
            `if`( ! missing(caseId), caseId, NULL),
            `if`( ! missing(spatialCompartment), spatialCompartment, NULL),
            `if`( ! missing(supervisedVariable), supervisedVariable, NULL),
            `if`( ! missing(ratioNumerator), ratioNumerator, NULL),
            `if`( ! missing(ratioDenominator), ratioDenominator, NULL),
            `if`( ! missing(knownDiagnosis), knownDiagnosis, NULL),
            `if`( ! missing(clinicalVars), clinicalVars, NULL),
            `if`( ! missing(survivalTime), survivalTime, NULL),
            `if`( ! missing(survivalEvent), survivalEvent, NULL))

    for (v in catVars) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in spatialCompartment) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in supervisedVariable) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in knownDiagnosis) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- ihcclusterOptions$new(
        catVars = catVars,
        contVars = contVars,
        caseId = caseId,
        spatialCompartment = spatialCompartment,
        performSpatialAnalysis = performSpatialAnalysis,
        spatialComparisonMode = spatialComparisonMode,
        method = method,
        distanceMethod = distanceMethod,
        linkageMethod = linkageMethod,
        nClusters = nClusters,
        autoSelectK = autoSelectK,
        kRange = kRange,
        scaleContVars = scaleContVars,
        weights = weights,
        handleMissing = handleMissing,
        consensusClustering = consensusClustering,
        nBootstrap = nBootstrap,
        seed = seed,
        showSilhouette = showSilhouette,
        showHeatmap = showHeatmap,
        heatmapScale = heatmapScale,
        showDendrogram = showDendrogram,
        showPCAPlot = showPCAPlot,
        showBoxplots = showBoxplots,
        markerSummary = markerSummary,
        clusterProfiles = clusterProfiles,
        associationTests = associationTests,
        multipleTestingCorrection = multipleTestingCorrection,
        markerOptimization = markerOptimization,
        showMarkerCorrelation = showMarkerCorrelation,
        clusterQualityMetrics = clusterQualityMetrics,
        iterativeRefinement = iterativeRefinement,
        refinementIterations = refinementIterations,
        reproducibilityTest = reproducibilityTest,
        nSplits = nSplits,
        supervisedClustering = supervisedClustering,
        supervisedVariable = supervisedVariable,
        calculateRatios = calculateRatios,
        ratioNumerator = ratioNumerator,
        ratioDenominator = ratioDenominator,
        ratioName = ratioName,
        ratioClassification = ratioClassification,
        ratioLowCutoff = ratioLowCutoff,
        ratioHighCutoff = ratioHighCutoff,
        exportClusters = exportClusters,
        knownDiagnosis = knownDiagnosis,
        calculateDiagnosticMetrics = calculateDiagnosticMetrics,
        identifyOptimalPanel = identifyOptimalPanel,
        panelSize = panelSize,
        flagOutliers = flagOutliers,
        outlierThreshold = outlierThreshold,
        clinicalVars = clinicalVars,
        survivalTime = survivalTime,
        survivalEvent = survivalEvent,
        colorPalette = colorPalette,
        fontSize = fontSize,
        plotContrast = plotContrast,
        showInterpretation = showInterpretation,
        showTechnicalNotes = showTechnicalNotes)

    analysis <- ihcclusterClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

