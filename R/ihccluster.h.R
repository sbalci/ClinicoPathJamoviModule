
# This file is automatically generated, you probably don't want to edit this

ihcclusterOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcclusterOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            catVars = NULL,
            contVars = NULL,
            caseId = NULL,
            method = "pam",
            nClusters = 3,
            autoSelectK = TRUE,
            kRange = "medium",
            scaleContVars = TRUE,
            weights = "",
            handleMissing = "pairwise",
            consensusClustering = FALSE,
            nBootstrap = 100,
            seed = 42,
            showSilhouette = TRUE,
            showHeatmap = TRUE,
            heatmapScale = "row",
            showDendrogram = TRUE,
            showPCAPlot = TRUE,
            showBoxplots = TRUE,
            markerSummary = TRUE,
            clusterProfiles = TRUE,
            associationTests = TRUE,
            exportClusters = FALSE,
            clinicalVars = NULL,
            survivalTime = NULL,
            survivalEvent = NULL,
            colorPalette = "default",
            fontSize = "medium",
            plotContrast = FALSE,
            tumorPreset = "none",
            applyPreset = FALSE,
            language = "english", ...) {

            super$initialize(
                package="ClinicoPath",
                name="ihccluster",
                requiresData=TRUE,
                ...)

            private$..catVars <- jmvcore::OptionVariables$new(
                "catVars",
                catVars,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..contVars <- jmvcore::OptionVariables$new(
                "contVars",
                contVars,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..caseId <- jmvcore::OptionVariable$new(
                "caseId",
                caseId,
                suggested=list(
                    "nominal",
                    "id"),
                permitted=list(
                    "factor",
                    "id"))
            private$..method <- jmvcore::OptionList$new(
                "method",
                method,
                options=list(
                    "pam",
                    "hierarchical",
                    "dimreduce"),
                default="pam")
            private$..nClusters <- jmvcore::OptionInteger$new(
                "nClusters",
                nClusters,
                min=2,
                max=15,
                default=3)
            private$..autoSelectK <- jmvcore::OptionBool$new(
                "autoSelectK",
                autoSelectK,
                default=TRUE)
            private$..kRange <- jmvcore::OptionList$new(
                "kRange",
                kRange,
                options=list(
                    "small",
                    "medium",
                    "large"),
                default="medium")
            private$..scaleContVars <- jmvcore::OptionBool$new(
                "scaleContVars",
                scaleContVars,
                default=TRUE)
            private$..weights <- jmvcore::OptionString$new(
                "weights",
                weights,
                default="")
            private$..handleMissing <- jmvcore::OptionList$new(
                "handleMissing",
                handleMissing,
                options=list(
                    "complete",
                    "pairwise"),
                default="pairwise")
            private$..consensusClustering <- jmvcore::OptionBool$new(
                "consensusClustering",
                consensusClustering,
                default=FALSE)
            private$..nBootstrap <- jmvcore::OptionInteger$new(
                "nBootstrap",
                nBootstrap,
                min=50,
                max=1000,
                default=100)
            private$..seed <- jmvcore::OptionInteger$new(
                "seed",
                seed,
                default=42)
            private$..showSilhouette <- jmvcore::OptionBool$new(
                "showSilhouette",
                showSilhouette,
                default=TRUE)
            private$..showHeatmap <- jmvcore::OptionBool$new(
                "showHeatmap",
                showHeatmap,
                default=TRUE)
            private$..heatmapScale <- jmvcore::OptionList$new(
                "heatmapScale",
                heatmapScale,
                options=list(
                    "row",
                    "column",
                    "none"),
                default="row")
            private$..showDendrogram <- jmvcore::OptionBool$new(
                "showDendrogram",
                showDendrogram,
                default=TRUE)
            private$..showPCAPlot <- jmvcore::OptionBool$new(
                "showPCAPlot",
                showPCAPlot,
                default=TRUE)
            private$..showBoxplots <- jmvcore::OptionBool$new(
                "showBoxplots",
                showBoxplots,
                default=TRUE)
            private$..markerSummary <- jmvcore::OptionBool$new(
                "markerSummary",
                markerSummary,
                default=TRUE)
            private$..clusterProfiles <- jmvcore::OptionBool$new(
                "clusterProfiles",
                clusterProfiles,
                default=TRUE)
            private$..associationTests <- jmvcore::OptionBool$new(
                "associationTests",
                associationTests,
                default=TRUE)
            private$..exportClusters <- jmvcore::OptionBool$new(
                "exportClusters",
                exportClusters,
                default=FALSE)
            private$..clinicalVars <- jmvcore::OptionVariables$new(
                "clinicalVars",
                clinicalVars,
                suggested=list(
                    "nominal",
                    "ordinal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..survivalTime <- jmvcore::OptionVariable$new(
                "survivalTime",
                survivalTime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..survivalEvent <- jmvcore::OptionVariable$new(
                "survivalEvent",
                survivalEvent,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..colorPalette <- jmvcore::OptionList$new(
                "colorPalette",
                colorPalette,
                options=list(
                    "default",
                    "colorblind",
                    "viridis",
                    "high_contrast"),
                default="default")
            private$..fontSize <- jmvcore::OptionList$new(
                "fontSize",
                fontSize,
                options=list(
                    "small",
                    "medium",
                    "large",
                    "extra_large"),
                default="medium")
            private$..plotContrast <- jmvcore::OptionBool$new(
                "plotContrast",
                plotContrast,
                default=FALSE)
            private$..tumorPreset <- jmvcore::OptionList$new(
                "tumorPreset",
                tumorPreset,
                options=list(
                    "none",
                    "breast_luminal",
                    "breast_triple_negative",
                    "lung_nsclc",
                    "prostate_standard",
                    "colon_standard",
                    "melanoma_immune",
                    "lymphoma_panel"),
                default="none")
            private$..applyPreset <- jmvcore::OptionBool$new(
                "applyPreset",
                applyPreset,
                default=FALSE)
            private$..language <- jmvcore::OptionList$new(
                "language",
                language,
                options=list(
                    "english",
                    "turkish"),
                default="english")

            self$.addOption(private$..catVars)
            self$.addOption(private$..contVars)
            self$.addOption(private$..caseId)
            self$.addOption(private$..method)
            self$.addOption(private$..nClusters)
            self$.addOption(private$..autoSelectK)
            self$.addOption(private$..kRange)
            self$.addOption(private$..scaleContVars)
            self$.addOption(private$..weights)
            self$.addOption(private$..handleMissing)
            self$.addOption(private$..consensusClustering)
            self$.addOption(private$..nBootstrap)
            self$.addOption(private$..seed)
            self$.addOption(private$..showSilhouette)
            self$.addOption(private$..showHeatmap)
            self$.addOption(private$..heatmapScale)
            self$.addOption(private$..showDendrogram)
            self$.addOption(private$..showPCAPlot)
            self$.addOption(private$..showBoxplots)
            self$.addOption(private$..markerSummary)
            self$.addOption(private$..clusterProfiles)
            self$.addOption(private$..associationTests)
            self$.addOption(private$..exportClusters)
            self$.addOption(private$..clinicalVars)
            self$.addOption(private$..survivalTime)
            self$.addOption(private$..survivalEvent)
            self$.addOption(private$..colorPalette)
            self$.addOption(private$..fontSize)
            self$.addOption(private$..plotContrast)
            self$.addOption(private$..tumorPreset)
            self$.addOption(private$..applyPreset)
            self$.addOption(private$..language)
        }),
    active = list(
        catVars = function() private$..catVars$value,
        contVars = function() private$..contVars$value,
        caseId = function() private$..caseId$value,
        method = function() private$..method$value,
        nClusters = function() private$..nClusters$value,
        autoSelectK = function() private$..autoSelectK$value,
        kRange = function() private$..kRange$value,
        scaleContVars = function() private$..scaleContVars$value,
        weights = function() private$..weights$value,
        handleMissing = function() private$..handleMissing$value,
        consensusClustering = function() private$..consensusClustering$value,
        nBootstrap = function() private$..nBootstrap$value,
        seed = function() private$..seed$value,
        showSilhouette = function() private$..showSilhouette$value,
        showHeatmap = function() private$..showHeatmap$value,
        heatmapScale = function() private$..heatmapScale$value,
        showDendrogram = function() private$..showDendrogram$value,
        showPCAPlot = function() private$..showPCAPlot$value,
        showBoxplots = function() private$..showBoxplots$value,
        markerSummary = function() private$..markerSummary$value,
        clusterProfiles = function() private$..clusterProfiles$value,
        associationTests = function() private$..associationTests$value,
        exportClusters = function() private$..exportClusters$value,
        clinicalVars = function() private$..clinicalVars$value,
        survivalTime = function() private$..survivalTime$value,
        survivalEvent = function() private$..survivalEvent$value,
        colorPalette = function() private$..colorPalette$value,
        fontSize = function() private$..fontSize$value,
        plotContrast = function() private$..plotContrast$value,
        tumorPreset = function() private$..tumorPreset$value,
        applyPreset = function() private$..applyPreset$value,
        language = function() private$..language$value),
    private = list(
        ..catVars = NA,
        ..contVars = NA,
        ..caseId = NA,
        ..method = NA,
        ..nClusters = NA,
        ..autoSelectK = NA,
        ..kRange = NA,
        ..scaleContVars = NA,
        ..weights = NA,
        ..handleMissing = NA,
        ..consensusClustering = NA,
        ..nBootstrap = NA,
        ..seed = NA,
        ..showSilhouette = NA,
        ..showHeatmap = NA,
        ..heatmapScale = NA,
        ..showDendrogram = NA,
        ..showPCAPlot = NA,
        ..showBoxplots = NA,
        ..markerSummary = NA,
        ..clusterProfiles = NA,
        ..associationTests = NA,
        ..exportClusters = NA,
        ..clinicalVars = NA,
        ..survivalTime = NA,
        ..survivalEvent = NA,
        ..colorPalette = NA,
        ..fontSize = NA,
        ..plotContrast = NA,
        ..tumorPreset = NA,
        ..applyPreset = NA,
        ..language = NA)
)

ihcclusterResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcclusterResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        summary = function() private$.items[["summary"]],
        clusterSizes = function() private$.items[["clusterSizes"]],
        silhouetteStats = function() private$.items[["silhouetteStats"]],
        clusterProfiles = function() private$.items[["clusterProfiles"]],
        markerSummary = function() private$.items[["markerSummary"]],
        associationTests = function() private$.items[["associationTests"]],
        clinicalComparison = function() private$.items[["clinicalComparison"]],
        consensusStats = function() private$.items[["consensusStats"]],
        silhouettePlot = function() private$.items[["silhouettePlot"]],
        heatmapPlot = function() private$.items[["heatmapPlot"]],
        dendrogramPlot = function() private$.items[["dendrogramPlot"]],
        pcaPlot = function() private$.items[["pcaPlot"]],
        boxplotPlot = function() private$.items[["boxplotPlot"]],
        survivalPlot = function() private$.items[["survivalPlot"]],
        medoidInfo = function() private$.items[["medoidInfo"]],
        interpretationGuide = function() private$.items[["interpretationGuide"]],
        technicalNotes = function() private$.items[["technicalNotes"]],
        executiveSummary = function() private$.items[["executiveSummary"]],
        sizes = function() private$.items[["sizes"]],
        modes = function() private$.items[["modes"]],
        distr = function() private$.items[["distr"]],
        assoc = function() private$.items[["assoc"]],
        text = function() private$.items[["text"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="IHC Clustering Analysis",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Instructions",
                clearWith=list(
                    "catVars",
                    "contVars")))
            self$add(jmvcore::Html$new(
                options=options,
                name="summary",
                title="Analysis Summary",
                visible=TRUE,
                clearWith=list(
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "autoSelectK",
                    "kRange",
                    "scaleContVars",
                    "weights",
                    "handleMissing",
                    "consensusClustering",
                    "seed")))
            self$add(jmvcore::Table$new(
                options=options,
                name="clusterSizes",
                title="Cluster Sizes",
                visible=TRUE,
                clearWith=list(
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "autoSelectK",
                    "kRange",
                    "scaleContVars",
                    "weights",
                    "handleMissing",
                    "consensusClustering",
                    "seed"),
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="percent", 
                        `title`="Percentage", 
                        `type`="number", 
                        `format`="zto,pc"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="silhouetteStats",
                title="Silhouette Statistics",
                visible="(autoSelectK)",
                columns=list(
                    list(
                        `name`="k", 
                        `title`="k", 
                        `type`="integer"),
                    list(
                        `name`="avg_silhouette", 
                        `title`="Avg Silhouette", 
                        `type`="number"),
                    list(
                        `name`="selected", 
                        `title`="Selected", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="clusterProfiles",
                title="Cluster Profiles",
                visible="(clusterProfiles)",
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="summary", 
                        `title`="Summary", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="markerSummary",
                title="Marker Summary by Cluster",
                visible="(markerSummary)",
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="type", 
                        `title`="Type", 
                        `type`="text"),
                    list(
                        `name`="mean_median", 
                        `title`="Mean/Median", 
                        `type`="text"),
                    list(
                        `name`="sd_iqr", 
                        `title`="SD/IQR", 
                        `type`="text"),
                    list(
                        `name`="range", 
                        `title`="Range", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="associationTests",
                title="Marker-Cluster Associations",
                visible="(associationTests)",
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="effect_size", 
                        `title`="Effect Size", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="clinicalComparison",
                title="Clinical Variables by Cluster",
                visible="(clinicalVars)",
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="summary", 
                        `title`="Summary", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="consensusStats",
                title="Consensus Clustering Stability",
                visible="(consensusClustering)",
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="stability", 
                        `title`="Stability", 
                        `type`="number"),
                    list(
                        `name`="core_samples", 
                        `title`="Core Samples", 
                        `type`="integer"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="silhouettePlot",
                title="Silhouette Plot",
                width=700,
                height=500,
                renderFun=".plotSilhouette",
                visible="(showSilhouette)",
                clearWith=list(
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "autoSelectK",
                    "colorPalette",
                    "fontSize",
                    "plotContrast",
                    "language")))
            self$add(jmvcore::Image$new(
                options=options,
                name="heatmapPlot",
                title="Expression Heatmap",
                width=900,
                height=700,
                renderFun=".plotHeatmap",
                visible="(showHeatmap)",
                clearWith=list(
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "heatmapScale",
                    "autoSelectK",
                    "colorPalette",
                    "fontSize",
                    "plotContrast",
                    "language")))
            self$add(jmvcore::Image$new(
                options=options,
                name="dendrogramPlot",
                title="Dendrogram",
                width=800,
                height=600,
                renderFun=".plotDendrogram",
                visible="(showDendrogram && method:hierarchical)",
                clearWith=list(
                    "catVars",
                    "contVars",
                    "nClusters",
                    "autoSelectK",
                    "colorPalette",
                    "fontSize",
                    "plotContrast",
                    "language")))
            self$add(jmvcore::Image$new(
                options=options,
                name="pcaPlot",
                title="PCA/MCA Plot",
                width=700,
                height=600,
                renderFun=".plotPCA",
                visible="(showPCAPlot)",
                clearWith=list(
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "autoSelectK",
                    "colorPalette",
                    "fontSize",
                    "plotContrast",
                    "language")))
            self$add(jmvcore::Image$new(
                options=options,
                name="boxplotPlot",
                title="Marker Distributions by Cluster",
                width=900,
                height=600,
                renderFun=".plotBoxplots",
                visible="(showBoxplots)",
                clearWith=list(
                    "contVars",
                    "nClusters",
                    "autoSelectK",
                    "colorPalette",
                    "fontSize",
                    "plotContrast",
                    "language")))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlot",
                title="Survival Analysis by Cluster",
                width=700,
                height=600,
                renderFun=".plotSurvival",
                visible=FALSE,
                clearWith=list(
                    "survivalTime",
                    "survivalEvent",
                    "nClusters",
                    "autoSelectK",
                    "colorPalette",
                    "fontSize",
                    "plotContrast",
                    "language")))
            self$add(jmvcore::Table$new(
                options=options,
                name="medoidInfo",
                title="Cluster Medoids (Representative Cases)",
                visible="(method:pam)",
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="medoid_id", 
                        `title`="Medoid Case ID", 
                        `type`="text"),
                    list(
                        `name`="description", 
                        `title`="Profile Description", 
                        `type`="text"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretationGuide",
                title="Clinical Interpretation",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="technicalNotes",
                title="Technical Notes",
                visible=TRUE))
            self$add(jmvcore::Preformatted$new(
                options=options,
                name="executiveSummary",
                title="Executive Summary (Copy-Ready)",
                visible=TRUE,
                clearWith=list(
                    "catVars",
                    "contVars",
                    "method",
                    "nClusters",
                    "autoSelectK",
                    "language",
                    "tumorPreset",
                    "applyPreset")))
            self$add(jmvcore::Table$new(
                options=options,
                name="sizes",
                title="Cluster Sizes (Legacy)",
                visible=FALSE,
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modes",
                title="Cluster Modes (Legacy)",
                visible=FALSE,
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="distr",
                title="Distributions (Legacy)",
                visible=FALSE,
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="text"),
                    list(
                        `name`="level", 
                        `title`="Level", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="pct", 
                        `title`="Percentage", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="assoc",
                title="Association Tests (Legacy)",
                visible=FALSE,
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="p", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Preformatted$new(
                options=options,
                name="text",
                title="Analysis Notes (Legacy)",
                visible=FALSE))}))

ihcclusterBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcclusterBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "ihccluster",
                version = c(2,0,0),
                options = options,
                results = ihcclusterResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' IHC Clustering Analysis
#'
#' Clusters cases based on immunohistochemistry (IHC) staining patterns.
#' 
#' **Variable Types:**
#' - Categorical: pos/neg, intensity levels (0/1/2/3), ordinal scales
#' - Continuous: H-scores (0-300), \% positivity (0-100), expression levels
#' - Mixed: Any combination of categorical and continuous markers
#' 
#' Uses Gower distance to handle mixed data types appropriately.
#' 
#' @param data The data as a data frame.
#' @param catVars Binary (pos/neg) or ordinal (0/1/2/3) stain results
#' @param contVars H-scores (0-300), \% positivity (0-100), or other
#'   continuous measures
#' @param caseId Case identifier for tracking
#' @param method Clustering algorithm to use
#' @param nClusters Leave blank for automatic selection using silhouette
#' @param autoSelectK Use silhouette width to find optimal number of clusters
#' @param kRange Range to test when auto-selecting k
#' @param scaleContVars Z-score continuous markers before clustering
#' @param weights Comma-separated weights for markers (e.g., "1,1,2,1" for 4
#'   markers)
#' @param handleMissing How to handle missing values
#' @param consensusClustering Use bootstrap resampling for stable clusters
#' @param nBootstrap Number of bootstrap samples for consensus
#' @param seed For reproducibility
#' @param showSilhouette Show silhouette width plot for cluster quality
#' @param showHeatmap Show clustered heatmap of IHC expression
#' @param heatmapScale How to scale heatmap values
#' @param showDendrogram Show dendrogram for hierarchical clustering
#' @param showPCAPlot Show dimension reduction plot with clusters
#' @param showBoxplots Show boxplots of continuous markers by cluster
#' @param markerSummary Summary statistics for each marker by cluster
#' @param clusterProfiles Characteristic features of each cluster
#' @param associationTests Test marker-cluster associations
#' @param exportClusters Save cluster assignments to dataset
#' @param clinicalVars Clinical variables to compare across clusters
#' @param survivalTime Time variable for survival analysis
#' @param survivalEvent Event variable for survival analysis
#' @param colorPalette Color palette for plots (colorblind-safe options
#'   available)
#' @param fontSize Base font size for all text elements
#' @param plotContrast Enable high contrast mode for better visibility
#' @param tumorPreset Apply tumor-specific clustering configurations
#' @param applyPreset Apply the selected tumor-specific preset settings. Note:
#'   This will provide recommendations, you may need to manually adjust the
#'   settings.
#' @param language Interface and output language / Arayüz ve çıktı dili
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$clusterSizes} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$silhouetteStats} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clusterProfiles} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$markerSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$associationTests} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clinicalComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$consensusStats} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$silhouettePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$heatmapPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$dendrogramPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$pcaPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$boxplotPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$survivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$medoidInfo} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$interpretationGuide} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$technicalNotes} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$executiveSummary} \tab \tab \tab \tab \tab a preformatted \cr
#'   \code{results$sizes} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modes} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$distr} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$assoc} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$text} \tab \tab \tab \tab \tab a preformatted \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$clusterSizes$asDF}
#'
#' \code{as.data.frame(results$clusterSizes)}
#'
#' @export
ihccluster <- function(
    data,
    catVars,
    contVars = NULL,
    caseId,
    method = "pam",
    nClusters = 3,
    autoSelectK = TRUE,
    kRange = "medium",
    scaleContVars = TRUE,
    weights = "",
    handleMissing = "pairwise",
    consensusClustering = FALSE,
    nBootstrap = 100,
    seed = 42,
    showSilhouette = TRUE,
    showHeatmap = TRUE,
    heatmapScale = "row",
    showDendrogram = TRUE,
    showPCAPlot = TRUE,
    showBoxplots = TRUE,
    markerSummary = TRUE,
    clusterProfiles = TRUE,
    associationTests = TRUE,
    exportClusters = FALSE,
    clinicalVars,
    survivalTime = NULL,
    survivalEvent = NULL,
    colorPalette = "default",
    fontSize = "medium",
    plotContrast = FALSE,
    tumorPreset = "none",
    applyPreset = FALSE,
    language = "english") {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("ihccluster requires jmvcore to be installed (restart may be required)")

    if ( ! missing(catVars)) catVars <- jmvcore::resolveQuo(jmvcore::enquo(catVars))
    if ( ! missing(contVars)) contVars <- jmvcore::resolveQuo(jmvcore::enquo(contVars))
    if ( ! missing(caseId)) caseId <- jmvcore::resolveQuo(jmvcore::enquo(caseId))
    if ( ! missing(clinicalVars)) clinicalVars <- jmvcore::resolveQuo(jmvcore::enquo(clinicalVars))
    if ( ! missing(survivalTime)) survivalTime <- jmvcore::resolveQuo(jmvcore::enquo(survivalTime))
    if ( ! missing(survivalEvent)) survivalEvent <- jmvcore::resolveQuo(jmvcore::enquo(survivalEvent))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(catVars), catVars, NULL),
            `if`( ! missing(contVars), contVars, NULL),
            `if`( ! missing(caseId), caseId, NULL),
            `if`( ! missing(clinicalVars), clinicalVars, NULL),
            `if`( ! missing(survivalTime), survivalTime, NULL),
            `if`( ! missing(survivalEvent), survivalEvent, NULL))

    for (v in catVars) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- ihcclusterOptions$new(
        catVars = catVars,
        contVars = contVars,
        caseId = caseId,
        method = method,
        nClusters = nClusters,
        autoSelectK = autoSelectK,
        kRange = kRange,
        scaleContVars = scaleContVars,
        weights = weights,
        handleMissing = handleMissing,
        consensusClustering = consensusClustering,
        nBootstrap = nBootstrap,
        seed = seed,
        showSilhouette = showSilhouette,
        showHeatmap = showHeatmap,
        heatmapScale = heatmapScale,
        showDendrogram = showDendrogram,
        showPCAPlot = showPCAPlot,
        showBoxplots = showBoxplots,
        markerSummary = markerSummary,
        clusterProfiles = clusterProfiles,
        associationTests = associationTests,
        exportClusters = exportClusters,
        clinicalVars = clinicalVars,
        survivalTime = survivalTime,
        survivalEvent = survivalEvent,
        colorPalette = colorPalette,
        fontSize = fontSize,
        plotContrast = plotContrast,
        tumorPreset = tumorPreset,
        applyPreset = applyPreset,
        language = language)

    analysis <- ihcclusterClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

