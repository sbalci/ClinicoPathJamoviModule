
# This file is automatically generated, you probably don't want to edit this

finegrayOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "finegrayOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            survivalTime = NULL,
            status = NULL,
            eventOfInterest = NULL,
            censorLevel = NULL,
            covariates = NULL,
            groupVar = NULL,
            showCoefficientTable = TRUE,
            exponentiate = TRUE,
            confLevel = 0.95,
            showGrayTest = TRUE,
            showModelFit = TRUE,
            showCIFPlot = TRUE,
            cifPlotBy = "group",
            cifPlotTimes = "",
            showRiskTable = TRUE,
            colorScheme = "default",
            cifConfInt = FALSE,
            cifConfLevel = 0.95,
            predictAt = "",
            predictCovariatePattern = "mean",
            customCovariateValues = "",
            showInterpretation = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="finegray",
                requiresData=TRUE,
                ...)

            private$..survivalTime <- jmvcore::OptionVariable$new(
                "survivalTime",
                survivalTime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..status <- jmvcore::OptionVariable$new(
                "status",
                status,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..eventOfInterest <- jmvcore::OptionLevel$new(
                "eventOfInterest",
                eventOfInterest,
                variable="(status)")
            private$..censorLevel <- jmvcore::OptionLevel$new(
                "censorLevel",
                censorLevel,
                variable="(status)")
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..groupVar <- jmvcore::OptionVariable$new(
                "groupVar",
                groupVar,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..showCoefficientTable <- jmvcore::OptionBool$new(
                "showCoefficientTable",
                showCoefficientTable,
                default=TRUE)
            private$..exponentiate <- jmvcore::OptionBool$new(
                "exponentiate",
                exponentiate,
                default=TRUE)
            private$..confLevel <- jmvcore::OptionNumber$new(
                "confLevel",
                confLevel,
                default=0.95,
                min=0.5,
                max=0.99)
            private$..showGrayTest <- jmvcore::OptionBool$new(
                "showGrayTest",
                showGrayTest,
                default=TRUE)
            private$..showModelFit <- jmvcore::OptionBool$new(
                "showModelFit",
                showModelFit,
                default=TRUE)
            private$..showCIFPlot <- jmvcore::OptionBool$new(
                "showCIFPlot",
                showCIFPlot,
                default=TRUE)
            private$..cifPlotBy <- jmvcore::OptionList$new(
                "cifPlotBy",
                cifPlotBy,
                options=list(
                    "group",
                    "covariate",
                    "overall"),
                default="group")
            private$..cifPlotTimes <- jmvcore::OptionString$new(
                "cifPlotTimes",
                cifPlotTimes,
                default="")
            private$..showRiskTable <- jmvcore::OptionBool$new(
                "showRiskTable",
                showRiskTable,
                default=TRUE)
            private$..colorScheme <- jmvcore::OptionList$new(
                "colorScheme",
                colorScheme,
                options=list(
                    "default",
                    "colorblind",
                    "grayscale",
                    "nejm",
                    "lancet"),
                default="default")
            private$..cifConfInt <- jmvcore::OptionBool$new(
                "cifConfInt",
                cifConfInt,
                default=FALSE)
            private$..cifConfLevel <- jmvcore::OptionNumber$new(
                "cifConfLevel",
                cifConfLevel,
                default=0.95,
                min=0.8,
                max=0.99)
            private$..predictAt <- jmvcore::OptionString$new(
                "predictAt",
                predictAt,
                default="")
            private$..predictCovariatePattern <- jmvcore::OptionList$new(
                "predictCovariatePattern",
                predictCovariatePattern,
                options=list(
                    "mean",
                    "median",
                    "reference",
                    "custom"),
                default="mean")
            private$..customCovariateValues <- jmvcore::OptionString$new(
                "customCovariateValues",
                customCovariateValues,
                default="")
            private$..showInterpretation <- jmvcore::OptionBool$new(
                "showInterpretation",
                showInterpretation,
                default=TRUE)

            self$.addOption(private$..survivalTime)
            self$.addOption(private$..status)
            self$.addOption(private$..eventOfInterest)
            self$.addOption(private$..censorLevel)
            self$.addOption(private$..covariates)
            self$.addOption(private$..groupVar)
            self$.addOption(private$..showCoefficientTable)
            self$.addOption(private$..exponentiate)
            self$.addOption(private$..confLevel)
            self$.addOption(private$..showGrayTest)
            self$.addOption(private$..showModelFit)
            self$.addOption(private$..showCIFPlot)
            self$.addOption(private$..cifPlotBy)
            self$.addOption(private$..cifPlotTimes)
            self$.addOption(private$..showRiskTable)
            self$.addOption(private$..colorScheme)
            self$.addOption(private$..cifConfInt)
            self$.addOption(private$..cifConfLevel)
            self$.addOption(private$..predictAt)
            self$.addOption(private$..predictCovariatePattern)
            self$.addOption(private$..customCovariateValues)
            self$.addOption(private$..showInterpretation)
        }),
    active = list(
        survivalTime = function() private$..survivalTime$value,
        status = function() private$..status$value,
        eventOfInterest = function() private$..eventOfInterest$value,
        censorLevel = function() private$..censorLevel$value,
        covariates = function() private$..covariates$value,
        groupVar = function() private$..groupVar$value,
        showCoefficientTable = function() private$..showCoefficientTable$value,
        exponentiate = function() private$..exponentiate$value,
        confLevel = function() private$..confLevel$value,
        showGrayTest = function() private$..showGrayTest$value,
        showModelFit = function() private$..showModelFit$value,
        showCIFPlot = function() private$..showCIFPlot$value,
        cifPlotBy = function() private$..cifPlotBy$value,
        cifPlotTimes = function() private$..cifPlotTimes$value,
        showRiskTable = function() private$..showRiskTable$value,
        colorScheme = function() private$..colorScheme$value,
        cifConfInt = function() private$..cifConfInt$value,
        cifConfLevel = function() private$..cifConfLevel$value,
        predictAt = function() private$..predictAt$value,
        predictCovariatePattern = function() private$..predictCovariatePattern$value,
        customCovariateValues = function() private$..customCovariateValues$value,
        showInterpretation = function() private$..showInterpretation$value),
    private = list(
        ..survivalTime = NA,
        ..status = NA,
        ..eventOfInterest = NA,
        ..censorLevel = NA,
        ..covariates = NA,
        ..groupVar = NA,
        ..showCoefficientTable = NA,
        ..exponentiate = NA,
        ..confLevel = NA,
        ..showGrayTest = NA,
        ..showModelFit = NA,
        ..showCIFPlot = NA,
        ..cifPlotBy = NA,
        ..cifPlotTimes = NA,
        ..showRiskTable = NA,
        ..colorScheme = NA,
        ..cifConfInt = NA,
        ..cifConfLevel = NA,
        ..predictAt = NA,
        ..predictCovariatePattern = NA,
        ..customCovariateValues = NA,
        ..showInterpretation = NA)
)

finegrayResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "finegrayResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        procedureNotes = function() private$.items[["procedureNotes"]],
        modelInfo = function() private$.items[["modelInfo"]],
        shrTable = function() private$.items[["shrTable"]],
        grayTestTable = function() private$.items[["grayTestTable"]],
        modelFitTable = function() private$.items[["modelFitTable"]],
        comparisonTable = function() private$.items[["comparisonTable"]],
        predictionTable = function() private$.items[["predictionTable"]],
        cifPlot = function() private$.items[["cifPlot"]],
        stackedCIFPlot = function() private$.items[["stackedCIFPlot"]],
        kmvscifPlot = function() private$.items[["kmvscifPlot"]],
        causeSpecificPlot = function() private$.items[["causeSpecificPlot"]],
        diagnosticPlots = function() private$.items[["diagnosticPlots"]],
        influenceTable = function() private$.items[["influenceTable"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Fine-Gray Competing Risks Regression",
                refs=list(
                    "cmprsk",
                    "riskRegression",
                    "tidycmprsk",
                    "survival",
                    "ggplot2",
                    "dplyr",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="procedureNotes",
                title="Analysis Summary",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelInfo",
                title="Model Information",
                visible=TRUE,
                rows=0,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="shrTable",
                title="Sub-Hazard Ratios (sHR)",
                visible="(showCoefficientTable)",
                rows=0,
                columns=list(
                    list(
                        `name`="term", 
                        `title`="Covariate", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="sHR", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="z_value", 
                        `title`="z", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="p_value", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue")),
                clearWith=list(
                    "survivalTime",
                    "status",
                    "eventOfInterest",
                    "censorLevel",
                    "covariates",
                    "strata",
                    "confLevel")))
            self$add(jmvcore::Table$new(
                options=options,
                name="grayTestTable",
                title="Gray's Test for Group Differences",
                visible="(showGrayTest)",
                rows=0,
                columns=list(
                    list(
                        `name`="event_type", 
                        `title`="Event Type", 
                        `type`="text"),
                    list(
                        `name`="chisq", 
                        `title`="Chi-square", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue")),
                clearWith=list(
                    "survivalTime",
                    "status",
                    "eventOfInterest",
                    "groupVar")))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelFitTable",
                title="Model Fit Statistics",
                visible="(showModelFit)",
                rows=0,
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="comparisonTable",
                title="Subdistribution vs Cause-Specific Hazard Ratios",
                visible="(causeSpecificComparison)",
                rows=0,
                columns=list(
                    list(
                        `name`="term", 
                        `title`="Covariate", 
                        `type`="text"),
                    list(
                        `name`="shr", 
                        `title`="sHR", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="shr_ci", 
                        `title`="95% CI", 
                        `type`="text"),
                    list(
                        `name`="cshr", 
                        `title`="csHR", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cshr_ci", 
                        `title`="95% CI", 
                        `type`="text"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="predictionTable",
                title="Predicted Cumulative Incidence",
                visible="(showPredictionTable)",
                rows=0,
                columns=list(
                    list(
                        `name`="time", 
                        `title`="Time", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cif", 
                        `title`="CIF", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="pc")),
                clearWith=list(
                    "survivalTime",
                    "status",
                    "covariates",
                    "predictAt",
                    "predictCovariatePattern")))
            self$add(jmvcore::Image$new(
                options=options,
                name="cifPlot",
                title="Cumulative Incidence Function",
                width=700,
                height=500,
                renderFun=".plotCIF",
                visible="(showCIFPlot)",
                clearWith=list(
                    "survivalTime",
                    "status",
                    "eventOfInterest",
                    "groupVar",
                    "colorScheme",
                    "cifConfInt")))
            self$add(jmvcore::Image$new(
                options=options,
                name="stackedCIFPlot",
                title="Stacked Cumulative Incidence (All Events)",
                width=700,
                height=500,
                renderFun=".plotStackedCIF",
                visible="(showStackedCIF)",
                clearWith=list(
                    "survivalTime",
                    "status",
                    "groupVar",
                    "colorScheme")))
            self$add(jmvcore::Image$new(
                options=options,
                name="kmvscifPlot",
                title="1-KM vs CIF Comparison",
                width=700,
                height=500,
                renderFun=".plotKMvsCIF",
                visible="(show1KMvsCIF)",
                clearWith=list(
                    "survivalTime",
                    "status",
                    "eventOfInterest",
                    "groupVar")))
            self$add(jmvcore::Image$new(
                options=options,
                name="causeSpecificPlot",
                title="Cause-Specific Hazard Functions",
                width=700,
                height=500,
                renderFun=".plotCauseSpecific",
                visible="(showCauseSpecific)",
                clearWith=list(
                    "survivalTime",
                    "status",
                    "groupVar",
                    "colorScheme")))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagnosticPlots",
                title="Diagnostic Plots",
                width=700,
                height=900,
                renderFun=".plotDiagnostics",
                visible="(diagnosticPlots)",
                clearWith=list(
                    "survivalTime",
                    "status",
                    "covariates")))
            self$add(jmvcore::Table$new(
                options=options,
                name="influenceTable",
                title="Influential Observations",
                visible="(showInfluence)",
                rows=0,
                columns=list(
                    list(
                        `name`="observation", 
                        `title`="Observation", 
                        `type`="integer"),
                    list(
                        `name`="dfbetas", 
                        `title`="DFBETAs", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="influence", 
                        `title`="Influence", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="flag", 
                        `title`="Flag", 
                        `type`="text"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation",
                visible="(showInterpretation)",
                clearWith=list(
                    "survivalTime",
                    "status",
                    "covariates")))}))

finegrayBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "finegrayBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "finegray",
                version = c(0,0,32),
                options = options,
                results = finegrayResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Fine-Gray Competing Risks Regression
#'
#' Fine-Gray subdistribution hazard regression for competing risks data. 
#' Models the cumulative incidence function (CIF) while accounting for 
#' competing events. Provides sub-hazard ratios (sHR) for covariate effects.
#' 
#'
#' @examples
#' \donttest{
#' # example will be added
#'}
#' @param data The data as a data frame.
#' @param survivalTime Time to event or censoring. Must be numeric and
#'   positive.
#' @param status Event status with multiple levels: 0 or first level =
#'   censored, 1 or second level = event of interest, 2+ = competing events.
#' @param eventOfInterest Which level of status represents the event of
#'   interest. Other non-censored levels are treated as competing events.
#' @param censorLevel Which level of status represents censoring.
#' @param covariates Predictor variables for the regression model. Can include
#'   continuous and categorical variables.
#' @param groupVar Optional grouping variable for cumulative incidence plots.
#' @param showCoefficientTable Display table of sub-hazard ratios with
#'   confidence intervals.
#' @param exponentiate Report exponentiated coefficients as sub-hazard ratios
#'   (sHR). If false, reports log sub-hazard ratios.
#' @param confLevel Confidence level for confidence intervals.
#' @param showGrayTest Perform Gray's test for comparing cumulative incidence
#'   functions between groups (requires grouping variable).
#' @param showModelFit Display model fit statistics (pseudo-RÂ², AIC, BIC).
#' @param showCIFPlot Display cumulative incidence function plot.
#' @param cifPlotBy How to display the CIF plot.
#' @param cifPlotTimes Comma-separated time points for CIF plot risk table. If
#'   empty, automatically determined.
#' @param showRiskTable Display numbers at risk below CIF plot.
#' @param colorScheme Color palette for plots.
#' @param cifConfInt Display confidence bands around CIF curves.
#' @param cifConfLevel Confidence level for CIF confidence bands.
#' @param predictAt Comma-separated time points for predictions. Calculates
#'   predicted CIF at these times for covariate patterns.
#' @param predictCovariatePattern Covariate pattern for predictions.
#' @param customCovariateValues Custom covariate values for predictions
#'   (comma-separated). Format: "age=65,stage=III,treatment=chemo"
#' @param showInterpretation Display interpretation guidance for Fine-Gray
#'   results.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$procedureNotes} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelInfo} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$shrTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$grayTestTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelFitTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$comparisonTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$predictionTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$cifPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$stackedCIFPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$kmvscifPlot} \tab \tab \tab \tab \tab Demonstrates bias in using 1-KM for competing risks \cr
#'   \code{results$causeSpecificPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$diagnosticPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$influenceTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelInfo$asDF}
#'
#' \code{as.data.frame(results$modelInfo)}
#'
#' @export
finegray <- function(
    data,
    survivalTime,
    status,
    eventOfInterest,
    censorLevel,
    covariates,
    groupVar,
    showCoefficientTable = TRUE,
    exponentiate = TRUE,
    confLevel = 0.95,
    showGrayTest = TRUE,
    showModelFit = TRUE,
    showCIFPlot = TRUE,
    cifPlotBy = "group",
    cifPlotTimes = "",
    showRiskTable = TRUE,
    colorScheme = "default",
    cifConfInt = FALSE,
    cifConfLevel = 0.95,
    predictAt = "",
    predictCovariatePattern = "mean",
    customCovariateValues = "",
    showInterpretation = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("finegray requires jmvcore to be installed (restart may be required)")

    if ( ! missing(survivalTime)) survivalTime <- jmvcore::resolveQuo(jmvcore::enquo(survivalTime))
    if ( ! missing(status)) status <- jmvcore::resolveQuo(jmvcore::enquo(status))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(groupVar)) groupVar <- jmvcore::resolveQuo(jmvcore::enquo(groupVar))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(survivalTime), survivalTime, NULL),
            `if`( ! missing(status), status, NULL),
            `if`( ! missing(covariates), covariates, NULL),
            `if`( ! missing(groupVar), groupVar, NULL))

    for (v in status) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in groupVar) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- finegrayOptions$new(
        survivalTime = survivalTime,
        status = status,
        eventOfInterest = eventOfInterest,
        censorLevel = censorLevel,
        covariates = covariates,
        groupVar = groupVar,
        showCoefficientTable = showCoefficientTable,
        exponentiate = exponentiate,
        confLevel = confLevel,
        showGrayTest = showGrayTest,
        showModelFit = showModelFit,
        showCIFPlot = showCIFPlot,
        cifPlotBy = cifPlotBy,
        cifPlotTimes = cifPlotTimes,
        showRiskTable = showRiskTable,
        colorScheme = colorScheme,
        cifConfInt = cifConfInt,
        cifConfLevel = cifConfLevel,
        predictAt = predictAt,
        predictCovariatePattern = predictCovariatePattern,
        customCovariateValues = customCovariateValues,
        showInterpretation = showInterpretation)

    analysis <- finegrayClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

