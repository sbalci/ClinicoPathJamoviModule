
# This file is automatically generated, you probably don't want to edit this

predmodelOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "predmodelOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            outcome = NULL,
            predictors = NULL,
            modelSelection = "none",
            validationMethod = "bootstrap",
            nBootstrap = 200,
            nFolds = 10,
            showCalibration = TRUE,
            showDiscrimination = TRUE,
            showRiskGroups = TRUE,
            riskCutoffs = "0.33, 0.67",
            ciLevel = 0.95, ...) {

            super$initialize(
                package="ClinicoPath",
                name="predmodel",
                requiresData=TRUE,
                ...)

            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..predictors <- jmvcore::OptionVariables$new(
                "predictors",
                predictors)
            private$..modelSelection <- jmvcore::OptionList$new(
                "modelSelection",
                modelSelection,
                options=list(
                    "none",
                    "stepwise",
                    "lasso",
                    "ridge"),
                default="none")
            private$..validationMethod <- jmvcore::OptionList$new(
                "validationMethod",
                validationMethod,
                options=list(
                    "none",
                    "bootstrap",
                    "kfold"),
                default="bootstrap")
            private$..nBootstrap <- jmvcore::OptionInteger$new(
                "nBootstrap",
                nBootstrap,
                default=200,
                min=50,
                max=1000)
            private$..nFolds <- jmvcore::OptionInteger$new(
                "nFolds",
                nFolds,
                default=10,
                min=3,
                max=20)
            private$..showCalibration <- jmvcore::OptionBool$new(
                "showCalibration",
                showCalibration,
                default=TRUE)
            private$..showDiscrimination <- jmvcore::OptionBool$new(
                "showDiscrimination",
                showDiscrimination,
                default=TRUE)
            private$..showRiskGroups <- jmvcore::OptionBool$new(
                "showRiskGroups",
                showRiskGroups,
                default=TRUE)
            private$..riskCutoffs <- jmvcore::OptionString$new(
                "riskCutoffs",
                riskCutoffs,
                default="0.33, 0.67")
            private$..ciLevel <- jmvcore::OptionNumber$new(
                "ciLevel",
                ciLevel,
                default=0.95,
                min=0.8,
                max=0.99)

            self$.addOption(private$..outcome)
            self$.addOption(private$..predictors)
            self$.addOption(private$..modelSelection)
            self$.addOption(private$..validationMethod)
            self$.addOption(private$..nBootstrap)
            self$.addOption(private$..nFolds)
            self$.addOption(private$..showCalibration)
            self$.addOption(private$..showDiscrimination)
            self$.addOption(private$..showRiskGroups)
            self$.addOption(private$..riskCutoffs)
            self$.addOption(private$..ciLevel)
        }),
    active = list(
        outcome = function() private$..outcome$value,
        predictors = function() private$..predictors$value,
        modelSelection = function() private$..modelSelection$value,
        validationMethod = function() private$..validationMethod$value,
        nBootstrap = function() private$..nBootstrap$value,
        nFolds = function() private$..nFolds$value,
        showCalibration = function() private$..showCalibration$value,
        showDiscrimination = function() private$..showDiscrimination$value,
        showRiskGroups = function() private$..showRiskGroups$value,
        riskCutoffs = function() private$..riskCutoffs$value,
        ciLevel = function() private$..ciLevel$value),
    private = list(
        ..outcome = NA,
        ..predictors = NA,
        ..modelSelection = NA,
        ..validationMethod = NA,
        ..nBootstrap = NA,
        ..nFolds = NA,
        ..showCalibration = NA,
        ..showDiscrimination = NA,
        ..showRiskGroups = NA,
        ..riskCutoffs = NA,
        ..ciLevel = NA)
)

predmodelResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "predmodelResults",
    inherit = jmvcore::Group,
    active = list(
        modelSummary = function() private$.items[["modelSummary"]],
        coefficients = function() private$.items[["coefficients"]],
        discriminationMetrics = function() private$.items[["discriminationMetrics"]],
        calibrationMetrics = function() private$.items[["calibrationMetrics"]],
        riskStratification = function() private$.items[["riskStratification"]],
        validationMetrics = function() private$.items[["validationMetrics"]],
        rocPlot = function() private$.items[["rocPlot"]],
        calibrationPlot = function() private$.items[["calibrationPlot"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Clinical Prediction Model",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "rms",
                    "pROC"))
            self$add(jmvcore::Html$new(
                options=options,
                name="modelSummary",
                title="Model Summary"))
            self$add(jmvcore::Table$new(
                options=options,
                name="coefficients",
                title="Model Coefficients",
                columns=list(
                    list(
                        `name`="term", 
                        `title`="Term", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Coefficient", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="z", 
                        `title`="z", 
                        `type`="number"),
                    list(
                        `name`="p", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="or", 
                        `title`="Odds Ratio", 
                        `type`="number"),
                    list(
                        `name`="ciLower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="ciUpper", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="discriminationMetrics",
                title="Discrimination Metrics",
                visible="(showDiscrimination)",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="ciLower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="ciUpper", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="calibrationMetrics",
                title="Calibration Metrics",
                visible="(showCalibration)",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="riskStratification",
                title="Risk Stratification",
                visible="(showRiskGroups)",
                columns=list(
                    list(
                        `name`="riskGroup", 
                        `title`="Risk Group", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="percent", 
                        `title`="%", 
                        `type`="number"),
                    list(
                        `name`="events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="eventRate", 
                        `title`="Event Rate", 
                        `type`="number", 
                        `format`="pc"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="validationMetrics",
                title="Validation Performance",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="apparent", 
                        `title`="Apparent", 
                        `type`="number"),
                    list(
                        `name`="optimism", 
                        `title`="Optimism", 
                        `type`="number"),
                    list(
                        `name`="corrected", 
                        `title`="Corrected", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="rocPlot",
                title="ROC Curve",
                width=500,
                height=500,
                renderFun=".rocPlot",
                visible="(showDiscrimination)",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="calibrationPlot",
                title="Calibration Plot",
                width=500,
                height=500,
                renderFun=".calibrationPlot",
                visible="(showCalibration)",
                requiresData=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation"))}))

predmodelBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "predmodelBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "predmodel",
                version = c(1,0,0),
                options = options,
                results = predmodelResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = TRUE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Clinical Prediction Model
#'
#' Build and validate clinical prediction models with integrated calibration 
#' and discrimination metrics. Supports logistic regression with 
#' stepwise/LASSO selection, ROC analysis, calibration plots, and bootstrap 
#' validation.
#' 
#'
#' @examples
#' # Example usage:
#' # data <- your_data
#' # ClinicoPath::predmodel(
#' #   data = data,
#' #   outcome = "disease",
#' #   predictors = vars(age, biomarker, stage),
#' #   validation = "bootstrap",
#' #   calibration = TRUE
#' # )
#'
#' @param data The data as a data frame.
#' @param outcome Binary outcome variable (disease/event vs. no disease/no
#'   event).
#' @param predictors Continuous or categorical predictor variables for the
#'   model.
#' @param modelSelection Method for variable selection.
#' @param validationMethod Internal validation method to assess model
#'   performance.
#' @param nBootstrap Number of bootstrap samples for optimism correction.
#' @param nFolds Number of folds for cross-validation.
#' @param showCalibration Display calibration plot and Hosmer-Lemeshow test.
#' @param showDiscrimination Display ROC curve, AUC, and Brier score.
#' @param showRiskGroups Stratify patients into risk groups (low/medium/high).
#' @param riskCutoffs Comma-separated risk probability cutoffs (e.g., "0.25,
#'   0.75").
#' @param ciLevel Confidence level for intervals (0.80-0.99).
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$coefficients} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$discriminationMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$calibrationMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$riskStratification} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$validationMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$rocPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$calibrationPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$coefficients$asDF}
#'
#' \code{as.data.frame(results$coefficients)}
#'
#' @export
predmodel <- function(
    data,
    outcome,
    predictors,
    modelSelection = "none",
    validationMethod = "bootstrap",
    nBootstrap = 200,
    nFolds = 10,
    showCalibration = TRUE,
    showDiscrimination = TRUE,
    showRiskGroups = TRUE,
    riskCutoffs = "0.33, 0.67",
    ciLevel = 0.95) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("predmodel requires jmvcore to be installed (restart may be required)")

    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(predictors)) predictors <- jmvcore::resolveQuo(jmvcore::enquo(predictors))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(predictors), predictors, NULL))

    for (v in outcome) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- predmodelOptions$new(
        outcome = outcome,
        predictors = predictors,
        modelSelection = modelSelection,
        validationMethod = validationMethod,
        nBootstrap = nBootstrap,
        nFolds = nFolds,
        showCalibration = showCalibration,
        showDiscrimination = showDiscrimination,
        showRiskGroups = showRiskGroups,
        riskCutoffs = riskCutoffs,
        ciLevel = ciLevel)

    analysis <- predmodelClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

