
# This file is automatically generated, you probably don't want to edit this

ssgUNIOptions <- if (requireNamespace('jmvcore')) R6::R6Class(
    "ssgUNIOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            y1 = NULL,
            time = NULL,
            trajectories = NULL,
            waves = NULL,
            ssgUNIlag = 1,
            v1_labels = "",
            v1_Nstates = 0,
            MinReturns = 2,
            MaxReturnTime = 0,
            MaxReturnVisits = 0,
            MinEventDuration = 0,
            MinCellDuration = 0,
            doWinnowing = FALSE,
            screeCut = 0.5, ...) {

            super$initialize(
                package='ClinicoPath',
                name='ssgUNI',
                requiresData=TRUE,
                ...)

            private$..y1 <- jmvcore::OptionVariable$new(
                "y1",
                y1,
                rejectUnusedLevels=FALSE,
                suggested=list(
                    "nominal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                rejectUnusedLevels=TRUE,
                suggested=list(
                    "ordinal",
                    "continuous"),
                default=NULL)
            private$..trajectories <- jmvcore::OptionVariable$new(
                "trajectories",
                trajectories,
                rejectUnusedLevels=TRUE,
                suggested=list(
                    "ordinal",
                    "nominal"),
                default=NULL)
            private$..waves <- jmvcore::OptionVariable$new(
                "waves",
                waves,
                rejectUnusedLevels=TRUE,
                suggested=list(
                    "ordinal",
                    "nominal"),
                default=NULL)
            private$..ssgUNIlag <- jmvcore::OptionInteger$new(
                "ssgUNIlag",
                ssgUNIlag,
                default=1)
            private$..v1_labels <- jmvcore::OptionString$new(
                "v1_labels",
                v1_labels,
                default="")
            private$..v1_Nstates <- jmvcore::OptionInteger$new(
                "v1_Nstates",
                v1_Nstates,
                default=0)
            private$..MinReturns <- jmvcore::OptionNumber$new(
                "MinReturns",
                MinReturns,
                default=2)
            private$..MaxReturnTime <- jmvcore::OptionNumber$new(
                "MaxReturnTime",
                MaxReturnTime,
                default=0)
            private$..MaxReturnVisits <- jmvcore::OptionNumber$new(
                "MaxReturnVisits",
                MaxReturnVisits,
                default=0)
            private$..MinEventDuration <- jmvcore::OptionNumber$new(
                "MinEventDuration",
                MinEventDuration,
                default=0)
            private$..MinCellDuration <- jmvcore::OptionNumber$new(
                "MinCellDuration",
                MinCellDuration,
                default=0)
            private$..doWinnowing <- jmvcore::OptionBool$new(
                "doWinnowing",
                doWinnowing,
                default=FALSE)
            private$..screeCut <- jmvcore::OptionNumber$new(
                "screeCut",
                screeCut,
                default=0.5)

            self$.addOption(private$..y1)
            self$.addOption(private$..time)
            self$.addOption(private$..trajectories)
            self$.addOption(private$..waves)
            self$.addOption(private$..ssgUNIlag)
            self$.addOption(private$..v1_labels)
            self$.addOption(private$..v1_Nstates)
            self$.addOption(private$..MinReturns)
            self$.addOption(private$..MaxReturnTime)
            self$.addOption(private$..MaxReturnVisits)
            self$.addOption(private$..MinEventDuration)
            self$.addOption(private$..MinCellDuration)
            self$.addOption(private$..doWinnowing)
            self$.addOption(private$..screeCut)
        }),
    active = list(
        y1 = function() private$..y1$value,
        time = function() private$..time$value,
        trajectories = function() private$..trajectories$value,
        waves = function() private$..waves$value,
        ssgUNIlag = function() private$..ssgUNIlag$value,
        v1_labels = function() private$..v1_labels$value,
        v1_Nstates = function() private$..v1_Nstates$value,
        MinReturns = function() private$..MinReturns$value,
        MaxReturnTime = function() private$..MaxReturnTime$value,
        MaxReturnVisits = function() private$..MaxReturnVisits$value,
        MinEventDuration = function() private$..MinEventDuration$value,
        MinCellDuration = function() private$..MinCellDuration$value,
        doWinnowing = function() private$..doWinnowing$value,
        screeCut = function() private$..screeCut$value),
    private = list(
        ..y1 = NA,
        ..time = NA,
        ..trajectories = NA,
        ..waves = NA,
        ..ssgUNIlag = NA,
        ..v1_labels = NA,
        ..v1_Nstates = NA,
        ..MinReturns = NA,
        ..MaxReturnTime = NA,
        ..MaxReturnVisits = NA,
        ..MinEventDuration = NA,
        ..MinCellDuration = NA,
        ..doWinnowing = NA,
        ..screeCut = NA)
)

ssgUNIResults <- if (requireNamespace('jmvcore')) R6::R6Class(
    inherit = jmvcore::Group,
    active = list(
        warnings = function() private$.items[["warnings"]],
        tblTS = function() private$.items[["tblTS"]],
        tsplot = function() private$.items[["tsplot"]],
        SSGplot = function() private$.items[["SSGplot"]],
        tblSSG = function() private$.items[["tblSSG"]],
        tblSSGstates = function() private$.items[["tblSSGstates"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Univariate State Space Grid")
            self$add(jmvcore::Preformatted$new(
                options=options,
                name="warnings",
                title="Notes"))
            self$add(jmvcore::Table$new(
                options=options,
                name="tblTS",
                title="Time series descriptives",
                rows=2,
                columns=list(
                    list(
                        `name`="var", 
                        `title`="", 
                        `type`="text"),
                    list(
                        `name`="vlevel", 
                        `title`="type", 
                        `type`="text"),
                    list(
                        `name`="N", 
                        `type`="integer", 
                        `title`="valid N"),
                    list(
                        `name`="na", 
                        `type`="integer", 
                        `title`="NA values"),
                    list(
                        `name`="uni_obs", 
                        `title`="# of unique observed states ", 
                        `type`="number"),
                    list(
                        `name`="uni_exp", 
                        `title`="# of unique expected states", 
                        `type`="number"),
                    list(
                        `name`="discretised", 
                        `title`="discretised?", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="tsplot",
                title="Nominal time series",
                width=700,
                height=300,
                renderFun=".tsplot"))
            self$add(jmvcore::Image$new(
                options=options,
                name="SSGplot",
                title="State Space Grid",
                width=700,
                height=500,
                renderFun=".SSGplot"))
            self$add(jmvcore::Table$new(
                options=options,
                name="tblSSG",
                title="Grid measures",
                rows=1,
                columns=list(
                    list(
                        `name`="Nstates", 
                        `title`="Unique states", 
                        `type`="number"),
                    list(
                        `name`="Ntraj", 
                        `title`="Unique trajectories", 
                        `type`="number"),
                    list(
                        `name`="Nreturns", 
                        `title`="N returns", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="tblSSGstates",
                title="State measures",
                rows=0,
                columns=list(
                    list(
                        `name`="stateName", 
                        `title`="State"),
                    list(
                        `name`="Nvisits", 
                        `title`="# of Visits", 
                        `type`="number"),
                    list(
                        `name`="MNduration", 
                        `title`="Mean Visit duration", 
                        `type`="number"),
                    list(
                        `name`="SDduration", 
                        `title`="SD Visit duration", 
                        `type`="number"),
                    list(
                        `name`="Nevents", 
                        `title`="# of Events", 
                        `type`="number"),
                    list(
                        `name`="MNevent", 
                        `title`="Mean Event duration", 
                        `type`="number"),
                    list(
                        `name`="SDevent", 
                        `title`="SD Event duration", 
                        `type`="number"),
                    list(
                        `name`="MNreturn", 
                        `title`="Mean return time", 
                        `type`="number"),
                    list(
                        `name`="SDreturn", 
                        `title`="SD return time", 
                        `type`="number"))))}))

ssgUNIBase <- if (requireNamespace('jmvcore')) R6::R6Class(
    "ssgUNIBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = 'ClinicoPath',
                name = 'ssgUNI',
                version = c(1,0,0),
                options = options,
                results = ssgUNIResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE)
        }))

#' Univariate State Space Grid
#'
#' 
#' @param data .
#' @param y1 An unordered categorical state variable
#' @param time A variable indicating time
#' @param trajectories A variable indicating groups
#' @param waves A variable indicating measurement occasions
#' @param ssgUNIlag .
#' @param v1_labels .
#' @param v1_Nstates .
#' @param MinReturns .
#' @param MaxReturnTime .
#' @param MaxReturnVisits .
#' @param MinEventDuration .
#' @param MinCellDuration .
#' @param doWinnowing .
#' @param screeCut .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$warnings} \tab \tab \tab \tab \tab a preformatted \cr
#'   \code{results$tblTS} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$tsplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$SSGplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$tblSSG} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$tblSSGstates} \tab \tab \tab \tab \tab a table \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$tblTS$asDF}
#'
#' \code{as.data.frame(results$tblTS)}
#'
#' @export
ssgUNI <- function(
    data,
    y1 = NULL,
    time = NULL,
    trajectories = NULL,
    waves = NULL,
    ssgUNIlag = 1,
    v1_labels = "",
    v1_Nstates = 0,
    MinReturns = 2,
    MaxReturnTime = 0,
    MaxReturnVisits = 0,
    MinEventDuration = 0,
    MinCellDuration = 0,
    doWinnowing = FALSE,
    screeCut = 0.5) {

    if ( ! requireNamespace('jmvcore'))
        stop('ssgUNI requires jmvcore to be installed (restart may be required)')

    if ( ! missing(y1)) y1 <- jmvcore::resolveQuo(jmvcore::enquo(y1))
    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(trajectories)) trajectories <- jmvcore::resolveQuo(jmvcore::enquo(trajectories))
    if ( ! missing(waves)) waves <- jmvcore::resolveQuo(jmvcore::enquo(waves))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(y1), y1, NULL),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(trajectories), trajectories, NULL),
            `if`( ! missing(waves), waves, NULL))


    options <- ssgUNIOptions$new(
        y1 = y1,
        time = time,
        trajectories = trajectories,
        waves = waves,
        ssgUNIlag = ssgUNIlag,
        v1_labels = v1_labels,
        v1_Nstates = v1_Nstates,
        MinReturns = MinReturns,
        MaxReturnTime = MaxReturnTime,
        MaxReturnVisits = MaxReturnVisits,
        MinEventDuration = MinEventDuration,
        MinCellDuration = MinCellDuration,
        doWinnowing = doWinnowing,
        screeCut = screeCut)

    analysis <- ssgUNIClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}
