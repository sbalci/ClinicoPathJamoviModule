
# This file is automatically generated, you probably don't want to edit this

generalpseudoOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "generalpseudoOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            outcome = NULL,
            explanatory = NULL,
            outcomeLevel = "1",
            functional_type = "survival",
            cause_specific = 1,
            time_points = "12,24,60",
            quantile_prob = 0.5,
            rmst_tau = 60,
            pseudo_method = "jackknife",
            regression_type = "linear",
            confidence_level = 0.95,
            bootstrap_reps = 500,
            clustering_var = NULL,
            show_pseudo_values = FALSE,
            show_model_diagnostics = TRUE,
            show_comparison = FALSE,
            functional_plot = TRUE,
            residual_plot = FALSE,
            pseudo_plot = FALSE,
            showSummaries = TRUE,
            showExplanations = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="generalpseudo",
                requiresData=TRUE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..explanatory <- jmvcore::OptionVariables$new(
                "explanatory",
                explanatory,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..outcomeLevel <- jmvcore::OptionString$new(
                "outcomeLevel",
                outcomeLevel,
                default="1")
            private$..functional_type <- jmvcore::OptionList$new(
                "functional_type",
                functional_type,
                options=list(
                    "survival",
                    "cumulative_incidence",
                    "restricted_mean",
                    "quantile"),
                default="survival")
            private$..cause_specific <- jmvcore::OptionNumber$new(
                "cause_specific",
                cause_specific,
                default=1,
                min=1,
                max=10)
            private$..time_points <- jmvcore::OptionString$new(
                "time_points",
                time_points,
                default="12,24,60")
            private$..quantile_prob <- jmvcore::OptionNumber$new(
                "quantile_prob",
                quantile_prob,
                default=0.5,
                min=0.01,
                max=0.99)
            private$..rmst_tau <- jmvcore::OptionNumber$new(
                "rmst_tau",
                rmst_tau,
                default=60,
                min=1)
            private$..pseudo_method <- jmvcore::OptionList$new(
                "pseudo_method",
                pseudo_method,
                options=list(
                    "jackknife",
                    "bootstrap",
                    "analytical"),
                default="jackknife")
            private$..regression_type <- jmvcore::OptionList$new(
                "regression_type",
                regression_type,
                options=list(
                    "linear",
                    "logistic",
                    "complementary_log_log",
                    "beta_regression"),
                default="linear")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.5,
                max=0.99)
            private$..bootstrap_reps <- jmvcore::OptionNumber$new(
                "bootstrap_reps",
                bootstrap_reps,
                default=500,
                min=100,
                max=2000)
            private$..clustering_var <- jmvcore::OptionVariable$new(
                "clustering_var",
                clustering_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..show_pseudo_values <- jmvcore::OptionBool$new(
                "show_pseudo_values",
                show_pseudo_values,
                default=FALSE)
            private$..show_model_diagnostics <- jmvcore::OptionBool$new(
                "show_model_diagnostics",
                show_model_diagnostics,
                default=TRUE)
            private$..show_comparison <- jmvcore::OptionBool$new(
                "show_comparison",
                show_comparison,
                default=FALSE)
            private$..functional_plot <- jmvcore::OptionBool$new(
                "functional_plot",
                functional_plot,
                default=TRUE)
            private$..residual_plot <- jmvcore::OptionBool$new(
                "residual_plot",
                residual_plot,
                default=FALSE)
            private$..pseudo_plot <- jmvcore::OptionBool$new(
                "pseudo_plot",
                pseudo_plot,
                default=FALSE)
            private$..showSummaries <- jmvcore::OptionBool$new(
                "showSummaries",
                showSummaries,
                default=TRUE)
            private$..showExplanations <- jmvcore::OptionBool$new(
                "showExplanations",
                showExplanations,
                default=TRUE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..outcome)
            self$.addOption(private$..explanatory)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..functional_type)
            self$.addOption(private$..cause_specific)
            self$.addOption(private$..time_points)
            self$.addOption(private$..quantile_prob)
            self$.addOption(private$..rmst_tau)
            self$.addOption(private$..pseudo_method)
            self$.addOption(private$..regression_type)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..bootstrap_reps)
            self$.addOption(private$..clustering_var)
            self$.addOption(private$..show_pseudo_values)
            self$.addOption(private$..show_model_diagnostics)
            self$.addOption(private$..show_comparison)
            self$.addOption(private$..functional_plot)
            self$.addOption(private$..residual_plot)
            self$.addOption(private$..pseudo_plot)
            self$.addOption(private$..showSummaries)
            self$.addOption(private$..showExplanations)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        outcome = function() private$..outcome$value,
        explanatory = function() private$..explanatory$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        functional_type = function() private$..functional_type$value,
        cause_specific = function() private$..cause_specific$value,
        time_points = function() private$..time_points$value,
        quantile_prob = function() private$..quantile_prob$value,
        rmst_tau = function() private$..rmst_tau$value,
        pseudo_method = function() private$..pseudo_method$value,
        regression_type = function() private$..regression_type$value,
        confidence_level = function() private$..confidence_level$value,
        bootstrap_reps = function() private$..bootstrap_reps$value,
        clustering_var = function() private$..clustering_var$value,
        show_pseudo_values = function() private$..show_pseudo_values$value,
        show_model_diagnostics = function() private$..show_model_diagnostics$value,
        show_comparison = function() private$..show_comparison$value,
        functional_plot = function() private$..functional_plot$value,
        residual_plot = function() private$..residual_plot$value,
        pseudo_plot = function() private$..pseudo_plot$value,
        showSummaries = function() private$..showSummaries$value,
        showExplanations = function() private$..showExplanations$value),
    private = list(
        ..elapsedtime = NA,
        ..outcome = NA,
        ..explanatory = NA,
        ..outcomeLevel = NA,
        ..functional_type = NA,
        ..cause_specific = NA,
        ..time_points = NA,
        ..quantile_prob = NA,
        ..rmst_tau = NA,
        ..pseudo_method = NA,
        ..regression_type = NA,
        ..confidence_level = NA,
        ..bootstrap_reps = NA,
        ..clustering_var = NA,
        ..show_pseudo_values = NA,
        ..show_model_diagnostics = NA,
        ..show_comparison = NA,
        ..functional_plot = NA,
        ..residual_plot = NA,
        ..pseudo_plot = NA,
        ..showSummaries = NA,
        ..showExplanations = NA)
)

generalpseudoResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "generalpseudoResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        functionalSummary = function() private$.items[["functionalSummary"]],
        regressionResults = function() private$.items[["regressionResults"]],
        pseudoValues = function() private$.items[["pseudoValues"]],
        modelDiagnostics = function() private$.items[["modelDiagnostics"]],
        methodComparison = function() private$.items[["methodComparison"]],
        competingRisks = function() private$.items[["competingRisks"]],
        restrictedMean = function() private$.items[["restrictedMean"]],
        quantileResults = function() private$.items[["quantileResults"]],
        methodologyExplanation = function() private$.items[["methodologyExplanation"]],
        analysisSummary = function() private$.items[["analysisSummary"]],
        functionalPlot = function() private$.items[["functionalPlot"]],
        residualPlot = function() private$.items[["residualPlot"]],
        pseudoPlot = function() private$.items[["pseudoPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Generalized Pseudo-Observations")
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis Complete",
                visible=FALSE))
            self$add(jmvcore::Table$new(
                options=options,
                name="functionalSummary",
                title="Functional Summary",
                columns=list(
                    list(
                        `name`="functional_type", 
                        `title`="Functional Type", 
                        `type`="text"),
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="number"),
                    list(
                        `name`="n_observations", 
                        `title`="N Obs", 
                        `type`="integer"),
                    list(
                        `name`="n_events", 
                        `title`="N Events", 
                        `type`="integer"),
                    list(
                        `name`="kaplan_meier", 
                        `title`="Kaplan-Meier", 
                        `type`="number"),
                    list(
                        `name`="pseudo_mean", 
                        `title`="Pseudo Mean", 
                        `type`="number"),
                    list(
                        `name`="pseudo_se", 
                        `title`="Pseudo SE", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="regressionResults",
                title="Pseudo-Observation Regression Results",
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="number"),
                    list(
                        `name`="term", 
                        `title`="Term", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="statistic", 
                        `title`="t/z", 
                        `type`="number"),
                    list(
                        `name`="p", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="pseudoValues",
                title="Pseudo-Observation Values",
                visible="(show_pseudo_values)",
                columns=list(
                    list(
                        `name`="observation", 
                        `title`="Observation", 
                        `type`="integer"),
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="number"),
                    list(
                        `name`="functional_type", 
                        `title`="Functional", 
                        `type`="text"),
                    list(
                        `name`="pseudo_value", 
                        `title`="Pseudo-Value", 
                        `type`="number"),
                    list(
                        `name`="original_functional", 
                        `title`="Original Functional", 
                        `type`="number"),
                    list(
                        `name`="jackknife_functional", 
                        `title`="Jackknife Functional", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelDiagnostics",
                title="Model Diagnostics",
                visible="(show_model_diagnostics)",
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="number"),
                    list(
                        `name`="r_squared", 
                        `title`="R\u00B2", 
                        `type`="number"),
                    list(
                        `name`="adj_r_squared", 
                        `title`="Adj. R\u00B2", 
                        `type`="number"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number"),
                    list(
                        `name`="rmse", 
                        `title`="RMSE", 
                        `type`="number"),
                    list(
                        `name`="residual_normality_p", 
                        `title`="Normality p", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="methodComparison",
                title="Method Comparison",
                visible="(show_comparison)",
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="number"),
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="bias", 
                        `title`="Bias", 
                        `type`="number"),
                    list(
                        `name`="mse", 
                        `title`="MSE", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="competingRisks",
                title="Competing Risks Analysis",
                visible="(functional_type:cumulative_incidence)",
                columns=list(
                    list(
                        `name`="cause", 
                        `title`="Cause", 
                        `type`="integer"),
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="number"),
                    list(
                        `name`="cumulative_incidence", 
                        `title`="Cum. Incidence", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="restrictedMean",
                title="Restricted Mean Survival Time",
                visible="(functional_type:restricted_mean)",
                columns=list(
                    list(
                        `name`="tau", 
                        `title`="Tau", 
                        `type`="number"),
                    list(
                        `name`="rmst", 
                        `title`="RMST", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="n_events_by_tau", 
                        `title`="Events by Tau", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="quantileResults",
                title="Quantile Pseudo-Observations",
                visible="(functional_type:quantile)",
                columns=list(
                    list(
                        `name`="probability", 
                        `title`="Probability", 
                        `type`="number"),
                    list(
                        `name`="quantile_estimate", 
                        `title`="Quantile", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodologyExplanation",
                title="Methodology Explanation",
                visible="(showExplanations)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="analysisSummary",
                title="Analysis Summary",
                visible="(showSummaries)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="functionalPlot",
                title="Functional Estimates",
                width=600,
                height=400,
                requiresData=TRUE,
                visible="(functional_plot)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="residualPlot",
                title="Residual Diagnostic Plots",
                width=600,
                height=400,
                requiresData=TRUE,
                visible="(residual_plot)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="pseudoPlot",
                title="Pseudo-Observation Distributions",
                width=600,
                height=400,
                requiresData=TRUE,
                visible="(pseudo_plot)"))}))

generalpseudoBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "generalpseudoBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "generalpseudo",
                version = c(1,0,0),
                options = options,
                results = generalpseudoResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Generalized Pseudo-Observations
#'
#' Generalized pseudo-observations approach for survival analysis, competing 
#' risks, and other censored data problems. This method provides a flexible 
#' framework for analyzing survival outcomes using standard statistical 
#' methods by transforming survival data into pseudo-observations that can be 
#' analyzed with conventional regression techniques. Supports various 
#' functionals including survival probabilities, cumulative incidence 
#' functions, and restricted mean survival times.
#' 
#'
#' @examples
#' data \%>\%
#' generalpseudo(
#'     elapsedtime = "time_to_event",
#'     outcome = "event_status",
#'     explanatory = c("age", "treatment", "stage"),
#'     functional_type = "survival",
#'     time_points = c(12, 24, 60),
#'     cause_specific = 1
#' )
#'
#' @param data the data as a data frame
#' @param elapsedtime Time to event or censoring
#' @param outcome Event indicator (for survival: 1 = event, 0 = censored; for
#'   competing risks: 0 = censored, 1,2,... = specific causes)
#' @param explanatory Explanatory variables for pseudo-observation regression
#'   modeling
#' @param outcomeLevel Level indicating event occurrence (for survival
#'   analysis)
#' @param functional_type Type of functional for pseudo-observation
#'   calculation
#' @param cause_specific Cause of interest for competing risks analysis
#'   (competing events coded as different integers)
#' @param time_points Comma-separated list of time points at which to
#'   calculate pseudo-observations
#' @param quantile_prob Probability for quantile pseudo-observations (e.g.,
#'   0.5 for median survival)
#' @param rmst_tau Restriction time tau for restricted mean survival time
#'   calculations
#' @param pseudo_method Method for calculating pseudo-observations
#' @param regression_type Type of regression model for pseudo-observations
#' @param confidence_level Confidence level for confidence intervals
#' @param bootstrap_reps Number of bootstrap replications for
#'   pseudo-observation calculation
#' @param clustering_var Variable for clustered data analysis (optional)
#' @param show_pseudo_values Display calculated pseudo-observation values
#' @param show_model_diagnostics Display comprehensive model diagnostic
#'   information
#' @param show_comparison Compare pseudo-observation results with traditional
#'   methods
#' @param functional_plot Display plots of the estimated functionals
#' @param residual_plot Display residual diagnostic plots
#' @param pseudo_plot Display pseudo-observation distribution plots
#' @param showSummaries Show comprehensive analysis summaries
#' @param showExplanations Show detailed methodology explanations
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$functionalSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$regressionResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$pseudoValues} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelDiagnostics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$methodComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$competingRisks} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$restrictedMean} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$quantileResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$methodologyExplanation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$analysisSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$functionalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$residualPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$pseudoPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$functionalSummary$asDF}
#'
#' \code{as.data.frame(results$functionalSummary)}
#'
#' @export
generalpseudo <- function(
    data,
    elapsedtime,
    outcome,
    explanatory,
    outcomeLevel = "1",
    functional_type = "survival",
    cause_specific = 1,
    time_points = "12,24,60",
    quantile_prob = 0.5,
    rmst_tau = 60,
    pseudo_method = "jackknife",
    regression_type = "linear",
    confidence_level = 0.95,
    bootstrap_reps = 500,
    clustering_var,
    show_pseudo_values = FALSE,
    show_model_diagnostics = TRUE,
    show_comparison = FALSE,
    functional_plot = TRUE,
    residual_plot = FALSE,
    pseudo_plot = FALSE,
    showSummaries = TRUE,
    showExplanations = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("generalpseudo requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(explanatory)) explanatory <- jmvcore::resolveQuo(jmvcore::enquo(explanatory))
    if ( ! missing(clustering_var)) clustering_var <- jmvcore::resolveQuo(jmvcore::enquo(clustering_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(elapsedtime), elapsedtime, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(explanatory), explanatory, NULL),
            `if`( ! missing(clustering_var), clustering_var, NULL))


    options <- generalpseudoOptions$new(
        elapsedtime = elapsedtime,
        outcome = outcome,
        explanatory = explanatory,
        outcomeLevel = outcomeLevel,
        functional_type = functional_type,
        cause_specific = cause_specific,
        time_points = time_points,
        quantile_prob = quantile_prob,
        rmst_tau = rmst_tau,
        pseudo_method = pseudo_method,
        regression_type = regression_type,
        confidence_level = confidence_level,
        bootstrap_reps = bootstrap_reps,
        clustering_var = clustering_var,
        show_pseudo_values = show_pseudo_values,
        show_model_diagnostics = show_model_diagnostics,
        show_comparison = show_comparison,
        functional_plot = functional_plot,
        residual_plot = residual_plot,
        pseudo_plot = pseudo_plot,
        showSummaries = showSummaries,
        showExplanations = showExplanations)

    analysis <- generalpseudoClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

