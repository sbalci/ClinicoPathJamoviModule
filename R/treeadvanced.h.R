
# This file is automatically generated, you probably don't want to edit this

treeadvancedOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "treeadvancedOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            vars = NULL,
            facs = NULL,
            target = NULL,
            targetLevel = NULL,
            train = NULL,
            trainLevel = NULL,
            validation = "repeated_cv",
            cv_folds = 5,
            cv_repeats = 3,
            bootstrap_samples = 200,
            stratified_sampling = TRUE,
            test_split = 0.25,
            hyperparameter_tuning = FALSE,
            tuning_method = "grid",
            tuning_metric = "bacc",
            max_depth_range = "3:8",
            cp_range = "0.001:0.1",
            min_samples_range = "10:50",
            pruning_method = "one_se",
            custom_cp = 0.01,
            auto_prune = TRUE,
            show_cp_analysis = FALSE,
            splitting_criterion = "gini",
            surrogate_splits = TRUE,
            max_surrogate = 5,
            competing_splits = 4,
            cost_sensitive = FALSE,
            clinical_loss_preset = "equal",
            fn_fp_cost_ratio = 2,
            prevalence_adjustment = FALSE,
            population_prevalence = 10,
            feature_selection = FALSE,
            feature_selection_method = "rfe",
            max_features = 10,
            show_tree_plot = TRUE,
            show_performance_metrics = TRUE,
            show_confusion_matrix = TRUE,
            show_importance_plot = TRUE,
            show_validation_curves = FALSE,
            show_calibration_plot = FALSE,
            show_roc_curve = TRUE,
            bootstrap_confidence = FALSE,
            n_bootstrap = 500,
            clinical_context = "diagnosis",
            show_clinical_interpretation = TRUE,
            clinical_importance_interpretation = TRUE,
            mdg_threshold = 1,
            show_feature_contributions = FALSE,
            survival_integration = FALSE,
            set_seed = TRUE,
            seed_value = 42, ...) {

            super$initialize(
                package="ClinicoPath",
                name="treeadvanced",
                requiresData=TRUE,
                ...)

            private$..vars <- jmvcore::OptionVariables$new(
                "vars",
                vars,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..facs <- jmvcore::OptionVariables$new(
                "facs",
                facs,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..target <- jmvcore::OptionVariable$new(
                "target",
                target,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..targetLevel <- jmvcore::OptionLevel$new(
                "targetLevel",
                targetLevel,
                variable="(target)")
            private$..train <- jmvcore::OptionVariable$new(
                "train",
                train,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..trainLevel <- jmvcore::OptionLevel$new(
                "trainLevel",
                trainLevel,
                variable="(train)")
            private$..validation <- jmvcore::OptionList$new(
                "validation",
                validation,
                options=list(
                    "cv",
                    "repeated_cv",
                    "bootstrap",
                    "holdout",
                    "cohort"),
                default="repeated_cv")
            private$..cv_folds <- jmvcore::OptionInteger$new(
                "cv_folds",
                cv_folds,
                default=5,
                min=3,
                max=10)
            private$..cv_repeats <- jmvcore::OptionInteger$new(
                "cv_repeats",
                cv_repeats,
                default=3,
                min=1,
                max=10)
            private$..bootstrap_samples <- jmvcore::OptionInteger$new(
                "bootstrap_samples",
                bootstrap_samples,
                default=200,
                min=100,
                max=1000)
            private$..stratified_sampling <- jmvcore::OptionBool$new(
                "stratified_sampling",
                stratified_sampling,
                default=TRUE)
            private$..test_split <- jmvcore::OptionNumber$new(
                "test_split",
                test_split,
                default=0.25,
                min=0.1,
                max=0.4)
            private$..hyperparameter_tuning <- jmvcore::OptionBool$new(
                "hyperparameter_tuning",
                hyperparameter_tuning,
                default=FALSE)
            private$..tuning_method <- jmvcore::OptionList$new(
                "tuning_method",
                tuning_method,
                options=list(
                    "grid",
                    "random",
                    "bayesian"),
                default="grid")
            private$..tuning_metric <- jmvcore::OptionList$new(
                "tuning_metric",
                tuning_metric,
                options=list(
                    "bacc",
                    "auc",
                    "sens",
                    "spec",
                    "f1"),
                default="bacc")
            private$..max_depth_range <- jmvcore::OptionString$new(
                "max_depth_range",
                max_depth_range,
                default="3:8")
            private$..cp_range <- jmvcore::OptionString$new(
                "cp_range",
                cp_range,
                default="0.001:0.1")
            private$..min_samples_range <- jmvcore::OptionString$new(
                "min_samples_range",
                min_samples_range,
                default="10:50")
            private$..pruning_method <- jmvcore::OptionList$new(
                "pruning_method",
                pruning_method,
                options=list(
                    "one_se",
                    "min_xerror",
                    "custom_cp"),
                default="one_se")
            private$..custom_cp <- jmvcore::OptionNumber$new(
                "custom_cp",
                custom_cp,
                default=0.01,
                min=0.001,
                max=0.5)
            private$..auto_prune <- jmvcore::OptionBool$new(
                "auto_prune",
                auto_prune,
                default=TRUE)
            private$..show_cp_analysis <- jmvcore::OptionBool$new(
                "show_cp_analysis",
                show_cp_analysis,
                default=FALSE)
            private$..splitting_criterion <- jmvcore::OptionList$new(
                "splitting_criterion",
                splitting_criterion,
                options=list(
                    "gini",
                    "information"),
                default="gini")
            private$..surrogate_splits <- jmvcore::OptionBool$new(
                "surrogate_splits",
                surrogate_splits,
                default=TRUE)
            private$..max_surrogate <- jmvcore::OptionInteger$new(
                "max_surrogate",
                max_surrogate,
                default=5,
                min=0,
                max=10)
            private$..competing_splits <- jmvcore::OptionInteger$new(
                "competing_splits",
                competing_splits,
                default=4,
                min=0,
                max=10)
            private$..cost_sensitive <- jmvcore::OptionBool$new(
                "cost_sensitive",
                cost_sensitive,
                default=FALSE)
            private$..clinical_loss_preset <- jmvcore::OptionList$new(
                "clinical_loss_preset",
                clinical_loss_preset,
                options=list(
                    "equal",
                    "screening",
                    "diagnosis",
                    "custom"),
                default="equal")
            private$..fn_fp_cost_ratio <- jmvcore::OptionNumber$new(
                "fn_fp_cost_ratio",
                fn_fp_cost_ratio,
                default=2,
                min=0.1,
                max=10)
            private$..prevalence_adjustment <- jmvcore::OptionBool$new(
                "prevalence_adjustment",
                prevalence_adjustment,
                default=FALSE)
            private$..population_prevalence <- jmvcore::OptionNumber$new(
                "population_prevalence",
                population_prevalence,
                default=10,
                min=0.1,
                max=50)
            private$..feature_selection <- jmvcore::OptionBool$new(
                "feature_selection",
                feature_selection,
                default=FALSE)
            private$..feature_selection_method <- jmvcore::OptionList$new(
                "feature_selection_method",
                feature_selection_method,
                options=list(
                    "rfe",
                    "boruta",
                    "importance"),
                default="rfe")
            private$..max_features <- jmvcore::OptionInteger$new(
                "max_features",
                max_features,
                default=10,
                min=2,
                max=50)
            private$..show_tree_plot <- jmvcore::OptionBool$new(
                "show_tree_plot",
                show_tree_plot,
                default=TRUE)
            private$..show_performance_metrics <- jmvcore::OptionBool$new(
                "show_performance_metrics",
                show_performance_metrics,
                default=TRUE)
            private$..show_confusion_matrix <- jmvcore::OptionBool$new(
                "show_confusion_matrix",
                show_confusion_matrix,
                default=TRUE)
            private$..show_importance_plot <- jmvcore::OptionBool$new(
                "show_importance_plot",
                show_importance_plot,
                default=TRUE)
            private$..show_validation_curves <- jmvcore::OptionBool$new(
                "show_validation_curves",
                show_validation_curves,
                default=FALSE)
            private$..show_calibration_plot <- jmvcore::OptionBool$new(
                "show_calibration_plot",
                show_calibration_plot,
                default=FALSE)
            private$..show_roc_curve <- jmvcore::OptionBool$new(
                "show_roc_curve",
                show_roc_curve,
                default=TRUE)
            private$..bootstrap_confidence <- jmvcore::OptionBool$new(
                "bootstrap_confidence",
                bootstrap_confidence,
                default=FALSE)
            private$..n_bootstrap <- jmvcore::OptionInteger$new(
                "n_bootstrap",
                n_bootstrap,
                default=500,
                min=100,
                max=2000)
            private$..clinical_context <- jmvcore::OptionList$new(
                "clinical_context",
                clinical_context,
                options=list(
                    "diagnosis",
                    "screening",
                    "prognosis",
                    "treatment",
                    "risk",
                    "histological"),
                default="diagnosis")
            private$..show_clinical_interpretation <- jmvcore::OptionBool$new(
                "show_clinical_interpretation",
                show_clinical_interpretation,
                default=TRUE)
            private$..clinical_importance_interpretation <- jmvcore::OptionBool$new(
                "clinical_importance_interpretation",
                clinical_importance_interpretation,
                default=TRUE)
            private$..mdg_threshold <- jmvcore::OptionNumber$new(
                "mdg_threshold",
                mdg_threshold,
                default=1,
                min=0.1,
                max=10)
            private$..show_feature_contributions <- jmvcore::OptionBool$new(
                "show_feature_contributions",
                show_feature_contributions,
                default=FALSE)
            private$..survival_integration <- jmvcore::OptionBool$new(
                "survival_integration",
                survival_integration,
                default=FALSE)
            private$..set_seed <- jmvcore::OptionBool$new(
                "set_seed",
                set_seed,
                default=TRUE)
            private$..seed_value <- jmvcore::OptionInteger$new(
                "seed_value",
                seed_value,
                default=42,
                min=1,
                max=999999)

            self$.addOption(private$..vars)
            self$.addOption(private$..facs)
            self$.addOption(private$..target)
            self$.addOption(private$..targetLevel)
            self$.addOption(private$..train)
            self$.addOption(private$..trainLevel)
            self$.addOption(private$..validation)
            self$.addOption(private$..cv_folds)
            self$.addOption(private$..cv_repeats)
            self$.addOption(private$..bootstrap_samples)
            self$.addOption(private$..stratified_sampling)
            self$.addOption(private$..test_split)
            self$.addOption(private$..hyperparameter_tuning)
            self$.addOption(private$..tuning_method)
            self$.addOption(private$..tuning_metric)
            self$.addOption(private$..max_depth_range)
            self$.addOption(private$..cp_range)
            self$.addOption(private$..min_samples_range)
            self$.addOption(private$..pruning_method)
            self$.addOption(private$..custom_cp)
            self$.addOption(private$..auto_prune)
            self$.addOption(private$..show_cp_analysis)
            self$.addOption(private$..splitting_criterion)
            self$.addOption(private$..surrogate_splits)
            self$.addOption(private$..max_surrogate)
            self$.addOption(private$..competing_splits)
            self$.addOption(private$..cost_sensitive)
            self$.addOption(private$..clinical_loss_preset)
            self$.addOption(private$..fn_fp_cost_ratio)
            self$.addOption(private$..prevalence_adjustment)
            self$.addOption(private$..population_prevalence)
            self$.addOption(private$..feature_selection)
            self$.addOption(private$..feature_selection_method)
            self$.addOption(private$..max_features)
            self$.addOption(private$..show_tree_plot)
            self$.addOption(private$..show_performance_metrics)
            self$.addOption(private$..show_confusion_matrix)
            self$.addOption(private$..show_importance_plot)
            self$.addOption(private$..show_validation_curves)
            self$.addOption(private$..show_calibration_plot)
            self$.addOption(private$..show_roc_curve)
            self$.addOption(private$..bootstrap_confidence)
            self$.addOption(private$..n_bootstrap)
            self$.addOption(private$..clinical_context)
            self$.addOption(private$..show_clinical_interpretation)
            self$.addOption(private$..clinical_importance_interpretation)
            self$.addOption(private$..mdg_threshold)
            self$.addOption(private$..show_feature_contributions)
            self$.addOption(private$..survival_integration)
            self$.addOption(private$..set_seed)
            self$.addOption(private$..seed_value)
        }),
    active = list(
        vars = function() private$..vars$value,
        facs = function() private$..facs$value,
        target = function() private$..target$value,
        targetLevel = function() private$..targetLevel$value,
        train = function() private$..train$value,
        trainLevel = function() private$..trainLevel$value,
        validation = function() private$..validation$value,
        cv_folds = function() private$..cv_folds$value,
        cv_repeats = function() private$..cv_repeats$value,
        bootstrap_samples = function() private$..bootstrap_samples$value,
        stratified_sampling = function() private$..stratified_sampling$value,
        test_split = function() private$..test_split$value,
        hyperparameter_tuning = function() private$..hyperparameter_tuning$value,
        tuning_method = function() private$..tuning_method$value,
        tuning_metric = function() private$..tuning_metric$value,
        max_depth_range = function() private$..max_depth_range$value,
        cp_range = function() private$..cp_range$value,
        min_samples_range = function() private$..min_samples_range$value,
        pruning_method = function() private$..pruning_method$value,
        custom_cp = function() private$..custom_cp$value,
        auto_prune = function() private$..auto_prune$value,
        show_cp_analysis = function() private$..show_cp_analysis$value,
        splitting_criterion = function() private$..splitting_criterion$value,
        surrogate_splits = function() private$..surrogate_splits$value,
        max_surrogate = function() private$..max_surrogate$value,
        competing_splits = function() private$..competing_splits$value,
        cost_sensitive = function() private$..cost_sensitive$value,
        clinical_loss_preset = function() private$..clinical_loss_preset$value,
        fn_fp_cost_ratio = function() private$..fn_fp_cost_ratio$value,
        prevalence_adjustment = function() private$..prevalence_adjustment$value,
        population_prevalence = function() private$..population_prevalence$value,
        feature_selection = function() private$..feature_selection$value,
        feature_selection_method = function() private$..feature_selection_method$value,
        max_features = function() private$..max_features$value,
        show_tree_plot = function() private$..show_tree_plot$value,
        show_performance_metrics = function() private$..show_performance_metrics$value,
        show_confusion_matrix = function() private$..show_confusion_matrix$value,
        show_importance_plot = function() private$..show_importance_plot$value,
        show_validation_curves = function() private$..show_validation_curves$value,
        show_calibration_plot = function() private$..show_calibration_plot$value,
        show_roc_curve = function() private$..show_roc_curve$value,
        bootstrap_confidence = function() private$..bootstrap_confidence$value,
        n_bootstrap = function() private$..n_bootstrap$value,
        clinical_context = function() private$..clinical_context$value,
        show_clinical_interpretation = function() private$..show_clinical_interpretation$value,
        clinical_importance_interpretation = function() private$..clinical_importance_interpretation$value,
        mdg_threshold = function() private$..mdg_threshold$value,
        show_feature_contributions = function() private$..show_feature_contributions$value,
        survival_integration = function() private$..survival_integration$value,
        set_seed = function() private$..set_seed$value,
        seed_value = function() private$..seed_value$value),
    private = list(
        ..vars = NA,
        ..facs = NA,
        ..target = NA,
        ..targetLevel = NA,
        ..train = NA,
        ..trainLevel = NA,
        ..validation = NA,
        ..cv_folds = NA,
        ..cv_repeats = NA,
        ..bootstrap_samples = NA,
        ..stratified_sampling = NA,
        ..test_split = NA,
        ..hyperparameter_tuning = NA,
        ..tuning_method = NA,
        ..tuning_metric = NA,
        ..max_depth_range = NA,
        ..cp_range = NA,
        ..min_samples_range = NA,
        ..pruning_method = NA,
        ..custom_cp = NA,
        ..auto_prune = NA,
        ..show_cp_analysis = NA,
        ..splitting_criterion = NA,
        ..surrogate_splits = NA,
        ..max_surrogate = NA,
        ..competing_splits = NA,
        ..cost_sensitive = NA,
        ..clinical_loss_preset = NA,
        ..fn_fp_cost_ratio = NA,
        ..prevalence_adjustment = NA,
        ..population_prevalence = NA,
        ..feature_selection = NA,
        ..feature_selection_method = NA,
        ..max_features = NA,
        ..show_tree_plot = NA,
        ..show_performance_metrics = NA,
        ..show_confusion_matrix = NA,
        ..show_importance_plot = NA,
        ..show_validation_curves = NA,
        ..show_calibration_plot = NA,
        ..show_roc_curve = NA,
        ..bootstrap_confidence = NA,
        ..n_bootstrap = NA,
        ..clinical_context = NA,
        ..show_clinical_interpretation = NA,
        ..clinical_importance_interpretation = NA,
        ..mdg_threshold = NA,
        ..show_feature_contributions = NA,
        ..survival_integration = NA,
        ..set_seed = NA,
        ..seed_value = NA)
)

treeadvancedResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "treeadvancedResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        modelsummary = function() private$.items[["modelsummary"]],
        tuningresults = function() private$.items[["tuningresults"]],
        performancetable = function() private$.items[["performancetable"]],
        confusionmatrix = function() private$.items[["confusionmatrix"]],
        variableimportance = function() private$.items[["variableimportance"]],
        treeplot = function() private$.items[["treeplot"]],
        importanceplot = function() private$.items[["importanceplot"]],
        validationcurves = function() private$.items[["validationcurves"]],
        calibrationplot = function() private$.items[["calibrationplot"]],
        roccurve = function() private$.items[["roccurve"]],
        clinicalinterpretation = function() private$.items[["clinicalinterpretation"]],
        clinicalimportance = function() private$.items[["clinicalimportance"]],
        featurecontributions = function() private$.items[["featurecontributions"]],
        survivalintegration = function() private$.items[["survivalintegration"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Advanced Clinical Decision Trees",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "rpart",
                    "rpart.plot",
                    "caret",
                    "pROC",
                    "randomForest",
                    "Boruta",
                    "ggplot2",
                    "stats"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=FALSE))
            self$add(jmvcore::Html$new(
                options=options,
                name="modelsummary",
                title="Model Summary",
                visible="(show_performance_metrics)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "validation",
                    "hyperparameter_tuning",
                    "cost_sensitive",
                    "clinical_loss_preset",
                    "prevalence_adjustment",
                    "feature_selection",
                    "feature_selection_method")))
            self$add(jmvcore::Html$new(
                options=options,
                name="tuningresults",
                title="Hyperparameter Tuning Results",
                visible="(hyperparameter_tuning)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "tuning_method",
                    "tuning_metric",
                    "max_depth_range",
                    "cp_range",
                    "min_samples_range",
                    "cost_sensitive")))
            self$add(jmvcore::Table$new(
                options=options,
                name="performancetable",
                title="Performance Metrics",
                visible="(show_performance_metrics)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "validation",
                    "hyperparameter_tuning",
                    "cost_sensitive",
                    "clinical_loss_preset",
                    "prevalence_adjustment"),
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="confusionmatrix",
                title="Confusion Matrix",
                visible="(show_confusion_matrix)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "validation"),
                columns=list(
                    list(
                        `name`="actual", 
                        `title`="Actual", 
                        `type`="text"),
                    list(
                        `name`="predictednegative", 
                        `title`="Predicted Negative", 
                        `type`="integer"),
                    list(
                        `name`="predictedpositive", 
                        `title`="Predicted Positive", 
                        `type`="integer"),
                    list(
                        `name`="total", 
                        `title`="Total", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="variableimportance",
                title="Variable Importance",
                visible="(show_importance_plot)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "feature_selection"),
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="importance", 
                        `title`="Importance", 
                        `type`="number"),
                    list(
                        `name`="rank", 
                        `title`="Rank", 
                        `type`="integer"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="treeplot",
                title="Advanced Decision Tree",
                width=900,
                height=700,
                renderFun=".tree_plot",
                visible="(show_tree_plot)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "hyperparameter_tuning",
                    "max_depth_range",
                    "cp_range")))
            self$add(jmvcore::Image$new(
                options=options,
                name="importanceplot",
                title="Variable Importance Plot",
                width=700,
                height=500,
                renderFun=".importance_plot",
                visible="(show_importance_plot)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "feature_selection")))
            self$add(jmvcore::Image$new(
                options=options,
                name="validationcurves",
                title="Validation Curves",
                width=800,
                height=600,
                renderFun=".validation_curves_plot",
                visible="(show_validation_curves)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "hyperparameter_tuning")))
            self$add(jmvcore::Image$new(
                options=options,
                name="calibrationplot",
                title="Calibration Plot",
                width=600,
                height=500,
                renderFun=".calibration_plot",
                visible="(show_calibration_plot)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel")))
            self$add(jmvcore::Image$new(
                options=options,
                name="roccurve",
                title="ROC Curve",
                width=600,
                height=500,
                renderFun=".roc_plot",
                visible="(show_roc_curve)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel")))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalinterpretation",
                title="Clinical Interpretation",
                visible="(show_clinical_interpretation)",
                clearWith=list(
                    "clinical_context",
                    "target",
                    "targetLevel")))
            self$add(jmvcore::Table$new(
                options=options,
                name="clinicalimportance",
                title="Clinical Variable Importance Analysis",
                visible="(clinical_importance_interpretation)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel"),
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="mdg", 
                        `title`="Mean Decrease Gini", 
                        `type`="number", 
                        `format`="zto,p:.3"),
                    list(
                        `name`="clinical_significance", 
                        `title`="Clinical Significance", 
                        `type`="text"),
                    list(
                        `name`="interpretation", 
                        `title`="Clinical Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="featurecontributions",
                title="Feature Contribution Analysis",
                visible="(show_feature_contributions)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel"),
                columns=list(
                    list(
                        `name`="feature", 
                        `title`="Feature", 
                        `type`="text"),
                    list(
                        `name`="contribution_positive", 
                        `title`="Contribution to Positive Class", 
                        `type`="number", 
                        `format`="zto,p:.3"),
                    list(
                        `name`="contribution_negative", 
                        `title`="Contribution to Negative Class", 
                        `type`="number", 
                        `format`="zto,p:.3"),
                    list(
                        `name`="net_contribution", 
                        `title`="Net Contribution", 
                        `type`="number", 
                        `format`="zto,p:.3"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="survivalintegration",
                title="Survival Integration Results",
                visible="(survival_integration)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel")))}))

treeadvancedBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "treeadvancedBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "treeadvanced",
                version = c(0,0,31),
                options = options,
                results = treeadvancedResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Advanced Clinical Decision Trees
#'
#' Advanced decision tree analysis with enhanced CART algorithm, comprehensive
#' validation methods, hyperparameter tuning, and detailed clinical 
#' performance
#' assessment for medical research and clinical decision support.
#' 
#'
#' @examples
#' # Advanced analysis with hyperparameter tuning
#' tree_advanced(
#'     data = clinical_data,
#'     vars = c("biomarker1", "biomarker2", "age"),
#'     facs = c("grade", "stage"),
#'     target = "outcome",
#'     targetLevel = "positive",
#'     validation = "repeated_cv",
#'     hyperparameter_tuning = TRUE,
#'     show_cp_analysis = TRUE,
#'     cost_sensitive = TRUE
#' )
#'
#' @param data The data as a data frame for advanced tree analysis.
#' @param vars .
#' @param facs .
#' @param target .
#' @param targetLevel .
#' @param train .
#' @param trainLevel .
#' @param validation .
#' @param cv_folds .
#' @param cv_repeats .
#' @param bootstrap_samples .
#' @param stratified_sampling .
#' @param test_split .
#' @param hyperparameter_tuning .
#' @param tuning_method .
#' @param tuning_metric .
#' @param max_depth_range .
#' @param cp_range .
#' @param min_samples_range .
#' @param pruning_method .
#' @param custom_cp .
#' @param auto_prune .
#' @param show_cp_analysis .
#' @param splitting_criterion .
#' @param surrogate_splits .
#' @param max_surrogate .
#' @param competing_splits .
#' @param cost_sensitive .
#' @param clinical_loss_preset .
#' @param fn_fp_cost_ratio .
#' @param prevalence_adjustment .
#' @param population_prevalence .
#' @param feature_selection .
#' @param feature_selection_method .
#' @param max_features .
#' @param show_tree_plot .
#' @param show_performance_metrics .
#' @param show_confusion_matrix .
#' @param show_importance_plot .
#' @param show_validation_curves .
#' @param show_calibration_plot .
#' @param show_roc_curve .
#' @param bootstrap_confidence .
#' @param n_bootstrap .
#' @param clinical_context .
#' @param show_clinical_interpretation .
#' @param clinical_importance_interpretation .
#' @param mdg_threshold .
#' @param show_feature_contributions .
#' @param survival_integration .
#' @param set_seed .
#' @param seed_value .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelsummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$tuningresults} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$performancetable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$confusionmatrix} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$variableimportance} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$treeplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$importanceplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$validationcurves} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$calibrationplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$roccurve} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$clinicalinterpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$clinicalimportance} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$featurecontributions} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$survivalintegration} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$performancetable$asDF}
#'
#' \code{as.data.frame(results$performancetable)}
#'
#' @export
treeadvanced <- function(
    data,
    vars = NULL,
    facs = NULL,
    target,
    targetLevel,
    train = NULL,
    trainLevel,
    validation = "repeated_cv",
    cv_folds = 5,
    cv_repeats = 3,
    bootstrap_samples = 200,
    stratified_sampling = TRUE,
    test_split = 0.25,
    hyperparameter_tuning = FALSE,
    tuning_method = "grid",
    tuning_metric = "bacc",
    max_depth_range = "3:8",
    cp_range = "0.001:0.1",
    min_samples_range = "10:50",
    pruning_method = "one_se",
    custom_cp = 0.01,
    auto_prune = TRUE,
    show_cp_analysis = FALSE,
    splitting_criterion = "gini",
    surrogate_splits = TRUE,
    max_surrogate = 5,
    competing_splits = 4,
    cost_sensitive = FALSE,
    clinical_loss_preset = "equal",
    fn_fp_cost_ratio = 2,
    prevalence_adjustment = FALSE,
    population_prevalence = 10,
    feature_selection = FALSE,
    feature_selection_method = "rfe",
    max_features = 10,
    show_tree_plot = TRUE,
    show_performance_metrics = TRUE,
    show_confusion_matrix = TRUE,
    show_importance_plot = TRUE,
    show_validation_curves = FALSE,
    show_calibration_plot = FALSE,
    show_roc_curve = TRUE,
    bootstrap_confidence = FALSE,
    n_bootstrap = 500,
    clinical_context = "diagnosis",
    show_clinical_interpretation = TRUE,
    clinical_importance_interpretation = TRUE,
    mdg_threshold = 1,
    show_feature_contributions = FALSE,
    survival_integration = FALSE,
    set_seed = TRUE,
    seed_value = 42) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("treeadvanced requires jmvcore to be installed (restart may be required)")

    if ( ! missing(vars)) vars <- jmvcore::resolveQuo(jmvcore::enquo(vars))
    if ( ! missing(facs)) facs <- jmvcore::resolveQuo(jmvcore::enquo(facs))
    if ( ! missing(target)) target <- jmvcore::resolveQuo(jmvcore::enquo(target))
    if ( ! missing(train)) train <- jmvcore::resolveQuo(jmvcore::enquo(train))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(vars), vars, NULL),
            `if`( ! missing(facs), facs, NULL),
            `if`( ! missing(target), target, NULL),
            `if`( ! missing(train), train, NULL))

    for (v in facs) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in target) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in train) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- treeadvancedOptions$new(
        vars = vars,
        facs = facs,
        target = target,
        targetLevel = targetLevel,
        train = train,
        trainLevel = trainLevel,
        validation = validation,
        cv_folds = cv_folds,
        cv_repeats = cv_repeats,
        bootstrap_samples = bootstrap_samples,
        stratified_sampling = stratified_sampling,
        test_split = test_split,
        hyperparameter_tuning = hyperparameter_tuning,
        tuning_method = tuning_method,
        tuning_metric = tuning_metric,
        max_depth_range = max_depth_range,
        cp_range = cp_range,
        min_samples_range = min_samples_range,
        pruning_method = pruning_method,
        custom_cp = custom_cp,
        auto_prune = auto_prune,
        show_cp_analysis = show_cp_analysis,
        splitting_criterion = splitting_criterion,
        surrogate_splits = surrogate_splits,
        max_surrogate = max_surrogate,
        competing_splits = competing_splits,
        cost_sensitive = cost_sensitive,
        clinical_loss_preset = clinical_loss_preset,
        fn_fp_cost_ratio = fn_fp_cost_ratio,
        prevalence_adjustment = prevalence_adjustment,
        population_prevalence = population_prevalence,
        feature_selection = feature_selection,
        feature_selection_method = feature_selection_method,
        max_features = max_features,
        show_tree_plot = show_tree_plot,
        show_performance_metrics = show_performance_metrics,
        show_confusion_matrix = show_confusion_matrix,
        show_importance_plot = show_importance_plot,
        show_validation_curves = show_validation_curves,
        show_calibration_plot = show_calibration_plot,
        show_roc_curve = show_roc_curve,
        bootstrap_confidence = bootstrap_confidence,
        n_bootstrap = n_bootstrap,
        clinical_context = clinical_context,
        show_clinical_interpretation = show_clinical_interpretation,
        clinical_importance_interpretation = clinical_importance_interpretation,
        mdg_threshold = mdg_threshold,
        show_feature_contributions = show_feature_contributions,
        survival_integration = survival_integration,
        set_seed = set_seed,
        seed_value = seed_value)

    analysis <- treeadvancedClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

