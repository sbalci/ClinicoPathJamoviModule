
# This file is automatically generated, you probably don't want to edit this

clinicalheatmapOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinicalheatmapOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            rowVar = NULL,
            colVar = NULL,
            valueVar = NULL,
            annotationCols = NULL,
            annotationRows = NULL,
            scaleMethod = "none",
            clusterRows = TRUE,
            clusterCols = TRUE,
            colorPalette = "viridis",
            showRownames = TRUE,
            showColnames = TRUE,
            naHandling = "exclude",
            showDataSummary = TRUE,
            showInterpretation = TRUE,
            exportWidth = 8,
            exportHeight = 6, ...) {

            super$initialize(
                package="ClinicoPath",
                name="clinicalheatmap",
                requiresData=TRUE,
                ...)

            private$..rowVar <- jmvcore::OptionVariable$new(
                "rowVar",
                rowVar,
                suggested=list(
                    "ordinal",
                    "nominal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..colVar <- jmvcore::OptionVariable$new(
                "colVar",
                colVar,
                suggested=list(
                    "ordinal",
                    "nominal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..valueVar <- jmvcore::OptionVariable$new(
                "valueVar",
                valueVar,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..annotationCols <- jmvcore::OptionVariables$new(
                "annotationCols",
                annotationCols,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..annotationRows <- jmvcore::OptionVariables$new(
                "annotationRows",
                annotationRows,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..scaleMethod <- jmvcore::OptionList$new(
                "scaleMethod",
                scaleMethod,
                options=list(
                    "none",
                    "row",
                    "column",
                    "both"),
                default="none")
            private$..clusterRows <- jmvcore::OptionBool$new(
                "clusterRows",
                clusterRows,
                default=TRUE)
            private$..clusterCols <- jmvcore::OptionBool$new(
                "clusterCols",
                clusterCols,
                default=TRUE)
            private$..colorPalette <- jmvcore::OptionList$new(
                "colorPalette",
                colorPalette,
                options=list(
                    "viridis",
                    "plasma",
                    "inferno",
                    "RdYlBu",
                    "RdBu",
                    "Blues",
                    "Reds"),
                default="viridis")
            private$..showRownames <- jmvcore::OptionBool$new(
                "showRownames",
                showRownames,
                default=TRUE)
            private$..showColnames <- jmvcore::OptionBool$new(
                "showColnames",
                showColnames,
                default=TRUE)
            private$..naHandling <- jmvcore::OptionList$new(
                "naHandling",
                naHandling,
                options=list(
                    "exclude",
                    "mean",
                    "median",
                    "zero"),
                default="exclude")
            private$..showDataSummary <- jmvcore::OptionBool$new(
                "showDataSummary",
                showDataSummary,
                default=TRUE)
            private$..showInterpretation <- jmvcore::OptionBool$new(
                "showInterpretation",
                showInterpretation,
                default=TRUE)
            private$..exportWidth <- jmvcore::OptionNumber$new(
                "exportWidth",
                exportWidth,
                min=3,
                max=20,
                default=8)
            private$..exportHeight <- jmvcore::OptionNumber$new(
                "exportHeight",
                exportHeight,
                min=3,
                max=20,
                default=6)

            self$.addOption(private$..rowVar)
            self$.addOption(private$..colVar)
            self$.addOption(private$..valueVar)
            self$.addOption(private$..annotationCols)
            self$.addOption(private$..annotationRows)
            self$.addOption(private$..scaleMethod)
            self$.addOption(private$..clusterRows)
            self$.addOption(private$..clusterCols)
            self$.addOption(private$..colorPalette)
            self$.addOption(private$..showRownames)
            self$.addOption(private$..showColnames)
            self$.addOption(private$..naHandling)
            self$.addOption(private$..showDataSummary)
            self$.addOption(private$..showInterpretation)
            self$.addOption(private$..exportWidth)
            self$.addOption(private$..exportHeight)
        }),
    active = list(
        rowVar = function() private$..rowVar$value,
        colVar = function() private$..colVar$value,
        valueVar = function() private$..valueVar$value,
        annotationCols = function() private$..annotationCols$value,
        annotationRows = function() private$..annotationRows$value,
        scaleMethod = function() private$..scaleMethod$value,
        clusterRows = function() private$..clusterRows$value,
        clusterCols = function() private$..clusterCols$value,
        colorPalette = function() private$..colorPalette$value,
        showRownames = function() private$..showRownames$value,
        showColnames = function() private$..showColnames$value,
        naHandling = function() private$..naHandling$value,
        showDataSummary = function() private$..showDataSummary$value,
        showInterpretation = function() private$..showInterpretation$value,
        exportWidth = function() private$..exportWidth$value,
        exportHeight = function() private$..exportHeight$value),
    private = list(
        ..rowVar = NA,
        ..colVar = NA,
        ..valueVar = NA,
        ..annotationCols = NA,
        ..annotationRows = NA,
        ..scaleMethod = NA,
        ..clusterRows = NA,
        ..clusterCols = NA,
        ..colorPalette = NA,
        ..showRownames = NA,
        ..showColnames = NA,
        ..naHandling = NA,
        ..showDataSummary = NA,
        ..showInterpretation = NA,
        ..exportWidth = NA,
        ..exportHeight = NA)
)

clinicalheatmapResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinicalheatmapResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        aboutAnalysis = function() private$.items[["aboutAnalysis"]],
        dataSummary = function() private$.items[["dataSummary"]],
        heatmap = function() private$.items[["heatmap"]],
        annotations = function() private$.items[["annotations"]],
        interpretation = function() private$.items[["interpretation"]],
        clinicalSummary = function() private$.items[["clinicalSummary"]],
        reportSentences = function() private$.items[["reportSentences"]],
        assumptions = function() private$.items[["assumptions"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Clinical Heatmap")
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Instructions",
                visible=TRUE,
                clearWith=list()))
            self$add(jmvcore::Html$new(
                options=options,
                name="aboutAnalysis",
                title="About This Analysis",
                visible=TRUE,
                clearWith=list()))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    dataStructure = function() private$.items[["dataStructure"]],
                    valueSummary = function() private$.items[["valueSummary"]],
                    missingData = function() private$.items[["missingData"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="dataSummary",
                            title="Data Summary")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="dataStructure",
                            title="Data Structure",
                            columns=list(
                                list(
                                    `name`="dimension", 
                                    `title`="Dimension", 
                                    `type`="text"),
                                list(
                                    `name`="value", 
                                    `title`="Value", 
                                    `type`="text")),
                            clearWith=list()))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="valueSummary",
                            title="Value Variable Summary",
                            columns=list(
                                list(
                                    `name`="statistic", 
                                    `title`="Statistic", 
                                    `type`="text"),
                                list(
                                    `name`="value", 
                                    `title`="Value", 
                                    `type`="number")),
                            clearWith=list()))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="missingData",
                            title="Missing Data Report",
                            columns=list(
                                list(
                                    `name`="variable", 
                                    `title`="Variable", 
                                    `type`="text"),
                                list(
                                    `name`="missing_count", 
                                    `title`="Missing Count", 
                                    `type`="integer"),
                                list(
                                    `name`="missing_pct", 
                                    `title`="Missing %", 
                                    `type`="number")),
                            clearWith=list()))}))$new(options=options))
            self$add(jmvcore::Image$new(
                options=options,
                name="heatmap",
                title="Clinical Heatmap",
                width=800,
                height=600,
                renderFun=".plotHeatmap",
                visible=TRUE,
                clearWith=list()))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    columnAnnotations = function() private$.items[["columnAnnotations"]],
                    rowAnnotations = function() private$.items[["rowAnnotations"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="annotations",
                            title="Annotation Summary")
                        self$add(jmvcore::Html$new(
                            options=options,
                            name="columnAnnotations",
                            title="Column Annotations",
                            visible="(annotationCols)",
                            clearWith=list()))
                        self$add(jmvcore::Html$new(
                            options=options,
                            name="rowAnnotations",
                            title="Row Annotations",
                            visible="(annotationRows)",
                            clearWith=list()))}))$new(options=options))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Interpretation Guide",
                visible="(showInterpretation)",
                clearWith=list()))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalSummary",
                title="Clinical Summary",
                visible=TRUE,
                clearWith=list()))
            self$add(jmvcore::Html$new(
                options=options,
                name="reportSentences",
                title="Report Sentences",
                visible=TRUE,
                clearWith=list()))
            self$add(jmvcore::Html$new(
                options=options,
                name="assumptions",
                title="Assumptions & Notes",
                visible=TRUE,
                clearWith=list()))}))

clinicalheatmapBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinicalheatmapBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "clinicalheatmap",
                version = c(0,0,31),
                options = options,
                results = clinicalheatmapResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Clinical Heatmap
#'
#' 
#' @param data The dataset as a data frame containing the variables for
#'   analysis.
#' @param rowVar A string naming the variable from \code{data} that will
#'   define the heatmap rows (e.g., patient IDs, gene names).
#' @param colVar A string naming the variable from \code{data} that will
#'   define the heatmap columns (e.g., biomarkers, time points).
#' @param valueVar A string naming the numeric variable from \code{data} that
#'   will be visualized in the heatmap.
#' @param annotationCols Optional variables to use as column annotations
#'   (e.g., treatment groups, clinical stages).
#' @param annotationRows Optional variables to use as row annotations (e.g.,
#'   patient characteristics, gene families).
#' @param scaleMethod Method for scaling the data values before visualization.
#' @param clusterRows Whether to perform hierarchical clustering on rows.
#' @param clusterCols Whether to perform hierarchical clustering on columns.
#' @param colorPalette Color palette for the heatmap visualization.
#' @param showRownames Whether to display row names in the heatmap.
#' @param showColnames Whether to display column names in the heatmap.
#' @param naHandling How to handle missing values in the data.
#' @param showDataSummary Display a summary of the data structure and values.
#' @param showInterpretation Display interpretation guidelines and clinical
#'   context.
#' @param exportWidth Width of exported heatmap in inches.
#' @param exportHeight Height of exported heatmap in inches.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$aboutAnalysis} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$dataSummary$dataStructure} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$dataSummary$valueSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$dataSummary$missingData} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$heatmap} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$annotations$columnAnnotations} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$annotations$rowAnnotations} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$clinicalSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$reportSentences} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$assumptions} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' @export
clinicalheatmap <- function(
    data,
    rowVar,
    colVar,
    valueVar,
    annotationCols,
    annotationRows,
    scaleMethod = "none",
    clusterRows = TRUE,
    clusterCols = TRUE,
    colorPalette = "viridis",
    showRownames = TRUE,
    showColnames = TRUE,
    naHandling = "exclude",
    showDataSummary = TRUE,
    showInterpretation = TRUE,
    exportWidth = 8,
    exportHeight = 6) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("clinicalheatmap requires jmvcore to be installed (restart may be required)")

    if ( ! missing(rowVar)) rowVar <- jmvcore::resolveQuo(jmvcore::enquo(rowVar))
    if ( ! missing(colVar)) colVar <- jmvcore::resolveQuo(jmvcore::enquo(colVar))
    if ( ! missing(valueVar)) valueVar <- jmvcore::resolveQuo(jmvcore::enquo(valueVar))
    if ( ! missing(annotationCols)) annotationCols <- jmvcore::resolveQuo(jmvcore::enquo(annotationCols))
    if ( ! missing(annotationRows)) annotationRows <- jmvcore::resolveQuo(jmvcore::enquo(annotationRows))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(rowVar), rowVar, NULL),
            `if`( ! missing(colVar), colVar, NULL),
            `if`( ! missing(valueVar), valueVar, NULL),
            `if`( ! missing(annotationCols), annotationCols, NULL),
            `if`( ! missing(annotationRows), annotationRows, NULL))

    for (v in annotationCols) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in annotationRows) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- clinicalheatmapOptions$new(
        rowVar = rowVar,
        colVar = colVar,
        valueVar = valueVar,
        annotationCols = annotationCols,
        annotationRows = annotationRows,
        scaleMethod = scaleMethod,
        clusterRows = clusterRows,
        clusterCols = clusterCols,
        colorPalette = colorPalette,
        showRownames = showRownames,
        showColnames = showColnames,
        naHandling = naHandling,
        showDataSummary = showDataSummary,
        showInterpretation = showInterpretation,
        exportWidth = exportWidth,
        exportHeight = exportHeight)

    analysis <- clinicalheatmapClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

