
# This file is automatically generated, you probably don't want to edit this

phevalOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "phevalOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            outcome = NULL,
            covariates = NULL,
            outcomeLevel = "1",
            test_schoenfeld = TRUE,
            test_scaled_schoenfeld = TRUE,
            test_global = TRUE,
            test_correlation = FALSE,
            test_logrank = FALSE,
            test_supremum = FALSE,
            time_transform = "identity",
            confidence_level = 0.95,
            rho_parameter = 0,
            global_test_method = "chisquare",
            stratify_variable = NULL,
            show_individual_tests = TRUE,
            show_global_tests = TRUE,
            show_residual_plots = TRUE,
            show_diagnostic_plots = TRUE,
            show_time_varying_plots = TRUE,
            show_model_summary = TRUE,
            show_recommendations = TRUE,
            showSummaries = FALSE,
            showExplanations = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="pheval",
                requiresData=TRUE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..outcomeLevel <- jmvcore::OptionString$new(
                "outcomeLevel",
                outcomeLevel,
                default="1")
            private$..test_schoenfeld <- jmvcore::OptionBool$new(
                "test_schoenfeld",
                test_schoenfeld,
                default=TRUE)
            private$..test_scaled_schoenfeld <- jmvcore::OptionBool$new(
                "test_scaled_schoenfeld",
                test_scaled_schoenfeld,
                default=TRUE)
            private$..test_global <- jmvcore::OptionBool$new(
                "test_global",
                test_global,
                default=TRUE)
            private$..test_correlation <- jmvcore::OptionBool$new(
                "test_correlation",
                test_correlation,
                default=FALSE)
            private$..test_logrank <- jmvcore::OptionBool$new(
                "test_logrank",
                test_logrank,
                default=FALSE)
            private$..test_supremum <- jmvcore::OptionBool$new(
                "test_supremum",
                test_supremum,
                default=FALSE)
            private$..time_transform <- jmvcore::OptionList$new(
                "time_transform",
                time_transform,
                options=list(
                    "identity",
                    "log",
                    "rank",
                    "kaplan_meier"),
                default="identity")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..rho_parameter <- jmvcore::OptionNumber$new(
                "rho_parameter",
                rho_parameter,
                min=0,
                max=2,
                default=0)
            private$..global_test_method <- jmvcore::OptionList$new(
                "global_test_method",
                global_test_method,
                options=list(
                    "chisquare",
                    "kolmogorov",
                    "cvm"),
                default="chisquare")
            private$..stratify_variable <- jmvcore::OptionVariable$new(
                "stratify_variable",
                stratify_variable,
                permitted=list(
                    "factor",
                    "numeric"))
            private$..show_individual_tests <- jmvcore::OptionBool$new(
                "show_individual_tests",
                show_individual_tests,
                default=TRUE)
            private$..show_global_tests <- jmvcore::OptionBool$new(
                "show_global_tests",
                show_global_tests,
                default=TRUE)
            private$..show_residual_plots <- jmvcore::OptionBool$new(
                "show_residual_plots",
                show_residual_plots,
                default=TRUE)
            private$..show_diagnostic_plots <- jmvcore::OptionBool$new(
                "show_diagnostic_plots",
                show_diagnostic_plots,
                default=TRUE)
            private$..show_time_varying_plots <- jmvcore::OptionBool$new(
                "show_time_varying_plots",
                show_time_varying_plots,
                default=TRUE)
            private$..show_model_summary <- jmvcore::OptionBool$new(
                "show_model_summary",
                show_model_summary,
                default=TRUE)
            private$..show_recommendations <- jmvcore::OptionBool$new(
                "show_recommendations",
                show_recommendations,
                default=TRUE)
            private$..showSummaries <- jmvcore::OptionBool$new(
                "showSummaries",
                showSummaries,
                default=FALSE)
            private$..showExplanations <- jmvcore::OptionBool$new(
                "showExplanations",
                showExplanations,
                default=FALSE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..outcome)
            self$.addOption(private$..covariates)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..test_schoenfeld)
            self$.addOption(private$..test_scaled_schoenfeld)
            self$.addOption(private$..test_global)
            self$.addOption(private$..test_correlation)
            self$.addOption(private$..test_logrank)
            self$.addOption(private$..test_supremum)
            self$.addOption(private$..time_transform)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..rho_parameter)
            self$.addOption(private$..global_test_method)
            self$.addOption(private$..stratify_variable)
            self$.addOption(private$..show_individual_tests)
            self$.addOption(private$..show_global_tests)
            self$.addOption(private$..show_residual_plots)
            self$.addOption(private$..show_diagnostic_plots)
            self$.addOption(private$..show_time_varying_plots)
            self$.addOption(private$..show_model_summary)
            self$.addOption(private$..show_recommendations)
            self$.addOption(private$..showSummaries)
            self$.addOption(private$..showExplanations)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        outcome = function() private$..outcome$value,
        covariates = function() private$..covariates$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        test_schoenfeld = function() private$..test_schoenfeld$value,
        test_scaled_schoenfeld = function() private$..test_scaled_schoenfeld$value,
        test_global = function() private$..test_global$value,
        test_correlation = function() private$..test_correlation$value,
        test_logrank = function() private$..test_logrank$value,
        test_supremum = function() private$..test_supremum$value,
        time_transform = function() private$..time_transform$value,
        confidence_level = function() private$..confidence_level$value,
        rho_parameter = function() private$..rho_parameter$value,
        global_test_method = function() private$..global_test_method$value,
        stratify_variable = function() private$..stratify_variable$value,
        show_individual_tests = function() private$..show_individual_tests$value,
        show_global_tests = function() private$..show_global_tests$value,
        show_residual_plots = function() private$..show_residual_plots$value,
        show_diagnostic_plots = function() private$..show_diagnostic_plots$value,
        show_time_varying_plots = function() private$..show_time_varying_plots$value,
        show_model_summary = function() private$..show_model_summary$value,
        show_recommendations = function() private$..show_recommendations$value,
        showSummaries = function() private$..showSummaries$value,
        showExplanations = function() private$..showExplanations$value),
    private = list(
        ..elapsedtime = NA,
        ..outcome = NA,
        ..covariates = NA,
        ..outcomeLevel = NA,
        ..test_schoenfeld = NA,
        ..test_scaled_schoenfeld = NA,
        ..test_global = NA,
        ..test_correlation = NA,
        ..test_logrank = NA,
        ..test_supremum = NA,
        ..time_transform = NA,
        ..confidence_level = NA,
        ..rho_parameter = NA,
        ..global_test_method = NA,
        ..stratify_variable = NA,
        ..show_individual_tests = NA,
        ..show_global_tests = NA,
        ..show_residual_plots = NA,
        ..show_diagnostic_plots = NA,
        ..show_time_varying_plots = NA,
        ..show_model_summary = NA,
        ..show_recommendations = NA,
        ..showSummaries = NA,
        ..showExplanations = NA)
)

phevalResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "phevalResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        modelSummary = function() private$.items[["modelSummary"]],
        individualTests = function() private$.items[["individualTests"]],
        globalTests = function() private$.items[["globalTests"]],
        residualAnalysis = function() private$.items[["residualAnalysis"]],
        stratifiedResults = function() private$.items[["stratifiedResults"]],
        powerAnalysis = function() private$.items[["powerAnalysis"]],
        residualPlots = function() private$.items[["residualPlots"]],
        diagnosticPlots = function() private$.items[["diagnosticPlots"]],
        timeVaryingPlots = function() private$.items[["timeVaryingPlots"]],
        globalTestPlots = function() private$.items[["globalTestPlots"]],
        stratifiedPlots = function() private$.items[["stratifiedPlots"]],
        recommendations = function() private$.items[["recommendations"]],
        analysisSummary = function() private$.items[["analysisSummary"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Proportional Hazards Testing",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "survival",
                    "tools"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="modelSummary",
                title="Cox Model Summary",
                visible="(show_model_summary)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="individualTests",
                title="Individual Covariate Tests",
                visible="(show_individual_tests)",
                columns=list(
                    list(
                        `name`="covariate", 
                        `title`="Covariate", 
                        `type`="text"),
                    list(
                        `name`="test_method", 
                        `title`="Test Method", 
                        `type`="text"),
                    list(
                        `name`="test_statistic", 
                        `title`="Test Statistic", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number"),
                    list(
                        `name`="significance", 
                        `title`="Significance", 
                        `type`="text"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="globalTests",
                title="Global Proportional Hazards Tests",
                visible="(show_global_tests)",
                columns=list(
                    list(
                        `name`="test_name", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="test_statistic", 
                        `title`="Test Statistic", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number"),
                    list(
                        `name`="critical_value", 
                        `title`="Critical Value", 
                        `type`="number"),
                    list(
                        `name`="conclusion", 
                        `title`="Conclusion", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="residualAnalysis",
                title="Schoenfeld Residuals Analysis",
                visible="(show_individual_tests)",
                columns=list(
                    list(
                        `name`="covariate", 
                        `title`="Covariate", 
                        `type`="text"),
                    list(
                        `name`="correlation", 
                        `title`="Time Correlation", 
                        `type`="number"),
                    list(
                        `name`="slope", 
                        `title`="Trend Slope", 
                        `type`="number"),
                    list(
                        `name`="slope_se", 
                        `title`="Slope SE", 
                        `type`="number"),
                    list(
                        `name`="slope_p_value", 
                        `title`="Slope p-value", 
                        `type`="number"),
                    list(
                        `name`="trend_direction", 
                        `title`="Trend Direction", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="stratifiedResults",
                title="Stratified Analysis Results",
                visible="(stratify_variable)",
                columns=list(
                    list(
                        `name`="stratum", 
                        `title`="Stratum", 
                        `type`="text"),
                    list(
                        `name`="covariate", 
                        `title`="Covariate", 
                        `type`="text"),
                    list(
                        `name`="test_statistic", 
                        `title`="Test Statistic", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number"),
                    list(
                        `name`="ph_assumption", 
                        `title`="PH Assumption", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="powerAnalysis",
                title="Test Power Analysis",
                visible="(show_global_tests)",
                columns=list(
                    list(
                        `name`="test_method", 
                        `title`="Test Method", 
                        `type`="text"),
                    list(
                        `name`="sample_size", 
                        `title`="Sample Size", 
                        `type`="integer"),
                    list(
                        `name`="events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="estimated_power", 
                        `title`="Estimated Power", 
                        `type`="number"),
                    list(
                        `name`="minimum_effect", 
                        `title`="Minimum Detectable Effect", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="residualPlots",
                title="Schoenfeld Residual Plots",
                visible="(show_residual_plots)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagnosticPlots",
                title="Diagnostic Plots",
                visible="(show_diagnostic_plots)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="timeVaryingPlots",
                title="Time-Varying Effect Plots",
                visible="(show_time_varying_plots)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="globalTestPlots",
                title="Global Test Visualizations",
                visible="(show_global_tests)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="stratifiedPlots",
                title="Stratified Analysis Plots",
                visible="(stratify_variable)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="recommendations",
                title="Recommendations & Interpretation",
                visible="(show_recommendations)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="analysisSummary",
                title="Analysis Summary",
                visible="(showSummaries)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Methodology",
                visible="(showExplanations)"))}))

phevalBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "phevalBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "pheval",
                version = c(1,0,0),
                options = options,
                results = phevalResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Proportional Hazards Testing
#'
#' Comprehensive testing of the proportional hazards assumption in Cox 
#' regression models using multiple statistical approaches. This analysis 
#' provides systematic validation of the fundamental assumption underlying Cox 
#' proportional hazards models through statistical tests, graphical 
#' diagnostics, and time-dependent coefficient analysis for robust model 
#' assessment and assumption verification.
#'
#' @examples
#' # Example 1: Basic proportional hazards testing
#' library(survival)
#'
#' pheval(
#'     data = lung_data,
#'     elapsedtime = "time",
#'     outcome = "status",
#'     outcomeLevel = "2",
#'     covariates = c("age", "sex", "ph.ecog"),
#'     test_methods = c("schoenfeld", "scaled_schoenfeld")
#' )
#'
#' @param data the data as a data frame
#' @param elapsedtime Survival time or follow-up duration variable
#' @param outcome Event indicator variable (0/1, FALSE/TRUE, or factor)
#' @param covariates Covariate variables for proportional hazards testing
#' @param outcomeLevel Level of outcome variable indicating event occurrence
#' @param test_schoenfeld Perform Schoenfeld residuals test
#' @param test_scaled_schoenfeld Perform scaled Schoenfeld residuals test
#' @param test_global Perform global proportional hazards test
#' @param test_correlation Perform correlation test with time
#' @param test_logrank Perform log-rank trend test
#' @param test_supremum Perform supremum test
#' @param time_transform Transformation function for time in testing
#' @param confidence_level Confidence level for test statistics and intervals
#' @param rho_parameter Rho parameter for weighted residuals (0=unweighted)
#' @param global_test_method Method for global proportional hazards test
#' @param stratify_variable Optional variable for stratified analysis
#' @param show_individual_tests Display individual covariate test results
#' @param show_global_tests Display global proportional hazards tests
#' @param show_residual_plots Display Schoenfeld residual plots
#' @param show_diagnostic_plots Display comprehensive diagnostic plots
#' @param show_time_varying_plots Display plots of potential time-varying
#'   effects
#' @param show_model_summary Display fitted Cox model summary
#' @param show_recommendations Display interpretation recommendations
#' @param showSummaries Generate natural language summaries of the analysis
#'   results
#' @param showExplanations Show detailed explanations of the methodology and
#'   interpretation
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$individualTests} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$globalTests} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$residualAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$stratifiedResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$powerAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$residualPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$diagnosticPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$timeVaryingPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$globalTestPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$stratifiedPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$recommendations} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$analysisSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$individualTests$asDF}
#'
#' \code{as.data.frame(results$individualTests)}
#'
#' @export
pheval <- function(
    data,
    elapsedtime,
    outcome,
    covariates,
    outcomeLevel = "1",
    test_schoenfeld = TRUE,
    test_scaled_schoenfeld = TRUE,
    test_global = TRUE,
    test_correlation = FALSE,
    test_logrank = FALSE,
    test_supremum = FALSE,
    time_transform = "identity",
    confidence_level = 0.95,
    rho_parameter = 0,
    global_test_method = "chisquare",
    stratify_variable,
    show_individual_tests = TRUE,
    show_global_tests = TRUE,
    show_residual_plots = TRUE,
    show_diagnostic_plots = TRUE,
    show_time_varying_plots = TRUE,
    show_model_summary = TRUE,
    show_recommendations = TRUE,
    showSummaries = FALSE,
    showExplanations = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("pheval requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(stratify_variable)) stratify_variable <- jmvcore::resolveQuo(jmvcore::enquo(stratify_variable))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(elapsedtime), elapsedtime, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(covariates), covariates, NULL),
            `if`( ! missing(stratify_variable), stratify_variable, NULL))


    options <- phevalOptions$new(
        elapsedtime = elapsedtime,
        outcome = outcome,
        covariates = covariates,
        outcomeLevel = outcomeLevel,
        test_schoenfeld = test_schoenfeld,
        test_scaled_schoenfeld = test_scaled_schoenfeld,
        test_global = test_global,
        test_correlation = test_correlation,
        test_logrank = test_logrank,
        test_supremum = test_supremum,
        time_transform = time_transform,
        confidence_level = confidence_level,
        rho_parameter = rho_parameter,
        global_test_method = global_test_method,
        stratify_variable = stratify_variable,
        show_individual_tests = show_individual_tests,
        show_global_tests = show_global_tests,
        show_residual_plots = show_residual_plots,
        show_diagnostic_plots = show_diagnostic_plots,
        show_time_varying_plots = show_time_varying_plots,
        show_model_summary = show_model_summary,
        show_recommendations = show_recommendations,
        showSummaries = showSummaries,
        showExplanations = showExplanations)

    analysis <- phevalClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

