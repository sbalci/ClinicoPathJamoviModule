
# This file is automatically generated, you probably don't want to edit this

roc2dOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "roc2dOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            marker1 = NULL,
            marker2 = NULL,
            outcome = NULL,
            positive_level = NULL,
            decision_rule = "linear",
            compare_single_markers = TRUE,
            plot_2d_roc_surface = TRUE,
            plot_threshold_region = TRUE,
            show_interpretation = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="roc2d",
                requiresData=TRUE,
                ...)

            private$..marker1 <- jmvcore::OptionVariable$new(
                "marker1",
                marker1,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..marker2 <- jmvcore::OptionVariable$new(
                "marker2",
                marker2,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..positive_level <- jmvcore::OptionLevel$new(
                "positive_level",
                positive_level,
                variable="(outcome)")
            private$..decision_rule <- jmvcore::OptionList$new(
                "decision_rule",
                decision_rule,
                options=list(
                    "and",
                    "or",
                    "linear",
                    "nonlinear"),
                default="linear")
            private$..compare_single_markers <- jmvcore::OptionBool$new(
                "compare_single_markers",
                compare_single_markers,
                default=TRUE)
            private$..plot_2d_roc_surface <- jmvcore::OptionBool$new(
                "plot_2d_roc_surface",
                plot_2d_roc_surface,
                default=TRUE)
            private$..plot_threshold_region <- jmvcore::OptionBool$new(
                "plot_threshold_region",
                plot_threshold_region,
                default=TRUE)
            private$..show_interpretation <- jmvcore::OptionBool$new(
                "show_interpretation",
                show_interpretation,
                default=TRUE)

            self$.addOption(private$..marker1)
            self$.addOption(private$..marker2)
            self$.addOption(private$..outcome)
            self$.addOption(private$..positive_level)
            self$.addOption(private$..decision_rule)
            self$.addOption(private$..compare_single_markers)
            self$.addOption(private$..plot_2d_roc_surface)
            self$.addOption(private$..plot_threshold_region)
            self$.addOption(private$..show_interpretation)
        }),
    active = list(
        marker1 = function() private$..marker1$value,
        marker2 = function() private$..marker2$value,
        outcome = function() private$..outcome$value,
        positive_level = function() private$..positive_level$value,
        decision_rule = function() private$..decision_rule$value,
        compare_single_markers = function() private$..compare_single_markers$value,
        plot_2d_roc_surface = function() private$..plot_2d_roc_surface$value,
        plot_threshold_region = function() private$..plot_threshold_region$value,
        show_interpretation = function() private$..show_interpretation$value),
    private = list(
        ..marker1 = NA,
        ..marker2 = NA,
        ..outcome = NA,
        ..positive_level = NA,
        ..decision_rule = NA,
        ..compare_single_markers = NA,
        ..plot_2d_roc_surface = NA,
        ..plot_threshold_region = NA,
        ..show_interpretation = NA)
)

roc2dResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "roc2dResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        individualAUCs = function() private$.items[["individualAUCs"]],
        combinationRules = function() private$.items[["combinationRules"]],
        optimalCombination = function() private$.items[["optimalCombination"]],
        roc2dPlot = function() private$.items[["roc2dPlot"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Two-Dimensional ROC Analysis")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="individualAUCs",
                title="Individual Marker Performance",
                rows=0,
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="auc", 
                        `title`="AUC", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower 95% CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper 95% CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="optimal_threshold", 
                        `title`="Optimal Threshold", 
                        `type`="number"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="combinationRules",
                title="Combination Rules Performance",
                rows=0,
                columns=list(
                    list(
                        `name`="combination", 
                        `title`="Combination Rule", 
                        `type`="text"),
                    list(
                        `name`="formula", 
                        `title`="Formula", 
                        `type`="text"),
                    list(
                        `name`="auc", 
                        `title`="AUC", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="clinical_use", 
                        `title`="Clinical Utility", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="optimalCombination",
                title="Optimal Linear Combination",
                rows=1,
                visible="(decision_rule:linear)",
                columns=list(
                    list(
                        `name`="weight1", 
                        `title`="Weight (Marker 1)", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="weight2", 
                        `title`="Weight (Marker 2)", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="auc_optimal", 
                        `title`="Optimized AUC", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="formula", 
                        `title`="Formula", 
                        `type`="text"),
                    list(
                        `name`="improvement", 
                        `title`="Improvement", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="roc2dPlot",
                title="2D ROC Surface",
                width=600,
                height=500,
                renderFun=".plot2DROC",
                visible="(plot_2d_roc_surface)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Interpretation",
                visible="(show_interpretation)"))}))

roc2dBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "roc2dBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "roc2d",
                version = c(0,0,32),
                options = options,
                results = roc2dResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Two-Dimensional ROC Analysis
#'
#' Two-dimensional ROC analysis for evaluating diagnostic accuracy of dual 
#' biomarker combinations or multi-parametric tests. When two biomarkers are 
#' measured simultaneously (e.g., ER and PR in breast cancer, dual IHC 
#' markers, imaging plus biomarker), 2D ROC analysis finds the optimal 
#' combined decision rule in two-dimensional marker space. Unlike analyzing 
#' markers separately and combining results, 2D ROC jointly optimizes both 
#' thresholds to maximize diagnostic accuracy. Provides joint 
#' sensitivity/specificity, optimal threshold pairs, 3D ROC surface 
#' visualization, and comparison to single-marker performance. Essential for 
#' multiplex assays, dual biomarker panels, and situations where neither 
#' marker alone is sufficient but combination improves diagnosis. Applications 
#' include ER/PR combinations, dual IHC (e.g., p16/Ki67), imaging radiomics 
#' plus molecular markers, and any scenario with two continuous diagnostic 
#' measurements.
#' 
#'
#' @examples
#' result <- roc2d(
#'     data = dual_marker_data,
#'     marker1 = "biomarker_A",
#'     marker2 = "biomarker_B",
#'     outcome = "disease_status"
#' )
#'
#' @param data .
#' @param marker1 .
#' @param marker2 .
#' @param outcome .
#' @param positive_level .
#' @param decision_rule .
#' @param compare_single_markers .
#' @param plot_2d_roc_surface .
#' @param plot_threshold_region .
#' @param show_interpretation .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$individualAUCs} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$combinationRules} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$optimalCombination} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$roc2dPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$individualAUCs$asDF}
#'
#' \code{as.data.frame(results$individualAUCs)}
#'
#' @export
roc2d <- function(
    data,
    marker1,
    marker2,
    outcome,
    positive_level,
    decision_rule = "linear",
    compare_single_markers = TRUE,
    plot_2d_roc_surface = TRUE,
    plot_threshold_region = TRUE,
    show_interpretation = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("roc2d requires jmvcore to be installed (restart may be required)")

    if ( ! missing(marker1)) marker1 <- jmvcore::resolveQuo(jmvcore::enquo(marker1))
    if ( ! missing(marker2)) marker2 <- jmvcore::resolveQuo(jmvcore::enquo(marker2))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(marker1), marker1, NULL),
            `if`( ! missing(marker2), marker2, NULL),
            `if`( ! missing(outcome), outcome, NULL))

    for (v in outcome) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- roc2dOptions$new(
        marker1 = marker1,
        marker2 = marker2,
        outcome = outcome,
        positive_level = positive_level,
        decision_rule = decision_rule,
        compare_single_markers = compare_single_markers,
        plot_2d_roc_surface = plot_2d_roc_surface,
        plot_threshold_region = plot_threshold_region,
        show_interpretation = show_interpretation)

    analysis <- roc2dClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

