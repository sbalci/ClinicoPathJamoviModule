
# This file is automatically generated, you probably don't want to edit this

classicalSurvivalPowerOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "classicalSurvivalPowerOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            calculation_type = "sample_size",
            method = "lachin_foulkes",
            hazard_control = 0.083,
            hazard_treatment = 0.042,
            hazard_ratio = 0.6,
            study_duration = 24,
            accrual_duration = 12,
            dropout_rate = 0,
            allocation_ratio = 1,
            alpha = 0.025,
            beta = 0.1,
            power = 0.9,
            sided = "one_sided",
            entry_type = "unif",
            gamma = 0,
            sample_size_input = 100,
            events_input = 50,
            show_summary = TRUE,
            show_formulas = FALSE,
            show_interpretation = TRUE,
            show_power_plot = FALSE,
            show_timeline_plot = FALSE,
            power_plot_range = "auto",
            export_results = FALSE,
            export_power_curve = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="classicalSurvivalPower",
                requiresData=TRUE,
                ...)

            private$..calculation_type <- jmvcore::OptionList$new(
                "calculation_type",
                calculation_type,
                options=list(
                    "sample_size",
                    "power",
                    "events",
                    "hazard_ratio"),
                default="sample_size")
            private$..method <- jmvcore::OptionList$new(
                "method",
                method,
                options=list(
                    "lachin_foulkes",
                    "schoenfeld"),
                default="lachin_foulkes")
            private$..hazard_control <- jmvcore::OptionNumber$new(
                "hazard_control",
                hazard_control,
                min=0.001,
                max=10,
                default=0.083)
            private$..hazard_treatment <- jmvcore::OptionNumber$new(
                "hazard_treatment",
                hazard_treatment,
                min=0.001,
                max=10,
                default=0.042)
            private$..hazard_ratio <- jmvcore::OptionNumber$new(
                "hazard_ratio",
                hazard_ratio,
                min=0.1,
                max=10,
                default=0.6)
            private$..study_duration <- jmvcore::OptionNumber$new(
                "study_duration",
                study_duration,
                min=1,
                max=120,
                default=24)
            private$..accrual_duration <- jmvcore::OptionNumber$new(
                "accrual_duration",
                accrual_duration,
                min=1,
                max=60,
                default=12)
            private$..dropout_rate <- jmvcore::OptionNumber$new(
                "dropout_rate",
                dropout_rate,
                min=0,
                max=1,
                default=0)
            private$..allocation_ratio <- jmvcore::OptionNumber$new(
                "allocation_ratio",
                allocation_ratio,
                min=0.1,
                max=10,
                default=1)
            private$..alpha <- jmvcore::OptionNumber$new(
                "alpha",
                alpha,
                min=0.001,
                max=0.1,
                default=0.025)
            private$..beta <- jmvcore::OptionNumber$new(
                "beta",
                beta,
                min=0.01,
                max=0.5,
                default=0.1)
            private$..power <- jmvcore::OptionNumber$new(
                "power",
                power,
                min=0.5,
                max=0.99,
                default=0.9)
            private$..sided <- jmvcore::OptionList$new(
                "sided",
                sided,
                options=list(
                    "one_sided",
                    "two_sided"),
                default="one_sided")
            private$..entry_type <- jmvcore::OptionList$new(
                "entry_type",
                entry_type,
                options=list(
                    "unif",
                    "expo"),
                default="unif")
            private$..gamma <- jmvcore::OptionNumber$new(
                "gamma",
                gamma,
                min=-5,
                max=5,
                default=0)
            private$..sample_size_input <- jmvcore::OptionNumber$new(
                "sample_size_input",
                sample_size_input,
                min=10,
                max=10000,
                default=100)
            private$..events_input <- jmvcore::OptionNumber$new(
                "events_input",
                events_input,
                min=5,
                max=1000,
                default=50)
            private$..show_summary <- jmvcore::OptionBool$new(
                "show_summary",
                show_summary,
                default=TRUE)
            private$..show_formulas <- jmvcore::OptionBool$new(
                "show_formulas",
                show_formulas,
                default=FALSE)
            private$..show_interpretation <- jmvcore::OptionBool$new(
                "show_interpretation",
                show_interpretation,
                default=TRUE)
            private$..show_power_plot <- jmvcore::OptionBool$new(
                "show_power_plot",
                show_power_plot,
                default=FALSE)
            private$..show_timeline_plot <- jmvcore::OptionBool$new(
                "show_timeline_plot",
                show_timeline_plot,
                default=FALSE)
            private$..power_plot_range <- jmvcore::OptionString$new(
                "power_plot_range",
                power_plot_range,
                default="auto")
            private$..export_results <- jmvcore::OptionBool$new(
                "export_results",
                export_results,
                default=FALSE)
            private$..export_power_curve <- jmvcore::OptionBool$new(
                "export_power_curve",
                export_power_curve,
                default=FALSE)

            self$.addOption(private$..calculation_type)
            self$.addOption(private$..method)
            self$.addOption(private$..hazard_control)
            self$.addOption(private$..hazard_treatment)
            self$.addOption(private$..hazard_ratio)
            self$.addOption(private$..study_duration)
            self$.addOption(private$..accrual_duration)
            self$.addOption(private$..dropout_rate)
            self$.addOption(private$..allocation_ratio)
            self$.addOption(private$..alpha)
            self$.addOption(private$..beta)
            self$.addOption(private$..power)
            self$.addOption(private$..sided)
            self$.addOption(private$..entry_type)
            self$.addOption(private$..gamma)
            self$.addOption(private$..sample_size_input)
            self$.addOption(private$..events_input)
            self$.addOption(private$..show_summary)
            self$.addOption(private$..show_formulas)
            self$.addOption(private$..show_interpretation)
            self$.addOption(private$..show_power_plot)
            self$.addOption(private$..show_timeline_plot)
            self$.addOption(private$..power_plot_range)
            self$.addOption(private$..export_results)
            self$.addOption(private$..export_power_curve)
        }),
    active = list(
        calculation_type = function() private$..calculation_type$value,
        method = function() private$..method$value,
        hazard_control = function() private$..hazard_control$value,
        hazard_treatment = function() private$..hazard_treatment$value,
        hazard_ratio = function() private$..hazard_ratio$value,
        study_duration = function() private$..study_duration$value,
        accrual_duration = function() private$..accrual_duration$value,
        dropout_rate = function() private$..dropout_rate$value,
        allocation_ratio = function() private$..allocation_ratio$value,
        alpha = function() private$..alpha$value,
        beta = function() private$..beta$value,
        power = function() private$..power$value,
        sided = function() private$..sided$value,
        entry_type = function() private$..entry_type$value,
        gamma = function() private$..gamma$value,
        sample_size_input = function() private$..sample_size_input$value,
        events_input = function() private$..events_input$value,
        show_summary = function() private$..show_summary$value,
        show_formulas = function() private$..show_formulas$value,
        show_interpretation = function() private$..show_interpretation$value,
        show_power_plot = function() private$..show_power_plot$value,
        show_timeline_plot = function() private$..show_timeline_plot$value,
        power_plot_range = function() private$..power_plot_range$value,
        export_results = function() private$..export_results$value,
        export_power_curve = function() private$..export_power_curve$value),
    private = list(
        ..calculation_type = NA,
        ..method = NA,
        ..hazard_control = NA,
        ..hazard_treatment = NA,
        ..hazard_ratio = NA,
        ..study_duration = NA,
        ..accrual_duration = NA,
        ..dropout_rate = NA,
        ..allocation_ratio = NA,
        ..alpha = NA,
        ..beta = NA,
        ..power = NA,
        ..sided = NA,
        ..entry_type = NA,
        ..gamma = NA,
        ..sample_size_input = NA,
        ..events_input = NA,
        ..show_summary = NA,
        ..show_formulas = NA,
        ..show_interpretation = NA,
        ..show_power_plot = NA,
        ..show_timeline_plot = NA,
        ..power_plot_range = NA,
        ..export_results = NA,
        ..export_power_curve = NA)
)

classicalSurvivalPowerResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "classicalSurvivalPowerResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        power_results = function() private$.items[["power_results"]],
        formulas = function() private$.items[["formulas"]],
        interpretation = function() private$.items[["interpretation"]],
        power_plot = function() private$.items[["power_plot"]],
        timeline_plot = function() private$.items[["timeline_plot"]],
        exported_results = function() private$.items[["exported_results"]],
        exported_power_curve = function() private$.items[["exported_power_curve"]],
        export_summary = function() private$.items[["export_summary"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Classical Survival Power Analysis",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "gsDesign",
                    "survival",
                    "ggplot2",
                    "scales"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="power_results",
                title="Power Analysis Results",
                visible="(calculation_type && method)",
                clearWith=list(
                    "calculation_type",
                    "method",
                    "hazard_control",
                    "hazard_treatment",
                    "hazard_ratio",
                    "study_duration",
                    "accrual_duration",
                    "alpha",
                    "beta",
                    "power",
                    "allocation_ratio",
                    "sample_size_input",
                    "events_input")))
            self$add(jmvcore::Html$new(
                options=options,
                name="formulas",
                title="Mathematical Formulas",
                visible="(calculation_type && method && show_formulas)",
                clearWith=list(
                    "calculation_type",
                    "method",
                    "show_formulas")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation",
                visible="(calculation_type && method && show_interpretation)",
                clearWith=list(
                    "calculation_type",
                    "method",
                    "show_interpretation",
                    "hazard_control",
                    "hazard_treatment",
                    "hazard_ratio",
                    "alpha",
                    "beta",
                    "power")))
            self$add(jmvcore::Image$new(
                options=options,
                name="power_plot",
                title="Power Curve Analysis",
                width=700,
                height=500,
                renderFun=".plot_power_curve",
                visible="(calculation_type && method && show_power_plot)",
                requiresData=FALSE,
                clearWith=list(
                    "calculation_type",
                    "method",
                    "show_power_plot",
                    "hazard_control",
                    "hazard_treatment",
                    "hazard_ratio",
                    "alpha",
                    "beta",
                    "power",
                    "allocation_ratio",
                    "power_plot_range")))
            self$add(jmvcore::Image$new(
                options=options,
                name="timeline_plot",
                title="Study Timeline Visualization",
                width=700,
                height=400,
                renderFun=".plot_timeline",
                visible="(calculation_type && method == \"lachin_foulkes\" && show_timeline_plot)",
                requiresData=FALSE,
                clearWith=list(
                    "calculation_type",
                    "method",
                    "show_timeline_plot",
                    "study_duration",
                    "accrual_duration",
                    "hazard_control",
                    "hazard_treatment")))
            self$add(jmvcore::Output$new(
                options=options,
                name="exported_results",
                title="Export Power Analysis Results",
                varTitle="Survival Power Results",
                varDescription="Comprehensive survival power analysis results for external analysis",
                clearWith=list(
                    "export_results",
                    "calculation_type",
                    "method",
                    "hazard_control",
                    "hazard_treatment",
                    "hazard_ratio",
                    "study_duration",
                    "accrual_duration",
                    "alpha",
                    "beta",
                    "power",
                    "allocation_ratio")))
            self$add(jmvcore::Output$new(
                options=options,
                name="exported_power_curve",
                title="Export Power Curve Data",
                varTitle="Power Curve Data",
                varDescription="Power curve data points for external plotting and analysis",
                clearWith=list(
                    "export_power_curve",
                    "calculation_type",
                    "method",
                    "hazard_control",
                    "hazard_treatment",
                    "hazard_ratio",
                    "alpha",
                    "beta",
                    "allocation_ratio",
                    "power_plot_range")))
            self$add(jmvcore::Html$new(
                options=options,
                name="export_summary",
                title="Export Summary",
                visible="(export_results || export_power_curve)",
                clearWith=list(
                    "export_results",
                    "export_power_curve")))}))

classicalSurvivalPowerBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "classicalSurvivalPowerBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "classicalSurvivalPower",
                version = c(0,0,3),
                options = options,
                results = classicalSurvivalPowerResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Classical Survival Power Analysis (Intermediate)
#'
#' Legacy power analysis and sample size calculation for survival studies 
#' using Lachin-Foulkes and
#' Schoenfeld methods from gsDesign package.
#' 
#' This is the original survival power analysis function. For enhanced 
#' functionality including
#' competing risks, RMST analysis, and additional methods, also consider 
#' 'Comprehensive Survival Power Analysis'.
#' 
#'
#' @examples
#' \donttest{
#' # Example usage:
#' library(gsDesign)
#' # Sample size for survival study
#' nSurvival(lambda1 = 0.2, lambda2 = 0.1, Ts = 24, Tr = 12)
#' # Number of events required
#' nEvents(hr = 0.6, alpha = 0.025, beta = 0.1)
#'}
#' @param data The data as a data frame (optional for power calculations).
#' @param calculation_type Type of power calculation to perform.
#' @param method Method for power/sample size calculation.
#' @param hazard_control Event hazard rate for control group (events per
#'   person-time unit).
#' @param hazard_treatment Event hazard rate for treatment group (events per
#'   person-time unit).
#' @param hazard_ratio Hazard ratio (treatment/control) for Schoenfeld method.
#' @param study_duration Maximum study duration (months or years).
#' @param accrual_duration Patient accrual (recruitment) duration.
#' @param dropout_rate Equal dropout hazard rate for both groups.
#' @param allocation_ratio Randomization ratio (treatment:control).
#' @param alpha Type I error rate (significance level).
#' @param beta Type II error rate (1 - power).
#' @param power Statistical power (1 - beta).
#' @param sided One-sided or two-sided statistical test.
#' @param entry_type Pattern of patient entry into the study.
#' @param gamma Rate parameter for exponential entry (0 if uniform entry).
#' @param sample_size_input Total sample size when calculating power.
#' @param events_input Number of events when calculating power with Schoenfeld
#'   method.
#' @param show_summary Whether to display comprehensive study design summary.
#' @param show_formulas Whether to display mathematical formulas used.
#' @param show_interpretation Whether to include clinical interpretation of
#'   results.
#' @param show_power_plot Whether to display power curve visualization.
#' @param show_timeline_plot Whether to display study timeline visualization
#'   for Lachin-Foulkes method.
#' @param power_plot_range Sample size range for power plots (format 'min,max'
#'   or 'auto').
#' @param export_results Whether to export detailed results for external
#'   analysis.
#' @param export_power_curve Whether to export power curve data points.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$power_results} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$formulas} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$power_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$timeline_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$exported_results} \tab \tab \tab \tab \tab an output \cr
#'   \code{results$exported_power_curve} \tab \tab \tab \tab \tab an output \cr
#'   \code{results$export_summary} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' @export
classicalSurvivalPower <- function(
    data,
    calculation_type = "sample_size",
    method = "lachin_foulkes",
    hazard_control = 0.083,
    hazard_treatment = 0.042,
    hazard_ratio = 0.6,
    study_duration = 24,
    accrual_duration = 12,
    dropout_rate = 0,
    allocation_ratio = 1,
    alpha = 0.025,
    beta = 0.1,
    power = 0.9,
    sided = "one_sided",
    entry_type = "unif",
    gamma = 0,
    sample_size_input = 100,
    events_input = 50,
    show_summary = TRUE,
    show_formulas = FALSE,
    show_interpretation = TRUE,
    show_power_plot = FALSE,
    show_timeline_plot = FALSE,
    power_plot_range = "auto",
    export_results = FALSE,
    export_power_curve = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("classicalSurvivalPower requires jmvcore to be installed (restart may be required)")

    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame())


    options <- classicalSurvivalPowerOptions$new(
        calculation_type = calculation_type,
        method = method,
        hazard_control = hazard_control,
        hazard_treatment = hazard_treatment,
        hazard_ratio = hazard_ratio,
        study_duration = study_duration,
        accrual_duration = accrual_duration,
        dropout_rate = dropout_rate,
        allocation_ratio = allocation_ratio,
        alpha = alpha,
        beta = beta,
        power = power,
        sided = sided,
        entry_type = entry_type,
        gamma = gamma,
        sample_size_input = sample_size_input,
        events_input = events_input,
        show_summary = show_summary,
        show_formulas = show_formulas,
        show_interpretation = show_interpretation,
        show_power_plot = show_power_plot,
        show_timeline_plot = show_timeline_plot,
        power_plot_range = power_plot_range,
        export_results = export_results,
        export_power_curve = export_power_curve)

    analysis <- classicalSurvivalPowerClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

