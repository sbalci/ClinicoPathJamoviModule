
# This file is automatically generated, you probably don't want to edit this

clinicalpredictionOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinicalpredictionOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            outcome_var = NULL,
            predictor_vars = NULL,
            patient_id = NULL,
            time_var = NULL,
            event_var = NULL,
            stratify_var = NULL,
            model_type = "random_forest",
            problem_type = "classification",
            outcome_type = "binary",
            feature_selection = TRUE,
            selection_method = "recursive_fe",
            feature_engineering = TRUE,
            handle_missing = "mice_imputation",
            train_proportion = 0.7,
            validation_method = "cv_10fold",
            hyperparameter_tuning = TRUE,
            tuning_method = "random_search",
            random_seed = 42,
            interpretability = TRUE,
            shap_analysis = TRUE,
            lime_analysis = FALSE,
            permutation_importance = TRUE,
            partial_dependence = TRUE,
            individual_explanations = FALSE,
            n_explanations = 10,
            performance_metrics = TRUE,
            calibration_analysis = TRUE,
            clinical_metrics = TRUE,
            roc_analysis = TRUE,
            threshold_optimization = TRUE,
            compare_models = FALSE,
            baseline_models = TRUE,
            ensemble_models = FALSE,
            risk_stratification = TRUE,
            n_risk_groups = 3,
            nomogram = TRUE,
            decision_curve = TRUE,
            external_validation = TRUE,
            bootstrap_ci = 1000,
            stability_analysis = TRUE,
            bias_analysis = TRUE,
            detailed_output = TRUE,
            clinical_report = TRUE,
            save_model = FALSE,
            export_predictions = FALSE,
            regulatory_documentation = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="clinicalprediction",
                requiresData=TRUE,
                ...)

            private$..outcome_var <- jmvcore::OptionVariable$new(
                "outcome_var",
                outcome_var,
                suggested=list(
                    "nominal",
                    "continuous"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..predictor_vars <- jmvcore::OptionVariables$new(
                "predictor_vars",
                predictor_vars,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..patient_id <- jmvcore::OptionVariable$new(
                "patient_id",
                patient_id,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "id"))
            private$..time_var <- jmvcore::OptionVariable$new(
                "time_var",
                time_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event_var <- jmvcore::OptionVariable$new(
                "event_var",
                event_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..stratify_var <- jmvcore::OptionVariable$new(
                "stratify_var",
                stratify_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..model_type <- jmvcore::OptionList$new(
                "model_type",
                model_type,
                options=list(
                    "random_forest",
                    "gradient_boosting",
                    "logistic_regression",
                    "cox_regression",
                    "svm",
                    "neural_network",
                    "ensemble"),
                default="random_forest")
            private$..problem_type <- jmvcore::OptionList$new(
                "problem_type",
                problem_type,
                options=list(
                    "classification",
                    "regression",
                    "survival"),
                default="classification")
            private$..outcome_type <- jmvcore::OptionList$new(
                "outcome_type",
                outcome_type,
                options=list(
                    "binary",
                    "multiclass",
                    "continuous",
                    "time_to_event"),
                default="binary")
            private$..feature_selection <- jmvcore::OptionBool$new(
                "feature_selection",
                feature_selection,
                default=TRUE)
            private$..selection_method <- jmvcore::OptionList$new(
                "selection_method",
                selection_method,
                options=list(
                    "recursive_fe",
                    "lasso",
                    "mutual_info",
                    "boruta",
                    "stability"),
                default="recursive_fe")
            private$..feature_engineering <- jmvcore::OptionBool$new(
                "feature_engineering",
                feature_engineering,
                default=TRUE)
            private$..handle_missing <- jmvcore::OptionList$new(
                "handle_missing",
                handle_missing,
                options=list(
                    "complete_cases",
                    "mean_median",
                    "knn_imputation",
                    "mice_imputation"),
                default="mice_imputation")
            private$..train_proportion <- jmvcore::OptionNumber$new(
                "train_proportion",
                train_proportion,
                min=0.5,
                max=0.9,
                default=0.7)
            private$..validation_method <- jmvcore::OptionList$new(
                "validation_method",
                validation_method,
                options=list(
                    "holdout",
                    "cv_5fold",
                    "cv_10fold",
                    "bootstrap",
                    "temporal"),
                default="cv_10fold")
            private$..hyperparameter_tuning <- jmvcore::OptionBool$new(
                "hyperparameter_tuning",
                hyperparameter_tuning,
                default=TRUE)
            private$..tuning_method <- jmvcore::OptionList$new(
                "tuning_method",
                tuning_method,
                options=list(
                    "grid_search",
                    "random_search",
                    "bayesian"),
                default="random_search")
            private$..random_seed <- jmvcore::OptionInteger$new(
                "random_seed",
                random_seed,
                min=1,
                max=999999,
                default=42)
            private$..interpretability <- jmvcore::OptionBool$new(
                "interpretability",
                interpretability,
                default=TRUE)
            private$..shap_analysis <- jmvcore::OptionBool$new(
                "shap_analysis",
                shap_analysis,
                default=TRUE)
            private$..lime_analysis <- jmvcore::OptionBool$new(
                "lime_analysis",
                lime_analysis,
                default=FALSE)
            private$..permutation_importance <- jmvcore::OptionBool$new(
                "permutation_importance",
                permutation_importance,
                default=TRUE)
            private$..partial_dependence <- jmvcore::OptionBool$new(
                "partial_dependence",
                partial_dependence,
                default=TRUE)
            private$..individual_explanations <- jmvcore::OptionBool$new(
                "individual_explanations",
                individual_explanations,
                default=FALSE)
            private$..n_explanations <- jmvcore::OptionInteger$new(
                "n_explanations",
                n_explanations,
                min=1,
                max=100,
                default=10)
            private$..performance_metrics <- jmvcore::OptionBool$new(
                "performance_metrics",
                performance_metrics,
                default=TRUE)
            private$..calibration_analysis <- jmvcore::OptionBool$new(
                "calibration_analysis",
                calibration_analysis,
                default=TRUE)
            private$..clinical_metrics <- jmvcore::OptionBool$new(
                "clinical_metrics",
                clinical_metrics,
                default=TRUE)
            private$..roc_analysis <- jmvcore::OptionBool$new(
                "roc_analysis",
                roc_analysis,
                default=TRUE)
            private$..threshold_optimization <- jmvcore::OptionBool$new(
                "threshold_optimization",
                threshold_optimization,
                default=TRUE)
            private$..compare_models <- jmvcore::OptionBool$new(
                "compare_models",
                compare_models,
                default=FALSE)
            private$..baseline_models <- jmvcore::OptionBool$new(
                "baseline_models",
                baseline_models,
                default=TRUE)
            private$..ensemble_models <- jmvcore::OptionBool$new(
                "ensemble_models",
                ensemble_models,
                default=FALSE)
            private$..risk_stratification <- jmvcore::OptionBool$new(
                "risk_stratification",
                risk_stratification,
                default=TRUE)
            private$..n_risk_groups <- jmvcore::OptionInteger$new(
                "n_risk_groups",
                n_risk_groups,
                min=2,
                max=10,
                default=3)
            private$..nomogram <- jmvcore::OptionBool$new(
                "nomogram",
                nomogram,
                default=TRUE)
            private$..decision_curve <- jmvcore::OptionBool$new(
                "decision_curve",
                decision_curve,
                default=TRUE)
            private$..external_validation <- jmvcore::OptionBool$new(
                "external_validation",
                external_validation,
                default=TRUE)
            private$..bootstrap_ci <- jmvcore::OptionInteger$new(
                "bootstrap_ci",
                bootstrap_ci,
                min=100,
                max=2000,
                default=1000)
            private$..stability_analysis <- jmvcore::OptionBool$new(
                "stability_analysis",
                stability_analysis,
                default=TRUE)
            private$..bias_analysis <- jmvcore::OptionBool$new(
                "bias_analysis",
                bias_analysis,
                default=TRUE)
            private$..detailed_output <- jmvcore::OptionBool$new(
                "detailed_output",
                detailed_output,
                default=TRUE)
            private$..clinical_report <- jmvcore::OptionBool$new(
                "clinical_report",
                clinical_report,
                default=TRUE)
            private$..save_model <- jmvcore::OptionBool$new(
                "save_model",
                save_model,
                default=FALSE)
            private$..export_predictions <- jmvcore::OptionBool$new(
                "export_predictions",
                export_predictions,
                default=FALSE)
            private$..regulatory_documentation <- jmvcore::OptionBool$new(
                "regulatory_documentation",
                regulatory_documentation,
                default=TRUE)

            self$.addOption(private$..outcome_var)
            self$.addOption(private$..predictor_vars)
            self$.addOption(private$..patient_id)
            self$.addOption(private$..time_var)
            self$.addOption(private$..event_var)
            self$.addOption(private$..stratify_var)
            self$.addOption(private$..model_type)
            self$.addOption(private$..problem_type)
            self$.addOption(private$..outcome_type)
            self$.addOption(private$..feature_selection)
            self$.addOption(private$..selection_method)
            self$.addOption(private$..feature_engineering)
            self$.addOption(private$..handle_missing)
            self$.addOption(private$..train_proportion)
            self$.addOption(private$..validation_method)
            self$.addOption(private$..hyperparameter_tuning)
            self$.addOption(private$..tuning_method)
            self$.addOption(private$..random_seed)
            self$.addOption(private$..interpretability)
            self$.addOption(private$..shap_analysis)
            self$.addOption(private$..lime_analysis)
            self$.addOption(private$..permutation_importance)
            self$.addOption(private$..partial_dependence)
            self$.addOption(private$..individual_explanations)
            self$.addOption(private$..n_explanations)
            self$.addOption(private$..performance_metrics)
            self$.addOption(private$..calibration_analysis)
            self$.addOption(private$..clinical_metrics)
            self$.addOption(private$..roc_analysis)
            self$.addOption(private$..threshold_optimization)
            self$.addOption(private$..compare_models)
            self$.addOption(private$..baseline_models)
            self$.addOption(private$..ensemble_models)
            self$.addOption(private$..risk_stratification)
            self$.addOption(private$..n_risk_groups)
            self$.addOption(private$..nomogram)
            self$.addOption(private$..decision_curve)
            self$.addOption(private$..external_validation)
            self$.addOption(private$..bootstrap_ci)
            self$.addOption(private$..stability_analysis)
            self$.addOption(private$..bias_analysis)
            self$.addOption(private$..detailed_output)
            self$.addOption(private$..clinical_report)
            self$.addOption(private$..save_model)
            self$.addOption(private$..export_predictions)
            self$.addOption(private$..regulatory_documentation)
        }),
    active = list(
        outcome_var = function() private$..outcome_var$value,
        predictor_vars = function() private$..predictor_vars$value,
        patient_id = function() private$..patient_id$value,
        time_var = function() private$..time_var$value,
        event_var = function() private$..event_var$value,
        stratify_var = function() private$..stratify_var$value,
        model_type = function() private$..model_type$value,
        problem_type = function() private$..problem_type$value,
        outcome_type = function() private$..outcome_type$value,
        feature_selection = function() private$..feature_selection$value,
        selection_method = function() private$..selection_method$value,
        feature_engineering = function() private$..feature_engineering$value,
        handle_missing = function() private$..handle_missing$value,
        train_proportion = function() private$..train_proportion$value,
        validation_method = function() private$..validation_method$value,
        hyperparameter_tuning = function() private$..hyperparameter_tuning$value,
        tuning_method = function() private$..tuning_method$value,
        random_seed = function() private$..random_seed$value,
        interpretability = function() private$..interpretability$value,
        shap_analysis = function() private$..shap_analysis$value,
        lime_analysis = function() private$..lime_analysis$value,
        permutation_importance = function() private$..permutation_importance$value,
        partial_dependence = function() private$..partial_dependence$value,
        individual_explanations = function() private$..individual_explanations$value,
        n_explanations = function() private$..n_explanations$value,
        performance_metrics = function() private$..performance_metrics$value,
        calibration_analysis = function() private$..calibration_analysis$value,
        clinical_metrics = function() private$..clinical_metrics$value,
        roc_analysis = function() private$..roc_analysis$value,
        threshold_optimization = function() private$..threshold_optimization$value,
        compare_models = function() private$..compare_models$value,
        baseline_models = function() private$..baseline_models$value,
        ensemble_models = function() private$..ensemble_models$value,
        risk_stratification = function() private$..risk_stratification$value,
        n_risk_groups = function() private$..n_risk_groups$value,
        nomogram = function() private$..nomogram$value,
        decision_curve = function() private$..decision_curve$value,
        external_validation = function() private$..external_validation$value,
        bootstrap_ci = function() private$..bootstrap_ci$value,
        stability_analysis = function() private$..stability_analysis$value,
        bias_analysis = function() private$..bias_analysis$value,
        detailed_output = function() private$..detailed_output$value,
        clinical_report = function() private$..clinical_report$value,
        save_model = function() private$..save_model$value,
        export_predictions = function() private$..export_predictions$value,
        regulatory_documentation = function() private$..regulatory_documentation$value),
    private = list(
        ..outcome_var = NA,
        ..predictor_vars = NA,
        ..patient_id = NA,
        ..time_var = NA,
        ..event_var = NA,
        ..stratify_var = NA,
        ..model_type = NA,
        ..problem_type = NA,
        ..outcome_type = NA,
        ..feature_selection = NA,
        ..selection_method = NA,
        ..feature_engineering = NA,
        ..handle_missing = NA,
        ..train_proportion = NA,
        ..validation_method = NA,
        ..hyperparameter_tuning = NA,
        ..tuning_method = NA,
        ..random_seed = NA,
        ..interpretability = NA,
        ..shap_analysis = NA,
        ..lime_analysis = NA,
        ..permutation_importance = NA,
        ..partial_dependence = NA,
        ..individual_explanations = NA,
        ..n_explanations = NA,
        ..performance_metrics = NA,
        ..calibration_analysis = NA,
        ..clinical_metrics = NA,
        ..roc_analysis = NA,
        ..threshold_optimization = NA,
        ..compare_models = NA,
        ..baseline_models = NA,
        ..ensemble_models = NA,
        ..risk_stratification = NA,
        ..n_risk_groups = NA,
        ..nomogram = NA,
        ..decision_curve = NA,
        ..external_validation = NA,
        ..bootstrap_ci = NA,
        ..stability_analysis = NA,
        ..bias_analysis = NA,
        ..detailed_output = NA,
        ..clinical_report = NA,
        ..save_model = NA,
        ..export_predictions = NA,
        ..regulatory_documentation = NA)
)

clinicalpredictionResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinicalpredictionResults",
    inherit = jmvcore::Group,
    active = list(
        overview = function() private$.items[["overview"]],
        dataset_info = function() private$.items[["dataset_info"]],
        feature_selection_results = function() private$.items[["feature_selection_results"]],
        feature_engineering_summary = function() private$.items[["feature_engineering_summary"]],
        performance_summary = function() private$.items[["performance_summary"]],
        classification_metrics = function() private$.items[["classification_metrics"]],
        survival_metrics = function() private$.items[["survival_metrics"]],
        feature_importance = function() private$.items[["feature_importance"]],
        shap_summary = function() private$.items[["shap_summary"]],
        individual_explanations = function() private$.items[["individual_explanations"]],
        model_comparison = function() private$.items[["model_comparison"]],
        risk_stratification = function() private$.items[["risk_stratification"]],
        decision_curve_analysis = function() private$.items[["decision_curve_analysis"]],
        cross_validation_results = function() private$.items[["cross_validation_results"]],
        stability_analysis = function() private$.items[["stability_analysis"]],
        bias_fairness_analysis = function() private$.items[["bias_fairness_analysis"]],
        hyperparameter_results = function() private$.items[["hyperparameter_results"]],
        clinical_interpretation = function() private$.items[["clinical_interpretation"]],
        regulatory_summary = function() private$.items[["regulatory_summary"]],
        roc_plot = function() private$.items[["roc_plot"]],
        calibration_plot = function() private$.items[["calibration_plot"]],
        feature_importance_plot = function() private$.items[["feature_importance_plot"]],
        shap_summary_plot = function() private$.items[["shap_summary_plot"]],
        shap_dependence_plot = function() private$.items[["shap_dependence_plot"]],
        decision_curve_plot = function() private$.items[["decision_curve_plot"]],
        risk_distribution_plot = function() private$.items[["risk_distribution_plot"]],
        model_comparison_plot = function() private$.items[["model_comparison_plot"]],
        stability_plot = function() private$.items[["stability_plot"]],
        nomogram_plot = function() private$.items[["nomogram_plot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Clinical Prediction Models & ML Interpretability",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "mice",
                    "glmnet",
                    "caret",
                    "randomForest",
                    "xgboost",
                    "e1071",
                    "pROC",
                    "fastshap"))
            self$add(jmvcore::Table$new(
                options=options,
                name="overview",
                title="Model Overview",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text")),
                clearWith=list(
                    "outcome_var",
                    "predictor_vars",
                    "model_type")))
            self$add(jmvcore::Table$new(
                options=options,
                name="dataset_info",
                title="Dataset Information",
                columns=list(
                    list(
                        `name`="characteristic", 
                        `title`="Characteristic", 
                        `type`="text"),
                    list(
                        `name`="training", 
                        `title`="Training Set", 
                        `type`="text"),
                    list(
                        `name`="validation", 
                        `title`="Validation Set", 
                        `type`="text")),
                clearWith=list(
                    "outcome_var",
                    "train_proportion")))
            self$add(jmvcore::Table$new(
                options=options,
                name="feature_selection_results",
                title="Feature Selection Results",
                visible="(feature_selection)",
                columns=list(
                    list(
                        `name`="feature", 
                        `title`="Feature", 
                        `type`="text"),
                    list(
                        `name`="selected", 
                        `title`="Selected", 
                        `type`="text"),
                    list(
                        `name`="importance_score", 
                        `title`="Importance Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="selection_frequency", 
                        `title`="Selection Frequency", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="rank", 
                        `title`="Rank", 
                        `type`="integer")),
                clearWith=list(
                    "predictor_vars",
                    "selection_method",
                    "feature_selection")))
            self$add(jmvcore::Table$new(
                options=options,
                name="feature_engineering_summary",
                title="Feature Engineering Summary",
                visible="(feature_engineering)",
                columns=list(
                    list(
                        `name`="original_features", 
                        `title`="Original Features", 
                        `type`="integer"),
                    list(
                        `name`="engineered_features", 
                        `title`="Engineered Features", 
                        `type`="integer"),
                    list(
                        `name`="final_features", 
                        `title`="Final Features", 
                        `type`="integer"),
                    list(
                        `name`="transformation_applied", 
                        `title`="Transformations Applied", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="performance_summary",
                title="Model Performance Summary",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="training", 
                        `title`="Training", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="validation", 
                        `title`="Validation", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto")),
                clearWith=list(
                    "model_type",
                    "validation_method")))
            self$add(jmvcore::Table$new(
                options=options,
                name="classification_metrics",
                title="Classification Performance Metrics",
                visible="(problem_type:classification)",
                columns=list(
                    list(
                        `name`="threshold", 
                        `title`="Threshold", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ppv", 
                        `title`="PPV", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="npv", 
                        `title`="NPV", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="f1_score", 
                        `title`="F1 Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="youden_index", 
                        `title`="Youden Index", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="survival_metrics",
                title="Survival Prediction Metrics",
                visible="(problem_type:survival)",
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="text"),
                    list(
                        `name`="c_index", 
                        `title`="C-Index", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="brier_score", 
                        `title`="Brier Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="auc_timepoint", 
                        `title`="Time-specific AUC", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="calibration_slope", 
                        `title`="Calibration Slope", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="feature_importance",
                title="Feature Importance Analysis",
                visible="(interpretability)",
                columns=list(
                    list(
                        `name`="feature", 
                        `title`="Feature", 
                        `type`="text"),
                    list(
                        `name`="importance", 
                        `title`="Importance", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="importance_rank", 
                        `title`="Rank", 
                        `type`="integer"),
                    list(
                        `name`="shap_mean", 
                        `title`="Mean |SHAP|", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="permutation_importance", 
                        `title`="Permutation Importance", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="direction", 
                        `title`="Direction", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="shap_summary",
                title="SHAP Values Summary",
                visible="(shap_analysis)",
                columns=list(
                    list(
                        `name`="feature", 
                        `title`="Feature", 
                        `type`="text"),
                    list(
                        `name`="shap_mean_abs", 
                        `title`="Mean |SHAP|", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="shap_std", 
                        `title`="SHAP Std", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="positive_impact", 
                        `title`="Positive Impact %", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="negative_impact", 
                        `title`="Negative Impact %", 
                        `type`="number", 
                        `format`="pc"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="individual_explanations",
                title="Individual Prediction Explanations",
                visible="(individual_explanations)",
                columns=list(
                    list(
                        `name`="patient_id", 
                        `title`="Patient ID", 
                        `type`="text"),
                    list(
                        `name`="predicted_probability", 
                        `title`="Predicted Probability", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="actual_outcome", 
                        `title`="Actual Outcome", 
                        `type`="text"),
                    list(
                        `name`="top_positive_feature", 
                        `title`="Top Positive Feature", 
                        `type`="text"),
                    list(
                        `name`="top_negative_feature", 
                        `title`="Top Negative Feature", 
                        `type`="text"),
                    list(
                        `name`="explanation_confidence", 
                        `title`="Explanation Confidence", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="model_comparison",
                title="Model Comparison",
                visible="(compare_models)",
                columns=list(
                    list(
                        `name`="model_type", 
                        `title`="Model Type", 
                        `type`="text"),
                    list(
                        `name`="auc_roc", 
                        `title`="AUC-ROC", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="accuracy", 
                        `title`="Accuracy", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="f1_score", 
                        `title`="F1 Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="calibration_slope", 
                        `title`="Calibration Slope", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="brier_score", 
                        `title`="Brier Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="training_time", 
                        `title`="Training Time (s)", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="risk_stratification",
                title="Risk Stratification Analysis",
                visible="(risk_stratification)",
                columns=list(
                    list(
                        `name`="risk_group", 
                        `title`="Risk Group", 
                        `type`="text"),
                    list(
                        `name`="risk_range", 
                        `title`="Risk Range", 
                        `type`="text"),
                    list(
                        `name`="n_patients", 
                        `title`="N Patients", 
                        `type`="integer"),
                    list(
                        `name`="event_rate", 
                        `title`="Event Rate", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="mean_risk_score", 
                        `title`="Mean Risk Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="clinical_interpretation", 
                        `title`="Clinical Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="decision_curve_analysis",
                title="Decision Curve Analysis",
                visible="(decision_curve)",
                columns=list(
                    list(
                        `name`="threshold", 
                        `title`="Threshold", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="net_benefit_model", 
                        `title`="Net Benefit (Model)", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="net_benefit_all", 
                        `title`="Net Benefit (Treat All)", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="net_benefit_none", 
                        `title`="Net Benefit (Treat None)", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="cross_validation_results",
                title="Cross-Validation Results",
                columns=list(
                    list(
                        `name`="fold", 
                        `title`="Fold", 
                        `type`="integer"),
                    list(
                        `name`="auc_roc", 
                        `title`="AUC-ROC", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="accuracy", 
                        `title`="Accuracy", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="calibration_slope", 
                        `title`="Calibration Slope", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="stability_analysis",
                title="Model Stability Analysis",
                visible="(stability_analysis)",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="mean_performance", 
                        `title`="Mean Performance", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="std_performance", 
                        `title`="Std Performance", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cv_performance", 
                        `title`="CV Performance", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="stability_index", 
                        `title`="Stability Index", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="bias_fairness_analysis",
                title="Bias and Fairness Analysis",
                visible="(bias_analysis)",
                columns=list(
                    list(
                        `name`="demographic_group", 
                        `title`="Demographic Group", 
                        `type`="text"),
                    list(
                        `name`="n_patients", 
                        `title`="N Patients", 
                        `type`="integer"),
                    list(
                        `name`="auc_roc", 
                        `title`="AUC-ROC", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="calibration_slope", 
                        `title`="Calibration Slope", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="equalized_odds", 
                        `title`="Equalized Odds", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="demographic_parity", 
                        `title`="Demographic Parity", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="hyperparameter_results",
                title="Hyperparameter Optimization Results",
                visible="(hyperparameter_tuning)",
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="optimal_value", 
                        `title`="Optimal Value", 
                        `type`="text"),
                    list(
                        `name`="search_range", 
                        `title`="Search Range", 
                        `type`="text"),
                    list(
                        `name`="importance", 
                        `title`="Parameter Importance", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="clinical_interpretation",
                title="Clinical Interpretation and Recommendations",
                visible="(clinical_report)",
                columns=list(
                    list(
                        `name`="aspect", 
                        `title`="Aspect", 
                        `type`="text"),
                    list(
                        `name`="finding", 
                        `title`="Finding", 
                        `type`="text"),
                    list(
                        `name`="clinical_implication", 
                        `title`="Clinical Implication", 
                        `type`="text"),
                    list(
                        `name`="recommendation", 
                        `title`="Recommendation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="regulatory_summary",
                title="Regulatory Documentation Summary",
                visible="(regulatory_documentation)",
                columns=list(
                    list(
                        `name`="requirement", 
                        `title`="Regulatory Requirement", 
                        `type`="text"),
                    list(
                        `name`="status", 
                        `title`="Compliance Status", 
                        `type`="text"),
                    list(
                        `name`="documentation", 
                        `title`="Documentation", 
                        `type`="text"),
                    list(
                        `name`="notes", 
                        `title`="Notes", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="roc_plot",
                title="ROC Curve Analysis",
                visible="(roc_analysis)",
                renderFun=".plot_roc",
                clearWith=list(
                    "model_type",
                    "outcome_var")))
            self$add(jmvcore::Image$new(
                options=options,
                name="calibration_plot",
                title="Calibration Plot",
                visible="(calibration_analysis)",
                renderFun=".plot_calibration",
                clearWith=list(
                    "model_type",
                    "outcome_var")))
            self$add(jmvcore::Image$new(
                options=options,
                name="feature_importance_plot",
                title="Feature Importance Plot",
                visible="(interpretability)",
                renderFun=".plot_feature_importance",
                clearWith=list(
                    "predictor_vars",
                    "model_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="shap_summary_plot",
                title="SHAP Summary Plot",
                visible="(shap_analysis)",
                renderFun=".plot_shap_summary",
                clearWith=list(
                    "predictor_vars",
                    "model_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="shap_dependence_plot",
                title="SHAP Partial Dependence Plots",
                visible="(partial_dependence && shap_analysis)",
                renderFun=".plot_shap_dependence",
                clearWith=list(
                    "predictor_vars",
                    "model_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="decision_curve_plot",
                title="Decision Curve Analysis Plot",
                visible="(decision_curve)",
                renderFun=".plot_decision_curve",
                clearWith=list(
                    "model_type",
                    "outcome_var")))
            self$add(jmvcore::Image$new(
                options=options,
                name="risk_distribution_plot",
                title="Risk Score Distribution",
                visible="(risk_stratification)",
                renderFun=".plot_risk_distribution",
                clearWith=list(
                    "model_type",
                    "outcome_var")))
            self$add(jmvcore::Image$new(
                options=options,
                name="model_comparison_plot",
                title="Model Comparison Plot",
                visible="(compare_models)",
                renderFun=".plot_model_comparison",
                clearWith=list(
                    "model_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="stability_plot",
                title="Model Stability Visualization",
                visible="(stability_analysis)",
                renderFun=".plot_stability",
                clearWith=list(
                    "validation_method",
                    "model_type")))
            self$add(jmvcore::Image$new(
                options=options,
                name="nomogram_plot",
                title="Clinical Nomogram",
                visible="(nomogram)",
                renderFun=".plot_nomogram",
                clearWith=list(
                    "predictor_vars",
                    "model_type")))}))

clinicalpredictionBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinicalpredictionBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "clinicalprediction",
                version = c(1,0,0),
                options = options,
                results = clinicalpredictionResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Clinical Prediction Models & ML Interpretability
#'
#' Develop and validate clinical prediction models using machine learning 
#' algorithms
#' with interpretability analysis. Includes comprehensive model comparison, 
#' feature
#' selection, cross-validation, and explainable AI through SHAP and LIME 
#' methods.
#' Designed for clinical research applications with regulatory compliance 
#' features
#' for model validation and documentation.
#' 
#'
#' @examples
#' data('clinical_data')
#'
#' clinicalprediction(
#'     data = clinical_data,
#'     outcome_var = "mortality",
#'     predictor_vars = c("age", "biomarker", "stage"),
#'     model_type = "random_forest",
#'     interpretability = TRUE,
#'     validation_method = "cv_10fold"
#' )
#'
#' @param data the data as a data frame
#' @param outcome_var Target variable for prediction (binary, continuous, or
#'   survival)
#' @param predictor_vars Variables to use as predictors in the model
#' @param patient_id Patient identifier for tracking predictions
#' @param time_var Time to event variable for survival prediction models
#' @param event_var Event indicator for survival prediction models
#' @param stratify_var Variable for stratified sampling and validation
#' @param model_type Type of machine learning model to fit
#' @param problem_type Type of prediction problem
#' @param outcome_type Specific type of outcome variable
#' @param feature_selection Perform automated feature selection
#' @param selection_method Method for automatic feature selection
#' @param feature_engineering Perform automated feature engineering
#' @param handle_missing Method for handling missing data
#' @param train_proportion Proportion of data for training (70\% = 0.7)
#' @param validation_method Method for model validation
#' @param hyperparameter_tuning Perform automated hyperparameter optimization
#' @param tuning_method Method for hyperparameter tuning
#' @param random_seed Random seed for reproducibility
#' @param interpretability Generate model interpretability analysis
#' @param shap_analysis Generate SHAP (SHapley Additive exPlanations) values
#' @param lime_analysis Generate LIME (Local Interpretable Model-agnostic
#'   Explanations)
#' @param permutation_importance Calculate permutation feature importance
#' @param partial_dependence Generate partial dependence plots for key
#'   features
#' @param individual_explanations Explain individual predictions using
#'   SHAP/LIME
#' @param n_explanations Number of individual predictions to explain in detail
#' @param performance_metrics Calculate comprehensive performance metrics
#' @param calibration_analysis Assess model calibration
#' @param clinical_metrics Calculate clinical decision analysis metrics
#' @param roc_analysis Perform ROC curve analysis with confidence intervals
#' @param threshold_optimization Optimize prediction threshold for clinical
#'   use
#' @param compare_models Compare multiple model types
#' @param baseline_models Include simple baseline models for comparison
#' @param ensemble_models Create ensemble of best performing models
#' @param risk_stratification Create risk stratification groups
#' @param n_risk_groups Number of risk stratification groups (e.g.,
#'   low/medium/high)
#' @param nomogram Create clinical nomogram for risk calculation
#' @param decision_curve Perform decision curve analysis for clinical utility
#' @param external_validation Prepare model for external validation
#' @param bootstrap_ci Number of bootstrap samples for confidence intervals
#' @param stability_analysis Assess model stability across different samples
#' @param bias_analysis Analyze model bias across demographic groups
#' @param detailed_output Include detailed model diagnostics and explanations
#' @param clinical_report Generate clinical interpretation report
#' @param save_model Save trained model for future predictions
#' @param export_predictions Export individual predictions with probabilities
#' @param regulatory_documentation Include documentation for regulatory
#'   submission
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$overview} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$dataset_info} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$feature_selection_results} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$feature_engineering_summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$performance_summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$classification_metrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$survival_metrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$feature_importance} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$shap_summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$individual_explanations} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$model_comparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$risk_stratification} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$decision_curve_analysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$cross_validation_results} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$stability_analysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$bias_fairness_analysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$hyperparameter_results} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clinical_interpretation} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$regulatory_summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$roc_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$calibration_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$feature_importance_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$shap_summary_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$shap_dependence_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$decision_curve_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$risk_distribution_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$model_comparison_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$stability_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$nomogram_plot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$overview$asDF}
#'
#' \code{as.data.frame(results$overview)}
#'
#' @export
clinicalprediction <- function(
    data,
    outcome_var,
    predictor_vars,
    patient_id,
    time_var,
    event_var,
    stratify_var,
    model_type = "random_forest",
    problem_type = "classification",
    outcome_type = "binary",
    feature_selection = TRUE,
    selection_method = "recursive_fe",
    feature_engineering = TRUE,
    handle_missing = "mice_imputation",
    train_proportion = 0.7,
    validation_method = "cv_10fold",
    hyperparameter_tuning = TRUE,
    tuning_method = "random_search",
    random_seed = 42,
    interpretability = TRUE,
    shap_analysis = TRUE,
    lime_analysis = FALSE,
    permutation_importance = TRUE,
    partial_dependence = TRUE,
    individual_explanations = FALSE,
    n_explanations = 10,
    performance_metrics = TRUE,
    calibration_analysis = TRUE,
    clinical_metrics = TRUE,
    roc_analysis = TRUE,
    threshold_optimization = TRUE,
    compare_models = FALSE,
    baseline_models = TRUE,
    ensemble_models = FALSE,
    risk_stratification = TRUE,
    n_risk_groups = 3,
    nomogram = TRUE,
    decision_curve = TRUE,
    external_validation = TRUE,
    bootstrap_ci = 1000,
    stability_analysis = TRUE,
    bias_analysis = TRUE,
    detailed_output = TRUE,
    clinical_report = TRUE,
    save_model = FALSE,
    export_predictions = FALSE,
    regulatory_documentation = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("clinicalprediction requires jmvcore to be installed (restart may be required)")

    if ( ! missing(outcome_var)) outcome_var <- jmvcore::resolveQuo(jmvcore::enquo(outcome_var))
    if ( ! missing(predictor_vars)) predictor_vars <- jmvcore::resolveQuo(jmvcore::enquo(predictor_vars))
    if ( ! missing(patient_id)) patient_id <- jmvcore::resolveQuo(jmvcore::enquo(patient_id))
    if ( ! missing(time_var)) time_var <- jmvcore::resolveQuo(jmvcore::enquo(time_var))
    if ( ! missing(event_var)) event_var <- jmvcore::resolveQuo(jmvcore::enquo(event_var))
    if ( ! missing(stratify_var)) stratify_var <- jmvcore::resolveQuo(jmvcore::enquo(stratify_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(outcome_var), outcome_var, NULL),
            `if`( ! missing(predictor_vars), predictor_vars, NULL),
            `if`( ! missing(patient_id), patient_id, NULL),
            `if`( ! missing(time_var), time_var, NULL),
            `if`( ! missing(event_var), event_var, NULL),
            `if`( ! missing(stratify_var), stratify_var, NULL))

    for (v in event_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in stratify_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- clinicalpredictionOptions$new(
        outcome_var = outcome_var,
        predictor_vars = predictor_vars,
        patient_id = patient_id,
        time_var = time_var,
        event_var = event_var,
        stratify_var = stratify_var,
        model_type = model_type,
        problem_type = problem_type,
        outcome_type = outcome_type,
        feature_selection = feature_selection,
        selection_method = selection_method,
        feature_engineering = feature_engineering,
        handle_missing = handle_missing,
        train_proportion = train_proportion,
        validation_method = validation_method,
        hyperparameter_tuning = hyperparameter_tuning,
        tuning_method = tuning_method,
        random_seed = random_seed,
        interpretability = interpretability,
        shap_analysis = shap_analysis,
        lime_analysis = lime_analysis,
        permutation_importance = permutation_importance,
        partial_dependence = partial_dependence,
        individual_explanations = individual_explanations,
        n_explanations = n_explanations,
        performance_metrics = performance_metrics,
        calibration_analysis = calibration_analysis,
        clinical_metrics = clinical_metrics,
        roc_analysis = roc_analysis,
        threshold_optimization = threshold_optimization,
        compare_models = compare_models,
        baseline_models = baseline_models,
        ensemble_models = ensemble_models,
        risk_stratification = risk_stratification,
        n_risk_groups = n_risk_groups,
        nomogram = nomogram,
        decision_curve = decision_curve,
        external_validation = external_validation,
        bootstrap_ci = bootstrap_ci,
        stability_analysis = stability_analysis,
        bias_analysis = bias_analysis,
        detailed_output = detailed_output,
        clinical_report = clinical_report,
        save_model = save_model,
        export_predictions = export_predictions,
        regulatory_documentation = regulatory_documentation)

    analysis <- clinicalpredictionClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

