
# This file is automatically generated, you probably don't want to edit this

jggheatmapOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jggheatmapOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            matrix_vars = NULL,
            row_var = NULL,
            col_var = NULL,
            value_var = NULL,
            cluster_rows = TRUE,
            cluster_cols = TRUE,
            clustering_method = "complete",
            distance_method = "euclidean",
            scaling = "none",
            color_scheme = "blue_red",
            cell_shape = "square",
            show_values = FALSE,
            value_format = "auto",
            text_size = 8,
            show_row_labels = TRUE,
            show_col_labels = TRUE,
            row_label_size = 10,
            col_label_size = 10,
            show_dendrograms = TRUE,
            dendrogram_height = 0.2,
            annotation_var = NULL,
            annotation_colors = "default",
            plot_title = "",
            plot_width = 600,
            plot_height = 600,
            show_colorbar = TRUE,
            colorbar_title = "Value",
            border_color = "white",
            na_color = "grey90",
            output_format = "plot_only", ...) {

            super$initialize(
                package="ClinicoPath",
                name="jggheatmap",
                requiresData=TRUE,
                ...)

            private$..matrix_vars <- jmvcore::OptionVariables$new(
                "matrix_vars",
                matrix_vars,
                permitted=list(
                    "numeric"))
            private$..row_var <- jmvcore::OptionVariable$new(
                "row_var",
                row_var,
                default=NULL,
                permitted=list(
                    "factor",
                    "id"))
            private$..col_var <- jmvcore::OptionVariable$new(
                "col_var",
                col_var,
                default=NULL,
                permitted=list(
                    "factor",
                    "id"))
            private$..value_var <- jmvcore::OptionVariable$new(
                "value_var",
                value_var,
                default=NULL,
                permitted=list(
                    "numeric"))
            private$..cluster_rows <- jmvcore::OptionBool$new(
                "cluster_rows",
                cluster_rows,
                default=TRUE)
            private$..cluster_cols <- jmvcore::OptionBool$new(
                "cluster_cols",
                cluster_cols,
                default=TRUE)
            private$..clustering_method <- jmvcore::OptionList$new(
                "clustering_method",
                clustering_method,
                options=list(
                    "complete",
                    "average",
                    "single",
                    "ward.D2",
                    "mcquitty"),
                default="complete")
            private$..distance_method <- jmvcore::OptionList$new(
                "distance_method",
                distance_method,
                options=list(
                    "euclidean",
                    "manhattan",
                    "pearson",
                    "spearman",
                    "maximum"),
                default="euclidean")
            private$..scaling <- jmvcore::OptionList$new(
                "scaling",
                scaling,
                options=list(
                    "none",
                    "row",
                    "column",
                    "global"),
                default="none")
            private$..color_scheme <- jmvcore::OptionList$new(
                "color_scheme",
                color_scheme,
                options=list(
                    "blue_red",
                    "viridis",
                    "plasma",
                    "rdylbu",
                    "spectral",
                    "custom"),
                default="blue_red")
            private$..cell_shape <- jmvcore::OptionList$new(
                "cell_shape",
                cell_shape,
                options=list(
                    "square",
                    "circle",
                    "triangle"),
                default="square")
            private$..show_values <- jmvcore::OptionBool$new(
                "show_values",
                show_values,
                default=FALSE)
            private$..value_format <- jmvcore::OptionList$new(
                "value_format",
                value_format,
                options=list(
                    "auto",
                    "integer",
                    "decimal1",
                    "decimal2",
                    "scientific"),
                default="auto")
            private$..text_size <- jmvcore::OptionNumber$new(
                "text_size",
                text_size,
                min=6,
                max=20,
                default=8)
            private$..show_row_labels <- jmvcore::OptionBool$new(
                "show_row_labels",
                show_row_labels,
                default=TRUE)
            private$..show_col_labels <- jmvcore::OptionBool$new(
                "show_col_labels",
                show_col_labels,
                default=TRUE)
            private$..row_label_size <- jmvcore::OptionNumber$new(
                "row_label_size",
                row_label_size,
                min=6,
                max=16,
                default=10)
            private$..col_label_size <- jmvcore::OptionNumber$new(
                "col_label_size",
                col_label_size,
                min=6,
                max=16,
                default=10)
            private$..show_dendrograms <- jmvcore::OptionBool$new(
                "show_dendrograms",
                show_dendrograms,
                default=TRUE)
            private$..dendrogram_height <- jmvcore::OptionNumber$new(
                "dendrogram_height",
                dendrogram_height,
                min=0.1,
                max=0.5,
                default=0.2)
            private$..annotation_var <- jmvcore::OptionVariable$new(
                "annotation_var",
                annotation_var,
                default=NULL)
            private$..annotation_colors <- jmvcore::OptionList$new(
                "annotation_colors",
                annotation_colors,
                options=list(
                    "default",
                    "set1",
                    "dark2",
                    "paired"),
                default="default")
            private$..plot_title <- jmvcore::OptionString$new(
                "plot_title",
                plot_title,
                default="")
            private$..plot_width <- jmvcore::OptionNumber$new(
                "plot_width",
                plot_width,
                min=400,
                max=1200,
                default=600)
            private$..plot_height <- jmvcore::OptionNumber$new(
                "plot_height",
                plot_height,
                min=400,
                max=1200,
                default=600)
            private$..show_colorbar <- jmvcore::OptionBool$new(
                "show_colorbar",
                show_colorbar,
                default=TRUE)
            private$..colorbar_title <- jmvcore::OptionString$new(
                "colorbar_title",
                colorbar_title,
                default="Value")
            private$..border_color <- jmvcore::OptionString$new(
                "border_color",
                border_color,
                default="white")
            private$..na_color <- jmvcore::OptionString$new(
                "na_color",
                na_color,
                default="grey90")
            private$..output_format <- jmvcore::OptionList$new(
                "output_format",
                output_format,
                options=list(
                    "plot_only",
                    "data_matrix",
                    "both"),
                default="plot_only")

            self$.addOption(private$..matrix_vars)
            self$.addOption(private$..row_var)
            self$.addOption(private$..col_var)
            self$.addOption(private$..value_var)
            self$.addOption(private$..cluster_rows)
            self$.addOption(private$..cluster_cols)
            self$.addOption(private$..clustering_method)
            self$.addOption(private$..distance_method)
            self$.addOption(private$..scaling)
            self$.addOption(private$..color_scheme)
            self$.addOption(private$..cell_shape)
            self$.addOption(private$..show_values)
            self$.addOption(private$..value_format)
            self$.addOption(private$..text_size)
            self$.addOption(private$..show_row_labels)
            self$.addOption(private$..show_col_labels)
            self$.addOption(private$..row_label_size)
            self$.addOption(private$..col_label_size)
            self$.addOption(private$..show_dendrograms)
            self$.addOption(private$..dendrogram_height)
            self$.addOption(private$..annotation_var)
            self$.addOption(private$..annotation_colors)
            self$.addOption(private$..plot_title)
            self$.addOption(private$..plot_width)
            self$.addOption(private$..plot_height)
            self$.addOption(private$..show_colorbar)
            self$.addOption(private$..colorbar_title)
            self$.addOption(private$..border_color)
            self$.addOption(private$..na_color)
            self$.addOption(private$..output_format)
        }),
    active = list(
        matrix_vars = function() private$..matrix_vars$value,
        row_var = function() private$..row_var$value,
        col_var = function() private$..col_var$value,
        value_var = function() private$..value_var$value,
        cluster_rows = function() private$..cluster_rows$value,
        cluster_cols = function() private$..cluster_cols$value,
        clustering_method = function() private$..clustering_method$value,
        distance_method = function() private$..distance_method$value,
        scaling = function() private$..scaling$value,
        color_scheme = function() private$..color_scheme$value,
        cell_shape = function() private$..cell_shape$value,
        show_values = function() private$..show_values$value,
        value_format = function() private$..value_format$value,
        text_size = function() private$..text_size$value,
        show_row_labels = function() private$..show_row_labels$value,
        show_col_labels = function() private$..show_col_labels$value,
        row_label_size = function() private$..row_label_size$value,
        col_label_size = function() private$..col_label_size$value,
        show_dendrograms = function() private$..show_dendrograms$value,
        dendrogram_height = function() private$..dendrogram_height$value,
        annotation_var = function() private$..annotation_var$value,
        annotation_colors = function() private$..annotation_colors$value,
        plot_title = function() private$..plot_title$value,
        plot_width = function() private$..plot_width$value,
        plot_height = function() private$..plot_height$value,
        show_colorbar = function() private$..show_colorbar$value,
        colorbar_title = function() private$..colorbar_title$value,
        border_color = function() private$..border_color$value,
        na_color = function() private$..na_color$value,
        output_format = function() private$..output_format$value),
    private = list(
        ..matrix_vars = NA,
        ..row_var = NA,
        ..col_var = NA,
        ..value_var = NA,
        ..cluster_rows = NA,
        ..cluster_cols = NA,
        ..clustering_method = NA,
        ..distance_method = NA,
        ..scaling = NA,
        ..color_scheme = NA,
        ..cell_shape = NA,
        ..show_values = NA,
        ..value_format = NA,
        ..text_size = NA,
        ..show_row_labels = NA,
        ..show_col_labels = NA,
        ..row_label_size = NA,
        ..col_label_size = NA,
        ..show_dendrograms = NA,
        ..dendrogram_height = NA,
        ..annotation_var = NA,
        ..annotation_colors = NA,
        ..plot_title = NA,
        ..plot_width = NA,
        ..plot_height = NA,
        ..show_colorbar = NA,
        ..colorbar_title = NA,
        ..border_color = NA,
        ..na_color = NA,
        ..output_format = NA)
)

jggheatmapResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jggheatmapResults",
    inherit = jmvcore::Group,
    active = list(
        plot = function() private$.items[["plot"]],
        matrixtab = function() private$.items[["matrixtab"]],
        clustertab = function() private$.items[["clustertab"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Advanced Heatmap Visualization",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot",
                title="Heatmap Visualization",
                width=650,
                height=650,
                renderFun=".plot"))
            self$add(jmvcore::Table$new(
                options=options,
                name="matrixtab",
                title="Data Matrix",
                rows=0,
                visible="(output_format:data_matrix || output_format:both)",
                columns=list(
                    list(
                        `name`="row_name", 
                        `title`="Row", 
                        `type`="text"),
                    list(
                        `name`="col_name", 
                        `title`="Column", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="clustertab",
                title="Clustering Results",
                rows=0,
                visible="(cluster_rows || cluster_cols)",
                columns=list(
                    list(
                        `name`="item", 
                        `title`="Item", 
                        `type`="text"),
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="integer"),
                    list(
                        `name`="height", 
                        `title`="Height", 
                        `type`="number"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Heatmap Interpretation"))}))

jggheatmapBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jggheatmapBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "jggheatmap",
                version = c(1,0,0),
                options = options,
                results = jggheatmapResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Advanced Heatmap Visualization
#'
#' 
#' @param data .
#' @param matrix_vars Variables to include in the heatmap matrix
#' @param row_var Variable defining row groupings (for pivot format)
#' @param col_var Variable defining column groupings (for pivot format)
#' @param value_var Variable containing matrix values (for pivot format)
#' @param cluster_rows Perform hierarchical clustering on rows
#' @param cluster_cols Perform hierarchical clustering on columns
#' @param clustering_method .
#' @param distance_method .
#' @param scaling .
#' @param color_scheme .
#' @param cell_shape .
#' @param show_values Display numeric values in cells
#' @param value_format .
#' @param text_size Size of text in cells
#' @param show_row_labels .
#' @param show_col_labels .
#' @param row_label_size .
#' @param col_label_size .
#' @param show_dendrograms Display clustering dendrograms
#' @param dendrogram_height Height of dendrogram relative to plot
#' @param annotation_var Variable for row/column annotations
#' @param annotation_colors .
#' @param plot_title .
#' @param plot_width .
#' @param plot_height .
#' @param show_colorbar Display color scale legend
#' @param colorbar_title .
#' @param border_color .
#' @param na_color .
#' @param output_format .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$matrixtab} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clustertab} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$matrixtab$asDF}
#'
#' \code{as.data.frame(results$matrixtab)}
#'
#' @export
jggheatmap <- function(
    data,
    matrix_vars,
    row_var = NULL,
    col_var = NULL,
    value_var = NULL,
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    clustering_method = "complete",
    distance_method = "euclidean",
    scaling = "none",
    color_scheme = "blue_red",
    cell_shape = "square",
    show_values = FALSE,
    value_format = "auto",
    text_size = 8,
    show_row_labels = TRUE,
    show_col_labels = TRUE,
    row_label_size = 10,
    col_label_size = 10,
    show_dendrograms = TRUE,
    dendrogram_height = 0.2,
    annotation_var = NULL,
    annotation_colors = "default",
    plot_title = "",
    plot_width = 600,
    plot_height = 600,
    show_colorbar = TRUE,
    colorbar_title = "Value",
    border_color = "white",
    na_color = "grey90",
    output_format = "plot_only") {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("jggheatmap requires jmvcore to be installed (restart may be required)")

    if ( ! missing(matrix_vars)) matrix_vars <- jmvcore::resolveQuo(jmvcore::enquo(matrix_vars))
    if ( ! missing(row_var)) row_var <- jmvcore::resolveQuo(jmvcore::enquo(row_var))
    if ( ! missing(col_var)) col_var <- jmvcore::resolveQuo(jmvcore::enquo(col_var))
    if ( ! missing(value_var)) value_var <- jmvcore::resolveQuo(jmvcore::enquo(value_var))
    if ( ! missing(annotation_var)) annotation_var <- jmvcore::resolveQuo(jmvcore::enquo(annotation_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(matrix_vars), matrix_vars, NULL),
            `if`( ! missing(row_var), row_var, NULL),
            `if`( ! missing(col_var), col_var, NULL),
            `if`( ! missing(value_var), value_var, NULL),
            `if`( ! missing(annotation_var), annotation_var, NULL))


    options <- jggheatmapOptions$new(
        matrix_vars = matrix_vars,
        row_var = row_var,
        col_var = col_var,
        value_var = value_var,
        cluster_rows = cluster_rows,
        cluster_cols = cluster_cols,
        clustering_method = clustering_method,
        distance_method = distance_method,
        scaling = scaling,
        color_scheme = color_scheme,
        cell_shape = cell_shape,
        show_values = show_values,
        value_format = value_format,
        text_size = text_size,
        show_row_labels = show_row_labels,
        show_col_labels = show_col_labels,
        row_label_size = row_label_size,
        col_label_size = col_label_size,
        show_dendrograms = show_dendrograms,
        dendrogram_height = dendrogram_height,
        annotation_var = annotation_var,
        annotation_colors = annotation_colors,
        plot_title = plot_title,
        plot_width = plot_width,
        plot_height = plot_height,
        show_colorbar = show_colorbar,
        colorbar_title = colorbar_title,
        border_color = border_color,
        na_color = na_color,
        output_format = output_format)

    analysis <- jggheatmapClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

