
# This file is automatically generated, you probably don't want to edit this

multistatesurvivalOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "multistatesurvivalOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            id = NULL,
            time_start = NULL,
            time_stop = NULL,
            state_from = NULL,
            state_to = NULL,
            covariates = NULL,
            model_type = "markov",
            transition_matrix = "auto",
            state_names = "",
            initial_state = "1",
            absorbing_states = "",
            transition_probabilities = TRUE,
            state_probabilities = TRUE,
            sojourn_times = TRUE,
            hazard_ratios = TRUE,
            prediction_times = "6,12,24,60",
            plot_transitions = TRUE,
            plot_probabilities = TRUE,
            plot_cumhazard = TRUE,
            plot_individual = FALSE,
            competing_risks = TRUE,
            time_varying = FALSE,
            stratified = NULL,
            confidence_level = 0.95,
            bootstrap_ci = FALSE,
            n_bootstrap = 1000, ...) {

            super$initialize(
                package="ClinicoPath",
                name="multistatesurvival",
                requiresData=TRUE,
                ...)

            private$..id <- jmvcore::OptionVariable$new(
                "id",
                id,
                suggested=list(
                    "id"),
                permitted=list(
                    "id",
                    "factor",
                    "numeric"))
            private$..time_start <- jmvcore::OptionVariable$new(
                "time_start",
                time_start,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..time_stop <- jmvcore::OptionVariable$new(
                "time_stop",
                time_stop,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..state_from <- jmvcore::OptionVariable$new(
                "state_from",
                state_from,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..state_to <- jmvcore::OptionVariable$new(
                "state_to",
                state_to,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..model_type <- jmvcore::OptionList$new(
                "model_type",
                model_type,
                options=list(
                    "markov",
                    "semimarkov",
                    "clock_reset",
                    "clock_forward"),
                default="markov")
            private$..transition_matrix <- jmvcore::OptionString$new(
                "transition_matrix",
                transition_matrix,
                default="auto")
            private$..state_names <- jmvcore::OptionString$new(
                "state_names",
                state_names,
                default="")
            private$..initial_state <- jmvcore::OptionString$new(
                "initial_state",
                initial_state,
                default="1")
            private$..absorbing_states <- jmvcore::OptionString$new(
                "absorbing_states",
                absorbing_states,
                default="")
            private$..transition_probabilities <- jmvcore::OptionBool$new(
                "transition_probabilities",
                transition_probabilities,
                default=TRUE)
            private$..state_probabilities <- jmvcore::OptionBool$new(
                "state_probabilities",
                state_probabilities,
                default=TRUE)
            private$..sojourn_times <- jmvcore::OptionBool$new(
                "sojourn_times",
                sojourn_times,
                default=TRUE)
            private$..hazard_ratios <- jmvcore::OptionBool$new(
                "hazard_ratios",
                hazard_ratios,
                default=TRUE)
            private$..prediction_times <- jmvcore::OptionString$new(
                "prediction_times",
                prediction_times,
                default="6,12,24,60")
            private$..plot_transitions <- jmvcore::OptionBool$new(
                "plot_transitions",
                plot_transitions,
                default=TRUE)
            private$..plot_probabilities <- jmvcore::OptionBool$new(
                "plot_probabilities",
                plot_probabilities,
                default=TRUE)
            private$..plot_cumhazard <- jmvcore::OptionBool$new(
                "plot_cumhazard",
                plot_cumhazard,
                default=TRUE)
            private$..plot_individual <- jmvcore::OptionBool$new(
                "plot_individual",
                plot_individual,
                default=FALSE)
            private$..competing_risks <- jmvcore::OptionBool$new(
                "competing_risks",
                competing_risks,
                default=TRUE)
            private$..time_varying <- jmvcore::OptionBool$new(
                "time_varying",
                time_varying,
                default=FALSE)
            private$..stratified <- jmvcore::OptionVariable$new(
                "stratified",
                stratified,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.5,
                max=0.99)
            private$..bootstrap_ci <- jmvcore::OptionBool$new(
                "bootstrap_ci",
                bootstrap_ci,
                default=FALSE)
            private$..n_bootstrap <- jmvcore::OptionInteger$new(
                "n_bootstrap",
                n_bootstrap,
                default=1000,
                min=100,
                max=10000)

            self$.addOption(private$..id)
            self$.addOption(private$..time_start)
            self$.addOption(private$..time_stop)
            self$.addOption(private$..state_from)
            self$.addOption(private$..state_to)
            self$.addOption(private$..covariates)
            self$.addOption(private$..model_type)
            self$.addOption(private$..transition_matrix)
            self$.addOption(private$..state_names)
            self$.addOption(private$..initial_state)
            self$.addOption(private$..absorbing_states)
            self$.addOption(private$..transition_probabilities)
            self$.addOption(private$..state_probabilities)
            self$.addOption(private$..sojourn_times)
            self$.addOption(private$..hazard_ratios)
            self$.addOption(private$..prediction_times)
            self$.addOption(private$..plot_transitions)
            self$.addOption(private$..plot_probabilities)
            self$.addOption(private$..plot_cumhazard)
            self$.addOption(private$..plot_individual)
            self$.addOption(private$..competing_risks)
            self$.addOption(private$..time_varying)
            self$.addOption(private$..stratified)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..bootstrap_ci)
            self$.addOption(private$..n_bootstrap)
        }),
    active = list(
        id = function() private$..id$value,
        time_start = function() private$..time_start$value,
        time_stop = function() private$..time_stop$value,
        state_from = function() private$..state_from$value,
        state_to = function() private$..state_to$value,
        covariates = function() private$..covariates$value,
        model_type = function() private$..model_type$value,
        transition_matrix = function() private$..transition_matrix$value,
        state_names = function() private$..state_names$value,
        initial_state = function() private$..initial_state$value,
        absorbing_states = function() private$..absorbing_states$value,
        transition_probabilities = function() private$..transition_probabilities$value,
        state_probabilities = function() private$..state_probabilities$value,
        sojourn_times = function() private$..sojourn_times$value,
        hazard_ratios = function() private$..hazard_ratios$value,
        prediction_times = function() private$..prediction_times$value,
        plot_transitions = function() private$..plot_transitions$value,
        plot_probabilities = function() private$..plot_probabilities$value,
        plot_cumhazard = function() private$..plot_cumhazard$value,
        plot_individual = function() private$..plot_individual$value,
        competing_risks = function() private$..competing_risks$value,
        time_varying = function() private$..time_varying$value,
        stratified = function() private$..stratified$value,
        confidence_level = function() private$..confidence_level$value,
        bootstrap_ci = function() private$..bootstrap_ci$value,
        n_bootstrap = function() private$..n_bootstrap$value),
    private = list(
        ..id = NA,
        ..time_start = NA,
        ..time_stop = NA,
        ..state_from = NA,
        ..state_to = NA,
        ..covariates = NA,
        ..model_type = NA,
        ..transition_matrix = NA,
        ..state_names = NA,
        ..initial_state = NA,
        ..absorbing_states = NA,
        ..transition_probabilities = NA,
        ..state_probabilities = NA,
        ..sojourn_times = NA,
        ..hazard_ratios = NA,
        ..prediction_times = NA,
        ..plot_transitions = NA,
        ..plot_probabilities = NA,
        ..plot_cumhazard = NA,
        ..plot_individual = NA,
        ..competing_risks = NA,
        ..time_varying = NA,
        ..stratified = NA,
        ..confidence_level = NA,
        ..bootstrap_ci = NA,
        ..n_bootstrap = NA)
)

multistatesurvivalResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "multistatesurvivalResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        summary = function() private$.items[["summary"]],
        transitionMatrix = function() private$.items[["transitionMatrix"]],
        stateTable = function() private$.items[["stateTable"]],
        hazardTable = function() private$.items[["hazardTable"]],
        sojournTable = function() private$.items[["sojournTable"]],
        transitionPlot = function() private$.items[["transitionPlot"]],
        probabilityPlot = function() private$.items[["probabilityPlot"]],
        cumhazardPlot = function() private$.items[["cumhazardPlot"]],
        individualPredictions = function() private$.items[["individualPredictions"]],
        modelFit = function() private$.items[["modelFit"]],
        stratifiedResults = function() private$.items[["stratifiedResults"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Multistate Survival Models",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "mstate",
                    "survival",
                    "glue"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="To Do",
                clearWith=list(
                    "id",
                    "time_start",
                    "time_stop",
                    "state_from",
                    "state_to")))
            self$add(jmvcore::Html$new(
                options=options,
                name="summary",
                title="Analysis Summary",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="transitionMatrix",
                title="Transition Matrix",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="from_state", 
                        `title`="From State", 
                        `type`="text"),
                    list(
                        `name`="to_state", 
                        `title`="To State", 
                        `type`="text"),
                    list(
                        `name`="transitions", 
                        `title`="N Transitions", 
                        `type`="integer"),
                    list(
                        `name`="rate", 
                        `title`="Transition Rate", 
                        `type`="number"),
                    list(
                        `name`="rate_ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="rate_ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="stateTable",
                title="State Occupation Probabilities",
                visible="(state_probabilities)",
                rows=1,
                columns=list(
                    list(
                        `name`="time", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="state", 
                        `title`="State", 
                        `type`="text"),
                    list(
                        `name`="probability", 
                        `title`="Probability", 
                        `type`="number"),
                    list(
                        `name`="prob_ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="prob_ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="hazardTable",
                title="Transition Hazard Ratios",
                visible="(hazard_ratios)",
                rows=1,
                columns=list(
                    list(
                        `name`="transition", 
                        `title`="Transition", 
                        `type`="text"),
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="hazard_ratio", 
                        `title`="HR", 
                        `type`="number"),
                    list(
                        `name`="hr_ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="hr_ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="sojournTable",
                title="Expected Sojourn Times",
                visible="(sojourn_times)",
                rows=1,
                columns=list(
                    list(
                        `name`="state", 
                        `title`="State", 
                        `type`="text"),
                    list(
                        `name`="mean_time", 
                        `title`="Mean Time", 
                        `type`="number"),
                    list(
                        `name`="median_time", 
                        `title`="Median Time", 
                        `type`="number"),
                    list(
                        `name`="sojourn_ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="sojourn_ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="transitionPlot",
                title="Transition Diagram",
                width=800,
                height=600,
                renderFun=".plotTransitions",
                visible="(plot_transitions)",
                clearWith=list(
                    "id",
                    "state_from",
                    "state_to",
                    "state_names")))
            self$add(jmvcore::Image$new(
                options=options,
                name="probabilityPlot",
                title="State Occupation Probabilities",
                width=700,
                height=450,
                renderFun=".plotProbabilities",
                visible="(plot_probabilities)",
                clearWith=list(
                    "id",
                    "time_start",
                    "time_stop",
                    "state_from",
                    "state_to",
                    "prediction_times")))
            self$add(jmvcore::Image$new(
                options=options,
                name="cumhazardPlot",
                title="Cumulative Hazard Functions",
                width=700,
                height=450,
                renderFun=".plotCumHazard",
                visible="(plot_cumhazard)",
                clearWith=list(
                    "id",
                    "time_start",
                    "time_stop",
                    "state_from",
                    "state_to")))
            self$add(jmvcore::Table$new(
                options=options,
                name="individualPredictions",
                title="Individual Predictions",
                visible="(plot_individual)",
                rows=1,
                columns=list(
                    list(
                        `name`="patient_id", 
                        `title`="Patient ID", 
                        `type`="text"),
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="predicted_state", 
                        `title`="Most Likely State", 
                        `type`="text"),
                    list(
                        `name`="state_1_prob", 
                        `title`="State 1 Prob", 
                        `type`="number"),
                    list(
                        `name`="state_2_prob", 
                        `title`="State 2 Prob", 
                        `type`="number"),
                    list(
                        `name`="state_3_prob", 
                        `title`="State 3 Prob", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelFit",
                title="Model Fit Statistics",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="description", 
                        `title`="Description", 
                        `type`="text"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="stratifiedResults",
                title="Stratified Analysis Results",
                visible="(stratified)",
                clearWith=list(
                    "stratified",
                    "id",
                    "state_from",
                    "state_to")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation",
                visible=TRUE))}))

multistatesurvivalBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "multistatesurvivalBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "multistatesurvival",
                version = c(0,0,3),
                options = options,
                results = multistatesurvivalResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Multistate Survival Models
#'
#' Multistate models for analyzing disease progression through multiple 
#' states.
#' Implements transition probabilities, state occupation probabilities, and 
#' competing transitions for complex disease pathways in clinical research.
#' 
#'
#' @examples
#' \donttest{
#' # Example: Cancer progression model
#' # States: Diagnosis -> Remission -> Relapse -> Death
#' #                   -> Death (direct)
#' multistatesurvival(
#'     data = cancer_data,
#'     id = patient_id,
#'     time = follow_up_time,
#'     state = disease_state,
#'     covariates = c(age, stage, treatment)
#' )
#'}
#' @param data The data as a data frame.
#' @param id Patient ID variable for tracking individuals
#' @param time_start Start time of observation period
#' @param time_stop End time of observation period
#' @param state_from State at beginning of interval
#' @param state_to State at end of interval
#' @param covariates Variables influencing state transitions
#' @param model_type Multistate model type specification
#' @param transition_matrix Transition matrix specification
#' @param state_names Custom names for model states
#' @param initial_state Starting state specification
#' @param absorbing_states States from which no transitions occur
#' @param transition_probabilities Compute transition probability matrix
#' @param state_probabilities Compute state occupation probabilities
#' @param sojourn_times Compute mean sojourn times
#' @param hazard_ratios Compute transition-specific hazard ratios
#' @param prediction_times Times at which to evaluate probabilities
#' @param plot_transitions Generate transition diagram plot
#' @param plot_probabilities Generate probability curves
#' @param plot_cumhazard Generate cumulative hazard plots
#' @param plot_individual Create individual-level predictions
#' @param competing_risks Use competing risks framework
#' @param time_varying Include time-varying effects
#' @param stratified Stratification variable
#' @param confidence_level Confidence interval level
#' @param bootstrap_ci Bootstrap-based inference
#' @param n_bootstrap Bootstrap iterations
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$transitionMatrix} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$stateTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$hazardTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$sojournTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$transitionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$probabilityPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$cumhazardPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$individualPredictions} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelFit} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$stratifiedResults} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$transitionMatrix$asDF}
#'
#' \code{as.data.frame(results$transitionMatrix)}
#'
#' @export
multistatesurvival <- function(
    data,
    id,
    time_start,
    time_stop,
    state_from,
    state_to,
    covariates,
    model_type = "markov",
    transition_matrix = "auto",
    state_names = "",
    initial_state = "1",
    absorbing_states = "",
    transition_probabilities = TRUE,
    state_probabilities = TRUE,
    sojourn_times = TRUE,
    hazard_ratios = TRUE,
    prediction_times = "6,12,24,60",
    plot_transitions = TRUE,
    plot_probabilities = TRUE,
    plot_cumhazard = TRUE,
    plot_individual = FALSE,
    competing_risks = TRUE,
    time_varying = FALSE,
    stratified,
    confidence_level = 0.95,
    bootstrap_ci = FALSE,
    n_bootstrap = 1000) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("multistatesurvival requires jmvcore to be installed (restart may be required)")

    if ( ! missing(id)) id <- jmvcore::resolveQuo(jmvcore::enquo(id))
    if ( ! missing(time_start)) time_start <- jmvcore::resolveQuo(jmvcore::enquo(time_start))
    if ( ! missing(time_stop)) time_stop <- jmvcore::resolveQuo(jmvcore::enquo(time_stop))
    if ( ! missing(state_from)) state_from <- jmvcore::resolveQuo(jmvcore::enquo(state_from))
    if ( ! missing(state_to)) state_to <- jmvcore::resolveQuo(jmvcore::enquo(state_to))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(stratified)) stratified <- jmvcore::resolveQuo(jmvcore::enquo(stratified))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(id), id, NULL),
            `if`( ! missing(time_start), time_start, NULL),
            `if`( ! missing(time_stop), time_stop, NULL),
            `if`( ! missing(state_from), state_from, NULL),
            `if`( ! missing(state_to), state_to, NULL),
            `if`( ! missing(covariates), covariates, NULL),
            `if`( ! missing(stratified), stratified, NULL))

    for (v in stratified) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- multistatesurvivalOptions$new(
        id = id,
        time_start = time_start,
        time_stop = time_stop,
        state_from = state_from,
        state_to = state_to,
        covariates = covariates,
        model_type = model_type,
        transition_matrix = transition_matrix,
        state_names = state_names,
        initial_state = initial_state,
        absorbing_states = absorbing_states,
        transition_probabilities = transition_probabilities,
        state_probabilities = state_probabilities,
        sojourn_times = sojourn_times,
        hazard_ratios = hazard_ratios,
        prediction_times = prediction_times,
        plot_transitions = plot_transitions,
        plot_probabilities = plot_probabilities,
        plot_cumhazard = plot_cumhazard,
        plot_individual = plot_individual,
        competing_risks = competing_risks,
        time_varying = time_varying,
        stratified = stratified,
        confidence_level = confidence_level,
        bootstrap_ci = bootstrap_ci,
        n_bootstrap = n_bootstrap)

    analysis <- multistatesurvivalClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

