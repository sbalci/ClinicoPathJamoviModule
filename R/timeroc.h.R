
# This file is automatically generated, you probably don't want to edit this

timerocOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "timerocOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            outcome = NULL,
            outcomeLevel = NULL,
            marker = NULL,
            timepoints = "12, 36, 60",
            method = "incident",
            bootstrapCI = FALSE,
            nboot = 100,
            plotROC = TRUE,
            plotAUC = TRUE,
            timetypeoutput = "months",
            showOptimalCutoff = TRUE,
            showMarkerStats = TRUE,
            compareBaseline = FALSE,
            smoothAUC = FALSE,
            analysisType = "timedep",
            compareROCs = FALSE,
            markers = NULL,
            rocComparison = "delong",
            youdenIndex = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="timeroc",
                requiresData=TRUE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "ordinal",
                    "nominal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..outcomeLevel <- jmvcore::OptionLevel$new(
                "outcomeLevel",
                outcomeLevel,
                variable="(outcome)")
            private$..marker <- jmvcore::OptionVariable$new(
                "marker",
                marker,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..timepoints <- jmvcore::OptionString$new(
                "timepoints",
                timepoints,
                default="12, 36, 60")
            private$..method <- jmvcore::OptionList$new(
                "method",
                method,
                options=list(
                    "incident",
                    "cumulative",
                    "static"),
                default="incident")
            private$..bootstrapCI <- jmvcore::OptionBool$new(
                "bootstrapCI",
                bootstrapCI,
                default=FALSE)
            private$..nboot <- jmvcore::OptionInteger$new(
                "nboot",
                nboot,
                default=100,
                min=10,
                max=1000)
            private$..plotROC <- jmvcore::OptionBool$new(
                "plotROC",
                plotROC,
                default=TRUE)
            private$..plotAUC <- jmvcore::OptionBool$new(
                "plotAUC",
                plotAUC,
                default=TRUE)
            private$..timetypeoutput <- jmvcore::OptionList$new(
                "timetypeoutput",
                timetypeoutput,
                options=list(
                    "days",
                    "weeks",
                    "months",
                    "years"),
                default="months")
            private$..showOptimalCutoff <- jmvcore::OptionBool$new(
                "showOptimalCutoff",
                showOptimalCutoff,
                default=TRUE)
            private$..showMarkerStats <- jmvcore::OptionBool$new(
                "showMarkerStats",
                showMarkerStats,
                default=TRUE)
            private$..compareBaseline <- jmvcore::OptionBool$new(
                "compareBaseline",
                compareBaseline,
                default=FALSE)
            private$..smoothAUC <- jmvcore::OptionBool$new(
                "smoothAUC",
                smoothAUC,
                default=FALSE)
            private$..analysisType <- jmvcore::OptionList$new(
                "analysisType",
                analysisType,
                options=list(
                    "timedep",
                    "binary"),
                default="timedep")
            private$..compareROCs <- jmvcore::OptionBool$new(
                "compareROCs",
                compareROCs,
                default=FALSE)
            private$..markers <- jmvcore::OptionVariables$new(
                "markers",
                markers,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..rocComparison <- jmvcore::OptionList$new(
                "rocComparison",
                rocComparison,
                options=list(
                    "delong",
                    "bootstrap",
                    "venkatraman"),
                default="delong")
            private$..youdenIndex <- jmvcore::OptionBool$new(
                "youdenIndex",
                youdenIndex,
                default=TRUE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..outcome)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..marker)
            self$.addOption(private$..timepoints)
            self$.addOption(private$..method)
            self$.addOption(private$..bootstrapCI)
            self$.addOption(private$..nboot)
            self$.addOption(private$..plotROC)
            self$.addOption(private$..plotAUC)
            self$.addOption(private$..timetypeoutput)
            self$.addOption(private$..showOptimalCutoff)
            self$.addOption(private$..showMarkerStats)
            self$.addOption(private$..compareBaseline)
            self$.addOption(private$..smoothAUC)
            self$.addOption(private$..analysisType)
            self$.addOption(private$..compareROCs)
            self$.addOption(private$..markers)
            self$.addOption(private$..rocComparison)
            self$.addOption(private$..youdenIndex)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        outcome = function() private$..outcome$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        marker = function() private$..marker$value,
        timepoints = function() private$..timepoints$value,
        method = function() private$..method$value,
        bootstrapCI = function() private$..bootstrapCI$value,
        nboot = function() private$..nboot$value,
        plotROC = function() private$..plotROC$value,
        plotAUC = function() private$..plotAUC$value,
        timetypeoutput = function() private$..timetypeoutput$value,
        showOptimalCutoff = function() private$..showOptimalCutoff$value,
        showMarkerStats = function() private$..showMarkerStats$value,
        compareBaseline = function() private$..compareBaseline$value,
        smoothAUC = function() private$..smoothAUC$value,
        analysisType = function() private$..analysisType$value,
        compareROCs = function() private$..compareROCs$value,
        markers = function() private$..markers$value,
        rocComparison = function() private$..rocComparison$value,
        youdenIndex = function() private$..youdenIndex$value),
    private = list(
        ..elapsedtime = NA,
        ..outcome = NA,
        ..outcomeLevel = NA,
        ..marker = NA,
        ..timepoints = NA,
        ..method = NA,
        ..bootstrapCI = NA,
        ..nboot = NA,
        ..plotROC = NA,
        ..plotAUC = NA,
        ..timetypeoutput = NA,
        ..showOptimalCutoff = NA,
        ..showMarkerStats = NA,
        ..compareBaseline = NA,
        ..smoothAUC = NA,
        ..analysisType = NA,
        ..compareROCs = NA,
        ..markers = NA,
        ..rocComparison = NA,
        ..youdenIndex = NA)
)

timerocResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "timerocResults",
    inherit = jmvcore::Group,
    active = list(
        text = function() private$.items[["text"]],
        aucTable = function() private$.items[["aucTable"]],
        rocPlot = function() private$.items[["rocPlot"]],
        aucPlot = function() private$.items[["aucPlot"]],
        markerStats = function() private$.items[["markerStats"]],
        cutoffTable = function() private$.items[["cutoffTable"]],
        modelComparison = function() private$.items[["modelComparison"]],
        clinicalInterpretation = function() private$.items[["clinicalInterpretation"]],
        binaryROCTable = function() private$.items[["binaryROCTable"]],
        rocComparison = function() private$.items[["rocComparison"]],
        binaryROCPlot = function() private$.items[["binaryROCPlot"]],
        diagnosticPerformance = function() private$.items[["diagnosticPerformance"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Time-Dependent ROC Analysis")
            self$add(jmvcore::Html$new(
                options=options,
                name="text",
                title="Time-Dependent ROC Analysis Results"))
            self$add(jmvcore::Table$new(
                options=options,
                name="aucTable",
                title="Area Under ROC Curve (AUC)",
                rows=0,
                columns=list(
                    list(
                        `name`="timepoint", 
                        `title`="Timepoint", 
                        `type`="integer"),
                    list(
                        `name`="auc", 
                        `title`="AUC", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="rocPlot",
                title="ROC Curves",
                width=600,
                height=450,
                renderFun=".plotROC",
                visible="(plotROC)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="aucPlot",
                title="AUC Over Time",
                width=600,
                height=450,
                renderFun=".plotAUC",
                visible="(plotAUC)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="markerStats",
                title="Marker Variable Statistics",
                visible="(showMarkerStats)",
                rows=1,
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="cutoffTable",
                title="Optimal Cutoff Values",
                visible="(showOptimalCutoff)",
                rows=0,
                columns=list(
                    list(
                        `name`="timepoint", 
                        `title`="Timepoint", 
                        `type`="integer"),
                    list(
                        `name`="cutoff", 
                        `title`="Optimal Cutoff", 
                        `type`="number"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity", 
                        `type`="number"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity", 
                        `type`="number"),
                    list(
                        `name`="youden", 
                        `title`="Youden Index", 
                        `type`="number"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="modelComparison",
                title="Model Performance Comparison",
                visible="(compareBaseline)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalInterpretation",
                title="Clinical Interpretation"))
            self$add(jmvcore::Table$new(
                options=options,
                name="binaryROCTable",
                title="Binary ROC Analysis Results",
                visible="(analysisType:binary)",
                rows=0,
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="auc", 
                        `title`="AUC", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity", 
                        `type`="number"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity", 
                        `type`="number"),
                    list(
                        `name`="optimal_cutoff", 
                        `title`="Optimal Cutoff", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="rocComparison",
                title="ROC Curve Comparison",
                visible="(compareROCs)",
                rows=0,
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"),
                    list(
                        `name`="test_statistic", 
                        `title`="Test Statistic", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="binaryROCPlot",
                title="Binary ROC Curves",
                width=600,
                height=450,
                renderFun=".plotBinaryROC",
                visible="(analysisType:binary && plotROC)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="diagnosticPerformance",
                title="Diagnostic Performance Summary",
                visible="(analysisType:binary)"))}))

timerocBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "timerocBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "timeroc",
                version = c(1,1,0),
                options = options,
                results = timerocResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Enhanced ROC Analysis
#'
#' 
#' @param data .
#' @param elapsedtime .
#' @param outcome .
#' @param outcomeLevel .
#' @param marker .
#' @param timepoints .
#' @param method .
#' @param bootstrapCI .
#' @param nboot .
#' @param plotROC .
#' @param plotAUC .
#' @param timetypeoutput Time units for display in plots and results.
#' @param showOptimalCutoff Calculate and display optimal cutoff points that
#'   maximize Youden index.
#' @param showMarkerStats Display descriptive statistics for the marker
#'   variable.
#' @param compareBaseline Compare marker performance to a baseline model (AUC
#'   = 0.5).
#' @param smoothAUC Apply smoothing to the AUC over time plot for better
#'   visualization.
#' @param analysisType Choose between time-dependent ROC analysis or general
#'   binary classification ROC.
#' @param compareROCs Compare multiple ROC curves using statistical tests
#'   (DeLong test for binary ROC).
#' @param markers Additional marker variables to compare against the primary
#'   marker.
#' @param rocComparison Statistical method for comparing ROC curves (binary
#'   analysis only).
#' @param youdenIndex Calculate Youden index (sensitivity + specificity - 1)
#'   for optimal threshold selection.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$text} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$aucTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$rocPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$aucPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$markerStats} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$cutoffTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelComparison} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$clinicalInterpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$binaryROCTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$rocComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$binaryROCPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$diagnosticPerformance} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$aucTable$asDF}
#'
#' \code{as.data.frame(results$aucTable)}
#'
#' @export
timeroc <- function(
    data,
    elapsedtime,
    outcome,
    outcomeLevel,
    marker,
    timepoints = "12, 36, 60",
    method = "incident",
    bootstrapCI = FALSE,
    nboot = 100,
    plotROC = TRUE,
    plotAUC = TRUE,
    timetypeoutput = "months",
    showOptimalCutoff = TRUE,
    showMarkerStats = TRUE,
    compareBaseline = FALSE,
    smoothAUC = FALSE,
    analysisType = "timedep",
    compareROCs = FALSE,
    markers,
    rocComparison = "delong",
    youdenIndex = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("timeroc requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(marker)) marker <- jmvcore::resolveQuo(jmvcore::enquo(marker))
    if ( ! missing(markers)) markers <- jmvcore::resolveQuo(jmvcore::enquo(markers))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(elapsedtime), elapsedtime, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(marker), marker, NULL),
            `if`( ! missing(markers), markers, NULL))


    options <- timerocOptions$new(
        elapsedtime = elapsedtime,
        outcome = outcome,
        outcomeLevel = outcomeLevel,
        marker = marker,
        timepoints = timepoints,
        method = method,
        bootstrapCI = bootstrapCI,
        nboot = nboot,
        plotROC = plotROC,
        plotAUC = plotAUC,
        timetypeoutput = timetypeoutput,
        showOptimalCutoff = showOptimalCutoff,
        showMarkerStats = showMarkerStats,
        compareBaseline = compareBaseline,
        smoothAUC = smoothAUC,
        analysisType = analysisType,
        compareROCs = compareROCs,
        markers = markers,
        rocComparison = rocComparison,
        youdenIndex = youdenIndex)

    analysis <- timerocClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

