
# This file is automatically generated, you probably don't want to edit this

jppsOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jppsOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            analysis_type = "predictors",
            target_var = NULL,
            predictor_var = NULL,
            predictor_vars = NULL,
            matrix_vars = NULL,
            algorithm = "auto",
            cv_folds = 4,
            sample_size = 5000,
            show_heatmap = TRUE,
            show_barplot = TRUE,
            show_correlation_comparison = FALSE,
            correlation_method = "pearson",
            min_pps_threshold = 0,
            sort_results = "pps_desc",
            color_scheme = "viridis",
            custom_color_low = "#FFFFFF",
            custom_color_high = "#FF0000",
            show_values_on_plot = TRUE,
            plot_title = "",
            show_summary = TRUE,
            show_interpretation = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="jpps",
                requiresData=TRUE,
                ...)

            private$..analysis_type <- jmvcore::OptionList$new(
                "analysis_type",
                analysis_type,
                options=list(
                    "single",
                    "predictors",
                    "matrix",
                    "compare"),
                default="predictors")
            private$..target_var <- jmvcore::OptionVariable$new(
                "target_var",
                target_var,
                default=NULL)
            private$..predictor_var <- jmvcore::OptionVariable$new(
                "predictor_var",
                predictor_var,
                default=NULL)
            private$..predictor_vars <- jmvcore::OptionVariables$new(
                "predictor_vars",
                predictor_vars,
                default=NULL)
            private$..matrix_vars <- jmvcore::OptionVariables$new(
                "matrix_vars",
                matrix_vars,
                default=NULL)
            private$..algorithm <- jmvcore::OptionList$new(
                "algorithm",
                algorithm,
                options=list(
                    "tree",
                    "forest",
                    "auto"),
                default="auto")
            private$..cv_folds <- jmvcore::OptionInteger$new(
                "cv_folds",
                cv_folds,
                min=2,
                max=20,
                default=4)
            private$..sample_size <- jmvcore::OptionInteger$new(
                "sample_size",
                sample_size,
                min=100,
                max=10000,
                default=5000)
            private$..show_heatmap <- jmvcore::OptionBool$new(
                "show_heatmap",
                show_heatmap,
                default=TRUE)
            private$..show_barplot <- jmvcore::OptionBool$new(
                "show_barplot",
                show_barplot,
                default=TRUE)
            private$..show_correlation_comparison <- jmvcore::OptionBool$new(
                "show_correlation_comparison",
                show_correlation_comparison,
                default=FALSE)
            private$..correlation_method <- jmvcore::OptionList$new(
                "correlation_method",
                correlation_method,
                options=list(
                    "pearson",
                    "spearman",
                    "kendall"),
                default="pearson")
            private$..min_pps_threshold <- jmvcore::OptionNumber$new(
                "min_pps_threshold",
                min_pps_threshold,
                min=0,
                max=1,
                default=0)
            private$..sort_results <- jmvcore::OptionList$new(
                "sort_results",
                sort_results,
                options=list(
                    "pps_desc",
                    "pps_asc",
                    "alphabetical",
                    "none"),
                default="pps_desc")
            private$..color_scheme <- jmvcore::OptionList$new(
                "color_scheme",
                color_scheme,
                options=list(
                    "viridis",
                    "blues",
                    "reds",
                    "greens",
                    "custom"),
                default="viridis")
            private$..custom_color_low <- jmvcore::OptionString$new(
                "custom_color_low",
                custom_color_low,
                default="#FFFFFF")
            private$..custom_color_high <- jmvcore::OptionString$new(
                "custom_color_high",
                custom_color_high,
                default="#FF0000")
            private$..show_values_on_plot <- jmvcore::OptionBool$new(
                "show_values_on_plot",
                show_values_on_plot,
                default=TRUE)
            private$..plot_title <- jmvcore::OptionString$new(
                "plot_title",
                plot_title,
                default="")
            private$..show_summary <- jmvcore::OptionBool$new(
                "show_summary",
                show_summary,
                default=TRUE)
            private$..show_interpretation <- jmvcore::OptionBool$new(
                "show_interpretation",
                show_interpretation,
                default=TRUE)

            self$.addOption(private$..analysis_type)
            self$.addOption(private$..target_var)
            self$.addOption(private$..predictor_var)
            self$.addOption(private$..predictor_vars)
            self$.addOption(private$..matrix_vars)
            self$.addOption(private$..algorithm)
            self$.addOption(private$..cv_folds)
            self$.addOption(private$..sample_size)
            self$.addOption(private$..show_heatmap)
            self$.addOption(private$..show_barplot)
            self$.addOption(private$..show_correlation_comparison)
            self$.addOption(private$..correlation_method)
            self$.addOption(private$..min_pps_threshold)
            self$.addOption(private$..sort_results)
            self$.addOption(private$..color_scheme)
            self$.addOption(private$..custom_color_low)
            self$.addOption(private$..custom_color_high)
            self$.addOption(private$..show_values_on_plot)
            self$.addOption(private$..plot_title)
            self$.addOption(private$..show_summary)
            self$.addOption(private$..show_interpretation)
        }),
    active = list(
        analysis_type = function() private$..analysis_type$value,
        target_var = function() private$..target_var$value,
        predictor_var = function() private$..predictor_var$value,
        predictor_vars = function() private$..predictor_vars$value,
        matrix_vars = function() private$..matrix_vars$value,
        algorithm = function() private$..algorithm$value,
        cv_folds = function() private$..cv_folds$value,
        sample_size = function() private$..sample_size$value,
        show_heatmap = function() private$..show_heatmap$value,
        show_barplot = function() private$..show_barplot$value,
        show_correlation_comparison = function() private$..show_correlation_comparison$value,
        correlation_method = function() private$..correlation_method$value,
        min_pps_threshold = function() private$..min_pps_threshold$value,
        sort_results = function() private$..sort_results$value,
        color_scheme = function() private$..color_scheme$value,
        custom_color_low = function() private$..custom_color_low$value,
        custom_color_high = function() private$..custom_color_high$value,
        show_values_on_plot = function() private$..show_values_on_plot$value,
        plot_title = function() private$..plot_title$value,
        show_summary = function() private$..show_summary$value,
        show_interpretation = function() private$..show_interpretation$value),
    private = list(
        ..analysis_type = NA,
        ..target_var = NA,
        ..predictor_var = NA,
        ..predictor_vars = NA,
        ..matrix_vars = NA,
        ..algorithm = NA,
        ..cv_folds = NA,
        ..sample_size = NA,
        ..show_heatmap = NA,
        ..show_barplot = NA,
        ..show_correlation_comparison = NA,
        ..correlation_method = NA,
        ..min_pps_threshold = NA,
        ..sort_results = NA,
        ..color_scheme = NA,
        ..custom_color_low = NA,
        ..custom_color_high = NA,
        ..show_values_on_plot = NA,
        ..plot_title = NA,
        ..show_summary = NA,
        ..show_interpretation = NA)
)

jppsResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jppsResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        pps_scores = function() private$.items[["pps_scores"]],
        correlation_comparison = function() private$.items[["correlation_comparison"]],
        pps_heatmap = function() private$.items[["pps_heatmap"]],
        pps_barplot = function() private$.items[["pps_barplot"]],
        comparison_plot = function() private$.items[["comparison_plot"]],
        summary_stats = function() private$.items[["summary_stats"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Predictive Power Score Analysis",
                refs=list(
                    "ClinicoPathJamoviModule",
                    ".step",
                    "ppsr"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Analysis Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="pps_scores",
                title="PPS Scores",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="predictor", 
                        `title`="Predictor", 
                        `type`="text"),
                    list(
                        `name`="target", 
                        `title`="Target", 
                        `type`="text"),
                    list(
                        `name`="pps_score", 
                        `title`="PPS Score", 
                        `type`="number", 
                        `format`="zto,dp:4"),
                    list(
                        `name`="baseline_score", 
                        `title`="Baseline Score", 
                        `type`="number", 
                        `format`="zto,dp:4"),
                    list(
                        `name`="model_score", 
                        `title`="Model Score", 
                        `type`="number", 
                        `format`="zto,dp:4"),
                    list(
                        `name`="cross_validation", 
                        `title`="CV Method", 
                        `type`="text")),
                clearWith=list(
                    "analysis_type",
                    "target_var",
                    "predictor_var",
                    "predictor_vars",
                    "matrix_vars",
                    "algorithm",
                    "cv_folds")))
            self$add(jmvcore::Table$new(
                options=options,
                name="correlation_comparison",
                title="PPS vs Correlation Comparison",
                visible="(show_correlation_comparison)",
                columns=list(
                    list(
                        `name`="variable_pair", 
                        `title`="Variable Pair", 
                        `type`="text"),
                    list(
                        `name`="pps_score", 
                        `title`="PPS Score", 
                        `type`="number", 
                        `format`="zto,dp:4"),
                    list(
                        `name`="correlation", 
                        `title`="Correlation", 
                        `type`="number", 
                        `format`="zto,dp:4"),
                    list(
                        `name`="pps_advantage", 
                        `title`="PPS Advantage", 
                        `type`="number", 
                        `format`="zto,dp:4")),
                clearWith=list(
                    "analysis_type",
                    "target_var",
                    "predictor_vars",
                    "matrix_vars",
                    "correlation_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="pps_heatmap",
                title="PPS Heatmap",
                width=500,
                height=400,
                renderFun=".plot_heatmap",
                visible="(show_heatmap && analysis_type:matrix)",
                clearWith=list(
                    "matrix_vars",
                    "color_scheme",
                    "custom_color_low",
                    "custom_color_high",
                    "show_values_on_plot",
                    "plot_title")))
            self$add(jmvcore::Image$new(
                options=options,
                name="pps_barplot",
                title="PPS Barplot",
                width=500,
                height=400,
                renderFun=".plot_barplot",
                visible="(show_barplot && (analysis_type:predictors || analysis_type:single))",
                clearWith=list(
                    "target_var",
                    "predictor_var",
                    "predictor_vars",
                    "color_scheme",
                    "sort_results",
                    "show_values_on_plot",
                    "plot_title")))
            self$add(jmvcore::Image$new(
                options=options,
                name="comparison_plot",
                title="PPS vs Correlation Plot",
                width=500,
                height=400,
                renderFun=".plot_comparison",
                visible="(show_correlation_comparison && analysis_type:compare)",
                clearWith=list(
                    "matrix_vars",
                    "correlation_method",
                    "color_scheme")))
            self$add(jmvcore::Table$new(
                options=options,
                name="summary_stats",
                title="Analysis Summary",
                visible="(show_summary)",
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text")),
                clearWith=list(
                    "analysis_type",
                    "target_var",
                    "predictor_vars",
                    "matrix_vars")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Interpretation Guide",
                visible="(show_interpretation)"))}))

jppsBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jppsBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "jpps",
                version = c(0,0,31),
                options = options,
                results = jppsResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Predictive Power Score Analysis
#'
#' Predictive Power Score (PPS) analysis provides an asymmetric, 
#' data-type-agnostic
#' score that can detect linear or non-linear relationships between variables.
#' PPS ranges from 0 (no predictive power) to 1 (perfect predictive power).
#' 
#' @param data Dataset for PPS analysis
#' @param analysis_type Type of PPS analysis to perform
#' @param target_var Target variable to predict (for single/predictors
#'   analysis)
#' @param predictor_var Single predictor variable (for single analysis)
#' @param predictor_vars Multiple predictor variables (for predictors
#'   analysis)
#' @param matrix_vars Variables to include in full PPS matrix
#' @param algorithm Machine learning algorithm for PPS calculation
#' @param cv_folds Number of cross-validation folds
#' @param sample_size Maximum sample size for analysis (0 = no limit)
#' @param show_heatmap Display PPS results as heatmap
#' @param show_barplot Display PPS scores as barplot
#' @param show_correlation_comparison Compare PPS with Pearson correlation
#' @param correlation_method Correlation method for comparison
#' @param min_pps_threshold Minimum PPS score to display in results
#' @param sort_results How to sort the results
#' @param color_scheme Color scheme for visualizations
#' @param custom_color_low Color for low PPS values (hex code)
#' @param custom_color_high Color for high PPS values (hex code)
#' @param show_values_on_plot Display PPS values on heatmap/barplot
#' @param plot_title Custom title for plots (auto-generated if empty)
#' @param show_summary Display summary of PPS analysis
#' @param show_interpretation Provide interpretation guidance for PPS results
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$pps_scores} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$correlation_comparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$pps_heatmap} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$pps_barplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$comparison_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$summary_stats} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$pps_scores$asDF}
#'
#' \code{as.data.frame(results$pps_scores)}
#'
#' @export
jpps <- function(
    data,
    analysis_type = "predictors",
    target_var = NULL,
    predictor_var = NULL,
    predictor_vars = NULL,
    matrix_vars = NULL,
    algorithm = "auto",
    cv_folds = 4,
    sample_size = 5000,
    show_heatmap = TRUE,
    show_barplot = TRUE,
    show_correlation_comparison = FALSE,
    correlation_method = "pearson",
    min_pps_threshold = 0,
    sort_results = "pps_desc",
    color_scheme = "viridis",
    custom_color_low = "#FFFFFF",
    custom_color_high = "#FF0000",
    show_values_on_plot = TRUE,
    plot_title = "",
    show_summary = TRUE,
    show_interpretation = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("jpps requires jmvcore to be installed (restart may be required)")

    if ( ! missing(target_var)) target_var <- jmvcore::resolveQuo(jmvcore::enquo(target_var))
    if ( ! missing(predictor_var)) predictor_var <- jmvcore::resolveQuo(jmvcore::enquo(predictor_var))
    if ( ! missing(predictor_vars)) predictor_vars <- jmvcore::resolveQuo(jmvcore::enquo(predictor_vars))
    if ( ! missing(matrix_vars)) matrix_vars <- jmvcore::resolveQuo(jmvcore::enquo(matrix_vars))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(target_var), target_var, NULL),
            `if`( ! missing(predictor_var), predictor_var, NULL),
            `if`( ! missing(predictor_vars), predictor_vars, NULL),
            `if`( ! missing(matrix_vars), matrix_vars, NULL))


    options <- jppsOptions$new(
        analysis_type = analysis_type,
        target_var = target_var,
        predictor_var = predictor_var,
        predictor_vars = predictor_vars,
        matrix_vars = matrix_vars,
        algorithm = algorithm,
        cv_folds = cv_folds,
        sample_size = sample_size,
        show_heatmap = show_heatmap,
        show_barplot = show_barplot,
        show_correlation_comparison = show_correlation_comparison,
        correlation_method = correlation_method,
        min_pps_threshold = min_pps_threshold,
        sort_results = sort_results,
        color_scheme = color_scheme,
        custom_color_low = custom_color_low,
        custom_color_high = custom_color_high,
        show_values_on_plot = show_values_on_plot,
        plot_title = plot_title,
        show_summary = show_summary,
        show_interpretation = show_interpretation)

    analysis <- jppsClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

