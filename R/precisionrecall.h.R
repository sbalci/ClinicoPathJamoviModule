
# This file is automatically generated, you probably don't want to edit this

precisionrecallOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "precisionrecallOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            outcome = NULL,
            positiveClass = NULL,
            scores = NULL,
            interpolation = "nonlinear",
            showBaseline = TRUE,
            aucMethod = "trapezoid",
            ci = FALSE,
            ciMethod = "bootstrap",
            ciSamples = 1000,
            ciWidth = 95,
            comparison = FALSE,
            comparisonMethod = "bootstrap",
            showROC = FALSE,
            showFScore = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="precisionrecall",
                requiresData=TRUE,
                ...)

            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..positiveClass <- jmvcore::OptionLevel$new(
                "positiveClass",
                positiveClass,
                variable="(outcome)")
            private$..scores <- jmvcore::OptionVariables$new(
                "scores",
                scores,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..interpolation <- jmvcore::OptionList$new(
                "interpolation",
                interpolation,
                options=list(
                    "nonlinear",
                    "linear"),
                default="nonlinear")
            private$..showBaseline <- jmvcore::OptionBool$new(
                "showBaseline",
                showBaseline,
                default=TRUE)
            private$..aucMethod <- jmvcore::OptionList$new(
                "aucMethod",
                aucMethod,
                options=list(
                    "trapezoid",
                    "interpolated"),
                default="trapezoid")
            private$..ci <- jmvcore::OptionBool$new(
                "ci",
                ci,
                default=FALSE)
            private$..ciMethod <- jmvcore::OptionList$new(
                "ciMethod",
                ciMethod,
                options=list(
                    "bootstrap",
                    "percentile",
                    "bca"),
                default="bootstrap")
            private$..ciSamples <- jmvcore::OptionInteger$new(
                "ciSamples",
                ciSamples,
                min=100,
                max=10000,
                default=1000)
            private$..ciWidth <- jmvcore::OptionNumber$new(
                "ciWidth",
                ciWidth,
                min=50,
                max=99,
                default=95)
            private$..comparison <- jmvcore::OptionBool$new(
                "comparison",
                comparison,
                default=FALSE)
            private$..comparisonMethod <- jmvcore::OptionList$new(
                "comparisonMethod",
                comparisonMethod,
                options=list(
                    "bootstrap",
                    "permutation"),
                default="bootstrap")
            private$..showROC <- jmvcore::OptionBool$new(
                "showROC",
                showROC,
                default=FALSE)
            private$..showFScore <- jmvcore::OptionBool$new(
                "showFScore",
                showFScore,
                default=FALSE)

            self$.addOption(private$..outcome)
            self$.addOption(private$..positiveClass)
            self$.addOption(private$..scores)
            self$.addOption(private$..interpolation)
            self$.addOption(private$..showBaseline)
            self$.addOption(private$..aucMethod)
            self$.addOption(private$..ci)
            self$.addOption(private$..ciMethod)
            self$.addOption(private$..ciSamples)
            self$.addOption(private$..ciWidth)
            self$.addOption(private$..comparison)
            self$.addOption(private$..comparisonMethod)
            self$.addOption(private$..showROC)
            self$.addOption(private$..showFScore)
        }),
    active = list(
        outcome = function() private$..outcome$value,
        positiveClass = function() private$..positiveClass$value,
        scores = function() private$..scores$value,
        interpolation = function() private$..interpolation$value,
        showBaseline = function() private$..showBaseline$value,
        aucMethod = function() private$..aucMethod$value,
        ci = function() private$..ci$value,
        ciMethod = function() private$..ciMethod$value,
        ciSamples = function() private$..ciSamples$value,
        ciWidth = function() private$..ciWidth$value,
        comparison = function() private$..comparison$value,
        comparisonMethod = function() private$..comparisonMethod$value,
        showROC = function() private$..showROC$value,
        showFScore = function() private$..showFScore$value),
    private = list(
        ..outcome = NA,
        ..positiveClass = NA,
        ..scores = NA,
        ..interpolation = NA,
        ..showBaseline = NA,
        ..aucMethod = NA,
        ..ci = NA,
        ..ciMethod = NA,
        ..ciSamples = NA,
        ..ciWidth = NA,
        ..comparison = NA,
        ..comparisonMethod = NA,
        ..showROC = NA,
        ..showFScore = NA)
)

precisionrecallResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "precisionrecallResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        aucTable = function() private$.items[["aucTable"]],
        comparisonTable = function() private$.items[["comparisonTable"]],
        prcPlot = function() private$.items[["prcPlot"]],
        rocPlot = function() private$.items[["rocPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Precision-Recall Curve",
                refs=list(
                    "Saito2015",
                    "Davis2006"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                visible=FALSE,
                content="<p>Please select an outcome variable and at least one classifier score variable to begin analysis.</p>\n"))
            self$add(jmvcore::Table$new(
                options=options,
                name="aucTable",
                title="Area Under PRC Curve",
                rows="(scores)",
                clearWith=list(
                    "outcome",
                    "scores",
                    "positiveClass",
                    "aucMethod"),
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="auc", 
                        `title`="AUC(PRC)", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="baseline", 
                        `title`="Baseline", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="improvement", 
                        `title`="Improvement", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto,pvalue", 
                        `visible`="(ci)"),
                    list(
                        `name`="upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto,pvalue", 
                        `visible`="(ci)"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="comparisonTable",
                title="Model Comparison",
                visible="(comparison)",
                clearWith=list(
                    "outcome",
                    "scores",
                    "positiveClass",
                    "comparisonMethod"),
                columns=list(
                    list(
                        `name`="model1", 
                        `title`="Model 1", 
                        `type`="text"),
                    list(
                        `name`="model2", 
                        `title`="Model 2", 
                        `type`="text"),
                    list(
                        `name`="aucDiff", 
                        `title`="AUC Difference", 
                        `type`="number"),
                    list(
                        `name`="pValue", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="prcPlot",
                title="Precision-Recall Curve",
                width=500,
                height=400,
                renderFun=".plotPRC",
                clearWith=list(
                    "outcome",
                    "scores",
                    "positiveClass",
                    "interpolation",
                    "showBaseline",
                    "showFScore")))
            self$add(jmvcore::Image$new(
                options=options,
                name="rocPlot",
                title="Companion ROC Curve",
                width=500,
                height=400,
                visible="(showROC)",
                renderFun=".plotROC",
                clearWith=list(
                    "outcome",
                    "scores",
                    "positiveClass")))}))

precisionrecallBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "precisionrecallBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "precisionrecall",
                version = c(0,0,31),
                options = options,
                results = precisionrecallResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Precision-Recall Curve
#'
#' Precision-Recall (PRC) curve analysis for evaluating binary classifiers,
#' especially on imbalanced datasets. Unlike ROC curves, PRC curves show
#' how precision (positive predictive value) varies with recall (sensitivity).
#' 
#' Based on Saito & Rehmsmeier (2015): "The Precision-Recall Plot Is More
#' Informative than the ROC Plot When Evaluating Binary Classifiers on
#' Imbalanced Datasets." PLoS ONE 10(3): e0118432.
#' 
#'
#' @examples
#' # Basic PRC curve
#' precisionrecall(data = mydata, outcome = 'disease', score = 'biomarker')
#'
#' # Compare multiple classifiers
#' precisionrecall(data = mydata, outcome = 'disease',
#'                scores = c('model1', 'model2', 'model3'),
#'                comparison = TRUE)
#'
#' @param data the data as a data frame
#' @param outcome Binary outcome variable (0/1, TRUE/FALSE, or factor with 2
#'   levels)
#' @param positiveClass Value representing positive class (disease/event)
#' @param scores One or more continuous variables containing classifier scores
#'   or predicted probabilities
#' @param interpolation PRC requires non-linear interpolation. Linear shown
#'   for educational comparison.
#' @param showBaseline Display horizontal baseline at y = P/(P+N) representing
#'   random classifier
#' @param aucMethod Method for calculating area under PRC curve
#' @param ci .
#' @param ciMethod .
#' @param ciSamples .
#' @param ciWidth .
#' @param comparison Perform statistical comparison of multiple PRC curves
#' @param comparisonMethod .
#' @param showROC Display ROC curve alongside PRC for comparison
#' @param showFScore Display F₁ score iso-lines on PRC plot
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$aucTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$comparisonTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$prcPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$rocPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$aucTable$asDF}
#'
#' \code{as.data.frame(results$aucTable)}
#'
#' @export
precisionrecall <- function(
    data,
    outcome,
    positiveClass,
    scores,
    interpolation = "nonlinear",
    showBaseline = TRUE,
    aucMethod = "trapezoid",
    ci = FALSE,
    ciMethod = "bootstrap",
    ciSamples = 1000,
    ciWidth = 95,
    comparison = FALSE,
    comparisonMethod = "bootstrap",
    showROC = FALSE,
    showFScore = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("precisionrecall requires jmvcore to be installed (restart may be required)")

    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(scores)) scores <- jmvcore::resolveQuo(jmvcore::enquo(scores))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(scores), scores, NULL))


    options <- precisionrecallOptions$new(
        outcome = outcome,
        positiveClass = positiveClass,
        scores = scores,
        interpolation = interpolation,
        showBaseline = showBaseline,
        aucMethod = aucMethod,
        ci = ci,
        ciMethod = ciMethod,
        ciSamples = ciSamples,
        ciWidth = ciWidth,
        comparison = comparison,
        comparisonMethod = comparisonMethod,
        showROC = showROC,
        showFScore = showFScore)

    analysis <- precisionrecallClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

