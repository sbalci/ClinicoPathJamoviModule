
# This file is automatically generated, you probably don't want to edit this

pcaloadingtestOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "pcaloadingtestOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            vars = NULL,
            ncomp = 3,
            nperm = 1000,
            seed = 123,
            componentfilter = 0,
            center = TRUE,
            scale = TRUE,
            conflevel = 0.95,
            adjustmethod = "BH",
            colorlow = "steelblue1",
            colormid = "white",
            colorhigh = "firebrick1",
            plotwidth = 700,
            plotheight = 450, ...) {

            super$initialize(
                package="ClinicoPath",
                name="pcaloadingtest",
                requiresData=TRUE,
                ...)

            private$..vars <- jmvcore::OptionVariables$new(
                "vars",
                vars,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..ncomp <- jmvcore::OptionInteger$new(
                "ncomp",
                ncomp,
                min=1,
                max=10,
                default=3)
            private$..nperm <- jmvcore::OptionInteger$new(
                "nperm",
                nperm,
                min=100,
                max=5000,
                default=1000)
            private$..seed <- jmvcore::OptionInteger$new(
                "seed",
                seed,
                default=123)
            private$..componentfilter <- jmvcore::OptionInteger$new(
                "componentfilter",
                componentfilter,
                min=0,
                max=10,
                default=0)
            private$..center <- jmvcore::OptionBool$new(
                "center",
                center,
                default=TRUE)
            private$..scale <- jmvcore::OptionBool$new(
                "scale",
                scale,
                default=TRUE)
            private$..conflevel <- jmvcore::OptionNumber$new(
                "conflevel",
                conflevel,
                min=0.8,
                max=0.99,
                default=0.95)
            private$..adjustmethod <- jmvcore::OptionList$new(
                "adjustmethod",
                adjustmethod,
                options=list(
                    "BH",
                    "bonferroni",
                    "holm",
                    "none"),
                default="BH")
            private$..colorlow <- jmvcore::OptionString$new(
                "colorlow",
                colorlow,
                default="steelblue1")
            private$..colormid <- jmvcore::OptionString$new(
                "colormid",
                colormid,
                default="white")
            private$..colorhigh <- jmvcore::OptionString$new(
                "colorhigh",
                colorhigh,
                default="firebrick1")
            private$..plotwidth <- jmvcore::OptionInteger$new(
                "plotwidth",
                plotwidth,
                min=300,
                max=2000,
                default=700)
            private$..plotheight <- jmvcore::OptionInteger$new(
                "plotheight",
                plotheight,
                min=300,
                max=2000,
                default=450)

            self$.addOption(private$..vars)
            self$.addOption(private$..ncomp)
            self$.addOption(private$..nperm)
            self$.addOption(private$..seed)
            self$.addOption(private$..componentfilter)
            self$.addOption(private$..center)
            self$.addOption(private$..scale)
            self$.addOption(private$..conflevel)
            self$.addOption(private$..adjustmethod)
            self$.addOption(private$..colorlow)
            self$.addOption(private$..colormid)
            self$.addOption(private$..colorhigh)
            self$.addOption(private$..plotwidth)
            self$.addOption(private$..plotheight)
        }),
    active = list(
        vars = function() private$..vars$value,
        ncomp = function() private$..ncomp$value,
        nperm = function() private$..nperm$value,
        seed = function() private$..seed$value,
        componentfilter = function() private$..componentfilter$value,
        center = function() private$..center$value,
        scale = function() private$..scale$value,
        conflevel = function() private$..conflevel$value,
        adjustmethod = function() private$..adjustmethod$value,
        colorlow = function() private$..colorlow$value,
        colormid = function() private$..colormid$value,
        colorhigh = function() private$..colorhigh$value,
        plotwidth = function() private$..plotwidth$value,
        plotheight = function() private$..plotheight$value),
    private = list(
        ..vars = NA,
        ..ncomp = NA,
        ..nperm = NA,
        ..seed = NA,
        ..componentfilter = NA,
        ..center = NA,
        ..scale = NA,
        ..conflevel = NA,
        ..adjustmethod = NA,
        ..colorlow = NA,
        ..colormid = NA,
        ..colorhigh = NA,
        ..plotwidth = NA,
        ..plotheight = NA)
)

pcaloadingtestResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "pcaloadingtestResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        results = function() private$.items[["results"]],
        variance = function() private$.items[["variance"]],
        loadingplot = function() private$.items[["loadingplot"]],
        scree = function() private$.items[["scree"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="PCA Loading Significance Test",
                refs=list(
                    "glue",
                    "pracma"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="results",
                title="Loading Significance Results",
                clearWith=list(
                    "vars",
                    "ncomp",
                    "nperm",
                    "seed",
                    "componentfilter",
                    "center",
                    "scale",
                    "conflevel",
                    "adjustmethod"),
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="original", 
                        `title`="Original Loading", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="mean", 
                        `title`="Permuted Mean", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="cilow", 
                        `title`="CI Lower", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="cihigh", 
                        `title`="CI Upper", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="pvalue", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="adjpvalue", 
                        `title`="Adjusted p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="significant", 
                        `title`="Sig.", 
                        `type`="text", 
                        `content`="($key)"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="variance",
                title="Variance Explained",
                clearWith=list(
                    "vars",
                    "ncomp",
                    "seed",
                    "center",
                    "scale"),
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="variance", 
                        `title`="Variance", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cumulative", 
                        `title`="Cumulative", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="loadingplot",
                title="Loading Barplot with Permutation CIs",
                width=700,
                height=450,
                renderFun=".loadingplot",
                requiresData=TRUE,
                clearWith=list(
                    "vars",
                    "ncomp",
                    "nperm",
                    "seed",
                    "componentfilter",
                    "center",
                    "scale",
                    "conflevel",
                    "colorlow",
                    "colormid",
                    "colorhigh",
                    "plotwidth",
                    "plotheight")))
            self$add(jmvcore::Image$new(
                options=options,
                name="scree",
                title="Variance Explained Plot",
                width=700,
                height=450,
                renderFun=".scree",
                requiresData=TRUE,
                clearWith=list(
                    "vars",
                    "ncomp",
                    "seed",
                    "center",
                    "scale",
                    "plotwidth",
                    "plotheight")))}))

pcaloadingtestBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "pcaloadingtestBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "pcaloadingtest",
                version = c(1,0,0),
                options = options,
                results = pcaloadingtestResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' PCA Loading Significance Test
#'
#' Performs permutation-based significance testing for PCA loadings using the
#' permV method (Linting et al., 2011). This approach permutes one variable at
#' a time, providing variable-specific and component-specific significance 
#' thresholds
#' with higher statistical power and proper Type I error control.
#' 
#' Instead of arbitrary cutoffs (e.g., |loading| > 0.5), this test provides
#' objective, hypothesis-tested thresholds for each variable on each 
#' component.
#' Procrustes rotation is applied to handle sign reflection and component
#' indeterminacy issues.
#' 
#'
#' @examples
#' # Example with mtcars dataset
#' data("mtcars")
#'
#' # Test loading significance for first 3 components
#' pcaloadingtest(
#'   data = mtcars,
#'   vars = c("mpg", "disp", "hp", "drat", "wt", "qsec"),
#'   ncomp = 3,
#'   nperm = 1000,
#'   center = TRUE,
#'   scale = TRUE,
#'   conflevel = 0.95,
#'   adjustmethod = "BH"
#' )
#'
#' @section References:
#' Linting M, van Os BJ, Meulman JJ. (2011). Statistical Significance of the Contribution of Variables to the PCA solution: An Alternative Permutation Strategy. Psychometrika, 76(3):440-460.
#'
#' Torres-Espin A, Chou A, Huie JR, et al. (2021). Reproducible analysis of disease space via principal components using the novel R package syndRomics. eLife, 10:e61812.
#'
#' @param data The data as a data frame.
#' @param vars Continuous variables to include in Principal Component
#'   Analysis. Select at least 3 numeric variables.
#' @param ncomp Number of principal components to test loadings for (1 to 10).
#' @param nperm Number of permutations per variable (100-5000). Total
#'   permutations = nperm Ã— number of variables. Higher values provide more
#'   accurate p-values but take longer.
#' @param seed Seed for permutation reproducibility. Use the same seed to
#'   obtain identical results.
#' @param componentfilter Filter results table by component. 0 shows all
#'   components, 1 shows only PC1, 2 shows only PC2, etc.
#' @param center Center variables to have mean = 0 before PCA.
#' @param scale Scale variables to have standard deviation = 1 before PCA.
#' @param conflevel Confidence level for confidence intervals (0.80-0.99).
#' @param adjustmethod Method for adjusting p-values within each component. BH
#'   (Benjamini-Hochberg) controls false discovery rate.
#' @param colorlow Color for negative loadings in barplot.
#' @param colormid Midpoint color for zero loading.
#' @param colorhigh Color for positive loadings in barplot.
#' @param plotwidth Width of the plot in pixels.
#' @param plotheight Height of the plot in pixels.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$results} \tab \tab \tab \tab \tab Permutation-based significance testing for each variable-component loading \cr
#'   \code{results$variance} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$loadingplot} \tab \tab \tab \tab \tab Barplot showing loadings with confidence intervals from permutation \cr
#'   \code{results$scree} \tab \tab \tab \tab \tab Scree/variance explained plot \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$results$asDF}
#'
#' \code{as.data.frame(results$results)}
#'
#' @export
pcaloadingtest <- function(
    data,
    vars,
    ncomp = 3,
    nperm = 1000,
    seed = 123,
    componentfilter = 0,
    center = TRUE,
    scale = TRUE,
    conflevel = 0.95,
    adjustmethod = "BH",
    colorlow = "steelblue1",
    colormid = "white",
    colorhigh = "firebrick1",
    plotwidth = 700,
    plotheight = 450) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("pcaloadingtest requires jmvcore to be installed (restart may be required)")

    if ( ! missing(vars)) vars <- jmvcore::resolveQuo(jmvcore::enquo(vars))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(vars), vars, NULL))


    options <- pcaloadingtestOptions$new(
        vars = vars,
        ncomp = ncomp,
        nperm = nperm,
        seed = seed,
        componentfilter = componentfilter,
        center = center,
        scale = scale,
        conflevel = conflevel,
        adjustmethod = adjustmethod,
        colorlow = colorlow,
        colormid = colormid,
        colorhigh = colorhigh,
        plotwidth = plotwidth,
        plotheight = plotheight)

    analysis <- pcaloadingtestClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

