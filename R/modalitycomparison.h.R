
# This file is automatically generated, you probably don't want to edit this

modalitycomparisonOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "modalitycomparisonOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            modality1_var = NULL,
            modality2_var = NULL,
            case_id = NULL,
            modality1_name = "Modality 1",
            modality2_name = "Modality 2",
            show_discordance_analysis = TRUE,
            score_categories = "auto",
            show_contingency_table = TRUE,
            calculate_weighted_kappa = FALSE,
            confidence_intervals = TRUE,
            directional_analysis = TRUE,
            low_end_focus = FALSE,
            show_plots = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="modalitycomparison",
                requiresData=TRUE,
                ...)

            private$..modality1_var <- jmvcore::OptionVariable$new(
                "modality1_var",
                modality1_var,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..modality2_var <- jmvcore::OptionVariable$new(
                "modality2_var",
                modality2_var,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..case_id <- jmvcore::OptionVariable$new(
                "case_id",
                case_id,
                suggested=list(
                    "nominal",
                    "id"),
                permitted=list(
                    "factor",
                    "id"),
                default=NULL)
            private$..modality1_name <- jmvcore::OptionString$new(
                "modality1_name",
                modality1_name,
                default="Modality 1")
            private$..modality2_name <- jmvcore::OptionString$new(
                "modality2_name",
                modality2_name,
                default="Modality 2")
            private$..show_discordance_analysis <- jmvcore::OptionBool$new(
                "show_discordance_analysis",
                show_discordance_analysis,
                default=TRUE)
            private$..score_categories <- jmvcore::OptionList$new(
                "score_categories",
                score_categories,
                options=list(
                    "her2_5cat",
                    "her2_4cat",
                    "custom",
                    "auto"),
                default="auto")
            private$..show_contingency_table <- jmvcore::OptionBool$new(
                "show_contingency_table",
                show_contingency_table,
                default=TRUE)
            private$..calculate_weighted_kappa <- jmvcore::OptionBool$new(
                "calculate_weighted_kappa",
                calculate_weighted_kappa,
                default=FALSE)
            private$..confidence_intervals <- jmvcore::OptionBool$new(
                "confidence_intervals",
                confidence_intervals,
                default=TRUE)
            private$..directional_analysis <- jmvcore::OptionBool$new(
                "directional_analysis",
                directional_analysis,
                default=TRUE)
            private$..low_end_focus <- jmvcore::OptionBool$new(
                "low_end_focus",
                low_end_focus,
                default=FALSE)
            private$..show_plots <- jmvcore::OptionBool$new(
                "show_plots",
                show_plots,
                default=TRUE)

            self$.addOption(private$..modality1_var)
            self$.addOption(private$..modality2_var)
            self$.addOption(private$..case_id)
            self$.addOption(private$..modality1_name)
            self$.addOption(private$..modality2_name)
            self$.addOption(private$..show_discordance_analysis)
            self$.addOption(private$..score_categories)
            self$.addOption(private$..show_contingency_table)
            self$.addOption(private$..calculate_weighted_kappa)
            self$.addOption(private$..confidence_intervals)
            self$.addOption(private$..directional_analysis)
            self$.addOption(private$..low_end_focus)
            self$.addOption(private$..show_plots)
        }),
    active = list(
        modality1_var = function() private$..modality1_var$value,
        modality2_var = function() private$..modality2_var$value,
        case_id = function() private$..case_id$value,
        modality1_name = function() private$..modality1_name$value,
        modality2_name = function() private$..modality2_name$value,
        show_discordance_analysis = function() private$..show_discordance_analysis$value,
        score_categories = function() private$..score_categories$value,
        show_contingency_table = function() private$..show_contingency_table$value,
        calculate_weighted_kappa = function() private$..calculate_weighted_kappa$value,
        confidence_intervals = function() private$..confidence_intervals$value,
        directional_analysis = function() private$..directional_analysis$value,
        low_end_focus = function() private$..low_end_focus$value,
        show_plots = function() private$..show_plots$value),
    private = list(
        ..modality1_var = NA,
        ..modality2_var = NA,
        ..case_id = NA,
        ..modality1_name = NA,
        ..modality2_name = NA,
        ..show_discordance_analysis = NA,
        ..score_categories = NA,
        ..show_contingency_table = NA,
        ..calculate_weighted_kappa = NA,
        ..confidence_intervals = NA,
        ..directional_analysis = NA,
        ..low_end_focus = NA,
        ..show_plots = NA)
)

modalitycomparisonResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "modalitycomparisonResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        overviewTable = function() private$.items[["overviewTable"]],
        agreementTable = function() private$.items[["agreementTable"]],
        contingencyTable = function() private$.items[["contingencyTable"]],
        discordanceTable = function() private$.items[["discordanceTable"]],
        directionalBiasTable = function() private$.items[["directionalBiasTable"]],
        lowEndAnalysisTable = function() private$.items[["lowEndAnalysisTable"]],
        caseDetailTable = function() private$.items[["caseDetailTable"]],
        agreementPlot = function() private$.items[["agreementPlot"]],
        discordancePlot = function() private$.items[["discordancePlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Modality Comparison Analysis",
                refs=list(
                    "irr",
                    "ggplot2",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Getting Started"))
            self$add(jmvcore::Table$new(
                options=options,
                name="overviewTable",
                title="Modality Comparison Summary",
                rows=1,
                columns=list(
                    list(
                        `name`="cases", 
                        `title`="Cases", 
                        `type`="integer"),
                    list(
                        `name`="modality1_name", 
                        `title`="Modality 1", 
                        `type`="text"),
                    list(
                        `name`="modality2_name", 
                        `title`="Modality 2", 
                        `type`="text"),
                    list(
                        `name`="categories", 
                        `title`="Categories", 
                        `type`="integer"),
                    list(
                        `name`="concordance_percent", 
                        `title`="Overall Concordance %", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="discordance_count", 
                        `title`="Discordant Cases", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="agreementTable",
                title="Agreement Statistics",
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(confidence_intervals)"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(confidence_intervals)"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="contingencyTable",
                title="Cross-Tabulation of Scores",
                visible="(show_contingency_table)",
                columns=list(
                    list(
                        `name`="modality1_score", 
                        `title`="Modality 1 Score", 
                        `type`="text"),
                    list(
                        `name`="modality2_null", 
                        `title`="Null", 
                        `type`="integer", 
                        `visible`="(score_categories:her2_5cat)"),
                    list(
                        `name`="modality2_ultralow", 
                        `title`="Ultralow", 
                        `type`="integer", 
                        `visible`="(score_categories:her2_5cat)"),
                    list(
                        `name`="modality2_1plus", 
                        `title`="1+", 
                        `type`="integer", 
                        `visible`="(score_categories:her2_5cat || score_categories:her2_4cat)"),
                    list(
                        `name`="modality2_2plus", 
                        `title`="2+", 
                        `type`="integer", 
                        `visible`="(score_categories:her2_5cat || score_categories:her2_4cat)"),
                    list(
                        `name`="modality2_3plus", 
                        `title`="3+", 
                        `type`="integer", 
                        `visible`="(score_categories:her2_5cat || score_categories:her2_4cat)"),
                    list(
                        `name`="modality2_0", 
                        `title`="0", 
                        `type`="integer", 
                        `visible`="(score_categories:her2_4cat)"),
                    list(
                        `name`="total", 
                        `title`="Total", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="discordanceTable",
                title="Discordance Pattern Analysis",
                visible="(show_discordance_analysis)",
                columns=list(
                    list(
                        `name`="pattern", 
                        `title`="Discordance Pattern", 
                        `type`="text"),
                    list(
                        `name`="count", 
                        `title`="Count", 
                        `type`="integer"),
                    list(
                        `name`="percentage", 
                        `title`="Percentage", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="direction", 
                        `title`="Direction", 
                        `type`="text"),
                    list(
                        `name`="clinical_significance", 
                        `title`="Clinical Impact", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="directionalBiasTable",
                title="Directional Bias Analysis",
                visible="(directional_analysis)",
                columns=list(
                    list(
                        `name`="bias_type", 
                        `title`="Bias Type", 
                        `type`="text"),
                    list(
                        `name`="count", 
                        `title`="Count", 
                        `type`="integer"),
                    list(
                        `name`="percentage", 
                        `title`="Percentage", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="significance", 
                        `title`="Significance", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="lowEndAnalysisTable",
                title="Low-End Category Analysis",
                visible="(low_end_focus)",
                columns=list(
                    list(
                        `name`="category_comparison", 
                        `title`="Category Comparison", 
                        `type`="text"),
                    list(
                        `name`="concordance", 
                        `title`="Concordance", 
                        `type`="integer"),
                    list(
                        `name`="discordance", 
                        `title`="Discordance", 
                        `type`="integer"),
                    list(
                        `name`="kappa", 
                        `title`="Kappa", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="clinical_relevance", 
                        `title`="Clinical Relevance", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="caseDetailTable",
                title="Discordant Cases Detail",
                visible="(show_discordance_analysis)",
                columns=list(
                    list(
                        `name`="case_id", 
                        `title`="Case ID", 
                        `type`="text"),
                    list(
                        `name`="modality1_score", 
                        `title`="Modality 1 Score", 
                        `type`="text"),
                    list(
                        `name`="modality2_score", 
                        `title`="Modality 2 Score", 
                        `type`="text"),
                    list(
                        `name`="discordance_type", 
                        `title`="Discordance Type", 
                        `type`="text"),
                    list(
                        `name`="clinical_impact", 
                        `title`="Clinical Impact", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="agreementPlot",
                title="Agreement Visualization",
                width=800,
                height=600,
                renderFun=".agreementPlot",
                visible="(show_plots)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="discordancePlot",
                title="Discordance Pattern Plot",
                width=700,
                height=500,
                renderFun=".discordancePlot",
                visible="(show_discordance_analysis && show_plots)"))}))

modalitycomparisonBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "modalitycomparisonBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "modalitycomparison",
                version = c(0,0,31),
                options = options,
                results = modalitycomparisonResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Modality Comparison Analysis
#'
#' Modality Comparison Analysis for digital pathology validation studies.
#' Compare agreement between different diagnostic modalities (e.g., glass 
#' slides vs digital images)
#' with specialized metrics for pathology applications including discordance 
#' pattern analysis
#' and HER2 scoring validation.
#' 
#'
#' @examples
#' # Basic modality comparison
#' result1 <- modalitycomparison(
#'   data = data,
#'   modality1_var = "glass_slides",
#'   modality2_var = "digital_images",
#'   case_id = "case_number"
#' )
#'
#' # HER2 scoring comparison with 5-category analysis
#' result2 <- modalitycomparison(
#'   data = her2_data,
#'   modality1_var = "glass_score",
#'   modality2_var = "digital_score",
#'   case_id = "case_id",
#'   score_categories = "her2_5cat",
#'   show_discordance_analysis = TRUE
#' )
#'
#' @param data The data as a data frame with paired observations from two
#'   modalities.
#' @param modality1_var Variable containing scores/ratings from the first
#'   modality (e.g., glass slides).
#' @param modality2_var Variable containing scores/ratings from the second
#'   modality (e.g., digital images).
#' @param case_id Optional case identifier variable for tracking individual
#'   cases.
#' @param modality1_name Descriptive name for the first modality (e.g., "Glass
#'   Slides").
#' @param modality2_name Descriptive name for the second modality (e.g.,
#'   "Digital Images").
#' @param show_discordance_analysis Perform detailed analysis of discordance
#'   patterns between modalities.
#' @param score_categories Category system for score interpretation and
#'   analysis.
#' @param show_contingency_table Display detailed cross-tabulation of scores
#'   between modalities.
#' @param calculate_weighted_kappa Calculate weighted kappa for ordinal scores
#'   (requires ordered categories).
#' @param confidence_intervals Calculate and display 95\% confidence intervals
#'   for agreement statistics.
#' @param directional_analysis Analyze systematic bias in one direction (e.g.,
#'   higher scores on digital vs glass).
#' @param low_end_focus Perform specialized analysis focusing on agreement at
#'   low expression levels (relevant for HER2-low/null distinction).
#' @param show_plots Generate scatter plots and agreement visualization.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$overviewTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$agreementTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$contingencyTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$discordanceTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$directionalBiasTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$lowEndAnalysisTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$caseDetailTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$agreementPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$discordancePlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$overviewTable$asDF}
#'
#' \code{as.data.frame(results$overviewTable)}
#'
#' @export
modalitycomparison <- function(
    data,
    modality1_var,
    modality2_var,
    case_id = NULL,
    modality1_name = "Modality 1",
    modality2_name = "Modality 2",
    show_discordance_analysis = TRUE,
    score_categories = "auto",
    show_contingency_table = TRUE,
    calculate_weighted_kappa = FALSE,
    confidence_intervals = TRUE,
    directional_analysis = TRUE,
    low_end_focus = FALSE,
    show_plots = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("modalitycomparison requires jmvcore to be installed (restart may be required)")

    if ( ! missing(modality1_var)) modality1_var <- jmvcore::resolveQuo(jmvcore::enquo(modality1_var))
    if ( ! missing(modality2_var)) modality2_var <- jmvcore::resolveQuo(jmvcore::enquo(modality2_var))
    if ( ! missing(case_id)) case_id <- jmvcore::resolveQuo(jmvcore::enquo(case_id))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(modality1_var), modality1_var, NULL),
            `if`( ! missing(modality2_var), modality2_var, NULL),
            `if`( ! missing(case_id), case_id, NULL))

    for (v in modality1_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in modality2_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- modalitycomparisonOptions$new(
        modality1_var = modality1_var,
        modality2_var = modality2_var,
        case_id = case_id,
        modality1_name = modality1_name,
        modality2_name = modality2_name,
        show_discordance_analysis = show_discordance_analysis,
        score_categories = score_categories,
        show_contingency_table = show_contingency_table,
        calculate_weighted_kappa = calculate_weighted_kappa,
        confidence_intervals = confidence_intervals,
        directional_analysis = directional_analysis,
        low_end_focus = low_end_focus,
        show_plots = show_plots)

    analysis <- modalitycomparisonClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

