
# This file is automatically generated, you probably don't want to edit this

stereologyOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "stereologyOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            intersections = NULL,
            totalPoints = NULL,
            boundaryIntersections = NULL,
            objectCount = NULL,
            referenceArea = NULL,
            sectionThickness = 5,
            gridSpacing = NULL,
            tissueType = "vessels",
            groupVar = NULL,
            calculateAa = TRUE,
            calculateVv = TRUE,
            calculateBa = FALSE,
            calculateNa = FALSE,
            calculateSv = FALSE,
            showConfidenceIntervals = TRUE,
            bootstrapIterations = 1000,
            showGroupComparison = FALSE,
            showDescriptives = TRUE,
            showPlot = TRUE,
            plotType = "bars",
            showMethodology = TRUE,
            showReferences = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="stereology",
                requiresData=TRUE,
                ...)

            private$..intersections <- jmvcore::OptionVariable$new(
                "intersections",
                intersections,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..totalPoints <- jmvcore::OptionVariable$new(
                "totalPoints",
                totalPoints,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..boundaryIntersections <- jmvcore::OptionVariable$new(
                "boundaryIntersections",
                boundaryIntersections,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..objectCount <- jmvcore::OptionVariable$new(
                "objectCount",
                objectCount,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..referenceArea <- jmvcore::OptionVariable$new(
                "referenceArea",
                referenceArea,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..sectionThickness <- jmvcore::OptionNumber$new(
                "sectionThickness",
                sectionThickness,
                min=0.1,
                max=100,
                default=5)
            private$..gridSpacing <- jmvcore::OptionVariable$new(
                "gridSpacing",
                gridSpacing,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..tissueType <- jmvcore::OptionList$new(
                "tissueType",
                tissueType,
                options=list(
                    "vessels",
                    "nuclei",
                    "fibrosis",
                    "inflammation",
                    "tumor",
                    "custom"),
                default="vessels")
            private$..groupVar <- jmvcore::OptionVariable$new(
                "groupVar",
                groupVar,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..calculateAa <- jmvcore::OptionBool$new(
                "calculateAa",
                calculateAa,
                default=TRUE)
            private$..calculateVv <- jmvcore::OptionBool$new(
                "calculateVv",
                calculateVv,
                default=TRUE)
            private$..calculateBa <- jmvcore::OptionBool$new(
                "calculateBa",
                calculateBa,
                default=FALSE)
            private$..calculateNa <- jmvcore::OptionBool$new(
                "calculateNa",
                calculateNa,
                default=FALSE)
            private$..calculateSv <- jmvcore::OptionBool$new(
                "calculateSv",
                calculateSv,
                default=FALSE)
            private$..showConfidenceIntervals <- jmvcore::OptionBool$new(
                "showConfidenceIntervals",
                showConfidenceIntervals,
                default=TRUE)
            private$..bootstrapIterations <- jmvcore::OptionInteger$new(
                "bootstrapIterations",
                bootstrapIterations,
                min=100,
                max=100000,
                default=1000)
            private$..showGroupComparison <- jmvcore::OptionBool$new(
                "showGroupComparison",
                showGroupComparison,
                default=FALSE)
            private$..showDescriptives <- jmvcore::OptionBool$new(
                "showDescriptives",
                showDescriptives,
                default=TRUE)
            private$..showPlot <- jmvcore::OptionBool$new(
                "showPlot",
                showPlot,
                default=TRUE)
            private$..plotType <- jmvcore::OptionList$new(
                "plotType",
                plotType,
                options=list(
                    "bars",
                    "boxplot",
                    "violin"),
                default="bars")
            private$..showMethodology <- jmvcore::OptionBool$new(
                "showMethodology",
                showMethodology,
                default=TRUE)
            private$..showReferences <- jmvcore::OptionBool$new(
                "showReferences",
                showReferences,
                default=FALSE)

            self$.addOption(private$..intersections)
            self$.addOption(private$..totalPoints)
            self$.addOption(private$..boundaryIntersections)
            self$.addOption(private$..objectCount)
            self$.addOption(private$..referenceArea)
            self$.addOption(private$..sectionThickness)
            self$.addOption(private$..gridSpacing)
            self$.addOption(private$..tissueType)
            self$.addOption(private$..groupVar)
            self$.addOption(private$..calculateAa)
            self$.addOption(private$..calculateVv)
            self$.addOption(private$..calculateBa)
            self$.addOption(private$..calculateNa)
            self$.addOption(private$..calculateSv)
            self$.addOption(private$..showConfidenceIntervals)
            self$.addOption(private$..bootstrapIterations)
            self$.addOption(private$..showGroupComparison)
            self$.addOption(private$..showDescriptives)
            self$.addOption(private$..showPlot)
            self$.addOption(private$..plotType)
            self$.addOption(private$..showMethodology)
            self$.addOption(private$..showReferences)
        }),
    active = list(
        intersections = function() private$..intersections$value,
        totalPoints = function() private$..totalPoints$value,
        boundaryIntersections = function() private$..boundaryIntersections$value,
        objectCount = function() private$..objectCount$value,
        referenceArea = function() private$..referenceArea$value,
        sectionThickness = function() private$..sectionThickness$value,
        gridSpacing = function() private$..gridSpacing$value,
        tissueType = function() private$..tissueType$value,
        groupVar = function() private$..groupVar$value,
        calculateAa = function() private$..calculateAa$value,
        calculateVv = function() private$..calculateVv$value,
        calculateBa = function() private$..calculateBa$value,
        calculateNa = function() private$..calculateNa$value,
        calculateSv = function() private$..calculateSv$value,
        showConfidenceIntervals = function() private$..showConfidenceIntervals$value,
        bootstrapIterations = function() private$..bootstrapIterations$value,
        showGroupComparison = function() private$..showGroupComparison$value,
        showDescriptives = function() private$..showDescriptives$value,
        showPlot = function() private$..showPlot$value,
        plotType = function() private$..plotType$value,
        showMethodology = function() private$..showMethodology$value,
        showReferences = function() private$..showReferences$value),
    private = list(
        ..intersections = NA,
        ..totalPoints = NA,
        ..boundaryIntersections = NA,
        ..objectCount = NA,
        ..referenceArea = NA,
        ..sectionThickness = NA,
        ..gridSpacing = NA,
        ..tissueType = NA,
        ..groupVar = NA,
        ..calculateAa = NA,
        ..calculateVv = NA,
        ..calculateBa = NA,
        ..calculateNa = NA,
        ..calculateSv = NA,
        ..showConfidenceIntervals = NA,
        ..bootstrapIterations = NA,
        ..showGroupComparison = NA,
        ..showDescriptives = NA,
        ..showPlot = NA,
        ..plotType = NA,
        ..showMethodology = NA,
        ..showReferences = NA)
)

stereologyResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "stereologyResults",
    inherit = jmvcore::Group,
    active = list(
        descriptives = function() private$.items[["descriptives"]],
        stereologyTable = function() private$.items[["stereologyTable"]],
        groupComparison = function() private$.items[["groupComparison"]],
        groupTests = function() private$.items[["groupTests"]],
        plot = function() private$.items[["plot"]],
        methodology = function() private$.items[["methodology"]],
        references = function() private$.items[["references"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Stereology Analysis")
            self$add(jmvcore::Table$new(
                options=options,
                name="descriptives",
                title="Descriptive Statistics",
                visible="(showDescriptives)",
                rows=1,
                columns=list(
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="mean_intersections", 
                        `title`="Mean Intersections", 
                        `type`="number"),
                    list(
                        `name`="mean_total_points", 
                        `title`="Mean Total Points", 
                        `type`="number"),
                    list(
                        `name`="mean_ref_area", 
                        `title`="Mean Reference Area (\u03BCm\u00B2)", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="stereologyTable",
                title="Stereological Parameters",
                rows=1,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number", 
                        `visible`="(showConfidenceIntervals)"),
                    list(
                        `name`="lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `visible`="(showConfidenceIntervals)"),
                    list(
                        `name`="upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `visible`="(showConfidenceIntervals)"),
                    list(
                        `name`="unit", 
                        `title`="Unit", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="groupComparison",
                title="Group Comparison",
                visible="(showGroupComparison && groupVar)",
                rows=0,
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="aa_mean", 
                        `title`="Aa (Mean)", 
                        `type`="number", 
                        `visible`="(calculateAa)"),
                    list(
                        `name`="aa_sd", 
                        `title`="Aa (SD)", 
                        `type`="number", 
                        `visible`="(calculateAa)"),
                    list(
                        `name`="vv_mean", 
                        `title`="Vv (Mean)", 
                        `type`="number", 
                        `visible`="(calculateVv)"),
                    list(
                        `name`="vv_sd", 
                        `title`="Vv (SD)", 
                        `type`="number", 
                        `visible`="(calculateVv)"),
                    list(
                        `name`="ba_mean", 
                        `title`="Ba (Mean)", 
                        `type`="number", 
                        `visible`="(calculateBa)"),
                    list(
                        `name`="ba_sd", 
                        `title`="Ba (SD)", 
                        `type`="number", 
                        `visible`="(calculateBa)"),
                    list(
                        `name`="na_mean", 
                        `title`="Na (Mean)", 
                        `type`="number", 
                        `visible`="(calculateNa)"),
                    list(
                        `name`="na_sd", 
                        `title`="Na (SD)", 
                        `type`="number", 
                        `visible`="(calculateNa)"),
                    list(
                        `name`="sv_mean", 
                        `title`="Sv (Mean)", 
                        `type`="number", 
                        `visible`="(calculateSv)"),
                    list(
                        `name`="sv_sd", 
                        `title`="Sv (SD)", 
                        `type`="number", 
                        `visible`="(calculateSv)"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="groupTests",
                title="Statistical Tests (Between Groups)",
                visible="(showGroupComparison && groupVar)",
                rows=0,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="test_stat", 
                        `title`="Test Statistic", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot",
                title="Stereological Parameters",
                visible="(showPlot)",
                renderFun=".plot",
                requiresData=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodology",
                title="Methodology & Interpretation",
                visible="(showMethodology)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="references",
                title="References",
                visible="(showReferences)"))}))

stereologyBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "stereologyBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "stereology",
                version = c(1,0,0),
                options = options,
                results = stereologyResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Stereology Analysis
#'
#' 
#' @param data .
#' @param intersections Number of grid intersections (hits) with the structure
#'   of interest (e.g., vessels, nuclei, fibrosis areas).
#' @param totalPoints Total number of grid points or test lines used in the
#'   measurement.
#' @param boundaryIntersections Number of grid line intersections with object
#'   boundaries (for boundary density calculation).
#' @param objectCount Number of discrete objects counted (for numerical
#'   density calculation).
#' @param referenceArea Total reference area examined (in square micrometers).
#'   Typically calculated as: image width × height.
#' @param sectionThickness Histological section thickness in micrometers.
#'   Required for volume density calculations. Default: 5 μm.
#' @param gridSpacing Distance between grid lines in micrometers. Used for
#'   length calculations in boundary/surface density.
#' @param tissueType Type of tissue structure being quantified. This helps
#'   provide context-specific interpretation.
#' @param groupVar Optional grouping variable to compare stereology parameters
#'   across groups (e.g., diagnosis, treatment, grade).
#' @param calculateAa Area density: proportion of reference area occupied by
#'   structure. Formula: Aa = intersection count / total points.
#' @param calculateVv Volume density: proportion of reference volume occupied
#'   by structure. In isotropic sections, Vv = Aa.
#' @param calculateBa Boundary density: boundary length per unit area.
#'   Requires boundary intersection data.
#' @param calculateNa Numerical density: number of objects per unit area.
#'   Requires object count data.
#' @param calculateSv Surface density: surface area per unit volume. Formula:
#'   Sv = 2 × Ba (for isotropic sections).
#' @param showConfidenceIntervals Calculate and display 95\% confidence
#'   intervals for stereological estimates using bootstrap methods.
#' @param bootstrapIterations Number of bootstrap iterations for confidence
#'   interval estimation.
#' @param showGroupComparison Compare stereological parameters across groups
#'   (requires grouping variable).
#' @param showDescriptives .
#' @param showPlot Display bar chart of stereological parameters with
#'   confidence intervals.
#' @param plotType .
#' @param showMethodology Display detailed explanation of stereological
#'   methods, formulas, and interpretation guidelines.
#' @param showReferences Display literature references for stereological
#'   methods.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$descriptives} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$stereologyTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$groupComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$groupTests} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$methodology} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$references} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$descriptives$asDF}
#'
#' \code{as.data.frame(results$descriptives)}
#'
#' @export
stereology <- function(
    data,
    intersections,
    totalPoints,
    boundaryIntersections = NULL,
    objectCount = NULL,
    referenceArea,
    sectionThickness = 5,
    gridSpacing,
    tissueType = "vessels",
    groupVar = NULL,
    calculateAa = TRUE,
    calculateVv = TRUE,
    calculateBa = FALSE,
    calculateNa = FALSE,
    calculateSv = FALSE,
    showConfidenceIntervals = TRUE,
    bootstrapIterations = 1000,
    showGroupComparison = FALSE,
    showDescriptives = TRUE,
    showPlot = TRUE,
    plotType = "bars",
    showMethodology = TRUE,
    showReferences = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("stereology requires jmvcore to be installed (restart may be required)")

    if ( ! missing(intersections)) intersections <- jmvcore::resolveQuo(jmvcore::enquo(intersections))
    if ( ! missing(totalPoints)) totalPoints <- jmvcore::resolveQuo(jmvcore::enquo(totalPoints))
    if ( ! missing(boundaryIntersections)) boundaryIntersections <- jmvcore::resolveQuo(jmvcore::enquo(boundaryIntersections))
    if ( ! missing(objectCount)) objectCount <- jmvcore::resolveQuo(jmvcore::enquo(objectCount))
    if ( ! missing(referenceArea)) referenceArea <- jmvcore::resolveQuo(jmvcore::enquo(referenceArea))
    if ( ! missing(gridSpacing)) gridSpacing <- jmvcore::resolveQuo(jmvcore::enquo(gridSpacing))
    if ( ! missing(groupVar)) groupVar <- jmvcore::resolveQuo(jmvcore::enquo(groupVar))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(intersections), intersections, NULL),
            `if`( ! missing(totalPoints), totalPoints, NULL),
            `if`( ! missing(boundaryIntersections), boundaryIntersections, NULL),
            `if`( ! missing(objectCount), objectCount, NULL),
            `if`( ! missing(referenceArea), referenceArea, NULL),
            `if`( ! missing(gridSpacing), gridSpacing, NULL),
            `if`( ! missing(groupVar), groupVar, NULL))

    for (v in groupVar) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- stereologyOptions$new(
        intersections = intersections,
        totalPoints = totalPoints,
        boundaryIntersections = boundaryIntersections,
        objectCount = objectCount,
        referenceArea = referenceArea,
        sectionThickness = sectionThickness,
        gridSpacing = gridSpacing,
        tissueType = tissueType,
        groupVar = groupVar,
        calculateAa = calculateAa,
        calculateVv = calculateVv,
        calculateBa = calculateBa,
        calculateNa = calculateNa,
        calculateSv = calculateSv,
        showConfidenceIntervals = showConfidenceIntervals,
        bootstrapIterations = bootstrapIterations,
        showGroupComparison = showGroupComparison,
        showDescriptives = showDescriptives,
        showPlot = showPlot,
        plotType = plotType,
        showMethodology = showMethodology,
        showReferences = showReferences)

    analysis <- stereologyClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

