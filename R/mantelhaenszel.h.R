
# This file is automatically generated, you probably don't want to edit this

mantelhaenszelOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "mantelhaenszelOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            rows = NULL,
            cols = NULL,
            strata = NULL,
            measure = "or",
            alpha = 0.05,
            show_stratum_tables = TRUE,
            show_homogeneity_tests = TRUE,
            show_crude_analysis = TRUE,
            continuity_correction = TRUE,
            show_methodology = FALSE,
            show_references = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="mantelhaenszel",
                requiresData=TRUE,
                ...)

            private$..rows <- jmvcore::OptionVariable$new(
                "rows",
                rows,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..cols <- jmvcore::OptionVariable$new(
                "cols",
                cols,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..strata <- jmvcore::OptionVariable$new(
                "strata",
                strata,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..measure <- jmvcore::OptionList$new(
                "measure",
                measure,
                options=list(
                    "or",
                    "rr",
                    "rd"),
                default="or")
            private$..alpha <- jmvcore::OptionNumber$new(
                "alpha",
                alpha,
                min=0.01,
                max=0.1,
                default=0.05)
            private$..show_stratum_tables <- jmvcore::OptionBool$new(
                "show_stratum_tables",
                show_stratum_tables,
                default=TRUE)
            private$..show_homogeneity_tests <- jmvcore::OptionBool$new(
                "show_homogeneity_tests",
                show_homogeneity_tests,
                default=TRUE)
            private$..show_crude_analysis <- jmvcore::OptionBool$new(
                "show_crude_analysis",
                show_crude_analysis,
                default=TRUE)
            private$..continuity_correction <- jmvcore::OptionBool$new(
                "continuity_correction",
                continuity_correction,
                default=TRUE)
            private$..show_methodology <- jmvcore::OptionBool$new(
                "show_methodology",
                show_methodology,
                default=FALSE)
            private$..show_references <- jmvcore::OptionBool$new(
                "show_references",
                show_references,
                default=FALSE)

            self$.addOption(private$..rows)
            self$.addOption(private$..cols)
            self$.addOption(private$..strata)
            self$.addOption(private$..measure)
            self$.addOption(private$..alpha)
            self$.addOption(private$..show_stratum_tables)
            self$.addOption(private$..show_homogeneity_tests)
            self$.addOption(private$..show_crude_analysis)
            self$.addOption(private$..continuity_correction)
            self$.addOption(private$..show_methodology)
            self$.addOption(private$..show_references)
        }),
    active = list(
        rows = function() private$..rows$value,
        cols = function() private$..cols$value,
        strata = function() private$..strata$value,
        measure = function() private$..measure$value,
        alpha = function() private$..alpha$value,
        show_stratum_tables = function() private$..show_stratum_tables$value,
        show_homogeneity_tests = function() private$..show_homogeneity_tests$value,
        show_crude_analysis = function() private$..show_crude_analysis$value,
        continuity_correction = function() private$..continuity_correction$value,
        show_methodology = function() private$..show_methodology$value,
        show_references = function() private$..show_references$value),
    private = list(
        ..rows = NA,
        ..cols = NA,
        ..strata = NA,
        ..measure = NA,
        ..alpha = NA,
        ..show_stratum_tables = NA,
        ..show_homogeneity_tests = NA,
        ..show_crude_analysis = NA,
        ..continuity_correction = NA,
        ..show_methodology = NA,
        ..show_references = NA)
)

mantelhaenszelResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "mantelhaenszelResults",
    inherit = jmvcore::Group,
    active = list(
        mh_summary = function() private$.items[["mh_summary"]],
        crude_analysis = function() private$.items[["crude_analysis"]],
        homogeneity_tests = function() private$.items[["homogeneity_tests"]],
        stratum_specific = function() private$.items[["stratum_specific"]],
        interpretation = function() private$.items[["interpretation"]],
        methodology = function() private$.items[["methodology"]],
        references = function() private$.items[["references"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Mantel-Haenszel Stratified Analysis")
            self$add(jmvcore::Table$new(
                options=options,
                name="mh_summary",
                title="Mantel-Haenszel Summary",
                rows=1,
                columns=list(
                    list(
                        `name`="estimate", 
                        `title`="Common Effect", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower 95% CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper 95% CI", 
                        `type`="number"),
                    list(
                        `name`="chisq", 
                        `title`="MH Chi-Square", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="crude_analysis",
                title="Crude (Unadjusted) Analysis",
                visible="(show_crude_analysis)",
                rows=1,
                columns=list(
                    list(
                        `name`="crude_estimate", 
                        `title`="Crude Effect", 
                        `type`="number"),
                    list(
                        `name`="crude_lower", 
                        `title`="Lower 95% CI", 
                        `type`="number"),
                    list(
                        `name`="crude_upper", 
                        `title`="Upper 95% CI", 
                        `type`="number"),
                    list(
                        `name`="confounding", 
                        `title`="Confounding Present", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="homogeneity_tests",
                title="Tests of Homogeneity Across Strata",
                visible="(show_homogeneity_tests)",
                rows=0,
                columns=list(
                    list(
                        `name`="test_name", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="stratum_specific",
                title="Stratum-Specific Analysis",
                visible="(show_stratum_tables)",
                rows=0,
                columns=list(
                    list(
                        `name`="stratum", 
                        `title`="Stratum", 
                        `type`="text"),
                    list(
                        `name`="n_total", 
                        `title`="Total N", 
                        `type`="integer"),
                    list(
                        `name`="estimate", 
                        `title`="Effect", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower 95% CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper 95% CI", 
                        `type`="number"),
                    list(
                        `name`="chisq", 
                        `title`="Chi-Square", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Interpretation Guide"))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodology",
                title="Methodology",
                visible="(show_methodology)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="references",
                title="References",
                visible="(show_references)"))}))

mantelhaenszelBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "mantelhaenszelBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "mantelhaenszel",
                version = c(1,0,0),
                options = options,
                results = mantelhaenszelResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Mantel-Haenszel Stratified Analysis
#'
#' 
#' @param data .
#' @param rows .
#' @param cols .
#' @param strata .
#' @param measure .
#' @param alpha .
#' @param show_stratum_tables .
#' @param show_homogeneity_tests .
#' @param show_crude_analysis .
#' @param continuity_correction .
#' @param show_methodology .
#' @param show_references .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$mh_summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$crude_analysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$homogeneity_tests} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$stratum_specific} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$methodology} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$references} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$mh_summary$asDF}
#'
#' \code{as.data.frame(results$mh_summary)}
#'
#' @export
mantelhaenszel <- function(
    data,
    rows,
    cols,
    strata,
    measure = "or",
    alpha = 0.05,
    show_stratum_tables = TRUE,
    show_homogeneity_tests = TRUE,
    show_crude_analysis = TRUE,
    continuity_correction = TRUE,
    show_methodology = FALSE,
    show_references = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("mantelhaenszel requires jmvcore to be installed (restart may be required)")

    if ( ! missing(rows)) rows <- jmvcore::resolveQuo(jmvcore::enquo(rows))
    if ( ! missing(cols)) cols <- jmvcore::resolveQuo(jmvcore::enquo(cols))
    if ( ! missing(strata)) strata <- jmvcore::resolveQuo(jmvcore::enquo(strata))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(rows), rows, NULL),
            `if`( ! missing(cols), cols, NULL),
            `if`( ! missing(strata), strata, NULL))

    for (v in rows) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in cols) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in strata) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- mantelhaenszelOptions$new(
        rows = rows,
        cols = cols,
        strata = strata,
        measure = measure,
        alpha = alpha,
        show_stratum_tables = show_stratum_tables,
        show_homogeneity_tests = show_homogeneity_tests,
        show_crude_analysis = show_crude_analysis,
        continuity_correction = continuity_correction,
        show_methodology = show_methodology,
        show_references = show_references)

    analysis <- mantelhaenszelClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

