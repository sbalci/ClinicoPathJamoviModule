
# This file is automatically generated, you probably don't want to edit this

advancedimputationOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "advancedimputationOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            imputation_vars = NULL,
            auxiliary_vars = NULL,
            cluster_var = NULL,
            id_var = NULL,
            n_imputations = 10,
            n_iterations = 10,
            convergence_check = TRUE,
            imputation_method = "pmm",
            categorical_method = "logreg",
            mnar_methods = FALSE,
            mnar_type = "delta_adjustment",
            delta_values = "0",
            sensitivity_analysis = TRUE,
            sensitivity_methods = "all",
            multilevel_imputation = FALSE,
            level1_vars = NULL,
            level2_vars = NULL,
            min_bucket_size = 5,
            exclude_vars = NULL,
            passive_imputation = NULL,
            ridge_penalty = 0.00001,
            remove_collinear = TRUE,
            collinearity_threshold = 0.95,
            diagnostic_plots = TRUE,
            imputation_quality = TRUE,
            cross_validation = FALSE,
            ampute_test = FALSE,
            save_imputations = FALSE,
            pool_results = TRUE,
            show_detailed_output = TRUE,
            regulatory_report = FALSE,
            random_seed = 123, ...) {

            super$initialize(
                package="ClinicoPath",
                name="advancedimputation",
                requiresData=TRUE,
                ...)

            private$..imputation_vars <- jmvcore::OptionVariables$new(
                "imputation_vars",
                imputation_vars,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..auxiliary_vars <- jmvcore::OptionVariables$new(
                "auxiliary_vars",
                auxiliary_vars,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..cluster_var <- jmvcore::OptionVariable$new(
                "cluster_var",
                cluster_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..id_var <- jmvcore::OptionVariable$new(
                "id_var",
                id_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "id"))
            private$..n_imputations <- jmvcore::OptionInteger$new(
                "n_imputations",
                n_imputations,
                min=3,
                max=100,
                default=10)
            private$..n_iterations <- jmvcore::OptionInteger$new(
                "n_iterations",
                n_iterations,
                min=1,
                max=100,
                default=10)
            private$..convergence_check <- jmvcore::OptionBool$new(
                "convergence_check",
                convergence_check,
                default=TRUE)
            private$..imputation_method <- jmvcore::OptionList$new(
                "imputation_method",
                imputation_method,
                options=list(
                    "pmm",
                    "norm",
                    "norm.boot",
                    "norm.nob",
                    "mean",
                    "2l.norm",
                    "2l.pmm",
                    "quadratic",
                    "rf"),
                default="pmm")
            private$..categorical_method <- jmvcore::OptionList$new(
                "categorical_method",
                categorical_method,
                options=list(
                    "logreg",
                    "polyreg",
                    "polr",
                    "lda",
                    "2l.bin",
                    "rf"),
                default="logreg")
            private$..mnar_methods <- jmvcore::OptionBool$new(
                "mnar_methods",
                mnar_methods,
                default=FALSE)
            private$..mnar_type <- jmvcore::OptionList$new(
                "mnar_type",
                mnar_type,
                options=list(
                    "delta_adjustment",
                    "pattern_mixture",
                    "selection_model",
                    "reference_based"),
                default="delta_adjustment")
            private$..delta_values <- jmvcore::OptionString$new(
                "delta_values",
                delta_values,
                default="0")
            private$..sensitivity_analysis <- jmvcore::OptionBool$new(
                "sensitivity_analysis",
                sensitivity_analysis,
                default=TRUE)
            private$..sensitivity_methods <- jmvcore::OptionList$new(
                "sensitivity_methods",
                sensitivity_methods,
                options=list(
                    "multiple_methods",
                    "parameter_variation",
                    "assumption_testing",
                    "all"),
                default="all")
            private$..multilevel_imputation <- jmvcore::OptionBool$new(
                "multilevel_imputation",
                multilevel_imputation,
                default=FALSE)
            private$..level1_vars <- jmvcore::OptionVariables$new(
                "level1_vars",
                level1_vars,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..level2_vars <- jmvcore::OptionVariables$new(
                "level2_vars",
                level2_vars,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..min_bucket_size <- jmvcore::OptionInteger$new(
                "min_bucket_size",
                min_bucket_size,
                min=1,
                max=20,
                default=5)
            private$..exclude_vars <- jmvcore::OptionVariables$new(
                "exclude_vars",
                exclude_vars)
            private$..passive_imputation <- jmvcore::OptionString$new(
                "passive_imputation",
                passive_imputation)
            private$..ridge_penalty <- jmvcore::OptionNumber$new(
                "ridge_penalty",
                ridge_penalty,
                min=0,
                max=1,
                default=0.00001)
            private$..remove_collinear <- jmvcore::OptionBool$new(
                "remove_collinear",
                remove_collinear,
                default=TRUE)
            private$..collinearity_threshold <- jmvcore::OptionNumber$new(
                "collinearity_threshold",
                collinearity_threshold,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..diagnostic_plots <- jmvcore::OptionBool$new(
                "diagnostic_plots",
                diagnostic_plots,
                default=TRUE)
            private$..imputation_quality <- jmvcore::OptionBool$new(
                "imputation_quality",
                imputation_quality,
                default=TRUE)
            private$..cross_validation <- jmvcore::OptionBool$new(
                "cross_validation",
                cross_validation,
                default=FALSE)
            private$..ampute_test <- jmvcore::OptionBool$new(
                "ampute_test",
                ampute_test,
                default=FALSE)
            private$..save_imputations <- jmvcore::OptionBool$new(
                "save_imputations",
                save_imputations,
                default=FALSE)
            private$..pool_results <- jmvcore::OptionBool$new(
                "pool_results",
                pool_results,
                default=TRUE)
            private$..show_detailed_output <- jmvcore::OptionBool$new(
                "show_detailed_output",
                show_detailed_output,
                default=TRUE)
            private$..regulatory_report <- jmvcore::OptionBool$new(
                "regulatory_report",
                regulatory_report,
                default=FALSE)
            private$..random_seed <- jmvcore::OptionInteger$new(
                "random_seed",
                random_seed,
                default=123)

            self$.addOption(private$..imputation_vars)
            self$.addOption(private$..auxiliary_vars)
            self$.addOption(private$..cluster_var)
            self$.addOption(private$..id_var)
            self$.addOption(private$..n_imputations)
            self$.addOption(private$..n_iterations)
            self$.addOption(private$..convergence_check)
            self$.addOption(private$..imputation_method)
            self$.addOption(private$..categorical_method)
            self$.addOption(private$..mnar_methods)
            self$.addOption(private$..mnar_type)
            self$.addOption(private$..delta_values)
            self$.addOption(private$..sensitivity_analysis)
            self$.addOption(private$..sensitivity_methods)
            self$.addOption(private$..multilevel_imputation)
            self$.addOption(private$..level1_vars)
            self$.addOption(private$..level2_vars)
            self$.addOption(private$..min_bucket_size)
            self$.addOption(private$..exclude_vars)
            self$.addOption(private$..passive_imputation)
            self$.addOption(private$..ridge_penalty)
            self$.addOption(private$..remove_collinear)
            self$.addOption(private$..collinearity_threshold)
            self$.addOption(private$..diagnostic_plots)
            self$.addOption(private$..imputation_quality)
            self$.addOption(private$..cross_validation)
            self$.addOption(private$..ampute_test)
            self$.addOption(private$..save_imputations)
            self$.addOption(private$..pool_results)
            self$.addOption(private$..show_detailed_output)
            self$.addOption(private$..regulatory_report)
            self$.addOption(private$..random_seed)
        }),
    active = list(
        imputation_vars = function() private$..imputation_vars$value,
        auxiliary_vars = function() private$..auxiliary_vars$value,
        cluster_var = function() private$..cluster_var$value,
        id_var = function() private$..id_var$value,
        n_imputations = function() private$..n_imputations$value,
        n_iterations = function() private$..n_iterations$value,
        convergence_check = function() private$..convergence_check$value,
        imputation_method = function() private$..imputation_method$value,
        categorical_method = function() private$..categorical_method$value,
        mnar_methods = function() private$..mnar_methods$value,
        mnar_type = function() private$..mnar_type$value,
        delta_values = function() private$..delta_values$value,
        sensitivity_analysis = function() private$..sensitivity_analysis$value,
        sensitivity_methods = function() private$..sensitivity_methods$value,
        multilevel_imputation = function() private$..multilevel_imputation$value,
        level1_vars = function() private$..level1_vars$value,
        level2_vars = function() private$..level2_vars$value,
        min_bucket_size = function() private$..min_bucket_size$value,
        exclude_vars = function() private$..exclude_vars$value,
        passive_imputation = function() private$..passive_imputation$value,
        ridge_penalty = function() private$..ridge_penalty$value,
        remove_collinear = function() private$..remove_collinear$value,
        collinearity_threshold = function() private$..collinearity_threshold$value,
        diagnostic_plots = function() private$..diagnostic_plots$value,
        imputation_quality = function() private$..imputation_quality$value,
        cross_validation = function() private$..cross_validation$value,
        ampute_test = function() private$..ampute_test$value,
        save_imputations = function() private$..save_imputations$value,
        pool_results = function() private$..pool_results$value,
        show_detailed_output = function() private$..show_detailed_output$value,
        regulatory_report = function() private$..regulatory_report$value,
        random_seed = function() private$..random_seed$value),
    private = list(
        ..imputation_vars = NA,
        ..auxiliary_vars = NA,
        ..cluster_var = NA,
        ..id_var = NA,
        ..n_imputations = NA,
        ..n_iterations = NA,
        ..convergence_check = NA,
        ..imputation_method = NA,
        ..categorical_method = NA,
        ..mnar_methods = NA,
        ..mnar_type = NA,
        ..delta_values = NA,
        ..sensitivity_analysis = NA,
        ..sensitivity_methods = NA,
        ..multilevel_imputation = NA,
        ..level1_vars = NA,
        ..level2_vars = NA,
        ..min_bucket_size = NA,
        ..exclude_vars = NA,
        ..passive_imputation = NA,
        ..ridge_penalty = NA,
        ..remove_collinear = NA,
        ..collinearity_threshold = NA,
        ..diagnostic_plots = NA,
        ..imputation_quality = NA,
        ..cross_validation = NA,
        ..ampute_test = NA,
        ..save_imputations = NA,
        ..pool_results = NA,
        ..show_detailed_output = NA,
        ..regulatory_report = NA,
        ..random_seed = NA)
)

advancedimputationResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "advancedimputationResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        summary = function() private$.items[["summary"]],
        imputationMethodSummary = function() private$.items[["imputationMethodSummary"]],
        pooledResults = function() private$.items[["pooledResults"]],
        diagnosticPlot = function() private$.items[["diagnosticPlot"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Advanced Multiple Imputation & Sensitivity Analysis",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "mice"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Analysis Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="summary",
                title="Missing Data Summary",
                rows=1,
                clearWith=list(
                    "imputation_vars"),
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="n_missing", 
                        `title`="Missing", 
                        `type`="integer"),
                    list(
                        `name`="p_missing", 
                        `title`="%", 
                        `type`="number", 
                        `format`="zto:1"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="imputationMethodSummary",
                title="Imputation Model Summary",
                rows=1,
                clearWith=list(
                    "imputation_vars",
                    "imputation_method"),
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="pooledResults",
                title="Pooled Parameter Estimates (Rubin's Rules)",
                visible="(pool_results)",
                rows=1,
                clearWith=list(
                    "imputation_vars",
                    "n_imputations"),
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="std_error", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="statistic", 
                        `title`="t", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto:pvalue"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagnosticPlot",
                title="Imputation Diagnostics",
                visible="(diagnostic_plots)",
                width=600,
                height=400,
                renderFun=".plotDiagnostics",
                clearWith=list(
                    "imputation_vars",
                    "n_imputations")))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Method and Clinical Context",
                visible=TRUE))}))

advancedimputationBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "advancedimputationBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "advancedimputation",
                version = c(1,0,0),
                options = options,
                results = advancedimputationResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Advanced Multiple Imputation & Sensitivity Analysis
#'
#' Advanced multiple imputation by chained equations (MICE) with comprehensive
#' sensitivity analysis for clinical research applications. Includes nested 
#' imputation
#' for multilevel data, missing not at random (MNAR) imputation methods, and
#' comprehensive sensitivity testing for missing data assumptions. Essential 
#' for
#' regulatory-compliant clinical research where missing data handling must be
#' thoroughly documented and validated.
#' 
#'
#' @examples
#' data('clinical_trial_data')
#'
#' advancedimputation(
#'     data = clinical_trial_data,
#'     imputation_vars = c("primary_endpoint", "biomarker", "age"),
#'     auxiliary_vars = c("baseline_score", "treatment_group"),
#'     sensitivity_analysis = TRUE,
#'     mnar_methods = TRUE
#' )
#'
#' @param data the data as a data frame
#' @param imputation_vars Variables with missing values to be imputed
#' @param auxiliary_vars Complete or mostly complete variables to assist
#'   imputation
#' @param cluster_var Clustering variable for nested/multilevel imputation
#'   (e.g., study site, patient ID)
#' @param id_var Subject identifier for tracking observations across
#'   imputations
#' @param n_imputations Number of imputed datasets to create (recommended 5-20
#'   for analysis, 100+ for final results)
#' @param n_iterations Number of MICE iterations per imputation (increase for
#'   convergence)
#' @param convergence_check Monitor and assess MICE convergence with
#'   diagnostic plots and statistics
#' @param imputation_method Primary method for continuous variables
#' @param categorical_method Method for categorical variables
#' @param mnar_methods Include Missing Not At Random imputation methods
#' @param mnar_type Type of MNAR imputation approach
#' @param delta_values Comma-separated delta values for MNAR sensitivity
#'   analysis (e.g., "0, -0.5, -1")
#' @param sensitivity_analysis Perform extensive sensitivity analysis for
#'   missing data assumptions
#' @param sensitivity_methods Type of sensitivity analysis to perform
#' @param multilevel_imputation Use multilevel imputation for nested/clustered
#'   data
#' @param level1_vars Individual-level variables for multilevel imputation
#' @param level2_vars Cluster-level variables for multilevel imputation
#' @param min_bucket_size Minimum number of donors for PMM (prevents poor
#'   matching)
#' @param exclude_vars Variables to exclude from imputation model (but keep in
#'   dataset)
#' @param passive_imputation R expressions for passive imputation (e.g., "bmi
#'   ~ I(weight/height^2)")
#' @param ridge_penalty Ridge penalty for numerical stability in regression
#'   imputation
#' @param remove_collinear Automatically remove highly collinear variables
#'   from imputation model
#' @param collinearity_threshold Correlation threshold for removing collinear
#'   variables
#' @param diagnostic_plots Generate convergence and diagnostic plots
#' @param imputation_quality Assess quality of imputations vs observed data
#' @param cross_validation Perform cross-validation of imputation methods
#' @param ampute_test Test imputation performance using artificial missingness
#' @param save_imputations Save completed imputed datasets for further
#'   analysis
#' @param pool_results Pool results across imputations using Rubin's rules
#' @param show_detailed_output Show detailed imputation summaries and
#'   diagnostics
#' @param regulatory_report Generate regulatory-compliant missing data
#'   analysis report
#' @param random_seed Set random seed for reproducible results
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$imputationMethodSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$pooledResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$diagnosticPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summary$asDF}
#'
#' \code{as.data.frame(results$summary)}
#'
#' @export
advancedimputation <- function(
    data,
    imputation_vars,
    auxiliary_vars,
    cluster_var,
    id_var,
    n_imputations = 10,
    n_iterations = 10,
    convergence_check = TRUE,
    imputation_method = "pmm",
    categorical_method = "logreg",
    mnar_methods = FALSE,
    mnar_type = "delta_adjustment",
    delta_values = "0",
    sensitivity_analysis = TRUE,
    sensitivity_methods = "all",
    multilevel_imputation = FALSE,
    level1_vars,
    level2_vars,
    min_bucket_size = 5,
    exclude_vars,
    passive_imputation,
    ridge_penalty = 0.00001,
    remove_collinear = TRUE,
    collinearity_threshold = 0.95,
    diagnostic_plots = TRUE,
    imputation_quality = TRUE,
    cross_validation = FALSE,
    ampute_test = FALSE,
    save_imputations = FALSE,
    pool_results = TRUE,
    show_detailed_output = TRUE,
    regulatory_report = FALSE,
    random_seed = 123) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("advancedimputation requires jmvcore to be installed (restart may be required)")

    if ( ! missing(imputation_vars)) imputation_vars <- jmvcore::resolveQuo(jmvcore::enquo(imputation_vars))
    if ( ! missing(auxiliary_vars)) auxiliary_vars <- jmvcore::resolveQuo(jmvcore::enquo(auxiliary_vars))
    if ( ! missing(cluster_var)) cluster_var <- jmvcore::resolveQuo(jmvcore::enquo(cluster_var))
    if ( ! missing(id_var)) id_var <- jmvcore::resolveQuo(jmvcore::enquo(id_var))
    if ( ! missing(level1_vars)) level1_vars <- jmvcore::resolveQuo(jmvcore::enquo(level1_vars))
    if ( ! missing(level2_vars)) level2_vars <- jmvcore::resolveQuo(jmvcore::enquo(level2_vars))
    if ( ! missing(exclude_vars)) exclude_vars <- jmvcore::resolveQuo(jmvcore::enquo(exclude_vars))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(imputation_vars), imputation_vars, NULL),
            `if`( ! missing(auxiliary_vars), auxiliary_vars, NULL),
            `if`( ! missing(cluster_var), cluster_var, NULL),
            `if`( ! missing(id_var), id_var, NULL),
            `if`( ! missing(level1_vars), level1_vars, NULL),
            `if`( ! missing(level2_vars), level2_vars, NULL),
            `if`( ! missing(exclude_vars), exclude_vars, NULL))

    for (v in cluster_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- advancedimputationOptions$new(
        imputation_vars = imputation_vars,
        auxiliary_vars = auxiliary_vars,
        cluster_var = cluster_var,
        id_var = id_var,
        n_imputations = n_imputations,
        n_iterations = n_iterations,
        convergence_check = convergence_check,
        imputation_method = imputation_method,
        categorical_method = categorical_method,
        mnar_methods = mnar_methods,
        mnar_type = mnar_type,
        delta_values = delta_values,
        sensitivity_analysis = sensitivity_analysis,
        sensitivity_methods = sensitivity_methods,
        multilevel_imputation = multilevel_imputation,
        level1_vars = level1_vars,
        level2_vars = level2_vars,
        min_bucket_size = min_bucket_size,
        exclude_vars = exclude_vars,
        passive_imputation = passive_imputation,
        ridge_penalty = ridge_penalty,
        remove_collinear = remove_collinear,
        collinearity_threshold = collinearity_threshold,
        diagnostic_plots = diagnostic_plots,
        imputation_quality = imputation_quality,
        cross_validation = cross_validation,
        ampute_test = ampute_test,
        save_imputations = save_imputations,
        pool_results = pool_results,
        show_detailed_output = show_detailed_output,
        regulatory_report = regulatory_report,
        random_seed = random_seed)

    analysis <- advancedimputationClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

