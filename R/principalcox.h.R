
# This file is automatically generated, you probably don't want to edit this

principalcoxOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "principalcoxOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            outcome = NULL,
            highdim_vars = NULL,
            clinical_vars = NULL,
            outcomeLevel = "1",
            pca_method = "standard",
            n_components = 5,
            variance_threshold = 0.95,
            component_selection = "fixed_number",
            scaling_method = "standardize",
            sparse_parameter = 0.1,
            cross_validation = 5,
            confidence_level = 0.95,
            show_pca_summary = TRUE,
            show_component_loadings = TRUE,
            show_cox_results = TRUE,
            show_variable_importance = FALSE,
            show_model_comparison = FALSE,
            scree_plot = TRUE,
            biplot = FALSE,
            loading_plot = TRUE,
            survival_plot = TRUE,
            showSummaries = TRUE,
            showExplanations = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="principalcox",
                requiresData=TRUE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..highdim_vars <- jmvcore::OptionVariables$new(
                "highdim_vars",
                highdim_vars,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..clinical_vars <- jmvcore::OptionVariables$new(
                "clinical_vars",
                clinical_vars,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..outcomeLevel <- jmvcore::OptionString$new(
                "outcomeLevel",
                outcomeLevel,
                default="1")
            private$..pca_method <- jmvcore::OptionList$new(
                "pca_method",
                pca_method,
                options=list(
                    "standard",
                    "sparse",
                    "supervised",
                    "kernel"),
                default="standard")
            private$..n_components <- jmvcore::OptionNumber$new(
                "n_components",
                n_components,
                default=5,
                min=1,
                max=50)
            private$..variance_threshold <- jmvcore::OptionNumber$new(
                "variance_threshold",
                variance_threshold,
                default=0.95,
                min=0.5,
                max=0.99)
            private$..component_selection <- jmvcore::OptionList$new(
                "component_selection",
                component_selection,
                options=list(
                    "fixed_number",
                    "variance_threshold",
                    "cross_validation",
                    "scree_plot"),
                default="fixed_number")
            private$..scaling_method <- jmvcore::OptionList$new(
                "scaling_method",
                scaling_method,
                options=list(
                    "standardize",
                    "normalize",
                    "robust",
                    "none"),
                default="standardize")
            private$..sparse_parameter <- jmvcore::OptionNumber$new(
                "sparse_parameter",
                sparse_parameter,
                default=0.1,
                min=0.01,
                max=1)
            private$..cross_validation <- jmvcore::OptionNumber$new(
                "cross_validation",
                cross_validation,
                default=5,
                min=3,
                max=10)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.5,
                max=0.99)
            private$..show_pca_summary <- jmvcore::OptionBool$new(
                "show_pca_summary",
                show_pca_summary,
                default=TRUE)
            private$..show_component_loadings <- jmvcore::OptionBool$new(
                "show_component_loadings",
                show_component_loadings,
                default=TRUE)
            private$..show_cox_results <- jmvcore::OptionBool$new(
                "show_cox_results",
                show_cox_results,
                default=TRUE)
            private$..show_variable_importance <- jmvcore::OptionBool$new(
                "show_variable_importance",
                show_variable_importance,
                default=FALSE)
            private$..show_model_comparison <- jmvcore::OptionBool$new(
                "show_model_comparison",
                show_model_comparison,
                default=FALSE)
            private$..scree_plot <- jmvcore::OptionBool$new(
                "scree_plot",
                scree_plot,
                default=TRUE)
            private$..biplot <- jmvcore::OptionBool$new(
                "biplot",
                biplot,
                default=FALSE)
            private$..loading_plot <- jmvcore::OptionBool$new(
                "loading_plot",
                loading_plot,
                default=TRUE)
            private$..survival_plot <- jmvcore::OptionBool$new(
                "survival_plot",
                survival_plot,
                default=TRUE)
            private$..showSummaries <- jmvcore::OptionBool$new(
                "showSummaries",
                showSummaries,
                default=TRUE)
            private$..showExplanations <- jmvcore::OptionBool$new(
                "showExplanations",
                showExplanations,
                default=TRUE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..outcome)
            self$.addOption(private$..highdim_vars)
            self$.addOption(private$..clinical_vars)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..pca_method)
            self$.addOption(private$..n_components)
            self$.addOption(private$..variance_threshold)
            self$.addOption(private$..component_selection)
            self$.addOption(private$..scaling_method)
            self$.addOption(private$..sparse_parameter)
            self$.addOption(private$..cross_validation)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..show_pca_summary)
            self$.addOption(private$..show_component_loadings)
            self$.addOption(private$..show_cox_results)
            self$.addOption(private$..show_variable_importance)
            self$.addOption(private$..show_model_comparison)
            self$.addOption(private$..scree_plot)
            self$.addOption(private$..biplot)
            self$.addOption(private$..loading_plot)
            self$.addOption(private$..survival_plot)
            self$.addOption(private$..showSummaries)
            self$.addOption(private$..showExplanations)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        outcome = function() private$..outcome$value,
        highdim_vars = function() private$..highdim_vars$value,
        clinical_vars = function() private$..clinical_vars$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        pca_method = function() private$..pca_method$value,
        n_components = function() private$..n_components$value,
        variance_threshold = function() private$..variance_threshold$value,
        component_selection = function() private$..component_selection$value,
        scaling_method = function() private$..scaling_method$value,
        sparse_parameter = function() private$..sparse_parameter$value,
        cross_validation = function() private$..cross_validation$value,
        confidence_level = function() private$..confidence_level$value,
        show_pca_summary = function() private$..show_pca_summary$value,
        show_component_loadings = function() private$..show_component_loadings$value,
        show_cox_results = function() private$..show_cox_results$value,
        show_variable_importance = function() private$..show_variable_importance$value,
        show_model_comparison = function() private$..show_model_comparison$value,
        scree_plot = function() private$..scree_plot$value,
        biplot = function() private$..biplot$value,
        loading_plot = function() private$..loading_plot$value,
        survival_plot = function() private$..survival_plot$value,
        showSummaries = function() private$..showSummaries$value,
        showExplanations = function() private$..showExplanations$value),
    private = list(
        ..elapsedtime = NA,
        ..outcome = NA,
        ..highdim_vars = NA,
        ..clinical_vars = NA,
        ..outcomeLevel = NA,
        ..pca_method = NA,
        ..n_components = NA,
        ..variance_threshold = NA,
        ..component_selection = NA,
        ..scaling_method = NA,
        ..sparse_parameter = NA,
        ..cross_validation = NA,
        ..confidence_level = NA,
        ..show_pca_summary = NA,
        ..show_component_loadings = NA,
        ..show_cox_results = NA,
        ..show_variable_importance = NA,
        ..show_model_comparison = NA,
        ..scree_plot = NA,
        ..biplot = NA,
        ..loading_plot = NA,
        ..survival_plot = NA,
        ..showSummaries = NA,
        ..showExplanations = NA)
)

principalcoxResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "principalcoxResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        pcaSummary = function() private$.items[["pcaSummary"]],
        componentLoadings = function() private$.items[["componentLoadings"]],
        coxResults = function() private$.items[["coxResults"]],
        variableImportance = function() private$.items[["variableImportance"]],
        modelComparison = function() private$.items[["modelComparison"]],
        componentSelection = function() private$.items[["componentSelection"]],
        scalingSummary = function() private$.items[["scalingSummary"]],
        methodologyExplanation = function() private$.items[["methodologyExplanation"]],
        analysisSummary = function() private$.items[["analysisSummary"]],
        screePlot = function() private$.items[["screePlot"]],
        biplot = function() private$.items[["biplot"]],
        loadingPlot = function() private$.items[["loadingPlot"]],
        survivalPlot = function() private$.items[["survivalPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Principal Component Cox Models",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "survival",
                    "Hmisc",
                    "scales"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis Complete",
                visible=FALSE))
            self$add(jmvcore::Table$new(
                options=options,
                name="pcaSummary",
                title="Principal Component Analysis Summary",
                visible="(show_pca_summary)",
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="eigenvalue", 
                        `title`="Eigenvalue", 
                        `type`="number"),
                    list(
                        `name`="variance_explained", 
                        `title`="Variance Explained", 
                        `type`="number"),
                    list(
                        `name`="cumulative_variance", 
                        `title`="Cumulative Variance", 
                        `type`="number"),
                    list(
                        `name`="proportion", 
                        `title`="Proportion", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="componentLoadings",
                title="Principal Component Loadings",
                visible="(show_component_loadings)",
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="loading", 
                        `title`="Loading", 
                        `type`="number"),
                    list(
                        `name`="abs_loading", 
                        `title`="Loading", 
                        `type`="number"),
                    list(
                        `name`="contribution", 
                        `title`="Contribution", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="coxResults",
                title="Cox Regression Results",
                visible="(show_cox_results)",
                columns=list(
                    list(
                        `name`="term", 
                        `title`="Term", 
                        `type`="text"),
                    list(
                        `name`="coefficient", 
                        `title`="Coefficient", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="z_value", 
                        `title`="z", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="hazard_ratio", 
                        `title`="Hazard Ratio", 
                        `type`="number"),
                    list(
                        `name`="hr_lower", 
                        `title`="HR Lower", 
                        `type`="number"),
                    list(
                        `name`="hr_upper", 
                        `title`="HR Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="variableImportance",
                title="Variable Importance in Components",
                visible="(show_variable_importance)",
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="overall_contribution", 
                        `title`="Overall Contribution", 
                        `type`="number"),
                    list(
                        `name`="max_loading", 
                        `title`="Max |Loading|", 
                        `type`="number"),
                    list(
                        `name`="primary_component", 
                        `title`="Primary Component", 
                        `type`="text"),
                    list(
                        `name`="secondary_component", 
                        `title`="Secondary Component", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelComparison",
                title="Model Comparison",
                visible="(show_model_comparison)",
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="n_components", 
                        `title`="N Components", 
                        `type`="integer"),
                    list(
                        `name`="c_index", 
                        `title`="C-Index", 
                        `type`="number"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number"),
                    list(
                        `name`="log_likelihood", 
                        `title`="Log-Likelihood", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="componentSelection",
                title="Component Selection Results",
                columns=list(
                    list(
                        `name`="method", 
                        `title`="Selection Method", 
                        `type`="text"),
                    list(
                        `name`="selected_components", 
                        `title`="Selected Components", 
                        `type`="integer"),
                    list(
                        `name`="total_variance", 
                        `title`="Total Variance Explained", 
                        `type`="number"),
                    list(
                        `name`="selection_criterion", 
                        `title`="Selection Criterion", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="scalingSummary",
                title="Scaling Summary",
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="original_mean", 
                        `title`="Original Mean", 
                        `type`="number"),
                    list(
                        `name`="original_sd", 
                        `title`="Original SD", 
                        `type`="number"),
                    list(
                        `name`="scaled_mean", 
                        `title`="Scaled Mean", 
                        `type`="number"),
                    list(
                        `name`="scaled_sd", 
                        `title`="Scaled SD", 
                        `type`="number"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodologyExplanation",
                title="Methodology Explanation",
                visible="(showExplanations)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="analysisSummary",
                title="Analysis Summary",
                visible="(showSummaries)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="screePlot",
                title="Scree Plot",
                width=600,
                height=400,
                requiresData=TRUE,
                visible="(scree_plot)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="biplot",
                title="PCA Biplot",
                width=600,
                height=500,
                requiresData=TRUE,
                visible="(biplot)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="loadingPlot",
                title="Component Loadings",
                width=700,
                height=400,
                requiresData=TRUE,
                visible="(loading_plot)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlot",
                title="Survival Curves by Component Scores",
                width=700,
                height=500,
                requiresData=TRUE,
                visible="(survival_plot)"))}))

principalcoxBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "principalcoxBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "principalcox",
                version = c(1,0,0),
                options = options,
                results = principalcoxResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Principal Component Cox Models
#'
#' Principal Component Cox models address the challenges of high-dimensional 
#' survival data by using principal component analysis (PCA) to reduce 
#' dimensionality before fitting Cox regression models. This approach is 
#' particularly useful when the number of covariates is large relative to 
#' sample size, helping to avoid overfitting while retaining important 
#' patterns in the data. The method supports various PCA approaches including 
#' standard PCA, sparse PCA, and supervised PCA for survival data.
#' 
#'
#' @examples
#' data \%>\%
#' principalcox(
#'     elapsedtime = "time_to_event",
#'     outcome = "event_status",
#'     highdim_vars = c("gene1", "gene2", "gene3"),
#'     n_components = 5,
#'     pca_method = "standard"
#' )
#'
#' @param data the data as a data frame
#' @param elapsedtime Time to event or censoring
#' @param outcome Event indicator (1 = event, 0 = censored)
#' @param highdim_vars High-dimensional variables for principal component
#'   analysis
#' @param clinical_vars Clinical variables to include alongside principal
#'   components
#' @param outcomeLevel Level indicating event occurrence
#' @param pca_method Method for principal component analysis
#' @param n_components Number of principal components to retain
#' @param variance_threshold Cumulative variance threshold for automatic
#'   component selection
#' @param component_selection Method for selecting the number of components
#' @param scaling_method Method for scaling variables before PCA
#' @param sparse_parameter Sparsity parameter for sparse PCA (proportion of
#'   non-zero loadings)
#' @param cross_validation Number of folds for cross-validation component
#'   selection
#' @param confidence_level Confidence level for confidence intervals
#' @param show_pca_summary Display PCA summary statistics
#' @param show_component_loadings Display principal component loadings
#' @param show_cox_results Display Cox regression results for principal
#'   components
#' @param show_variable_importance Display importance of original variables in
#'   components
#' @param show_model_comparison Compare different PCA approaches and component
#'   numbers
#' @param scree_plot Display scree plot for component selection
#' @param biplot Display PCA biplot
#' @param loading_plot Display component loading plots
#' @param survival_plot Display survival curves stratified by principal
#'   component scores
#' @param showSummaries Show comprehensive analysis summaries
#' @param showExplanations Show detailed methodology explanations
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$pcaSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$componentLoadings} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$coxResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$variableImportance} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$componentSelection} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$scalingSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$methodologyExplanation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$analysisSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$screePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$biplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$loadingPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$survivalPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$pcaSummary$asDF}
#'
#' \code{as.data.frame(results$pcaSummary)}
#'
#' @export
principalcox <- function(
    data,
    elapsedtime,
    outcome,
    highdim_vars,
    clinical_vars,
    outcomeLevel = "1",
    pca_method = "standard",
    n_components = 5,
    variance_threshold = 0.95,
    component_selection = "fixed_number",
    scaling_method = "standardize",
    sparse_parameter = 0.1,
    cross_validation = 5,
    confidence_level = 0.95,
    show_pca_summary = TRUE,
    show_component_loadings = TRUE,
    show_cox_results = TRUE,
    show_variable_importance = FALSE,
    show_model_comparison = FALSE,
    scree_plot = TRUE,
    biplot = FALSE,
    loading_plot = TRUE,
    survival_plot = TRUE,
    showSummaries = TRUE,
    showExplanations = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("principalcox requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(highdim_vars)) highdim_vars <- jmvcore::resolveQuo(jmvcore::enquo(highdim_vars))
    if ( ! missing(clinical_vars)) clinical_vars <- jmvcore::resolveQuo(jmvcore::enquo(clinical_vars))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(elapsedtime), elapsedtime, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(highdim_vars), highdim_vars, NULL),
            `if`( ! missing(clinical_vars), clinical_vars, NULL))


    options <- principalcoxOptions$new(
        elapsedtime = elapsedtime,
        outcome = outcome,
        highdim_vars = highdim_vars,
        clinical_vars = clinical_vars,
        outcomeLevel = outcomeLevel,
        pca_method = pca_method,
        n_components = n_components,
        variance_threshold = variance_threshold,
        component_selection = component_selection,
        scaling_method = scaling_method,
        sparse_parameter = sparse_parameter,
        cross_validation = cross_validation,
        confidence_level = confidence_level,
        show_pca_summary = show_pca_summary,
        show_component_loadings = show_component_loadings,
        show_cox_results = show_cox_results,
        show_variable_importance = show_variable_importance,
        show_model_comparison = show_model_comparison,
        scree_plot = scree_plot,
        biplot = biplot,
        loading_plot = loading_plot,
        survival_plot = survival_plot,
        showSummaries = showSummaries,
        showExplanations = showExplanations)

    analysis <- principalcoxClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

