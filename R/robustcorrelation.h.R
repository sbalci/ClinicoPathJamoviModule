
# This file is automatically generated, you probably don't want to edit this

robustcorrelationOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "robustcorrelationOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            dep = NULL,
            method = "spearman",
            matrix_type = "upper",
            show_pvalues = TRUE,
            sig_level = 0.05,
            p_adjust_method = "none",
            outlier_detection = FALSE,
            outlier_method = "mcd",
            outlier_threshold = 2.5,
            bootstrap_ci = FALSE,
            n_bootstrap = 1000,
            confidence_level = 0.95,
            show_heatmap = TRUE,
            heatmap_colors = "blue_white_red",
            low_color = "#3B82C5",
            mid_color = "white",
            high_color = "#E74C3C",
            show_diagnostics = FALSE,
            plot_width = 600,
            plot_height = 450,
            decimal_places = 3, ...) {

            super$initialize(
                package="ClinicoPath",
                name="robustcorrelation",
                requiresData=TRUE,
                ...)

            private$..dep <- jmvcore::OptionVariables$new(
                "dep",
                dep,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..method <- jmvcore::OptionList$new(
                "method",
                method,
                options=list(
                    "spearman",
                    "kendall",
                    "percentage_bend",
                    "biweight",
                    "mve",
                    "mcd",
                    "pearson"),
                default="spearman")
            private$..matrix_type <- jmvcore::OptionList$new(
                "matrix_type",
                matrix_type,
                options=list(
                    "upper",
                    "lower",
                    "full"),
                default="upper")
            private$..show_pvalues <- jmvcore::OptionBool$new(
                "show_pvalues",
                show_pvalues,
                default=TRUE)
            private$..sig_level <- jmvcore::OptionNumber$new(
                "sig_level",
                sig_level,
                default=0.05,
                min=0.001,
                max=0.2)
            private$..p_adjust_method <- jmvcore::OptionList$new(
                "p_adjust_method",
                p_adjust_method,
                options=list(
                    "none",
                    "bonferroni",
                    "holm",
                    "hochberg",
                    "BH",
                    "BY"),
                default="none")
            private$..outlier_detection <- jmvcore::OptionBool$new(
                "outlier_detection",
                outlier_detection,
                default=FALSE)
            private$..outlier_method <- jmvcore::OptionList$new(
                "outlier_method",
                outlier_method,
                options=list(
                    "mahalanobis",
                    "mcd",
                    "zscore",
                    "iqr"),
                default="mcd")
            private$..outlier_threshold <- jmvcore::OptionNumber$new(
                "outlier_threshold",
                outlier_threshold,
                default=2.5,
                min=1.5,
                max=5)
            private$..bootstrap_ci <- jmvcore::OptionBool$new(
                "bootstrap_ci",
                bootstrap_ci,
                default=FALSE)
            private$..n_bootstrap <- jmvcore::OptionInteger$new(
                "n_bootstrap",
                n_bootstrap,
                default=1000,
                min=100,
                max=10000)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.8,
                max=0.99)
            private$..show_heatmap <- jmvcore::OptionBool$new(
                "show_heatmap",
                show_heatmap,
                default=TRUE)
            private$..heatmap_colors <- jmvcore::OptionList$new(
                "heatmap_colors",
                heatmap_colors,
                options=list(
                    "blue_white_red",
                    "red_yellow_blue",
                    "viridis",
                    "plasma",
                    "custom"),
                default="blue_white_red")
            private$..low_color <- jmvcore::OptionString$new(
                "low_color",
                low_color,
                default="#3B82C5")
            private$..mid_color <- jmvcore::OptionString$new(
                "mid_color",
                mid_color,
                default="white")
            private$..high_color <- jmvcore::OptionString$new(
                "high_color",
                high_color,
                default="#E74C3C")
            private$..show_diagnostics <- jmvcore::OptionBool$new(
                "show_diagnostics",
                show_diagnostics,
                default=FALSE)
            private$..plot_width <- jmvcore::OptionInteger$new(
                "plot_width",
                plot_width,
                default=600,
                min=300,
                max=1200)
            private$..plot_height <- jmvcore::OptionInteger$new(
                "plot_height",
                plot_height,
                default=450,
                min=300,
                max=800)
            private$..decimal_places <- jmvcore::OptionInteger$new(
                "decimal_places",
                decimal_places,
                default=3,
                min=2,
                max=6)

            self$.addOption(private$..dep)
            self$.addOption(private$..method)
            self$.addOption(private$..matrix_type)
            self$.addOption(private$..show_pvalues)
            self$.addOption(private$..sig_level)
            self$.addOption(private$..p_adjust_method)
            self$.addOption(private$..outlier_detection)
            self$.addOption(private$..outlier_method)
            self$.addOption(private$..outlier_threshold)
            self$.addOption(private$..bootstrap_ci)
            self$.addOption(private$..n_bootstrap)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..show_heatmap)
            self$.addOption(private$..heatmap_colors)
            self$.addOption(private$..low_color)
            self$.addOption(private$..mid_color)
            self$.addOption(private$..high_color)
            self$.addOption(private$..show_diagnostics)
            self$.addOption(private$..plot_width)
            self$.addOption(private$..plot_height)
            self$.addOption(private$..decimal_places)
        }),
    active = list(
        dep = function() private$..dep$value,
        method = function() private$..method$value,
        matrix_type = function() private$..matrix_type$value,
        show_pvalues = function() private$..show_pvalues$value,
        sig_level = function() private$..sig_level$value,
        p_adjust_method = function() private$..p_adjust_method$value,
        outlier_detection = function() private$..outlier_detection$value,
        outlier_method = function() private$..outlier_method$value,
        outlier_threshold = function() private$..outlier_threshold$value,
        bootstrap_ci = function() private$..bootstrap_ci$value,
        n_bootstrap = function() private$..n_bootstrap$value,
        confidence_level = function() private$..confidence_level$value,
        show_heatmap = function() private$..show_heatmap$value,
        heatmap_colors = function() private$..heatmap_colors$value,
        low_color = function() private$..low_color$value,
        mid_color = function() private$..mid_color$value,
        high_color = function() private$..high_color$value,
        show_diagnostics = function() private$..show_diagnostics$value,
        plot_width = function() private$..plot_width$value,
        plot_height = function() private$..plot_height$value,
        decimal_places = function() private$..decimal_places$value),
    private = list(
        ..dep = NA,
        ..method = NA,
        ..matrix_type = NA,
        ..show_pvalues = NA,
        ..sig_level = NA,
        ..p_adjust_method = NA,
        ..outlier_detection = NA,
        ..outlier_method = NA,
        ..outlier_threshold = NA,
        ..bootstrap_ci = NA,
        ..n_bootstrap = NA,
        ..confidence_level = NA,
        ..show_heatmap = NA,
        ..heatmap_colors = NA,
        ..low_color = NA,
        ..mid_color = NA,
        ..high_color = NA,
        ..show_diagnostics = NA,
        ..plot_width = NA,
        ..plot_height = NA,
        ..decimal_places = NA)
)

robustcorrelationResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "robustcorrelationResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        package_status = function() private$.items[["package_status"]],
        correlation_table = function() private$.items[["correlation_table"]],
        bootstrap_table = function() private$.items[["bootstrap_table"]],
        outlier_table = function() private$.items[["outlier_table"]],
        correlation_heatmap = function() private$.items[["correlation_heatmap"]],
        outlier_plot = function() private$.items[["outlier_plot"]],
        diagnostic_plots = function() private$.items[["diagnostic_plots"]],
        scatterplot_matrix = function() private$.items[["scatterplot_matrix"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Robust Correlation Methods",
                refs=list(
                    "Hmisc",
                    "corrplot",
                    "ggplot2",
                    "ggcorrplot",
                    "MASS",
                    "robustbase",
                    "WRS2",
                    "boot",
                    "ClinicoPathJamoviModule",
                    "WGCNA",
                    "glue",
                    "reshape2",
                    "gridExtra",
                    "GGally"),
                clearWith=list(
                    "dep",
                    "method",
                    "matrix_type",
                    "show_pvalues",
                    "sig_level",
                    "p_adjust_method",
                    "outlier_detection",
                    "outlier_method",
                    "outlier_threshold",
                    "bootstrap_ci",
                    "n_bootstrap",
                    "confidence_level",
                    "show_heatmap",
                    "heatmap_colors",
                    "low_color",
                    "mid_color",
                    "high_color",
                    "show_diagnostics",
                    "plot_width",
                    "plot_height",
                    "decimal_places"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions"))
            self$add(jmvcore::Html$new(
                options=options,
                name="package_status",
                title="Package Availability Status",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="correlation_table",
                title="Correlation Matrix",
                visible=TRUE,
                clearWith=list(
                    "dep",
                    "method",
                    "sig_level",
                    "p_adjust_method",
                    "decimal_places"),
                columns=list(
                    list(
                        `name`="var1", 
                        `title`="Variable 1", 
                        `type`="text"),
                    list(
                        `name`="var2", 
                        `title`="Variable 2", 
                        `type`="text"),
                    list(
                        `name`="correlation", 
                        `title`="Correlation", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="pvalue", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue", 
                        `visible`="(show_pvalues)"),
                    list(
                        `name`="pvalue_adj", 
                        `title`="p-value (adj)", 
                        `type`="number", 
                        `format`="zto,pvalue", 
                        `visible`="(show_pvalues && p_adjust_method:none != true)"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="bootstrap_table",
                title="Bootstrap Confidence Intervals",
                visible="(bootstrap_ci)",
                clearWith=list(
                    "dep",
                    "method",
                    "bootstrap_ci",
                    "n_bootstrap",
                    "confidence_level"),
                columns=list(
                    list(
                        `name`="var1", 
                        `title`="Variable 1", 
                        `type`="text"),
                    list(
                        `name`="var2", 
                        `title`="Variable 2", 
                        `type`="text"),
                    list(
                        `name`="correlation", 
                        `title`="Correlation", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="bias", 
                        `title`="Bias", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="outlier_table",
                title="Outlier Detection Results",
                visible="(outlier_detection)",
                clearWith=list(
                    "dep",
                    "outlier_detection",
                    "outlier_method",
                    "outlier_threshold"),
                columns=list(
                    list(
                        `name`="observation", 
                        `title`="Observation", 
                        `type`="integer"),
                    list(
                        `name`="distance", 
                        `title`="Distance", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="threshold", 
                        `title`="Threshold", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="outlier", 
                        `title`="Outlier", 
                        `type`="text"),
                    list(
                        `name`="variables", 
                        `title`="Extreme Variables", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="correlation_heatmap",
                title="Correlation Heatmap",
                width=600,
                height=450,
                renderFun=".plot_heatmap",
                requiresData=TRUE,
                visible="(show_heatmap)",
                clearWith=list(
                    "dep",
                    "method",
                    "matrix_type",
                    "heatmap_colors",
                    "low_color",
                    "mid_color",
                    "high_color",
                    "plot_width",
                    "plot_height")))
            self$add(jmvcore::Image$new(
                options=options,
                name="outlier_plot",
                title="Outlier Detection Plot",
                width=600,
                height=450,
                renderFun=".plot_outliers",
                requiresData=TRUE,
                visible="(outlier_detection)",
                clearWith=list(
                    "dep",
                    "outlier_detection",
                    "outlier_method",
                    "outlier_threshold",
                    "plot_width",
                    "plot_height")))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagnostic_plots",
                title="Diagnostic Plots",
                width=800,
                height=600,
                renderFun=".plot_diagnostics",
                requiresData=TRUE,
                visible="(show_diagnostics)",
                clearWith=list(
                    "dep",
                    "method",
                    "show_diagnostics",
                    "plot_width",
                    "plot_height")))
            self$add(jmvcore::Image$new(
                options=options,
                name="scatterplot_matrix",
                title="Scatterplot Matrix",
                width=800,
                height=800,
                renderFun=".plot_scatter_matrix",
                requiresData=TRUE,
                visible=TRUE,
                clearWith=list(
                    "dep",
                    "method",
                    "outlier_detection",
                    "plot_width",
                    "plot_height")))}))

robustcorrelationBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "robustcorrelationBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "robustcorrelation",
                version = c(0,0,1),
                options = options,
                results = robustcorrelationResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Robust Correlation Methods
#'
#' Comprehensive robust correlation analysis with multiple correlation 
#' methods,
#' outlier detection, diagnostic plots, and bootstrap confidence intervals.
#' Includes Spearman, Kendall, Percentage Bend, Biweight Midcorrelation,
#' Minimum Volume Ellipsoid (MVE), and Minimum Covariance Determinant (MCD)
#' correlation methods.
#' 
#'
#' @examples
#' \donttest{
#' # Load test data
#' data("mtcars")
#'
#' # Basic robust correlation analysis
#' robustcorrelation(
#'   data = mtcars,
#'   dep = c("mpg", "hp", "wt", "qsec"),
#'   method = "spearman"
#' )
#'
#' # Advanced robust correlation with outlier detection
#' robustcorrelation(
#'   data = mtcars,
#'   dep = c("mpg", "hp", "wt", "qsec", "disp"),
#'   method = "percentage_bend",
#'   outlier_detection = TRUE,
#'   outlier_method = "mcd",
#'   bootstrap_ci = TRUE,
#'   n_bootstrap = 1000
#' )
#'
#' # Multiple robust methods comparison
#' robustcorrelation(
#'   data = mtcars,
#'   dep = c("mpg", "hp", "wt"),
#'   method = "biweight",
#'   show_heatmap = TRUE,
#'   matrix_type = "lower"
#' )
#'}
#' @param data The data as a data frame.
#' @param dep List of continuous variables for robust correlation analysis.
#'   All variables must be numeric with sufficient variation.
#' @param method Robust correlation method to use. Spearman and Kendall are
#'   rank-based, percentage bend and biweight are robust to outliers, MVE and
#'   MCD are based on robust covariance estimation.
#' @param matrix_type Display type for correlation matrix.
#' @param show_pvalues Display significance p-values in correlation matrix.
#' @param sig_level Significance level for correlation tests.
#' @param p_adjust_method Method for adjusting p-values for multiple testing.
#' @param outlier_detection Perform outlier detection analysis.
#' @param outlier_method Method for detecting outliers in the data.
#' @param outlier_threshold Threshold for outlier detection (in standard
#'   deviations or equivalent).
#' @param bootstrap_ci Calculate bootstrap confidence intervals for
#'   correlations.
#' @param n_bootstrap Number of bootstrap iterations for confidence intervals.
#' @param confidence_level Confidence level for bootstrap intervals.
#' @param show_heatmap Display correlation matrix as a heatmap visualization.
#' @param heatmap_colors Color scheme for correlation heatmap.
#' @param low_color Color for low (negative) correlation values (when using
#'   custom colors).
#' @param mid_color Color for mid (zero) correlation values (when using custom
#'   colors).
#' @param high_color Color for high (positive) correlation values (when using
#'   custom colors).
#' @param show_diagnostics Generate diagnostic plots for robust correlation
#'   analysis.
#' @param plot_width Width of plots in pixels.
#' @param plot_height Height of plots in pixels.
#' @param decimal_places Number of decimal places for correlation
#'   coefficients.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$package_status} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$correlation_table} \tab \tab \tab \tab \tab Correlation coefficients and significance tests \cr
#'   \code{results$bootstrap_table} \tab \tab \tab \tab \tab Bootstrap confidence intervals for correlations \cr
#'   \code{results$outlier_table} \tab \tab \tab \tab \tab Identified outliers and their statistics \cr
#'   \code{results$correlation_heatmap} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$outlier_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$diagnostic_plots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$scatterplot_matrix} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$correlation_table$asDF}
#'
#' \code{as.data.frame(results$correlation_table)}
#'
#' @export
robustcorrelation <- function(
    data,
    dep,
    method = "spearman",
    matrix_type = "upper",
    show_pvalues = TRUE,
    sig_level = 0.05,
    p_adjust_method = "none",
    outlier_detection = FALSE,
    outlier_method = "mcd",
    outlier_threshold = 2.5,
    bootstrap_ci = FALSE,
    n_bootstrap = 1000,
    confidence_level = 0.95,
    show_heatmap = TRUE,
    heatmap_colors = "blue_white_red",
    low_color = "#3B82C5",
    mid_color = "white",
    high_color = "#E74C3C",
    show_diagnostics = FALSE,
    plot_width = 600,
    plot_height = 450,
    decimal_places = 3) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("robustcorrelation requires jmvcore to be installed (restart may be required)")

    if ( ! missing(dep)) dep <- jmvcore::resolveQuo(jmvcore::enquo(dep))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(dep), dep, NULL))


    options <- robustcorrelationOptions$new(
        dep = dep,
        method = method,
        matrix_type = matrix_type,
        show_pvalues = show_pvalues,
        sig_level = sig_level,
        p_adjust_method = p_adjust_method,
        outlier_detection = outlier_detection,
        outlier_method = outlier_method,
        outlier_threshold = outlier_threshold,
        bootstrap_ci = bootstrap_ci,
        n_bootstrap = n_bootstrap,
        confidence_level = confidence_level,
        show_heatmap = show_heatmap,
        heatmap_colors = heatmap_colors,
        low_color = low_color,
        mid_color = mid_color,
        high_color = high_color,
        show_diagnostics = show_diagnostics,
        plot_width = plot_width,
        plot_height = plot_height,
        decimal_places = decimal_places)

    analysis <- robustcorrelationClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

