
# This file is automatically generated, you probably don't want to edit this

clinicalvalidationOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinicalvalidationOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            outcome = NULL,
            outcomeLevel = NULL,
            predictors = NULL,
            time_variable = NULL,
            model_type = "logistic",
            model_formula = "",
            validation_method = "bootstrap",
            bootstrap_samples = 1000,
            cv_folds = 10,
            cv_repeats = 3,
            holdout_proportion = 0.25,
            stratified_sampling = TRUE,
            clinical_context = "diagnosis",
            prevalence_adjustment = FALSE,
            population_prevalence = 10,
            cost_matrix = "equal",
            fn_fp_cost_ratio = 2,
            performance_metrics = "all",
            confidence_level = 0.95,
            calibration_method = "all",
            calibration_bins = 10,
            compare_models = FALSE,
            comparison_models = "logistic_rf",
            show_model_summary = TRUE,
            show_performance_table = TRUE,
            show_calibration_plot = TRUE,
            show_roc_curve = TRUE,
            show_prc_curve = FALSE,
            show_validation_curves = FALSE,
            show_residual_plots = FALSE,
            show_clinical_interpretation = TRUE,
            export_results = FALSE,
            detailed_bootstrap = FALSE,
            missing_data_handling = "complete_cases",
            imputation_methods = 5,
            parallel_processing = FALSE,
            n_cores = 2,
            set_seed = TRUE,
            seed_value = 42, ...) {

            super$initialize(
                package="ClinicoPath",
                name="clinicalvalidation",
                requiresData=TRUE,
                ...)

            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..outcomeLevel <- jmvcore::OptionLevel$new(
                "outcomeLevel",
                outcomeLevel,
                variable="(outcome)")
            private$..predictors <- jmvcore::OptionVariables$new(
                "predictors",
                predictors,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..time_variable <- jmvcore::OptionVariable$new(
                "time_variable",
                time_variable,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..model_type <- jmvcore::OptionList$new(
                "model_type",
                model_type,
                options=list(
                    "logistic",
                    "cox",
                    "random_forest",
                    "svm",
                    "lda"),
                default="logistic")
            private$..model_formula <- jmvcore::OptionString$new(
                "model_formula",
                model_formula,
                default="")
            private$..validation_method <- jmvcore::OptionList$new(
                "validation_method",
                validation_method,
                options=list(
                    "bootstrap",
                    "cross_validation",
                    "repeated_cv",
                    "holdout",
                    "time_split"),
                default="bootstrap")
            private$..bootstrap_samples <- jmvcore::OptionInteger$new(
                "bootstrap_samples",
                bootstrap_samples,
                default=1000,
                min=100,
                max=5000)
            private$..cv_folds <- jmvcore::OptionInteger$new(
                "cv_folds",
                cv_folds,
                default=10,
                min=3,
                max=20)
            private$..cv_repeats <- jmvcore::OptionInteger$new(
                "cv_repeats",
                cv_repeats,
                default=3,
                min=1,
                max=10)
            private$..holdout_proportion <- jmvcore::OptionNumber$new(
                "holdout_proportion",
                holdout_proportion,
                default=0.25,
                min=0.1,
                max=0.4)
            private$..stratified_sampling <- jmvcore::OptionBool$new(
                "stratified_sampling",
                stratified_sampling,
                default=TRUE)
            private$..clinical_context <- jmvcore::OptionList$new(
                "clinical_context",
                clinical_context,
                options=list(
                    "diagnosis",
                    "screening",
                    "prognosis",
                    "treatment",
                    "risk",
                    "histological"),
                default="diagnosis")
            private$..prevalence_adjustment <- jmvcore::OptionBool$new(
                "prevalence_adjustment",
                prevalence_adjustment,
                default=FALSE)
            private$..population_prevalence <- jmvcore::OptionNumber$new(
                "population_prevalence",
                population_prevalence,
                default=10,
                min=0.1,
                max=50)
            private$..cost_matrix <- jmvcore::OptionList$new(
                "cost_matrix",
                cost_matrix,
                options=list(
                    "equal",
                    "screening",
                    "diagnosis",
                    "custom"),
                default="equal")
            private$..fn_fp_cost_ratio <- jmvcore::OptionNumber$new(
                "fn_fp_cost_ratio",
                fn_fp_cost_ratio,
                default=2,
                min=0.1,
                max=10)
            private$..performance_metrics <- jmvcore::OptionList$new(
                "performance_metrics",
                performance_metrics,
                options=list(
                    "all",
                    "clinical",
                    "discrimination",
                    "calibration"),
                default="all")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.8,
                max=0.99)
            private$..calibration_method <- jmvcore::OptionList$new(
                "calibration_method",
                calibration_method,
                options=list(
                    "hosmer_lemeshow",
                    "brier",
                    "plot",
                    "all"),
                default="all")
            private$..calibration_bins <- jmvcore::OptionInteger$new(
                "calibration_bins",
                calibration_bins,
                default=10,
                min=5,
                max=20)
            private$..compare_models <- jmvcore::OptionBool$new(
                "compare_models",
                compare_models,
                default=FALSE)
            private$..comparison_models <- jmvcore::OptionList$new(
                "comparison_models",
                comparison_models,
                options=list(
                    "logistic_rf",
                    "all_classification",
                    "cox_rsf",
                    "custom"),
                default="logistic_rf")
            private$..show_model_summary <- jmvcore::OptionBool$new(
                "show_model_summary",
                show_model_summary,
                default=TRUE)
            private$..show_performance_table <- jmvcore::OptionBool$new(
                "show_performance_table",
                show_performance_table,
                default=TRUE)
            private$..show_calibration_plot <- jmvcore::OptionBool$new(
                "show_calibration_plot",
                show_calibration_plot,
                default=TRUE)
            private$..show_roc_curve <- jmvcore::OptionBool$new(
                "show_roc_curve",
                show_roc_curve,
                default=TRUE)
            private$..show_prc_curve <- jmvcore::OptionBool$new(
                "show_prc_curve",
                show_prc_curve,
                default=FALSE)
            private$..show_validation_curves <- jmvcore::OptionBool$new(
                "show_validation_curves",
                show_validation_curves,
                default=FALSE)
            private$..show_residual_plots <- jmvcore::OptionBool$new(
                "show_residual_plots",
                show_residual_plots,
                default=FALSE)
            private$..show_clinical_interpretation <- jmvcore::OptionBool$new(
                "show_clinical_interpretation",
                show_clinical_interpretation,
                default=TRUE)
            private$..export_results <- jmvcore::OptionBool$new(
                "export_results",
                export_results,
                default=FALSE)
            private$..detailed_bootstrap <- jmvcore::OptionBool$new(
                "detailed_bootstrap",
                detailed_bootstrap,
                default=FALSE)
            private$..missing_data_handling <- jmvcore::OptionList$new(
                "missing_data_handling",
                missing_data_handling,
                options=list(
                    "complete_cases",
                    "imputation",
                    "indicator"),
                default="complete_cases")
            private$..imputation_methods <- jmvcore::OptionInteger$new(
                "imputation_methods",
                imputation_methods,
                default=5,
                min=3,
                max=10)
            private$..parallel_processing <- jmvcore::OptionBool$new(
                "parallel_processing",
                parallel_processing,
                default=FALSE)
            private$..n_cores <- jmvcore::OptionInteger$new(
                "n_cores",
                n_cores,
                default=2,
                min=1,
                max=8)
            private$..set_seed <- jmvcore::OptionBool$new(
                "set_seed",
                set_seed,
                default=TRUE)
            private$..seed_value <- jmvcore::OptionInteger$new(
                "seed_value",
                seed_value,
                default=42,
                min=1,
                max=999999)

            self$.addOption(private$..outcome)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..predictors)
            self$.addOption(private$..time_variable)
            self$.addOption(private$..model_type)
            self$.addOption(private$..model_formula)
            self$.addOption(private$..validation_method)
            self$.addOption(private$..bootstrap_samples)
            self$.addOption(private$..cv_folds)
            self$.addOption(private$..cv_repeats)
            self$.addOption(private$..holdout_proportion)
            self$.addOption(private$..stratified_sampling)
            self$.addOption(private$..clinical_context)
            self$.addOption(private$..prevalence_adjustment)
            self$.addOption(private$..population_prevalence)
            self$.addOption(private$..cost_matrix)
            self$.addOption(private$..fn_fp_cost_ratio)
            self$.addOption(private$..performance_metrics)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..calibration_method)
            self$.addOption(private$..calibration_bins)
            self$.addOption(private$..compare_models)
            self$.addOption(private$..comparison_models)
            self$.addOption(private$..show_model_summary)
            self$.addOption(private$..show_performance_table)
            self$.addOption(private$..show_calibration_plot)
            self$.addOption(private$..show_roc_curve)
            self$.addOption(private$..show_prc_curve)
            self$.addOption(private$..show_validation_curves)
            self$.addOption(private$..show_residual_plots)
            self$.addOption(private$..show_clinical_interpretation)
            self$.addOption(private$..export_results)
            self$.addOption(private$..detailed_bootstrap)
            self$.addOption(private$..missing_data_handling)
            self$.addOption(private$..imputation_methods)
            self$.addOption(private$..parallel_processing)
            self$.addOption(private$..n_cores)
            self$.addOption(private$..set_seed)
            self$.addOption(private$..seed_value)
        }),
    active = list(
        outcome = function() private$..outcome$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        predictors = function() private$..predictors$value,
        time_variable = function() private$..time_variable$value,
        model_type = function() private$..model_type$value,
        model_formula = function() private$..model_formula$value,
        validation_method = function() private$..validation_method$value,
        bootstrap_samples = function() private$..bootstrap_samples$value,
        cv_folds = function() private$..cv_folds$value,
        cv_repeats = function() private$..cv_repeats$value,
        holdout_proportion = function() private$..holdout_proportion$value,
        stratified_sampling = function() private$..stratified_sampling$value,
        clinical_context = function() private$..clinical_context$value,
        prevalence_adjustment = function() private$..prevalence_adjustment$value,
        population_prevalence = function() private$..population_prevalence$value,
        cost_matrix = function() private$..cost_matrix$value,
        fn_fp_cost_ratio = function() private$..fn_fp_cost_ratio$value,
        performance_metrics = function() private$..performance_metrics$value,
        confidence_level = function() private$..confidence_level$value,
        calibration_method = function() private$..calibration_method$value,
        calibration_bins = function() private$..calibration_bins$value,
        compare_models = function() private$..compare_models$value,
        comparison_models = function() private$..comparison_models$value,
        show_model_summary = function() private$..show_model_summary$value,
        show_performance_table = function() private$..show_performance_table$value,
        show_calibration_plot = function() private$..show_calibration_plot$value,
        show_roc_curve = function() private$..show_roc_curve$value,
        show_prc_curve = function() private$..show_prc_curve$value,
        show_validation_curves = function() private$..show_validation_curves$value,
        show_residual_plots = function() private$..show_residual_plots$value,
        show_clinical_interpretation = function() private$..show_clinical_interpretation$value,
        export_results = function() private$..export_results$value,
        detailed_bootstrap = function() private$..detailed_bootstrap$value,
        missing_data_handling = function() private$..missing_data_handling$value,
        imputation_methods = function() private$..imputation_methods$value,
        parallel_processing = function() private$..parallel_processing$value,
        n_cores = function() private$..n_cores$value,
        set_seed = function() private$..set_seed$value,
        seed_value = function() private$..seed_value$value),
    private = list(
        ..outcome = NA,
        ..outcomeLevel = NA,
        ..predictors = NA,
        ..time_variable = NA,
        ..model_type = NA,
        ..model_formula = NA,
        ..validation_method = NA,
        ..bootstrap_samples = NA,
        ..cv_folds = NA,
        ..cv_repeats = NA,
        ..holdout_proportion = NA,
        ..stratified_sampling = NA,
        ..clinical_context = NA,
        ..prevalence_adjustment = NA,
        ..population_prevalence = NA,
        ..cost_matrix = NA,
        ..fn_fp_cost_ratio = NA,
        ..performance_metrics = NA,
        ..confidence_level = NA,
        ..calibration_method = NA,
        ..calibration_bins = NA,
        ..compare_models = NA,
        ..comparison_models = NA,
        ..show_model_summary = NA,
        ..show_performance_table = NA,
        ..show_calibration_plot = NA,
        ..show_roc_curve = NA,
        ..show_prc_curve = NA,
        ..show_validation_curves = NA,
        ..show_residual_plots = NA,
        ..show_clinical_interpretation = NA,
        ..export_results = NA,
        ..detailed_bootstrap = NA,
        ..missing_data_handling = NA,
        ..imputation_methods = NA,
        ..parallel_processing = NA,
        ..n_cores = NA,
        ..set_seed = NA,
        ..seed_value = NA)
)

clinicalvalidationResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinicalvalidationResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        modelsummary = function() private$.items[["modelsummary"]],
        performancetable = function() private$.items[["performancetable"]],
        bootstrapresults = function() private$.items[["bootstrapresults"]],
        calibrationtable = function() private$.items[["calibrationtable"]],
        brierscore = function() private$.items[["brierscore"]],
        modelcomparison = function() private$.items[["modelcomparison"]],
        costreduction = function() private$.items[["costreduction"]],
        validationcurves = function() private$.items[["validationcurves"]],
        calibrationplot = function() private$.items[["calibrationplot"]],
        roccurve = function() private$.items[["roccurve"]],
        prccurve = function() private$.items[["prccurve"]],
        residualplots = function() private$.items[["residualplots"]],
        clinicalinterpretation = function() private$.items[["clinicalinterpretation"]],
        validationreport = function() private$.items[["validationreport"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Clinical Model Validation Suite",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "rms",
                    "boot",
                    "caret",
                    "pROC",
                    "ResourceSelection",
                    "MASS",
                    "randomForest",
                    "survival",
                    "ggplot2",
                    "stats",
                    "e1071",
                    "tools"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=FALSE))
            self$add(jmvcore::Html$new(
                options=options,
                name="modelsummary",
                title="Model Summary",
                visible="(show_model_summary)",
                clearWith=list(
                    "outcome",
                    "outcomeLevel",
                    "predictors",
                    "model_type",
                    "model_formula",
                    "time_variable")))
            self$add(jmvcore::Table$new(
                options=options,
                name="performancetable",
                title="Performance Metrics",
                visible="(show_performance_table)",
                clearWith=list(
                    "outcome",
                    "outcomeLevel",
                    "predictors",
                    "validation_method",
                    "bootstrap_samples",
                    "cv_folds",
                    "performance_metrics"),
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number", 
                        `format`="zto,p:.3"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower 95% CI", 
                        `type`="number", 
                        `format`="zto,p:.3"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper 95% CI", 
                        `type`="number", 
                        `format`="zto,p:.3"),
                    list(
                        `name`="interpretation", 
                        `title`="Clinical Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="bootstrapresults",
                title="Bootstrap Validation Results",
                visible="(validation_method:bootstrap && detailed_bootstrap)",
                clearWith=list(
                    "outcome",
                    "outcomeLevel",
                    "predictors",
                    "bootstrap_samples"),
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="original", 
                        `title`="Original", 
                        `type`="number", 
                        `format`="zto,p:.3"),
                    list(
                        `name`="bias", 
                        `title`="Bias", 
                        `type`="number", 
                        `format`="zto,p:.4"),
                    list(
                        `name`="bias_corrected", 
                        `title`="Bias-Corrected", 
                        `type`="number", 
                        `format`="zto,p:.3"),
                    list(
                        `name`="percentile_ci_lower", 
                        `title`="Percentile CI Lower", 
                        `type`="number", 
                        `format`="zto,p:.3"),
                    list(
                        `name`="percentile_ci_upper", 
                        `title`="Percentile CI Upper", 
                        `type`="number", 
                        `format`="zto,p:.3"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="calibrationtable",
                title="Model Calibration Assessment",
                visible="(calibration_method:all || calibration_method:hosmer_lemeshow)",
                clearWith=list(
                    "outcome",
                    "outcomeLevel",
                    "predictors",
                    "calibration_method",
                    "calibration_bins"),
                columns=list(
                    list(
                        `name`="test", 
                        `title`="Calibration Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Test Statistic", 
                        `type`="number", 
                        `format`="zto,p:.3"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,p:.4"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="brierscore",
                title="Brier Score Analysis",
                visible="(calibration_method:all || calibration_method:brier)",
                clearWith=list(
                    "outcome",
                    "outcomeLevel",
                    "predictors"),
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto,p:.4"),
                    list(
                        `name`="interpretation", 
                        `title`="Clinical Meaning", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelcomparison",
                title="Model Comparison Results",
                visible="(compare_models)",
                clearWith=list(
                    "outcome",
                    "outcomeLevel",
                    "predictors",
                    "comparison_models"),
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="auc", 
                        `title`="AUC", 
                        `type`="number", 
                        `format`="zto,p:.3"),
                    list(
                        `name`="accuracy", 
                        `title`="Accuracy", 
                        `type`="number", 
                        `format`="zto,p:.3"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity", 
                        `type`="number", 
                        `format`="zto,p:.3"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity", 
                        `type`="number", 
                        `format`="zto,p:.3"),
                    list(
                        `name`="rank", 
                        `title`="Rank", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="costreduction",
                title="Clinical Cost-Benefit Analysis",
                visible="(cost_matrix:!equal)",
                clearWith=list(
                    "outcome",
                    "outcomeLevel",
                    "predictors",
                    "cost_matrix",
                    "fn_fp_cost_ratio",
                    "prevalence_adjustment"),
                columns=list(
                    list(
                        `name`="threshold", 
                        `title`="Decision Threshold", 
                        `type`="number", 
                        `format`="zto,p:.3"),
                    list(
                        `name`="expected_cost", 
                        `title`="Expected Cost per Patient", 
                        `type`="number", 
                        `format`="zto,p:.2"),
                    list(
                        `name`="cost_reduction", 
                        `title`="Cost Reduction vs. Treat-All", 
                        `type`="number", 
                        `format`="zto,p:.2"),
                    list(
                        `name`="net_benefit", 
                        `title`="Net Benefit", 
                        `type`="number", 
                        `format`="zto,p:.4"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="validationcurves",
                title="Validation Learning Curves",
                width=800,
                height=600,
                renderFun=".validation_curves_plot",
                visible="(show_validation_curves)",
                clearWith=list(
                    "outcome",
                    "outcomeLevel",
                    "predictors",
                    "validation_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="calibrationplot",
                title="Calibration Plot",
                width=700,
                height=500,
                renderFun=".calibration_plot",
                visible="(show_calibration_plot)",
                clearWith=list(
                    "outcome",
                    "outcomeLevel",
                    "predictors",
                    "calibration_bins")))
            self$add(jmvcore::Image$new(
                options=options,
                name="roccurve",
                title="ROC Curve with Confidence Intervals",
                width=700,
                height=500,
                renderFun=".roc_curve_plot",
                visible="(show_roc_curve)",
                clearWith=list(
                    "outcome",
                    "outcomeLevel",
                    "predictors",
                    "confidence_level")))
            self$add(jmvcore::Image$new(
                options=options,
                name="prccurve",
                title="Precision-Recall Curve Analysis",
                width=700,
                height=500,
                renderFun=".prc_curve_plot",
                visible="(show_prc_curve)",
                clearWith=list(
                    "outcome",
                    "outcomeLevel",
                    "predictors",
                    "confidence_level"),
                refs=list(
                    "Saito2015")))
            self$add(jmvcore::Image$new(
                options=options,
                name="residualplots",
                title="Model Residual Analysis",
                width=900,
                height=600,
                renderFun=".residual_plots",
                visible="(show_residual_plots)",
                clearWith=list(
                    "outcome",
                    "outcomeLevel",
                    "predictors",
                    "model_type")))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalinterpretation",
                title="Clinical Decision Guidelines",
                visible="(show_clinical_interpretation)",
                clearWith=list(
                    "clinical_context",
                    "outcome",
                    "outcomeLevel",
                    "cost_matrix")))
            self$add(jmvcore::Html$new(
                options=options,
                name="validationreport",
                title="Validation Report Summary",
                visible="(export_results)",
                clearWith=list(
                    "outcome",
                    "outcomeLevel",
                    "predictors",
                    "validation_method")))}))

clinicalvalidationBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinicalvalidationBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "clinicalvalidation",
                version = c(0,0,32),
                options = options,
                results = clinicalvalidationResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Clinical Model Validation Suite
#'
#' Comprehensive validation suite for clinical prediction models including 
#' bootstrap validation, cross-validation, model calibration assessment, 
#' and clinical performance evaluation designed for medical research and 
#' diagnostic test evaluation.
#' 
#'
#' @examples
#' # Clinical model validation with bootstrap
#' clinical_validation(
#'     data = clinical_data,
#'     outcome = "diagnosis",
#'     predictors = c("biomarker1", "biomarker2", "age", "gender"),
#'     model_type = "logistic",
#'     validation_method = "bootstrap",
#'     bootstrap_samples = 1000,
#'     clinical_context = "diagnosis"
#' )
#'
#' @param data The data as a data frame for clinical model validation.
#' @param outcome .
#' @param outcomeLevel .
#' @param predictors .
#' @param time_variable .
#' @param model_type .
#' @param model_formula .
#' @param validation_method .
#' @param bootstrap_samples .
#' @param cv_folds .
#' @param cv_repeats .
#' @param holdout_proportion .
#' @param stratified_sampling .
#' @param clinical_context .
#' @param prevalence_adjustment .
#' @param population_prevalence .
#' @param cost_matrix .
#' @param fn_fp_cost_ratio .
#' @param performance_metrics .
#' @param confidence_level .
#' @param calibration_method .
#' @param calibration_bins .
#' @param compare_models .
#' @param comparison_models .
#' @param show_model_summary .
#' @param show_performance_table .
#' @param show_calibration_plot .
#' @param show_roc_curve .
#' @param show_prc_curve Display Precision-Recall curve analysis. Recommended
#'   for imbalanced datasets where ROC curves may be misleading (Saito &
#'   Rehmsmeier, 2015).
#' @param show_validation_curves .
#' @param show_residual_plots .
#' @param show_clinical_interpretation .
#' @param export_results .
#' @param detailed_bootstrap .
#' @param missing_data_handling .
#' @param imputation_methods .
#' @param parallel_processing .
#' @param n_cores .
#' @param set_seed .
#' @param seed_value .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelsummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$performancetable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$bootstrapresults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$calibrationtable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$brierscore} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelcomparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$costreduction} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$validationcurves} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$calibrationplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$roccurve} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$prccurve} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$residualplots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$clinicalinterpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$validationreport} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$performancetable$asDF}
#'
#' \code{as.data.frame(results$performancetable)}
#'
#' @export
clinicalvalidation <- function(
    data,
    outcome,
    outcomeLevel,
    predictors,
    time_variable = NULL,
    model_type = "logistic",
    model_formula = "",
    validation_method = "bootstrap",
    bootstrap_samples = 1000,
    cv_folds = 10,
    cv_repeats = 3,
    holdout_proportion = 0.25,
    stratified_sampling = TRUE,
    clinical_context = "diagnosis",
    prevalence_adjustment = FALSE,
    population_prevalence = 10,
    cost_matrix = "equal",
    fn_fp_cost_ratio = 2,
    performance_metrics = "all",
    confidence_level = 0.95,
    calibration_method = "all",
    calibration_bins = 10,
    compare_models = FALSE,
    comparison_models = "logistic_rf",
    show_model_summary = TRUE,
    show_performance_table = TRUE,
    show_calibration_plot = TRUE,
    show_roc_curve = TRUE,
    show_prc_curve = FALSE,
    show_validation_curves = FALSE,
    show_residual_plots = FALSE,
    show_clinical_interpretation = TRUE,
    export_results = FALSE,
    detailed_bootstrap = FALSE,
    missing_data_handling = "complete_cases",
    imputation_methods = 5,
    parallel_processing = FALSE,
    n_cores = 2,
    set_seed = TRUE,
    seed_value = 42) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("clinicalvalidation requires jmvcore to be installed (restart may be required)")

    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(predictors)) predictors <- jmvcore::resolveQuo(jmvcore::enquo(predictors))
    if ( ! missing(time_variable)) time_variable <- jmvcore::resolveQuo(jmvcore::enquo(time_variable))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(predictors), predictors, NULL),
            `if`( ! missing(time_variable), time_variable, NULL))

    for (v in outcome) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- clinicalvalidationOptions$new(
        outcome = outcome,
        outcomeLevel = outcomeLevel,
        predictors = predictors,
        time_variable = time_variable,
        model_type = model_type,
        model_formula = model_formula,
        validation_method = validation_method,
        bootstrap_samples = bootstrap_samples,
        cv_folds = cv_folds,
        cv_repeats = cv_repeats,
        holdout_proportion = holdout_proportion,
        stratified_sampling = stratified_sampling,
        clinical_context = clinical_context,
        prevalence_adjustment = prevalence_adjustment,
        population_prevalence = population_prevalence,
        cost_matrix = cost_matrix,
        fn_fp_cost_ratio = fn_fp_cost_ratio,
        performance_metrics = performance_metrics,
        confidence_level = confidence_level,
        calibration_method = calibration_method,
        calibration_bins = calibration_bins,
        compare_models = compare_models,
        comparison_models = comparison_models,
        show_model_summary = show_model_summary,
        show_performance_table = show_performance_table,
        show_calibration_plot = show_calibration_plot,
        show_roc_curve = show_roc_curve,
        show_prc_curve = show_prc_curve,
        show_validation_curves = show_validation_curves,
        show_residual_plots = show_residual_plots,
        show_clinical_interpretation = show_clinical_interpretation,
        export_results = export_results,
        detailed_bootstrap = detailed_bootstrap,
        missing_data_handling = missing_data_handling,
        imputation_methods = imputation_methods,
        parallel_processing = parallel_processing,
        n_cores = n_cores,
        set_seed = set_seed,
        seed_value = seed_value)

    analysis <- clinicalvalidationClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

