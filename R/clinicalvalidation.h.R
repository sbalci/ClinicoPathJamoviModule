
# This file is automatically generated, you probably don't want to edit this

clinicalvalidationOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinicalvalidationOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            testVar = NULL,
            referenceVar = NULL,
            validationType = "accuracy",
            referenceMethod = "r_stats",
            toleranceLevel = 0.01,
            confidenceLevel = 95,
            performEquivalence = TRUE,
            generateReport = TRUE,
            regulatoryStandard = "fda",
            documentationLevel = "comprehensive", ...) {

            super$initialize(
                package="ClinicoPath",
                name="clinicalvalidation",
                requiresData=TRUE,
                ...)

            private$..testVar <- jmvcore::OptionVariable$new(
                "testVar",
                testVar,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..referenceVar <- jmvcore::OptionVariable$new(
                "referenceVar",
                referenceVar,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..validationType <- jmvcore::OptionList$new(
                "validationType",
                validationType,
                options=list(
                    "accuracy",
                    "clinical_guidelines",
                    "regulatory",
                    "cross_platform"),
                default="accuracy")
            private$..referenceMethod <- jmvcore::OptionList$new(
                "referenceMethod",
                referenceMethod,
                options=list(
                    "r_stats",
                    "sas",
                    "spss",
                    "stata",
                    "published"),
                default="r_stats")
            private$..toleranceLevel <- jmvcore::OptionNumber$new(
                "toleranceLevel",
                toleranceLevel,
                min=0.001,
                max=0.1,
                default=0.01)
            private$..confidenceLevel <- jmvcore::OptionNumber$new(
                "confidenceLevel",
                confidenceLevel,
                min=90,
                max=99.9,
                default=95)
            private$..performEquivalence <- jmvcore::OptionBool$new(
                "performEquivalence",
                performEquivalence,
                default=TRUE)
            private$..generateReport <- jmvcore::OptionBool$new(
                "generateReport",
                generateReport,
                default=TRUE)
            private$..regulatoryStandard <- jmvcore::OptionList$new(
                "regulatoryStandard",
                regulatoryStandard,
                options=list(
                    "fda",
                    "ema",
                    "ich",
                    "gcp"),
                default="fda")
            private$..documentationLevel <- jmvcore::OptionList$new(
                "documentationLevel",
                documentationLevel,
                options=list(
                    "basic",
                    "comprehensive",
                    "submission_ready"),
                default="comprehensive")

            self$.addOption(private$..testVar)
            self$.addOption(private$..referenceVar)
            self$.addOption(private$..validationType)
            self$.addOption(private$..referenceMethod)
            self$.addOption(private$..toleranceLevel)
            self$.addOption(private$..confidenceLevel)
            self$.addOption(private$..performEquivalence)
            self$.addOption(private$..generateReport)
            self$.addOption(private$..regulatoryStandard)
            self$.addOption(private$..documentationLevel)
        }),
    active = list(
        testVar = function() private$..testVar$value,
        referenceVar = function() private$..referenceVar$value,
        validationType = function() private$..validationType$value,
        referenceMethod = function() private$..referenceMethod$value,
        toleranceLevel = function() private$..toleranceLevel$value,
        confidenceLevel = function() private$..confidenceLevel$value,
        performEquivalence = function() private$..performEquivalence$value,
        generateReport = function() private$..generateReport$value,
        regulatoryStandard = function() private$..regulatoryStandard$value,
        documentationLevel = function() private$..documentationLevel$value),
    private = list(
        ..testVar = NA,
        ..referenceVar = NA,
        ..validationType = NA,
        ..referenceMethod = NA,
        ..toleranceLevel = NA,
        ..confidenceLevel = NA,
        ..performEquivalence = NA,
        ..generateReport = NA,
        ..regulatoryStandard = NA,
        ..documentationLevel = NA)
)

clinicalvalidationResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinicalvalidationResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        validationSummary = function() private$.items[["validationSummary"]],
        accuracyTests = function() private$.items[["accuracyTests"]],
        equivalenceTest = function() private$.items[["equivalenceTest"]],
        complianceChecklist = function() private$.items[["complianceChecklist"]],
        validationReport = function() private$.items[["validationReport"]],
        agreementPlot = function() private$.items[["agreementPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Clinical Validation Framework")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="validationSummary",
                title="Validation Summary",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="test_name", 
                        `title`="Validation Test", 
                        `type`="text"),
                    list(
                        `name`="result", 
                        `title`="Result", 
                        `type`="text"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="confidence_interval", 
                        `title`="95% CI", 
                        `type`="text"),
                    list(
                        `name`="status", 
                        `title`="Status", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="accuracyTests",
                title="Statistical Accuracy Tests",
                visible="(validationType:accuracy)",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Accuracy Metric", 
                        `type`="text"),
                    list(
                        `name`="test_value", 
                        `title`="Test Value", 
                        `type`="number"),
                    list(
                        `name`="reference_value", 
                        `title`="Reference Value", 
                        `type`="number"),
                    list(
                        `name`="difference", 
                        `title`="Difference", 
                        `type`="number"),
                    list(
                        `name`="relative_error", 
                        `title`="Relative Error (%)", 
                        `type`="number"),
                    list(
                        `name`="within_tolerance", 
                        `title`="Within Tolerance", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="equivalenceTest",
                title="Equivalence Testing",
                visible="(performEquivalence)",
                columns=list(
                    list(
                        `name`="test_type", 
                        `title`="Test Type", 
                        `type`="text"),
                    list(
                        `name`="equivalence_margin", 
                        `title`="Equivalence Margin", 
                        `type`="number"),
                    list(
                        `name`="test_statistic", 
                        `title`="Test Statistic", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="conclusion", 
                        `title`="Conclusion", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="complianceChecklist",
                title="Compliance Checklist",
                visible="(validationType:clinical_guidelines || validationType:regulatory)",
                columns=list(
                    list(
                        `name`="requirement", 
                        `title`="Requirement", 
                        `type`="text"),
                    list(
                        `name`="standard", 
                        `title`="Standard", 
                        `type`="text"),
                    list(
                        `name`="status", 
                        `title`="Status", 
                        `type`="text"),
                    list(
                        `name`="notes", 
                        `title`="Notes", 
                        `type`="text"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="validationReport",
                title="Validation Report",
                visible="(generateReport)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="agreementPlot",
                title="Method Agreement Plot",
                visible="(testVar && referenceVar)",
                width=600,
                height=500,
                renderFun=".agreementPlot"))}))

clinicalvalidationBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "clinicalvalidationBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "clinicalvalidation",
                version = c(1,0,0),
                options = options,
                results = clinicalvalidationResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Clinical Validation Framework
#'
#' 
#' @param data .
#' @param testVar .
#' @param referenceVar .
#' @param validationType .
#' @param referenceMethod .
#' @param toleranceLevel .
#' @param confidenceLevel .
#' @param performEquivalence .
#' @param generateReport .
#' @param regulatoryStandard .
#' @param documentationLevel .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$validationSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$accuracyTests} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$equivalenceTest} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$complianceChecklist} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$validationReport} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$agreementPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$validationSummary$asDF}
#'
#' \code{as.data.frame(results$validationSummary)}
#'
#' @export
clinicalvalidation <- function(
    data,
    testVar,
    referenceVar,
    validationType = "accuracy",
    referenceMethod = "r_stats",
    toleranceLevel = 0.01,
    confidenceLevel = 95,
    performEquivalence = TRUE,
    generateReport = TRUE,
    regulatoryStandard = "fda",
    documentationLevel = "comprehensive") {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("clinicalvalidation requires jmvcore to be installed (restart may be required)")

    if ( ! missing(testVar)) testVar <- jmvcore::resolveQuo(jmvcore::enquo(testVar))
    if ( ! missing(referenceVar)) referenceVar <- jmvcore::resolveQuo(jmvcore::enquo(referenceVar))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(testVar), testVar, NULL),
            `if`( ! missing(referenceVar), referenceVar, NULL))


    options <- clinicalvalidationOptions$new(
        testVar = testVar,
        referenceVar = referenceVar,
        validationType = validationType,
        referenceMethod = referenceMethod,
        toleranceLevel = toleranceLevel,
        confidenceLevel = confidenceLevel,
        performEquivalence = performEquivalence,
        generateReport = generateReport,
        regulatoryStandard = regulatoryStandard,
        documentationLevel = documentationLevel)

    analysis <- clinicalvalidationClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

