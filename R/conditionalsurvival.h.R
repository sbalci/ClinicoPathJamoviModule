
# This file is automatically generated, you probably don't want to edit this

conditionalsurvivalOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "conditionalsurvivalOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            timeVar = NULL,
            outcomeVar = NULL,
            conditionVar = NULL,
            conditionTime = NULL,
            method = "km",
            bandwidth = NULL,
            confInt = 0.95,
            timePoints = "",
            plotType = "curves",
            showTable = TRUE,
            showPlot = TRUE,
            showExplanations = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="conditionalsurvival",
                requiresData=TRUE,
                ...)

            private$..timeVar <- jmvcore::OptionVariable$new(
                "timeVar",
                timeVar,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcomeVar <- jmvcore::OptionVariable$new(
                "outcomeVar",
                outcomeVar,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..conditionVar <- jmvcore::OptionVariable$new(
                "conditionVar",
                conditionVar,
                suggested=list(
                    "ordinal",
                    "nominal",
                    "continuous"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..conditionTime <- jmvcore::OptionNumber$new(
                "conditionTime",
                conditionTime)
            private$..method <- jmvcore::OptionList$new(
                "method",
                method,
                options=list(
                    "km",
                    "landmark",
                    "ipw",
                    "pkm"),
                default="km")
            private$..bandwidth <- jmvcore::OptionNumber$new(
                "bandwidth",
                bandwidth)
            private$..confInt <- jmvcore::OptionNumber$new(
                "confInt",
                confInt,
                default=0.95,
                min=0.01,
                max=0.99)
            private$..timePoints <- jmvcore::OptionString$new(
                "timePoints",
                timePoints,
                default="")
            private$..plotType <- jmvcore::OptionList$new(
                "plotType",
                plotType,
                options=list(
                    "curves",
                    "probability",
                    "both"),
                default="curves")
            private$..showTable <- jmvcore::OptionBool$new(
                "showTable",
                showTable,
                default=TRUE)
            private$..showPlot <- jmvcore::OptionBool$new(
                "showPlot",
                showPlot,
                default=TRUE)
            private$..showExplanations <- jmvcore::OptionBool$new(
                "showExplanations",
                showExplanations,
                default=TRUE)

            self$.addOption(private$..timeVar)
            self$.addOption(private$..outcomeVar)
            self$.addOption(private$..conditionVar)
            self$.addOption(private$..conditionTime)
            self$.addOption(private$..method)
            self$.addOption(private$..bandwidth)
            self$.addOption(private$..confInt)
            self$.addOption(private$..timePoints)
            self$.addOption(private$..plotType)
            self$.addOption(private$..showTable)
            self$.addOption(private$..showPlot)
            self$.addOption(private$..showExplanations)
        }),
    active = list(
        timeVar = function() private$..timeVar$value,
        outcomeVar = function() private$..outcomeVar$value,
        conditionVar = function() private$..conditionVar$value,
        conditionTime = function() private$..conditionTime$value,
        method = function() private$..method$value,
        bandwidth = function() private$..bandwidth$value,
        confInt = function() private$..confInt$value,
        timePoints = function() private$..timePoints$value,
        plotType = function() private$..plotType$value,
        showTable = function() private$..showTable$value,
        showPlot = function() private$..showPlot$value,
        showExplanations = function() private$..showExplanations$value),
    private = list(
        ..timeVar = NA,
        ..outcomeVar = NA,
        ..conditionVar = NA,
        ..conditionTime = NA,
        ..method = NA,
        ..bandwidth = NA,
        ..confInt = NA,
        ..timePoints = NA,
        ..plotType = NA,
        ..showTable = NA,
        ..showPlot = NA,
        ..showExplanations = NA)
)

conditionalsurvivalResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "conditionalsurvivalResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        condsurvTable = function() private$.items[["condsurvTable"]],
        survplot = function() private$.items[["survplot"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Conditional Survival Estimation",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "survival",
                    "condSURV",
                    "scales"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis",
                visible="(showExplanations)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="condsurvTable",
                title="Conditional Survival Probabilities",
                visible="(showTable)",
                rows=1,
                clearWith=list(
                    "timeVar",
                    "outcomeVar",
                    "conditionVar",
                    "conditionTime",
                    "method",
                    "timePoints"),
                columns=list(
                    list(
                        `name`="time", 
                        `title`="Time Point", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="condtime", 
                        `title`="Conditioning Time", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="condprob", 
                        `title`="Conditional Survival", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="se", 
                        `title`="Standard Error", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto:4"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="survplot",
                title="Conditional Survival Plot",
                visible="(showPlot)",
                requiresData=TRUE,
                width=600,
                height=450,
                renderFun=".plot",
                clearWith=list(
                    "timeVar",
                    "outcomeVar",
                    "conditionVar",
                    "conditionTime",
                    "method",
                    "plotType")))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Method and Interpretation",
                visible="(showExplanations)"))}))

conditionalsurvivalBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "conditionalsurvivalBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "conditionalsurvival",
                version = c(0,0,1),
                options = options,
                results = conditionalsurvivalResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Conditional Survival Estimation
#'
#' Performs conditional survival estimation, which calculates the probability  
#' of surviving beyond a specific time point given survival to a conditioning  
#' time point. This analysis is particularly useful for updating prognosis  
#' estimates for patients who have already survived a certain period. Multiple  
#' estimation methods are supported including Kaplan-Meier weights, landmark  
#' approaches, and inverse probability weighting.
#'
#' @examples
#' # example will be added
#'
#' @param data The data as a data frame.
#' @param timeVar Survival time variable (numeric)
#' @param outcomeVar Event indicator (0=censored, 1=event)
#' @param conditionVar Variable for conditional survival estimation
#' @param conditionTime Time point at which to condition survival (defaults to
#'   median follow-up)
#' @param method Method for conditional survival estimation
#' @param bandwidth Bandwidth for kernel smoothing (auto-selected if not
#'   specified)
#' @param confInt Confidence level for intervals
#' @param timePoints Comma-separated time points for conditional survival
#'   (e.g., 12,24,60)
#' @param plotType Type of plot to display
#' @param showTable Display conditional survival probabilities table
#' @param showPlot Display conditional survival plot
#' @param showExplanations Display interpretation and methodology explanations
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$condsurvTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$survplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$condsurvTable$asDF}
#'
#' \code{as.data.frame(results$condsurvTable)}
#'
#' @export
conditionalsurvival <- function(
    data,
    timeVar,
    outcomeVar,
    conditionVar,
    conditionTime,
    method = "km",
    bandwidth,
    confInt = 0.95,
    timePoints = "",
    plotType = "curves",
    showTable = TRUE,
    showPlot = TRUE,
    showExplanations = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("conditionalsurvival requires jmvcore to be installed (restart may be required)")

    if ( ! missing(timeVar)) timeVar <- jmvcore::resolveQuo(jmvcore::enquo(timeVar))
    if ( ! missing(outcomeVar)) outcomeVar <- jmvcore::resolveQuo(jmvcore::enquo(outcomeVar))
    if ( ! missing(conditionVar)) conditionVar <- jmvcore::resolveQuo(jmvcore::enquo(conditionVar))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(timeVar), timeVar, NULL),
            `if`( ! missing(outcomeVar), outcomeVar, NULL),
            `if`( ! missing(conditionVar), conditionVar, NULL))


    options <- conditionalsurvivalOptions$new(
        timeVar = timeVar,
        outcomeVar = outcomeVar,
        conditionVar = conditionVar,
        conditionTime = conditionTime,
        method = method,
        bandwidth = bandwidth,
        confInt = confInt,
        timePoints = timePoints,
        plotType = plotType,
        showTable = showTable,
        showPlot = showPlot,
        showExplanations = showExplanations)

    analysis <- conditionalsurvivalClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

