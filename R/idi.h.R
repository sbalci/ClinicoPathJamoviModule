
# This file is automatically generated, you probably don't want to edit this

idiOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "idiOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            outcome = NULL,
            baseline_risk = NULL,
            new_risk = NULL,
            time_var = NULL,
            followup_time = 5,
            idi_type = "standard",
            discrimination_measure = "mean_diff",
            trim_proportion = 0.1,
            confidence_level = 0.95,
            bootstrap_samples = 1000,
            bootstrap_method = "bca",
            hypothesis_test = TRUE,
            test_method = "bootstrap",
            decompose_idi = TRUE,
            risk_distribution = TRUE,
            discrimination_slope = TRUE,
            relative_improvement = TRUE,
            cross_validation = FALSE,
            cv_folds = 5,
            sensitivity_analysis = FALSE,
            outlier_detection = FALSE,
            outlier_method = "iqr",
            show_summary = TRUE,
            show_distributions = TRUE,
            show_discrimination = TRUE,
            show_validation = FALSE,
            plot_risk_distributions = TRUE,
            plot_discrimination = TRUE,
            plot_scatter = TRUE,
            plot_bootstrap = FALSE,
            plot_sensitivity = FALSE,
            plot_outliers = FALSE,
            competing_risks = FALSE,
            stratified_analysis = FALSE,
            subgroup_var = NULL,
            missing_handling = "complete",
            calibration_aware = FALSE,
            time_dependent = FALSE,
            alpha_level = 0.05,
            random_seed = 123, ...) {

            super$initialize(
                package="ClinicoPath",
                name="idi",
                requiresData=TRUE,
                ...)

            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..baseline_risk <- jmvcore::OptionVariable$new(
                "baseline_risk",
                baseline_risk,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..new_risk <- jmvcore::OptionVariable$new(
                "new_risk",
                new_risk,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..time_var <- jmvcore::OptionVariable$new(
                "time_var",
                time_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..followup_time <- jmvcore::OptionNumber$new(
                "followup_time",
                followup_time,
                default=5,
                min=0.1)
            private$..idi_type <- jmvcore::OptionList$new(
                "idi_type",
                idi_type,
                options=list(
                    "standard",
                    "relative",
                    "scaled",
                    "all"),
                default="standard")
            private$..discrimination_measure <- jmvcore::OptionList$new(
                "discrimination_measure",
                discrimination_measure,
                options=list(
                    "mean_diff",
                    "median_diff",
                    "trimmed_mean",
                    "robust"),
                default="mean_diff")
            private$..trim_proportion <- jmvcore::OptionNumber$new(
                "trim_proportion",
                trim_proportion,
                default=0.1,
                min=0,
                max=0.4)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.5,
                max=0.99)
            private$..bootstrap_samples <- jmvcore::OptionInteger$new(
                "bootstrap_samples",
                bootstrap_samples,
                default=1000,
                min=100,
                max=10000)
            private$..bootstrap_method <- jmvcore::OptionList$new(
                "bootstrap_method",
                bootstrap_method,
                options=list(
                    "percentile",
                    "bca",
                    "basic",
                    "studentized"),
                default="bca")
            private$..hypothesis_test <- jmvcore::OptionBool$new(
                "hypothesis_test",
                hypothesis_test,
                default=TRUE)
            private$..test_method <- jmvcore::OptionList$new(
                "test_method",
                test_method,
                options=list(
                    "bootstrap",
                    "asymptotic",
                    "permutation",
                    "robust"),
                default="bootstrap")
            private$..decompose_idi <- jmvcore::OptionBool$new(
                "decompose_idi",
                decompose_idi,
                default=TRUE)
            private$..risk_distribution <- jmvcore::OptionBool$new(
                "risk_distribution",
                risk_distribution,
                default=TRUE)
            private$..discrimination_slope <- jmvcore::OptionBool$new(
                "discrimination_slope",
                discrimination_slope,
                default=TRUE)
            private$..relative_improvement <- jmvcore::OptionBool$new(
                "relative_improvement",
                relative_improvement,
                default=TRUE)
            private$..cross_validation <- jmvcore::OptionBool$new(
                "cross_validation",
                cross_validation,
                default=FALSE)
            private$..cv_folds <- jmvcore::OptionInteger$new(
                "cv_folds",
                cv_folds,
                default=5,
                min=3,
                max=10)
            private$..sensitivity_analysis <- jmvcore::OptionBool$new(
                "sensitivity_analysis",
                sensitivity_analysis,
                default=FALSE)
            private$..outlier_detection <- jmvcore::OptionBool$new(
                "outlier_detection",
                outlier_detection,
                default=FALSE)
            private$..outlier_method <- jmvcore::OptionList$new(
                "outlier_method",
                outlier_method,
                options=list(
                    "iqr",
                    "zscore",
                    "modified_zscore",
                    "isolation"),
                default="iqr")
            private$..show_summary <- jmvcore::OptionBool$new(
                "show_summary",
                show_summary,
                default=TRUE)
            private$..show_distributions <- jmvcore::OptionBool$new(
                "show_distributions",
                show_distributions,
                default=TRUE)
            private$..show_discrimination <- jmvcore::OptionBool$new(
                "show_discrimination",
                show_discrimination,
                default=TRUE)
            private$..show_validation <- jmvcore::OptionBool$new(
                "show_validation",
                show_validation,
                default=FALSE)
            private$..plot_risk_distributions <- jmvcore::OptionBool$new(
                "plot_risk_distributions",
                plot_risk_distributions,
                default=TRUE)
            private$..plot_discrimination <- jmvcore::OptionBool$new(
                "plot_discrimination",
                plot_discrimination,
                default=TRUE)
            private$..plot_scatter <- jmvcore::OptionBool$new(
                "plot_scatter",
                plot_scatter,
                default=TRUE)
            private$..plot_bootstrap <- jmvcore::OptionBool$new(
                "plot_bootstrap",
                plot_bootstrap,
                default=FALSE)
            private$..plot_sensitivity <- jmvcore::OptionBool$new(
                "plot_sensitivity",
                plot_sensitivity,
                default=FALSE)
            private$..plot_outliers <- jmvcore::OptionBool$new(
                "plot_outliers",
                plot_outliers,
                default=FALSE)
            private$..competing_risks <- jmvcore::OptionBool$new(
                "competing_risks",
                competing_risks,
                default=FALSE)
            private$..stratified_analysis <- jmvcore::OptionBool$new(
                "stratified_analysis",
                stratified_analysis,
                default=FALSE)
            private$..subgroup_var <- jmvcore::OptionVariable$new(
                "subgroup_var",
                subgroup_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..missing_handling <- jmvcore::OptionList$new(
                "missing_handling",
                missing_handling,
                options=list(
                    "complete",
                    "imputation",
                    "ipw"),
                default="complete")
            private$..calibration_aware <- jmvcore::OptionBool$new(
                "calibration_aware",
                calibration_aware,
                default=FALSE)
            private$..time_dependent <- jmvcore::OptionBool$new(
                "time_dependent",
                time_dependent,
                default=FALSE)
            private$..alpha_level <- jmvcore::OptionNumber$new(
                "alpha_level",
                alpha_level,
                default=0.05,
                min=0.001,
                max=0.2)
            private$..random_seed <- jmvcore::OptionInteger$new(
                "random_seed",
                random_seed,
                default=123,
                min=1,
                max=999999)

            self$.addOption(private$..outcome)
            self$.addOption(private$..baseline_risk)
            self$.addOption(private$..new_risk)
            self$.addOption(private$..time_var)
            self$.addOption(private$..followup_time)
            self$.addOption(private$..idi_type)
            self$.addOption(private$..discrimination_measure)
            self$.addOption(private$..trim_proportion)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..bootstrap_samples)
            self$.addOption(private$..bootstrap_method)
            self$.addOption(private$..hypothesis_test)
            self$.addOption(private$..test_method)
            self$.addOption(private$..decompose_idi)
            self$.addOption(private$..risk_distribution)
            self$.addOption(private$..discrimination_slope)
            self$.addOption(private$..relative_improvement)
            self$.addOption(private$..cross_validation)
            self$.addOption(private$..cv_folds)
            self$.addOption(private$..sensitivity_analysis)
            self$.addOption(private$..outlier_detection)
            self$.addOption(private$..outlier_method)
            self$.addOption(private$..show_summary)
            self$.addOption(private$..show_distributions)
            self$.addOption(private$..show_discrimination)
            self$.addOption(private$..show_validation)
            self$.addOption(private$..plot_risk_distributions)
            self$.addOption(private$..plot_discrimination)
            self$.addOption(private$..plot_scatter)
            self$.addOption(private$..plot_bootstrap)
            self$.addOption(private$..plot_sensitivity)
            self$.addOption(private$..plot_outliers)
            self$.addOption(private$..competing_risks)
            self$.addOption(private$..stratified_analysis)
            self$.addOption(private$..subgroup_var)
            self$.addOption(private$..missing_handling)
            self$.addOption(private$..calibration_aware)
            self$.addOption(private$..time_dependent)
            self$.addOption(private$..alpha_level)
            self$.addOption(private$..random_seed)
        }),
    active = list(
        outcome = function() private$..outcome$value,
        baseline_risk = function() private$..baseline_risk$value,
        new_risk = function() private$..new_risk$value,
        time_var = function() private$..time_var$value,
        followup_time = function() private$..followup_time$value,
        idi_type = function() private$..idi_type$value,
        discrimination_measure = function() private$..discrimination_measure$value,
        trim_proportion = function() private$..trim_proportion$value,
        confidence_level = function() private$..confidence_level$value,
        bootstrap_samples = function() private$..bootstrap_samples$value,
        bootstrap_method = function() private$..bootstrap_method$value,
        hypothesis_test = function() private$..hypothesis_test$value,
        test_method = function() private$..test_method$value,
        decompose_idi = function() private$..decompose_idi$value,
        risk_distribution = function() private$..risk_distribution$value,
        discrimination_slope = function() private$..discrimination_slope$value,
        relative_improvement = function() private$..relative_improvement$value,
        cross_validation = function() private$..cross_validation$value,
        cv_folds = function() private$..cv_folds$value,
        sensitivity_analysis = function() private$..sensitivity_analysis$value,
        outlier_detection = function() private$..outlier_detection$value,
        outlier_method = function() private$..outlier_method$value,
        show_summary = function() private$..show_summary$value,
        show_distributions = function() private$..show_distributions$value,
        show_discrimination = function() private$..show_discrimination$value,
        show_validation = function() private$..show_validation$value,
        plot_risk_distributions = function() private$..plot_risk_distributions$value,
        plot_discrimination = function() private$..plot_discrimination$value,
        plot_scatter = function() private$..plot_scatter$value,
        plot_bootstrap = function() private$..plot_bootstrap$value,
        plot_sensitivity = function() private$..plot_sensitivity$value,
        plot_outliers = function() private$..plot_outliers$value,
        competing_risks = function() private$..competing_risks$value,
        stratified_analysis = function() private$..stratified_analysis$value,
        subgroup_var = function() private$..subgroup_var$value,
        missing_handling = function() private$..missing_handling$value,
        calibration_aware = function() private$..calibration_aware$value,
        time_dependent = function() private$..time_dependent$value,
        alpha_level = function() private$..alpha_level$value,
        random_seed = function() private$..random_seed$value),
    private = list(
        ..outcome = NA,
        ..baseline_risk = NA,
        ..new_risk = NA,
        ..time_var = NA,
        ..followup_time = NA,
        ..idi_type = NA,
        ..discrimination_measure = NA,
        ..trim_proportion = NA,
        ..confidence_level = NA,
        ..bootstrap_samples = NA,
        ..bootstrap_method = NA,
        ..hypothesis_test = NA,
        ..test_method = NA,
        ..decompose_idi = NA,
        ..risk_distribution = NA,
        ..discrimination_slope = NA,
        ..relative_improvement = NA,
        ..cross_validation = NA,
        ..cv_folds = NA,
        ..sensitivity_analysis = NA,
        ..outlier_detection = NA,
        ..outlier_method = NA,
        ..show_summary = NA,
        ..show_distributions = NA,
        ..show_discrimination = NA,
        ..show_validation = NA,
        ..plot_risk_distributions = NA,
        ..plot_discrimination = NA,
        ..plot_scatter = NA,
        ..plot_bootstrap = NA,
        ..plot_sensitivity = NA,
        ..plot_outliers = NA,
        ..competing_risks = NA,
        ..stratified_analysis = NA,
        ..subgroup_var = NA,
        ..missing_handling = NA,
        ..calibration_aware = NA,
        ..time_dependent = NA,
        ..alpha_level = NA,
        ..random_seed = NA)
)

idiResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "idiResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        todo = function() private$.items[["todo"]],
        summary = function() private$.items[["summary"]],
        distributionSummary = function() private$.items[["distributionSummary"]],
        discriminationAnalysis = function() private$.items[["discriminationAnalysis"]],
        decomposition = function() private$.items[["decomposition"]],
        validationResults = function() private$.items[["validationResults"]],
        subgroupAnalysis = function() private$.items[["subgroupAnalysis"]],
        outlierAnalysis = function() private$.items[["outlierAnalysis"]],
        sensitivityTable = function() private$.items[["sensitivityTable"]],
        riskDistributionsPlot = function() private$.items[["riskDistributionsPlot"]],
        discriminationPlot = function() private$.items[["discriminationPlot"]],
        scatterPlot = function() private$.items[["scatterPlot"]],
        bootstrapPlot = function() private$.items[["bootstrapPlot"]],
        sensitivityPlot = function() private$.items[["sensitivityPlot"]],
        outliersPlot = function() private$.items[["outliersPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Analysis Results")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=FALSE))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis Todo",
                visible=FALSE))
            self$add(jmvcore::Table$new(
                options=options,
                name="summary",
                title="IDI Summary",
                visible="(show_summary)",
                clearWith=list(
                    "outcome",
                    "baseline_risk",
                    "new_risk",
                    "idi_type",
                    "discrimination_measure"),
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="distributionSummary",
                title="Risk Distribution Summary",
                visible="(show_distributions)",
                clearWith=list(
                    "baseline_risk",
                    "new_risk",
                    "outcome",
                    "risk_distribution"),
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="outcome_group", 
                        `title`="Outcome Group", 
                        `type`="text"),
                    list(
                        `name`="n_subjects", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="mean_risk", 
                        `title`="Mean Risk", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="median_risk", 
                        `title`="Median Risk", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="sd_risk", 
                        `title`="SD Risk", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="risk_range", 
                        `title`="Risk Range", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="discriminationAnalysis",
                title="Discrimination Analysis",
                visible="(show_discrimination)",
                clearWith=list(
                    "discrimination_slope",
                    "discrimination_measure"),
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="discrimination_slope", 
                        `title`="Discrimination Slope", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="slope_ci", 
                        `title`="95% CI", 
                        `type`="text"),
                    list(
                        `name`="relative_improvement", 
                        `title`="Relative Improvement (%)", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="significance", 
                        `title`="Significance", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="decomposition",
                title="IDI Decomposition",
                visible="(decompose_idi)",
                clearWith=list(
                    "outcome",
                    "baseline_risk",
                    "new_risk",
                    "idi_type"),
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="idi_events", 
                        `title`="IDI Events", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="idi_nonevents", 
                        `title`="IDI Non-Events", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="total_idi", 
                        `title`="Total IDI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="proportion_events", 
                        `title`="Events Percent", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="proportion_nonevents", 
                        `title`="Non-Events Percent", 
                        `type`="number", 
                        `format`="pc"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="validationResults",
                title="Validation Results",
                visible="(show_validation)",
                clearWith=list(
                    "cross_validation",
                    "sensitivity_analysis"),
                columns=list(
                    list(
                        `name`="validation_type", 
                        `title`="Validation Type", 
                        `type`="text"),
                    list(
                        `name`="idi_estimate", 
                        `title`="IDI Estimate", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="idi_se", 
                        `title`="Standard Error", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="bias_correction", 
                        `title`="Bias Correction", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="optimism", 
                        `title`="Optimism", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="subgroupAnalysis",
                title="Subgroup Analysis",
                visible="(stratified_analysis)",
                clearWith=list(
                    "subgroup_var",
                    "outcome",
                    "baseline_risk",
                    "new_risk"),
                columns=list(
                    list(
                        `name`="subgroup", 
                        `title`="Subgroup", 
                        `type`="text"),
                    list(
                        `name`="n_subjects", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="event_rate", 
                        `title`="Event Rate", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="idi_estimate", 
                        `title`="IDI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="idi_ci", 
                        `title`="95% CI", 
                        `type`="text"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="outlierAnalysis",
                title="Outlier Analysis",
                visible="(outlier_detection)",
                clearWith=list(
                    "outlier_detection",
                    "outlier_method"),
                columns=list(
                    list(
                        `name`="analysis_type", 
                        `title`="Analysis", 
                        `type`="text"),
                    list(
                        `name`="n_outliers_baseline", 
                        `title`="Outliers Baseline", 
                        `type`="integer"),
                    list(
                        `name`="n_outliers_new", 
                        `title`="Outliers New Model", 
                        `type`="integer"),
                    list(
                        `name`="idi_with_outliers", 
                        `title`="IDI (with outliers)", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="idi_without_outliers", 
                        `title`="IDI (without outliers)", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="outlier_influence", 
                        `title`="Outlier Influence", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="sensitivityTable",
                title="Sensitivity Analysis",
                visible="(sensitivity_analysis)",
                clearWith=list(
                    "sensitivity_analysis",
                    "followup_time"),
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"),
                    list(
                        `name`="idi_estimate", 
                        `title`="IDI Estimate", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="change_from_base", 
                        `title`="Change from Base", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="stability", 
                        `title`="Stability", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="riskDistributionsPlot",
                title="Risk Score Distributions",
                width=600,
                height=500,
                visible="(plot_risk_distributions)",
                requiresData=TRUE,
                clearWith=list(
                    "baseline_risk",
                    "new_risk",
                    "outcome")))
            self$add(jmvcore::Image$new(
                options=options,
                name="discriminationPlot",
                title="Discrimination Improvement",
                width=500,
                height=400,
                visible="(plot_discrimination)",
                requiresData=TRUE,
                clearWith=list(
                    "discrimination_slope",
                    "confidence_level")))
            self$add(jmvcore::Image$new(
                options=options,
                name="scatterPlot",
                title="Risk Score Comparison",
                width=500,
                height=400,
                visible="(plot_scatter)",
                requiresData=TRUE,
                clearWith=list(
                    "baseline_risk",
                    "new_risk",
                    "outcome")))
            self$add(jmvcore::Image$new(
                options=options,
                name="bootstrapPlot",
                title="Bootstrap Distribution",
                width=500,
                height=400,
                visible="(plot_bootstrap)",
                requiresData=TRUE,
                clearWith=list(
                    "bootstrap_samples",
                    "bootstrap_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="sensitivityPlot",
                title="Sensitivity Analysis",
                width=500,
                height=400,
                visible="(plot_sensitivity)",
                requiresData=TRUE,
                clearWith=list(
                    "sensitivity_analysis")))
            self$add(jmvcore::Image$new(
                options=options,
                name="outliersPlot",
                title="Outlier Influence Analysis",
                width=500,
                height=400,
                visible="(plot_outliers)",
                requiresData=TRUE,
                clearWith=list(
                    "outlier_detection",
                    "outlier_method")))}))

idiBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "idiBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "idi",
                version = c(0,0,31),
                options = options,
                results = idiResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Integrated Discrimination Improvement (IDI)
#'
#' Integrated Discrimination Improvement (IDI) analysis for assessing the 
#' incremental value of new biomarkers or risk factors in prediction models. 
#' IDI quantifies the improvement in model discrimination by measuring the 
#' difference in predicted probabilities between events and non-events for the 
#' new model compared to the baseline model. Unlike NRI which focuses on 
#' reclassification, IDI provides a numeric measure of discrimination 
#' improvement without requiring risk categories. The analysis includes 
#' confidence intervals through bootstrap methods, statistical significance 
#' testing, and decomposition into event and non-event components. Essential 
#' for biomarker validation, model enhancement assessment, and demonstrating 
#' clinical utility of new predictors in medical research. Particularly 
#' valuable when numeric risk improvement is more relevant than categorical 
#' reclassification, such as in precision medicine applications.
#' 
#'
#' @examples
#' result <- idi(
#'     data = mydata,
#'     outcome = "event_indicator",
#'     baseline_risk = "baseline_predictions",
#'     new_risk = "new_model_predictions",
#'     time_point = 5,
#'     bootstrap_samples = 1000
#' )
#'
#' @param data The data as a data frame.
#' @param outcome Binary outcome variable (0/1) indicating event occurrence.
#'   For time-to-event data, this should be event status at the specified time
#'   point.
#' @param baseline_risk Predicted risks or probabilities from the baseline
#'   (reference) model. Should be on probability scale (0-1) for optimal IDI
#'   interpretation.
#' @param new_risk Predicted risks or probabilities from the new (enhanced)
#'   model that includes additional predictors or biomarkers.
#' @param time_var Time to event variable for survival data analysis. Required
#'   when using time-to-event outcomes with IDI.
#' @param followup_time Time point for survival analysis (years). Events
#'   occurring after this time are censored for IDI calculation.
#' @param idi_type Type of IDI calculation. Standard uses absolute
#'   differences, relative scales by baseline discrimination, scaled normalizes
#'   by outcome prevalence, all provides comprehensive assessment.
#' @param discrimination_measure Method for calculating discrimination
#'   differences. Mean difference is standard, median is robust to outliers,
#'   trimmed mean balances both approaches, robust uses M-estimators.
#' @param trim_proportion Proportion of extreme values to trim when using
#'   trimmed mean. 0.1 trims 10\% from each tail, providing robust estimation.
#' @param confidence_level Confidence level for IDI confidence intervals and
#'   hypothesis testing. 0.95 provides 95\% confidence intervals.
#' @param bootstrap_samples Number of bootstrap samples for confidence
#'   interval estimation. More samples provide more stable estimates but
#'   increase computation time.
#' @param bootstrap_method Bootstrap confidence interval method. BCa provides
#'   bias-corrected intervals with better coverage, studentized accounts for
#'   variance changes, percentile is simple and robust.
#' @param hypothesis_test Perform hypothesis test for IDI = 0. Tests whether
#'   the new model provides significant discrimination improvement.
#' @param test_method Method for hypothesis testing. Bootstrap is recommended
#'   for most situations, asymptotic assumes normality, permutation is
#'   distribution-free, robust handles outliers.
#' @param decompose_idi Decompose IDI into contributions from events and
#'   non-events. Provides insight into which population drives the improvement.
#' @param risk_distribution Analyze and compare risk score distributions
#'   between baseline and new models for events and non-events separately.
#' @param discrimination_slope Calculate discrimination slopes (difference in
#'   means) for baseline and new models with confidence intervals.
#' @param relative_improvement Calculate relative improvement as percentage
#'   increase in discrimination over baseline model performance.
#' @param cross_validation Perform k-fold cross-validation to assess stability
#'   of IDI estimates and reduce optimism bias in model comparisons.
#' @param cv_folds Number of folds for cross-validation when enabled. 5-fold
#'   CV provides good balance of bias and variance.
#' @param sensitivity_analysis Perform sensitivity analysis by varying
#'   follow-up times and examining IDI stability across different time horizons.
#' @param outlier_detection Detect and analyze outliers in risk predictions
#'   that may disproportionately influence IDI calculations.
#' @param outlier_method Method for outlier detection. IQR is simple and
#'   robust, Z-score assumes normality, modified Z-score is more robust,
#'   isolation forest handles complex patterns.
#' @param show_summary Display comprehensive IDI summary including overall
#'   IDI, decomposed components, and statistical significance.
#' @param show_distributions Display risk distribution summaries for baseline
#'   and new models separately for events and non-events.
#' @param show_discrimination Display discrimination slopes and related
#'   measures for both baseline and new models with improvements.
#' @param show_validation Display cross-validation and sensitivity analysis
#'   results when these options are enabled.
#' @param plot_risk_distributions Create plots showing risk score
#'   distributions for baseline and new models separated by outcome status.
#' @param plot_discrimination Visualize discrimination improvement showing
#'   mean differences and IDI components with confidence intervals.
#' @param plot_scatter Create scatter plot of baseline vs new model risk
#'   scores colored by outcome status to visualize improvement patterns.
#' @param plot_bootstrap Plot bootstrap distribution of IDI estimates showing
#'   sampling variability and confidence interval construction.
#' @param plot_sensitivity Create plots showing IDI variation across different
#'   analysis parameters and time points.
#' @param plot_outliers Visualize detected outliers and their influence on IDI
#'   calculations with and without outliers.
#' @param competing_risks Account for competing risks in survival analysis.
#'   Modifies IDI calculation for settings with multiple event types.
#' @param stratified_analysis Perform stratified IDI analysis by important
#'   subgroups to assess consistency of improvement across populations.
#' @param subgroup_var Variable defining subgroups for stratified analysis.
#'   Each level will receive separate IDI calculation.
#' @param missing_handling Method for handling missing data in risk
#'   predictions. Multiple imputation provides most robust results.
#' @param calibration_aware Adjust IDI calculation to account for model
#'   calibration. Uses calibrated probabilities for more accurate assessment.
#' @param time_dependent Calculate time-dependent IDI for survival models
#'   showing how discrimination improvement varies over time.
#' @param alpha_level Type I error rate for hypothesis testing and confidence
#'   intervals. Standard value is 0.05 for 95\% confidence.
#' @param random_seed Random seed for bootstrap sampling and cross-validation.
#'   Ensures reproducible results across analyses.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$distributionSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$discriminationAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$decomposition} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$validationResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$subgroupAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$outlierAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$sensitivityTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$riskDistributionsPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$discriminationPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$scatterPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$bootstrapPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$sensitivityPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$outliersPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summary$asDF}
#'
#' \code{as.data.frame(results$summary)}
#'
#' @export
idi <- function(
    data,
    outcome,
    baseline_risk,
    new_risk,
    time_var,
    followup_time = 5,
    idi_type = "standard",
    discrimination_measure = "mean_diff",
    trim_proportion = 0.1,
    confidence_level = 0.95,
    bootstrap_samples = 1000,
    bootstrap_method = "bca",
    hypothesis_test = TRUE,
    test_method = "bootstrap",
    decompose_idi = TRUE,
    risk_distribution = TRUE,
    discrimination_slope = TRUE,
    relative_improvement = TRUE,
    cross_validation = FALSE,
    cv_folds = 5,
    sensitivity_analysis = FALSE,
    outlier_detection = FALSE,
    outlier_method = "iqr",
    show_summary = TRUE,
    show_distributions = TRUE,
    show_discrimination = TRUE,
    show_validation = FALSE,
    plot_risk_distributions = TRUE,
    plot_discrimination = TRUE,
    plot_scatter = TRUE,
    plot_bootstrap = FALSE,
    plot_sensitivity = FALSE,
    plot_outliers = FALSE,
    competing_risks = FALSE,
    stratified_analysis = FALSE,
    subgroup_var,
    missing_handling = "complete",
    calibration_aware = FALSE,
    time_dependent = FALSE,
    alpha_level = 0.05,
    random_seed = 123) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("idi requires jmvcore to be installed (restart may be required)")

    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(baseline_risk)) baseline_risk <- jmvcore::resolveQuo(jmvcore::enquo(baseline_risk))
    if ( ! missing(new_risk)) new_risk <- jmvcore::resolveQuo(jmvcore::enquo(new_risk))
    if ( ! missing(time_var)) time_var <- jmvcore::resolveQuo(jmvcore::enquo(time_var))
    if ( ! missing(subgroup_var)) subgroup_var <- jmvcore::resolveQuo(jmvcore::enquo(subgroup_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(baseline_risk), baseline_risk, NULL),
            `if`( ! missing(new_risk), new_risk, NULL),
            `if`( ! missing(time_var), time_var, NULL),
            `if`( ! missing(subgroup_var), subgroup_var, NULL))

    for (v in subgroup_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- idiOptions$new(
        outcome = outcome,
        baseline_risk = baseline_risk,
        new_risk = new_risk,
        time_var = time_var,
        followup_time = followup_time,
        idi_type = idi_type,
        discrimination_measure = discrimination_measure,
        trim_proportion = trim_proportion,
        confidence_level = confidence_level,
        bootstrap_samples = bootstrap_samples,
        bootstrap_method = bootstrap_method,
        hypothesis_test = hypothesis_test,
        test_method = test_method,
        decompose_idi = decompose_idi,
        risk_distribution = risk_distribution,
        discrimination_slope = discrimination_slope,
        relative_improvement = relative_improvement,
        cross_validation = cross_validation,
        cv_folds = cv_folds,
        sensitivity_analysis = sensitivity_analysis,
        outlier_detection = outlier_detection,
        outlier_method = outlier_method,
        show_summary = show_summary,
        show_distributions = show_distributions,
        show_discrimination = show_discrimination,
        show_validation = show_validation,
        plot_risk_distributions = plot_risk_distributions,
        plot_discrimination = plot_discrimination,
        plot_scatter = plot_scatter,
        plot_bootstrap = plot_bootstrap,
        plot_sensitivity = plot_sensitivity,
        plot_outliers = plot_outliers,
        competing_risks = competing_risks,
        stratified_analysis = stratified_analysis,
        subgroup_var = subgroup_var,
        missing_handling = missing_handling,
        calibration_aware = calibration_aware,
        time_dependent = time_dependent,
        alpha_level = alpha_level,
        random_seed = random_seed)

    analysis <- idiClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

