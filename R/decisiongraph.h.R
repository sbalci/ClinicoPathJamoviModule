
# This file is automatically generated, you probably don't want to edit this

decisiongraphOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "decisiongraphOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            treeType = "costeffectiveness",
            decisions = NULL,
            healthStates = NULL,
            transitionProbs = NULL,
            cycleLength = 1,
            probabilities = NULL,
            costs = NULL,
            utilities = NULL,
            outcomes = NULL,
            layout = "horizontal",
            nodeShapes = TRUE,
            showProbabilities = TRUE,
            showCosts = TRUE,
            showUtilities = TRUE,
            calculateExpectedValues = TRUE,
            sensitivityAnalysis = FALSE,
            discountRate = 0.03,
            timeHorizon = 10,
            nodeLabels = TRUE,
            branchLabels = TRUE,
            colorScheme = "medical",
            summaryTable = TRUE,
            tornado = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="decisiongraph",
                requiresData=TRUE,
                ...)

            private$..treeType <- jmvcore::OptionList$new(
                "treeType",
                treeType,
                options=list(
                    "simple",
                    "markov",
                    "costeffectiveness"),
                default="costeffectiveness")
            private$..decisions <- jmvcore::OptionVariables$new(
                "decisions",
                decisions,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..healthStates <- jmvcore::OptionVariables$new(
                "healthStates",
                healthStates,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..transitionProbs <- jmvcore::OptionVariables$new(
                "transitionProbs",
                transitionProbs,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..cycleLength <- jmvcore::OptionNumber$new(
                "cycleLength",
                cycleLength,
                default=1,
                min=0.1,
                max=10)
            private$..probabilities <- jmvcore::OptionVariables$new(
                "probabilities",
                probabilities,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..costs <- jmvcore::OptionVariables$new(
                "costs",
                costs,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..utilities <- jmvcore::OptionVariables$new(
                "utilities",
                utilities,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcomes <- jmvcore::OptionVariables$new(
                "outcomes",
                outcomes,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..layout <- jmvcore::OptionList$new(
                "layout",
                layout,
                options=list(
                    "horizontal",
                    "vertical",
                    "radial"),
                default="horizontal")
            private$..nodeShapes <- jmvcore::OptionBool$new(
                "nodeShapes",
                nodeShapes,
                default=TRUE)
            private$..showProbabilities <- jmvcore::OptionBool$new(
                "showProbabilities",
                showProbabilities,
                default=TRUE)
            private$..showCosts <- jmvcore::OptionBool$new(
                "showCosts",
                showCosts,
                default=TRUE)
            private$..showUtilities <- jmvcore::OptionBool$new(
                "showUtilities",
                showUtilities,
                default=TRUE)
            private$..calculateExpectedValues <- jmvcore::OptionBool$new(
                "calculateExpectedValues",
                calculateExpectedValues,
                default=TRUE)
            private$..sensitivityAnalysis <- jmvcore::OptionBool$new(
                "sensitivityAnalysis",
                sensitivityAnalysis,
                default=FALSE)
            private$..discountRate <- jmvcore::OptionNumber$new(
                "discountRate",
                discountRate,
                default=0.03,
                min=0,
                max=0.2)
            private$..timeHorizon <- jmvcore::OptionNumber$new(
                "timeHorizon",
                timeHorizon,
                default=10,
                min=1,
                max=100)
            private$..nodeLabels <- jmvcore::OptionBool$new(
                "nodeLabels",
                nodeLabels,
                default=TRUE)
            private$..branchLabels <- jmvcore::OptionBool$new(
                "branchLabels",
                branchLabels,
                default=TRUE)
            private$..colorScheme <- jmvcore::OptionList$new(
                "colorScheme",
                colorScheme,
                options=list(
                    "default",
                    "colorblind",
                    "medical",
                    "economic"),
                default="medical")
            private$..summaryTable <- jmvcore::OptionBool$new(
                "summaryTable",
                summaryTable,
                default=TRUE)
            private$..tornado <- jmvcore::OptionBool$new(
                "tornado",
                tornado,
                default=FALSE)

            self$.addOption(private$..treeType)
            self$.addOption(private$..decisions)
            self$.addOption(private$..healthStates)
            self$.addOption(private$..transitionProbs)
            self$.addOption(private$..cycleLength)
            self$.addOption(private$..probabilities)
            self$.addOption(private$..costs)
            self$.addOption(private$..utilities)
            self$.addOption(private$..outcomes)
            self$.addOption(private$..layout)
            self$.addOption(private$..nodeShapes)
            self$.addOption(private$..showProbabilities)
            self$.addOption(private$..showCosts)
            self$.addOption(private$..showUtilities)
            self$.addOption(private$..calculateExpectedValues)
            self$.addOption(private$..sensitivityAnalysis)
            self$.addOption(private$..discountRate)
            self$.addOption(private$..timeHorizon)
            self$.addOption(private$..nodeLabels)
            self$.addOption(private$..branchLabels)
            self$.addOption(private$..colorScheme)
            self$.addOption(private$..summaryTable)
            self$.addOption(private$..tornado)
        }),
    active = list(
        treeType = function() private$..treeType$value,
        decisions = function() private$..decisions$value,
        healthStates = function() private$..healthStates$value,
        transitionProbs = function() private$..transitionProbs$value,
        cycleLength = function() private$..cycleLength$value,
        probabilities = function() private$..probabilities$value,
        costs = function() private$..costs$value,
        utilities = function() private$..utilities$value,
        outcomes = function() private$..outcomes$value,
        layout = function() private$..layout$value,
        nodeShapes = function() private$..nodeShapes$value,
        showProbabilities = function() private$..showProbabilities$value,
        showCosts = function() private$..showCosts$value,
        showUtilities = function() private$..showUtilities$value,
        calculateExpectedValues = function() private$..calculateExpectedValues$value,
        sensitivityAnalysis = function() private$..sensitivityAnalysis$value,
        discountRate = function() private$..discountRate$value,
        timeHorizon = function() private$..timeHorizon$value,
        nodeLabels = function() private$..nodeLabels$value,
        branchLabels = function() private$..branchLabels$value,
        colorScheme = function() private$..colorScheme$value,
        summaryTable = function() private$..summaryTable$value,
        tornado = function() private$..tornado$value),
    private = list(
        ..treeType = NA,
        ..decisions = NA,
        ..healthStates = NA,
        ..transitionProbs = NA,
        ..cycleLength = NA,
        ..probabilities = NA,
        ..costs = NA,
        ..utilities = NA,
        ..outcomes = NA,
        ..layout = NA,
        ..nodeShapes = NA,
        ..showProbabilities = NA,
        ..showCosts = NA,
        ..showUtilities = NA,
        ..calculateExpectedValues = NA,
        ..sensitivityAnalysis = NA,
        ..discountRate = NA,
        ..timeHorizon = NA,
        ..nodeLabels = NA,
        ..branchLabels = NA,
        ..colorScheme = NA,
        ..summaryTable = NA,
        ..tornado = NA)
)

decisiongraphResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "decisiongraphResults",
    inherit = jmvcore::Group,
    active = list(
        treeplot = function() private$.items[["treeplot"]],
        summaryTable = function() private$.items[["summaryTable"]],
        nodeTable = function() private$.items[["nodeTable"]],
        tornadoplot = function() private$.items[["tornadoplot"]],
        sensitivityTable = function() private$.items[["sensitivityTable"]],
        text1 = function() private$.items[["text1"]],
        text2 = function() private$.items[["text2"]],
        markovTable = function() private$.items[["markovTable"]],
        markovCohortTable = function() private$.items[["markovCohortTable"]],
        markovPlot = function() private$.items[["markovPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Decision Tree Graph")
            self$add(jmvcore::Image$new(
                options=options,
                name="treeplot",
                title="Decision Tree",
                width=700,
                height=500,
                renderFun=".treeplot"))
            self$add(jmvcore::Table$new(
                options=options,
                name="summaryTable",
                title="Expected Values Summary",
                visible="(summaryTable)",
                rows=0,
                columns=list(
                    list(
                        `name`="strategy", 
                        `title`="Strategy", 
                        `type`="text"),
                    list(
                        `name`="expectedCost", 
                        `title`="Expected Cost", 
                        `type`="number", 
                        `format`="currency"),
                    list(
                        `name`="expectedUtility", 
                        `title`="Expected Utility", 
                        `type`="number", 
                        `format`="zto3"),
                    list(
                        `name`="icer", 
                        `title`="ICER", 
                        `type`="number", 
                        `format`="currency"),
                    list(
                        `name`="netBenefit", 
                        `title`="Net Benefit", 
                        `type`="number", 
                        `format`="currency"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="nodeTable",
                title="Node Details",
                rows=0,
                columns=list(
                    list(
                        `name`="nodeId", 
                        `title`="Node ID", 
                        `type`="text"),
                    list(
                        `name`="nodeType", 
                        `title`="Type", 
                        `type`="text"),
                    list(
                        `name`="nodeLabel", 
                        `title`="Label", 
                        `type`="text"),
                    list(
                        `name`="probability", 
                        `title`="Probability", 
                        `type`="number", 
                        `format`="zto3"),
                    list(
                        `name`="cost", 
                        `title`="Cost", 
                        `type`="number", 
                        `format`="currency"),
                    list(
                        `name`="utility", 
                        `title`="Utility", 
                        `type`="number", 
                        `format`="zto3"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="tornadoplot",
                title="Tornado Diagram",
                width=600,
                height=400,
                renderFun=".tornadoplot",
                visible="(tornado)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="sensitivityTable",
                title="Sensitivity Analysis",
                visible="(sensitivityAnalysis)",
                rows=0,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="baseValue", 
                        `title`="Base Value", 
                        `type`="number", 
                        `format`="zto3"),
                    list(
                        `name`="lowValue", 
                        `title`="Low Value", 
                        `type`="number", 
                        `format`="zto3"),
                    list(
                        `name`="highValue", 
                        `title`="High Value", 
                        `type`="number", 
                        `format`="zto3"),
                    list(
                        `name`="lowResult", 
                        `title`="Low Result", 
                        `type`="number", 
                        `format`="currency"),
                    list(
                        `name`="highResult", 
                        `title`="High Result", 
                        `type`="number", 
                        `format`="currency"),
                    list(
                        `name`="range", 
                        `title`="Range", 
                        `type`="number", 
                        `format`="currency"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="text1",
                title="Tree Structure",
                visible=FALSE))
            self$add(jmvcore::Html$new(
                options=options,
                name="text2",
                title="Calculations",
                visible=FALSE))
            self$add(jmvcore::Table$new(
                options=options,
                name="markovTable",
                title="Markov Transition Matrix",
                visible="(treeType:markov)",
                rows=0,
                columns=list(
                    list(
                        `name`="fromState", 
                        `title`="From State", 
                        `type`="text"),
                    list(
                        `name`="toState", 
                        `title`="To State", 
                        `type`="text"),
                    list(
                        `name`="transitionProb", 
                        `title`="Transition Probability", 
                        `type`="number", 
                        `format`="zto3"),
                    list(
                        `name`="annualCost", 
                        `title`="Annual Cost", 
                        `type`="number", 
                        `format`="currency"),
                    list(
                        `name`="annualUtility", 
                        `title`="Annual Utility", 
                        `type`="number", 
                        `format`="zto3"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="markovCohortTable",
                title="Markov Cohort Analysis",
                visible="(treeType:markov)",
                rows=0,
                columns=list(
                    list(
                        `name`="cycle", 
                        `title`="Cycle", 
                        `type`="integer"),
                    list(
                        `name`="healthyProp", 
                        `title`="Healthy %", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="sickProp", 
                        `title`="Sick %", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="deadProp", 
                        `title`="Dead %", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="cumulativeCost", 
                        `title`="Cumulative Cost", 
                        `type`="number", 
                        `format`="currency"),
                    list(
                        `name`="cumulativeUtility", 
                        `title`="Cumulative Utility", 
                        `type`="number", 
                        `format`="zto3"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="markovPlot",
                title="Markov State Transitions",
                width=600,
                height=400,
                renderFun=".markovPlot",
                visible="(treeType:markov)"))}))

decisiongraphBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "decisiongraphBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "decisiongraph",
                version = c(0,0,3),
                options = options,
                results = decisiongraphResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Decision Tree Graph
#'
#' Creates decision tree graphs for cost-effectiveness analysis with typical 
#' decision nodes, chance nodes, and terminal nodes. Supports visualization of 
#' treatment pathways, probabilities, costs, and outcomes.
#' 
#'
#' @examples
#' \donttest{
#' # example will be added
#'}
#' @param data The data as a data frame containing decision tree parameters.
#' @param treeType Type of decision tree to create.
#' @param decisions Variables representing decision nodes (treatment options).
#' @param healthStates Variables defining health states for Markov model.
#' @param transitionProbs Variables containing transition probabilities
#'   between health states.
#' @param cycleLength Length of each Markov cycle in years.
#' @param probabilities Variables containing probability values for chance
#'   nodes.
#' @param costs Variables containing cost values for terminal nodes.
#' @param utilities Variables containing utility/effectiveness values.
#' @param outcomes Variables representing clinical outcomes.
#' @param layout Layout orientation for the decision tree.
#' @param nodeShapes Use different shapes for different node types.
#' @param showProbabilities Display probability values on tree branches.
#' @param showCosts Display cost values at terminal nodes.
#' @param showUtilities Display utility/effectiveness values.
#' @param calculateExpectedValues Calculate and display expected costs and
#'   utilities.
#' @param sensitivityAnalysis Perform one-way sensitivity analysis on key
#'   parameters.
#' @param discountRate Annual discount rate for future costs and benefits.
#' @param timeHorizon Time horizon for the analysis in years.
#' @param nodeLabels Display descriptive labels for nodes.
#' @param branchLabels Display labels on tree branches.
#' @param colorScheme Color scheme for the decision tree visualization.
#' @param summaryTable Show summary table with expected values and
#'   cost-effectiveness ratios.
#' @param tornado Create tornado diagram for sensitivity analysis.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$treeplot} \tab \tab \tab \tab \tab Decision tree visualization with nodes and branches \cr
#'   \code{results$summaryTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$nodeTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$tornadoplot} \tab \tab \tab \tab \tab Sensitivity analysis tornado diagram \cr
#'   \code{results$sensitivityTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$text1} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$text2} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$markovTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$markovCohortTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$markovPlot} \tab \tab \tab \tab \tab Markov state transition diagram \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summaryTable$asDF}
#'
#' \code{as.data.frame(results$summaryTable)}
#'
#' @export
decisiongraph <- function(
    data,
    treeType = "costeffectiveness",
    decisions,
    healthStates,
    transitionProbs,
    cycleLength = 1,
    probabilities,
    costs,
    utilities,
    outcomes,
    layout = "horizontal",
    nodeShapes = TRUE,
    showProbabilities = TRUE,
    showCosts = TRUE,
    showUtilities = TRUE,
    calculateExpectedValues = TRUE,
    sensitivityAnalysis = FALSE,
    discountRate = 0.03,
    timeHorizon = 10,
    nodeLabels = TRUE,
    branchLabels = TRUE,
    colorScheme = "medical",
    summaryTable = TRUE,
    tornado = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("decisiongraph requires jmvcore to be installed (restart may be required)")

    if ( ! missing(decisions)) decisions <- jmvcore::resolveQuo(jmvcore::enquo(decisions))
    if ( ! missing(healthStates)) healthStates <- jmvcore::resolveQuo(jmvcore::enquo(healthStates))
    if ( ! missing(transitionProbs)) transitionProbs <- jmvcore::resolveQuo(jmvcore::enquo(transitionProbs))
    if ( ! missing(probabilities)) probabilities <- jmvcore::resolveQuo(jmvcore::enquo(probabilities))
    if ( ! missing(costs)) costs <- jmvcore::resolveQuo(jmvcore::enquo(costs))
    if ( ! missing(utilities)) utilities <- jmvcore::resolveQuo(jmvcore::enquo(utilities))
    if ( ! missing(outcomes)) outcomes <- jmvcore::resolveQuo(jmvcore::enquo(outcomes))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(decisions), decisions, NULL),
            `if`( ! missing(healthStates), healthStates, NULL),
            `if`( ! missing(transitionProbs), transitionProbs, NULL),
            `if`( ! missing(probabilities), probabilities, NULL),
            `if`( ! missing(costs), costs, NULL),
            `if`( ! missing(utilities), utilities, NULL),
            `if`( ! missing(outcomes), outcomes, NULL))

    for (v in decisions) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in healthStates) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in outcomes) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- decisiongraphOptions$new(
        treeType = treeType,
        decisions = decisions,
        healthStates = healthStates,
        transitionProbs = transitionProbs,
        cycleLength = cycleLength,
        probabilities = probabilities,
        costs = costs,
        utilities = utilities,
        outcomes = outcomes,
        layout = layout,
        nodeShapes = nodeShapes,
        showProbabilities = showProbabilities,
        showCosts = showCosts,
        showUtilities = showUtilities,
        calculateExpectedValues = calculateExpectedValues,
        sensitivityAnalysis = sensitivityAnalysis,
        discountRate = discountRate,
        timeHorizon = timeHorizon,
        nodeLabels = nodeLabels,
        branchLabels = branchLabels,
        colorScheme = colorScheme,
        summaryTable = summaryTable,
        tornado = tornado)

    analysis <- decisiongraphClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

