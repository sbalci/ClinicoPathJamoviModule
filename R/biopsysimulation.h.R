
# This file is automatically generated, you probably don't want to edit this

biopsysimulationOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "biopsysimulationOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            wholesection = NULL,
            biopsy1 = NULL,
            biopsy2 = NULL,
            biopsy3 = NULL,
            biopsy4 = NULL,
            biopsies = NULL,
            spatial_id = NULL,
            analysis_type = "comprehensive",
            sampling_strategy = "unknown",
            cv_threshold = 20,
            correlation_threshold = 0.8,
            show_variability_plots = TRUE,
            variance_components = TRUE,
            power_analysis = FALSE,
            generate_recommendations = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="biopsysimulation",
                requiresData=TRUE,
                ...)

            private$..wholesection <- jmvcore::OptionVariable$new(
                "wholesection",
                wholesection,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..biopsy1 <- jmvcore::OptionVariable$new(
                "biopsy1",
                biopsy1,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..biopsy2 <- jmvcore::OptionVariable$new(
                "biopsy2",
                biopsy2,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..biopsy3 <- jmvcore::OptionVariable$new(
                "biopsy3",
                biopsy3,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..biopsy4 <- jmvcore::OptionVariable$new(
                "biopsy4",
                biopsy4,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..biopsies <- jmvcore::OptionVariables$new(
                "biopsies",
                biopsies,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..spatial_id <- jmvcore::OptionVariable$new(
                "spatial_id",
                spatial_id,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..analysis_type <- jmvcore::OptionList$new(
                "analysis_type",
                analysis_type,
                options=list(
                    "reproducibility",
                    "bias",
                    "variability",
                    "comprehensive"),
                default="comprehensive")
            private$..sampling_strategy <- jmvcore::OptionList$new(
                "sampling_strategy",
                sampling_strategy,
                options=list(
                    "random",
                    "systematic",
                    "stratified",
                    "unknown"),
                default="unknown")
            private$..cv_threshold <- jmvcore::OptionNumber$new(
                "cv_threshold",
                cv_threshold,
                min=5,
                max=50,
                default=20)
            private$..correlation_threshold <- jmvcore::OptionNumber$new(
                "correlation_threshold",
                correlation_threshold,
                min=0.5,
                max=0.99,
                default=0.8)
            private$..show_variability_plots <- jmvcore::OptionBool$new(
                "show_variability_plots",
                show_variability_plots,
                default=TRUE)
            private$..variance_components <- jmvcore::OptionBool$new(
                "variance_components",
                variance_components,
                default=TRUE)
            private$..power_analysis <- jmvcore::OptionBool$new(
                "power_analysis",
                power_analysis,
                default=FALSE)
            private$..generate_recommendations <- jmvcore::OptionBool$new(
                "generate_recommendations",
                generate_recommendations,
                default=TRUE)

            self$.addOption(private$..wholesection)
            self$.addOption(private$..biopsy1)
            self$.addOption(private$..biopsy2)
            self$.addOption(private$..biopsy3)
            self$.addOption(private$..biopsy4)
            self$.addOption(private$..biopsies)
            self$.addOption(private$..spatial_id)
            self$.addOption(private$..analysis_type)
            self$.addOption(private$..sampling_strategy)
            self$.addOption(private$..cv_threshold)
            self$.addOption(private$..correlation_threshold)
            self$.addOption(private$..show_variability_plots)
            self$.addOption(private$..variance_components)
            self$.addOption(private$..power_analysis)
            self$.addOption(private$..generate_recommendations)
        }),
    active = list(
        wholesection = function() private$..wholesection$value,
        biopsy1 = function() private$..biopsy1$value,
        biopsy2 = function() private$..biopsy2$value,
        biopsy3 = function() private$..biopsy3$value,
        biopsy4 = function() private$..biopsy4$value,
        biopsies = function() private$..biopsies$value,
        spatial_id = function() private$..spatial_id$value,
        analysis_type = function() private$..analysis_type$value,
        sampling_strategy = function() private$..sampling_strategy$value,
        cv_threshold = function() private$..cv_threshold$value,
        correlation_threshold = function() private$..correlation_threshold$value,
        show_variability_plots = function() private$..show_variability_plots$value,
        variance_components = function() private$..variance_components$value,
        power_analysis = function() private$..power_analysis$value,
        generate_recommendations = function() private$..generate_recommendations$value),
    private = list(
        ..wholesection = NA,
        ..biopsy1 = NA,
        ..biopsy2 = NA,
        ..biopsy3 = NA,
        ..biopsy4 = NA,
        ..biopsies = NA,
        ..spatial_id = NA,
        ..analysis_type = NA,
        ..sampling_strategy = NA,
        ..cv_threshold = NA,
        ..correlation_threshold = NA,
        ..show_variability_plots = NA,
        ..variance_components = NA,
        ..power_analysis = NA,
        ..generate_recommendations = NA)
)

biopsysimulationResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "biopsysimulationResults",
    inherit = jmvcore::Group,
    active = list(
        interpretation = function() private$.items[["interpretation"]],
        report_sentences = function() private$.items[["report_sentences"]],
        assumptions = function() private$.items[["assumptions"]],
        reproducibilitytable = function() private$.items[["reproducibilitytable"]],
        samplingbiastable = function() private$.items[["samplingbiastable"]],
        variancetable = function() private$.items[["variancetable"]],
        poweranalysistable = function() private$.items[["poweranalysistable"]],
        spatialanalysistable = function() private$.items[["spatialanalysistable"]],
        biopsyplot = function() private$.items[["biopsyplot"]],
        variabilityplot = function() private$.items[["variabilityplot"]],
        spatialplot = function() private$.items[["spatialplot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Biopsy Simulation Analysis",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation and Analysis Summary",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="report_sentences",
                title="Copy-Ready Report Sentences",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="assumptions",
                title="Methodology & Assumptions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="reproducibilitytable",
                title="Reproducibility Assessment",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Reproducibility Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="interpretation", 
                        `title`="Clinical Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="samplingbiastable",
                title="Sampling Bias Analysis",
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="mean_diff", 
                        `title`="Mean Difference", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="p_value", 
                        `title`="P-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="effect_size", 
                        `title`="Effect Size (Cohen's d)", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="clinical_impact", 
                        `title`="Clinical Impact", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="variancetable",
                title="Variance Component Analysis",
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Variance Component", 
                        `type`="text"),
                    list(
                        `name`="variance", 
                        `title`="Variance", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="percentage", 
                        `title`="Percentage (%)", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="contribution", 
                        `title`="Contribution to Total Variance", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="poweranalysistable",
                title="Power Analysis Results",
                visible="(power_analysis)",
                columns=list(
                    list(
                        `name`="scenario", 
                        `title`="Analysis Scenario", 
                        `type`="text"),
                    list(
                        `name`="effect_size", 
                        `title`="Expected Effect Size", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="power", 
                        `title`="Statistical Power", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="required_n", 
                        `title`="Required Sample Size", 
                        `type`="integer"),
                    list(
                        `name`="recommendation", 
                        `title`="Recommendation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="spatialanalysistable",
                title="Spatial Heterogeneity Analysis",
                visible="(spatial_id)",
                columns=list(
                    list(
                        `name`="region", 
                        `title`="Spatial Region", 
                        `type`="text"),
                    list(
                        `name`="n_cases", 
                        `title`="Cases", 
                        `type`="integer"),
                    list(
                        `name`="mean_value", 
                        `title`="Mean Value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cv_percent", 
                        `title`="CV (%)", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="heterogeneity_level", 
                        `title`="Heterogeneity Level", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="biopsyplot",
                title="Biopsy vs Whole Section Comparison",
                width=700,
                height=500,
                visible="(show_variability_plots)",
                renderFun=".biopsyplot"))
            self$add(jmvcore::Image$new(
                options=options,
                name="variabilityplot",
                title="Sampling Variability Analysis",
                width=600,
                height=400,
                visible="(show_variability_plots)",
                renderFun=".variabilityplot"))
            self$add(jmvcore::Image$new(
                options=options,
                name="spatialplot",
                title="Spatial Heterogeneity Visualization",
                width=600,
                height=400,
                visible="(show_variability_plots)",
                renderFun=".spatialplot"))}))

biopsysimulationBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "biopsysimulationBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "biopsysimulation",
                version = c(1,0,0),
                options = options,
                results = biopsysimulationResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Biopsy Simulation Analysis
#'
#' 
#' @param data the data as a data frame
#' @param wholesection Biomarker measurement from entire tissue section.
#'   Example: Ki67 proliferation index (0-100\%), ER/PR expression (0-8 Allred
#'   score), HER2 expression (0-3+ intensity), or quantitative molecular
#'   biomarker values.
#' @param biopsy1 Biomarker measurement from first simulated core biopsy
#'   sample. Should represent same biomarker as whole section measurement.
#'   Example: Ki67 \% from 2mm core biopsy #1.
#' @param biopsy2 second simulated biopsy measurement
#' @param biopsy3 third simulated biopsy measurement
#' @param biopsy4 fourth simulated biopsy measurement
#' @param biopsies additional simulated biopsy measurements
#' @param spatial_id identifier for spatial regions or tissue areas
#' @param analysis_type primary focus of biopsy simulation analysis
#' @param sampling_strategy biopsy sampling strategy used
#' @param cv_threshold Coefficient of variation threshold for acceptable
#'   sampling variability. Typical clinical values: 15-25\% for
#'   immunohistochemistry (Ki67, ER, PR), 10-20\% for molecular assays, 20-30\%
#'   for heterogeneous markers (HER2, PD-L1). Lower values indicate more
#'   stringent quality requirements.
#' @param correlation_threshold Minimum Spearman correlation between biopsy
#'   and whole section measurements. Clinical guidelines: ≥0.80 excellent
#'   agreement, ≥0.70 good agreement, ≥0.60 moderate agreement, <0.60 poor
#'   agreement. Higher values indicate better representativeness of biopsy
#'   samples.
#' @param show_variability_plots display plots showing sampling variability
#' @param variance_components perform variance component decomposition
#' @param power_analysis perform power analysis for sample size
#'   recommendations
#' @param generate_recommendations provide recommendations for optimal
#'   sampling strategy
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$report_sentences} \tab \tab \tab \tab \tab Pre-formatted sentences ready for clinical reports and publications \cr
#'   \code{results$assumptions} \tab \tab \tab \tab \tab Analysis assumptions, data requirements, and methodological considerations \cr
#'   \code{results$reproducibilitytable} \tab \tab \tab \tab \tab Correlation and reliability metrics \cr
#'   \code{results$samplingbiastable} \tab \tab \tab \tab \tab Systematic bias assessment between methods \cr
#'   \code{results$variancetable} \tab \tab \tab \tab \tab Sources of measurement variability \cr
#'   \code{results$poweranalysistable} \tab \tab \tab \tab \tab Sample size recommendations and power calculations \cr
#'   \code{results$spatialanalysistable} \tab \tab \tab \tab \tab Variability across spatial regions \cr
#'   \code{results$biopsyplot} \tab \tab \tab \tab \tab Distribution comparison across methods \cr
#'   \code{results$variabilityplot} \tab \tab \tab \tab \tab Coefficient of variation by case \cr
#'   \code{results$spatialplot} \tab \tab \tab \tab \tab Spatial distribution of biomarker values \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$reproducibilitytable$asDF}
#'
#' \code{as.data.frame(results$reproducibilitytable)}
#'
#' @export
biopsysimulation <- function(
    data,
    wholesection,
    biopsy1,
    biopsy2,
    biopsy3,
    biopsy4,
    biopsies,
    spatial_id,
    analysis_type = "comprehensive",
    sampling_strategy = "unknown",
    cv_threshold = 20,
    correlation_threshold = 0.8,
    show_variability_plots = TRUE,
    variance_components = TRUE,
    power_analysis = FALSE,
    generate_recommendations = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("biopsysimulation requires jmvcore to be installed (restart may be required)")

    if ( ! missing(wholesection)) wholesection <- jmvcore::resolveQuo(jmvcore::enquo(wholesection))
    if ( ! missing(biopsy1)) biopsy1 <- jmvcore::resolveQuo(jmvcore::enquo(biopsy1))
    if ( ! missing(biopsy2)) biopsy2 <- jmvcore::resolveQuo(jmvcore::enquo(biopsy2))
    if ( ! missing(biopsy3)) biopsy3 <- jmvcore::resolveQuo(jmvcore::enquo(biopsy3))
    if ( ! missing(biopsy4)) biopsy4 <- jmvcore::resolveQuo(jmvcore::enquo(biopsy4))
    if ( ! missing(biopsies)) biopsies <- jmvcore::resolveQuo(jmvcore::enquo(biopsies))
    if ( ! missing(spatial_id)) spatial_id <- jmvcore::resolveQuo(jmvcore::enquo(spatial_id))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(wholesection), wholesection, NULL),
            `if`( ! missing(biopsy1), biopsy1, NULL),
            `if`( ! missing(biopsy2), biopsy2, NULL),
            `if`( ! missing(biopsy3), biopsy3, NULL),
            `if`( ! missing(biopsy4), biopsy4, NULL),
            `if`( ! missing(biopsies), biopsies, NULL),
            `if`( ! missing(spatial_id), spatial_id, NULL))

    for (v in spatial_id) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- biopsysimulationOptions$new(
        wholesection = wholesection,
        biopsy1 = biopsy1,
        biopsy2 = biopsy2,
        biopsy3 = biopsy3,
        biopsy4 = biopsy4,
        biopsies = biopsies,
        spatial_id = spatial_id,
        analysis_type = analysis_type,
        sampling_strategy = sampling_strategy,
        cv_threshold = cv_threshold,
        correlation_threshold = correlation_threshold,
        show_variability_plots = show_variability_plots,
        variance_components = variance_components,
        power_analysis = power_analysis,
        generate_recommendations = generate_recommendations)

    analysis <- biopsysimulationClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

