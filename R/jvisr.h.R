
# This file is automatically generated, you probably don't want to edit this

jvisrOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jvisrOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            analysis_type = "kaplan_meier",
            time_var = NULL,
            event_var = NULL,
            strata_var = NULL,
            cdisc_format = FALSE,
            aval_var = NULL,
            cnsr_var = NULL,
            fun_type = "surv",
            confidence_interval = TRUE,
            risk_table = TRUE,
            quantiles = FALSE,
            p_value = TRUE,
            legend_position = "right",
            time_label = "Time",
            time_units = "",
            survival_label = "",
            title = "",
            theme_style = "visr",
            color_palette = "default",
            show_summary = TRUE,
            show_interpretation = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="jvisr",
                requiresData=TRUE,
                ...)

            private$..analysis_type <- jmvcore::OptionList$new(
                "analysis_type",
                analysis_type,
                options=list(
                    "kaplan_meier",
                    "cuminc",
                    "tableone",
                    "attrition",
                    "risktable"),
                default="kaplan_meier")
            private$..time_var <- jmvcore::OptionVariable$new(
                "time_var",
                time_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event_var <- jmvcore::OptionVariable$new(
                "event_var",
                event_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..strata_var <- jmvcore::OptionVariable$new(
                "strata_var",
                strata_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..cdisc_format <- jmvcore::OptionBool$new(
                "cdisc_format",
                cdisc_format,
                default=FALSE)
            private$..aval_var <- jmvcore::OptionVariable$new(
                "aval_var",
                aval_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..cnsr_var <- jmvcore::OptionVariable$new(
                "cnsr_var",
                cnsr_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..fun_type <- jmvcore::OptionList$new(
                "fun_type",
                fun_type,
                options=list(
                    "surv",
                    "event",
                    "cumhaz",
                    "cloglog",
                    "pct",
                    "log"),
                default="surv")
            private$..confidence_interval <- jmvcore::OptionBool$new(
                "confidence_interval",
                confidence_interval,
                default=TRUE)
            private$..risk_table <- jmvcore::OptionBool$new(
                "risk_table",
                risk_table,
                default=TRUE)
            private$..quantiles <- jmvcore::OptionBool$new(
                "quantiles",
                quantiles,
                default=FALSE)
            private$..p_value <- jmvcore::OptionBool$new(
                "p_value",
                p_value,
                default=TRUE)
            private$..legend_position <- jmvcore::OptionList$new(
                "legend_position",
                legend_position,
                options=list(
                    "right",
                    "left",
                    "top",
                    "bottom",
                    "none"),
                default="right")
            private$..time_label <- jmvcore::OptionString$new(
                "time_label",
                time_label,
                default="Time")
            private$..time_units <- jmvcore::OptionString$new(
                "time_units",
                time_units,
                default="")
            private$..survival_label <- jmvcore::OptionString$new(
                "survival_label",
                survival_label,
                default="")
            private$..title <- jmvcore::OptionString$new(
                "title",
                title,
                default="")
            private$..theme_style <- jmvcore::OptionList$new(
                "theme_style",
                theme_style,
                options=list(
                    "visr",
                    "classic",
                    "minimal",
                    "clean"),
                default="visr")
            private$..color_palette <- jmvcore::OptionList$new(
                "color_palette",
                color_palette,
                options=list(
                    "default",
                    "Set1",
                    "Set2",
                    "Dark2",
                    "Paired"),
                default="default")
            private$..show_summary <- jmvcore::OptionBool$new(
                "show_summary",
                show_summary,
                default=TRUE)
            private$..show_interpretation <- jmvcore::OptionBool$new(
                "show_interpretation",
                show_interpretation,
                default=TRUE)

            self$.addOption(private$..analysis_type)
            self$.addOption(private$..time_var)
            self$.addOption(private$..event_var)
            self$.addOption(private$..strata_var)
            self$.addOption(private$..cdisc_format)
            self$.addOption(private$..aval_var)
            self$.addOption(private$..cnsr_var)
            self$.addOption(private$..fun_type)
            self$.addOption(private$..confidence_interval)
            self$.addOption(private$..risk_table)
            self$.addOption(private$..quantiles)
            self$.addOption(private$..p_value)
            self$.addOption(private$..legend_position)
            self$.addOption(private$..time_label)
            self$.addOption(private$..time_units)
            self$.addOption(private$..survival_label)
            self$.addOption(private$..title)
            self$.addOption(private$..theme_style)
            self$.addOption(private$..color_palette)
            self$.addOption(private$..show_summary)
            self$.addOption(private$..show_interpretation)
        }),
    active = list(
        analysis_type = function() private$..analysis_type$value,
        time_var = function() private$..time_var$value,
        event_var = function() private$..event_var$value,
        strata_var = function() private$..strata_var$value,
        cdisc_format = function() private$..cdisc_format$value,
        aval_var = function() private$..aval_var$value,
        cnsr_var = function() private$..cnsr_var$value,
        fun_type = function() private$..fun_type$value,
        confidence_interval = function() private$..confidence_interval$value,
        risk_table = function() private$..risk_table$value,
        quantiles = function() private$..quantiles$value,
        p_value = function() private$..p_value$value,
        legend_position = function() private$..legend_position$value,
        time_label = function() private$..time_label$value,
        time_units = function() private$..time_units$value,
        survival_label = function() private$..survival_label$value,
        title = function() private$..title$value,
        theme_style = function() private$..theme_style$value,
        color_palette = function() private$..color_palette$value,
        show_summary = function() private$..show_summary$value,
        show_interpretation = function() private$..show_interpretation$value),
    private = list(
        ..analysis_type = NA,
        ..time_var = NA,
        ..event_var = NA,
        ..strata_var = NA,
        ..cdisc_format = NA,
        ..aval_var = NA,
        ..cnsr_var = NA,
        ..fun_type = NA,
        ..confidence_interval = NA,
        ..risk_table = NA,
        ..quantiles = NA,
        ..p_value = NA,
        ..legend_position = NA,
        ..time_label = NA,
        ..time_units = NA,
        ..survival_label = NA,
        ..title = NA,
        ..theme_style = NA,
        ..color_palette = NA,
        ..show_summary = NA,
        ..show_interpretation = NA)
)

jvisrResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jvisrResults",
    inherit = jmvcore::Group,
    active = list(
        plot = function() private$.items[["plot"]],
        summary = function() private$.items[["summary"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Clinical Research Visualization with visR",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "knitr",
                    "survival",
                    "visR",
                    "survminer"))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot",
                title="Clinical Visualization Plot",
                width=800,
                height=600,
                renderFun=".plot"))
            self$add(jmvcore::Html$new(
                options=options,
                name="summary",
                title="Summary Statistics",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation",
                visible=TRUE))}))

jvisrBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jvisrBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "jvisr",
                version = c(0,0,3),
                options = options,
                results = jvisrResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Clinical Research Visualization with visR
#'
#' Clinical and medical research focused visualizations using the visR package 
#' with sensible defaults based on graphical principles.
#'
#' @examples
#' \donttest{
#' # Example usage:
#' library(visR)
#' # Kaplan-Meier estimation
#' survfit_object <- estimate_KM(data = data, strata = "treatment")
#' # Clinical visualization
#' visr(survfit_object)
#'}
#' @param data The data as a data frame.
#' @param analysis_type Type of clinical visualization to generate.
#' @param time_var Time-to-event variable for survival analysis.
#' @param event_var Event indicator variable (1=event, 0=censored).
#' @param strata_var Variable for stratified analysis.
#' @param cdisc_format Whether to assume CDISC ADaM ADTTE data format.
#' @param aval_var Analysis value for CDISC format (time variable).
#' @param cnsr_var Censor variable for CDISC format (1=censored, 0=event).
#' @param fun_type Function scale for survival plots.
#' @param confidence_interval Whether to display confidence intervals.
#' @param risk_table Whether to include risk table below plot.
#' @param quantiles Whether to display survival quantiles.
#' @param p_value Whether to display statistical p-value.
#' @param legend_position Position of the legend in the plot.
#' @param time_label Label for the time axis.
#' @param time_units Units for time measurement.
#' @param survival_label Label for the survival probability axis.
#' @param title Main title for the plot.
#' @param theme_style Visual theme for the plot.
#' @param color_palette Color palette for group stratification.
#' @param show_summary Whether to display summary statistics table.
#' @param show_interpretation Whether to include clinical interpretation.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$plot} \tab \tab \tab \tab \tab Main clinical visualization plot using visR package \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab Summary statistics and data information \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab Clinical interpretation of the results \cr
#' }
#'
#' @export
jvisr <- function(
    data,
    analysis_type = "kaplan_meier",
    time_var,
    event_var,
    strata_var,
    cdisc_format = FALSE,
    aval_var,
    cnsr_var,
    fun_type = "surv",
    confidence_interval = TRUE,
    risk_table = TRUE,
    quantiles = FALSE,
    p_value = TRUE,
    legend_position = "right",
    time_label = "Time",
    time_units = "",
    survival_label = "",
    title = "",
    theme_style = "visr",
    color_palette = "default",
    show_summary = TRUE,
    show_interpretation = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("jvisr requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time_var)) time_var <- jmvcore::resolveQuo(jmvcore::enquo(time_var))
    if ( ! missing(event_var)) event_var <- jmvcore::resolveQuo(jmvcore::enquo(event_var))
    if ( ! missing(strata_var)) strata_var <- jmvcore::resolveQuo(jmvcore::enquo(strata_var))
    if ( ! missing(aval_var)) aval_var <- jmvcore::resolveQuo(jmvcore::enquo(aval_var))
    if ( ! missing(cnsr_var)) cnsr_var <- jmvcore::resolveQuo(jmvcore::enquo(cnsr_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time_var), time_var, NULL),
            `if`( ! missing(event_var), event_var, NULL),
            `if`( ! missing(strata_var), strata_var, NULL),
            `if`( ! missing(aval_var), aval_var, NULL),
            `if`( ! missing(cnsr_var), cnsr_var, NULL))

    for (v in strata_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- jvisrOptions$new(
        analysis_type = analysis_type,
        time_var = time_var,
        event_var = event_var,
        strata_var = strata_var,
        cdisc_format = cdisc_format,
        aval_var = aval_var,
        cnsr_var = cnsr_var,
        fun_type = fun_type,
        confidence_interval = confidence_interval,
        risk_table = risk_table,
        quantiles = quantiles,
        p_value = p_value,
        legend_position = legend_position,
        time_label = time_label,
        time_units = time_units,
        survival_label = survival_label,
        title = title,
        theme_style = theme_style,
        color_palette = color_palette,
        show_summary = show_summary,
        show_interpretation = show_interpretation)

    analysis <- jvisrClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

