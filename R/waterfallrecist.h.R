
# This file is automatically generated, you probably don't want to edit this

waterfallrecistOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "waterfallrecistOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            patientID = NULL,
            lesionID = NULL,
            visitTime = NULL,
            lesionType = NULL,
            location = NULL,
            diameter = NULL,
            isNewLesion = NULL,
            baselineTimepoint = 0,
            confirmationInterval = 4,
            maxTargetLesions = 5,
            maxLesionsPerOrgan = 2,
            showWaterfallPlot = TRUE,
            showSpiderPlot = TRUE,
            showLesionTable = TRUE,
            showTargetSumTable = TRUE,
            showBestResponseTable = TRUE,
            showRecistComplianceReport = TRUE,
            colorScheme = "recist", ...) {

            super$initialize(
                package="ClinicoPath",
                name="waterfallrecist",
                requiresData=TRUE,
                ...)

            private$..patientID <- jmvcore::OptionVariable$new(
                "patientID",
                patientID,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor",
                    "id"))
            private$..lesionID <- jmvcore::OptionVariable$new(
                "lesionID",
                lesionID,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor",
                    "id"))
            private$..visitTime <- jmvcore::OptionVariable$new(
                "visitTime",
                visitTime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..lesionType <- jmvcore::OptionVariable$new(
                "lesionType",
                lesionType,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..location <- jmvcore::OptionVariable$new(
                "location",
                location,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..diameter <- jmvcore::OptionVariable$new(
                "diameter",
                diameter,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..isNewLesion <- jmvcore::OptionVariable$new(
                "isNewLesion",
                isNewLesion,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..baselineTimepoint <- jmvcore::OptionNumber$new(
                "baselineTimepoint",
                baselineTimepoint,
                default=0)
            private$..confirmationInterval <- jmvcore::OptionNumber$new(
                "confirmationInterval",
                confirmationInterval,
                default=4,
                min=0,
                max=52)
            private$..maxTargetLesions <- jmvcore::OptionNumber$new(
                "maxTargetLesions",
                maxTargetLesions,
                default=5,
                min=1,
                max=10)
            private$..maxLesionsPerOrgan <- jmvcore::OptionNumber$new(
                "maxLesionsPerOrgan",
                maxLesionsPerOrgan,
                default=2,
                min=1,
                max=5)
            private$..showWaterfallPlot <- jmvcore::OptionBool$new(
                "showWaterfallPlot",
                showWaterfallPlot,
                default=TRUE)
            private$..showSpiderPlot <- jmvcore::OptionBool$new(
                "showSpiderPlot",
                showSpiderPlot,
                default=TRUE)
            private$..showLesionTable <- jmvcore::OptionBool$new(
                "showLesionTable",
                showLesionTable,
                default=TRUE)
            private$..showTargetSumTable <- jmvcore::OptionBool$new(
                "showTargetSumTable",
                showTargetSumTable,
                default=TRUE)
            private$..showBestResponseTable <- jmvcore::OptionBool$new(
                "showBestResponseTable",
                showBestResponseTable,
                default=TRUE)
            private$..showRecistComplianceReport <- jmvcore::OptionBool$new(
                "showRecistComplianceReport",
                showRecistComplianceReport,
                default=TRUE)
            private$..colorScheme <- jmvcore::OptionList$new(
                "colorScheme",
                colorScheme,
                options=list(
                    "recist",
                    "jamovi",
                    "colorblind"),
                default="recist")
            private$..addBestResponseToData <- jmvcore::OptionOutput$new(
                "addBestResponseToData")

            self$.addOption(private$..patientID)
            self$.addOption(private$..lesionID)
            self$.addOption(private$..visitTime)
            self$.addOption(private$..lesionType)
            self$.addOption(private$..location)
            self$.addOption(private$..diameter)
            self$.addOption(private$..isNewLesion)
            self$.addOption(private$..baselineTimepoint)
            self$.addOption(private$..confirmationInterval)
            self$.addOption(private$..maxTargetLesions)
            self$.addOption(private$..maxLesionsPerOrgan)
            self$.addOption(private$..showWaterfallPlot)
            self$.addOption(private$..showSpiderPlot)
            self$.addOption(private$..showLesionTable)
            self$.addOption(private$..showTargetSumTable)
            self$.addOption(private$..showBestResponseTable)
            self$.addOption(private$..showRecistComplianceReport)
            self$.addOption(private$..colorScheme)
            self$.addOption(private$..addBestResponseToData)
        }),
    active = list(
        patientID = function() private$..patientID$value,
        lesionID = function() private$..lesionID$value,
        visitTime = function() private$..visitTime$value,
        lesionType = function() private$..lesionType$value,
        location = function() private$..location$value,
        diameter = function() private$..diameter$value,
        isNewLesion = function() private$..isNewLesion$value,
        baselineTimepoint = function() private$..baselineTimepoint$value,
        confirmationInterval = function() private$..confirmationInterval$value,
        maxTargetLesions = function() private$..maxTargetLesions$value,
        maxLesionsPerOrgan = function() private$..maxLesionsPerOrgan$value,
        showWaterfallPlot = function() private$..showWaterfallPlot$value,
        showSpiderPlot = function() private$..showSpiderPlot$value,
        showLesionTable = function() private$..showLesionTable$value,
        showTargetSumTable = function() private$..showTargetSumTable$value,
        showBestResponseTable = function() private$..showBestResponseTable$value,
        showRecistComplianceReport = function() private$..showRecistComplianceReport$value,
        colorScheme = function() private$..colorScheme$value,
        addBestResponseToData = function() private$..addBestResponseToData$value),
    private = list(
        ..patientID = NA,
        ..lesionID = NA,
        ..visitTime = NA,
        ..lesionType = NA,
        ..location = NA,
        ..diameter = NA,
        ..isNewLesion = NA,
        ..baselineTimepoint = NA,
        ..confirmationInterval = NA,
        ..maxTargetLesions = NA,
        ..maxLesionsPerOrgan = NA,
        ..showWaterfallPlot = NA,
        ..showSpiderPlot = NA,
        ..showLesionTable = NA,
        ..showTargetSumTable = NA,
        ..showBestResponseTable = NA,
        ..showRecistComplianceReport = NA,
        ..colorScheme = NA,
        ..addBestResponseToData = NA)
)

waterfallrecistResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "waterfallrecistResults",
    inherit = jmvcore::Group,
    active = list(
        lesionTable = function() private$.items[["lesionTable"]],
        targetSumTable = function() private$.items[["targetSumTable"]],
        bestResponseTable = function() private$.items[["bestResponseTable"]],
        recistSummary = function() private$.items[["recistSummary"]],
        complianceReport = function() private$.items[["complianceReport"]],
        waterfallPlot = function() private$.items[["waterfallPlot"]],
        spiderPlot = function() private$.items[["spiderPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="RECIST v1.1 Response Analysis")
            self$add(jmvcore::Table$new(
                options=options,
                name="lesionTable",
                title="Lesion-Level Measurements",
                visible="(showLesionTable)",
                clearWith=list(
                    "patientID",
                    "lesionID",
                    "visitTime",
                    "diameter",
                    "lesionType",
                    "location"),
                columns=list(
                    list(
                        `name`="patientID", 
                        `title`="Patient ID", 
                        `type`="text"),
                    list(
                        `name`="lesionID", 
                        `title`="Lesion ID", 
                        `type`="text"),
                    list(
                        `name`="visitTime", 
                        `title`="Visit Time", 
                        `type`="number"),
                    list(
                        `name`="visitNumber", 
                        `title`="Visit", 
                        `type`="integer"),
                    list(
                        `name`="lesionType", 
                        `title`="Type", 
                        `type`="text"),
                    list(
                        `name`="location", 
                        `title`="Location", 
                        `type`="text"),
                    list(
                        `name`="diameter", 
                        `title`="Diameter (mm)", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="changeFromBaseline", 
                        `title`="Change from Baseline (mm)", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="percentChange", 
                        `title`="% Change", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="targetSumTable",
                title="Target Lesion Sum by Visit",
                visible="(showTargetSumTable)",
                clearWith=list(
                    "patientID",
                    "visitTime",
                    "diameter"),
                columns=list(
                    list(
                        `name`="patientID", 
                        `title`="Patient ID", 
                        `type`="text"),
                    list(
                        `name`="visitTime", 
                        `title`="Visit Time", 
                        `type`="number"),
                    list(
                        `name`="visitNumber", 
                        `title`="Visit", 
                        `type`="integer"),
                    list(
                        `name`="nTargetLesions", 
                        `title`="N Target", 
                        `type`="integer"),
                    list(
                        `name`="baselineSum", 
                        `title`="Baseline Sum (mm)", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="currentSum", 
                        `title`="Current Sum (mm)", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="absoluteChange", 
                        `title`="Absolute \\u0394 (mm)", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="percentChange", 
                        `title`="% Change", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="targetResponse", 
                        `title`="Target Response", 
                        `type`="text"),
                    list(
                        `name`="responseConfirmed", 
                        `title`="Confirmed", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="bestResponseTable",
                title="Best Overall Response (BOR)",
                visible="(showBestResponseTable)",
                clearWith=list(
                    "patientID",
                    "visitTime",
                    "diameter",
                    "confirmationInterval"),
                columns=list(
                    list(
                        `name`="patientID", 
                        `title`="Patient ID", 
                        `type`="text"),
                    list(
                        `name`="bestOverallResponse", 
                        `title`="Best Response", 
                        `type`="text"),
                    list(
                        `name`="borConfirmed", 
                        `title`="Confirmed", 
                        `type`="text"),
                    list(
                        `name`="borFirstVisit", 
                        `title`="First Achieved (Visit)", 
                        `type`="text"),
                    list(
                        `name`="timeToResponse", 
                        `title`="Time to Response", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="durationOfResponse", 
                        `title`="Duration of Response", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="progressionOccurred", 
                        `title`="Progression", 
                        `type`="text"),
                    list(
                        `name`="progressionVisit", 
                        `title`="Progression Visit", 
                        `type`="text"))))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    orrConfirmed = function() private$.items[["orrConfirmed"]],
                    dcrConfirmed = function() private$.items[["dcrConfirmed"]],
                    responseDistribution = function() private$.items[["responseDistribution"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="recistSummary",
                            title="RECIST v1.1 Summary Statistics",
                            clearWith=list(
                    "patientID",
                    "visitTime",
                    "diameter",
                    "confirmationInterval"))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="orrConfirmed",
                            title="Confirmed ORR (CR + PR)",
                            columns=list(
                                list(
                                    `name`="metric", 
                                    `title`="Metric", 
                                    `type`="text"),
                                list(
                                    `name`="value", 
                                    `title`="Value", 
                                    `type`="text"),
                                list(
                                    `name`="ci", 
                                    `title`="95% CI", 
                                    `type`="text"),
                                list(
                                    `name`="interpretation", 
                                    `title`="Interpretation", 
                                    `type`="text"))))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="dcrConfirmed",
                            title="Confirmed DCR (CR + PR + SD)",
                            columns=list(
                                list(
                                    `name`="metric", 
                                    `title`="Metric", 
                                    `type`="text"),
                                list(
                                    `name`="value", 
                                    `title`="Value", 
                                    `type`="text"),
                                list(
                                    `name`="ci", 
                                    `title`="95% CI", 
                                    `type`="text"),
                                list(
                                    `name`="interpretation", 
                                    `title`="Interpretation", 
                                    `type`="text"))))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="responseDistribution",
                            title="Response Category Distribution",
                            columns=list(
                                list(
                                    `name`="category", 
                                    `title`="Response Category", 
                                    `type`="text"),
                                list(
                                    `name`="confirmed", 
                                    `title`="Confirmed (n)", 
                                    `type`="integer"),
                                list(
                                    `name`="confirmedPercent", 
                                    `title`="Confirmed (%)", 
                                    `type`="number", 
                                    `format`="zto,pvalue"),
                                list(
                                    `name`="unconfirmed", 
                                    `title`="Unconfirmed (n)", 
                                    `type`="integer"),
                                list(
                                    `name`="unconfirmedPercent", 
                                    `title`="Unconfirmed (%)", 
                                    `type`="number", 
                                    `format`="zto,pvalue"))))}))$new(options=options))
            self$add(jmvcore::Html$new(
                options=options,
                name="complianceReport",
                title="RECIST v1.1 Compliance Audit",
                visible="(showRecistComplianceReport)",
                clearWith=list(
                    "patientID",
                    "lesionID",
                    "visitTime",
                    "diameter",
                    "lesionType",
                    "location",
                    "maxTargetLesions",
                    "maxLesionsPerOrgan",
                    "confirmationInterval")))
            self$add(jmvcore::Image$new(
                options=options,
                name="waterfallPlot",
                title="Waterfall Plot (Best Confirmed Response)",
                width=800,
                height=600,
                renderFun=".waterfallPlot",
                visible="(showWaterfallPlot)",
                clearWith=list(
                    "patientID",
                    "diameter",
                    "visitTime",
                    "confirmationInterval",
                    "colorScheme")))
            self$add(jmvcore::Image$new(
                options=options,
                name="spiderPlot",
                title="Spider Plot (Target Lesion Sum Trajectories)",
                width=800,
                height=600,
                renderFun=".spiderPlot",
                visible="(showSpiderPlot)",
                clearWith=list(
                    "patientID",
                    "diameter",
                    "visitTime",
                    "confirmationInterval",
                    "colorScheme")))}))

waterfallrecistBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "waterfallrecistBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "waterfallrecist",
                version = c(0,0,1),
                options = options,
                results = waterfallrecistResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'none')
        }))

#' RECIST v1.1 Compliant Response Analysis
#'
#' Creates RECIST v1.1 compliant waterfall and spider plots for tumor response 
#' analysis. Implements full RECIST v1.1 protocol including target lesion 
#' summation, new lesion detection, non-target progression assessment, and 
#' response confirmation requirements. REGULATORY-READY: Suitable for clinical 
#' trial endpoints and regulatory submissions.
#' 
#'
#' @examples
#' \donttest{
#' # Example: Lesion-level data for RECIST v1.1
#' data_recist <- data.frame(
#'     PatientID = rep(paste0("PT", 1:3), each = 6),
#'     VisitTime = rep(c(0, 4, 8, 12, 16, 20), 3),
#'     LesionID = paste0("L", rep(1:2, each = 3, times = 3)),
#'     LesionType = rep(c("Target", "Target"), each = 3, times = 3),
#'     Location = rep(c("Liver", "Lung"), each = 3, times = 3),
#'     Diameter = c(
#'         # Patient 1
#'         35, 28, 20,  # Lesion 1
#'         42, 38, 30,  # Lesion 2
#'         # Patient 2
#'         50, 45, 48,  # Lesion 1
#'         30, 28, 32,  # Lesion 2
#'         # Patient 3
#'         45, 30, 25,  # Lesion 1
#'         38, 25, 20   # Lesion 2
#'     ),
#'     IsNewLesion = rep(0, 18)
#' )
#'
#' waterfallrecist(
#'     data = data_recist,
#'     patientID = "PatientID",
#'     lesionID = "LesionID",
#'     visitTime = "VisitTime",
#'     lesionType = "LesionType",
#'     location = "Location",
#'     diameter = "Diameter",
#'     isNewLesion = "IsNewLesion"
#' )
#'}
#' @param data The data as a data frame with LESION-LEVEL observations (one
#'   row per lesion per timepoint).
#' @param patientID Variable containing patient identifiers. Each patient can
#'   have multiple lesions tracked across timepoints.
#' @param lesionID Unique lesion identifier within each patient (e.g., L1, L2,
#'   Liver_1, Lung_2). Used to track individual lesions across timepoints.
#' @param visitTime Time point of measurement (e.g., weeks from baseline, days
#'   from treatment start). Baseline should be time = 0. Used for tracking
#'   lesion progression over time.
#' @param lesionType Lesion classification: Target, NonTarget, or New. Target
#'   lesions (max 5 total, max 2 per organ) are measured and summed. NonTarget
#'   lesions are assessed qualitatively (present/absent/progressed).
#' @param location Anatomic site of lesion (e.g., Liver, Lung, Lymph_Node).
#'   Used to enforce RECIST rule: max 2 target lesions per organ.
#' @param diameter Longest diameter of target lesions in millimeters (≥10mm
#'   for non-lymph nodes, ≥15mm for lymph nodes). For non-target lesions, can be
#'   NA (qualitative assessment only).
#' @param isNewLesion Binary indicator (0 = baseline/existing, 1 = new lesion
#'   appearing after baseline). ANY new lesion automatically triggers
#'   Progressive Disease (PD) per RECIST v1.1.
#' @param baselineTimepoint Value of visitTime representing baseline (default
#'   = 0). All lesions at this timepoint establish the baseline sum.
#' @param confirmationInterval Minimum time interval (weeks) for response
#'   confirmation per RECIST v1.1. CR and PR must be confirmed by repeat
#'   assessment ≥4 weeks after initial documentation.
#' @param maxTargetLesions Maximum number of target lesions per patient
#'   (RECIST v1.1 default = 5).
#' @param maxLesionsPerOrgan Maximum target lesions per organ (RECIST v1.1
#'   default = 2).
#' @param showWaterfallPlot Display waterfall plot showing best confirmed
#'   response for each patient.
#' @param showSpiderPlot Display spider plot showing target lesion sum
#'   trajectories over time.
#' @param showLesionTable Display detailed lesion-level measurements across
#'   all timepoints.
#' @param showTargetSumTable Display target lesion sums and percent changes
#'   per visit.
#' @param showBestResponseTable Display best overall response with
#'   confirmation status per patient.
#' @param showRecistComplianceReport Display audit report verifying RECIST
#'   v1.1 compliance (target lesion limits, confirmation, new lesions).
#' @param colorScheme Color scheme for plots.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$lesionTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$targetSumTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$bestResponseTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$recistSummary$orrConfirmed} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$recistSummary$dcrConfirmed} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$recistSummary$responseDistribution} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$complianceReport} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$waterfallPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$spiderPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$lesionTable$asDF}
#'
#' \code{as.data.frame(results$lesionTable)}
#'
#' @export
waterfallrecist <- function(
    data,
    patientID,
    lesionID,
    visitTime,
    lesionType = NULL,
    location = NULL,
    diameter,
    isNewLesion = NULL,
    baselineTimepoint = 0,
    confirmationInterval = 4,
    maxTargetLesions = 5,
    maxLesionsPerOrgan = 2,
    showWaterfallPlot = TRUE,
    showSpiderPlot = TRUE,
    showLesionTable = TRUE,
    showTargetSumTable = TRUE,
    showBestResponseTable = TRUE,
    showRecistComplianceReport = TRUE,
    colorScheme = "recist") {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("waterfallrecist requires jmvcore to be installed (restart may be required)")

    if ( ! missing(patientID)) patientID <- jmvcore::resolveQuo(jmvcore::enquo(patientID))
    if ( ! missing(lesionID)) lesionID <- jmvcore::resolveQuo(jmvcore::enquo(lesionID))
    if ( ! missing(visitTime)) visitTime <- jmvcore::resolveQuo(jmvcore::enquo(visitTime))
    if ( ! missing(lesionType)) lesionType <- jmvcore::resolveQuo(jmvcore::enquo(lesionType))
    if ( ! missing(location)) location <- jmvcore::resolveQuo(jmvcore::enquo(location))
    if ( ! missing(diameter)) diameter <- jmvcore::resolveQuo(jmvcore::enquo(diameter))
    if ( ! missing(isNewLesion)) isNewLesion <- jmvcore::resolveQuo(jmvcore::enquo(isNewLesion))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(patientID), patientID, NULL),
            `if`( ! missing(lesionID), lesionID, NULL),
            `if`( ! missing(visitTime), visitTime, NULL),
            `if`( ! missing(lesionType), lesionType, NULL),
            `if`( ! missing(location), location, NULL),
            `if`( ! missing(diameter), diameter, NULL),
            `if`( ! missing(isNewLesion), isNewLesion, NULL))

    for (v in lesionType) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in location) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- waterfallrecistOptions$new(
        patientID = patientID,
        lesionID = lesionID,
        visitTime = visitTime,
        lesionType = lesionType,
        location = location,
        diameter = diameter,
        isNewLesion = isNewLesion,
        baselineTimepoint = baselineTimepoint,
        confirmationInterval = confirmationInterval,
        maxTargetLesions = maxTargetLesions,
        maxLesionsPerOrgan = maxLesionsPerOrgan,
        showWaterfallPlot = showWaterfallPlot,
        showSpiderPlot = showSpiderPlot,
        showLesionTable = showLesionTable,
        showTargetSumTable = showTargetSumTable,
        showBestResponseTable = showBestResponseTable,
        showRecistComplianceReport = showRecistComplianceReport,
        colorScheme = colorScheme)

    analysis <- waterfallrecistClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

