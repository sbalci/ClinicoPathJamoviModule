# This file is automatically generated, you probably don't want to edit this

correlationnetworkOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "correlationnetworkOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            vars = NULL,
            group = NULL,
            networkMethod = "correlation",
            correlationMethod = "pearson",
            threshold = 0.1,
            significanceThreshold = 0.05,
            onlySignificant = FALSE,
            centralityMeasures = TRUE,
            communityDetection = TRUE,
            communityMethod = "walktrap",
            networkComparison = FALSE,
            plots = TRUE,
            layoutAlgorithm = "spring",
            nodeSize = "degree",
            edgeWidth = "weight",
            colorNodes = TRUE,
            interactive = FALSE,
            report = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="correlationnetwork",
                requiresData=TRUE,
                ...)

            private$..vars <- jmvcore::OptionVariables$new(
                "vars",
                vars,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..group <- jmvcore::OptionVariable$new(
                "group",
                group,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..networkMethod <- jmvcore::OptionList$new(
                "networkMethod",
                networkMethod,
                options=list(
                    "correlation",
                    "partial",
                    "ggm",
                    "lasso"),
                default="correlation")
            private$..correlationMethod <- jmvcore::OptionList$new(
                "correlationMethod",
                correlationMethod,
                options=list(
                    "pearson",
                    "spearman",
                    "kendall"),
                default="pearson")
            private$..threshold <- jmvcore::OptionNumber$new(
                "threshold",
                threshold,
                min=0,
                max=1,
                default=0.1)
            private$..significanceThreshold <- jmvcore::OptionNumber$new(
                "significanceThreshold",
                significanceThreshold,
                min=0.001,
                max=0.1,
                default=0.05)
            private$..onlySignificant <- jmvcore::OptionBool$new(
                "onlySignificant",
                onlySignificant,
                default=FALSE)
            private$..centralityMeasures <- jmvcore::OptionBool$new(
                "centralityMeasures",
                centralityMeasures,
                default=TRUE)
            private$..communityDetection <- jmvcore::OptionBool$new(
                "communityDetection",
                communityDetection,
                default=TRUE)
            private$..communityMethod <- jmvcore::OptionList$new(
                "communityMethod",
                communityMethod,
                options=list(
                    "walktrap",
                    "louvain",
                    "leiden",
                    "spinglass",
                    "betweenness"),
                default="walktrap")
            private$..networkComparison <- jmvcore::OptionBool$new(
                "networkComparison",
                networkComparison,
                default=FALSE)
            private$..plots <- jmvcore::OptionBool$new(
                "plots",
                plots,
                default=TRUE)
            private$..layoutAlgorithm <- jmvcore::OptionList$new(
                "layoutAlgorithm",
                layoutAlgorithm,
                options=list(
                    "spring",
                    "circle",
                    "nicely",
                    "kk",
                    "lgl"),
                default="spring")
            private$..nodeSize <- jmvcore::OptionList$new(
                "nodeSize",
                nodeSize,
                options=list(
                    "constant",
                    "degree",
                    "betweenness",
                    "closeness",
                    "eigenvector"),
                default="degree")
            private$..edgeWidth <- jmvcore::OptionList$new(
                "edgeWidth",
                edgeWidth,
                options=list(
                    "weight",
                    "constant"),
                default="weight")
            private$..colorNodes <- jmvcore::OptionBool$new(
                "colorNodes",
                colorNodes,
                default=TRUE)
            private$..interactive <- jmvcore::OptionBool$new(
                "interactive",
                interactive,
                default=FALSE)
            private$..report <- jmvcore::OptionBool$new(
                "report",
                report,
                default=TRUE)

            self$.addOption(private$..vars)
            self$.addOption(private$..group)
            self$.addOption(private$..networkMethod)
            self$.addOption(private$..correlationMethod)
            self$.addOption(private$..threshold)
            self$.addOption(private$..significanceThreshold)
            self$.addOption(private$..onlySignificant)
            self$.addOption(private$..centralityMeasures)
            self$.addOption(private$..communityDetection)
            self$.addOption(private$..communityMethod)
            self$.addOption(private$..networkComparison)
            self$.addOption(private$..plots)
            self$.addOption(private$..layoutAlgorithm)
            self$.addOption(private$..nodeSize)
            self$.addOption(private$..edgeWidth)
            self$.addOption(private$..colorNodes)
            self$.addOption(private$..interactive)
            self$.addOption(private$..report)
        }),
    active = list(
        vars = function() private$..vars$value,
        group = function() private$..group$value,
        networkMethod = function() private$..networkMethod$value,
        correlationMethod = function() private$..correlationMethod$value,
        threshold = function() private$..threshold$value,
        significanceThreshold = function() private$..significanceThreshold$value,
        onlySignificant = function() private$..onlySignificant$value,
        centralityMeasures = function() private$..centralityMeasures$value,
        communityDetection = function() private$..communityDetection$value,
        communityMethod = function() private$..communityMethod$value,
        networkComparison = function() private$..networkComparison$value,
        plots = function() private$..plots$value,
        layoutAlgorithm = function() private$..layoutAlgorithm$value,
        nodeSize = function() private$..nodeSize$value,
        edgeWidth = function() private$..edgeWidth$value,
        colorNodes = function() private$..colorNodes$value,
        interactive = function() private$..interactive$value,
        report = function() private$..report$value),
    private = list(
        ..vars = NA,
        ..group = NA,
        ..networkMethod = NA,
        ..correlationMethod = NA,
        ..threshold = NA,
        ..significanceThreshold = NA,
        ..onlySignificant = NA,
        ..centralityMeasures = NA,
        ..communityDetection = NA,
        ..communityMethod = NA,
        ..networkComparison = NA,
        ..plots = NA,
        ..layoutAlgorithm = NA,
        ..nodeSize = NA,
        ..edgeWidth = NA,
        ..colorNodes = NA,
        ..interactive = NA,
        ..report = NA)
)

correlationnetworkResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "correlationnetworkResults",
    inherit = jmvcore::Group,
    active = list(
        networkSummary = function() private$.items[["networkSummary"]],
        adjacencyMatrix = function() private$.items[["adjacencyMatrix"]],
        centralityMeasures = function() private$.items[["centralityMeasures"]],
        communityStructure = function() private$.items[["communityStructure"]],
        communityStats = function() private$.items[["communityStats"]],
        networkComparison = function() private$.items[["networkComparison"]],
        report = function() private$.items[["report"]],
        networkPlot = function() private$.items[["networkPlot"]],
        interactiveNetworkPlot = function() private$.items[["interactiveNetworkPlot"]],
        centralityPlot = function() private$.items[["centralityPlot"]],
        communityPlot = function() private$.items[["communityPlot"]],
        adjacencyHeatmap = function() private$.items[["adjacencyHeatmap"]],
        networkMetricsPlot = function() private$.items[["networkMetricsPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Correlation Network Analysis",
                refs=list(
                    "correlation",
                    "igraph",
                    "qgraph",
                    "network",
                    "ggraph",
                    "visNetwork",
                    "corrplot",
                    "glmnet",
                    "huge",
                    "bootnet",
                    "NetworkComparisonTest",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Table$new(
                options=options,
                name="networkSummary",
                title="Network Summary",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="property", 
                        `title`="Property", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="adjacencyMatrix",
                title="Adjacency Matrix",
                columns=list(),
                clearWith=list(
                    "vars",
                    "group",
                    "networkMethod",
                    "correlationMethod",
                    "threshold",
                    "significanceThreshold",
                    "onlySignificant")))
            self$add(jmvcore::Table$new(
                options=options,
                name="centralityMeasures",
                title="Centrality Measures",
                visible="(centralityMeasures)",
                columns=list(
                    list(
                        `name`="node", 
                        `title`="Node", 
                        `type`="text"),
                    list(
                        `name`="degree", 
                        `title`="Degree", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="betweenness", 
                        `title`="Betweenness", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="closeness", 
                        `title`="Closeness", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="eigenvector", 
                        `title`="Eigenvector", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="strength", 
                        `title`="Strength", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="communityStructure",
                title="Community Structure",
                visible="(communityDetection)",
                columns=list(
                    list(
                        `name`="node", 
                        `title`="Node", 
                        `type`="text"),
                    list(
                        `name`="community", 
                        `title`="Community", 
                        `type`="integer"),
                    list(
                        `name`="membership_strength", 
                        `title`="Membership Strength", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="communityStats",
                title="Community Statistics",
                visible="(communityDetection)",
                columns=list(
                    list(
                        `name`="community", 
                        `title`="Community", 
                        `type`="integer"),
                    list(
                        `name`="size", 
                        `title`="Size", 
                        `type`="integer"),
                    list(
                        `name`="modularity", 
                        `title`="Modularity", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="density", 
                        `title`="Density", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="networkComparison",
                title="Network Comparison",
                visible="(networkComparison && group)",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="group1", 
                        `title`="Group 1", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="group2", 
                        `title`="Group 2", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="difference", 
                        `title`="Difference", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="report",
                title="Natural Language Report",
                visible="(report)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="networkPlot",
                title="Network Visualization",
                width=800,
                height=600,
                renderFun=".networkPlot",
                visible="(plots && !interactive)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="interactiveNetworkPlot",
                title="Interactive Network",
                width=900,
                height=700,
                renderFun=".interactiveNetworkPlot",
                visible="(plots && interactive)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="centralityPlot",
                title="Centrality Measures Plot",
                width=600,
                height=500,
                renderFun=".centralityPlot",
                visible="(plots && centralityMeasures)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="communityPlot",
                title="Community Structure Plot",
                width=800,
                height=600,
                renderFun=".communityPlot",
                visible="(plots && communityDetection)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="adjacencyHeatmap",
                title="Adjacency Heatmap",
                width=600,
                height=500,
                renderFun=".adjacencyHeatmap",
                visible="(plots)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="networkMetricsPlot",
                title="Network Metrics Distribution",
                width=700,
                height=500,
                renderFun=".networkMetricsPlot",
                visible="(plots && centralityMeasures)"))}))

correlationnetworkBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "correlationnetworkBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "correlationnetwork",
                version = c(0,0,1),
                options = options,
                results = correlationnetworkResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = TRUE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Correlation Network Analysis
#'
#' Comprehensive network analysis of correlation structures using multiple 
#' algorithms including  Gaussian Graphical Models (GGM), LASSO regularized 
#' networks, and partial correlations.  Provides network metrics, community 
#' detection, interactive visualizations, and network  comparison tests. 
#' Suitable for understanding complex relationships between variables through  
#' network topology.
#' 
#'
#' @examples
#' # Basic correlation network analysis
#' correlationnetwork(
#'     data = histopathology,
#'     vars = c("Age", "OverallTime", "MeasurementA", "MeasurementB", "MeasurementC")
#' )
#'
#' # With LASSO regularization and community detection
#' correlationnetwork(
#'     data = histopathology,
#'     vars = c("Age", "OverallTime", "MeasurementA", "MeasurementB", "MeasurementC"),
#'     networkMethod = "lasso",
#'     communityDetection = TRUE,
#'     centralityMeasures = TRUE
#' )
#'
#' @param data The data as a data frame.
#' @param vars A vector of strings naming the variables to include in the
#'   network analysis.
#' @param group Variable to split the analysis by for network comparison.
#' @param networkMethod Method for constructing the network: 'correlation'
#'   (default), 'partial', 'ggm', or 'lasso'.
#' @param correlationMethod The correlation method to use: 'pearson' (default),
#'   'spearman', or 'kendall'.
#' @param threshold Minimum absolute correlation value to include as edge in
#'   network (default: 0.1).
#' @param significanceThreshold Alpha level for edge significance testing
#'   (default: 0.05).
#' @param onlySignificant FALSE (default) or TRUE, show only statistically
#'   significant edges.
#' @param centralityMeasures TRUE (default) or FALSE, calculate node centrality
#'   measures.
#' @param communityDetection TRUE (default) or FALSE, perform community
#'   detection analysis.
#' @param communityMethod Method for community detection: 'walktrap' (default),
#'   'louvain', 'leiden', 'spinglass', or 'betweenness'.
#' @param networkComparison FALSE (default) or TRUE, perform network comparison
#'   tests when grouping variable is provided.
#' @param plots TRUE (default) or FALSE, generate network visualization plots.
#' @param layoutAlgorithm Layout algorithm for network visualization: 'spring'
#'   (default), 'circle', 'nicely', 'kk', or 'lgl'.
#' @param nodeSize Method for sizing nodes: 'constant', 'degree' (default),
#'   'betweenness', 'closeness', or 'eigenvector'.
#' @param edgeWidth Method for edge width: 'weight' (default) or 'constant'.
#' @param colorNodes TRUE (default) or FALSE, color nodes by detected
#'   communities.
#' @param interactive FALSE (default) or TRUE, generate interactive network
#'   plots.
#' @param report TRUE (default) or FALSE, provide natural language
#'   interpretation of network analysis.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$networkSummary} \tab \tab \tab \tab \tab overview of network structure and properties \cr
#'   \code{results$adjacencyMatrix} \tab \tab \tab \tab \tab network adjacency matrix showing edge weights \cr
#'   \code{results$centralityMeasures} \tab \tab \tab \tab \tab node centrality metrics for network analysis \cr
#'   \code{results$communityStructure} \tab \tab \tab \tab \tab community detection results and modularity \cr
#'   \code{results$communityStats} \tab \tab \tab \tab \tab summary statistics for detected communities \cr
#'   \code{results$networkComparison} \tab \tab \tab \tab \tab comparison of networks across groups \cr
#'   \code{results$report} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$networkPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$interactiveNetworkPlot} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$centralityPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$communityPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$adjacencyHeatmap} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$networkMetricsPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$networkSummary$asDF}
#'
#' \code{as.data.frame(results$networkSummary)}
#'
#' @export
correlationnetwork <- function(
    data,
    vars,
    group = NULL,
    networkMethod = "correlation",
    correlationMethod = "pearson",
    threshold = 0.1,
    significanceThreshold = 0.05,
    onlySignificant = FALSE,
    centralityMeasures = TRUE,
    communityDetection = TRUE,
    communityMethod = "walktrap",
    networkComparison = FALSE,
    plots = TRUE,
    layoutAlgorithm = "spring",
    nodeSize = "degree",
    edgeWidth = "weight",
    colorNodes = TRUE,
    interactive = FALSE,
    report = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("correlationnetwork requires jmvcore to be installed (restart may be required)")

    if ( ! missing(vars)) vars <- jmvcore::resolveQuo(jmvcore::enquo(vars))
    if ( ! missing(group)) group <- jmvcore::resolveQuo(jmvcore::enquo(group))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(vars), vars, NULL),
            `if`( ! missing(group), group, NULL))

    for (v in group) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- correlationnetworkOptions$new(
        vars = vars,
        group = group,
        networkMethod = networkMethod,
        correlationMethod = correlationMethod,
        threshold = threshold,
        significanceThreshold = significanceThreshold,
        onlySignificant = onlySignificant,
        centralityMeasures = centralityMeasures,
        communityDetection = communityDetection,
        communityMethod = communityMethod,
        networkComparison = networkComparison,
        plots = plots,
        layoutAlgorithm = layoutAlgorithm,
        nodeSize = nodeSize,
        edgeWidth = edgeWidth,
        colorNodes = colorNodes,
        interactive = interactive,
        report = report)

    analysis <- correlationnetworkClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}
