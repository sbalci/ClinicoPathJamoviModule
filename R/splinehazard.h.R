
# This file is automatically generated, you probably don't want to edit this

splinehazardOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "splinehazardOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            outcome = NULL,
            explanatory = NULL,
            outcomeLevel = "1",
            knots_method = "automatic",
            num_knots = 3,
            spline_degree = "3",
            hazard_scale = "log",
            confidence_level = 0.95,
            show_hazard_plot = TRUE,
            show_survival_plot = TRUE,
            show_cumulative_plot = FALSE,
            show_model_comparison = TRUE,
            showSummaries = FALSE,
            showExplanations = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="splinehazard",
                requiresData=FALSE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..explanatory <- jmvcore::OptionVariables$new(
                "explanatory",
                explanatory,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..outcomeLevel <- jmvcore::OptionString$new(
                "outcomeLevel",
                outcomeLevel,
                default="1")
            private$..knots_method <- jmvcore::OptionList$new(
                "knots_method",
                knots_method,
                options=list(
                    "quantile",
                    "equal",
                    "manual",
                    "automatic"),
                default="automatic")
            private$..num_knots <- jmvcore::OptionInteger$new(
                "num_knots",
                num_knots,
                default=3,
                min=1,
                max=10)
            private$..spline_degree <- jmvcore::OptionList$new(
                "spline_degree",
                spline_degree,
                options=list(
                    "1",
                    "2",
                    "3"),
                default="3")
            private$..hazard_scale <- jmvcore::OptionList$new(
                "hazard_scale",
                hazard_scale,
                options=list(
                    "log",
                    "odds",
                    "normal"),
                default="log")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.5,
                max=0.99)
            private$..show_hazard_plot <- jmvcore::OptionBool$new(
                "show_hazard_plot",
                show_hazard_plot,
                default=TRUE)
            private$..show_survival_plot <- jmvcore::OptionBool$new(
                "show_survival_plot",
                show_survival_plot,
                default=TRUE)
            private$..show_cumulative_plot <- jmvcore::OptionBool$new(
                "show_cumulative_plot",
                show_cumulative_plot,
                default=FALSE)
            private$..show_model_comparison <- jmvcore::OptionBool$new(
                "show_model_comparison",
                show_model_comparison,
                default=TRUE)
            private$..showSummaries <- jmvcore::OptionBool$new(
                "showSummaries",
                showSummaries,
                default=FALSE)
            private$..showExplanations <- jmvcore::OptionBool$new(
                "showExplanations",
                showExplanations,
                default=FALSE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..outcome)
            self$.addOption(private$..explanatory)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..knots_method)
            self$.addOption(private$..num_knots)
            self$.addOption(private$..spline_degree)
            self$.addOption(private$..hazard_scale)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..show_hazard_plot)
            self$.addOption(private$..show_survival_plot)
            self$.addOption(private$..show_cumulative_plot)
            self$.addOption(private$..show_model_comparison)
            self$.addOption(private$..showSummaries)
            self$.addOption(private$..showExplanations)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        outcome = function() private$..outcome$value,
        explanatory = function() private$..explanatory$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        knots_method = function() private$..knots_method$value,
        num_knots = function() private$..num_knots$value,
        spline_degree = function() private$..spline_degree$value,
        hazard_scale = function() private$..hazard_scale$value,
        confidence_level = function() private$..confidence_level$value,
        show_hazard_plot = function() private$..show_hazard_plot$value,
        show_survival_plot = function() private$..show_survival_plot$value,
        show_cumulative_plot = function() private$..show_cumulative_plot$value,
        show_model_comparison = function() private$..show_model_comparison$value,
        showSummaries = function() private$..showSummaries$value,
        showExplanations = function() private$..showExplanations$value),
    private = list(
        ..elapsedtime = NA,
        ..outcome = NA,
        ..explanatory = NA,
        ..outcomeLevel = NA,
        ..knots_method = NA,
        ..num_knots = NA,
        ..spline_degree = NA,
        ..hazard_scale = NA,
        ..confidence_level = NA,
        ..show_hazard_plot = NA,
        ..show_survival_plot = NA,
        ..show_cumulative_plot = NA,
        ..show_model_comparison = NA,
        ..showSummaries = NA,
        ..showExplanations = NA)
)

splinehazardResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "splinehazardResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        modelSummary = function() private$.items[["modelSummary"]],
        parametersTable = function() private$.items[["parametersTable"]],
        knotsTable = function() private$.items[["knotsTable"]],
        modelComparison = function() private$.items[["modelComparison"]],
        hazardPlot = function() private$.items[["hazardPlot"]],
        survivalPlot = function() private$.items[["survivalPlot"]],
        cumulativePlot = function() private$.items[["cumulativePlot"]],
        splineBasisPlot = function() private$.items[["splineBasisPlot"]],
        analysisSummary = function() private$.items[["analysisSummary"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Spline-based Hazard Functions")
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="knots", 
                        `title`="Knots", 
                        `type`="integer"),
                    list(
                        `name`="degree", 
                        `title`="Degree", 
                        `type`="integer"),
                    list(
                        `name`="loglik", 
                        `title`="Log-likelihood", 
                        `type`="number"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="parametersTable",
                title="Spline Parameters",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="z_value", 
                        `title`="Z-value", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="knotsTable",
                title="Knot Locations",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="knot_number", 
                        `title`="Knot", 
                        `type`="integer"),
                    list(
                        `name`="time_location", 
                        `title`="Time Location", 
                        `type`="number"),
                    list(
                        `name`="quantile", 
                        `title`="Quantile", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelComparison",
                title="Model Comparison",
                visible="(show_model_comparison)",
                columns=list(
                    list(
                        `name`="n_knots", 
                        `title`="Knots", 
                        `type`="integer"),
                    list(
                        `name`="degree", 
                        `title`="Degree", 
                        `type`="integer"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number"),
                    list(
                        `name`="delta_aic", 
                        `title`="\u0394 AIC", 
                        `type`="number"),
                    list(
                        `name`="weight", 
                        `title`="AIC Weight", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="hazardPlot",
                title="Spline-based Hazard Function",
                visible="(show_hazard_plot)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlot",
                title="Survival Function",
                visible="(show_survival_plot)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="cumulativePlot",
                title="Cumulative Hazard Function",
                visible="(show_cumulative_plot)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="splineBasisPlot",
                title="Spline Basis Functions",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="analysisSummary",
                title="Analysis Summary",
                visible="(showSummaries)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Methodology",
                visible="(showExplanations)"))}))

splinehazardBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "splinehazardBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "splinehazard",
                version = c(1,0,0),
                options = options,
                results = splinehazardResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'na')
        }))

#' Spline-based Hazard Functions
#'
#' 
#' @param elapsedtime Time to event or censoring
#' @param outcome Event indicator (1 = event, 0 = censored)
#' @param explanatory Explanatory variables for modeling
#' @param outcomeLevel Level indicating event occurrence
#' @param knots_method Method for selecting spline knots
#' @param num_knots Number of internal knots for spline
#' @param spline_degree Polynomial degree for spline basis
#' @param hazard_scale Scale for modeling hazard function
#' @param confidence_level Confidence level for intervals
#' @param show_hazard_plot Display estimated hazard function over time
#' @param show_survival_plot Display survival curves
#' @param show_cumulative_plot Display cumulative hazard function
#' @param show_model_comparison Compare different knot configurations
#' @param showSummaries Generate natural language summaries
#' @param showExplanations Show methodology explanations
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$parametersTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$knotsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$hazardPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$survivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$cumulativePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$splineBasisPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$analysisSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelSummary$asDF}
#'
#' \code{as.data.frame(results$modelSummary)}
#'
#' @export
splinehazard <- function(
    elapsedtime,
    outcome,
    explanatory,
    outcomeLevel = "1",
    knots_method = "automatic",
    num_knots = 3,
    spline_degree = "3",
    hazard_scale = "log",
    confidence_level = 0.95,
    show_hazard_plot = TRUE,
    show_survival_plot = TRUE,
    show_cumulative_plot = FALSE,
    show_model_comparison = TRUE,
    showSummaries = FALSE,
    showExplanations = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("splinehazard requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(explanatory)) explanatory <- jmvcore::resolveQuo(jmvcore::enquo(explanatory))

    options <- splinehazardOptions$new(
        elapsedtime = elapsedtime,
        outcome = outcome,
        explanatory = explanatory,
        outcomeLevel = outcomeLevel,
        knots_method = knots_method,
        num_knots = num_knots,
        spline_degree = spline_degree,
        hazard_scale = hazard_scale,
        confidence_level = confidence_level,
        show_hazard_plot = show_hazard_plot,
        show_survival_plot = show_survival_plot,
        show_cumulative_plot = show_cumulative_plot,
        show_model_comparison = show_model_comparison,
        showSummaries = showSummaries,
        showExplanations = showExplanations)

    analysis <- splinehazardClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

