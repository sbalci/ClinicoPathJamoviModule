
# This file is automatically generated, you probably don't want to edit this

haralicktextureOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "haralicktextureOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            texture_features = NULL,
            x_coord = NULL,
            y_coord = NULL,
            group_var = NULL,
            outcome_var = NULL,
            analysis_focus = "comprehensive",
            feature_selection = "all",
            correlation_threshold = 0.9,
            normality_testing = TRUE,
            outlier_detection = TRUE,
            outlier_method = "iqr",
            show_distribution_plots = TRUE,
            show_correlation_plot = TRUE,
            show_spatial_plot = FALSE,
            texture_interpretation = "clinical",
            biomarker_context = "general", ...) {

            super$initialize(
                package="ClinicoPath",
                name="haralicktexture",
                requiresData=TRUE,
                ...)

            private$..texture_features <- jmvcore::OptionVariables$new(
                "texture_features",
                texture_features,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..x_coord <- jmvcore::OptionVariable$new(
                "x_coord",
                x_coord,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..y_coord <- jmvcore::OptionVariable$new(
                "y_coord",
                y_coord,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..group_var <- jmvcore::OptionVariable$new(
                "group_var",
                group_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..outcome_var <- jmvcore::OptionVariable$new(
                "outcome_var",
                outcome_var,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..analysis_focus <- jmvcore::OptionList$new(
                "analysis_focus",
                analysis_focus,
                options=list(
                    "descriptive",
                    "correlation",
                    "spatial",
                    "prognostic",
                    "comprehensive"),
                default="comprehensive")
            private$..feature_selection <- jmvcore::OptionList$new(
                "feature_selection",
                feature_selection,
                options=list(
                    "all",
                    "correlation_filter",
                    "variance_filter",
                    "clinical_priority"),
                default="all")
            private$..correlation_threshold <- jmvcore::OptionNumber$new(
                "correlation_threshold",
                correlation_threshold,
                min=0.7,
                max=0.99,
                default=0.9)
            private$..normality_testing <- jmvcore::OptionBool$new(
                "normality_testing",
                normality_testing,
                default=TRUE)
            private$..outlier_detection <- jmvcore::OptionBool$new(
                "outlier_detection",
                outlier_detection,
                default=TRUE)
            private$..outlier_method <- jmvcore::OptionList$new(
                "outlier_method",
                outlier_method,
                options=list(
                    "iqr",
                    "zscore",
                    "modified_zscore",
                    "isolation_forest"),
                default="iqr")
            private$..show_distribution_plots <- jmvcore::OptionBool$new(
                "show_distribution_plots",
                show_distribution_plots,
                default=TRUE)
            private$..show_correlation_plot <- jmvcore::OptionBool$new(
                "show_correlation_plot",
                show_correlation_plot,
                default=TRUE)
            private$..show_spatial_plot <- jmvcore::OptionBool$new(
                "show_spatial_plot",
                show_spatial_plot,
                default=FALSE)
            private$..texture_interpretation <- jmvcore::OptionList$new(
                "texture_interpretation",
                texture_interpretation,
                options=list(
                    "basic",
                    "clinical",
                    "research",
                    "comprehensive"),
                default="clinical")
            private$..biomarker_context <- jmvcore::OptionList$new(
                "biomarker_context",
                biomarker_context,
                options=list(
                    "ki67",
                    "her2",
                    "pdl1",
                    "cd8",
                    "general",
                    "custom"),
                default="general")

            self$.addOption(private$..texture_features)
            self$.addOption(private$..x_coord)
            self$.addOption(private$..y_coord)
            self$.addOption(private$..group_var)
            self$.addOption(private$..outcome_var)
            self$.addOption(private$..analysis_focus)
            self$.addOption(private$..feature_selection)
            self$.addOption(private$..correlation_threshold)
            self$.addOption(private$..normality_testing)
            self$.addOption(private$..outlier_detection)
            self$.addOption(private$..outlier_method)
            self$.addOption(private$..show_distribution_plots)
            self$.addOption(private$..show_correlation_plot)
            self$.addOption(private$..show_spatial_plot)
            self$.addOption(private$..texture_interpretation)
            self$.addOption(private$..biomarker_context)
        }),
    active = list(
        texture_features = function() private$..texture_features$value,
        x_coord = function() private$..x_coord$value,
        y_coord = function() private$..y_coord$value,
        group_var = function() private$..group_var$value,
        outcome_var = function() private$..outcome_var$value,
        analysis_focus = function() private$..analysis_focus$value,
        feature_selection = function() private$..feature_selection$value,
        correlation_threshold = function() private$..correlation_threshold$value,
        normality_testing = function() private$..normality_testing$value,
        outlier_detection = function() private$..outlier_detection$value,
        outlier_method = function() private$..outlier_method$value,
        show_distribution_plots = function() private$..show_distribution_plots$value,
        show_correlation_plot = function() private$..show_correlation_plot$value,
        show_spatial_plot = function() private$..show_spatial_plot$value,
        texture_interpretation = function() private$..texture_interpretation$value,
        biomarker_context = function() private$..biomarker_context$value),
    private = list(
        ..texture_features = NA,
        ..x_coord = NA,
        ..y_coord = NA,
        ..group_var = NA,
        ..outcome_var = NA,
        ..analysis_focus = NA,
        ..feature_selection = NA,
        ..correlation_threshold = NA,
        ..normality_testing = NA,
        ..outlier_detection = NA,
        ..outlier_method = NA,
        ..show_distribution_plots = NA,
        ..show_correlation_plot = NA,
        ..show_spatial_plot = NA,
        ..texture_interpretation = NA,
        ..biomarker_context = NA)
)

haralicktextureResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "haralicktextureResults",
    inherit = jmvcore::Group,
    active = list(
        interpretation = function() private$.items[["interpretation"]],
        texturetable = function() private$.items[["texturetable"]],
        correlationtable = function() private$.items[["correlationtable"]],
        groupcomparisontable = function() private$.items[["groupcomparisontable"]],
        normalitytable = function() private$.items[["normalitytable"]],
        outliertable = function() private$.items[["outliertable"]],
        distributionplot = function() private$.items[["distributionplot"]],
        heatmapplot = function() private$.items[["heatmapplot"]],
        boxplot = function() private$.items[["boxplot"]],
        clinicalrelevance = function() private$.items[["clinicalrelevance"]],
        qualityassessment = function() private$.items[["qualityassessment"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Haralick Texture Analysis")
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Context and Interpretation",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="texturetable",
                title="Texture Feature Statistics",
                columns=list(),
                clearWith=list(
                    "texture_vars",
                    "analysis_type")))
            self$add(jmvcore::Table$new(
                options=options,
                name="correlationtable",
                title="Feature Correlation Matrix",
                columns=list(),
                visible="(correlation_analysis)",
                clearWith=list(
                    "texture_vars",
                    "correlation_analysis")))
            self$add(jmvcore::Table$new(
                options=options,
                name="groupcomparisontable",
                title="Group Comparison Results",
                columns=list(),
                visible="(group_comparison && group_var)",
                clearWith=list(
                    "texture_vars",
                    "group_var",
                    "group_comparison")))
            self$add(jmvcore::Table$new(
                options=options,
                name="normalitytable",
                title="Normality Testing Results",
                columns=list(),
                visible="(normality_testing)",
                clearWith=list(
                    "texture_vars",
                    "normality_testing")))
            self$add(jmvcore::Table$new(
                options=options,
                name="outliertable",
                title="Outlier Detection Results",
                columns=list(),
                visible="(outlier_detection)",
                clearWith=list(
                    "texture_vars",
                    "outlier_detection")))
            self$add(jmvcore::Image$new(
                options=options,
                name="distributionplot",
                title="Distribution Plots",
                width=700,
                height=500,
                visible="(show_plots)",
                requiresData=TRUE,
                clearWith=list(
                    "texture_vars",
                    "show_plots")))
            self$add(jmvcore::Image$new(
                options=options,
                name="heatmapplot",
                title="Feature Correlation Heatmap",
                width=600,
                height=600,
                visible="(show_heatmaps && correlation_analysis)",
                requiresData=TRUE,
                clearWith=list(
                    "texture_vars",
                    "show_heatmaps",
                    "correlation_analysis")))
            self$add(jmvcore::Image$new(
                options=options,
                name="boxplot",
                title="Group Comparison Boxplots",
                width=600,
                height=400,
                visible="(show_plots && group_comparison && group_var)",
                requiresData=TRUE,
                clearWith=list(
                    "texture_vars",
                    "group_var",
                    "group_comparison")))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    clinicalinterpretation = function() private$.items[["clinicalinterpretation"]],
                    prognosticsummary = function() private$.items[["prognosticsummary"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="clinicalrelevance",
                            title="Clinical Relevance Assessment")
                        self$add(jmvcore::Html$new(
                            options=options,
                            name="clinicalinterpretation",
                            title="Clinical Interpretation"))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="prognosticsummary",
                            title="Prognostic Summary",
                            columns=list()))}))$new(options=options))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    missingdata = function() private$.items[["missingdata"]],
                    variability = function() private$.items[["variability"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="qualityassessment",
                            title="Data Quality Assessment")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="missingdata",
                            title="Missing Data Summary",
                            columns=list()))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="variability",
                            title="Variability Assessment",
                            columns=list()))}))$new(options=options))}))

haralicktextureBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "haralicktextureBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "haralicktexture",
                version = c(1,0,0),
                options = options,
                results = haralicktextureResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Haralick Texture Analysis
#'
#' 
#' @param data the data as a data frame
#' @param texture_features Haralick texture feature measurements (entropy,
#'   contrast, correlation, etc.)
#' @param x_coord X spatial coordinate for spatial analysis
#' @param y_coord Y spatial coordinate for spatial analysis
#' @param group_var grouping variable for stratified analysis
#' @param outcome_var clinical outcome for prognostic analysis
#' @param analysis_focus primary focus of texture analysis
#' @param feature_selection method for feature selection/filtering
#' @param correlation_threshold threshold for identifying highly correlated
#'   features
#' @param normality_testing perform normality testing for distribution
#'   assessment
#' @param outlier_detection identify and flag potential outliers
#' @param outlier_method method for outlier detection
#' @param show_distribution_plots display histograms and distribution plots
#' @param show_correlation_plot display correlation matrix heatmap
#' @param show_spatial_plot display spatial distribution plot (requires
#'   coordinates)
#' @param texture_interpretation level of interpretation and guidance provided
#' @param biomarker_context biomarker context for specialized interpretation
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$texturetable} \tab \tab \tab \tab \tab Descriptive statistics for each texture feature \cr
#'   \code{results$correlationtable} \tab \tab \tab \tab \tab Correlation between texture features \cr
#'   \code{results$groupcomparisontable} \tab \tab \tab \tab \tab Statistical comparison across groups \cr
#'   \code{results$normalitytable} \tab \tab \tab \tab \tab Shapiro-Wilk and other normality tests \cr
#'   \code{results$outliertable} \tab \tab \tab \tab \tab Identified outliers in texture features \cr
#'   \code{results$distributionplot} \tab \tab \tab \tab \tab Histogram and density plots for texture features \cr
#'   \code{results$heatmapplot} \tab \tab \tab \tab \tab Visual correlation matrix between features \cr
#'   \code{results$boxplot} \tab \tab \tab \tab \tab Boxplots comparing texture features across groups \cr
#'   \code{results$clinicalrelevance$clinicalinterpretation} \tab \tab \tab \tab \tab Context-specific clinical interpretation \cr
#'   \code{results$clinicalrelevance$prognosticsummary} \tab \tab \tab \tab \tab Prognostic relevance of texture features \cr
#'   \code{results$qualityassessment$missingdata} \tab \tab \tab \tab \tab Missing data patterns and impact \cr
#'   \code{results$qualityassessment$variability} \tab \tab \tab \tab \tab Coefficient of variation and reliability \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$texturetable$asDF}
#'
#' \code{as.data.frame(results$texturetable)}
#'
#' @export
haralicktexture <- function(
    data,
    texture_features,
    x_coord,
    y_coord,
    group_var,
    outcome_var,
    analysis_focus = "comprehensive",
    feature_selection = "all",
    correlation_threshold = 0.9,
    normality_testing = TRUE,
    outlier_detection = TRUE,
    outlier_method = "iqr",
    show_distribution_plots = TRUE,
    show_correlation_plot = TRUE,
    show_spatial_plot = FALSE,
    texture_interpretation = "clinical",
    biomarker_context = "general") {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("haralicktexture requires jmvcore to be installed (restart may be required)")

    if ( ! missing(texture_features)) texture_features <- jmvcore::resolveQuo(jmvcore::enquo(texture_features))
    if ( ! missing(x_coord)) x_coord <- jmvcore::resolveQuo(jmvcore::enquo(x_coord))
    if ( ! missing(y_coord)) y_coord <- jmvcore::resolveQuo(jmvcore::enquo(y_coord))
    if ( ! missing(group_var)) group_var <- jmvcore::resolveQuo(jmvcore::enquo(group_var))
    if ( ! missing(outcome_var)) outcome_var <- jmvcore::resolveQuo(jmvcore::enquo(outcome_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(texture_features), texture_features, NULL),
            `if`( ! missing(x_coord), x_coord, NULL),
            `if`( ! missing(y_coord), y_coord, NULL),
            `if`( ! missing(group_var), group_var, NULL),
            `if`( ! missing(outcome_var), outcome_var, NULL))

    for (v in group_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- haralicktextureOptions$new(
        texture_features = texture_features,
        x_coord = x_coord,
        y_coord = y_coord,
        group_var = group_var,
        outcome_var = outcome_var,
        analysis_focus = analysis_focus,
        feature_selection = feature_selection,
        correlation_threshold = correlation_threshold,
        normality_testing = normality_testing,
        outlier_detection = outlier_detection,
        outlier_method = outlier_method,
        show_distribution_plots = show_distribution_plots,
        show_correlation_plot = show_correlation_plot,
        show_spatial_plot = show_spatial_plot,
        texture_interpretation = texture_interpretation,
        biomarker_context = biomarker_context)

    analysis <- haralicktextureClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

