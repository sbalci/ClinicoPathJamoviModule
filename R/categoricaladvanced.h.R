
# This file is automatically generated, you probably don't want to edit this

categoricaladvancedOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "categoricaladvancedOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            rows = NULL,
            cols = NULL,
            stratify = NULL,
            test_type = "enhanced",
            fisher_exact = TRUE,
            effect_sizes = TRUE,
            association_measures = TRUE,
            residual_analysis = TRUE,
            posthoc_comparisons = FALSE,
            correction_method = "bonferroni",
            confidence_level = 0.95,
            exact_threshold = 50,
            simulation_runs = 5000,
            show_expected = TRUE,
            plot_mosaic = TRUE,
            plot_residuals = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="categoricaladvanced",
                requiresData=TRUE,
                ...)

            private$..rows <- jmvcore::OptionVariable$new(
                "rows",
                rows,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..cols <- jmvcore::OptionVariable$new(
                "cols",
                cols,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..stratify <- jmvcore::OptionVariable$new(
                "stratify",
                stratify,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..test_type <- jmvcore::OptionList$new(
                "test_type",
                test_type,
                options=list(
                    "basic",
                    "enhanced",
                    "stratified"),
                default="enhanced")
            private$..fisher_exact <- jmvcore::OptionBool$new(
                "fisher_exact",
                fisher_exact,
                default=TRUE)
            private$..effect_sizes <- jmvcore::OptionBool$new(
                "effect_sizes",
                effect_sizes,
                default=TRUE)
            private$..association_measures <- jmvcore::OptionBool$new(
                "association_measures",
                association_measures,
                default=TRUE)
            private$..residual_analysis <- jmvcore::OptionBool$new(
                "residual_analysis",
                residual_analysis,
                default=TRUE)
            private$..posthoc_comparisons <- jmvcore::OptionBool$new(
                "posthoc_comparisons",
                posthoc_comparisons,
                default=FALSE)
            private$..correction_method <- jmvcore::OptionList$new(
                "correction_method",
                correction_method,
                options=list(
                    "none",
                    "bonferroni",
                    "holm",
                    "fdr"),
                default="bonferroni")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..exact_threshold <- jmvcore::OptionInteger$new(
                "exact_threshold",
                exact_threshold,
                min=5,
                max=1000,
                default=50)
            private$..simulation_runs <- jmvcore::OptionInteger$new(
                "simulation_runs",
                simulation_runs,
                min=1000,
                max=10000,
                default=5000)
            private$..show_expected <- jmvcore::OptionBool$new(
                "show_expected",
                show_expected,
                default=TRUE)
            private$..plot_mosaic <- jmvcore::OptionBool$new(
                "plot_mosaic",
                plot_mosaic,
                default=TRUE)
            private$..plot_residuals <- jmvcore::OptionBool$new(
                "plot_residuals",
                plot_residuals,
                default=TRUE)

            self$.addOption(private$..rows)
            self$.addOption(private$..cols)
            self$.addOption(private$..stratify)
            self$.addOption(private$..test_type)
            self$.addOption(private$..fisher_exact)
            self$.addOption(private$..effect_sizes)
            self$.addOption(private$..association_measures)
            self$.addOption(private$..residual_analysis)
            self$.addOption(private$..posthoc_comparisons)
            self$.addOption(private$..correction_method)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..exact_threshold)
            self$.addOption(private$..simulation_runs)
            self$.addOption(private$..show_expected)
            self$.addOption(private$..plot_mosaic)
            self$.addOption(private$..plot_residuals)
        }),
    active = list(
        rows = function() private$..rows$value,
        cols = function() private$..cols$value,
        stratify = function() private$..stratify$value,
        test_type = function() private$..test_type$value,
        fisher_exact = function() private$..fisher_exact$value,
        effect_sizes = function() private$..effect_sizes$value,
        association_measures = function() private$..association_measures$value,
        residual_analysis = function() private$..residual_analysis$value,
        posthoc_comparisons = function() private$..posthoc_comparisons$value,
        correction_method = function() private$..correction_method$value,
        confidence_level = function() private$..confidence_level$value,
        exact_threshold = function() private$..exact_threshold$value,
        simulation_runs = function() private$..simulation_runs$value,
        show_expected = function() private$..show_expected$value,
        plot_mosaic = function() private$..plot_mosaic$value,
        plot_residuals = function() private$..plot_residuals$value),
    private = list(
        ..rows = NA,
        ..cols = NA,
        ..stratify = NA,
        ..test_type = NA,
        ..fisher_exact = NA,
        ..effect_sizes = NA,
        ..association_measures = NA,
        ..residual_analysis = NA,
        ..posthoc_comparisons = NA,
        ..correction_method = NA,
        ..confidence_level = NA,
        ..exact_threshold = NA,
        ..simulation_runs = NA,
        ..show_expected = NA,
        ..plot_mosaic = NA,
        ..plot_residuals = NA)
)

categoricaladvancedResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "categoricaladvancedResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        contingencytable = function() private$.items[["contingencytable"]],
        chisquaretest = function() private$.items[["chisquaretest"]],
        fishertest = function() private$.items[["fishertest"]],
        effectsizes = function() private$.items[["effectsizes"]],
        associations = function() private$.items[["associations"]],
        residuals = function() private$.items[["residuals"]],
        posthoc = function() private$.items[["posthoc"]],
        stratifiedanalysis = function() private$.items[["stratifiedanalysis"]],
        mosaicplot = function() private$.items[["mosaicplot"]],
        residualsplot = function() private$.items[["residualsplot"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Enhanced Chi-Square and Fisher's Tests",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Getting Started",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="contingencytable",
                title="Contingency Table",
                clearWith=list(
                    "rows",
                    "cols",
                    "stratify",
                    "show_expected"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="chisquaretest",
                title="Chi-Square Tests",
                clearWith=list(
                    "rows",
                    "cols",
                    "test_type",
                    "fisher_exact",
                    "simulation_runs"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="fishertest",
                title="Fisher's Exact Test",
                visible="(fisher_exact)",
                clearWith=list(
                    "rows",
                    "cols",
                    "stratify",
                    "simulation_runs"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="effectsizes",
                title="Effect Sizes and Association Strength",
                visible="(effect_sizes)",
                clearWith=list(
                    "rows",
                    "cols",
                    "effect_sizes",
                    "confidence_level"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="associations",
                title="Association Measures",
                visible="(association_measures)",
                clearWith=list(
                    "rows",
                    "cols",
                    "stratify",
                    "association_measures"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="residuals",
                title="Standardized Residuals",
                visible="(residual_analysis)",
                clearWith=list(
                    "rows",
                    "cols",
                    "residual_analysis"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="posthoc",
                title="Post Hoc Pairwise Comparisons",
                visible="(posthoc_comparisons)",
                clearWith=list(
                    "rows",
                    "cols",
                    "posthoc_comparisons",
                    "correction_method"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="stratifiedanalysis",
                title="Stratified Analysis Results",
                visible="(test_type:stratified && stratify)",
                clearWith=list(
                    "rows",
                    "cols",
                    "stratify",
                    "test_type"),
                columns=list()))
            self$add(jmvcore::Image$new(
                options=options,
                name="mosaicplot",
                title="Mosaic Plot",
                width=600,
                height=500,
                visible="(plot_mosaic)",
                requiresData=TRUE,
                clearWith=list(
                    "rows",
                    "cols",
                    "stratify",
                    "plot_mosaic")))
            self$add(jmvcore::Image$new(
                options=options,
                name="residualsplot",
                title="Standardized Residuals Plot",
                width=600,
                height=500,
                visible="(plot_residuals && residual_analysis)",
                requiresData=TRUE,
                clearWith=list(
                    "rows",
                    "cols",
                    "residual_analysis",
                    "plot_residuals")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation and Guidelines",
                visible=TRUE))}))

categoricaladvancedBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "categoricaladvancedBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "categoricaladvanced",
                version = c(1,0,0),
                options = options,
                results = categoricaladvancedResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Enhanced Chi-Square and Fisher's Tests
#'
#' Enhanced categorical analysis with chi-square tests, Fisher's exact tests, 
#' effect sizes, and association measures. Addresses the critical issue where 
#' 25\% of pathology studies use categorical analysis incorrectly.
#' 
#'
#' @examples
#' data('histopathology')
#'
#' categoricaladvanced(data = histopathology,
#'                    rows = tumor_type,
#'                    cols = grade)
#'
#' @param data the data as a data frame
#' @param rows Row variable for the contingency table
#' @param cols Column variable for the contingency table
#' @param stratify Optional stratification variable for Mantel-Haenszel tests
#' @param test_type Type of categorical analysis to perform
#' @param fisher_exact Perform Fisher's exact test when appropriate
#' @param effect_sizes Calculate effect sizes (Cramér's V, phi coefficient,
#'   Cohen's w)
#' @param association_measures Calculate association measures (Lambda, Tau,
#'   Gamma)
#' @param residual_analysis Perform standardized residual analysis
#' @param posthoc_comparisons Perform pairwise comparisons for tables larger
#'   than 2×2
#' @param correction_method Multiple testing correction method
#' @param confidence_level Confidence level for effect size intervals
#' @param exact_threshold Maximum total sample size for automatic exact tests
#' @param simulation_runs Number of Monte Carlo simulations for exact p-values
#' @param show_expected Display expected frequencies in contingency table
#' @param plot_mosaic Generate mosaic plot showing association patterns
#' @param plot_residuals Generate standardized residuals plot
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$contingencytable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$chisquaretest} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$fishertest} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$effectsizes} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$associations} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$residuals} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$posthoc} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$stratifiedanalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$mosaicplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$residualsplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$contingencytable$asDF}
#'
#' \code{as.data.frame(results$contingencytable)}
#'
#' @export
categoricaladvanced <- function(
    data,
    rows,
    cols,
    stratify,
    test_type = "enhanced",
    fisher_exact = TRUE,
    effect_sizes = TRUE,
    association_measures = TRUE,
    residual_analysis = TRUE,
    posthoc_comparisons = FALSE,
    correction_method = "bonferroni",
    confidence_level = 0.95,
    exact_threshold = 50,
    simulation_runs = 5000,
    show_expected = TRUE,
    plot_mosaic = TRUE,
    plot_residuals = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("categoricaladvanced requires jmvcore to be installed (restart may be required)")

    if ( ! missing(rows)) rows <- jmvcore::resolveQuo(jmvcore::enquo(rows))
    if ( ! missing(cols)) cols <- jmvcore::resolveQuo(jmvcore::enquo(cols))
    if ( ! missing(stratify)) stratify <- jmvcore::resolveQuo(jmvcore::enquo(stratify))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(rows), rows, NULL),
            `if`( ! missing(cols), cols, NULL),
            `if`( ! missing(stratify), stratify, NULL))

    for (v in rows) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in cols) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in stratify) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- categoricaladvancedOptions$new(
        rows = rows,
        cols = cols,
        stratify = stratify,
        test_type = test_type,
        fisher_exact = fisher_exact,
        effect_sizes = effect_sizes,
        association_measures = association_measures,
        residual_analysis = residual_analysis,
        posthoc_comparisons = posthoc_comparisons,
        correction_method = correction_method,
        confidence_level = confidence_level,
        exact_threshold = exact_threshold,
        simulation_runs = simulation_runs,
        show_expected = show_expected,
        plot_mosaic = plot_mosaic,
        plot_residuals = plot_residuals)

    analysis <- categoricaladvancedClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

