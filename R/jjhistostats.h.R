
# This file is automatically generated, you probably don't want to edit this

jjhistostatsOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jjhistostatsOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            dep = NULL,
            grvar = NULL,
            typestatistics = "parametric",
            centralityline = FALSE,
            changebinwidth = FALSE,
            binwidth = 1.1,
            resultssubtitle = FALSE,
            showInterpretation = FALSE,
            clinicalPreset = "custom",
            test.value = 0,
            conf.level = 0.95,
            bf.message = FALSE,
            digits = 2,
            xlab = "",
            title = "",
            subtitle = "",
            caption = "",
            centralitytype = "default",
            binfill = "skyblue",
            bincolor = "black",
            binalpha = 0.7,
            centralitylinecolor = "blue",
            centralitylinewidth = 1,
            centralitylinetype = "dashed",
            plotwidth = 600,
            plotheight = 450,
            addGGPubrPlot = FALSE,
            ggpubrPalette = "#0073C2FF",
            ggpubrAddDensity = TRUE,
            ggpubrAddMean = FALSE,
            addDistributionDiagnostics = FALSE,
            ggpubrDensityColor = "#0073C2FF",
            ggpubrShowQQ = TRUE,
            ggpubrShowECDF = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="jjhistostats",
                requiresData=TRUE,
                ...)

            private$..dep <- jmvcore::OptionVariables$new(
                "dep",
                dep,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..grvar <- jmvcore::OptionVariable$new(
                "grvar",
                grvar,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..typestatistics <- jmvcore::OptionList$new(
                "typestatistics",
                typestatistics,
                options=list(
                    "parametric",
                    "nonparametric",
                    "robust",
                    "bayes"),
                default="parametric")
            private$..centralityline <- jmvcore::OptionBool$new(
                "centralityline",
                centralityline,
                default=FALSE)
            private$..changebinwidth <- jmvcore::OptionBool$new(
                "changebinwidth",
                changebinwidth,
                default=FALSE)
            private$..binwidth <- jmvcore::OptionNumber$new(
                "binwidth",
                binwidth,
                default=1.1)
            private$..resultssubtitle <- jmvcore::OptionBool$new(
                "resultssubtitle",
                resultssubtitle,
                default=FALSE)
            private$..showInterpretation <- jmvcore::OptionBool$new(
                "showInterpretation",
                showInterpretation,
                default=FALSE)
            private$..clinicalPreset <- jmvcore::OptionList$new(
                "clinicalPreset",
                clinicalPreset,
                options=list(
                    "custom",
                    "lab_values",
                    "biomarkers",
                    "patient_chars",
                    "pathology_scores"),
                default="custom")
            private$..test.value <- jmvcore::OptionNumber$new(
                "test.value",
                test.value,
                default=0)
            private$..conf.level <- jmvcore::OptionNumber$new(
                "conf.level",
                conf.level,
                default=0.95,
                min=0,
                max=1)
            private$..bf.message <- jmvcore::OptionBool$new(
                "bf.message",
                bf.message,
                default=FALSE)
            private$..digits <- jmvcore::OptionInteger$new(
                "digits",
                digits,
                default=2,
                min=0,
                max=5)
            private$..xlab <- jmvcore::OptionString$new(
                "xlab",
                xlab,
                default="")
            private$..title <- jmvcore::OptionString$new(
                "title",
                title,
                default="")
            private$..subtitle <- jmvcore::OptionString$new(
                "subtitle",
                subtitle,
                default="")
            private$..caption <- jmvcore::OptionString$new(
                "caption",
                caption,
                default="")
            private$..centralitytype <- jmvcore::OptionList$new(
                "centralitytype",
                centralitytype,
                options=list(
                    "default",
                    "parametric",
                    "nonparametric",
                    "robust",
                    "bayes"),
                default="default")
            private$..binfill <- jmvcore::OptionString$new(
                "binfill",
                binfill,
                default="skyblue")
            private$..bincolor <- jmvcore::OptionString$new(
                "bincolor",
                bincolor,
                default="black")
            private$..binalpha <- jmvcore::OptionNumber$new(
                "binalpha",
                binalpha,
                default=0.7,
                min=0,
                max=1)
            private$..centralitylinecolor <- jmvcore::OptionString$new(
                "centralitylinecolor",
                centralitylinecolor,
                default="blue")
            private$..centralitylinewidth <- jmvcore::OptionNumber$new(
                "centralitylinewidth",
                centralitylinewidth,
                default=1,
                min=0.1,
                max=5)
            private$..centralitylinetype <- jmvcore::OptionList$new(
                "centralitylinetype",
                centralitylinetype,
                options=list(
                    "solid",
                    "dashed",
                    "dotted",
                    "dotdash",
                    "longdash",
                    "twodash"),
                default="dashed")
            private$..plotwidth <- jmvcore::OptionInteger$new(
                "plotwidth",
                plotwidth,
                default=600,
                min=300,
                max=1200)
            private$..plotheight <- jmvcore::OptionInteger$new(
                "plotheight",
                plotheight,
                default=450,
                min=300,
                max=800)
            private$..addGGPubrPlot <- jmvcore::OptionBool$new(
                "addGGPubrPlot",
                addGGPubrPlot,
                default=FALSE)
            private$..ggpubrPalette <- jmvcore::OptionString$new(
                "ggpubrPalette",
                ggpubrPalette,
                default="#0073C2FF")
            private$..ggpubrAddDensity <- jmvcore::OptionBool$new(
                "ggpubrAddDensity",
                ggpubrAddDensity,
                default=TRUE)
            private$..ggpubrAddMean <- jmvcore::OptionBool$new(
                "ggpubrAddMean",
                ggpubrAddMean,
                default=FALSE)
            private$..addDistributionDiagnostics <- jmvcore::OptionBool$new(
                "addDistributionDiagnostics",
                addDistributionDiagnostics,
                default=FALSE)
            private$..ggpubrDensityColor <- jmvcore::OptionString$new(
                "ggpubrDensityColor",
                ggpubrDensityColor,
                default="#0073C2FF")
            private$..ggpubrShowQQ <- jmvcore::OptionBool$new(
                "ggpubrShowQQ",
                ggpubrShowQQ,
                default=TRUE)
            private$..ggpubrShowECDF <- jmvcore::OptionBool$new(
                "ggpubrShowECDF",
                ggpubrShowECDF,
                default=TRUE)

            self$.addOption(private$..dep)
            self$.addOption(private$..grvar)
            self$.addOption(private$..typestatistics)
            self$.addOption(private$..centralityline)
            self$.addOption(private$..changebinwidth)
            self$.addOption(private$..binwidth)
            self$.addOption(private$..resultssubtitle)
            self$.addOption(private$..showInterpretation)
            self$.addOption(private$..clinicalPreset)
            self$.addOption(private$..test.value)
            self$.addOption(private$..conf.level)
            self$.addOption(private$..bf.message)
            self$.addOption(private$..digits)
            self$.addOption(private$..xlab)
            self$.addOption(private$..title)
            self$.addOption(private$..subtitle)
            self$.addOption(private$..caption)
            self$.addOption(private$..centralitytype)
            self$.addOption(private$..binfill)
            self$.addOption(private$..bincolor)
            self$.addOption(private$..binalpha)
            self$.addOption(private$..centralitylinecolor)
            self$.addOption(private$..centralitylinewidth)
            self$.addOption(private$..centralitylinetype)
            self$.addOption(private$..plotwidth)
            self$.addOption(private$..plotheight)
            self$.addOption(private$..addGGPubrPlot)
            self$.addOption(private$..ggpubrPalette)
            self$.addOption(private$..ggpubrAddDensity)
            self$.addOption(private$..ggpubrAddMean)
            self$.addOption(private$..addDistributionDiagnostics)
            self$.addOption(private$..ggpubrDensityColor)
            self$.addOption(private$..ggpubrShowQQ)
            self$.addOption(private$..ggpubrShowECDF)
        }),
    active = list(
        dep = function() private$..dep$value,
        grvar = function() private$..grvar$value,
        typestatistics = function() private$..typestatistics$value,
        centralityline = function() private$..centralityline$value,
        changebinwidth = function() private$..changebinwidth$value,
        binwidth = function() private$..binwidth$value,
        resultssubtitle = function() private$..resultssubtitle$value,
        showInterpretation = function() private$..showInterpretation$value,
        clinicalPreset = function() private$..clinicalPreset$value,
        test.value = function() private$..test.value$value,
        conf.level = function() private$..conf.level$value,
        bf.message = function() private$..bf.message$value,
        digits = function() private$..digits$value,
        xlab = function() private$..xlab$value,
        title = function() private$..title$value,
        subtitle = function() private$..subtitle$value,
        caption = function() private$..caption$value,
        centralitytype = function() private$..centralitytype$value,
        binfill = function() private$..binfill$value,
        bincolor = function() private$..bincolor$value,
        binalpha = function() private$..binalpha$value,
        centralitylinecolor = function() private$..centralitylinecolor$value,
        centralitylinewidth = function() private$..centralitylinewidth$value,
        centralitylinetype = function() private$..centralitylinetype$value,
        plotwidth = function() private$..plotwidth$value,
        plotheight = function() private$..plotheight$value,
        addGGPubrPlot = function() private$..addGGPubrPlot$value,
        ggpubrPalette = function() private$..ggpubrPalette$value,
        ggpubrAddDensity = function() private$..ggpubrAddDensity$value,
        ggpubrAddMean = function() private$..ggpubrAddMean$value,
        addDistributionDiagnostics = function() private$..addDistributionDiagnostics$value,
        ggpubrDensityColor = function() private$..ggpubrDensityColor$value,
        ggpubrShowQQ = function() private$..ggpubrShowQQ$value,
        ggpubrShowECDF = function() private$..ggpubrShowECDF$value),
    private = list(
        ..dep = NA,
        ..grvar = NA,
        ..typestatistics = NA,
        ..centralityline = NA,
        ..changebinwidth = NA,
        ..binwidth = NA,
        ..resultssubtitle = NA,
        ..showInterpretation = NA,
        ..clinicalPreset = NA,
        ..test.value = NA,
        ..conf.level = NA,
        ..bf.message = NA,
        ..digits = NA,
        ..xlab = NA,
        ..title = NA,
        ..subtitle = NA,
        ..caption = NA,
        ..centralitytype = NA,
        ..binfill = NA,
        ..bincolor = NA,
        ..binalpha = NA,
        ..centralitylinecolor = NA,
        ..centralitylinewidth = NA,
        ..centralitylinetype = NA,
        ..plotwidth = NA,
        ..plotheight = NA,
        ..addGGPubrPlot = NA,
        ..ggpubrPalette = NA,
        ..ggpubrAddDensity = NA,
        ..ggpubrAddMean = NA,
        ..addDistributionDiagnostics = NA,
        ..ggpubrDensityColor = NA,
        ..ggpubrShowQQ = NA,
        ..ggpubrShowECDF = NA)
)

jjhistostatsResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jjhistostatsResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        plot2 = function() private$.items[["plot2"]],
        plot = function() private$.items[["plot"]],
        interpretation = function() private$.items[["interpretation"]],
        ggpubrPlot = function() private$.items[["ggpubrPlot"]],
        ggpubrPlot2 = function() private$.items[["ggpubrPlot2"]],
        densityPlot = function() private$.items[["densityPlot"]],
        qqPlot = function() private$.items[["qqPlot"]],
        ecdfPlot = function() private$.items[["ecdfPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Histogram",
                refs=list(
                    "ggplot2",
                    "ggstatsplot",
                    "ggpubr",
                    "ClinicoPathJamoviModule",
                    "digest",
                    "glue",
                    "purrr"),
                clearWith=list(
                    "dep",
                    "grvar",
                    "typestatistics",
                    "changebinwidth",
                    "binwidth",
                    "centralityline",
                    "centralitytype",
                    "resultssubtitle",
                    "test.value",
                    "conf.level",
                    "bf.message",
                    "binfill",
                    "bincolor",
                    "binalpha",
                    "centralitylinecolor",
                    "centralitylinewidth",
                    "centralitylinetype",
                    "plotwidth",
                    "plotheight",
                    "xlab",
                    "title",
                    "subtitle",
                    "caption",
                    "digits",
                    "showInterpretation",
                    "clinicalPreset"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="To Do"))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot2",
                title="`Histogram Splitted by {grvar}`",
                renderFun=".plot2",
                requiresData=TRUE,
                visible="(grvar)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot",
                title="Histogram",
                renderFun=".plot",
                requiresData=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation",
                visible="(showInterpretation)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="ggpubrPlot",
                title="Publication-Ready Histogram (ggpubr)",
                width=600,
                height=450,
                renderFun=".plotGGPubr",
                requiresData=TRUE,
                visible="(addGGPubrPlot)",
                clearWith=list(
                    "dep",
                    "ggpubrPalette",
                    "ggpubrAddDensity",
                    "ggpubrAddMean")))
            self$add(jmvcore::Image$new(
                options=options,
                name="ggpubrPlot2",
                title="`Publication-Ready Histogram by ${grvar} (ggpubr)`",
                width=1200,
                height=450,
                renderFun=".plotGGPubr2",
                requiresData=TRUE,
                visible="(addGGPubrPlot && grvar)",
                clearWith=list(
                    "dep",
                    "grvar",
                    "ggpubrPalette",
                    "ggpubrAddDensity",
                    "ggpubrAddMean")))
            self$add(jmvcore::Image$new(
                options=options,
                name="densityPlot",
                title="Density Plot (ggpubr)",
                width=600,
                height=400,
                renderFun=".plotDensity",
                requiresData=TRUE,
                visible="(addDistributionDiagnostics)",
                clearWith=list(
                    "dep",
                    "ggpubrDensityColor")))
            self$add(jmvcore::Image$new(
                options=options,
                name="qqPlot",
                title="QQ Plot - Normality Assessment (ggpubr)",
                width=600,
                height=400,
                renderFun=".plotQQ",
                requiresData=TRUE,
                visible="(addDistributionDiagnostics && ggpubrShowQQ)",
                clearWith=list(
                    "dep")))
            self$add(jmvcore::Image$new(
                options=options,
                name="ecdfPlot",
                title="Empirical CDF (ggpubr)",
                width=600,
                height=400,
                renderFun=".plotECDF",
                requiresData=TRUE,
                visible="(addDistributionDiagnostics && ggpubrShowECDF)",
                clearWith=list(
                    "dep")))}))

jjhistostatsBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "jjhistostatsBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "jjhistostats",
                version = c(0,0,31),
                options = options,
                results = jjhistostatsResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Histogram
#'
#' 'Wrapper Function for ggstatsplot::gghistostats and
#' ggstatsplot::grouped_gghistostats to generate Histogram.'
#' 
#'
#' @examples
#' \donttest{
#' # Load test data
#' data(jjhistostats_test_data)
#'
#' # Basic histogram
#' jjhistostats(
#'   data = jjhistostats_test_data,
#'   dep = "age_years",
#'   typestatistics = "parametric"
#' )
#'
#' # Multiple histograms
#' jjhistostats(
#'   data = jjhistostats_test_data,
#'   dep = c("age_years", "tumor_size_mm", "bmi"),
#'   centralityline = TRUE,
#'   resultssubtitle = TRUE
#' )
#'
#' # Grouped histogram by disease stage
#' jjhistostats(
#'   data = jjhistostats_test_data,
#'   dep = "psa_level",
#'   grvar = "disease_stage",
#'   typestatistics = "nonparametric",
#'   changebinwidth = TRUE,
#'   binwidth = 2.0
#' )
#'}
#' @param data The data as a data frame.
#' @param dep One or more continuous numeric variables for which histograms
#'   will be created. Multiple variables will be displayed in separate panels.
#' @param grvar Optional grouping variable to create separate histograms for
#'   each level of this variable (grouped analysis).
#' @param typestatistics Type of statistical test for normality assessment.
#'   'parametric' uses Shapiro-Wilk test, 'nonparametric' uses Anderson-Darling
#'   test, 'robust' uses robust normality tests, 'bayes' provides Bayesian
#'   analysis.
#' @param centralityline Whether to display a vertical line indicating the
#'   measure of central tendency (mean for parametric, median for
#'   nonparametric).
#' @param changebinwidth Whether to manually specify the bin width. If FALSE,
#'   automatic bin width calculation will be used.
#' @param binwidth Manual bin width for histogram. Only used when
#'   changebinwidth is TRUE. Smaller values create more bins, larger values
#'   create fewer bins.
#' @param resultssubtitle Whether to display statistical test results as
#'   subtitle in the plot, including normality test results and descriptive
#'   statistics.
#' @param showInterpretation Generate clinical interpretation of histogram
#'   results including distribution shape,  normality assessment, and practical
#'   implications for clinical data.
#' @param clinicalPreset Predefined configurations optimized for common
#'   clinical data types. Automatically sets appropriate statistical methods and
#'   visualization options.
#' @param test.value Value to compare the sample against in one-sample test.
#'   Default is 0.
#' @param conf.level Confidence level for confidence intervals (between 0 and
#'   1).
#' @param bf.message Whether to display Bayes Factor in the subtitle when
#'   using Bayesian analysis.
#' @param digits Number of decimal places for displaying statistics in the
#'   subtitle.
#' @param xlab Custom label for the x-axis. If empty, variable name will be
#'   used.
#' @param title Title for the plot.
#' @param subtitle Subtitle for the plot (overrides statistical results if
#'   provided).
#' @param caption Caption text to display at the bottom of the plot.
#' @param centralitytype Type of central tendency measure to display.
#'   'Default' uses the appropriate measure based on the statistical test type
#'   selected.
#' @param binfill Fill color for histogram bins.
#' @param bincolor Border color for histogram bins.
#' @param binalpha Transparency level for histogram bins (0 = fully
#'   transparent, 1 = opaque).
#' @param centralitylinecolor Color of the vertical centrality line.
#' @param centralitylinewidth Width of the vertical centrality line.
#' @param centralitylinetype Line type for the vertical centrality line.
#' @param plotwidth Width of each plot in pixels. Default is 600.
#' @param plotheight Height of each plot in pixels. Default is 450.
#' @param addGGPubrPlot Add publication-ready histogram using ggpubr package.
#' @param ggpubrPalette Fill color for ggpubr histogram (hex code).
#' @param ggpubrAddDensity Add density curve overlay to ggpubr histogram.
#' @param ggpubrAddMean Add vertical line at mean for ggpubr histogram.
#' @param addDistributionDiagnostics Add density plot, ECDF, and QQ plot for
#'   distribution assessment using ggpubr.
#' @param ggpubrDensityColor Fill color for density plot (hex code).
#' @param ggpubrShowQQ Show QQ plot for normality assessment.
#' @param ggpubrShowECDF Show empirical cumulative distribution function plot.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$plot2} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$ggpubrPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$ggpubrPlot2} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$densityPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$qqPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$ecdfPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' @export
jjhistostats <- function(
    data,
    dep,
    grvar,
    typestatistics = "parametric",
    centralityline = FALSE,
    changebinwidth = FALSE,
    binwidth = 1.1,
    resultssubtitle = FALSE,
    showInterpretation = FALSE,
    clinicalPreset = "custom",
    test.value = 0,
    conf.level = 0.95,
    bf.message = FALSE,
    digits = 2,
    xlab = "",
    title = "",
    subtitle = "",
    caption = "",
    centralitytype = "default",
    binfill = "skyblue",
    bincolor = "black",
    binalpha = 0.7,
    centralitylinecolor = "blue",
    centralitylinewidth = 1,
    centralitylinetype = "dashed",
    plotwidth = 600,
    plotheight = 450,
    addGGPubrPlot = FALSE,
    ggpubrPalette = "#0073C2FF",
    ggpubrAddDensity = TRUE,
    ggpubrAddMean = FALSE,
    addDistributionDiagnostics = FALSE,
    ggpubrDensityColor = "#0073C2FF",
    ggpubrShowQQ = TRUE,
    ggpubrShowECDF = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("jjhistostats requires jmvcore to be installed (restart may be required)")

    if ( ! missing(dep)) dep <- jmvcore::resolveQuo(jmvcore::enquo(dep))
    if ( ! missing(grvar)) grvar <- jmvcore::resolveQuo(jmvcore::enquo(grvar))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(dep), dep, NULL),
            `if`( ! missing(grvar), grvar, NULL))

    for (v in grvar) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- jjhistostatsOptions$new(
        dep = dep,
        grvar = grvar,
        typestatistics = typestatistics,
        centralityline = centralityline,
        changebinwidth = changebinwidth,
        binwidth = binwidth,
        resultssubtitle = resultssubtitle,
        showInterpretation = showInterpretation,
        clinicalPreset = clinicalPreset,
        test.value = test.value,
        conf.level = conf.level,
        bf.message = bf.message,
        digits = digits,
        xlab = xlab,
        title = title,
        subtitle = subtitle,
        caption = caption,
        centralitytype = centralitytype,
        binfill = binfill,
        bincolor = bincolor,
        binalpha = binalpha,
        centralitylinecolor = centralitylinecolor,
        centralitylinewidth = centralitylinewidth,
        centralitylinetype = centralitylinetype,
        plotwidth = plotwidth,
        plotheight = plotheight,
        addGGPubrPlot = addGGPubrPlot,
        ggpubrPalette = ggpubrPalette,
        ggpubrAddDensity = ggpubrAddDensity,
        ggpubrAddMean = ggpubrAddMean,
        addDistributionDiagnostics = addDistributionDiagnostics,
        ggpubrDensityColor = ggpubrDensityColor,
        ggpubrShowQQ = ggpubrShowQQ,
        ggpubrShowECDF = ggpubrShowECDF)

    analysis <- jjhistostatsClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

