
# This file is automatically generated, you probably don't want to edit this

bayesianmetaanalysisOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "bayesianmetaanalysisOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            effectSize = NULL,
            standardError = NULL,
            studyId = NULL,
            covariates = NULL,
            modelType = "random_effects",
            outcomeType = "continuous",
            priorType = "weakly_informative",
            mcmcChains = 4,
            mcmcIterations = 5000,
            warmupIterations = 2500,
            credibleInterval = 0.95,
            publicationBias = FALSE,
            posteriorPredictive = TRUE,
            plotForest = TRUE,
            plotPosterior = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="bayesianmetaanalysis",
                requiresData=TRUE,
                ...)

            private$..effectSize <- jmvcore::OptionVariable$new(
                "effectSize",
                effectSize,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..standardError <- jmvcore::OptionVariable$new(
                "standardError",
                standardError,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..studyId <- jmvcore::OptionVariable$new(
                "studyId",
                studyId,
                suggested=list(
                    "nominal",
                    "id"),
                permitted=list(
                    "factor",
                    "id"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..modelType <- jmvcore::OptionList$new(
                "modelType",
                modelType,
                options=list(
                    "fixed_effects",
                    "random_effects",
                    "hierarchical"),
                default="random_effects")
            private$..outcomeType <- jmvcore::OptionList$new(
                "outcomeType",
                outcomeType,
                options=list(
                    "continuous",
                    "binary",
                    "time_to_event",
                    "correlation"),
                default="continuous")
            private$..priorType <- jmvcore::OptionList$new(
                "priorType",
                priorType,
                options=list(
                    "non_informative",
                    "weakly_informative",
                    "informative",
                    "empirical_bayes"),
                default="weakly_informative")
            private$..mcmcChains <- jmvcore::OptionInteger$new(
                "mcmcChains",
                mcmcChains,
                min=1,
                max=8,
                default=4)
            private$..mcmcIterations <- jmvcore::OptionInteger$new(
                "mcmcIterations",
                mcmcIterations,
                min=1000,
                max=50000,
                default=5000)
            private$..warmupIterations <- jmvcore::OptionInteger$new(
                "warmupIterations",
                warmupIterations,
                min=500,
                max=25000,
                default=2500)
            private$..credibleInterval <- jmvcore::OptionNumber$new(
                "credibleInterval",
                credibleInterval,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..publicationBias <- jmvcore::OptionBool$new(
                "publicationBias",
                publicationBias,
                default=FALSE)
            private$..posteriorPredictive <- jmvcore::OptionBool$new(
                "posteriorPredictive",
                posteriorPredictive,
                default=TRUE)
            private$..plotForest <- jmvcore::OptionBool$new(
                "plotForest",
                plotForest,
                default=TRUE)
            private$..plotPosterior <- jmvcore::OptionBool$new(
                "plotPosterior",
                plotPosterior,
                default=TRUE)

            self$.addOption(private$..effectSize)
            self$.addOption(private$..standardError)
            self$.addOption(private$..studyId)
            self$.addOption(private$..covariates)
            self$.addOption(private$..modelType)
            self$.addOption(private$..outcomeType)
            self$.addOption(private$..priorType)
            self$.addOption(private$..mcmcChains)
            self$.addOption(private$..mcmcIterations)
            self$.addOption(private$..warmupIterations)
            self$.addOption(private$..credibleInterval)
            self$.addOption(private$..publicationBias)
            self$.addOption(private$..posteriorPredictive)
            self$.addOption(private$..plotForest)
            self$.addOption(private$..plotPosterior)
        }),
    active = list(
        effectSize = function() private$..effectSize$value,
        standardError = function() private$..standardError$value,
        studyId = function() private$..studyId$value,
        covariates = function() private$..covariates$value,
        modelType = function() private$..modelType$value,
        outcomeType = function() private$..outcomeType$value,
        priorType = function() private$..priorType$value,
        mcmcChains = function() private$..mcmcChains$value,
        mcmcIterations = function() private$..mcmcIterations$value,
        warmupIterations = function() private$..warmupIterations$value,
        credibleInterval = function() private$..credibleInterval$value,
        publicationBias = function() private$..publicationBias$value,
        posteriorPredictive = function() private$..posteriorPredictive$value,
        plotForest = function() private$..plotForest$value,
        plotPosterior = function() private$..plotPosterior$value),
    private = list(
        ..effectSize = NA,
        ..standardError = NA,
        ..studyId = NA,
        ..covariates = NA,
        ..modelType = NA,
        ..outcomeType = NA,
        ..priorType = NA,
        ..mcmcChains = NA,
        ..mcmcIterations = NA,
        ..warmupIterations = NA,
        ..credibleInterval = NA,
        ..publicationBias = NA,
        ..posteriorPredictive = NA,
        ..plotForest = NA,
        ..plotPosterior = NA)
)

bayesianmetaanalysisResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "bayesianmetaanalysisResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        modelSummary = function() private$.items[["modelSummary"]],
        studyEffects = function() private$.items[["studyEffects"]],
        mcmcDiagnostics = function() private$.items[["mcmcDiagnostics"]],
        modelComparison = function() private$.items[["modelComparison"]],
        publicationBiasResults = function() private$.items[["publicationBiasResults"]],
        forestPlot = function() private$.items[["forestPlot"]],
        posteriorPlot = function() private$.items[["posteriorPlot"]],
        analysisReport = function() private$.items[["analysisReport"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Bayesian Meta-Analysis")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="posterior_mean", 
                        `title`="Posterior Mean", 
                        `type`="number"),
                    list(
                        `name`="posterior_sd", 
                        `title`="Posterior SD", 
                        `type`="number"),
                    list(
                        `name`="credible_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="credible_upper", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="effective_sample_size", 
                        `title`="ESS", 
                        `type`="number"),
                    list(
                        `name`="rhat", 
                        `title`="R-hat", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="studyEffects",
                title="Study Effects",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="study", 
                        `title`="Study", 
                        `type`="text"),
                    list(
                        `name`="observed_effect", 
                        `title`="Observed Effect", 
                        `type`="number"),
                    list(
                        `name`="posterior_effect", 
                        `title`="Posterior Effect", 
                        `type`="number"),
                    list(
                        `name`="credible_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="credible_upper", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="mcmcDiagnostics",
                title="MCMC Diagnostics",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="n_effective", 
                        `title`="Effective Sample Size", 
                        `type`="number"),
                    list(
                        `name`="rhat", 
                        `title`="R-hat", 
                        `type`="number"),
                    list(
                        `name`="mcmc_se", 
                        `title`="MCMC SE", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelComparison",
                title="Model Comparison",
                visible="(modelType:hierarchical)",
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="waic", 
                        `title`="WAIC", 
                        `type`="number"),
                    list(
                        `name`="looic", 
                        `title`="LOOIC", 
                        `type`="number"),
                    list(
                        `name`="effective_params", 
                        `title`="Effective Parameters", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="publicationBiasResults",
                title="Publication Bias Assessment",
                visible="(publicationBias)",
                columns=list(
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="forestPlot",
                title="Bayesian Forest Plot",
                visible="(plotForest)",
                width=700,
                height=500,
                renderFun=".forestPlot"))
            self$add(jmvcore::Image$new(
                options=options,
                name="posteriorPlot",
                title="Posterior Distributions",
                visible="(plotPosterior)",
                width=600,
                height=400,
                renderFun=".posteriorPlot"))
            self$add(jmvcore::Html$new(
                options=options,
                name="analysisReport",
                title="Analysis Report",
                visible=TRUE))}))

bayesianmetaanalysisBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "bayesianmetaanalysisBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "bayesianmetaanalysis",
                version = c(1,0,0),
                options = options,
                results = bayesianmetaanalysisResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Bayesian Meta-Analysis
#'
#' Performs Bayesian meta-analysis using hierarchical models for evidence 
#' synthesis across multiple studies. This approach accounts for both 
#' within-study and between-study variability using informative prior 
#' distributions and MCMC sampling methods.
#' 
#' Key features:
#' - Random effects and fixed effects Bayesian meta-analysis
#' - Multiple outcome types (continuous, binary, time-to-event)
#' - Hierarchical modeling with informative and non-informative priors
#' - MCMC sampling with convergence diagnostics
#' - Posterior predictive checking and model comparison
#' - Meta-regression with study-level covariates
#' - Publication bias assessment and adjustment
#' 
#'
#' @examples
#' # Bayesian meta-analysis of treatment effects
#' bayesianmetaanalysis(
#'     data = data,
#'     effectSize = "effect",
#'     standardError = "se",
#'     studyId = "study",
#'     modelType = "random_effects",
#'     outcomeType = "continuous"
#' )
#'
#' @param data the data as a data frame
#' @param effectSize the effect size variable (e.g., mean difference, log odds
#'   ratio)
#' @param standardError the standard error of the effect size
#' @param studyId variable identifying individual studies
#' @param covariates study-level covariates for meta-regression
#' @param modelType the type of meta-analysis model to fit
#' @param outcomeType the type of outcome being meta-analyzed
#' @param priorType the type of prior distribution to use
#' @param mcmcChains number of MCMC chains for posterior sampling
#' @param mcmcIterations number of MCMC iterations per chain
#' @param warmupIterations number of warmup (burn-in) iterations per chain
#' @param credibleInterval credible interval probability
#' @param publicationBias whether to assess and adjust for publication bias
#' @param posteriorPredictive whether to perform posterior predictive model
#'   checking
#' @param plotForest whether to create Bayesian forest plot
#' @param plotPosterior whether to plot posterior distributions
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$studyEffects} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$mcmcDiagnostics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$publicationBiasResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$forestPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$posteriorPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$analysisReport} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelSummary$asDF}
#'
#' \code{as.data.frame(results$modelSummary)}
#'
#' @export
bayesianmetaanalysis <- function(
    data,
    effectSize,
    standardError,
    studyId,
    covariates,
    modelType = "random_effects",
    outcomeType = "continuous",
    priorType = "weakly_informative",
    mcmcChains = 4,
    mcmcIterations = 5000,
    warmupIterations = 2500,
    credibleInterval = 0.95,
    publicationBias = FALSE,
    posteriorPredictive = TRUE,
    plotForest = TRUE,
    plotPosterior = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("bayesianmetaanalysis requires jmvcore to be installed (restart may be required)")

    if ( ! missing(effectSize)) effectSize <- jmvcore::resolveQuo(jmvcore::enquo(effectSize))
    if ( ! missing(standardError)) standardError <- jmvcore::resolveQuo(jmvcore::enquo(standardError))
    if ( ! missing(studyId)) studyId <- jmvcore::resolveQuo(jmvcore::enquo(studyId))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(effectSize), effectSize, NULL),
            `if`( ! missing(standardError), standardError, NULL),
            `if`( ! missing(studyId), studyId, NULL),
            `if`( ! missing(covariates), covariates, NULL))


    options <- bayesianmetaanalysisOptions$new(
        effectSize = effectSize,
        standardError = standardError,
        studyId = studyId,
        covariates = covariates,
        modelType = modelType,
        outcomeType = outcomeType,
        priorType = priorType,
        mcmcChains = mcmcChains,
        mcmcIterations = mcmcIterations,
        warmupIterations = warmupIterations,
        credibleInterval = credibleInterval,
        publicationBias = publicationBias,
        posteriorPredictive = posteriorPredictive,
        plotForest = plotForest,
        plotPosterior = plotPosterior)

    analysis <- bayesianmetaanalysisClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

