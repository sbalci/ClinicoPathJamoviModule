
# This file is automatically generated, you probably don't want to edit this

measurementuncertaintyOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "measurementuncertaintyOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            measurement = NULL,
            reference_value = NULL,
            replicate_group = NULL,
            calibrator = NULL,
            operator = NULL,
            instrument = NULL,
            uncertainty_method = "gum_approach",
            confidence_level = 0.95,
            coverage_factor = 2,
            type_a_components = "repeatability,intermediate_precision,operator_variability",
            type_b_components = "calibration_uncertainty,reference_material_uncertainty,temperature_effects",
            calibration_uncertainty = 1,
            reference_material_uncertainty = 0.5,
            temperature_uncertainty = 0.1,
            pipetting_uncertainty = 0.2,
            sample_stability_uncertainty = 0.3,
            matrix_effects_uncertainty = 0.2,
            monte_carlo_simulations = 100000,
            distribution_types = "normal,uniform,triangular",
            correlation_analysis = TRUE,
            sensitivity_analysis = TRUE,
            budget_optimization = TRUE,
            measurement_model = TRUE,
            validation_experiments = FALSE,
            proficiency_testing_data = FALSE,
            interlaboratory_comparison = FALSE,
            clinical_significance = TRUE,
            iso15189_compliance = TRUE,
            uncertainty_plots = TRUE,
            budget_plots = TRUE,
            monte_carlo_plots = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="measurementuncertainty",
                requiresData=TRUE,
                ...)

            private$..measurement <- jmvcore::OptionVariable$new(
                "measurement",
                measurement,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..reference_value <- jmvcore::OptionVariable$new(
                "reference_value",
                reference_value,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..replicate_group <- jmvcore::OptionVariable$new(
                "replicate_group",
                replicate_group,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..calibrator <- jmvcore::OptionVariable$new(
                "calibrator",
                calibrator,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..operator <- jmvcore::OptionVariable$new(
                "operator",
                operator,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..instrument <- jmvcore::OptionVariable$new(
                "instrument",
                instrument,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..uncertainty_method <- jmvcore::OptionList$new(
                "uncertainty_method",
                uncertainty_method,
                options=list(
                    "gum_approach",
                    "monte_carlo",
                    "top_down",
                    "bottom_up",
                    "combined_approach"),
                default="gum_approach")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.9,
                max=0.99,
                default=0.95)
            private$..coverage_factor <- jmvcore::OptionNumber$new(
                "coverage_factor",
                coverage_factor,
                min=1.5,
                max=3,
                default=2)
            private$..type_a_components <- jmvcore::OptionString$new(
                "type_a_components",
                type_a_components,
                default="repeatability,intermediate_precision,operator_variability")
            private$..type_b_components <- jmvcore::OptionString$new(
                "type_b_components",
                type_b_components,
                default="calibration_uncertainty,reference_material_uncertainty,temperature_effects")
            private$..calibration_uncertainty <- jmvcore::OptionNumber$new(
                "calibration_uncertainty",
                calibration_uncertainty,
                min=0,
                max=10,
                default=1)
            private$..reference_material_uncertainty <- jmvcore::OptionNumber$new(
                "reference_material_uncertainty",
                reference_material_uncertainty,
                min=0,
                max=5,
                default=0.5)
            private$..temperature_uncertainty <- jmvcore::OptionNumber$new(
                "temperature_uncertainty",
                temperature_uncertainty,
                min=0,
                max=2,
                default=0.1)
            private$..pipetting_uncertainty <- jmvcore::OptionNumber$new(
                "pipetting_uncertainty",
                pipetting_uncertainty,
                min=0,
                max=2,
                default=0.2)
            private$..sample_stability_uncertainty <- jmvcore::OptionNumber$new(
                "sample_stability_uncertainty",
                sample_stability_uncertainty,
                min=0,
                max=5,
                default=0.3)
            private$..matrix_effects_uncertainty <- jmvcore::OptionNumber$new(
                "matrix_effects_uncertainty",
                matrix_effects_uncertainty,
                min=0,
                max=3,
                default=0.2)
            private$..monte_carlo_simulations <- jmvcore::OptionInteger$new(
                "monte_carlo_simulations",
                monte_carlo_simulations,
                min=10000,
                max=1000000,
                default=100000)
            private$..distribution_types <- jmvcore::OptionString$new(
                "distribution_types",
                distribution_types,
                default="normal,uniform,triangular")
            private$..correlation_analysis <- jmvcore::OptionBool$new(
                "correlation_analysis",
                correlation_analysis,
                default=TRUE)
            private$..sensitivity_analysis <- jmvcore::OptionBool$new(
                "sensitivity_analysis",
                sensitivity_analysis,
                default=TRUE)
            private$..budget_optimization <- jmvcore::OptionBool$new(
                "budget_optimization",
                budget_optimization,
                default=TRUE)
            private$..measurement_model <- jmvcore::OptionBool$new(
                "measurement_model",
                measurement_model,
                default=TRUE)
            private$..validation_experiments <- jmvcore::OptionBool$new(
                "validation_experiments",
                validation_experiments,
                default=FALSE)
            private$..proficiency_testing_data <- jmvcore::OptionBool$new(
                "proficiency_testing_data",
                proficiency_testing_data,
                default=FALSE)
            private$..interlaboratory_comparison <- jmvcore::OptionBool$new(
                "interlaboratory_comparison",
                interlaboratory_comparison,
                default=FALSE)
            private$..clinical_significance <- jmvcore::OptionBool$new(
                "clinical_significance",
                clinical_significance,
                default=TRUE)
            private$..iso15189_compliance <- jmvcore::OptionBool$new(
                "iso15189_compliance",
                iso15189_compliance,
                default=TRUE)
            private$..uncertainty_plots <- jmvcore::OptionBool$new(
                "uncertainty_plots",
                uncertainty_plots,
                default=TRUE)
            private$..budget_plots <- jmvcore::OptionBool$new(
                "budget_plots",
                budget_plots,
                default=TRUE)
            private$..monte_carlo_plots <- jmvcore::OptionBool$new(
                "monte_carlo_plots",
                monte_carlo_plots,
                default=TRUE)

            self$.addOption(private$..measurement)
            self$.addOption(private$..reference_value)
            self$.addOption(private$..replicate_group)
            self$.addOption(private$..calibrator)
            self$.addOption(private$..operator)
            self$.addOption(private$..instrument)
            self$.addOption(private$..uncertainty_method)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..coverage_factor)
            self$.addOption(private$..type_a_components)
            self$.addOption(private$..type_b_components)
            self$.addOption(private$..calibration_uncertainty)
            self$.addOption(private$..reference_material_uncertainty)
            self$.addOption(private$..temperature_uncertainty)
            self$.addOption(private$..pipetting_uncertainty)
            self$.addOption(private$..sample_stability_uncertainty)
            self$.addOption(private$..matrix_effects_uncertainty)
            self$.addOption(private$..monte_carlo_simulations)
            self$.addOption(private$..distribution_types)
            self$.addOption(private$..correlation_analysis)
            self$.addOption(private$..sensitivity_analysis)
            self$.addOption(private$..budget_optimization)
            self$.addOption(private$..measurement_model)
            self$.addOption(private$..validation_experiments)
            self$.addOption(private$..proficiency_testing_data)
            self$.addOption(private$..interlaboratory_comparison)
            self$.addOption(private$..clinical_significance)
            self$.addOption(private$..iso15189_compliance)
            self$.addOption(private$..uncertainty_plots)
            self$.addOption(private$..budget_plots)
            self$.addOption(private$..monte_carlo_plots)
        }),
    active = list(
        measurement = function() private$..measurement$value,
        reference_value = function() private$..reference_value$value,
        replicate_group = function() private$..replicate_group$value,
        calibrator = function() private$..calibrator$value,
        operator = function() private$..operator$value,
        instrument = function() private$..instrument$value,
        uncertainty_method = function() private$..uncertainty_method$value,
        confidence_level = function() private$..confidence_level$value,
        coverage_factor = function() private$..coverage_factor$value,
        type_a_components = function() private$..type_a_components$value,
        type_b_components = function() private$..type_b_components$value,
        calibration_uncertainty = function() private$..calibration_uncertainty$value,
        reference_material_uncertainty = function() private$..reference_material_uncertainty$value,
        temperature_uncertainty = function() private$..temperature_uncertainty$value,
        pipetting_uncertainty = function() private$..pipetting_uncertainty$value,
        sample_stability_uncertainty = function() private$..sample_stability_uncertainty$value,
        matrix_effects_uncertainty = function() private$..matrix_effects_uncertainty$value,
        monte_carlo_simulations = function() private$..monte_carlo_simulations$value,
        distribution_types = function() private$..distribution_types$value,
        correlation_analysis = function() private$..correlation_analysis$value,
        sensitivity_analysis = function() private$..sensitivity_analysis$value,
        budget_optimization = function() private$..budget_optimization$value,
        measurement_model = function() private$..measurement_model$value,
        validation_experiments = function() private$..validation_experiments$value,
        proficiency_testing_data = function() private$..proficiency_testing_data$value,
        interlaboratory_comparison = function() private$..interlaboratory_comparison$value,
        clinical_significance = function() private$..clinical_significance$value,
        iso15189_compliance = function() private$..iso15189_compliance$value,
        uncertainty_plots = function() private$..uncertainty_plots$value,
        budget_plots = function() private$..budget_plots$value,
        monte_carlo_plots = function() private$..monte_carlo_plots$value),
    private = list(
        ..measurement = NA,
        ..reference_value = NA,
        ..replicate_group = NA,
        ..calibrator = NA,
        ..operator = NA,
        ..instrument = NA,
        ..uncertainty_method = NA,
        ..confidence_level = NA,
        ..coverage_factor = NA,
        ..type_a_components = NA,
        ..type_b_components = NA,
        ..calibration_uncertainty = NA,
        ..reference_material_uncertainty = NA,
        ..temperature_uncertainty = NA,
        ..pipetting_uncertainty = NA,
        ..sample_stability_uncertainty = NA,
        ..matrix_effects_uncertainty = NA,
        ..monte_carlo_simulations = NA,
        ..distribution_types = NA,
        ..correlation_analysis = NA,
        ..sensitivity_analysis = NA,
        ..budget_optimization = NA,
        ..measurement_model = NA,
        ..validation_experiments = NA,
        ..proficiency_testing_data = NA,
        ..interlaboratory_comparison = NA,
        ..clinical_significance = NA,
        ..iso15189_compliance = NA,
        ..uncertainty_plots = NA,
        ..budget_plots = NA,
        ..monte_carlo_plots = NA)
)

measurementuncertaintyResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "measurementuncertaintyResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        summary = function() private$.items[["summary"]],
        uncertaintyResults = function() private$.items[["uncertaintyResults"]],
        budgetTable = function() private$.items[["budgetTable"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Measurement Uncertainty Estimation",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Analysis Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="summary",
                title="Data Summary",
                rows=1,
                clearWith=list(
                    "measurement"),
                columns=list(
                    list(
                        `name`="characteristic", 
                        `title`="Characteristic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="uncertaintyResults",
                title="Uncertainty Evaluation Results",
                rows=1,
                clearWith=list(
                    "measurement",
                    "calibration_uncertainty",
                    "reference_material_uncertainty"),
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="unit", 
                        `title`="Unit", 
                        `type`="text"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="budgetTable",
                title="Uncertainty Budget",
                rows=1,
                clearWith=list(
                    "measurement"),
                columns=list(
                    list(
                        `name`="source", 
                        `title`="Source of Uncertainty", 
                        `type`="text"),
                    list(
                        `name`="type", 
                        `title`="Type", 
                        `type`="text"),
                    list(
                        `name`="distribution", 
                        `title`="Distribution", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Standard Uncertainty (u)", 
                        `type`="number"),
                    list(
                        `name`="contribution", 
                        `title`="Contribution (%)", 
                        `type`="number"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Method and Clinical Context",
                visible=TRUE))}))

measurementuncertaintyBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "measurementuncertaintyBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "measurementuncertainty",
                version = c(1,0,0),
                options = options,
                results = measurementuncertaintyResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Measurement Uncertainty Estimation
#'
#' Comprehensive measurement uncertainty evaluation following ISO/IEC Guide 
#' 98-3 (GUM), and JCGM 100:2008 guidelines. Calculates Type A and Type B 
#' uncertainties, combined and expanded uncertainty, and uncertainty budgets 
#' for clinical laboratory measurements. Essential for laboratory 
#' accreditation and quality assurance.
#' 
#'
#' @examples
#' data \%>\%
#' measurementuncertainty(
#'     measurement = "glucose_result",
#'     reference_value = "certified_value",
#'     replicate_group = "measurement_run",
#'     uncertainty_method = "gum_approach"
#' )
#'
#' @param data the data as a data frame
#' @param measurement Laboratory measurement values for uncertainty analysis
#' @param reference_value Reference or certified values for bias estimation
#' @param replicate_group Identifier for measurement replicates or runs
#' @param calibrator Calibrator or standard identifier
#' @param operator Operator identifier for operator variability
#' @param instrument Instrument identifier for instrument variability
#' @param uncertainty_method Method for measurement uncertainty evaluation
#' @param confidence_level Confidence level for expanded uncertainty
#' @param coverage_factor Coverage factor for expanded uncertainty calculation
#' @param type_a_components Comma-separated list of Type A uncertainty
#'   components
#' @param type_b_components Comma-separated list of Type B uncertainty
#'   components
#' @param calibration_uncertainty Relative uncertainty from calibration
#' @param reference_material_uncertainty Uncertainty of reference materials
#' @param temperature_uncertainty Uncertainty due to temperature variations
#' @param pipetting_uncertainty Uncertainty from pipetting operations
#' @param sample_stability_uncertainty Uncertainty due to sample stability
#' @param matrix_effects_uncertainty Uncertainty from matrix effects
#' @param monte_carlo_simulations Number of Monte Carlo simulations
#' @param distribution_types Distribution types for uncertainty components
#' @param correlation_analysis Analyze correlations between uncertainty
#'   components
#' @param sensitivity_analysis Perform sensitivity analysis of uncertainty
#'   components
#' @param budget_optimization Optimize uncertainty budget for
#'   cost-effectiveness
#' @param measurement_model Define and validate measurement model
#' @param validation_experiments Design experiments to validate uncertainty
#'   estimates
#' @param proficiency_testing_data Incorporate proficiency testing results
#' @param interlaboratory_comparison Compare uncertainty with other
#'   laboratories
#' @param clinical_significance Evaluate clinical significance of uncertainty
#' @param iso15189_compliance Verify compliance with laboratory accreditation
#'   requirements
#' @param uncertainty_plots Generate uncertainty analysis plots
#' @param budget_plots Create uncertainty budget visualizations
#' @param monte_carlo_plots Generate Monte Carlo simulation plots
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$uncertaintyResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$budgetTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summary$asDF}
#'
#' \code{as.data.frame(results$summary)}
#'
#' @export
measurementuncertainty <- function(
    data,
    measurement,
    reference_value,
    replicate_group,
    calibrator,
    operator,
    instrument,
    uncertainty_method = "gum_approach",
    confidence_level = 0.95,
    coverage_factor = 2,
    type_a_components = "repeatability,intermediate_precision,operator_variability",
    type_b_components = "calibration_uncertainty,reference_material_uncertainty,temperature_effects",
    calibration_uncertainty = 1,
    reference_material_uncertainty = 0.5,
    temperature_uncertainty = 0.1,
    pipetting_uncertainty = 0.2,
    sample_stability_uncertainty = 0.3,
    matrix_effects_uncertainty = 0.2,
    monte_carlo_simulations = 100000,
    distribution_types = "normal,uniform,triangular",
    correlation_analysis = TRUE,
    sensitivity_analysis = TRUE,
    budget_optimization = TRUE,
    measurement_model = TRUE,
    validation_experiments = FALSE,
    proficiency_testing_data = FALSE,
    interlaboratory_comparison = FALSE,
    clinical_significance = TRUE,
    iso15189_compliance = TRUE,
    uncertainty_plots = TRUE,
    budget_plots = TRUE,
    monte_carlo_plots = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("measurementuncertainty requires jmvcore to be installed (restart may be required)")

    if ( ! missing(measurement)) measurement <- jmvcore::resolveQuo(jmvcore::enquo(measurement))
    if ( ! missing(reference_value)) reference_value <- jmvcore::resolveQuo(jmvcore::enquo(reference_value))
    if ( ! missing(replicate_group)) replicate_group <- jmvcore::resolveQuo(jmvcore::enquo(replicate_group))
    if ( ! missing(calibrator)) calibrator <- jmvcore::resolveQuo(jmvcore::enquo(calibrator))
    if ( ! missing(operator)) operator <- jmvcore::resolveQuo(jmvcore::enquo(operator))
    if ( ! missing(instrument)) instrument <- jmvcore::resolveQuo(jmvcore::enquo(instrument))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(measurement), measurement, NULL),
            `if`( ! missing(reference_value), reference_value, NULL),
            `if`( ! missing(replicate_group), replicate_group, NULL),
            `if`( ! missing(calibrator), calibrator, NULL),
            `if`( ! missing(operator), operator, NULL),
            `if`( ! missing(instrument), instrument, NULL))

    for (v in calibrator) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in operator) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in instrument) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- measurementuncertaintyOptions$new(
        measurement = measurement,
        reference_value = reference_value,
        replicate_group = replicate_group,
        calibrator = calibrator,
        operator = operator,
        instrument = instrument,
        uncertainty_method = uncertainty_method,
        confidence_level = confidence_level,
        coverage_factor = coverage_factor,
        type_a_components = type_a_components,
        type_b_components = type_b_components,
        calibration_uncertainty = calibration_uncertainty,
        reference_material_uncertainty = reference_material_uncertainty,
        temperature_uncertainty = temperature_uncertainty,
        pipetting_uncertainty = pipetting_uncertainty,
        sample_stability_uncertainty = sample_stability_uncertainty,
        matrix_effects_uncertainty = matrix_effects_uncertainty,
        monte_carlo_simulations = monte_carlo_simulations,
        distribution_types = distribution_types,
        correlation_analysis = correlation_analysis,
        sensitivity_analysis = sensitivity_analysis,
        budget_optimization = budget_optimization,
        measurement_model = measurement_model,
        validation_experiments = validation_experiments,
        proficiency_testing_data = proficiency_testing_data,
        interlaboratory_comparison = interlaboratory_comparison,
        clinical_significance = clinical_significance,
        iso15189_compliance = iso15189_compliance,
        uncertainty_plots = uncertainty_plots,
        budget_plots = budget_plots,
        monte_carlo_plots = monte_carlo_plots)

    analysis <- measurementuncertaintyClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

