
# This file is automatically generated, you probably don't want to edit this

parametricfrailtyOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "parametricfrailtyOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            outcome = NULL,
            covariates = NULL,
            frailty_variable = NULL,
            baseline_distribution = "weibull",
            frailty_distribution = "gamma",
            estimation_method = "penalized_likelihood",
            include_se = TRUE,
            include_ci = TRUE,
            conf_level = 0.95,
            frailty_variance = TRUE,
            frailty_predictions = FALSE,
            gof_tests = FALSE,
            plot_hazard = FALSE,
            plot_survival = FALSE,
            plot_frailty = FALSE,
            plot_diagnostics = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="parametricfrailty",
                requiresData=TRUE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..frailty_variable <- jmvcore::OptionVariable$new(
                "frailty_variable",
                frailty_variable,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..baseline_distribution <- jmvcore::OptionList$new(
                "baseline_distribution",
                baseline_distribution,
                options=list(
                    "weibull",
                    "exponential",
                    "gompertz",
                    "lognormal",
                    "loglogistic",
                    "gengamma"),
                default="weibull")
            private$..frailty_distribution <- jmvcore::OptionList$new(
                "frailty_distribution",
                frailty_distribution,
                options=list(
                    "gamma",
                    "lognormal",
                    "invgauss",
                    "posstab"),
                default="gamma")
            private$..estimation_method <- jmvcore::OptionList$new(
                "estimation_method",
                estimation_method,
                options=list(
                    "penalized_likelihood",
                    "reml",
                    "laplace"),
                default="penalized_likelihood")
            private$..include_se <- jmvcore::OptionBool$new(
                "include_se",
                include_se,
                default=TRUE)
            private$..include_ci <- jmvcore::OptionBool$new(
                "include_ci",
                include_ci,
                default=TRUE)
            private$..conf_level <- jmvcore::OptionNumber$new(
                "conf_level",
                conf_level,
                default=0.95,
                min=0.5,
                max=0.99)
            private$..frailty_variance <- jmvcore::OptionBool$new(
                "frailty_variance",
                frailty_variance,
                default=TRUE)
            private$..frailty_predictions <- jmvcore::OptionBool$new(
                "frailty_predictions",
                frailty_predictions,
                default=FALSE)
            private$..gof_tests <- jmvcore::OptionBool$new(
                "gof_tests",
                gof_tests,
                default=FALSE)
            private$..plot_hazard <- jmvcore::OptionBool$new(
                "plot_hazard",
                plot_hazard,
                default=FALSE)
            private$..plot_survival <- jmvcore::OptionBool$new(
                "plot_survival",
                plot_survival,
                default=FALSE)
            private$..plot_frailty <- jmvcore::OptionBool$new(
                "plot_frailty",
                plot_frailty,
                default=FALSE)
            private$..plot_diagnostics <- jmvcore::OptionBool$new(
                "plot_diagnostics",
                plot_diagnostics,
                default=FALSE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..outcome)
            self$.addOption(private$..covariates)
            self$.addOption(private$..frailty_variable)
            self$.addOption(private$..baseline_distribution)
            self$.addOption(private$..frailty_distribution)
            self$.addOption(private$..estimation_method)
            self$.addOption(private$..include_se)
            self$.addOption(private$..include_ci)
            self$.addOption(private$..conf_level)
            self$.addOption(private$..frailty_variance)
            self$.addOption(private$..frailty_predictions)
            self$.addOption(private$..gof_tests)
            self$.addOption(private$..plot_hazard)
            self$.addOption(private$..plot_survival)
            self$.addOption(private$..plot_frailty)
            self$.addOption(private$..plot_diagnostics)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        outcome = function() private$..outcome$value,
        covariates = function() private$..covariates$value,
        frailty_variable = function() private$..frailty_variable$value,
        baseline_distribution = function() private$..baseline_distribution$value,
        frailty_distribution = function() private$..frailty_distribution$value,
        estimation_method = function() private$..estimation_method$value,
        include_se = function() private$..include_se$value,
        include_ci = function() private$..include_ci$value,
        conf_level = function() private$..conf_level$value,
        frailty_variance = function() private$..frailty_variance$value,
        frailty_predictions = function() private$..frailty_predictions$value,
        gof_tests = function() private$..gof_tests$value,
        plot_hazard = function() private$..plot_hazard$value,
        plot_survival = function() private$..plot_survival$value,
        plot_frailty = function() private$..plot_frailty$value,
        plot_diagnostics = function() private$..plot_diagnostics$value),
    private = list(
        ..elapsedtime = NA,
        ..outcome = NA,
        ..covariates = NA,
        ..frailty_variable = NA,
        ..baseline_distribution = NA,
        ..frailty_distribution = NA,
        ..estimation_method = NA,
        ..include_se = NA,
        ..include_ci = NA,
        ..conf_level = NA,
        ..frailty_variance = NA,
        ..frailty_predictions = NA,
        ..gof_tests = NA,
        ..plot_hazard = NA,
        ..plot_survival = NA,
        ..plot_frailty = NA,
        ..plot_diagnostics = NA)
)

parametricfrailtyResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "parametricfrailtyResults",
    inherit = jmvcore::Group,
    active = list(
        overview = function() private$.items[["overview"]],
        model_fit = function() private$.items[["model_fit"]],
        coefficients = function() private$.items[["coefficients"]],
        frailty_summary = function() private$.items[["frailty_summary"]],
        frailty_predictions_table = function() private$.items[["frailty_predictions_table"]],
        gof_table = function() private$.items[["gof_table"]],
        hazard_plot = function() private$.items[["hazard_plot"]],
        survival_plot = function() private$.items[["survival_plot"]],
        frailty_plot = function() private$.items[["frailty_plot"]],
        diagnostics_plot = function() private$.items[["diagnostics_plot"]],
        model_summary = function() private$.items[["model_summary"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Parametric Frailty Models",
                refs="survival - ClinicoPathJamoviModule")
            self$add(jmvcore::Table$new(
                options=options,
                name="overview",
                title="Analysis Overview",
                clearWith=list(
                    "outcome",
                    "explanatory",
                    "frailty",
                    "baseline_distribution",
                    "frailty_distribution",
                    "estimation_method"),
                columns=list(
                    list(
                        `name`="analysis", 
                        `title`="Analysis", 
                        `type`="text"),
                    list(
                        `name`="outcome", 
                        `title`="Outcome Variable", 
                        `type`="text"),
                    list(
                        `name`="n_subjects", 
                        `title`="Number of Subjects", 
                        `type`="integer"),
                    list(
                        `name`="n_events", 
                        `title`="Number of Events", 
                        `type`="integer"),
                    list(
                        `name`="frailty_groups", 
                        `title`="Frailty Groups", 
                        `type`="integer"),
                    list(
                        `name`="baseline_dist", 
                        `title`="Baseline Distribution", 
                        `type`="text"),
                    list(
                        `name`="frailty_dist", 
                        `title`="Frailty Distribution", 
                        `type`="text"),
                    list(
                        `name`="estimation", 
                        `title`="Estimation Method", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="model_fit",
                title="Model Fit Statistics",
                clearWith=list(
                    "outcome",
                    "explanatory",
                    "frailty",
                    "baseline_distribution",
                    "frailty_distribution",
                    "estimation_method"),
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="coefficients",
                title="Model Coefficients",
                clearWith=list(
                    "outcome",
                    "explanatory",
                    "frailty",
                    "baseline_distribution",
                    "frailty_distribution",
                    "estimation_method",
                    "include_se",
                    "include_ci",
                    "conf_level"),
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(include_se)"),
                    list(
                        `name`="z_stat", 
                        `title`="Z", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(include_se)"),
                    list(
                        `name`="p_value", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue", 
                        `visible`="(include_se)"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(include_ci)"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(include_ci)"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="frailty_summary",
                title="Frailty Summary",
                clearWith=list(
                    "outcome",
                    "explanatory",
                    "frailty",
                    "baseline_distribution",
                    "frailty_distribution",
                    "estimation_method",
                    "frailty_variance"),
                visible="(frailty_variance)",
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="variance", 
                        `title`="Variance", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="se_variance", 
                        `title`="SE(Variance)", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="theta", 
                        `title`="\u03B8 (Heterogeneity)", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="kendall_tau", 
                        `title`="Kendall's \u03C4", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="frailty_predictions_table",
                title="Individual Frailty Predictions",
                clearWith=list(
                    "outcome",
                    "explanatory",
                    "frailty",
                    "baseline_distribution",
                    "frailty_distribution",
                    "estimation_method",
                    "frailty_predictions"),
                visible="(frailty_predictions)",
                columns=list(
                    list(
                        `name`="subject", 
                        `title`="Subject/Group", 
                        `type`="text"),
                    list(
                        `name`="frailty_pred", 
                        `title`="Frailty Prediction", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="se_pred", 
                        `title`="SE(Prediction)", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="lower_pred", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="upper_pred", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="gof_table",
                title="Goodness-of-Fit Tests",
                clearWith=list(
                    "outcome",
                    "explanatory",
                    "frailty",
                    "baseline_distribution",
                    "frailty_distribution",
                    "estimation_method",
                    "gof_tests"),
                visible="(gof_tests)",
                columns=list(
                    list(
                        `name`="test", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Test Statistic", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="hazard_plot",
                title="Hazard Function",
                clearWith=list(
                    "outcome",
                    "explanatory",
                    "frailty",
                    "baseline_distribution",
                    "frailty_distribution",
                    "estimation_method",
                    "plot_hazard"),
                visible="(plot_hazard)",
                renderFun=".plot_hazard"))
            self$add(jmvcore::Image$new(
                options=options,
                name="survival_plot",
                title="Survival Function",
                clearWith=list(
                    "outcome",
                    "explanatory",
                    "frailty",
                    "baseline_distribution",
                    "frailty_distribution",
                    "estimation_method",
                    "plot_survival"),
                visible="(plot_survival)",
                renderFun=".plot_survival"))
            self$add(jmvcore::Image$new(
                options=options,
                name="frailty_plot",
                title="Frailty Distribution",
                clearWith=list(
                    "outcome",
                    "explanatory",
                    "frailty",
                    "baseline_distribution",
                    "frailty_distribution",
                    "estimation_method",
                    "plot_frailty"),
                visible="(plot_frailty)",
                renderFun=".plot_frailty"))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagnostics_plot",
                title="Diagnostic Plots",
                clearWith=list(
                    "outcome",
                    "explanatory",
                    "frailty",
                    "baseline_distribution",
                    "frailty_distribution",
                    "estimation_method",
                    "plot_diagnostics"),
                visible="(plot_diagnostics)",
                renderFun=".plot_diagnostics"))
            self$add(jmvcore::Html$new(
                options=options,
                name="model_summary",
                title="Model Summary",
                clearWith=list(
                    "outcome",
                    "explanatory",
                    "frailty",
                    "baseline_distribution",
                    "frailty_distribution",
                    "estimation_method")))}))

parametricfrailtyBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "parametricfrailtyBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "parametricfrailty",
                version = c(0,0,31),
                options = options,
                results = parametricfrailtyResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Parametric Frailty Models
#'
#' Implements parametric frailty models for survival analysis with clustered 
#' or correlated survival data. Uses the frailtySurv package for efficient 
#' estimation of parametric baseline distributions combined with frailty 
#' components to model unobserved heterogeneity between clusters or 
#' individuals.
#' 
#'
#' @examples
#' data('lung', package='survival')
#'
#' parametricfrailty(data = lung,
#'                  elapsedtime = 'time',
#'                  outcome = 'status',
#'                  covariates = c('age', 'sex'),
#'                  frailty_variable = 'inst',
#'                  baseline_distribution = 'weibull',
#'                  frailty_distribution = 'gamma')
#'
#' @param data the data as a data frame
#' @param elapsedtime Survival time or follow-up duration variable. Should
#'   contain positive  numeric values representing the time to event or
#'   censoring.
#' @param outcome Binary event indicator variable. Should contain values like
#'   0/1,  FALSE/TRUE, or factor levels indicating whether event occurred.
#' @param covariates Vector of variable names for covariates/explanatory
#'   variables to include  in the parametric frailty model.
#' @param frailty_variable Variable identifying clusters or groups for frailty
#'   modeling. Each unique value represents a different cluster/group with
#'   shared frailty.
#' @param baseline_distribution Baseline parametric distribution for survival
#'   times.
#' @param frailty_distribution Distribution of the frailty random effects.
#' @param estimation_method Method for parameter estimation in the frailty
#'   model.
#' @param include_se Whether to compute and display standard errors for
#'   parameter estimates.
#' @param include_ci Whether to compute and display confidence intervals for
#'   parameter estimates.
#' @param conf_level Confidence level for confidence intervals (between 0.5
#'   and 0.99).
#' @param frailty_variance Whether to estimate and display frailty variance
#'   components.
#' @param frailty_predictions Whether to compute individual frailty
#'   predictions for each cluster.
#' @param gof_tests Whether to perform goodness-of-fit tests for the fitted
#'   model.
#' @param plot_hazard Whether to create plots of the estimated hazard
#'   function.
#' @param plot_survival Whether to create plots of the estimated survival
#'   function.
#' @param plot_frailty Whether to create plots of the frailty distribution.
#' @param plot_diagnostics Whether to create model diagnostic plots for
#'   residuals and fit assessment.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$overview} \tab \tab \tab \tab \tab Overview of the parametric frailty model analysis \cr
#'   \code{results$model_fit} \tab \tab \tab \tab \tab Model fit statistics for the parametric frailty model \cr
#'   \code{results$coefficients} \tab \tab \tab \tab \tab Parameter estimates for the parametric frailty model \cr
#'   \code{results$frailty_summary} \tab \tab \tab \tab \tab Summary statistics for frailty terms \cr
#'   \code{results$frailty_predictions_table} \tab \tab \tab \tab \tab Individual frailty predictions for each subject/group \cr
#'   \code{results$gof_table} \tab \tab \tab \tab \tab Goodness-of-fit tests for the parametric frailty model \cr
#'   \code{results$hazard_plot} \tab \tab \tab \tab \tab Plot of the estimated hazard function \cr
#'   \code{results$survival_plot} \tab \tab \tab \tab \tab Plot of the estimated survival function \cr
#'   \code{results$frailty_plot} \tab \tab \tab \tab \tab Plot of the frailty distribution \cr
#'   \code{results$diagnostics_plot} \tab \tab \tab \tab \tab Model diagnostic plots \cr
#'   \code{results$model_summary} \tab \tab \tab \tab \tab Comprehensive model summary and interpretation \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$overview$asDF}
#'
#' \code{as.data.frame(results$overview)}
#'
#' @export
parametricfrailty <- function(
    data,
    elapsedtime,
    outcome,
    covariates = NULL,
    frailty_variable,
    baseline_distribution = "weibull",
    frailty_distribution = "gamma",
    estimation_method = "penalized_likelihood",
    include_se = TRUE,
    include_ci = TRUE,
    conf_level = 0.95,
    frailty_variance = TRUE,
    frailty_predictions = FALSE,
    gof_tests = FALSE,
    plot_hazard = FALSE,
    plot_survival = FALSE,
    plot_frailty = FALSE,
    plot_diagnostics = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("parametricfrailty requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(frailty_variable)) frailty_variable <- jmvcore::resolveQuo(jmvcore::enquo(frailty_variable))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(elapsedtime), elapsedtime, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(covariates), covariates, NULL),
            `if`( ! missing(frailty_variable), frailty_variable, NULL))


    options <- parametricfrailtyOptions$new(
        elapsedtime = elapsedtime,
        outcome = outcome,
        covariates = covariates,
        frailty_variable = frailty_variable,
        baseline_distribution = baseline_distribution,
        frailty_distribution = frailty_distribution,
        estimation_method = estimation_method,
        include_se = include_se,
        include_ci = include_ci,
        conf_level = conf_level,
        frailty_variance = frailty_variance,
        frailty_predictions = frailty_predictions,
        gof_tests = gof_tests,
        plot_hazard = plot_hazard,
        plot_survival = plot_survival,
        plot_frailty = plot_frailty,
        plot_diagnostics = plot_diagnostics)

    analysis <- parametricfrailtyClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

