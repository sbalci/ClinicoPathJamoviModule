
# This file is automatically generated, you probably don't want to edit this

timeupdatesurvivalOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "timeupdatesurvivalOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            status = NULL,
            covariates = NULL,
            id = NULL,
            update_times = "0.5, 1, 2, 5",
            method = "aalen_additive",
            smoothing_method = "lowess",
            bandwidth = 0.5,
            degrees_freedom = 4,
            confidence_level = 0.95,
            prediction_horizon = 5,
            bootstrap_samples = 200,
            include_residuals = TRUE,
            dynamic_prediction = TRUE,
            individual_profiles = FALSE,
            significance_testing = TRUE,
            model_comparison = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="timeupdatesurvival",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..status <- jmvcore::OptionVariable$new(
                "status",
                status,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..id <- jmvcore::OptionVariable$new(
                "id",
                id,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..update_times <- jmvcore::OptionString$new(
                "update_times",
                update_times,
                default="0.5, 1, 2, 5")
            private$..method <- jmvcore::OptionList$new(
                "method",
                method,
                options=list(
                    "aalen_additive",
                    "cox_time_varying",
                    "smoothing_splines",
                    "kernel_weighted",
                    "local_likelihood"),
                default="aalen_additive")
            private$..smoothing_method <- jmvcore::OptionList$new(
                "smoothing_method",
                smoothing_method,
                options=list(
                    "lowess",
                    "splines",
                    "kernel",
                    "local_regression"),
                default="lowess")
            private$..bandwidth <- jmvcore::OptionNumber$new(
                "bandwidth",
                bandwidth,
                min=0.1,
                max=2,
                default=0.5)
            private$..degrees_freedom <- jmvcore::OptionInteger$new(
                "degrees_freedom",
                degrees_freedom,
                min=2,
                max=20,
                default=4)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.8,
                max=0.99,
                default=0.95)
            private$..prediction_horizon <- jmvcore::OptionNumber$new(
                "prediction_horizon",
                prediction_horizon,
                min=0.1,
                max=20,
                default=5)
            private$..bootstrap_samples <- jmvcore::OptionInteger$new(
                "bootstrap_samples",
                bootstrap_samples,
                min=50,
                max=1000,
                default=200)
            private$..include_residuals <- jmvcore::OptionBool$new(
                "include_residuals",
                include_residuals,
                default=TRUE)
            private$..dynamic_prediction <- jmvcore::OptionBool$new(
                "dynamic_prediction",
                dynamic_prediction,
                default=TRUE)
            private$..individual_profiles <- jmvcore::OptionBool$new(
                "individual_profiles",
                individual_profiles,
                default=FALSE)
            private$..significance_testing <- jmvcore::OptionBool$new(
                "significance_testing",
                significance_testing,
                default=TRUE)
            private$..model_comparison <- jmvcore::OptionBool$new(
                "model_comparison",
                model_comparison,
                default=TRUE)

            self$.addOption(private$..time)
            self$.addOption(private$..status)
            self$.addOption(private$..covariates)
            self$.addOption(private$..id)
            self$.addOption(private$..update_times)
            self$.addOption(private$..method)
            self$.addOption(private$..smoothing_method)
            self$.addOption(private$..bandwidth)
            self$.addOption(private$..degrees_freedom)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..prediction_horizon)
            self$.addOption(private$..bootstrap_samples)
            self$.addOption(private$..include_residuals)
            self$.addOption(private$..dynamic_prediction)
            self$.addOption(private$..individual_profiles)
            self$.addOption(private$..significance_testing)
            self$.addOption(private$..model_comparison)
        }),
    active = list(
        time = function() private$..time$value,
        status = function() private$..status$value,
        covariates = function() private$..covariates$value,
        id = function() private$..id$value,
        update_times = function() private$..update_times$value,
        method = function() private$..method$value,
        smoothing_method = function() private$..smoothing_method$value,
        bandwidth = function() private$..bandwidth$value,
        degrees_freedom = function() private$..degrees_freedom$value,
        confidence_level = function() private$..confidence_level$value,
        prediction_horizon = function() private$..prediction_horizon$value,
        bootstrap_samples = function() private$..bootstrap_samples$value,
        include_residuals = function() private$..include_residuals$value,
        dynamic_prediction = function() private$..dynamic_prediction$value,
        individual_profiles = function() private$..individual_profiles$value,
        significance_testing = function() private$..significance_testing$value,
        model_comparison = function() private$..model_comparison$value),
    private = list(
        ..time = NA,
        ..status = NA,
        ..covariates = NA,
        ..id = NA,
        ..update_times = NA,
        ..method = NA,
        ..smoothing_method = NA,
        ..bandwidth = NA,
        ..degrees_freedom = NA,
        ..confidence_level = NA,
        ..prediction_horizon = NA,
        ..bootstrap_samples = NA,
        ..include_residuals = NA,
        ..dynamic_prediction = NA,
        ..individual_profiles = NA,
        ..significance_testing = NA,
        ..model_comparison = NA)
)

timeupdatesurvivalResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "timeupdatesurvivalResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        modelSummary = function() private$.items[["modelSummary"]],
        timeVaryingCoefficients = function() private$.items[["timeVaryingCoefficients"]],
        cumulativeCoefficients = function() private$.items[["cumulativeCoefficients"]],
        dynamicPredictions = function() private$.items[["dynamicPredictions"]],
        significanceTests = function() private$.items[["significanceTests"]],
        modelComparison = function() private$.items[["modelComparison"]],
        residualAnalysis = function() private$.items[["residualAnalysis"]],
        goodnessOfFit = function() private$.items[["goodnessOfFit"]],
        timeVaryingPlot = function() private$.items[["timeVaryingPlot"]],
        cumulativePlot = function() private$.items[["cumulativePlot"]],
        dynamicPredictionPlot = function() private$.items[["dynamicPredictionPlot"]],
        residualPlots = function() private$.items[["residualPlots"]],
        smoothingDiagnostics = function() private$.items[["smoothingDiagnostics"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Time-Updated Survival Estimates")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Analysis Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                visible=TRUE,
                rows=1,
                clearWith=list(
                    "time",
                    "status",
                    "covariates",
                    "method"),
                columns=list(
                    list(
                        `name`="characteristic", 
                        `title`="Characteristic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="timeVaryingCoefficients",
                title="Time-Varying Coefficients",
                visible=TRUE,
                rows=1,
                clearWith=list(
                    "covariates",
                    "method",
                    "update_times"),
                columns=list(
                    list(
                        `name`="covariate", 
                        `title`="Covariate", 
                        `type`="text"),
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="coefficient", 
                        `title`="Coefficient", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="standard_error", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="confidence_interval", 
                        `title`="Confidence Interval", 
                        `type`="text"),
                    list(
                        `name`="z_value", 
                        `title`="z-value", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto:4"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="cumulativeCoefficients",
                title="Cumulative Regression Functions",
                visible="(method:aalen_additive)",
                rows=1,
                clearWith=list(
                    "method",
                    "update_times"),
                columns=list(
                    list(
                        `name`="covariate", 
                        `title`="Covariate", 
                        `type`="text"),
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="cumulative_coefficient", 
                        `title`="Cumulative Coefficient", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="confidence_lower", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="confidence_upper", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto:4"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="dynamicPredictions",
                title="Dynamic Survival Predictions",
                visible="(dynamic_prediction)",
                rows=1,
                clearWith=list(
                    "dynamic_prediction",
                    "prediction_horizon"),
                columns=list(
                    list(
                        `name`="patient_profile", 
                        `title`="Patient Profile", 
                        `type`="text"),
                    list(
                        `name`="current_time", 
                        `title`="Current Time", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="prediction_time", 
                        `title`="Prediction Time", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="survival_probability", 
                        `title`="Survival Probability", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="hazard_ratio", 
                        `title`="Current Hazard Ratio", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="risk_category", 
                        `title`="Risk Category", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="significanceTests",
                title="Time-Varying Coefficient Tests",
                visible="(significance_testing)",
                rows=1,
                clearWith=list(
                    "significance_testing",
                    "covariates"),
                columns=list(
                    list(
                        `name`="covariate", 
                        `title`="Covariate", 
                        `type`="text"),
                    list(
                        `name`="test_statistic", 
                        `title`="Test Statistic", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="conclusion", 
                        `title`="Conclusion", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelComparison",
                title="Model Comparison",
                visible="(model_comparison)",
                rows=1,
                clearWith=list(
                    "model_comparison",
                    "method"),
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="log_likelihood", 
                        `title`="Log-Likelihood", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="deviance", 
                        `title`="Deviance", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="p_value", 
                        `title`="p-value vs Cox", 
                        `type`="number", 
                        `format`="zto:4"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="residualAnalysis",
                title="Residual Analysis",
                visible="(include_residuals)",
                rows=1,
                clearWith=list(
                    "include_residuals",
                    "method"),
                columns=list(
                    list(
                        `name`="residual_type", 
                        `title`="Residual Type", 
                        `type`="text"),
                    list(
                        `name`="mean", 
                        `title`="Mean", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="std_deviation", 
                        `title`="SD", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="skewness", 
                        `title`="Skewness", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="kurtosis", 
                        `title`="Kurtosis", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="normality_test", 
                        `title`="Normality p-value", 
                        `type`="number", 
                        `format`="zto:4"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="goodnessOfFit",
                title="Goodness of Fit Statistics",
                visible=TRUE,
                rows=1,
                clearWith=list(
                    "method",
                    "covariates"),
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="timeVaryingPlot",
                title="Time-Varying Coefficients Plot",
                visible=TRUE,
                requiresData=TRUE,
                width=900,
                height=600,
                renderFun=".plotTimeVaryingCoefficients",
                clearWith=list(
                    "covariates",
                    "method",
                    "smoothing_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="cumulativePlot",
                title="Cumulative Regression Functions Plot",
                visible="(method:aalen_additive)",
                requiresData=TRUE,
                width=800,
                height=600,
                renderFun=".plotCumulativeCoefficients",
                clearWith=list(
                    "method",
                    "update_times")))
            self$add(jmvcore::Image$new(
                options=options,
                name="dynamicPredictionPlot",
                title="Dynamic Survival Predictions Plot",
                visible="(dynamic_prediction)",
                requiresData=TRUE,
                width=800,
                height=600,
                renderFun=".plotDynamicPredictions",
                clearWith=list(
                    "dynamic_prediction",
                    "prediction_horizon")))
            self$add(jmvcore::Image$new(
                options=options,
                name="residualPlots",
                title="Residual Analysis Plots",
                visible="(include_residuals)",
                requiresData=TRUE,
                width=900,
                height=700,
                renderFun=".plotResidualAnalysis",
                clearWith=list(
                    "include_residuals",
                    "method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="smoothingDiagnostics",
                title="Smoothing Diagnostics Plot",
                visible=TRUE,
                requiresData=TRUE,
                width=800,
                height=600,
                renderFun=".plotSmoothingDiagnostics",
                clearWith=list(
                    "smoothing_method",
                    "bandwidth")))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Method and Clinical Interpretation",
                visible=TRUE))}))

timeupdatesurvivalBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "timeupdatesurvivalBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "timeupdatesurvival",
                version = c(1,0,0),
                options = options,
                results = timeupdatesurvivalResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Time-Updated Survival Estimates
#'
#' Time-updated survival estimates using time-varying regression coefficients 
#' and  dynamic hazard functions. Incorporates real-time patient information 
#' updates  for precision medicine and personalized survival prediction.
#' 
#'
#' @examples
#' data \%>\%
#' timeupdatesurvival(
#'     time = "time_variable",
#'     status = "status_variable",
#'     covariates = c("age", "treatment"),
#'     update_times = c(0.5, 1, 2),
#'     method = "aalen_additive"
#' )
#'
#' @param data the data as a data frame
#' @param time Time-to-event or follow-up time variable (numeric)
#' @param status Event indicator variable (1/TRUE = event occurred, 0/FALSE =
#'   censored)
#' @param covariates Covariates for time-varying coefficient analysis
#' @param id Subject identifier for longitudinal data and repeated
#'   measurements
#' @param update_times Comma-separated list of time points for coefficient
#'   updates (e.g., "0.5, 1, 2, 5")
#' @param method Method for estimating time-varying regression coefficients
#' @param smoothing_method Smoothing method for time-varying coefficient
#'   estimation
#' @param bandwidth Bandwidth parameter for smoothing (0.1 to 2.0)
#' @param degrees_freedom Degrees of freedom for spline-based methods
#' @param confidence_level Confidence level for confidence bands
#' @param prediction_horizon Time horizon for dynamic survival predictions
#' @param bootstrap_samples Number of bootstrap samples for confidence band
#'   estimation
#' @param include_residuals Include residual analysis and model diagnostics
#' @param dynamic_prediction Enable dynamic survival prediction with updated
#'   coefficients
#' @param individual_profiles Generate individual-level time-varying
#'   coefficient profiles
#' @param significance_testing Perform tests for time-varying coefficients vs.
#'   constant coefficients
#' @param model_comparison Compare time-varying models with standard Cox
#'   regression
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$timeVaryingCoefficients} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$cumulativeCoefficients} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$dynamicPredictions} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$significanceTests} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$residualAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$goodnessOfFit} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$timeVaryingPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$cumulativePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$dynamicPredictionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$residualPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$smoothingDiagnostics} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelSummary$asDF}
#'
#' \code{as.data.frame(results$modelSummary)}
#'
#' @export
timeupdatesurvival <- function(
    data,
    time,
    status,
    covariates,
    id,
    update_times = "0.5, 1, 2, 5",
    method = "aalen_additive",
    smoothing_method = "lowess",
    bandwidth = 0.5,
    degrees_freedom = 4,
    confidence_level = 0.95,
    prediction_horizon = 5,
    bootstrap_samples = 200,
    include_residuals = TRUE,
    dynamic_prediction = TRUE,
    individual_profiles = FALSE,
    significance_testing = TRUE,
    model_comparison = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("timeupdatesurvival requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(status)) status <- jmvcore::resolveQuo(jmvcore::enquo(status))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(id)) id <- jmvcore::resolveQuo(jmvcore::enquo(id))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(status), status, NULL),
            `if`( ! missing(covariates), covariates, NULL),
            `if`( ! missing(id), id, NULL))

    for (v in id) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- timeupdatesurvivalOptions$new(
        time = time,
        status = status,
        covariates = covariates,
        id = id,
        update_times = update_times,
        method = method,
        smoothing_method = smoothing_method,
        bandwidth = bandwidth,
        degrees_freedom = degrees_freedom,
        confidence_level = confidence_level,
        prediction_horizon = prediction_horizon,
        bootstrap_samples = bootstrap_samples,
        include_residuals = include_residuals,
        dynamic_prediction = dynamic_prediction,
        individual_profiles = individual_profiles,
        significance_testing = significance_testing,
        model_comparison = model_comparison)

    analysis <- timeupdatesurvivalClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

