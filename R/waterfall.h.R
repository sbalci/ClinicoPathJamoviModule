
# This file is automatically generated, you probably don't want to edit this

waterfallOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "waterfallOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            patientID = NULL,
            responseVar = NULL,
            timeVar = NULL,
            groupVar = NULL,
            inputType = "percentage",
            sortBy = "response",
            showThresholds = FALSE,
            labelOutliers = FALSE,
            showMedian = FALSE,
            showCI = FALSE,
            minResponseForLabel = 50,
            colorBy = "recist",
            colorScheme = "jamovi",
            barAlpha = 1,
            barWidth = 0.7,
            showWaterfallPlot = TRUE,
            showSpiderPlot = TRUE,
            spiderColorBy = "response",
            spiderColorScheme = "classic", ...) {

            super$initialize(
                package="ClinicoPath",
                name="waterfall",
                requiresData=TRUE,
                ...)

            private$..patientID <- jmvcore::OptionVariable$new(
                "patientID",
                patientID,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor",
                    "id"))
            private$..responseVar <- jmvcore::OptionVariable$new(
                "responseVar",
                responseVar,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..timeVar <- jmvcore::OptionVariable$new(
                "timeVar",
                timeVar,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..groupVar <- jmvcore::OptionVariable$new(
                "groupVar",
                groupVar,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..inputType <- jmvcore::OptionList$new(
                "inputType",
                inputType,
                options=list(
                    "raw",
                    "percentage"),
                default="percentage")
            private$..sortBy <- jmvcore::OptionList$new(
                "sortBy",
                sortBy,
                options=list(
                    "response",
                    "id"),
                default="response")
            private$..showThresholds <- jmvcore::OptionBool$new(
                "showThresholds",
                showThresholds,
                default=FALSE)
            private$..labelOutliers <- jmvcore::OptionBool$new(
                "labelOutliers",
                labelOutliers,
                default=FALSE)
            private$..showMedian <- jmvcore::OptionBool$new(
                "showMedian",
                showMedian,
                default=FALSE)
            private$..showCI <- jmvcore::OptionBool$new(
                "showCI",
                showCI,
                default=FALSE)
            private$..minResponseForLabel <- jmvcore::OptionNumber$new(
                "minResponseForLabel",
                minResponseForLabel,
                default=50,
                min=0,
                max=100)
            private$..colorBy <- jmvcore::OptionList$new(
                "colorBy",
                colorBy,
                options=list(
                    "recist",
                    "group"),
                default="recist")
            private$..colorScheme <- jmvcore::OptionList$new(
                "colorScheme",
                colorScheme,
                options=list(
                    "jamovi",
                    "recist",
                    "simple",
                    "colorful"),
                default="jamovi")
            private$..barAlpha <- jmvcore::OptionNumber$new(
                "barAlpha",
                barAlpha,
                default=1,
                min=0,
                max=1)
            private$..barWidth <- jmvcore::OptionNumber$new(
                "barWidth",
                barWidth,
                default=0.7,
                min=0.1,
                max=1)
            private$..showWaterfallPlot <- jmvcore::OptionBool$new(
                "showWaterfallPlot",
                showWaterfallPlot,
                default=TRUE)
            private$..showSpiderPlot <- jmvcore::OptionBool$new(
                "showSpiderPlot",
                showSpiderPlot,
                default=TRUE)
            private$..spiderColorBy <- jmvcore::OptionList$new(
                "spiderColorBy",
                spiderColorBy,
                options=list(
                    "response",
                    "group"),
                default="response")
            private$..spiderColorScheme <- jmvcore::OptionList$new(
                "spiderColorScheme",
                spiderColorScheme,
                options=list(
                    "classic",
                    "jamovi",
                    "colorful"),
                default="classic")
            private$..addResponseCategory <- jmvcore::OptionOutput$new(
                "addResponseCategory")

            self$.addOption(private$..patientID)
            self$.addOption(private$..responseVar)
            self$.addOption(private$..timeVar)
            self$.addOption(private$..groupVar)
            self$.addOption(private$..inputType)
            self$.addOption(private$..sortBy)
            self$.addOption(private$..showThresholds)
            self$.addOption(private$..labelOutliers)
            self$.addOption(private$..showMedian)
            self$.addOption(private$..showCI)
            self$.addOption(private$..minResponseForLabel)
            self$.addOption(private$..colorBy)
            self$.addOption(private$..colorScheme)
            self$.addOption(private$..barAlpha)
            self$.addOption(private$..barWidth)
            self$.addOption(private$..showWaterfallPlot)
            self$.addOption(private$..showSpiderPlot)
            self$.addOption(private$..spiderColorBy)
            self$.addOption(private$..spiderColorScheme)
            self$.addOption(private$..addResponseCategory)
        }),
    active = list(
        patientID = function() private$..patientID$value,
        responseVar = function() private$..responseVar$value,
        timeVar = function() private$..timeVar$value,
        groupVar = function() private$..groupVar$value,
        inputType = function() private$..inputType$value,
        sortBy = function() private$..sortBy$value,
        showThresholds = function() private$..showThresholds$value,
        labelOutliers = function() private$..labelOutliers$value,
        showMedian = function() private$..showMedian$value,
        showCI = function() private$..showCI$value,
        minResponseForLabel = function() private$..minResponseForLabel$value,
        colorBy = function() private$..colorBy$value,
        colorScheme = function() private$..colorScheme$value,
        barAlpha = function() private$..barAlpha$value,
        barWidth = function() private$..barWidth$value,
        showWaterfallPlot = function() private$..showWaterfallPlot$value,
        showSpiderPlot = function() private$..showSpiderPlot$value,
        spiderColorBy = function() private$..spiderColorBy$value,
        spiderColorScheme = function() private$..spiderColorScheme$value,
        addResponseCategory = function() private$..addResponseCategory$value),
    private = list(
        ..patientID = NA,
        ..responseVar = NA,
        ..timeVar = NA,
        ..groupVar = NA,
        ..inputType = NA,
        ..sortBy = NA,
        ..showThresholds = NA,
        ..labelOutliers = NA,
        ..showMedian = NA,
        ..showCI = NA,
        ..minResponseForLabel = NA,
        ..colorBy = NA,
        ..colorScheme = NA,
        ..barAlpha = NA,
        ..barWidth = NA,
        ..showWaterfallPlot = NA,
        ..showSpiderPlot = NA,
        ..spiderColorBy = NA,
        ..spiderColorScheme = NA,
        ..addResponseCategory = NA)
)

waterfallResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "waterfallResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        clinicalSummary = function() private$.items[["clinicalSummary"]],
        aboutAnalysis = function() private$.items[["aboutAnalysis"]],
        summaryTable = function() private$.items[["summaryTable"]],
        personTimeTable = function() private$.items[["personTimeTable"]],
        clinicalMetrics = function() private$.items[["clinicalMetrics"]],
        waterfallplot = function() private$.items[["waterfallplot"]],
        spiderplot = function() private$.items[["spiderplot"]],
        addResponseCategory = function() private$.items[["addResponseCategory"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Treatment Response Analysis",
                refs=list(
                    "recist",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Treatment Response Analysis Guide",
                clearWith=list(
                    "patientID",
                    "responseVar",
                    "timeVar",
                    "inputType")))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalSummary",
                title="Clinical Summary",
                visible="(patientID && responseVar)",
                clearWith=list(
                    "patientID",
                    "responseVar",
                    "timeVar",
                    "inputType",
                    "colorScheme",
                    "groupVar")))
            self$add(jmvcore::Html$new(
                options=options,
                name="aboutAnalysis",
                title="About This Analysis",
                visible="(patientID)",
                clearWith=list(
                    "patientID",
                    "responseVar",
                    "timeVar",
                    "inputType")))
            self$add(jmvcore::Table$new(
                options=options,
                name="summaryTable",
                title="Response Categories Based on RECIST v1.1 Criteria",
                rows=0,
                columns=list(
                    list(
                        `name`="category", 
                        `title`="Category", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="Number of Patients", 
                        `type`="integer"),
                    list(
                        `name`="percent", 
                        `title`="Percentage", 
                        `type`="number", 
                        `format`="percent")),
                clearWith=list(
                    "patientID",
                    "responseVar",
                    "timeVar",
                    "inputType")))
            self$add(jmvcore::Table$new(
                options=options,
                name="personTimeTable",
                title="Person-Time Analysis",
                rows=0,
                columns=list(
                    list(
                        `name`="category", 
                        `title`="Response Category", 
                        `type`="text"),
                    list(
                        `name`="patients", 
                        `title`="Patients", 
                        `type`="integer"),
                    list(
                        `name`="patient_pct", 
                        `title`="% Patients", 
                        `type`="text"),
                    list(
                        `name`="person_time", 
                        `title`="Person-Time", 
                        `type`="text"),
                    list(
                        `name`="time_pct", 
                        `title`="% Time", 
                        `type`="text"),
                    list(
                        `name`="median_time", 
                        `title`="Median Time to Response", 
                        `type`="text"),
                    list(
                        `name`="median_duration", 
                        `title`="Median Duration", 
                        `type`="text")),
                visible="(timeVar && inputType == \"raw\")"))
            self$add(jmvcore::Table$new(
                options=options,
                name="clinicalMetrics",
                title="Clinical Response Metrics",
                rows=0,
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text")),
                clearWith=list(
                    "patientID",
                    "responseVar",
                    "timeVar",
                    "inputType")))
            self$add(jmvcore::Image$new(
                options=options,
                name="waterfallplot",
                title="Waterfall Plot",
                width=800,
                height=500,
                renderFun=".waterfallplot",
                requiresData=TRUE,
                visible="(showWaterfallPlot)",
                clearWith=list(
                    "patientID",
                    "responseVar",
                    "sortBy",
                    "showThresholds",
                    "labelOutliers",
                    "colorBy",
                    "colorScheme",
                    "showMedian",
                    "showCI",
                    "groupVar",
                    "inputType")))
            self$add(jmvcore::Image$new(
                options=options,
                name="spiderplot",
                title="Spider Plot - Response Over Time",
                width=800,
                height=500,
                renderFun=".spiderplot",
                requiresData=TRUE,
                visible="(showSpiderPlot && timeVar)",
                clearWith=list(
                    "patientID",
                    "responseVar",
                    "timeVar",
                    "inputType",
                    "sortBy",
                    "groupVar",
                    "showThresholds",
                    "labelOutliers",
                    "colorBy",
                    "colorScheme",
                    "spiderColorBy",
                    "spiderColorScheme",
                    "showMedian",
                    "showCI")))
            self$add(jmvcore::Output$new(
                options=options,
                name="addResponseCategory",
                title="Add Response Category to Data",
                varTitle="RECIST",
                varDescription="Calculated response category based on RECIST criteria.",
                measureType="nominal",
                clearWith=list(
                    "patientID",
                    "responseVar",
                    "timeVar",
                    "inputType")))}))

waterfallBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "waterfallBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "waterfall",
                version = c(0,0,31),
                options = options,
                results = waterfallResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'none')
        }))

#' Treatment Response Analysis
#'
#' Creates waterfall and spider plots to analyze tumor response data following 
#' RECIST criteria. Supports both raw tumor measurements and pre-calculated 
#' percentage changes. Provides comprehensive response analysis including ORR, 
#' DCR, and person-time metrics.
#' 
#'
#' @examples
#' \donttest{
#' # Example 1: Percentage data
#' data_pct <- data.frame(
#'     PatientID = paste0("PT", 1:5),
#'     Response = c(-60, -35, -10, 15, 45)
#' )
#' waterfall(
#'     data = data_pct,
#'     patientID = "PatientID",
#'     responseVar = "Response",
#'     inputType = "percentage"
#' )
#'
#' # Example 2: Raw measurements
#' data_raw <- data.frame(
#'     PatientID = rep(paste0("PT", 1:3), each = 3),
#'     Time = rep(c(0, 2, 4), 3),
#'     Measurement = c(50, 30, 25, 60, 45, 40, 55, 50, 48)
#' )
#' waterfall(
#'     data = data_raw,
#'     patientID = "PatientID",
#'     responseVar = "Measurement",
#'     timeVar = "Time",
#'     inputType = "raw"
#' )
#'}
#' @param data The data as a data frame.
#' @param patientID Variable containing patient identifiers.
#' @param responseVar Response variable: either raw tumor measurements or
#'   pre-calculated percentage changes. For raw measurements, requires a time
#'   variable with baseline (time = 0). For percentages, negative values
#'   indicate tumor shrinkage (improvement).
#' @param timeVar Time point of measurement for spider plot (e.g., months from
#'   baseline)
#' @param groupVar Optional grouping variable for coloring bars by patient
#'   groups (e.g., treatment arms, disease subtypes). When specified, overrides
#'   RECIST category coloring to show group-based colors.
#' @param inputType Specify data format: 'raw' for actual measurements (will
#'   calculate percent change) or 'percentage' for pre-calculated percentage
#'   changes
#' @param sortBy Sort the waterfall plot by best response or patient ID.
#' @param showThresholds Show +20 percent and -30 percent RECIST thresholds.
#' @param labelOutliers Label responses exceeding the specified threshold.
#' @param showMedian Show median response as a horizontal line.
#' @param showCI Show confidence interval around median response.
#' @param minResponseForLabel Minimum response value for labels to be
#'   displayed.
#' @param colorBy Coloring method: RECIST categories or patient groups
#'   (requires Group Variable).
#' @param colorScheme Color scheme for waterfall plot. 'Colorful' provides
#'   distinct colors for group-based coloring.
#' @param barAlpha Transparency of bars in waterfall plot.
#' @param barWidth Width of bars in waterfall plot.
#' @param showWaterfallPlot Display the waterfall plot showing best response
#'   for each patient.
#' @param showSpiderPlot Display spider plot showing response trajectories
#'   over time (requires time variable).
#' @param spiderColorBy Coloring method for spider plot: Response status or
#'   patient groups. For backward compatibility, defaults to response status
#'   coloring.
#' @param spiderColorScheme Color scheme for spider plot lines and points.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$clinicalSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$aboutAnalysis} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summaryTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$personTimeTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clinicalMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$waterfallplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$spiderplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$addResponseCategory} \tab \tab \tab \tab \tab an output \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summaryTable$asDF}
#'
#' \code{as.data.frame(results$summaryTable)}
#'
#' @export
waterfall <- function(
    data,
    patientID,
    responseVar,
    timeVar = NULL,
    groupVar = NULL,
    inputType = "percentage",
    sortBy = "response",
    showThresholds = FALSE,
    labelOutliers = FALSE,
    showMedian = FALSE,
    showCI = FALSE,
    minResponseForLabel = 50,
    colorBy = "recist",
    colorScheme = "jamovi",
    barAlpha = 1,
    barWidth = 0.7,
    showWaterfallPlot = TRUE,
    showSpiderPlot = TRUE,
    spiderColorBy = "response",
    spiderColorScheme = "classic") {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("waterfall requires jmvcore to be installed (restart may be required)")

    if ( ! missing(patientID)) patientID <- jmvcore::resolveQuo(jmvcore::enquo(patientID))
    if ( ! missing(responseVar)) responseVar <- jmvcore::resolveQuo(jmvcore::enquo(responseVar))
    if ( ! missing(timeVar)) timeVar <- jmvcore::resolveQuo(jmvcore::enquo(timeVar))
    if ( ! missing(groupVar)) groupVar <- jmvcore::resolveQuo(jmvcore::enquo(groupVar))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(patientID), patientID, NULL),
            `if`( ! missing(responseVar), responseVar, NULL),
            `if`( ! missing(timeVar), timeVar, NULL),
            `if`( ! missing(groupVar), groupVar, NULL))


    options <- waterfallOptions$new(
        patientID = patientID,
        responseVar = responseVar,
        timeVar = timeVar,
        groupVar = groupVar,
        inputType = inputType,
        sortBy = sortBy,
        showThresholds = showThresholds,
        labelOutliers = labelOutliers,
        showMedian = showMedian,
        showCI = showCI,
        minResponseForLabel = minResponseForLabel,
        colorBy = colorBy,
        colorScheme = colorScheme,
        barAlpha = barAlpha,
        barWidth = barWidth,
        showWaterfallPlot = showWaterfallPlot,
        showSpiderPlot = showSpiderPlot,
        spiderColorBy = spiderColorBy,
        spiderColorScheme = spiderColorScheme)

    analysis <- waterfallClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

