
# This file is automatically generated, you probably don't want to edit this

flexiblerelativesurvivalOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "flexiblerelativesurvivalOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            timeVar = NULL,
            statusVar = NULL,
            ageVar = NULL,
            sexVar = NULL,
            yearVar = NULL,
            covariates = NULL,
            expectedType = "lifetable",
            smoothingMethod = "splines",
            knotsTime = 5,
            knotsAge = 3,
            smoothingParameter = 1,
            confidenceLevel = 95,
            plotRelativeSurvival = TRUE,
            plotExcessHazard = TRUE,
            plotLifeExpectancy = FALSE,
            predictTimePoints = "1,2,3,5,10",
            standardizeAge = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="flexiblerelativesurvival",
                requiresData=TRUE,
                ...)

            private$..timeVar <- jmvcore::OptionVariable$new(
                "timeVar",
                timeVar,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..statusVar <- jmvcore::OptionVariable$new(
                "statusVar",
                statusVar,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..ageVar <- jmvcore::OptionVariable$new(
                "ageVar",
                ageVar,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..sexVar <- jmvcore::OptionVariable$new(
                "sexVar",
                sexVar,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..yearVar <- jmvcore::OptionVariable$new(
                "yearVar",
                yearVar,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..expectedType <- jmvcore::OptionList$new(
                "expectedType",
                expectedType,
                options=list(
                    "lifetable",
                    "hazard",
                    "custom"),
                default="lifetable")
            private$..smoothingMethod <- jmvcore::OptionList$new(
                "smoothingMethod",
                smoothingMethod,
                options=list(
                    "splines",
                    "pspline",
                    "bspline",
                    "ns"),
                default="splines")
            private$..knotsTime <- jmvcore::OptionNumber$new(
                "knotsTime",
                knotsTime,
                min=2,
                max=10,
                default=5)
            private$..knotsAge <- jmvcore::OptionNumber$new(
                "knotsAge",
                knotsAge,
                min=2,
                max=8,
                default=3)
            private$..smoothingParameter <- jmvcore::OptionNumber$new(
                "smoothingParameter",
                smoothingParameter,
                min=0.001,
                max=100,
                default=1)
            private$..confidenceLevel <- jmvcore::OptionNumber$new(
                "confidenceLevel",
                confidenceLevel,
                min=90,
                max=99.9,
                default=95)
            private$..plotRelativeSurvival <- jmvcore::OptionBool$new(
                "plotRelativeSurvival",
                plotRelativeSurvival,
                default=TRUE)
            private$..plotExcessHazard <- jmvcore::OptionBool$new(
                "plotExcessHazard",
                plotExcessHazard,
                default=TRUE)
            private$..plotLifeExpectancy <- jmvcore::OptionBool$new(
                "plotLifeExpectancy",
                plotLifeExpectancy,
                default=FALSE)
            private$..predictTimePoints <- jmvcore::OptionString$new(
                "predictTimePoints",
                predictTimePoints,
                default="1,2,3,5,10")
            private$..standardizeAge <- jmvcore::OptionBool$new(
                "standardizeAge",
                standardizeAge,
                default=TRUE)

            self$.addOption(private$..timeVar)
            self$.addOption(private$..statusVar)
            self$.addOption(private$..ageVar)
            self$.addOption(private$..sexVar)
            self$.addOption(private$..yearVar)
            self$.addOption(private$..covariates)
            self$.addOption(private$..expectedType)
            self$.addOption(private$..smoothingMethod)
            self$.addOption(private$..knotsTime)
            self$.addOption(private$..knotsAge)
            self$.addOption(private$..smoothingParameter)
            self$.addOption(private$..confidenceLevel)
            self$.addOption(private$..plotRelativeSurvival)
            self$.addOption(private$..plotExcessHazard)
            self$.addOption(private$..plotLifeExpectancy)
            self$.addOption(private$..predictTimePoints)
            self$.addOption(private$..standardizeAge)
        }),
    active = list(
        timeVar = function() private$..timeVar$value,
        statusVar = function() private$..statusVar$value,
        ageVar = function() private$..ageVar$value,
        sexVar = function() private$..sexVar$value,
        yearVar = function() private$..yearVar$value,
        covariates = function() private$..covariates$value,
        expectedType = function() private$..expectedType$value,
        smoothingMethod = function() private$..smoothingMethod$value,
        knotsTime = function() private$..knotsTime$value,
        knotsAge = function() private$..knotsAge$value,
        smoothingParameter = function() private$..smoothingParameter$value,
        confidenceLevel = function() private$..confidenceLevel$value,
        plotRelativeSurvival = function() private$..plotRelativeSurvival$value,
        plotExcessHazard = function() private$..plotExcessHazard$value,
        plotLifeExpectancy = function() private$..plotLifeExpectancy$value,
        predictTimePoints = function() private$..predictTimePoints$value,
        standardizeAge = function() private$..standardizeAge$value),
    private = list(
        ..timeVar = NA,
        ..statusVar = NA,
        ..ageVar = NA,
        ..sexVar = NA,
        ..yearVar = NA,
        ..covariates = NA,
        ..expectedType = NA,
        ..smoothingMethod = NA,
        ..knotsTime = NA,
        ..knotsAge = NA,
        ..smoothingParameter = NA,
        ..confidenceLevel = NA,
        ..plotRelativeSurvival = NA,
        ..plotExcessHazard = NA,
        ..plotLifeExpectancy = NA,
        ..predictTimePoints = NA,
        ..standardizeAge = NA)
)

flexiblerelativesurvivalResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "flexiblerelativesurvivalResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        modelSummary = function() private$.items[["modelSummary"]],
        coefficients = function() private$.items[["coefficients"]],
        relativeSurvival = function() private$.items[["relativeSurvival"]],
        smoothingInfo = function() private$.items[["smoothingInfo"]],
        goodnessOfFit = function() private$.items[["goodnessOfFit"]],
        relativeSurvivalPlot = function() private$.items[["relativeSurvivalPlot"]],
        excessHazardPlot = function() private$.items[["excessHazardPlot"]],
        lifeExpectancyPlot = function() private$.items[["lifeExpectancyPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Flexible Relative Survival Analysis")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="coefficients",
                title="Model Coefficients",
                visible="(covariates)",
                columns=list(
                    list(
                        `name`="term", 
                        `title`="Term", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="z_value", 
                        `title`="z value", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="hr", 
                        `title`="Hazard Ratio", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="HR CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="HR CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="relativeSurvival",
                title="Relative Survival Estimates",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="time", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="rel_survival", 
                        `title`="Relative Survival", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"),
                    list(
                        `name`="excess_hazard", 
                        `title`="Excess Hazard", 
                        `type`="number"),
                    list(
                        `name`="life_lost", 
                        `title`="Life Years Lost", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="smoothingInfo",
                title="Smoothing Information",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="dimension", 
                        `title`="Dimension", 
                        `type`="text"),
                    list(
                        `name`="knots", 
                        `title`="Knots", 
                        `type`="integer"),
                    list(
                        `name`="smoothing_param", 
                        `title`="Smoothing Parameter", 
                        `type`="number"),
                    list(
                        `name`="edf", 
                        `title`="Effective df", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="goodnessOfFit",
                title="Model Fit Statistics",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="relativeSurvivalPlot",
                title="Relative Survival Curve",
                visible="(plotRelativeSurvival)",
                width=650,
                height=450,
                renderFun=".relativeSurvivalPlot"))
            self$add(jmvcore::Image$new(
                options=options,
                name="excessHazardPlot",
                title="Excess Hazard Function",
                visible="(plotExcessHazard)",
                width=650,
                height=450,
                renderFun=".excessHazardPlot"))
            self$add(jmvcore::Image$new(
                options=options,
                name="lifeExpectancyPlot",
                title="Life Expectancy Loss",
                visible="(plotLifeExpectancy)",
                width=650,
                height=450,
                renderFun=".lifeExpectancyPlot"))}))

flexiblerelativesurvivalBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "flexiblerelativesurvivalBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "flexiblerelativesurvival",
                version = c(1,0,0),
                options = options,
                results = flexiblerelativesurvivalResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Flexible Relative Survival Analysis
#'
#' 
#' @param data .
#' @param timeVar .
#' @param statusVar .
#' @param ageVar .
#' @param sexVar .
#' @param yearVar .
#' @param covariates .
#' @param expectedType .
#' @param smoothingMethod .
#' @param knotsTime .
#' @param knotsAge .
#' @param smoothingParameter .
#' @param confidenceLevel .
#' @param plotRelativeSurvival .
#' @param plotExcessHazard .
#' @param plotLifeExpectancy .
#' @param predictTimePoints .
#' @param standardizeAge .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$coefficients} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$relativeSurvival} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$smoothingInfo} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$goodnessOfFit} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$relativeSurvivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$excessHazardPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$lifeExpectancyPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelSummary$asDF}
#'
#' \code{as.data.frame(results$modelSummary)}
#'
#' @export
flexiblerelativesurvival <- function(
    data,
    timeVar,
    statusVar,
    ageVar,
    sexVar,
    yearVar,
    covariates,
    expectedType = "lifetable",
    smoothingMethod = "splines",
    knotsTime = 5,
    knotsAge = 3,
    smoothingParameter = 1,
    confidenceLevel = 95,
    plotRelativeSurvival = TRUE,
    plotExcessHazard = TRUE,
    plotLifeExpectancy = FALSE,
    predictTimePoints = "1,2,3,5,10",
    standardizeAge = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("flexiblerelativesurvival requires jmvcore to be installed (restart may be required)")

    if ( ! missing(timeVar)) timeVar <- jmvcore::resolveQuo(jmvcore::enquo(timeVar))
    if ( ! missing(statusVar)) statusVar <- jmvcore::resolveQuo(jmvcore::enquo(statusVar))
    if ( ! missing(ageVar)) ageVar <- jmvcore::resolveQuo(jmvcore::enquo(ageVar))
    if ( ! missing(sexVar)) sexVar <- jmvcore::resolveQuo(jmvcore::enquo(sexVar))
    if ( ! missing(yearVar)) yearVar <- jmvcore::resolveQuo(jmvcore::enquo(yearVar))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(timeVar), timeVar, NULL),
            `if`( ! missing(statusVar), statusVar, NULL),
            `if`( ! missing(ageVar), ageVar, NULL),
            `if`( ! missing(sexVar), sexVar, NULL),
            `if`( ! missing(yearVar), yearVar, NULL),
            `if`( ! missing(covariates), covariates, NULL))

    for (v in sexVar) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- flexiblerelativesurvivalOptions$new(
        timeVar = timeVar,
        statusVar = statusVar,
        ageVar = ageVar,
        sexVar = sexVar,
        yearVar = yearVar,
        covariates = covariates,
        expectedType = expectedType,
        smoothingMethod = smoothingMethod,
        knotsTime = knotsTime,
        knotsAge = knotsAge,
        smoothingParameter = smoothingParameter,
        confidenceLevel = confidenceLevel,
        plotRelativeSurvival = plotRelativeSurvival,
        plotExcessHazard = plotExcessHazard,
        plotLifeExpectancy = plotLifeExpectancy,
        predictTimePoints = predictTimePoints,
        standardizeAge = standardizeAge)

    analysis <- flexiblerelativesurvivalClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

