
# This file is automatically generated, you probably don't want to edit this

groupedforestOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "groupedforestOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time_var = NULL,
            event_var = NULL,
            treatment_var = NULL,
            grouping_var = NULL,
            covariates = NULL,
            reference_treatment = "",
            plot_title = "Grouped Hazard Forest Plot",
            show_overall = TRUE,
            show_statistics = TRUE,
            confidence_level = 0.95,
            sort_by_hr = FALSE,
            show_counts = TRUE,
            plot_theme = "clinical",
            hr_range = "auto",
            custom_hr_min = 0.1,
            custom_hr_max = 10,
            interaction_test = FALSE,
            export_data = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="groupedforest",
                requiresData=TRUE,
                ...)

            private$..time_var <- jmvcore::OptionVariable$new(
                "time_var",
                time_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event_var <- jmvcore::OptionVariable$new(
                "event_var",
                event_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..treatment_var <- jmvcore::OptionVariable$new(
                "treatment_var",
                treatment_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..grouping_var <- jmvcore::OptionVariable$new(
                "grouping_var",
                grouping_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..reference_treatment <- jmvcore::OptionString$new(
                "reference_treatment",
                reference_treatment,
                default="")
            private$..plot_title <- jmvcore::OptionString$new(
                "plot_title",
                plot_title,
                default="Grouped Hazard Forest Plot")
            private$..show_overall <- jmvcore::OptionBool$new(
                "show_overall",
                show_overall,
                default=TRUE)
            private$..show_statistics <- jmvcore::OptionBool$new(
                "show_statistics",
                show_statistics,
                default=TRUE)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.8,
                max=0.99,
                default=0.95)
            private$..sort_by_hr <- jmvcore::OptionBool$new(
                "sort_by_hr",
                sort_by_hr,
                default=FALSE)
            private$..show_counts <- jmvcore::OptionBool$new(
                "show_counts",
                show_counts,
                default=TRUE)
            private$..plot_theme <- jmvcore::OptionList$new(
                "plot_theme",
                plot_theme,
                options=list(
                    "clinical",
                    "minimal",
                    "classic",
                    "publication"),
                default="clinical")
            private$..hr_range <- jmvcore::OptionList$new(
                "hr_range",
                hr_range,
                options=list(
                    "auto",
                    "wide",
                    "narrow",
                    "custom"),
                default="auto")
            private$..custom_hr_min <- jmvcore::OptionNumber$new(
                "custom_hr_min",
                custom_hr_min,
                min=0.01,
                max=1,
                default=0.1)
            private$..custom_hr_max <- jmvcore::OptionNumber$new(
                "custom_hr_max",
                custom_hr_max,
                min=1,
                max=100,
                default=10)
            private$..interaction_test <- jmvcore::OptionBool$new(
                "interaction_test",
                interaction_test,
                default=FALSE)
            private$..export_data <- jmvcore::OptionBool$new(
                "export_data",
                export_data,
                default=FALSE)

            self$.addOption(private$..time_var)
            self$.addOption(private$..event_var)
            self$.addOption(private$..treatment_var)
            self$.addOption(private$..grouping_var)
            self$.addOption(private$..covariates)
            self$.addOption(private$..reference_treatment)
            self$.addOption(private$..plot_title)
            self$.addOption(private$..show_overall)
            self$.addOption(private$..show_statistics)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..sort_by_hr)
            self$.addOption(private$..show_counts)
            self$.addOption(private$..plot_theme)
            self$.addOption(private$..hr_range)
            self$.addOption(private$..custom_hr_min)
            self$.addOption(private$..custom_hr_max)
            self$.addOption(private$..interaction_test)
            self$.addOption(private$..export_data)
        }),
    active = list(
        time_var = function() private$..time_var$value,
        event_var = function() private$..event_var$value,
        treatment_var = function() private$..treatment_var$value,
        grouping_var = function() private$..grouping_var$value,
        covariates = function() private$..covariates$value,
        reference_treatment = function() private$..reference_treatment$value,
        plot_title = function() private$..plot_title$value,
        show_overall = function() private$..show_overall$value,
        show_statistics = function() private$..show_statistics$value,
        confidence_level = function() private$..confidence_level$value,
        sort_by_hr = function() private$..sort_by_hr$value,
        show_counts = function() private$..show_counts$value,
        plot_theme = function() private$..plot_theme$value,
        hr_range = function() private$..hr_range$value,
        custom_hr_min = function() private$..custom_hr_min$value,
        custom_hr_max = function() private$..custom_hr_max$value,
        interaction_test = function() private$..interaction_test$value,
        export_data = function() private$..export_data$value),
    private = list(
        ..time_var = NA,
        ..event_var = NA,
        ..treatment_var = NA,
        ..grouping_var = NA,
        ..covariates = NA,
        ..reference_treatment = NA,
        ..plot_title = NA,
        ..show_overall = NA,
        ..show_statistics = NA,
        ..confidence_level = NA,
        ..sort_by_hr = NA,
        ..show_counts = NA,
        ..plot_theme = NA,
        ..hr_range = NA,
        ..custom_hr_min = NA,
        ..custom_hr_max = NA,
        ..interaction_test = NA,
        ..export_data = NA)
)

groupedforestResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "groupedforestResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        forest_plot = function() private$.items[["forest_plot"]],
        statistics_table = function() private$.items[["statistics_table"]],
        overall_stats = function() private$.items[["overall_stats"]],
        interaction_test = function() private$.items[["interaction_test"]],
        sample_sizes = function() private$.items[["sample_sizes"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Grouped Hazard Forest Plot",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Instructions",
                visible=FALSE))
            self$add(jmvcore::Image$new(
                options=options,
                name="forest_plot",
                title="Grouped Forest Plot",
                width=800,
                height=600,
                renderFun=".plot_forest"))
            self$add(jmvcore::Html$new(
                options=options,
                name="statistics_table",
                title="Hazard Ratios by Group",
                visible="(show_statistics)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="overall_stats",
                title="Overall Analysis",
                visible="(show_overall)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="interaction_test",
                title="Interaction Test",
                visible="(interaction_test)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="sample_sizes",
                title="Sample Sizes by Group",
                visible="(show_counts)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Interpretation Guide"))}))

groupedforestBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "groupedforestBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "groupedforest",
                version = c(0,0,3),
                options = options,
                results = groupedforestResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Grouped Hazard Forest Plot
#'
#' Creates grouped hazard regression forest plots to show treatment vs control 
#' comparisons
#' across different variants or subgroups. This module performs Cox 
#' proportional hazards
#' regression separately for each subgroup defined by a grouping variable and 
#' presents
#' the hazard ratios in a single forest plot. Perfect for showing treatment 
#' effects
#' across patient variants, genetic subtypes, or clinical subgroups.
#' 
#'
#' @examples
#' \donttest{
#' # Example:
#' # 1. Load survival data with time, event, treatment, and subgroup variables.
#' # 2. Select time variable (follow-up duration).
#' # 3. Select event variable (outcome/death indicator).
#' # 4. Select treatment variable (treatment vs control).
#' # 5. Select grouping variable (variants/subgroups for comparison).
#' # 6. Run grouped forest plot analysis to compare treatment effects across groups.
#'}
#' @param data The data as a data frame containing survival variables.
#' @param time_var Numeric variable representing follow-up time until the
#'   event or last observation.
#' @param event_var Variable indicating whether the event occurred (1) or was
#'   censored (0).
#' @param treatment_var Treatment variable (e.g., treatment vs control). This
#'   will be the primary variable for which hazard ratios are calculated within
#'   each subgroup.
#' @param grouping_var Variable defining subgroups/variants for separate Cox
#'   regression analyses. Each level will have its own hazard ratio calculation.
#' @param covariates Optional covariates to include in the Cox regression
#'   models for adjustment.
#' @param reference_treatment Specify the reference level for treatment
#'   variable. If empty, will use the first level.
#' @param plot_title Custom title for the forest plot.
#' @param show_overall If TRUE, includes an overall analysis (all groups
#'   combined) in the forest plot.
#' @param show_statistics If TRUE, displays a detailed statistics table with
#'   hazard ratios, confidence intervals, and p-values.
#' @param confidence_level Confidence level for confidence intervals (e.g.,
#'   0.95 for 95\% CI).
#' @param sort_by_hr If TRUE, sorts subgroups by hazard ratio magnitude in the
#'   forest plot.
#' @param show_counts If TRUE, displays sample sizes for each subgroup in the
#'   forest plot.
#' @param plot_theme Visual theme for the forest plot.
#' @param hr_range Range for displaying hazard ratios on the x-axis.
#' @param custom_hr_min Custom minimum hazard ratio for x-axis (when HR Range
#'   = Custom).
#' @param custom_hr_max Custom maximum hazard ratio for x-axis (when HR Range
#'   = Custom).
#' @param interaction_test If TRUE, performs a test for interaction between
#'   treatment and grouping variable.
#' @param export_data If TRUE, makes forest plot data available for export.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$forest_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$statistics_table} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$overall_stats} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$interaction_test} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$sample_sizes} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' @export
groupedforest <- function(
    data,
    time_var,
    event_var,
    treatment_var,
    grouping_var,
    covariates,
    reference_treatment = "",
    plot_title = "Grouped Hazard Forest Plot",
    show_overall = TRUE,
    show_statistics = TRUE,
    confidence_level = 0.95,
    sort_by_hr = FALSE,
    show_counts = TRUE,
    plot_theme = "clinical",
    hr_range = "auto",
    custom_hr_min = 0.1,
    custom_hr_max = 10,
    interaction_test = FALSE,
    export_data = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("groupedforest requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time_var)) time_var <- jmvcore::resolveQuo(jmvcore::enquo(time_var))
    if ( ! missing(event_var)) event_var <- jmvcore::resolveQuo(jmvcore::enquo(event_var))
    if ( ! missing(treatment_var)) treatment_var <- jmvcore::resolveQuo(jmvcore::enquo(treatment_var))
    if ( ! missing(grouping_var)) grouping_var <- jmvcore::resolveQuo(jmvcore::enquo(grouping_var))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time_var), time_var, NULL),
            `if`( ! missing(event_var), event_var, NULL),
            `if`( ! missing(treatment_var), treatment_var, NULL),
            `if`( ! missing(grouping_var), grouping_var, NULL),
            `if`( ! missing(covariates), covariates, NULL))


    options <- groupedforestOptions$new(
        time_var = time_var,
        event_var = event_var,
        treatment_var = treatment_var,
        grouping_var = grouping_var,
        covariates = covariates,
        reference_treatment = reference_treatment,
        plot_title = plot_title,
        show_overall = show_overall,
        show_statistics = show_statistics,
        confidence_level = confidence_level,
        sort_by_hr = sort_by_hr,
        show_counts = show_counts,
        plot_theme = plot_theme,
        hr_range = hr_range,
        custom_hr_min = custom_hr_min,
        custom_hr_max = custom_hr_max,
        interaction_test = interaction_test,
        export_data = export_data)

    analysis <- groupedforestClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

