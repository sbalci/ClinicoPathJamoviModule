
# This file is automatically generated, you probably don't want to edit this

ncvregcoxOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ncvregcoxOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            event = NULL,
            covariates = NULL,
            penalty = "SCAD",
            cv_folds = 10,
            lambda_type = "min",
            alpha = 1,
            gamma = 3.7,
            standardize = TRUE,
            plot_path = TRUE,
            plot_cv = TRUE,
            variable_importance = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="ncvregcox",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event <- jmvcore::OptionVariable$new(
                "event",
                event,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..penalty <- jmvcore::OptionList$new(
                "penalty",
                penalty,
                options=list(
                    "SCAD",
                    "MCP",
                    "lasso"),
                default="SCAD")
            private$..cv_folds <- jmvcore::OptionNumber$new(
                "cv_folds",
                cv_folds,
                default=10,
                min=3,
                max=20)
            private$..lambda_type <- jmvcore::OptionList$new(
                "lambda_type",
                lambda_type,
                options=list(
                    "min",
                    "1se"),
                default="min")
            private$..alpha <- jmvcore::OptionNumber$new(
                "alpha",
                alpha,
                default=1,
                min=0,
                max=1)
            private$..gamma <- jmvcore::OptionNumber$new(
                "gamma",
                gamma,
                default=3.7,
                min=1.1,
                max=10)
            private$..standardize <- jmvcore::OptionBool$new(
                "standardize",
                standardize,
                default=TRUE)
            private$..plot_path <- jmvcore::OptionBool$new(
                "plot_path",
                plot_path,
                default=TRUE)
            private$..plot_cv <- jmvcore::OptionBool$new(
                "plot_cv",
                plot_cv,
                default=TRUE)
            private$..variable_importance <- jmvcore::OptionBool$new(
                "variable_importance",
                variable_importance,
                default=TRUE)

            self$.addOption(private$..time)
            self$.addOption(private$..event)
            self$.addOption(private$..covariates)
            self$.addOption(private$..penalty)
            self$.addOption(private$..cv_folds)
            self$.addOption(private$..lambda_type)
            self$.addOption(private$..alpha)
            self$.addOption(private$..gamma)
            self$.addOption(private$..standardize)
            self$.addOption(private$..plot_path)
            self$.addOption(private$..plot_cv)
            self$.addOption(private$..variable_importance)
        }),
    active = list(
        time = function() private$..time$value,
        event = function() private$..event$value,
        covariates = function() private$..covariates$value,
        penalty = function() private$..penalty$value,
        cv_folds = function() private$..cv_folds$value,
        lambda_type = function() private$..lambda_type$value,
        alpha = function() private$..alpha$value,
        gamma = function() private$..gamma$value,
        standardize = function() private$..standardize$value,
        plot_path = function() private$..plot_path$value,
        plot_cv = function() private$..plot_cv$value,
        variable_importance = function() private$..variable_importance$value),
    private = list(
        ..time = NA,
        ..event = NA,
        ..covariates = NA,
        ..penalty = NA,
        ..cv_folds = NA,
        ..lambda_type = NA,
        ..alpha = NA,
        ..gamma = NA,
        ..standardize = NA,
        ..plot_path = NA,
        ..plot_cv = NA,
        ..variable_importance = NA)
)

ncvregcoxResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ncvregcoxResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        model_summary = function() private$.items[["model_summary"]],
        selected_variables = function() private$.items[["selected_variables"]],
        variable_importance = function() private$.items[["variable_importance"]],
        cross_validation_results = function() private$.items[["cross_validation_results"]],
        model_comparison = function() private$.items[["model_comparison"]],
        convergence_info = function() private$.items[["convergence_info"]],
        regularization_path = function() private$.items[["regularization_path"]],
        cv_error_plot = function() private$.items[["cv_error_plot"]],
        variable_selection_plot = function() private$.items[["variable_selection_plot"]],
        coefficient_comparison = function() private$.items[["coefficient_comparison"]],
        model_interpretation = function() private$.items[["model_interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="SCAD Cox Regression Results")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="model_summary",
                title="Model Summary",
                rows=1,
                visible=TRUE,
                columns=list(
                    list(
                        `name`="penalty", 
                        `title`="Penalty Function", 
                        `type`="text"),
                    list(
                        `name`="lambda_selected", 
                        `title`="Selected Lambda", 
                        `type`="number"),
                    list(
                        `name`="cv_error", 
                        `title`="CV Error", 
                        `type`="number"),
                    list(
                        `name`="n_selected", 
                        `title`="Variables Selected", 
                        `type`="integer"),
                    list(
                        `name`="deviance_explained", 
                        `title`="Deviance Explained (%)", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="selected_variables",
                title="Selected Variables",
                rows=0,
                visible=TRUE,
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="coefficient", 
                        `title`="Coefficient", 
                        `type`="number"),
                    list(
                        `name`="hazard_ratio", 
                        `title`="Hazard Ratio", 
                        `type`="number"),
                    list(
                        `name`="standard_error", 
                        `title`="Standard Error", 
                        `type`="number"),
                    list(
                        `name`="z_value", 
                        `title`="Z-value", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="P-value", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="variable_importance",
                title="Variable Importance",
                rows=0,
                visible="(variable_importance)",
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="importance", 
                        `title`="Importance Score", 
                        `type`="number"),
                    list(
                        `name`="rank", 
                        `title`="Rank", 
                        `type`="integer"),
                    list(
                        `name`="relative_importance", 
                        `title`="Relative Importance (%)", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="cross_validation_results",
                title="Cross-Validation Results",
                rows=0,
                visible=TRUE,
                columns=list(
                    list(
                        `name`="lambda", 
                        `title`="Lambda", 
                        `type`="number"),
                    list(
                        `name`="cv_error", 
                        `title`="CV Error", 
                        `type`="number"),
                    list(
                        `name`="cv_se", 
                        `title`="CV Standard Error", 
                        `type`="number"),
                    list(
                        `name`="n_vars", 
                        `title`="Number of Variables", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="model_comparison",
                title="Model Comparison",
                rows=0,
                visible=TRUE,
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="lambda", 
                        `title`="Lambda", 
                        `type`="number"),
                    list(
                        `name`="cv_error", 
                        `title`="CV Error", 
                        `type`="number"),
                    list(
                        `name`="n_vars", 
                        `title`="Variables", 
                        `type`="integer"),
                    list(
                        `name`="c_index", 
                        `title`="C-index", 
                        `type`="number"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="convergence_info",
                title="Convergence Information",
                rows=1,
                visible=TRUE,
                columns=list(
                    list(
                        `name`="converged", 
                        `title`="Converged", 
                        `type`="text"),
                    list(
                        `name`="iterations", 
                        `title`="Iterations", 
                        `type`="integer"),
                    list(
                        `name`="tolerance", 
                        `title`="Tolerance", 
                        `type`="number"),
                    list(
                        `name`="algorithm", 
                        `title`="Algorithm", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="regularization_path",
                title="Regularization Path",
                width=600,
                height=450,
                visible="(plot_path)",
                renderFun=".plot_regularization_path"))
            self$add(jmvcore::Image$new(
                options=options,
                name="cv_error_plot",
                title="Cross-Validation Error",
                width=600,
                height=450,
                visible="(plot_cv)",
                renderFun=".plot_cv_error"))
            self$add(jmvcore::Image$new(
                options=options,
                name="variable_selection_plot",
                title="Variable Selection Stability",
                width=600,
                height=450,
                visible="(variable_importance)",
                renderFun=".plot_variable_selection"))
            self$add(jmvcore::Image$new(
                options=options,
                name="coefficient_comparison",
                title="Coefficient Comparison",
                width=600,
                height=450,
                visible=TRUE,
                renderFun=".plot_coefficient_comparison"))
            self$add(jmvcore::Html$new(
                options=options,
                name="model_interpretation",
                title="Model Interpretation and Clinical Insights",
                visible=TRUE))}))

ncvregcoxBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ncvregcoxBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "ncvregcox",
                version = c(0,0,31),
                options = options,
                results = ncvregcoxResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Smoothly Clipped Absolute Deviation Cox Regression
#'
#' Smoothly Clipped Absolute Deviation (SCAD) Cox regression for 
#' high-dimensional survival data. 
#' SCAD provides automatic variable selection with oracle properties, avoiding 
#' over-penalization
#' of large coefficients while maintaining sparsity for small coefficients. 
#' Particularly useful
#' for genomics and high-dimensional clinical data where interpretable 
#' variable selection is crucial.
#' 
#'
#' @examples
#' ncvregcox(
#'     data = data,
#'     time = "time",
#'     event = "event",
#'     covariates = c("x1", "x2", "x3"),
#'     penalty = "SCAD",
#'     cv_folds = 10,
#'     lambda_type = "min"
#' )
#'
#' @param data the data as a data frame
#' @param time survival time variable
#' @param event event indicator (1=event, 0=censored)
#' @param covariates predictor variables for high-dimensional analysis
#' @param penalty Type of penalty function for variable selection
#' @param cv_folds Number of folds for cross-validation
#' @param lambda_type Lambda selection criterion
#' @param alpha Mixing parameter for elastic net (1=lasso, 0=ridge)
#' @param gamma SCAD gamma parameter or MCP gamma parameter
#' @param standardize Standardize covariates before fitting
#' @param plot_path Display coefficient paths plot
#' @param plot_cv Display cross-validation error plot
#' @param variable_importance Calculate and display variable importance
#'   metrics
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$model_summary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$selected_variables} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$variable_importance} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$cross_validation_results} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$model_comparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$convergence_info} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$regularization_path} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$cv_error_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$variable_selection_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$coefficient_comparison} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$model_interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$model_summary$asDF}
#'
#' \code{as.data.frame(results$model_summary)}
#'
#' @export
ncvregcox <- function(
    data,
    time,
    event,
    covariates,
    penalty = "SCAD",
    cv_folds = 10,
    lambda_type = "min",
    alpha = 1,
    gamma = 3.7,
    standardize = TRUE,
    plot_path = TRUE,
    plot_cv = TRUE,
    variable_importance = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("ncvregcox requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(event)) event <- jmvcore::resolveQuo(jmvcore::enquo(event))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(event), event, NULL),
            `if`( ! missing(covariates), covariates, NULL))

    for (v in event) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- ncvregcoxOptions$new(
        time = time,
        event = event,
        covariates = covariates,
        penalty = penalty,
        cv_folds = cv_folds,
        lambda_type = lambda_type,
        alpha = alpha,
        gamma = gamma,
        standardize = standardize,
        plot_path = plot_path,
        plot_cv = plot_cv,
        variable_importance = variable_importance)

    analysis <- ncvregcoxClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

