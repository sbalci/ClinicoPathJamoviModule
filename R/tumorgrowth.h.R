
# This file is automatically generated, you probably don't want to edit this

tumorgrowthOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "tumorgrowthOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            tumorSize = NULL,
            patientId = NULL,
            covariates = list(),
            growthModel = "gompertz",
            treatmentEffect = NULL,
            treatmentTime = NULL,
            modelApproach = "nlme",
            confidenceLevel = 95,
            modelSummary = TRUE,
            growthParameters = TRUE,
            growthCurves = TRUE,
            residualAnalysis = FALSE,
            treatmentAnalysis = FALSE,
            predictions = FALSE,
            doubleTime = TRUE,
            initialSize = NULL,
            maxSize = NULL,
            predictionTime = 30,
            mcmcSamples = 5000,
            plotWidth = 600,
            plotHeight = 450, ...) {

            super$initialize(
                package="ClinicoPath",
                name="tumorgrowth",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..tumorSize <- jmvcore::OptionVariable$new(
                "tumorSize",
                tumorSize,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..patientId <- jmvcore::OptionVariable$new(
                "patientId",
                patientId,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=list())
            private$..growthModel <- jmvcore::OptionList$new(
                "growthModel",
                growthModel,
                options=list(
                    "exponential",
                    "gompertz",
                    "logistic",
                    "bertalanffy",
                    "linear",
                    "power"),
                default="gompertz")
            private$..treatmentEffect <- jmvcore::OptionVariable$new(
                "treatmentEffect",
                treatmentEffect,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..treatmentTime <- jmvcore::OptionVariable$new(
                "treatmentTime",
                treatmentTime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..modelApproach <- jmvcore::OptionList$new(
                "modelApproach",
                modelApproach,
                options=list(
                    "nlme",
                    "nls",
                    "bayesian"),
                default="nlme")
            private$..confidenceLevel <- jmvcore::OptionNumber$new(
                "confidenceLevel",
                confidenceLevel,
                min=50,
                max=99.9,
                default=95)
            private$..modelSummary <- jmvcore::OptionBool$new(
                "modelSummary",
                modelSummary,
                default=TRUE)
            private$..growthParameters <- jmvcore::OptionBool$new(
                "growthParameters",
                growthParameters,
                default=TRUE)
            private$..growthCurves <- jmvcore::OptionBool$new(
                "growthCurves",
                growthCurves,
                default=TRUE)
            private$..residualAnalysis <- jmvcore::OptionBool$new(
                "residualAnalysis",
                residualAnalysis,
                default=FALSE)
            private$..treatmentAnalysis <- jmvcore::OptionBool$new(
                "treatmentAnalysis",
                treatmentAnalysis,
                default=FALSE)
            private$..predictions <- jmvcore::OptionBool$new(
                "predictions",
                predictions,
                default=FALSE)
            private$..doubleTime <- jmvcore::OptionBool$new(
                "doubleTime",
                doubleTime,
                default=TRUE)
            private$..initialSize <- jmvcore::OptionNumber$new(
                "initialSize",
                initialSize,
                min=0)
            private$..maxSize <- jmvcore::OptionNumber$new(
                "maxSize",
                maxSize,
                min=0)
            private$..predictionTime <- jmvcore::OptionNumber$new(
                "predictionTime",
                predictionTime,
                min=1,
                default=30)
            private$..mcmcSamples <- jmvcore::OptionInteger$new(
                "mcmcSamples",
                mcmcSamples,
                min=1000,
                max=50000,
                default=5000)
            private$..plotWidth <- jmvcore::OptionInteger$new(
                "plotWidth",
                plotWidth,
                default=600,
                min=300,
                max=2000)
            private$..plotHeight <- jmvcore::OptionInteger$new(
                "plotHeight",
                plotHeight,
                default=450,
                min=200,
                max=2000)

            self$.addOption(private$..time)
            self$.addOption(private$..tumorSize)
            self$.addOption(private$..patientId)
            self$.addOption(private$..covariates)
            self$.addOption(private$..growthModel)
            self$.addOption(private$..treatmentEffect)
            self$.addOption(private$..treatmentTime)
            self$.addOption(private$..modelApproach)
            self$.addOption(private$..confidenceLevel)
            self$.addOption(private$..modelSummary)
            self$.addOption(private$..growthParameters)
            self$.addOption(private$..growthCurves)
            self$.addOption(private$..residualAnalysis)
            self$.addOption(private$..treatmentAnalysis)
            self$.addOption(private$..predictions)
            self$.addOption(private$..doubleTime)
            self$.addOption(private$..initialSize)
            self$.addOption(private$..maxSize)
            self$.addOption(private$..predictionTime)
            self$.addOption(private$..mcmcSamples)
            self$.addOption(private$..plotWidth)
            self$.addOption(private$..plotHeight)
        }),
    active = list(
        time = function() private$..time$value,
        tumorSize = function() private$..tumorSize$value,
        patientId = function() private$..patientId$value,
        covariates = function() private$..covariates$value,
        growthModel = function() private$..growthModel$value,
        treatmentEffect = function() private$..treatmentEffect$value,
        treatmentTime = function() private$..treatmentTime$value,
        modelApproach = function() private$..modelApproach$value,
        confidenceLevel = function() private$..confidenceLevel$value,
        modelSummary = function() private$..modelSummary$value,
        growthParameters = function() private$..growthParameters$value,
        growthCurves = function() private$..growthCurves$value,
        residualAnalysis = function() private$..residualAnalysis$value,
        treatmentAnalysis = function() private$..treatmentAnalysis$value,
        predictions = function() private$..predictions$value,
        doubleTime = function() private$..doubleTime$value,
        initialSize = function() private$..initialSize$value,
        maxSize = function() private$..maxSize$value,
        predictionTime = function() private$..predictionTime$value,
        mcmcSamples = function() private$..mcmcSamples$value,
        plotWidth = function() private$..plotWidth$value,
        plotHeight = function() private$..plotHeight$value),
    private = list(
        ..time = NA,
        ..tumorSize = NA,
        ..patientId = NA,
        ..covariates = NA,
        ..growthModel = NA,
        ..treatmentEffect = NA,
        ..treatmentTime = NA,
        ..modelApproach = NA,
        ..confidenceLevel = NA,
        ..modelSummary = NA,
        ..growthParameters = NA,
        ..growthCurves = NA,
        ..residualAnalysis = NA,
        ..treatmentAnalysis = NA,
        ..predictions = NA,
        ..doubleTime = NA,
        ..initialSize = NA,
        ..maxSize = NA,
        ..predictionTime = NA,
        ..mcmcSamples = NA,
        ..plotWidth = NA,
        ..plotHeight = NA)
)

tumorgrowthResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "tumorgrowthResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        summary = function() private$.items[["summary"]],
        modelTable = function() private$.items[["modelTable"]],
        growthParametersTable = function() private$.items[["growthParametersTable"]],
        doublingTimeTable = function() private$.items[["doublingTimeTable"]],
        treatmentEffectTable = function() private$.items[["treatmentEffectTable"]],
        growthCurvesPlot = function() private$.items[["growthCurvesPlot"]],
        residualPlot = function() private$.items[["residualPlot"]],
        predictionPlot = function() private$.items[["predictionPlot"]],
        fitStatistics = function() private$.items[["fitStatistics"]],
        clinicalInterpretation = function() private$.items[["clinicalInterpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Tumor Growth Models",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="To Do",
                clearWith=list(
                    "time",
                    "tumorSize",
                    "patientId")))
            self$add(jmvcore::Html$new(
                options=options,
                name="summary",
                title="Analysis Summary",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelTable",
                title="Growth Model Parameters",
                visible="(modelSummary)",
                rows=1,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="std_error", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="t_value", 
                        `title`="t value", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Biological Meaning", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="growthParametersTable",
                title="Growth Characteristics",
                visible="(growthParameters)",
                rows=1,
                columns=list(
                    list(
                        `name`="characteristic", 
                        `title`="Characteristic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="unit", 
                        `title`="Unit", 
                        `type`="text"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="doublingTimeTable",
                title="Tumor Doubling Time",
                visible="(doubleTime)",
                rows=1,
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="doubling_time", 
                        `title`="Doubling Time", 
                        `type`="number"),
                    list(
                        `name`="unit", 
                        `title`="Unit", 
                        `type`="text"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="treatmentEffectTable",
                title="Treatment Effects on Growth",
                visible="(treatmentAnalysis)",
                rows=1,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Growth Parameter", 
                        `type`="text"),
                    list(
                        `name`="treatment_effect", 
                        `title`="Treatment Effect", 
                        `type`="number"),
                    list(
                        `name`="percent_change", 
                        `title`="% Change", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="clinical_significance", 
                        `title`="Clinical Significance", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="growthCurvesPlot",
                title="Tumor Growth Curves",
                width=700,
                height=500,
                renderFun=".plotGrowthCurves",
                visible="(growthCurves)",
                clearWith=list(
                    "time",
                    "tumorSize",
                    "patientId",
                    "growthModel",
                    "treatmentEffect")))
            self$add(jmvcore::Image$new(
                options=options,
                name="residualPlot",
                title="Residual Analysis",
                width=700,
                height=400,
                renderFun=".plotResiduals",
                visible="(residualAnalysis)",
                clearWith=list(
                    "time",
                    "tumorSize",
                    "growthModel",
                    "modelApproach")))
            self$add(jmvcore::Image$new(
                options=options,
                name="predictionPlot",
                title="Growth Predictions",
                width=700,
                height=450,
                renderFun=".plotPredictions",
                visible="(predictions)",
                clearWith=list(
                    "time",
                    "tumorSize",
                    "predictionTime",
                    "growthModel")))
            self$add(jmvcore::Table$new(
                options=options,
                name="fitStatistics",
                title="Model Fit Statistics",
                visible="(modelSummary)",
                rows=1,
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalInterpretation",
                title="Clinical Interpretation",
                visible=TRUE))}))

tumorgrowthBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "tumorgrowthBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "tumorgrowth",
                version = c(1,0,0),
                options = options,
                results = tumorgrowthResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Tumor Growth Models
#'
#' 
#' @param data the data as a data frame
#' @param time Time variable (days, weeks, months) from baseline
#' @param tumorSize Tumor size measurement (volume, diameter, etc.)
#' @param patientId Patient identifier for longitudinal data
#' @param covariates Covariates affecting tumor growth
#' @param growthModel Mathematical model for tumor growth kinetics
#' @param treatmentEffect Variable indicating treatment status or type
#' @param treatmentTime Time when treatment was initiated
#' @param modelApproach Statistical approach for parameter estimation
#' @param confidenceLevel Confidence level for parameter intervals
#' @param modelSummary Display model parameter estimates and fit statistics
#' @param growthParameters Show biological interpretation of growth parameters
#' @param growthCurves Display individual and population growth curves
#' @param residualAnalysis Perform residual diagnostics
#' @param treatmentAnalysis Analyze treatment effects on growth parameters
#' @param predictions Generate future growth predictions
#' @param doubleTime Calculate tumor doubling time
#' @param initialSize Initial tumor size (if not measured)
#' @param maxSize Theoretical maximum size for logistic models
#' @param predictionTime Time units ahead for growth predictions
#' @param mcmcSamples Number of MCMC samples for Bayesian estimation
#' @param plotWidth Width of the growth plots in pixels
#' @param plotHeight Height of the growth plots in pixels
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$growthParametersTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$doublingTimeTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$treatmentEffectTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$growthCurvesPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$residualPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$predictionPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$fitStatistics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clinicalInterpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelTable$asDF}
#'
#' \code{as.data.frame(results$modelTable)}
#'
#' @export
tumorgrowth <- function(
    data,
    time,
    tumorSize,
    patientId,
    covariates = list(),
    growthModel = "gompertz",
    treatmentEffect,
    treatmentTime,
    modelApproach = "nlme",
    confidenceLevel = 95,
    modelSummary = TRUE,
    growthParameters = TRUE,
    growthCurves = TRUE,
    residualAnalysis = FALSE,
    treatmentAnalysis = FALSE,
    predictions = FALSE,
    doubleTime = TRUE,
    initialSize,
    maxSize,
    predictionTime = 30,
    mcmcSamples = 5000,
    plotWidth = 600,
    plotHeight = 450) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("tumorgrowth requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(tumorSize)) tumorSize <- jmvcore::resolveQuo(jmvcore::enquo(tumorSize))
    if ( ! missing(patientId)) patientId <- jmvcore::resolveQuo(jmvcore::enquo(patientId))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(treatmentEffect)) treatmentEffect <- jmvcore::resolveQuo(jmvcore::enquo(treatmentEffect))
    if ( ! missing(treatmentTime)) treatmentTime <- jmvcore::resolveQuo(jmvcore::enquo(treatmentTime))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(tumorSize), tumorSize, NULL),
            `if`( ! missing(patientId), patientId, NULL),
            `if`( ! missing(covariates), covariates, NULL),
            `if`( ! missing(treatmentEffect), treatmentEffect, NULL),
            `if`( ! missing(treatmentTime), treatmentTime, NULL))

    for (v in treatmentEffect) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- tumorgrowthOptions$new(
        time = time,
        tumorSize = tumorSize,
        patientId = patientId,
        covariates = covariates,
        growthModel = growthModel,
        treatmentEffect = treatmentEffect,
        treatmentTime = treatmentTime,
        modelApproach = modelApproach,
        confidenceLevel = confidenceLevel,
        modelSummary = modelSummary,
        growthParameters = growthParameters,
        growthCurves = growthCurves,
        residualAnalysis = residualAnalysis,
        treatmentAnalysis = treatmentAnalysis,
        predictions = predictions,
        doubleTime = doubleTime,
        initialSize = initialSize,
        maxSize = maxSize,
        predictionTime = predictionTime,
        mcmcSamples = mcmcSamples,
        plotWidth = plotWidth,
        plotHeight = plotHeight)

    analysis <- tumorgrowthClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

