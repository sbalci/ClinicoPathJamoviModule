
# This file is automatically generated, you probably don't want to edit this

treatmentswitchingOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "treatmentswitchingOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            event = NULL,
            treatment = NULL,
            switchingTime = NULL,
            actualTreatment = NULL,
            covariates = list(),
            switchingMethod = "ipcw",
            switchingDirection = "control_to_treatment",
            censoringAssumption = "common_treatment",
            confidenceLevel = 95,
            treatmentEffect = TRUE,
            switchingPatterns = TRUE,
            survivalCurves = TRUE,
            sensitivityAnalysis = FALSE,
            causalEstimate = TRUE,
            methodComparison = TRUE,
            bootstrapSamples = 1000,
            psModel = NULL,
            accelerationFactor = NULL,
            treatmentLag = 0,
            plotWidth = 700,
            plotHeight = 500, ...) {

            super$initialize(
                package="ClinicoPath",
                name="treatmentswitching",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event <- jmvcore::OptionVariable$new(
                "event",
                event,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..treatment <- jmvcore::OptionVariable$new(
                "treatment",
                treatment,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..switchingTime <- jmvcore::OptionVariable$new(
                "switchingTime",
                switchingTime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..actualTreatment <- jmvcore::OptionVariable$new(
                "actualTreatment",
                actualTreatment,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=list())
            private$..switchingMethod <- jmvcore::OptionList$new(
                "switchingMethod",
                switchingMethod,
                options=list(
                    "itt",
                    "pp",
                    "ipcw",
                    "rpsft",
                    "tvc",
                    "tte"),
                default="ipcw")
            private$..switchingDirection <- jmvcore::OptionList$new(
                "switchingDirection",
                switchingDirection,
                options=list(
                    "control_to_treatment",
                    "treatment_to_control",
                    "bidirectional"),
                default="control_to_treatment")
            private$..censoringAssumption <- jmvcore::OptionList$new(
                "censoringAssumption",
                censoringAssumption,
                options=list(
                    "common_treatment",
                    "no_unmeasured_confounding",
                    "non_informative_censoring"),
                default="common_treatment")
            private$..confidenceLevel <- jmvcore::OptionNumber$new(
                "confidenceLevel",
                confidenceLevel,
                min=50,
                max=99.9,
                default=95)
            private$..treatmentEffect <- jmvcore::OptionBool$new(
                "treatmentEffect",
                treatmentEffect,
                default=TRUE)
            private$..switchingPatterns <- jmvcore::OptionBool$new(
                "switchingPatterns",
                switchingPatterns,
                default=TRUE)
            private$..survivalCurves <- jmvcore::OptionBool$new(
                "survivalCurves",
                survivalCurves,
                default=TRUE)
            private$..sensitivityAnalysis <- jmvcore::OptionBool$new(
                "sensitivityAnalysis",
                sensitivityAnalysis,
                default=FALSE)
            private$..causalEstimate <- jmvcore::OptionBool$new(
                "causalEstimate",
                causalEstimate,
                default=TRUE)
            private$..methodComparison <- jmvcore::OptionBool$new(
                "methodComparison",
                methodComparison,
                default=TRUE)
            private$..bootstrapSamples <- jmvcore::OptionInteger$new(
                "bootstrapSamples",
                bootstrapSamples,
                min=100,
                max=10000,
                default=1000)
            private$..psModel <- jmvcore::OptionString$new(
                "psModel",
                psModel)
            private$..accelerationFactor <- jmvcore::OptionNumber$new(
                "accelerationFactor",
                accelerationFactor)
            private$..treatmentLag <- jmvcore::OptionNumber$new(
                "treatmentLag",
                treatmentLag,
                min=0,
                default=0)
            private$..plotWidth <- jmvcore::OptionInteger$new(
                "plotWidth",
                plotWidth,
                default=700,
                min=300,
                max=2000)
            private$..plotHeight <- jmvcore::OptionInteger$new(
                "plotHeight",
                plotHeight,
                default=500,
                min=200,
                max=2000)

            self$.addOption(private$..time)
            self$.addOption(private$..event)
            self$.addOption(private$..treatment)
            self$.addOption(private$..switchingTime)
            self$.addOption(private$..actualTreatment)
            self$.addOption(private$..covariates)
            self$.addOption(private$..switchingMethod)
            self$.addOption(private$..switchingDirection)
            self$.addOption(private$..censoringAssumption)
            self$.addOption(private$..confidenceLevel)
            self$.addOption(private$..treatmentEffect)
            self$.addOption(private$..switchingPatterns)
            self$.addOption(private$..survivalCurves)
            self$.addOption(private$..sensitivityAnalysis)
            self$.addOption(private$..causalEstimate)
            self$.addOption(private$..methodComparison)
            self$.addOption(private$..bootstrapSamples)
            self$.addOption(private$..psModel)
            self$.addOption(private$..accelerationFactor)
            self$.addOption(private$..treatmentLag)
            self$.addOption(private$..plotWidth)
            self$.addOption(private$..plotHeight)
        }),
    active = list(
        time = function() private$..time$value,
        event = function() private$..event$value,
        treatment = function() private$..treatment$value,
        switchingTime = function() private$..switchingTime$value,
        actualTreatment = function() private$..actualTreatment$value,
        covariates = function() private$..covariates$value,
        switchingMethod = function() private$..switchingMethod$value,
        switchingDirection = function() private$..switchingDirection$value,
        censoringAssumption = function() private$..censoringAssumption$value,
        confidenceLevel = function() private$..confidenceLevel$value,
        treatmentEffect = function() private$..treatmentEffect$value,
        switchingPatterns = function() private$..switchingPatterns$value,
        survivalCurves = function() private$..survivalCurves$value,
        sensitivityAnalysis = function() private$..sensitivityAnalysis$value,
        causalEstimate = function() private$..causalEstimate$value,
        methodComparison = function() private$..methodComparison$value,
        bootstrapSamples = function() private$..bootstrapSamples$value,
        psModel = function() private$..psModel$value,
        accelerationFactor = function() private$..accelerationFactor$value,
        treatmentLag = function() private$..treatmentLag$value,
        plotWidth = function() private$..plotWidth$value,
        plotHeight = function() private$..plotHeight$value),
    private = list(
        ..time = NA,
        ..event = NA,
        ..treatment = NA,
        ..switchingTime = NA,
        ..actualTreatment = NA,
        ..covariates = NA,
        ..switchingMethod = NA,
        ..switchingDirection = NA,
        ..censoringAssumption = NA,
        ..confidenceLevel = NA,
        ..treatmentEffect = NA,
        ..switchingPatterns = NA,
        ..survivalCurves = NA,
        ..sensitivityAnalysis = NA,
        ..causalEstimate = NA,
        ..methodComparison = NA,
        ..bootstrapSamples = NA,
        ..psModel = NA,
        ..accelerationFactor = NA,
        ..treatmentLag = NA,
        ..plotWidth = NA,
        ..plotHeight = NA)
)

treatmentswitchingResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "treatmentswitchingResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        summary = function() private$.items[["summary"]],
        switchingPatternsTable = function() private$.items[["switchingPatternsTable"]],
        treatmentEffectTable = function() private$.items[["treatmentEffectTable"]],
        causalEffectTable = function() private$.items[["causalEffectTable"]],
        methodComparisonTable = function() private$.items[["methodComparisonTable"]],
        survivalCurvesPlot = function() private$.items[["survivalCurvesPlot"]],
        switchingPatternsPlot = function() private$.items[["switchingPatternsPlot"]],
        sensitivityPlot = function() private$.items[["sensitivityPlot"]],
        diagnosticsTable = function() private$.items[["diagnosticsTable"]],
        sensitivityTable = function() private$.items[["sensitivityTable"]],
        bootstrapTable = function() private$.items[["bootstrapTable"]],
        clinicalInterpretation = function() private$.items[["clinicalInterpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Treatment Switching Analysis",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "urvival",
                    "urvminer",
                    "glue",
                    "parallel"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="To Do",
                clearWith=list(
                    "time",
                    "event",
                    "treatment",
                    "switchingTime")))
            self$add(jmvcore::Html$new(
                options=options,
                name="summary",
                title="Analysis Summary",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="switchingPatternsTable",
                title="Treatment Switching Patterns",
                visible="(switchingPatterns)",
                rows=1,
                columns=list(
                    list(
                        `name`="pattern", 
                        `title`="Switching Pattern", 
                        `type`="text"),
                    list(
                        `name`="n_patients", 
                        `title`="N Patients", 
                        `type`="integer"),
                    list(
                        `name`="percentage", 
                        `title`="Percentage", 
                        `type`="number"),
                    list(
                        `name`="median_switch_time", 
                        `title`="Median Switch Time", 
                        `type`="number"),
                    list(
                        `name`="switch_time_iqr", 
                        `title`="IQR Switch Time", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="treatmentEffectTable",
                title="Treatment Effect Estimates",
                visible="(treatmentEffect)",
                rows=1,
                columns=list(
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"),
                    list(
                        `name`="hr", 
                        `title`="Hazard Ratio", 
                        `type`="number"),
                    list(
                        `name`="hr_ci_lower", 
                        `title`="HR CI Lower", 
                        `type`="number"),
                    list(
                        `name`="hr_ci_upper", 
                        `title`="HR CI Upper", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="causalEffectTable",
                title="Causal Treatment Effects",
                visible="(causalEstimate)",
                rows=1,
                columns=list(
                    list(
                        `name`="estimand", 
                        `title`="Estimand", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="std_error", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="CI Upper", 
                        `type`="number"),
                    list(
                        `name`="assumption", 
                        `title`="Key Assumption", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="methodComparisonTable",
                title="Method Comparison",
                visible="(methodComparison)",
                rows=1,
                columns=list(
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"),
                    list(
                        `name`="bias_direction", 
                        `title`="Likely Bias Direction", 
                        `type`="text"),
                    list(
                        `name`="assumptions", 
                        `title`="Key Assumptions", 
                        `type`="text"),
                    list(
                        `name`="hr_estimate", 
                        `title`="HR Estimate", 
                        `type`="number"),
                    list(
                        `name`="recommendation", 
                        `title`="Recommendation", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalCurvesPlot",
                title="Survival Curves by Switching Method",
                width=700,
                height=500,
                renderFun=".plotSurvivalCurves",
                visible="(survivalCurves)",
                clearWith=list(
                    "time",
                    "event",
                    "treatment",
                    "switchingMethod")))
            self$add(jmvcore::Image$new(
                options=options,
                name="switchingPatternsPlot",
                title="Treatment Switching Timeline",
                width=700,
                height=400,
                renderFun=".plotSwitchingPatterns",
                visible="(switchingPatterns)",
                clearWith=list(
                    "switchingTime",
                    "treatment",
                    "actualTreatment")))
            self$add(jmvcore::Image$new(
                options=options,
                name="sensitivityPlot",
                title="Sensitivity Analysis",
                width=600,
                height=400,
                renderFun=".plotSensitivity",
                visible="(sensitivityAnalysis)",
                clearWith=list(
                    "switchingMethod",
                    "accelerationFactor",
                    "treatmentLag")))
            self$add(jmvcore::Table$new(
                options=options,
                name="diagnosticsTable",
                title="Model Diagnostics",
                visible="(causalEstimate)",
                rows=1,
                columns=list(
                    list(
                        `name`="diagnostic", 
                        `title`="Diagnostic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="sensitivityTable",
                title="Sensitivity Analysis Results",
                visible="(sensitivityAnalysis)",
                rows=1,
                columns=list(
                    list(
                        `name`="analysis_type", 
                        `title`="Analysis Type", 
                        `type`="text"),
                    list(
                        `name`="parameter", 
                        `title`="Parameter/Model", 
                        `type`="text"),
                    list(
                        `name`="hr", 
                        `title`="Hazard Ratio", 
                        `type`="number"),
                    list(
                        `name`="hr_ci", 
                        `title`="95% CI", 
                        `type`="text"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="bootstrapTable",
                title="Bootstrap Confidence Intervals",
                visible="(bootstrapSamples>0)",
                rows=1,
                columns=list(
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"),
                    list(
                        `name`="n_bootstrap", 
                        `title`="Bootstrap Samples", 
                        `type`="integer"),
                    list(
                        `name`="boot_ci_lower", 
                        `title`="Bootstrap CI Lower", 
                        `type`="number"),
                    list(
                        `name`="boot_ci_upper", 
                        `title`="Bootstrap CI Upper", 
                        `type`="number"),
                    list(
                        `name`="boot_se", 
                        `title`="Bootstrap SE", 
                        `type`="number"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalInterpretation",
                title="Clinical Interpretation",
                visible=TRUE))}))

treatmentswitchingBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "treatmentswitchingBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "treatmentswitching",
                version = c(1,0,0),
                options = options,
                results = treatmentswitchingResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Treatment Switching Analysis
#'
#' 
#' @param data the data as a data frame
#' @param time Time to event or censoring
#' @param event Event status (0 = censored, 1 = event)
#' @param treatment Original randomized treatment assignment
#' @param switchingTime Time when treatment switching occurred (NA if no
#'   switching)
#' @param actualTreatment Actual treatment received after any switching
#' @param covariates Baseline covariates for adjustment
#' @param switchingMethod Method for handling treatment switching
#' @param switchingDirection Direction of treatment switching allowed
#' @param censoringAssumption Assumptions for handling censoring in switching
#'   analysis
#' @param confidenceLevel Confidence level for interval estimation
#' @param treatmentEffect Display treatment effect estimates for different
#'   methods
#' @param switchingPatterns Summarize patterns of treatment switching
#' @param survivalCurves Display survival curves with switching adjustments
#' @param sensitivityAnalysis Perform sensitivity analysis for switching
#'   assumptions
#' @param causalEstimate Estimate causal treatment effects adjusting for
#'   switching
#' @param methodComparison Compare results across different switching methods
#' @param bootstrapSamples Number of bootstrap samples for uncertainty
#'   estimation
#' @param psModel Formula for propensity score model (for IPCW method)
#' @param accelerationFactor Acceleration factor for RPSFT method (estimated
#'   if not specified)
#' @param treatmentLag Lag time before treatment effect begins
#' @param plotWidth Width of survival plots in pixels
#' @param plotHeight Height of survival plots in pixels
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$switchingPatternsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$treatmentEffectTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$causalEffectTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$methodComparisonTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$survivalCurvesPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$switchingPatternsPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$sensitivityPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$diagnosticsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$sensitivityTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$bootstrapTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clinicalInterpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$switchingPatternsTable$asDF}
#'
#' \code{as.data.frame(results$switchingPatternsTable)}
#'
#' @export
treatmentswitching <- function(
    data,
    time,
    event,
    treatment,
    switchingTime,
    actualTreatment,
    covariates = list(),
    switchingMethod = "ipcw",
    switchingDirection = "control_to_treatment",
    censoringAssumption = "common_treatment",
    confidenceLevel = 95,
    treatmentEffect = TRUE,
    switchingPatterns = TRUE,
    survivalCurves = TRUE,
    sensitivityAnalysis = FALSE,
    causalEstimate = TRUE,
    methodComparison = TRUE,
    bootstrapSamples = 1000,
    psModel,
    accelerationFactor,
    treatmentLag = 0,
    plotWidth = 700,
    plotHeight = 500) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("treatmentswitching requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(event)) event <- jmvcore::resolveQuo(jmvcore::enquo(event))
    if ( ! missing(treatment)) treatment <- jmvcore::resolveQuo(jmvcore::enquo(treatment))
    if ( ! missing(switchingTime)) switchingTime <- jmvcore::resolveQuo(jmvcore::enquo(switchingTime))
    if ( ! missing(actualTreatment)) actualTreatment <- jmvcore::resolveQuo(jmvcore::enquo(actualTreatment))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(event), event, NULL),
            `if`( ! missing(treatment), treatment, NULL),
            `if`( ! missing(switchingTime), switchingTime, NULL),
            `if`( ! missing(actualTreatment), actualTreatment, NULL),
            `if`( ! missing(covariates), covariates, NULL))

    for (v in treatment) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in actualTreatment) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- treatmentswitchingOptions$new(
        time = time,
        event = event,
        treatment = treatment,
        switchingTime = switchingTime,
        actualTreatment = actualTreatment,
        covariates = covariates,
        switchingMethod = switchingMethod,
        switchingDirection = switchingDirection,
        censoringAssumption = censoringAssumption,
        confidenceLevel = confidenceLevel,
        treatmentEffect = treatmentEffect,
        switchingPatterns = switchingPatterns,
        survivalCurves = survivalCurves,
        sensitivityAnalysis = sensitivityAnalysis,
        causalEstimate = causalEstimate,
        methodComparison = methodComparison,
        bootstrapSamples = bootstrapSamples,
        psModel = psModel,
        accelerationFactor = accelerationFactor,
        treatmentLag = treatmentLag,
        plotWidth = plotWidth,
        plotHeight = plotHeight)

    analysis <- treatmentswitchingClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

