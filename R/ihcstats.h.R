
# This file is automatically generated, you probably don't want to edit this

ihcstatsOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcstatsOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            markers = NULL,
            computeHScore = FALSE,
            clusterMethod = "hierarchical",
            distanceMetric = "gower",
            nClusters = 3,
            showDendrogram = FALSE,
            showHeatmap = FALSE,
            showScoreDist = FALSE,
            pcaAnalysis = FALSE,
            standardizeData = TRUE,
            showPCAPlot = FALSE,
            showClusterValidation = FALSE,
            optimalKMethod = "elbow",
            iterativeClustering = FALSE,
            linkageMethod = "average",
            showDiagnostics = FALSE,
            groupVariable = NULL,
            scoringScale = "standard",
            tumorRegionAnalysis = FALSE,
            centralRegionVar = NULL,
            invasiveRegionVar = NULL,
            prognosticClustering = FALSE,
            survivalTimeVar = NULL,
            survivalEventVar = NULL,
            differentialDiagnosis = FALSE,
            tumorTypeVar = NULL,
            antibodyOptimization = FALSE,
            calculateDiagnosticMetrics = FALSE,
            olsenVisualization = FALSE,
            clusterCutHeight = 0.5,
            sterlacciAnalysis = FALSE,
            supervisedClustering = FALSE,
            reproductibilityTesting = FALSE,
            immuneSignatureFocus = FALSE,
            tilAnalysisMode = "combined_til",
            multipleTesting = "bonferroni",
            significanceThreshold = 0.000055, ...) {

            super$initialize(
                package="ClinicoPath",
                name="ihcstats",
                requiresData=TRUE,
                ...)

            private$..markers <- jmvcore::OptionVariables$new(
                "markers",
                markers,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..computeHScore <- jmvcore::OptionBool$new(
                "computeHScore",
                computeHScore,
                default=FALSE)
            private$..clusterMethod <- jmvcore::OptionList$new(
                "clusterMethod",
                clusterMethod,
                options=list(
                    "hierarchical",
                    "pam",
                    "kmeans",
                    "pca_kmeans"),
                default="hierarchical")
            private$..distanceMetric <- jmvcore::OptionList$new(
                "distanceMetric",
                distanceMetric,
                options=list(
                    "gower",
                    "jaccard"),
                default="gower")
            private$..nClusters <- jmvcore::OptionInteger$new(
                "nClusters",
                nClusters,
                min=2,
                max=10,
                default=3)
            private$..showDendrogram <- jmvcore::OptionBool$new(
                "showDendrogram",
                showDendrogram,
                default=FALSE)
            private$..showHeatmap <- jmvcore::OptionBool$new(
                "showHeatmap",
                showHeatmap,
                default=FALSE)
            private$..showScoreDist <- jmvcore::OptionBool$new(
                "showScoreDist",
                showScoreDist,
                default=FALSE)
            private$..pcaAnalysis <- jmvcore::OptionBool$new(
                "pcaAnalysis",
                pcaAnalysis,
                default=FALSE)
            private$..standardizeData <- jmvcore::OptionBool$new(
                "standardizeData",
                standardizeData,
                default=TRUE)
            private$..showPCAPlot <- jmvcore::OptionBool$new(
                "showPCAPlot",
                showPCAPlot,
                default=FALSE)
            private$..showClusterValidation <- jmvcore::OptionBool$new(
                "showClusterValidation",
                showClusterValidation,
                default=FALSE)
            private$..optimalKMethod <- jmvcore::OptionList$new(
                "optimalKMethod",
                optimalKMethod,
                options=list(
                    "elbow",
                    "silhouette",
                    "gap"),
                default="elbow")
            private$..iterativeClustering <- jmvcore::OptionBool$new(
                "iterativeClustering",
                iterativeClustering,
                default=FALSE)
            private$..linkageMethod <- jmvcore::OptionList$new(
                "linkageMethod",
                linkageMethod,
                options=list(
                    "average",
                    "complete",
                    "ward.D2",
                    "single"),
                default="average")
            private$..showDiagnostics <- jmvcore::OptionBool$new(
                "showDiagnostics",
                showDiagnostics,
                default=FALSE)
            private$..groupVariable <- jmvcore::OptionVariable$new(
                "groupVariable",
                groupVariable,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..scoringScale <- jmvcore::OptionList$new(
                "scoringScale",
                scoringScale,
                options=list(
                    "binary",
                    "carvalho",
                    "standard",
                    "hscore",
                    "matsuoka"),
                default="standard")
            private$..tumorRegionAnalysis <- jmvcore::OptionBool$new(
                "tumorRegionAnalysis",
                tumorRegionAnalysis,
                default=FALSE)
            private$..centralRegionVar <- jmvcore::OptionVariable$new(
                "centralRegionVar",
                centralRegionVar,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..invasiveRegionVar <- jmvcore::OptionVariable$new(
                "invasiveRegionVar",
                invasiveRegionVar,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..prognosticClustering <- jmvcore::OptionBool$new(
                "prognosticClustering",
                prognosticClustering,
                default=FALSE)
            private$..survivalTimeVar <- jmvcore::OptionVariable$new(
                "survivalTimeVar",
                survivalTimeVar,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..survivalEventVar <- jmvcore::OptionVariable$new(
                "survivalEventVar",
                survivalEventVar,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..differentialDiagnosis <- jmvcore::OptionBool$new(
                "differentialDiagnosis",
                differentialDiagnosis,
                default=FALSE)
            private$..tumorTypeVar <- jmvcore::OptionVariable$new(
                "tumorTypeVar",
                tumorTypeVar,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..antibodyOptimization <- jmvcore::OptionBool$new(
                "antibodyOptimization",
                antibodyOptimization,
                default=FALSE)
            private$..calculateDiagnosticMetrics <- jmvcore::OptionBool$new(
                "calculateDiagnosticMetrics",
                calculateDiagnosticMetrics,
                default=FALSE)
            private$..olsenVisualization <- jmvcore::OptionBool$new(
                "olsenVisualization",
                olsenVisualization,
                default=FALSE)
            private$..clusterCutHeight <- jmvcore::OptionNumber$new(
                "clusterCutHeight",
                clusterCutHeight,
                min=0.1,
                max=1,
                default=0.5)
            private$..sterlacciAnalysis <- jmvcore::OptionBool$new(
                "sterlacciAnalysis",
                sterlacciAnalysis,
                default=FALSE)
            private$..supervisedClustering <- jmvcore::OptionBool$new(
                "supervisedClustering",
                supervisedClustering,
                default=FALSE)
            private$..reproductibilityTesting <- jmvcore::OptionBool$new(
                "reproductibilityTesting",
                reproductibilityTesting,
                default=FALSE)
            private$..immuneSignatureFocus <- jmvcore::OptionBool$new(
                "immuneSignatureFocus",
                immuneSignatureFocus,
                default=FALSE)
            private$..tilAnalysisMode <- jmvcore::OptionList$new(
                "tilAnalysisMode",
                tilAnalysisMode,
                options=list(
                    "cd4cd8_ratio",
                    "granzyme_til",
                    "combined_til",
                    "all_til"),
                default="combined_til")
            private$..multipleTesting <- jmvcore::OptionList$new(
                "multipleTesting",
                multipleTesting,
                options=list(
                    "bonferroni",
                    "none"),
                default="bonferroni")
            private$..significanceThreshold <- jmvcore::OptionNumber$new(
                "significanceThreshold",
                significanceThreshold,
                min=0.001,
                max=0.05,
                default=0.000055)

            self$.addOption(private$..markers)
            self$.addOption(private$..computeHScore)
            self$.addOption(private$..clusterMethod)
            self$.addOption(private$..distanceMetric)
            self$.addOption(private$..nClusters)
            self$.addOption(private$..showDendrogram)
            self$.addOption(private$..showHeatmap)
            self$.addOption(private$..showScoreDist)
            self$.addOption(private$..pcaAnalysis)
            self$.addOption(private$..standardizeData)
            self$.addOption(private$..showPCAPlot)
            self$.addOption(private$..showClusterValidation)
            self$.addOption(private$..optimalKMethod)
            self$.addOption(private$..iterativeClustering)
            self$.addOption(private$..linkageMethod)
            self$.addOption(private$..showDiagnostics)
            self$.addOption(private$..groupVariable)
            self$.addOption(private$..scoringScale)
            self$.addOption(private$..tumorRegionAnalysis)
            self$.addOption(private$..centralRegionVar)
            self$.addOption(private$..invasiveRegionVar)
            self$.addOption(private$..prognosticClustering)
            self$.addOption(private$..survivalTimeVar)
            self$.addOption(private$..survivalEventVar)
            self$.addOption(private$..differentialDiagnosis)
            self$.addOption(private$..tumorTypeVar)
            self$.addOption(private$..antibodyOptimization)
            self$.addOption(private$..calculateDiagnosticMetrics)
            self$.addOption(private$..olsenVisualization)
            self$.addOption(private$..clusterCutHeight)
            self$.addOption(private$..sterlacciAnalysis)
            self$.addOption(private$..supervisedClustering)
            self$.addOption(private$..reproductibilityTesting)
            self$.addOption(private$..immuneSignatureFocus)
            self$.addOption(private$..tilAnalysisMode)
            self$.addOption(private$..multipleTesting)
            self$.addOption(private$..significanceThreshold)
        }),
    active = list(
        markers = function() private$..markers$value,
        computeHScore = function() private$..computeHScore$value,
        clusterMethod = function() private$..clusterMethod$value,
        distanceMetric = function() private$..distanceMetric$value,
        nClusters = function() private$..nClusters$value,
        showDendrogram = function() private$..showDendrogram$value,
        showHeatmap = function() private$..showHeatmap$value,
        showScoreDist = function() private$..showScoreDist$value,
        pcaAnalysis = function() private$..pcaAnalysis$value,
        standardizeData = function() private$..standardizeData$value,
        showPCAPlot = function() private$..showPCAPlot$value,
        showClusterValidation = function() private$..showClusterValidation$value,
        optimalKMethod = function() private$..optimalKMethod$value,
        iterativeClustering = function() private$..iterativeClustering$value,
        linkageMethod = function() private$..linkageMethod$value,
        showDiagnostics = function() private$..showDiagnostics$value,
        groupVariable = function() private$..groupVariable$value,
        scoringScale = function() private$..scoringScale$value,
        tumorRegionAnalysis = function() private$..tumorRegionAnalysis$value,
        centralRegionVar = function() private$..centralRegionVar$value,
        invasiveRegionVar = function() private$..invasiveRegionVar$value,
        prognosticClustering = function() private$..prognosticClustering$value,
        survivalTimeVar = function() private$..survivalTimeVar$value,
        survivalEventVar = function() private$..survivalEventVar$value,
        differentialDiagnosis = function() private$..differentialDiagnosis$value,
        tumorTypeVar = function() private$..tumorTypeVar$value,
        antibodyOptimization = function() private$..antibodyOptimization$value,
        calculateDiagnosticMetrics = function() private$..calculateDiagnosticMetrics$value,
        olsenVisualization = function() private$..olsenVisualization$value,
        clusterCutHeight = function() private$..clusterCutHeight$value,
        sterlacciAnalysis = function() private$..sterlacciAnalysis$value,
        supervisedClustering = function() private$..supervisedClustering$value,
        reproductibilityTesting = function() private$..reproductibilityTesting$value,
        immuneSignatureFocus = function() private$..immuneSignatureFocus$value,
        tilAnalysisMode = function() private$..tilAnalysisMode$value,
        multipleTesting = function() private$..multipleTesting$value,
        significanceThreshold = function() private$..significanceThreshold$value),
    private = list(
        ..markers = NA,
        ..computeHScore = NA,
        ..clusterMethod = NA,
        ..distanceMetric = NA,
        ..nClusters = NA,
        ..showDendrogram = NA,
        ..showHeatmap = NA,
        ..showScoreDist = NA,
        ..pcaAnalysis = NA,
        ..standardizeData = NA,
        ..showPCAPlot = NA,
        ..showClusterValidation = NA,
        ..optimalKMethod = NA,
        ..iterativeClustering = NA,
        ..linkageMethod = NA,
        ..showDiagnostics = NA,
        ..groupVariable = NA,
        ..scoringScale = NA,
        ..tumorRegionAnalysis = NA,
        ..centralRegionVar = NA,
        ..invasiveRegionVar = NA,
        ..prognosticClustering = NA,
        ..survivalTimeVar = NA,
        ..survivalEventVar = NA,
        ..differentialDiagnosis = NA,
        ..tumorTypeVar = NA,
        ..antibodyOptimization = NA,
        ..calculateDiagnosticMetrics = NA,
        ..olsenVisualization = NA,
        ..clusterCutHeight = NA,
        ..sterlacciAnalysis = NA,
        ..supervisedClustering = NA,
        ..reproductibilityTesting = NA,
        ..immuneSignatureFocus = NA,
        ..tilAnalysisMode = NA,
        ..multipleTesting = NA,
        ..significanceThreshold = NA)
)

ihcstatsResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcstatsResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        hscoreTable = function() private$.items[["hscoreTable"]],
        clusterSummary = function() private$.items[["clusterSummary"]],
        pcaTable = function() private$.items[["pcaTable"]],
        silhouetteTable = function() private$.items[["silhouetteTable"]],
        diagnosticTable = function() private$.items[["diagnosticTable"]],
        optimalMarkersTable = function() private$.items[["optimalMarkersTable"]],
        regionalTable = function() private$.items[["regionalTable"]],
        prognosticTable = function() private$.items[["prognosticTable"]],
        survivalTable = function() private$.items[["survivalTable"]],
        differentialTable = function() private$.items[["differentialTable"]],
        antibodyPerformanceTable = function() private$.items[["antibodyPerformanceTable"]],
        optimalPanelTable = function() private$.items[["optimalPanelTable"]],
        sterlacciTable = function() private$.items[["sterlacciTable"]],
        reproductibilityTable = function() private$.items[["reproductibilityTable"]],
        supervisedResultsTable = function() private$.items[["supervisedResultsTable"]],
        tilSignatureTable = function() private$.items[["tilSignatureTable"]],
        dendrogramPlot = function() private$.items[["dendrogramPlot"]],
        heatmapPlot = function() private$.items[["heatmapPlot"]],
        pcaPlot = function() private$.items[["pcaPlot"]],
        validationPlot = function() private$.items[["validationPlot"]],
        scoreDist = function() private$.items[["scoreDist"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="IHC Expression Analysis",
                refs=list(
                    "sterlacci2020",
                    "olsen2006",
                    "matsuoka2011",
                    "carvalho2011",
                    "laas2019"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Getting Started"))
            self$add(jmvcore::Table$new(
                options=options,
                name="hscoreTable",
                title="H-Score Analysis",
                visible="(computeHScore)",
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="hscore", 
                        `title`="H-Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="dist", 
                        `title`="Score Distribution", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="clusterSummary",
                title="Clustering Results",
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="integer"),
                    list(
                        `name`="size", 
                        `title`="Size", 
                        `type`="integer"),
                    list(
                        `name`="pattern", 
                        `title`="Expression Pattern", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="pcaTable",
                title="Principal Component Analysis",
                visible="(pcaAnalysis)",
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="eigenvalue", 
                        `title`="Eigenvalue", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="variance_explained", 
                        `title`="Variance %", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cumulative_variance", 
                        `title`="Cumulative %", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="silhouetteTable",
                title="Clustering Quality Assessment",
                visible="(silhouetteAnalysis)",
                columns=list(
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"),
                    list(
                        `name`="clusters", 
                        `title`="Clusters", 
                        `type`="integer"),
                    list(
                        `name`="avg_silhouette", 
                        `title`="Avg Silhouette Width", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="diagnosticTable",
                title="Diagnostic Performance Analysis",
                visible="(showDiagnostics)",
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity %", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity %", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ppv", 
                        `title`="PPV %", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="npv", 
                        `title`="NPV %", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="optimalMarkersTable",
                title="Optimal Marker Panel",
                visible="(iterativeClustering)",
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="separation_score", 
                        `title`="Separation Score", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="status", 
                        `title`="Status", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="regionalTable",
                title="Multi-Region Analysis (Central vs Invasive)",
                visible="(tumorRegionAnalysis)",
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="central_mean", 
                        `title`="Central Mean", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="invasive_mean", 
                        `title`="Invasive Mean", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="correlation", 
                        `title`="Correlation", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="p_value", 
                        `title`="P-value", 
                        `type`="text"),
                    list(
                        `name`="significance", 
                        `title`="Significance", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="prognosticTable",
                title="Prognostic Clustering Results",
                visible="(prognosticClustering)",
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="integer"),
                    list(
                        `name`="label", 
                        `title`="Prognosis", 
                        `type`="text"),
                    list(
                        `name`="size", 
                        `title`="Size", 
                        `type`="integer"),
                    list(
                        `name`="percentage", 
                        `title`="Percentage %", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="pattern", 
                        `title`="Expression Pattern", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="survivalTable",
                title="Survival Analysis (Cox Regression)",
                visible="(prognosticClustering)",
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="hazard_ratio", 
                        `title`="Hazard Ratio", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="p_value", 
                        `title`="P-value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="significance", 
                        `title`="Significance", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="differentialTable",
                title="Differential Diagnosis Results (Olsen Method)",
                visible="(differentialDiagnosis)",
                columns=list(
                    list(
                        `name`="tumor_type", 
                        `title`="Tumor Type", 
                        `type`="text"),
                    list(
                        `name`="predicted_group", 
                        `title`="Predicted Group", 
                        `type`="integer"),
                    list(
                        `name`="confidence", 
                        `title`="Confidence %", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="outlier_status", 
                        `title`="Outlier Status", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="antibodyPerformanceTable",
                title="Antibody Performance Analysis",
                visible="(antibodyOptimization)",
                columns=list(
                    list(
                        `name`="antibody", 
                        `title`="Antibody", 
                        `type`="text"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity %", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity %", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="ppv", 
                        `title`="PPV %", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="npv", 
                        `title`="NPV %", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="diagnostic_utility", 
                        `title`="Diagnostic Utility", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="optimalPanelTable",
                title="Optimal Antibody Panel Combinations",
                visible="(antibodyOptimization)",
                columns=list(
                    list(
                        `name`="combination", 
                        `title`="Antibody Combination", 
                        `type`="text"),
                    list(
                        `name`="target_tumor", 
                        `title`="Target Tumor Type", 
                        `type`="text"),
                    list(
                        `name`="combined_sensitivity", 
                        `title`="Combined Sensitivity %", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="combined_specificity", 
                        `title`="Combined Specificity %", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="recommendation", 
                        `title`="Recommendation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="sterlacciTable",
                title="Sterlacci TIL Signature Analysis",
                visible="(sterlacciAnalysis)",
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="integer"),
                    list(
                        `name`="cluster_type", 
                        `title`="Cluster Type", 
                        `type`="text"),
                    list(
                        `name`="size", 
                        `title`="Size", 
                        `type`="integer"),
                    list(
                        `name`="cd4_cd8_ratio", 
                        `title`="CD4/CD8 Ratio", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cd8_til_count", 
                        `title`="CD8+ TIL Count", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="granzyme_b_til", 
                        `title`="Granzyme B+ TIL", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="immune_signature", 
                        `title`="Immune Signature", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="reproductibilityTable",
                title="Cluster Reproducibility Analysis",
                visible="(reproductibilityTesting)",
                columns=list(
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="integer"),
                    list(
                        `name`="cohen_kappa", 
                        `title`="Cohen's \u03BA", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="reproducibility", 
                        `title`="Reproducibility", 
                        `type`="text"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="supervisedResultsTable",
                title="Supervised Clustering Results",
                visible="(supervisedClustering)",
                columns=list(
                    list(
                        `name`="histotype", 
                        `title`="Histotype", 
                        `type`="text"),
                    list(
                        `name`="cluster", 
                        `title`="Cluster", 
                        `type`="integer"),
                    list(
                        `name`="size", 
                        `title`="Size", 
                        `type`="integer"),
                    list(
                        `name`="percentage", 
                        `title`="Percentage %", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="defining_markers", 
                        `title`="Defining Markers", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="tilSignatureTable",
                title="TIL Signature Characterization",
                visible="(sterlacciAnalysis)",
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="TIL Marker", 
                        `type`="text"),
                    list(
                        `name`="cluster_1", 
                        `title`="Cluster 1 Mean", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cluster_2", 
                        `title`="Cluster 2 Mean", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cluster_3", 
                        `title`="Cluster 3 Mean", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="p_value", 
                        `title`="P-value", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="significance", 
                        `title`="Significance", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="dendrogramPlot",
                title="Expression Pattern Dendrogram",
                visible="(showDendrogram)",
                renderFun=".visualizeDendrogram",
                width=800,
                height=600))
            self$add(jmvcore::Image$new(
                options=options,
                name="heatmapPlot",
                title="IHC Expression Heatmap",
                visible="(showHeatmap)",
                renderFun=".visualizeClusterHeatmap",
                width=800,
                height=600))
            self$add(jmvcore::Image$new(
                options=options,
                name="pcaPlot",
                title="PCA Biplot with Clusters",
                visible="(showPCAPlot)",
                renderFun=".visualizePCABiplot",
                width=800,
                height=600))
            self$add(jmvcore::Image$new(
                options=options,
                name="validationPlot",
                title="Cluster Validation",
                visible="(showClusterValidation)",
                renderFun=".visualizeClusterValidation",
                width=700,
                height=500))
            self$add(jmvcore::Image$new(
                options=options,
                name="scoreDist",
                title="Score Distribution",
                visible="(showScoreDist)",
                renderFun=".scoreDistPlot",
                width=600,
                height=400))}))

ihcstatsBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcstatsBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "ihcstats",
                version = c(0,0,3),
                options = options,
                results = ihcstatsResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' IHC Expression Analysis
#'
#' 
#' @param data The data as a data frame.
#' @param markers IHC marker variables with categorical expression scores
#' @param computeHScore .
#' @param clusterMethod .
#' @param distanceMetric .
#' @param nClusters .
#' @param showDendrogram .
#' @param showHeatmap .
#' @param showScoreDist .
#' @param pcaAnalysis .
#' @param standardizeData .
#' @param showPCAPlot .
#' @param showClusterValidation .
#' @param optimalKMethod .
#' @param iterativeClustering .
#' @param linkageMethod .
#' @param showDiagnostics .
#' @param groupVariable .
#' @param scoringScale .
#' @param tumorRegionAnalysis .
#' @param centralRegionVar .
#' @param invasiveRegionVar .
#' @param prognosticClustering .
#' @param survivalTimeVar .
#' @param survivalEventVar .
#' @param differentialDiagnosis .
#' @param tumorTypeVar .
#' @param antibodyOptimization .
#' @param calculateDiagnosticMetrics .
#' @param olsenVisualization .
#' @param clusterCutHeight .
#' @param sterlacciAnalysis .
#' @param supervisedClustering .
#' @param reproductibilityTesting .
#' @param immuneSignatureFocus .
#' @param tilAnalysisMode .
#' @param multipleTesting .
#' @param significanceThreshold .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$hscoreTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$clusterSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$pcaTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$silhouetteTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$diagnosticTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$optimalMarkersTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$regionalTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$prognosticTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$survivalTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$differentialTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$antibodyPerformanceTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$optimalPanelTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$sterlacciTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$reproductibilityTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$supervisedResultsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$tilSignatureTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$dendrogramPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$heatmapPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$pcaPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$validationPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$scoreDist} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$hscoreTable$asDF}
#'
#' \code{as.data.frame(results$hscoreTable)}
#'
#' @export
ihcstats <- function(
    data,
    markers,
    computeHScore = FALSE,
    clusterMethod = "hierarchical",
    distanceMetric = "gower",
    nClusters = 3,
    showDendrogram = FALSE,
    showHeatmap = FALSE,
    showScoreDist = FALSE,
    pcaAnalysis = FALSE,
    standardizeData = TRUE,
    showPCAPlot = FALSE,
    showClusterValidation = FALSE,
    optimalKMethod = "elbow",
    iterativeClustering = FALSE,
    linkageMethod = "average",
    showDiagnostics = FALSE,
    groupVariable = NULL,
    scoringScale = "standard",
    tumorRegionAnalysis = FALSE,
    centralRegionVar = NULL,
    invasiveRegionVar = NULL,
    prognosticClustering = FALSE,
    survivalTimeVar = NULL,
    survivalEventVar = NULL,
    differentialDiagnosis = FALSE,
    tumorTypeVar = NULL,
    antibodyOptimization = FALSE,
    calculateDiagnosticMetrics = FALSE,
    olsenVisualization = FALSE,
    clusterCutHeight = 0.5,
    sterlacciAnalysis = FALSE,
    supervisedClustering = FALSE,
    reproductibilityTesting = FALSE,
    immuneSignatureFocus = FALSE,
    tilAnalysisMode = "combined_til",
    multipleTesting = "bonferroni",
    significanceThreshold = 0.000055) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("ihcstats requires jmvcore to be installed (restart may be required)")

    if ( ! missing(markers)) markers <- jmvcore::resolveQuo(jmvcore::enquo(markers))
    if ( ! missing(groupVariable)) groupVariable <- jmvcore::resolveQuo(jmvcore::enquo(groupVariable))
    if ( ! missing(centralRegionVar)) centralRegionVar <- jmvcore::resolveQuo(jmvcore::enquo(centralRegionVar))
    if ( ! missing(invasiveRegionVar)) invasiveRegionVar <- jmvcore::resolveQuo(jmvcore::enquo(invasiveRegionVar))
    if ( ! missing(survivalTimeVar)) survivalTimeVar <- jmvcore::resolveQuo(jmvcore::enquo(survivalTimeVar))
    if ( ! missing(survivalEventVar)) survivalEventVar <- jmvcore::resolveQuo(jmvcore::enquo(survivalEventVar))
    if ( ! missing(tumorTypeVar)) tumorTypeVar <- jmvcore::resolveQuo(jmvcore::enquo(tumorTypeVar))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(markers), markers, NULL),
            `if`( ! missing(groupVariable), groupVariable, NULL),
            `if`( ! missing(centralRegionVar), centralRegionVar, NULL),
            `if`( ! missing(invasiveRegionVar), invasiveRegionVar, NULL),
            `if`( ! missing(survivalTimeVar), survivalTimeVar, NULL),
            `if`( ! missing(survivalEventVar), survivalEventVar, NULL),
            `if`( ! missing(tumorTypeVar), tumorTypeVar, NULL))

    for (v in markers) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in groupVariable) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in centralRegionVar) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in invasiveRegionVar) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in tumorTypeVar) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- ihcstatsOptions$new(
        markers = markers,
        computeHScore = computeHScore,
        clusterMethod = clusterMethod,
        distanceMetric = distanceMetric,
        nClusters = nClusters,
        showDendrogram = showDendrogram,
        showHeatmap = showHeatmap,
        showScoreDist = showScoreDist,
        pcaAnalysis = pcaAnalysis,
        standardizeData = standardizeData,
        showPCAPlot = showPCAPlot,
        showClusterValidation = showClusterValidation,
        optimalKMethod = optimalKMethod,
        iterativeClustering = iterativeClustering,
        linkageMethod = linkageMethod,
        showDiagnostics = showDiagnostics,
        groupVariable = groupVariable,
        scoringScale = scoringScale,
        tumorRegionAnalysis = tumorRegionAnalysis,
        centralRegionVar = centralRegionVar,
        invasiveRegionVar = invasiveRegionVar,
        prognosticClustering = prognosticClustering,
        survivalTimeVar = survivalTimeVar,
        survivalEventVar = survivalEventVar,
        differentialDiagnosis = differentialDiagnosis,
        tumorTypeVar = tumorTypeVar,
        antibodyOptimization = antibodyOptimization,
        calculateDiagnosticMetrics = calculateDiagnosticMetrics,
        olsenVisualization = olsenVisualization,
        clusterCutHeight = clusterCutHeight,
        sterlacciAnalysis = sterlacciAnalysis,
        supervisedClustering = supervisedClustering,
        reproductibilityTesting = reproductibilityTesting,
        immuneSignatureFocus = immuneSignatureFocus,
        tilAnalysisMode = tilAnalysisMode,
        multipleTesting = multipleTesting,
        significanceThreshold = significanceThreshold)

    analysis <- ihcstatsClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

