
# This file is automatically generated, you probably don't want to edit this

ihcadvancedOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcadvancedOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            markers = NULL,
            id = NULL,
            optimalKMethod = "silhouette",
            kRange = "2:8",
            iterativeClustering = FALSE,
            pcaAnalysis = TRUE,
            consensusClustering = FALSE,
            nBootstrap = 100,
            clusterValidation = TRUE,
            showAdvancedPlots = TRUE,
            parallelProcessing = FALSE,
            randomSeed = 123, ...) {

            super$initialize(
                package="ClinicoPath",
                name="ihcadvanced",
                requiresData=TRUE,
                ...)

            private$..markers <- jmvcore::OptionVariables$new(
                "markers",
                markers,
                suggested=list(
                    "ordinal",
                    "nominal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..id <- jmvcore::OptionVariable$new(
                "id",
                id,
                suggested=list(
                    "nominal",
                    "id"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..optimalKMethod <- jmvcore::OptionList$new(
                "optimalKMethod",
                optimalKMethod,
                options=list(
                    "elbow",
                    "silhouette",
                    "gap",
                    "manual"),
                default="silhouette")
            private$..kRange <- jmvcore::OptionString$new(
                "kRange",
                kRange,
                default="2:8")
            private$..iterativeClustering <- jmvcore::OptionBool$new(
                "iterativeClustering",
                iterativeClustering,
                default=FALSE)
            private$..pcaAnalysis <- jmvcore::OptionBool$new(
                "pcaAnalysis",
                pcaAnalysis,
                default=TRUE)
            private$..consensusClustering <- jmvcore::OptionBool$new(
                "consensusClustering",
                consensusClustering,
                default=FALSE)
            private$..nBootstrap <- jmvcore::OptionInteger$new(
                "nBootstrap",
                nBootstrap,
                min=50,
                max=1000,
                default=100)
            private$..clusterValidation <- jmvcore::OptionBool$new(
                "clusterValidation",
                clusterValidation,
                default=TRUE)
            private$..showAdvancedPlots <- jmvcore::OptionBool$new(
                "showAdvancedPlots",
                showAdvancedPlots,
                default=TRUE)
            private$..parallelProcessing <- jmvcore::OptionBool$new(
                "parallelProcessing",
                parallelProcessing,
                default=FALSE)
            private$..randomSeed <- jmvcore::OptionInteger$new(
                "randomSeed",
                randomSeed,
                default=123)

            self$.addOption(private$..markers)
            self$.addOption(private$..id)
            self$.addOption(private$..optimalKMethod)
            self$.addOption(private$..kRange)
            self$.addOption(private$..iterativeClustering)
            self$.addOption(private$..pcaAnalysis)
            self$.addOption(private$..consensusClustering)
            self$.addOption(private$..nBootstrap)
            self$.addOption(private$..clusterValidation)
            self$.addOption(private$..showAdvancedPlots)
            self$.addOption(private$..parallelProcessing)
            self$.addOption(private$..randomSeed)
        }),
    active = list(
        markers = function() private$..markers$value,
        id = function() private$..id$value,
        optimalKMethod = function() private$..optimalKMethod$value,
        kRange = function() private$..kRange$value,
        iterativeClustering = function() private$..iterativeClustering$value,
        pcaAnalysis = function() private$..pcaAnalysis$value,
        consensusClustering = function() private$..consensusClustering$value,
        nBootstrap = function() private$..nBootstrap$value,
        clusterValidation = function() private$..clusterValidation$value,
        showAdvancedPlots = function() private$..showAdvancedPlots$value,
        parallelProcessing = function() private$..parallelProcessing$value,
        randomSeed = function() private$..randomSeed$value),
    private = list(
        ..markers = NA,
        ..id = NA,
        ..optimalKMethod = NA,
        ..kRange = NA,
        ..iterativeClustering = NA,
        ..pcaAnalysis = NA,
        ..consensusClustering = NA,
        ..nBootstrap = NA,
        ..clusterValidation = NA,
        ..showAdvancedPlots = NA,
        ..parallelProcessing = NA,
        ..randomSeed = NA)
)

ihcadvancedResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcadvancedResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        optimalKResults = function() private$.items[["optimalKResults"]],
        markerOptimization = function() private$.items[["markerOptimization"]],
        pcaResults = function() private$.items[["pcaResults"]],
        pcaLoadings = function() private$.items[["pcaLoadings"]],
        validationMetrics = function() private$.items[["validationMetrics"]],
        consensusResults = function() private$.items[["consensusResults"]],
        optimalKPlot = function() private$.items[["optimalKPlot"]],
        pcaPlot = function() private$.items[["pcaPlot"]],
        silhouettePlot = function() private$.items[["silhouettePlot"]],
        validationPlot = function() private$.items[["validationPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Advanced IHC Clustering",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Advanced Analysis Overview",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="optimalKResults",
                title="Optimal K Selection Results",
                visible=TRUE,
                clearWith=list(
                    "markers",
                    "optimalKMethod",
                    "kRange"),
                columns=list(
                    list(
                        `name`="k", 
                        `title`="K", 
                        `type`="integer"),
                    list(
                        `name`="silhouette_avg", 
                        `title`="Avg Silhouette", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="within_ss", 
                        `title`="Within SS", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="gap_statistic", 
                        `title`="Gap Statistic", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="recommendation", 
                        `title`="Recommendation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="markerOptimization",
                title="Marker Selection Results",
                visible="(iterativeClustering)",
                clearWith=list(
                    "markers",
                    "iterativeClustering"),
                columns=list(
                    list(
                        `name`="iteration", 
                        `title`="Iteration", 
                        `type`="integer"),
                    list(
                        `name`="marker", 
                        `title`="Marker Added/Removed", 
                        `type`="text"),
                    list(
                        `name`="action", 
                        `title`="Action", 
                        `type`="text"),
                    list(
                        `name`="silhouette_improvement", 
                        `title`="Silhouette \u0394", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="selected_markers", 
                        `title`="Selected Markers", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="pcaResults",
                title="Principal Component Analysis",
                visible="(pcaAnalysis)",
                clearWith=list(
                    "markers",
                    "pcaAnalysis"),
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="eigenvalue", 
                        `title`="Eigenvalue", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="variance_explained", 
                        `title`="Variance %", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="cumulative_variance", 
                        `title`="Cumulative %", 
                        `type`="number", 
                        `format`="zto:1"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="pcaLoadings",
                title="PCA Loadings Matrix",
                visible="(pcaAnalysis)",
                clearWith=list(
                    "markers",
                    "pcaAnalysis"),
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="pc1", 
                        `title`="PC1", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="pc2", 
                        `title`="PC2", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="pc3", 
                        `title`="PC3", 
                        `type`="number", 
                        `format`="zto:3"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="validationMetrics",
                title="Cluster Validation Metrics",
                visible="(clusterValidation)",
                clearWith=list(
                    "markers",
                    "optimalKMethod"),
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Validation Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"),
                    list(
                        `name`="range", 
                        `title`="Range", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="consensusResults",
                title="Consensus Clustering Stability",
                visible="(consensusClustering)",
                clearWith=list(
                    "markers",
                    "consensusClustering",
                    "nBootstrap"),
                columns=list(
                    list(
                        `name`="k", 
                        `title`="K", 
                        `type`="integer"),
                    list(
                        `name`="consensus_score", 
                        `title`="Consensus Score", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="stability", 
                        `title`="Stability", 
                        `type`="text"),
                    list(
                        `name`="frequency", 
                        `title`="Selection Frequency", 
                        `type`="number", 
                        `format`="zto:1"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="optimalKPlot",
                title="Optimal K Selection Plot",
                visible=TRUE,
                renderFun=".plotOptimalK",
                clearWith=list(
                    "markers",
                    "optimalKMethod",
                    "kRange"),
                width=800,
                height=600))
            self$add(jmvcore::Image$new(
                options=options,
                name="pcaPlot",
                title="PCA Biplot with Clusters",
                visible="(pcaAnalysis && showAdvancedPlots)",
                renderFun=".plotPCA",
                clearWith=list(
                    "markers",
                    "pcaAnalysis"),
                width=800,
                height=600))
            self$add(jmvcore::Image$new(
                options=options,
                name="silhouettePlot",
                title="Silhouette Analysis Plot",
                visible="(showAdvancedPlots)",
                renderFun=".plotSilhouette",
                clearWith=list(
                    "markers",
                    "optimalKMethod"),
                width=800,
                height=600))
            self$add(jmvcore::Image$new(
                options=options,
                name="validationPlot",
                title="Cluster Validation Plot",
                visible="(clusterValidation && showAdvancedPlots)",
                renderFun=".plotValidation",
                clearWith=list(
                    "markers",
                    "clusterValidation"),
                width=800,
                height=500))}))

ihcadvancedBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcadvancedBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "ihcadvanced",
                version = c(1,0,0),
                options = options,
                results = ihcadvancedResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Advanced IHC Clustering
#'
#' Advanced clustering analysis with marker optimization and validation. 
#' Includes optimal K selection, PCA analysis, and iterative marker selection.
#' 
#'
#' @examples
#' data \%>\%
#' ihcadvanced(
#'     markers = c("ER", "PR", "HER2", "Ki67"),
#'     optimalKMethod = "silhouette",
#'     iterativeClustering = TRUE
#' )
#'
#' @param data the data as a data frame
#' @param markers IHC marker variables for advanced clustering analysis
#' @param id Case identifier for tracking
#' @param optimalKMethod Method for automatically determining optimal number
#'   of clusters
#' @param kRange Range of K values to test (e.g., "2:8" or "2,3,4,5")
#' @param iterativeClustering Perform iterative optimization to select most
#'   informative markers
#' @param pcaAnalysis Perform PCA for dimensionality reduction and
#'   visualization
#' @param consensusClustering Use bootstrap consensus clustering for stable
#'   results
#' @param nBootstrap Number of bootstrap iterations for consensus clustering
#' @param clusterValidation Perform multiple validation metrics (silhouette,
#'   connectivity, Dunn index)
#' @param showAdvancedPlots Display PCA, silhouette, and validation plots
#' @param parallelProcessing Enable parallel processing for computationally
#'   intensive tasks
#' @param randomSeed Set random seed for reproducible results
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$optimalKResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$markerOptimization} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$pcaResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$pcaLoadings} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$validationMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$consensusResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$optimalKPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$pcaPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$silhouettePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$validationPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$optimalKResults$asDF}
#'
#' \code{as.data.frame(results$optimalKResults)}
#'
#' @export
ihcadvanced <- function(
    data,
    markers,
    id = NULL,
    optimalKMethod = "silhouette",
    kRange = "2:8",
    iterativeClustering = FALSE,
    pcaAnalysis = TRUE,
    consensusClustering = FALSE,
    nBootstrap = 100,
    clusterValidation = TRUE,
    showAdvancedPlots = TRUE,
    parallelProcessing = FALSE,
    randomSeed = 123) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("ihcadvanced requires jmvcore to be installed (restart may be required)")

    if ( ! missing(markers)) markers <- jmvcore::resolveQuo(jmvcore::enquo(markers))
    if ( ! missing(id)) id <- jmvcore::resolveQuo(jmvcore::enquo(id))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(markers), markers, NULL),
            `if`( ! missing(id), id, NULL))


    options <- ihcadvancedOptions$new(
        markers = markers,
        id = id,
        optimalKMethod = optimalKMethod,
        kRange = kRange,
        iterativeClustering = iterativeClustering,
        pcaAnalysis = pcaAnalysis,
        consensusClustering = consensusClustering,
        nBootstrap = nBootstrap,
        clusterValidation = clusterValidation,
        showAdvancedPlots = showAdvancedPlots,
        parallelProcessing = parallelProcessing,
        randomSeed = randomSeed)

    analysis <- ihcadvancedClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

