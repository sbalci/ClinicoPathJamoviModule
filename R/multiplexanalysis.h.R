
# This file is automatically generated, you probably don't want to edit this

multiplexanalysisOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "multiplexanalysisOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            marker_vars = NULL,
            x_coord = NULL,
            y_coord = NULL,
            cell_type_var = NULL,
            sample_id_var = NULL,
            group_var = NULL,
            analysis_focus = "comprehensive",
            correlation_method = "pearson",
            positivity_cutpoint = 0.1,
            perform_clustering = TRUE,
            n_clusters = 0,
            perform_pca = TRUE,
            show_loadings = TRUE,
            immune_contexture = FALSE,
            diversity_metrics = TRUE,
            spatial_analysis = FALSE,
            proximity_threshold = 20,
            show_plots = TRUE,
            show_clustering_plots = TRUE,
            biomarker_panel = "custom",
            normalization_method = "zscore",
            multiple_testing = "fdr",
            confidence_level = 0.95, ...) {

            super$initialize(
                package="ClinicoPath",
                name="multiplexanalysis",
                requiresData=TRUE,
                ...)

            private$..marker_vars <- jmvcore::OptionVariables$new(
                "marker_vars",
                marker_vars,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..x_coord <- jmvcore::OptionVariable$new(
                "x_coord",
                x_coord,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..y_coord <- jmvcore::OptionVariable$new(
                "y_coord",
                y_coord,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..cell_type_var <- jmvcore::OptionVariable$new(
                "cell_type_var",
                cell_type_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..sample_id_var <- jmvcore::OptionVariable$new(
                "sample_id_var",
                sample_id_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "id"))
            private$..group_var <- jmvcore::OptionVariable$new(
                "group_var",
                group_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..analysis_focus <- jmvcore::OptionList$new(
                "analysis_focus",
                analysis_focus,
                options=list(
                    "coexpression",
                    "phenotyping",
                    "spatial",
                    "comprehensive"),
                default="comprehensive")
            private$..correlation_method <- jmvcore::OptionList$new(
                "correlation_method",
                correlation_method,
                options=list(
                    "pearson",
                    "spearman"),
                default="pearson")
            private$..positivity_cutpoint <- jmvcore::OptionNumber$new(
                "positivity_cutpoint",
                positivity_cutpoint,
                min=0,
                default=0.1)
            private$..perform_clustering <- jmvcore::OptionBool$new(
                "perform_clustering",
                perform_clustering,
                default=TRUE)
            private$..n_clusters <- jmvcore::OptionInteger$new(
                "n_clusters",
                n_clusters,
                min=0,
                max=10,
                default=0)
            private$..perform_pca <- jmvcore::OptionBool$new(
                "perform_pca",
                perform_pca,
                default=TRUE)
            private$..show_loadings <- jmvcore::OptionBool$new(
                "show_loadings",
                show_loadings,
                default=TRUE)
            private$..immune_contexture <- jmvcore::OptionBool$new(
                "immune_contexture",
                immune_contexture,
                default=FALSE)
            private$..diversity_metrics <- jmvcore::OptionBool$new(
                "diversity_metrics",
                diversity_metrics,
                default=TRUE)
            private$..spatial_analysis <- jmvcore::OptionBool$new(
                "spatial_analysis",
                spatial_analysis,
                default=FALSE)
            private$..proximity_threshold <- jmvcore::OptionNumber$new(
                "proximity_threshold",
                proximity_threshold,
                min=1,
                max=1000,
                default=20)
            private$..show_plots <- jmvcore::OptionBool$new(
                "show_plots",
                show_plots,
                default=TRUE)
            private$..show_clustering_plots <- jmvcore::OptionBool$new(
                "show_clustering_plots",
                show_clustering_plots,
                default=TRUE)
            private$..biomarker_panel <- jmvcore::OptionList$new(
                "biomarker_panel",
                biomarker_panel,
                options=list(
                    "immune",
                    "tumor",
                    "angiogenesis",
                    "metabolism",
                    "custom"),
                default="custom")
            private$..normalization_method <- jmvcore::OptionList$new(
                "normalization_method",
                normalization_method,
                options=list(
                    "none",
                    "zscore",
                    "minmax",
                    "quantile"),
                default="zscore")
            private$..multiple_testing <- jmvcore::OptionList$new(
                "multiple_testing",
                multiple_testing,
                options=list(
                    "none",
                    "bonferroni",
                    "fdr"),
                default="fdr")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.8,
                max=0.99,
                default=0.95)

            self$.addOption(private$..marker_vars)
            self$.addOption(private$..x_coord)
            self$.addOption(private$..y_coord)
            self$.addOption(private$..cell_type_var)
            self$.addOption(private$..sample_id_var)
            self$.addOption(private$..group_var)
            self$.addOption(private$..analysis_focus)
            self$.addOption(private$..correlation_method)
            self$.addOption(private$..positivity_cutpoint)
            self$.addOption(private$..perform_clustering)
            self$.addOption(private$..n_clusters)
            self$.addOption(private$..perform_pca)
            self$.addOption(private$..show_loadings)
            self$.addOption(private$..immune_contexture)
            self$.addOption(private$..diversity_metrics)
            self$.addOption(private$..spatial_analysis)
            self$.addOption(private$..proximity_threshold)
            self$.addOption(private$..show_plots)
            self$.addOption(private$..show_clustering_plots)
            self$.addOption(private$..biomarker_panel)
            self$.addOption(private$..normalization_method)
            self$.addOption(private$..multiple_testing)
            self$.addOption(private$..confidence_level)
        }),
    active = list(
        marker_vars = function() private$..marker_vars$value,
        x_coord = function() private$..x_coord$value,
        y_coord = function() private$..y_coord$value,
        cell_type_var = function() private$..cell_type_var$value,
        sample_id_var = function() private$..sample_id_var$value,
        group_var = function() private$..group_var$value,
        analysis_focus = function() private$..analysis_focus$value,
        correlation_method = function() private$..correlation_method$value,
        positivity_cutpoint = function() private$..positivity_cutpoint$value,
        perform_clustering = function() private$..perform_clustering$value,
        n_clusters = function() private$..n_clusters$value,
        perform_pca = function() private$..perform_pca$value,
        show_loadings = function() private$..show_loadings$value,
        immune_contexture = function() private$..immune_contexture$value,
        diversity_metrics = function() private$..diversity_metrics$value,
        spatial_analysis = function() private$..spatial_analysis$value,
        proximity_threshold = function() private$..proximity_threshold$value,
        show_plots = function() private$..show_plots$value,
        show_clustering_plots = function() private$..show_clustering_plots$value,
        biomarker_panel = function() private$..biomarker_panel$value,
        normalization_method = function() private$..normalization_method$value,
        multiple_testing = function() private$..multiple_testing$value,
        confidence_level = function() private$..confidence_level$value),
    private = list(
        ..marker_vars = NA,
        ..x_coord = NA,
        ..y_coord = NA,
        ..cell_type_var = NA,
        ..sample_id_var = NA,
        ..group_var = NA,
        ..analysis_focus = NA,
        ..correlation_method = NA,
        ..positivity_cutpoint = NA,
        ..perform_clustering = NA,
        ..n_clusters = NA,
        ..perform_pca = NA,
        ..show_loadings = NA,
        ..immune_contexture = NA,
        ..diversity_metrics = NA,
        ..spatial_analysis = NA,
        ..proximity_threshold = NA,
        ..show_plots = NA,
        ..show_clustering_plots = NA,
        ..biomarker_panel = NA,
        ..normalization_method = NA,
        ..multiple_testing = NA,
        ..confidence_level = NA)
)

multiplexanalysisResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "multiplexanalysisResults",
    inherit = jmvcore::Group,
    active = list(
        interpretation = function() private$.items[["interpretation"]],
        expressiontable = function() private$.items[["expressiontable"]],
        correlationtable = function() private$.items[["correlationtable"]],
        clusteringtable = function() private$.items[["clusteringtable"]],
        pcatable = function() private$.items[["pcatable"]],
        correlationplot = function() private$.items[["correlationplot"]],
        heatmapplot = function() private$.items[["heatmapplot"]],
        pcaplot = function() private$.items[["pcaplot"]],
        clusterplot = function() private$.items[["clusterplot"]],
        spatialanalysis = function() private$.items[["spatialanalysis"]],
        immunecontexture = function() private$.items[["immunecontexture"]],
        diversityanalysis = function() private$.items[["diversityanalysis"]],
        qualitycontrol = function() private$.items[["qualitycontrol"]],
        advancedanalysis = function() private$.items[["advancedanalysis"]],
        exportdata = function() private$.items[["exportdata"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Multiplex Immunofluorescence Analysis",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Analysis Overview and Clinical Context",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="expressiontable",
                title="Marker Expression Summary",
                columns=list(),
                clearWith=list(
                    "marker_vars",
                    "positivity_cutpoint",
                    "normalization_method")))
            self$add(jmvcore::Table$new(
                options=options,
                name="correlationtable",
                title="Co-expression Analysis",
                columns=list(),
                clearWith=list(
                    "marker_vars",
                    "correlation_method",
                    "multiple_testing")))
            self$add(jmvcore::Table$new(
                options=options,
                name="clusteringtable",
                title="Cell Population Clustering",
                columns=list(),
                visible="(perform_clustering)",
                clearWith=list(
                    "marker_vars",
                    "perform_clustering",
                    "n_clusters")))
            self$add(jmvcore::Table$new(
                options=options,
                name="pcatable",
                title="Principal Component Analysis",
                columns=list(),
                visible="(perform_pca)",
                clearWith=list(
                    "marker_vars",
                    "perform_pca")))
            self$add(jmvcore::Image$new(
                options=options,
                name="correlationplot",
                title="Marker Correlation Matrix",
                width=600,
                height=500,
                visible="(show_plots)",
                requiresData=TRUE,
                clearWith=list(
                    "marker_vars",
                    "correlation_method",
                    "show_plots")))
            self$add(jmvcore::Image$new(
                options=options,
                name="heatmapplot",
                title="Expression Heatmap",
                width=600,
                height=500,
                visible="(show_plots)",
                requiresData=TRUE,
                clearWith=list(
                    "marker_vars",
                    "show_plots",
                    "normalization_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="pcaplot",
                title="Principal Component Analysis Plot",
                width=600,
                height=500,
                visible="(perform_pca && show_plots)",
                requiresData=TRUE,
                clearWith=list(
                    "marker_vars",
                    "perform_pca",
                    "show_plots",
                    "show_loadings")))
            self$add(jmvcore::Image$new(
                options=options,
                name="clusterplot",
                title="Cluster Analysis Plot",
                width=600,
                height=500,
                visible="(perform_clustering && show_clustering_plots)",
                requiresData=TRUE,
                clearWith=list(
                    "marker_vars",
                    "perform_clustering",
                    "show_clustering_plots",
                    "n_clusters")))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    proximityresults = function() private$.items[["proximityresults"]],
                    spatialplot = function() private$.items[["spatialplot"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="spatialanalysis",
                            title="Spatial Proximity Analysis")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="proximityresults",
                            title="Cell-Cell Proximity Statistics",
                            columns=list()))
                        self$add(jmvcore::Image$new(
                            options=options,
                            name="spatialplot",
                            title="Spatial Distribution Plot",
                            width=600,
                            height=500))}))$new(options=options))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    immunescores = function() private$.items[["immunescores"]],
                    immuneplot = function() private$.items[["immuneplot"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="immunecontexture",
                            title="Immune Contexture Scoring")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="immunescores",
                            title="Immunoscore Results",
                            columns=list()))
                        self$add(jmvcore::Image$new(
                            options=options,
                            name="immuneplot",
                            title="Immune Profile Visualization",
                            width=500,
                            height=400))}))$new(options=options))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    diversitytable = function() private$.items[["diversitytable"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="diversityanalysis",
                            title="Cellular Diversity Metrics")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="diversitytable",
                            title="Diversity Index Results",
                            columns=list()))}))$new(options=options))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    qcmetrics = function() private$.items[["qcmetrics"]],
                    batcheffects = function() private$.items[["batcheffects"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="qualitycontrol",
                            title="Quality Control Assessment")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="qcmetrics",
                            title="Data Quality Metrics",
                            columns=list()))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="batcheffects",
                            title="Batch Effect Assessment",
                            columns=list()))}))$new(options=options))
            self$add(R6::R6Class(
                inherit = jmvcore::Group,
                active = list(
                    networkanalysis = function() private$.items[["networkanalysis"]],
                    pathwayenrichment = function() private$.items[["pathwayenrichment"]]),
                private = list(),
                public=list(
                    initialize=function(options) {
                        super$initialize(
                            options=options,
                            name="advancedanalysis",
                            title="Advanced Statistical Analysis")
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="networkanalysis",
                            title="Marker Network Analysis",
                            columns=list()))
                        self$add(jmvcore::Table$new(
                            options=options,
                            name="pathwayenrichment",
                            title="Pathway Enrichment Results",
                            columns=list()))}))$new(options=options))
            self$add(jmvcore::Table$new(
                options=options,
                name="exportdata",
                title="Export-Ready Results",
                columns=list(),
                visible=FALSE))}))

multiplexanalysisBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "multiplexanalysisBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "multiplexanalysis",
                version = c(1,0,0),
                options = options,
                results = multiplexanalysisResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Multiplex Immunofluorescence Analysis
#'
#' 
#' @param data the data as a data frame
#' @param marker_vars expression levels or intensities for multiple biomarkers
#' @param x_coord X spatial coordinates for proximity analysis
#' @param y_coord Y spatial coordinates for proximity analysis
#' @param cell_type_var pre-defined cell type classifications
#' @param sample_id_var unique identifier for samples/regions
#' @param group_var grouping variable for comparative analysis
#' @param analysis_focus primary focus of multiplex analysis
#' @param correlation_method correlation method for co-expression analysis
#' @param positivity_cutpoint threshold for defining positive marker
#'   expression
#' @param perform_clustering identify cell populations through clustering
#' @param n_clusters number of clusters (0 = auto-determine)
#' @param perform_pca dimensionality reduction and visualization
#' @param show_loadings display loading vectors on PCA plot
#' @param immune_contexture calculate immunoscore and T-cell infiltration
#'   metrics
#' @param diversity_metrics Shannon and Simpson diversity for cellular
#'   composition
#' @param spatial_analysis cell-cell interaction analysis (requires
#'   coordinates)
#' @param proximity_threshold distance threshold for defining cell proximity
#' @param show_plots display correlation, PCA, and expression plots
#' @param show_clustering_plots display cluster analysis visualizations
#' @param biomarker_panel type of biomarker panel for optimized analysis
#' @param normalization_method normalization method for marker expressions
#' @param multiple_testing correction for multiple comparisons
#' @param confidence_level confidence level for statistical intervals
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$expressiontable} \tab \tab \tab \tab \tab Descriptive statistics for each biomarker \cr
#'   \code{results$correlationtable} \tab \tab \tab \tab \tab Pairwise correlations between biomarkers \cr
#'   \code{results$clusteringtable} \tab \tab \tab \tab \tab Identified cell clusters and phenotype suggestions \cr
#'   \code{results$pcatable} \tab \tab \tab \tab \tab PCA results and variance explained \cr
#'   \code{results$correlationplot} \tab \tab \tab \tab \tab Heatmap showing pairwise marker correlations \cr
#'   \code{results$heatmapplot} \tab \tab \tab \tab \tab Comprehensive marker expression patterns \cr
#'   \code{results$pcaplot} \tab \tab \tab \tab \tab PCA visualization with optional loading vectors \cr
#'   \code{results$clusterplot} \tab \tab \tab \tab \tab Visualization of identified cell populations \cr
#'   \code{results$spatialanalysis$proximityresults} \tab \tab \tab \tab \tab Distance-based interaction analysis \cr
#'   \code{results$spatialanalysis$spatialplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$immunecontexture$immunescores} \tab \tab \tab \tab \tab T-cell infiltration and immune context metrics \cr
#'   \code{results$immunecontexture$immuneplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$diversityanalysis$diversitytable} \tab \tab \tab \tab \tab Shannon, Simpson, and evenness indices \cr
#'   \code{results$qualitycontrol$qcmetrics} \tab \tab \tab \tab \tab Missing data, outliers, and technical quality \cr
#'   \code{results$qualitycontrol$batcheffects} \tab \tab \tab \tab \tab Analysis of systematic technical variation \cr
#'   \code{results$advancedanalysis$networkanalysis} \tab \tab \tab \tab \tab Network-based marker interaction analysis \cr
#'   \code{results$advancedanalysis$pathwayenrichment} \tab \tab \tab \tab \tab Biological pathway associations \cr
#'   \code{results$exportdata} \tab \tab \tab \tab \tab Formatted data for external analysis \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$expressiontable$asDF}
#'
#' \code{as.data.frame(results$expressiontable)}
#'
#' @export
multiplexanalysis <- function(
    data,
    marker_vars,
    x_coord,
    y_coord,
    cell_type_var,
    sample_id_var,
    group_var,
    analysis_focus = "comprehensive",
    correlation_method = "pearson",
    positivity_cutpoint = 0.1,
    perform_clustering = TRUE,
    n_clusters = 0,
    perform_pca = TRUE,
    show_loadings = TRUE,
    immune_contexture = FALSE,
    diversity_metrics = TRUE,
    spatial_analysis = FALSE,
    proximity_threshold = 20,
    show_plots = TRUE,
    show_clustering_plots = TRUE,
    biomarker_panel = "custom",
    normalization_method = "zscore",
    multiple_testing = "fdr",
    confidence_level = 0.95) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("multiplexanalysis requires jmvcore to be installed (restart may be required)")

    if ( ! missing(marker_vars)) marker_vars <- jmvcore::resolveQuo(jmvcore::enquo(marker_vars))
    if ( ! missing(x_coord)) x_coord <- jmvcore::resolveQuo(jmvcore::enquo(x_coord))
    if ( ! missing(y_coord)) y_coord <- jmvcore::resolveQuo(jmvcore::enquo(y_coord))
    if ( ! missing(cell_type_var)) cell_type_var <- jmvcore::resolveQuo(jmvcore::enquo(cell_type_var))
    if ( ! missing(sample_id_var)) sample_id_var <- jmvcore::resolveQuo(jmvcore::enquo(sample_id_var))
    if ( ! missing(group_var)) group_var <- jmvcore::resolveQuo(jmvcore::enquo(group_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(marker_vars), marker_vars, NULL),
            `if`( ! missing(x_coord), x_coord, NULL),
            `if`( ! missing(y_coord), y_coord, NULL),
            `if`( ! missing(cell_type_var), cell_type_var, NULL),
            `if`( ! missing(sample_id_var), sample_id_var, NULL),
            `if`( ! missing(group_var), group_var, NULL))

    for (v in cell_type_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in group_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- multiplexanalysisOptions$new(
        marker_vars = marker_vars,
        x_coord = x_coord,
        y_coord = y_coord,
        cell_type_var = cell_type_var,
        sample_id_var = sample_id_var,
        group_var = group_var,
        analysis_focus = analysis_focus,
        correlation_method = correlation_method,
        positivity_cutpoint = positivity_cutpoint,
        perform_clustering = perform_clustering,
        n_clusters = n_clusters,
        perform_pca = perform_pca,
        show_loadings = show_loadings,
        immune_contexture = immune_contexture,
        diversity_metrics = diversity_metrics,
        spatial_analysis = spatial_analysis,
        proximity_threshold = proximity_threshold,
        show_plots = show_plots,
        show_clustering_plots = show_clustering_plots,
        biomarker_panel = biomarker_panel,
        normalization_method = normalization_method,
        multiple_testing = multiple_testing,
        confidence_level = confidence_level)

    analysis <- multiplexanalysisClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

