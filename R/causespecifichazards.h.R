
# This file is automatically generated, you probably don't want to edit this

causespecifichazardsOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "causespecifichazardsOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            outcome = NULL,
            covariates = NULL,
            cause_variable = NULL,
            reference_cause = "1",
            model_type = "cox",
            include_se = TRUE,
            include_ci = TRUE,
            conf_level = 0.95,
            cumulative_incidence = TRUE,
            model_comparison = FALSE,
            proportional_hazards_test = FALSE,
            plot_cumulative_incidence = FALSE,
            plot_hazards = FALSE,
            plot_diagnostics = FALSE,
            stratify_plots = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="causespecifichazards",
                requiresData=TRUE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"),
                default=NULL)
            private$..cause_variable <- jmvcore::OptionVariable$new(
                "cause_variable",
                cause_variable,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..reference_cause <- jmvcore::OptionString$new(
                "reference_cause",
                reference_cause,
                default="1")
            private$..model_type <- jmvcore::OptionList$new(
                "model_type",
                model_type,
                options=list(
                    "cox",
                    "weibull",
                    "exponential",
                    "lognormal"),
                default="cox")
            private$..include_se <- jmvcore::OptionBool$new(
                "include_se",
                include_se,
                default=TRUE)
            private$..include_ci <- jmvcore::OptionBool$new(
                "include_ci",
                include_ci,
                default=TRUE)
            private$..conf_level <- jmvcore::OptionNumber$new(
                "conf_level",
                conf_level,
                default=0.95,
                min=0.5,
                max=0.99)
            private$..cumulative_incidence <- jmvcore::OptionBool$new(
                "cumulative_incidence",
                cumulative_incidence,
                default=TRUE)
            private$..model_comparison <- jmvcore::OptionBool$new(
                "model_comparison",
                model_comparison,
                default=FALSE)
            private$..proportional_hazards_test <- jmvcore::OptionBool$new(
                "proportional_hazards_test",
                proportional_hazards_test,
                default=FALSE)
            private$..plot_cumulative_incidence <- jmvcore::OptionBool$new(
                "plot_cumulative_incidence",
                plot_cumulative_incidence,
                default=FALSE)
            private$..plot_hazards <- jmvcore::OptionBool$new(
                "plot_hazards",
                plot_hazards,
                default=FALSE)
            private$..plot_diagnostics <- jmvcore::OptionBool$new(
                "plot_diagnostics",
                plot_diagnostics,
                default=FALSE)
            private$..stratify_plots <- jmvcore::OptionBool$new(
                "stratify_plots",
                stratify_plots,
                default=FALSE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..outcome)
            self$.addOption(private$..covariates)
            self$.addOption(private$..cause_variable)
            self$.addOption(private$..reference_cause)
            self$.addOption(private$..model_type)
            self$.addOption(private$..include_se)
            self$.addOption(private$..include_ci)
            self$.addOption(private$..conf_level)
            self$.addOption(private$..cumulative_incidence)
            self$.addOption(private$..model_comparison)
            self$.addOption(private$..proportional_hazards_test)
            self$.addOption(private$..plot_cumulative_incidence)
            self$.addOption(private$..plot_hazards)
            self$.addOption(private$..plot_diagnostics)
            self$.addOption(private$..stratify_plots)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        outcome = function() private$..outcome$value,
        covariates = function() private$..covariates$value,
        cause_variable = function() private$..cause_variable$value,
        reference_cause = function() private$..reference_cause$value,
        model_type = function() private$..model_type$value,
        include_se = function() private$..include_se$value,
        include_ci = function() private$..include_ci$value,
        conf_level = function() private$..conf_level$value,
        cumulative_incidence = function() private$..cumulative_incidence$value,
        model_comparison = function() private$..model_comparison$value,
        proportional_hazards_test = function() private$..proportional_hazards_test$value,
        plot_cumulative_incidence = function() private$..plot_cumulative_incidence$value,
        plot_hazards = function() private$..plot_hazards$value,
        plot_diagnostics = function() private$..plot_diagnostics$value,
        stratify_plots = function() private$..stratify_plots$value),
    private = list(
        ..elapsedtime = NA,
        ..outcome = NA,
        ..covariates = NA,
        ..cause_variable = NA,
        ..reference_cause = NA,
        ..model_type = NA,
        ..include_se = NA,
        ..include_ci = NA,
        ..conf_level = NA,
        ..cumulative_incidence = NA,
        ..model_comparison = NA,
        ..proportional_hazards_test = NA,
        ..plot_cumulative_incidence = NA,
        ..plot_hazards = NA,
        ..plot_diagnostics = NA,
        ..stratify_plots = NA)
)

causespecifichazardsResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "causespecifichazardsResults",
    inherit = jmvcore::Group,
    active = list(
        overview = function() private$.items[["overview"]],
        cause_summary = function() private$.items[["cause_summary"]],
        model_fit = function() private$.items[["model_fit"]],
        coefficients = function() private$.items[["coefficients"]],
        cumulative_incidence_table = function() private$.items[["cumulative_incidence_table"]],
        model_comparison_table = function() private$.items[["model_comparison_table"]],
        proportional_hazards_table = function() private$.items[["proportional_hazards_table"]],
        cumulative_incidence_plot = function() private$.items[["cumulative_incidence_plot"]],
        hazards_plot = function() private$.items[["hazards_plot"]],
        diagnostics_plot = function() private$.items[["diagnostics_plot"]],
        model_summary = function() private$.items[["model_summary"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Cause-Specific Hazards Models",
                refs="survival")
            self$add(jmvcore::Table$new(
                options=options,
                name="overview",
                title="Analysis Overview",
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "covariates",
                    "cause_variable",
                    "reference_cause",
                    "model_type"),
                columns=list(
                    list(
                        `name`="analysis", 
                        `title`="Analysis", 
                        `type`="text"),
                    list(
                        `name`="outcome", 
                        `title`="Outcome Variable", 
                        `type`="text"),
                    list(
                        `name`="n_subjects", 
                        `title`="Number of Subjects", 
                        `type`="integer"),
                    list(
                        `name`="n_events", 
                        `title`="Total Events", 
                        `type`="integer"),
                    list(
                        `name`="n_causes", 
                        `title`="Number of Causes", 
                        `type`="integer"),
                    list(
                        `name`="model_type", 
                        `title`="Model Type", 
                        `type`="text"),
                    list(
                        `name`="reference_cause", 
                        `title`="Reference Cause", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="cause_summary",
                title="Cause-Specific Event Summary",
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "cause_variable"),
                columns=list(
                    list(
                        `name`="cause", 
                        `title`="Cause", 
                        `type`="text"),
                    list(
                        `name`="n_events", 
                        `title`="Number of Events", 
                        `type`="integer"),
                    list(
                        `name`="proportion", 
                        `title`="Proportion", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="median_time", 
                        `title`="Median Time", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="q25_time", 
                        `title`="Q1 Time", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="q75_time", 
                        `title`="Q3 Time", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="model_fit",
                title="Model Fit Statistics by Cause",
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "covariates",
                    "cause_variable",
                    "model_type"),
                columns=list(
                    list(
                        `name`="cause", 
                        `title`="Cause", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="coefficients",
                title="Cause-Specific Hazard Ratios",
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "covariates",
                    "cause_variable",
                    "model_type",
                    "include_se",
                    "include_ci",
                    "conf_level"),
                columns=list(
                    list(
                        `name`="cause", 
                        `title`="Cause", 
                        `type`="text"),
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="hr", 
                        `title`="Hazard Ratio", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(include_se)"),
                    list(
                        `name`="z_stat", 
                        `title`="Z", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(include_se)"),
                    list(
                        `name`="p_value", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue", 
                        `visible`="(include_se)"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(include_ci)"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto", 
                        `visible`="(include_ci)"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="cumulative_incidence_table",
                title="Cumulative Incidence Functions",
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "cause_variable",
                    "cumulative_incidence"),
                visible="(cumulative_incidence)",
                columns=list(
                    list(
                        `name`="time", 
                        `title`="Time", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="cause", 
                        `title`="Cause", 
                        `type`="text"),
                    list(
                        `name`="cumulative_incidence", 
                        `title`="Cumulative Incidence", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="model_comparison_table",
                title="Model Comparison Across Causes",
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "covariates",
                    "cause_variable",
                    "model_type",
                    "model_comparison"),
                visible="(model_comparison)",
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Test Statistic", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="proportional_hazards_table",
                title="Proportional Hazards Tests",
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "covariates",
                    "cause_variable",
                    "proportional_hazards_test"),
                visible="(proportional_hazards_test)",
                columns=list(
                    list(
                        `name`="cause", 
                        `title`="Cause", 
                        `type`="text"),
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="rho", 
                        `title`="Correlation (\u03C1)", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="chi_square", 
                        `title`="\u03C7\u00B2", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="cumulative_incidence_plot",
                title="Cumulative Incidence Functions",
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "cause_variable",
                    "plot_cumulative_incidence",
                    "stratify_plots"),
                visible="(plot_cumulative_incidence)",
                renderFun=".plot_cumulative_incidence"))
            self$add(jmvcore::Image$new(
                options=options,
                name="hazards_plot",
                title="Cause-Specific Hazard Functions",
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "covariates",
                    "cause_variable",
                    "model_type",
                    "plot_hazards",
                    "stratify_plots"),
                visible="(plot_hazards)",
                renderFun=".plot_hazards"))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagnostics_plot",
                title="Diagnostic Plots",
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "covariates",
                    "cause_variable",
                    "model_type",
                    "plot_diagnostics"),
                visible="(plot_diagnostics)",
                renderFun=".plot_diagnostics"))
            self$add(jmvcore::Html$new(
                options=options,
                name="model_summary",
                title="Model Summary",
                clearWith=list(
                    "elapsedtime",
                    "outcome",
                    "covariates",
                    "cause_variable",
                    "model_type")))}))

causespecifichazardsBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "causespecifichazardsBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "causespecifichazards",
                version = c(0,0,31),
                options = options,
                results = causespecifichazardsResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Cause-Specific Hazards Models
#'
#' Implements cause-specific hazards modeling for competing risks analysis. 
#' This approach models the hazard for each specific cause separately, 
#' treating other causes as censoring events. Provides comprehensive analysis 
#' including hazard ratios, cumulative incidence functions, and model 
#' comparisons across different causes of failure.
#' 
#'
#' @examples
#' data('mgus2', package='survival')
#'
#' causespecifichazards(data = mgus2,
#'                     elapsedtime = 'futime',
#'                     outcome = 'death',
#'                     covariates = c('age', 'sex'),
#'                     cause_variable = 'death',
#'                     reference_cause = '1')
#'
#' @param data the data as a data frame
#' @param elapsedtime Survival time or follow-up duration variable. Should
#'   contain positive  numeric values representing the time to event or
#'   censoring.
#' @param outcome Event indicator variable. Should contain values indicating
#'   the type of event or censoring (0 for censored, 1,2,3... for different
#'   causes).
#' @param covariates Vector of variable names for covariates/explanatory
#'   variables to include  in the cause-specific hazards models.
#' @param cause_variable Optional separate variable identifying the cause of
#'   failure. If not specified, the outcome variable will be used to identify
#'   causes.
#' @param reference_cause The reference cause for model comparison and hazard
#'   ratio calculations. Should match one of the cause levels in the data.
#' @param model_type Type of survival model to fit for each cause-specific
#'   hazard.
#' @param include_se Whether to compute and display standard errors for
#'   parameter estimates.
#' @param include_ci Whether to compute and display confidence intervals for
#'   parameter estimates.
#' @param conf_level Confidence level for confidence intervals (between 0.5
#'   and 0.99).
#' @param cumulative_incidence Whether to compute and display cumulative
#'   incidence functions for each cause.
#' @param model_comparison Whether to perform model comparison across
#'   different causes using likelihood ratio tests and information criteria.
#' @param proportional_hazards_test Whether to test the proportional hazards
#'   assumption for Cox models.
#' @param plot_cumulative_incidence Whether to create cumulative incidence
#'   function plots for each cause.
#' @param plot_hazards Whether to create hazard function plots for each cause.
#' @param plot_diagnostics Whether to create diagnostic plots for model
#'   assessment (residuals, etc.).
#' @param stratify_plots Whether to stratify plots by covariate levels for
#'   better visualization.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$overview} \tab \tab \tab \tab \tab Overview of the cause-specific hazards analysis \cr
#'   \code{results$cause_summary} \tab \tab \tab \tab \tab Summary of events by cause \cr
#'   \code{results$model_fit} \tab \tab \tab \tab \tab Model fit statistics for each cause-specific model \cr
#'   \code{results$coefficients} \tab \tab \tab \tab \tab Parameter estimates for each cause-specific model \cr
#'   \code{results$cumulative_incidence_table} \tab \tab \tab \tab \tab Cumulative incidence estimates by cause and time points \cr
#'   \code{results$model_comparison_table} \tab \tab \tab \tab \tab Comparison of model fit across different causes \cr
#'   \code{results$proportional_hazards_table} \tab \tab \tab \tab \tab Tests of proportional hazards assumption for each cause \cr
#'   \code{results$cumulative_incidence_plot} \tab \tab \tab \tab \tab Plot of cumulative incidence functions by cause \cr
#'   \code{results$hazards_plot} \tab \tab \tab \tab \tab Plot of hazard functions by cause \cr
#'   \code{results$diagnostics_plot} \tab \tab \tab \tab \tab Model diagnostic plots for cause-specific models \cr
#'   \code{results$model_summary} \tab \tab \tab \tab \tab Comprehensive summary and interpretation of cause-specific hazards analysis \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$overview$asDF}
#'
#' \code{as.data.frame(results$overview)}
#'
#' @export
causespecifichazards <- function(
    data,
    elapsedtime,
    outcome,
    covariates = NULL,
    cause_variable = NULL,
    reference_cause = "1",
    model_type = "cox",
    include_se = TRUE,
    include_ci = TRUE,
    conf_level = 0.95,
    cumulative_incidence = TRUE,
    model_comparison = FALSE,
    proportional_hazards_test = FALSE,
    plot_cumulative_incidence = FALSE,
    plot_hazards = FALSE,
    plot_diagnostics = FALSE,
    stratify_plots = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("causespecifichazards requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if ( ! missing(cause_variable)) cause_variable <- jmvcore::resolveQuo(jmvcore::enquo(cause_variable))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(elapsedtime), elapsedtime, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(covariates), covariates, NULL),
            `if`( ! missing(cause_variable), cause_variable, NULL))


    options <- causespecifichazardsOptions$new(
        elapsedtime = elapsedtime,
        outcome = outcome,
        covariates = covariates,
        cause_variable = cause_variable,
        reference_cause = reference_cause,
        model_type = model_type,
        include_se = include_se,
        include_ci = include_ci,
        conf_level = conf_level,
        cumulative_incidence = cumulative_incidence,
        model_comparison = model_comparison,
        proportional_hazards_test = proportional_hazards_test,
        plot_cumulative_incidence = plot_cumulative_incidence,
        plot_hazards = plot_hazards,
        plot_diagnostics = plot_diagnostics,
        stratify_plots = stratify_plots)

    analysis <- causespecifichazardsClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

