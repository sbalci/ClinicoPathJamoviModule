
# This file is automatically generated, you probably don't want to edit this

stratifiedparametricOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "stratifiedparametricOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            outcome = NULL,
            strata_variable = NULL,
            covariates = NULL,
            outcomeLevel = "1",
            parametric_distribution = "weibull",
            baseline_specification = "separate_baselines",
            spline_df = 3,
            knot_placement = "quantiles",
            test_stratification = TRUE,
            confidence_level = 0.95,
            show_model_summary = TRUE,
            show_coefficients = TRUE,
            show_stratification_test = TRUE,
            show_survival_curves = TRUE,
            show_hazard_curves = TRUE,
            show_comparison_plot = FALSE,
            show_diagnostics = TRUE,
            showSummaries = FALSE,
            showExplanations = FALSE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="stratifiedparametric",
                requiresData=TRUE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..strata_variable <- jmvcore::OptionVariable$new(
                "strata_variable",
                strata_variable,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..outcomeLevel <- jmvcore::OptionString$new(
                "outcomeLevel",
                outcomeLevel,
                default="1")
            private$..parametric_distribution <- jmvcore::OptionList$new(
                "parametric_distribution",
                parametric_distribution,
                options=list(
                    "weibull",
                    "exponential",
                    "lognormal",
                    "loglogistic",
                    "gamma",
                    "gengamma",
                    "genf"),
                default="weibull")
            private$..baseline_specification <- jmvcore::OptionList$new(
                "baseline_specification",
                baseline_specification,
                options=list(
                    "separate_baselines",
                    "proportional_baselines",
                    "shared_shape",
                    "fully_stratified"),
                default="separate_baselines")
            private$..spline_df <- jmvcore::OptionInteger$new(
                "spline_df",
                spline_df,
                default=3,
                min=1,
                max=10)
            private$..knot_placement <- jmvcore::OptionList$new(
                "knot_placement",
                knot_placement,
                options=list(
                    "quantiles",
                    "boundary",
                    "auto"),
                default="quantiles")
            private$..test_stratification <- jmvcore::OptionBool$new(
                "test_stratification",
                test_stratification,
                default=TRUE)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.5,
                max=0.99)
            private$..show_model_summary <- jmvcore::OptionBool$new(
                "show_model_summary",
                show_model_summary,
                default=TRUE)
            private$..show_coefficients <- jmvcore::OptionBool$new(
                "show_coefficients",
                show_coefficients,
                default=TRUE)
            private$..show_stratification_test <- jmvcore::OptionBool$new(
                "show_stratification_test",
                show_stratification_test,
                default=TRUE)
            private$..show_survival_curves <- jmvcore::OptionBool$new(
                "show_survival_curves",
                show_survival_curves,
                default=TRUE)
            private$..show_hazard_curves <- jmvcore::OptionBool$new(
                "show_hazard_curves",
                show_hazard_curves,
                default=TRUE)
            private$..show_comparison_plot <- jmvcore::OptionBool$new(
                "show_comparison_plot",
                show_comparison_plot,
                default=FALSE)
            private$..show_diagnostics <- jmvcore::OptionBool$new(
                "show_diagnostics",
                show_diagnostics,
                default=TRUE)
            private$..showSummaries <- jmvcore::OptionBool$new(
                "showSummaries",
                showSummaries,
                default=FALSE)
            private$..showExplanations <- jmvcore::OptionBool$new(
                "showExplanations",
                showExplanations,
                default=FALSE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..outcome)
            self$.addOption(private$..strata_variable)
            self$.addOption(private$..covariates)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..parametric_distribution)
            self$.addOption(private$..baseline_specification)
            self$.addOption(private$..spline_df)
            self$.addOption(private$..knot_placement)
            self$.addOption(private$..test_stratification)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..show_model_summary)
            self$.addOption(private$..show_coefficients)
            self$.addOption(private$..show_stratification_test)
            self$.addOption(private$..show_survival_curves)
            self$.addOption(private$..show_hazard_curves)
            self$.addOption(private$..show_comparison_plot)
            self$.addOption(private$..show_diagnostics)
            self$.addOption(private$..showSummaries)
            self$.addOption(private$..showExplanations)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        outcome = function() private$..outcome$value,
        strata_variable = function() private$..strata_variable$value,
        covariates = function() private$..covariates$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        parametric_distribution = function() private$..parametric_distribution$value,
        baseline_specification = function() private$..baseline_specification$value,
        spline_df = function() private$..spline_df$value,
        knot_placement = function() private$..knot_placement$value,
        test_stratification = function() private$..test_stratification$value,
        confidence_level = function() private$..confidence_level$value,
        show_model_summary = function() private$..show_model_summary$value,
        show_coefficients = function() private$..show_coefficients$value,
        show_stratification_test = function() private$..show_stratification_test$value,
        show_survival_curves = function() private$..show_survival_curves$value,
        show_hazard_curves = function() private$..show_hazard_curves$value,
        show_comparison_plot = function() private$..show_comparison_plot$value,
        show_diagnostics = function() private$..show_diagnostics$value,
        showSummaries = function() private$..showSummaries$value,
        showExplanations = function() private$..showExplanations$value),
    private = list(
        ..elapsedtime = NA,
        ..outcome = NA,
        ..strata_variable = NA,
        ..covariates = NA,
        ..outcomeLevel = NA,
        ..parametric_distribution = NA,
        ..baseline_specification = NA,
        ..spline_df = NA,
        ..knot_placement = NA,
        ..test_stratification = NA,
        ..confidence_level = NA,
        ..show_model_summary = NA,
        ..show_coefficients = NA,
        ..show_stratification_test = NA,
        ..show_survival_curves = NA,
        ..show_hazard_curves = NA,
        ..show_comparison_plot = NA,
        ..show_diagnostics = NA,
        ..showSummaries = NA,
        ..showExplanations = NA)
)

stratifiedparametricResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "stratifiedparametricResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        modelSummary = function() private$.items[["modelSummary"]],
        coefficientsTable = function() private$.items[["coefficientsTable"]],
        stratificationTestTable = function() private$.items[["stratificationTestTable"]],
        modelComparisonTable = function() private$.items[["modelComparisonTable"]],
        strataCharacteristicsTable = function() private$.items[["strataCharacteristicsTable"]],
        survivalPlot = function() private$.items[["survivalPlot"]],
        hazardPlot = function() private$.items[["hazardPlot"]],
        comparisonPlot = function() private$.items[["comparisonPlot"]],
        diagnosticPlots = function() private$.items[["diagnosticPlots"]],
        residualAnalysisTable = function() private$.items[["residualAnalysisTable"]],
        predictionTable = function() private$.items[["predictionTable"]],
        analysisSummary = function() private$.items[["analysisSummary"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Stratified Parametric Models",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                visible="(show_model_summary)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="coefficientsTable",
                title="Parameter Estimates by Strata",
                visible="(show_coefficients)",
                columns=list(
                    list(
                        `name`="stratum", 
                        `title`="Stratum", 
                        `type`="text"),
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="z_value", 
                        `title`="z", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="stratificationTestTable",
                title="Stratification Effect Test",
                visible="(show_stratification_test)",
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="test_statistic", 
                        `title`="Test Statistic", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelComparisonTable",
                title="Model Comparison Statistics",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="model", 
                        `title`="Model", 
                        `type`="text"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number"),
                    list(
                        `name`="loglik", 
                        `title`="Log-likelihood", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="deviance", 
                        `title`="Deviance", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="strataCharacteristicsTable",
                title="Strata Characteristics",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="stratum", 
                        `title`="Stratum", 
                        `type`="text"),
                    list(
                        `name`="n_total", 
                        `title`="Total", 
                        `type`="integer"),
                    list(
                        `name`="n_events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="event_rate", 
                        `title`="Event Rate (%)", 
                        `type`="number"),
                    list(
                        `name`="median_time", 
                        `title`="Median Time", 
                        `type`="number"),
                    list(
                        `name`="mean_time", 
                        `title`="Mean Time", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlot",
                title="Stratified Survival Curves",
                visible="(show_survival_curves)",
                width=800,
                height=600,
                renderFun=".plot"))
            self$add(jmvcore::Image$new(
                options=options,
                name="hazardPlot",
                title="Stratified Hazard Functions",
                visible="(show_hazard_curves)",
                width=800,
                height=600,
                renderFun=".plotHazard"))
            self$add(jmvcore::Image$new(
                options=options,
                name="comparisonPlot",
                title="Stratified vs Non-stratified Model",
                visible="(show_comparison_plot)",
                width=900,
                height=600,
                renderFun=".plotComparison"))
            self$add(jmvcore::Image$new(
                options=options,
                name="diagnosticPlots",
                title="Stratified Model Diagnostics",
                visible="(show_diagnostics)",
                width=1000,
                height=700,
                renderFun=".plotDiagnostics"))
            self$add(jmvcore::Table$new(
                options=options,
                name="residualAnalysisTable",
                title="Residual Analysis by Strata",
                visible="(show_diagnostics)",
                columns=list(
                    list(
                        `name`="stratum", 
                        `title`="Stratum", 
                        `type`="text"),
                    list(
                        `name`="residual_type", 
                        `title`="Residual Type", 
                        `type`="text"),
                    list(
                        `name`="mean_residual", 
                        `title`="Mean", 
                        `type`="number"),
                    list(
                        `name`="sd_residual", 
                        `title`="SD", 
                        `type`="number"),
                    list(
                        `name`="ks_test_p", 
                        `title`="KS Test p-value", 
                        `type`="number"),
                    list(
                        `name`="normality_assessment", 
                        `title`="Normality", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="predictionTable",
                title="Predicted Values by Strata",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="stratum", 
                        `title`="Stratum", 
                        `type`="text"),
                    list(
                        `name`="time_point", 
                        `title`="Time Point", 
                        `type`="number"),
                    list(
                        `name`="survival_prob", 
                        `title`="Survival Probability", 
                        `type`="number"),
                    list(
                        `name`="hazard_rate", 
                        `title`="Hazard Rate", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="analysisSummary",
                title="Analysis Summary",
                visible="(showSummaries)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Methodology",
                visible="(showExplanations)"))}))

stratifiedparametricBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "stratifiedparametricBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "stratifiedparametric",
                version = c(1,0,0),
                options = options,
                results = stratifiedparametricResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Stratified Parametric Models
#'
#' 
#' @param data The data as a data frame.
#' @param elapsedtime Time variable for survival analysis.
#' @param outcome Event indicator variable.
#' @param strata_variable Variable for stratifying the parametric models.
#' @param covariates Covariates to include in the stratified parametric model.
#' @param outcomeLevel Level of outcome variable indicating event.
#' @param parametric_distribution Parametric distribution for stratified
#'   modeling.
#' @param baseline_specification Method for specifying baseline functions
#'   across strata.
#' @param spline_df Degrees of freedom for spline-based baseline functions.
#' @param knot_placement Method for placing spline knots.
#' @param test_stratification Test whether stratification significantly
#'   improves model fit.
#' @param confidence_level Confidence level for parameter estimates and
#'   predictions.
#' @param show_model_summary Display comprehensive model summary information.
#' @param show_coefficients Display parameter estimates for each stratum.
#' @param show_stratification_test Display test results for stratification
#'   effect.
#' @param show_survival_curves Display stratified survival curves.
#' @param show_hazard_curves Display stratified hazard functions.
#' @param show_comparison_plot Compare stratified vs non-stratified models.
#' @param show_diagnostics Display diagnostic plots and statistics for each
#'   stratum.
#' @param showSummaries Generate natural language summaries of results.
#' @param showExplanations Show detailed methodology explanations.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$coefficientsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$stratificationTestTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelComparisonTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$strataCharacteristicsTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$survivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$hazardPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$comparisonPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$diagnosticPlots} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$residualAnalysisTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$predictionTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$analysisSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$coefficientsTable$asDF}
#'
#' \code{as.data.frame(results$coefficientsTable)}
#'
#' @export
stratifiedparametric <- function(
    data,
    elapsedtime,
    outcome,
    strata_variable,
    covariates,
    outcomeLevel = "1",
    parametric_distribution = "weibull",
    baseline_specification = "separate_baselines",
    spline_df = 3,
    knot_placement = "quantiles",
    test_stratification = TRUE,
    confidence_level = 0.95,
    show_model_summary = TRUE,
    show_coefficients = TRUE,
    show_stratification_test = TRUE,
    show_survival_curves = TRUE,
    show_hazard_curves = TRUE,
    show_comparison_plot = FALSE,
    show_diagnostics = TRUE,
    showSummaries = FALSE,
    showExplanations = FALSE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("stratifiedparametric requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(strata_variable)) strata_variable <- jmvcore::resolveQuo(jmvcore::enquo(strata_variable))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(elapsedtime), elapsedtime, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(strata_variable), strata_variable, NULL),
            `if`( ! missing(covariates), covariates, NULL))


    options <- stratifiedparametricOptions$new(
        elapsedtime = elapsedtime,
        outcome = outcome,
        strata_variable = strata_variable,
        covariates = covariates,
        outcomeLevel = outcomeLevel,
        parametric_distribution = parametric_distribution,
        baseline_specification = baseline_specification,
        spline_df = spline_df,
        knot_placement = knot_placement,
        test_stratification = test_stratification,
        confidence_level = confidence_level,
        show_model_summary = show_model_summary,
        show_coefficients = show_coefficients,
        show_stratification_test = show_stratification_test,
        show_survival_curves = show_survival_curves,
        show_hazard_curves = show_hazard_curves,
        show_comparison_plot = show_comparison_plot,
        show_diagnostics = show_diagnostics,
        showSummaries = showSummaries,
        showExplanations = showExplanations)

    analysis <- stratifiedparametricClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

