
# This file is automatically generated, you probably don't want to edit this

thresholdregressionOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "thresholdregressionOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            status = NULL,
            covariates = NULL,
            thresholdType = "single",
            estimationMethod = "mle",
            maxThresholds = 3,
            confidenceLevel = 0.95,
            bootstrapSamples = 500,
            performBootstrap = FALSE,
            selectionCriterion = "bic",
            plotHazard = TRUE,
            plotResiduals = FALSE,
            diagnosticTests = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="thresholdregression",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..status <- jmvcore::OptionVariable$new(
                "status",
                status,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..covariates <- jmvcore::OptionVariables$new(
                "covariates",
                covariates,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..thresholdType <- jmvcore::OptionList$new(
                "thresholdType",
                thresholdType,
                options=list(
                    "single",
                    "multiple",
                    "adaptive"),
                default="single")
            private$..estimationMethod <- jmvcore::OptionList$new(
                "estimationMethod",
                estimationMethod,
                options=list(
                    "mle",
                    "em",
                    "bayesian",
                    "nonparametric"),
                default="mle")
            private$..maxThresholds <- jmvcore::OptionInteger$new(
                "maxThresholds",
                maxThresholds,
                min=1,
                max=10,
                default=3)
            private$..confidenceLevel <- jmvcore::OptionNumber$new(
                "confidenceLevel",
                confidenceLevel,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..bootstrapSamples <- jmvcore::OptionInteger$new(
                "bootstrapSamples",
                bootstrapSamples,
                min=100,
                max=2000,
                default=500)
            private$..performBootstrap <- jmvcore::OptionBool$new(
                "performBootstrap",
                performBootstrap,
                default=FALSE)
            private$..selectionCriterion <- jmvcore::OptionList$new(
                "selectionCriterion",
                selectionCriterion,
                options=list(
                    "aic",
                    "bic",
                    "cross_validation",
                    "likelihood_ratio"),
                default="bic")
            private$..plotHazard <- jmvcore::OptionBool$new(
                "plotHazard",
                plotHazard,
                default=TRUE)
            private$..plotResiduals <- jmvcore::OptionBool$new(
                "plotResiduals",
                plotResiduals,
                default=FALSE)
            private$..diagnosticTests <- jmvcore::OptionBool$new(
                "diagnosticTests",
                diagnosticTests,
                default=TRUE)

            self$.addOption(private$..time)
            self$.addOption(private$..status)
            self$.addOption(private$..covariates)
            self$.addOption(private$..thresholdType)
            self$.addOption(private$..estimationMethod)
            self$.addOption(private$..maxThresholds)
            self$.addOption(private$..confidenceLevel)
            self$.addOption(private$..bootstrapSamples)
            self$.addOption(private$..performBootstrap)
            self$.addOption(private$..selectionCriterion)
            self$.addOption(private$..plotHazard)
            self$.addOption(private$..plotResiduals)
            self$.addOption(private$..diagnosticTests)
        }),
    active = list(
        time = function() private$..time$value,
        status = function() private$..status$value,
        covariates = function() private$..covariates$value,
        thresholdType = function() private$..thresholdType$value,
        estimationMethod = function() private$..estimationMethod$value,
        maxThresholds = function() private$..maxThresholds$value,
        confidenceLevel = function() private$..confidenceLevel$value,
        bootstrapSamples = function() private$..bootstrapSamples$value,
        performBootstrap = function() private$..performBootstrap$value,
        selectionCriterion = function() private$..selectionCriterion$value,
        plotHazard = function() private$..plotHazard$value,
        plotResiduals = function() private$..plotResiduals$value,
        diagnosticTests = function() private$..diagnosticTests$value),
    private = list(
        ..time = NA,
        ..status = NA,
        ..covariates = NA,
        ..thresholdType = NA,
        ..estimationMethod = NA,
        ..maxThresholds = NA,
        ..confidenceLevel = NA,
        ..bootstrapSamples = NA,
        ..performBootstrap = NA,
        ..selectionCriterion = NA,
        ..plotHazard = NA,
        ..plotResiduals = NA,
        ..diagnosticTests = NA)
)

thresholdregressionResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "thresholdregressionResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        thresholdEstimates = function() private$.items[["thresholdEstimates"]],
        modelCoefficients = function() private$.items[["modelCoefficients"]],
        modelSelection = function() private$.items[["modelSelection"]],
        diagnosticTests = function() private$.items[["diagnosticTests"]],
        bootstrapResults = function() private$.items[["bootstrapResults"]],
        hazardPlot = function() private$.items[["hazardPlot"]],
        residualPlot = function() private$.items[["residualPlot"]],
        modelSummary = function() private$.items[["modelSummary"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Threshold Regression Models")
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="thresholdEstimates",
                title="Threshold Estimates",
                visible=TRUE,
                columns=list(
                    list(
                        `name`="threshold_id", 
                        `title`="Threshold", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="Standard Error", 
                        `type`="number"),
                    list(
                        `name`="lower_ci", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="upper_ci", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelCoefficients",
                title="Model Coefficients",
                visible="(covariates)",
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="period", 
                        `title`="Period", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="z_value", 
                        `title`="z value", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="hr", 
                        `title`="Hazard Ratio", 
                        `type`="number"),
                    list(
                        `name`="hr_lower", 
                        `title`="HR Lower CI", 
                        `type`="number"),
                    list(
                        `name`="hr_upper", 
                        `title`="HR Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelSelection",
                title="Model Selection",
                visible="(thresholdType:multiple || thresholdType:adaptive)",
                columns=list(
                    list(
                        `name`="n_thresholds", 
                        `title`="Number of Thresholds", 
                        `type`="integer"),
                    list(
                        `name`="loglik", 
                        `title`="Log-Likelihood", 
                        `type`="number"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number"),
                    list(
                        `name`="selected", 
                        `title`="Selected", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="diagnosticTests",
                title="Diagnostic Tests",
                visible="(diagnosticTests)",
                columns=list(
                    list(
                        `name`="test_name", 
                        `title`="Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="number"),
                    list(
                        `name`="df", 
                        `title`="df", 
                        `type`="integer"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="bootstrapResults",
                title="Bootstrap Results",
                visible="(performBootstrap)",
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="original", 
                        `title`="Original Estimate", 
                        `type`="number"),
                    list(
                        `name`="boot_mean", 
                        `title`="Bootstrap Mean", 
                        `type`="number"),
                    list(
                        `name`="boot_se", 
                        `title`="Bootstrap SE", 
                        `type`="number"),
                    list(
                        `name`="boot_lower", 
                        `title`="Bootstrap Lower CI", 
                        `type`="number"),
                    list(
                        `name`="boot_upper", 
                        `title`="Bootstrap Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="hazardPlot",
                title="Hazard Function Plot",
                visible="(plotHazard)",
                width=700,
                height=500,
                renderFun=".hazardPlot"))
            self$add(jmvcore::Image$new(
                options=options,
                name="residualPlot",
                title="Residual Plot",
                visible="(plotResiduals)",
                width=600,
                height=400,
                renderFun=".residualPlot"))
            self$add(jmvcore::Html$new(
                options=options,
                name="modelSummary",
                title="Analysis Summary",
                visible=TRUE))}))

thresholdregressionBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "thresholdregressionBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "thresholdregression",
                version = c(1,0,0),
                options = options,
                results = thresholdregressionResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Threshold Regression Models
#'
#' Performs threshold regression analysis for survival data with 
#' change-points.
#' This method is designed to identify and model thresholds or change-points 
#' in
#' survival processes where the hazard function changes at unknown time 
#' points.
#' 
#' Key features:
#' - Multiple change-point detection in survival data
#' - Threshold regression with parametric and semi-parametric approaches
#' - Covariate effects on threshold parameters
#' - Model selection for optimal number of thresholds
#' - Bootstrap confidence intervals for threshold estimates
#' - Graphical visualization of hazard changes
#' 
#'
#' @examples
#' # Threshold regression with single change-point
#' thresholdregression(
#'     data = data,
#'     time = "time",
#'     status = "status",
#'     covariates = c("age", "treatment"),
#'     thresholdType = "single",
#'     estimationMethod = "mle"
#' )
#'
#' @param data the data as a data frame
#' @param time the time variable for survival analysis
#' @param status the status variable (0 = censored, 1 = event)
#' @param covariates covariates to include in the threshold regression model
#' @param thresholdType the type of threshold model to fit
#' @param estimationMethod the estimation method for threshold parameters
#' @param maxThresholds maximum number of thresholds to consider for multiple
#'   threshold models
#' @param confidenceLevel the confidence level for threshold estimates
#' @param bootstrapSamples number of bootstrap samples for confidence
#'   intervals
#' @param performBootstrap whether to perform bootstrap analysis for
#'   confidence intervals
#' @param selectionCriterion criterion for selecting the optimal number of
#'   thresholds
#' @param plotHazard whether to plot the estimated hazard function with
#'   thresholds
#' @param plotResiduals whether to plot model residuals
#' @param diagnosticTests whether to perform diagnostic tests for threshold
#'   significance
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$thresholdEstimates} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelCoefficients} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelSelection} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$diagnosticTests} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$bootstrapResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$hazardPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$residualPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$thresholdEstimates$asDF}
#'
#' \code{as.data.frame(results$thresholdEstimates)}
#'
#' @export
thresholdregression <- function(
    data,
    time,
    status,
    covariates,
    thresholdType = "single",
    estimationMethod = "mle",
    maxThresholds = 3,
    confidenceLevel = 0.95,
    bootstrapSamples = 500,
    performBootstrap = FALSE,
    selectionCriterion = "bic",
    plotHazard = TRUE,
    plotResiduals = FALSE,
    diagnosticTests = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("thresholdregression requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(status)) status <- jmvcore::resolveQuo(jmvcore::enquo(status))
    if ( ! missing(covariates)) covariates <- jmvcore::resolveQuo(jmvcore::enquo(covariates))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(status), status, NULL),
            `if`( ! missing(covariates), covariates, NULL))

    for (v in status) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- thresholdregressionOptions$new(
        time = time,
        status = status,
        covariates = covariates,
        thresholdType = thresholdType,
        estimationMethod = estimationMethod,
        maxThresholds = maxThresholds,
        confidenceLevel = confidenceLevel,
        bootstrapSamples = bootstrapSamples,
        performBootstrap = performBootstrap,
        selectionCriterion = selectionCriterion,
        plotHazard = plotHazard,
        plotResiduals = plotResiduals,
        diagnosticTests = diagnosticTests)

    analysis <- thresholdregressionClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

