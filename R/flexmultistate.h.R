
# This file is automatically generated, you probably don't want to edit this

flexmultistateOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "flexmultistateOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            status = NULL,
            start_state = NULL,
            predictors = NULL,
            model_type = "illness_death",
            hazard_distribution = "royston_parmar",
            spline_knots = 3,
            time_scale = "hazard",
            transition_specific = TRUE,
            shared_effects = NULL,
            time_varying_effects = NULL,
            prediction_times = "12, 24, 36, 60",
            transition_probabilities = TRUE,
            state_probabilities = TRUE,
            expected_sojourn = TRUE,
            plot_hazards = TRUE,
            plot_cumhaz = TRUE,
            plot_survival = TRUE,
            microsimulation = FALSE,
            n_simulation = 10000,
            confidence_intervals = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="flexmultistate",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..status <- jmvcore::OptionVariable$new(
                "status",
                status,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..start_state <- jmvcore::OptionVariable$new(
                "start_state",
                start_state,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..predictors <- jmvcore::OptionVariables$new(
                "predictors",
                predictors,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..model_type <- jmvcore::OptionList$new(
                "model_type",
                model_type,
                options=list(
                    "illness_death",
                    "competing_risks",
                    "progressive",
                    "custom"),
                default="illness_death")
            private$..hazard_distribution <- jmvcore::OptionList$new(
                "hazard_distribution",
                hazard_distribution,
                options=list(
                    "weibull_spline",
                    "lognormal_spline",
                    "royston_parmar",
                    "piecewise_exp"),
                default="royston_parmar")
            private$..spline_knots <- jmvcore::OptionInteger$new(
                "spline_knots",
                spline_knots,
                default=3,
                min=1,
                max=10)
            private$..time_scale <- jmvcore::OptionList$new(
                "time_scale",
                time_scale,
                options=list(
                    "hazard",
                    "odds",
                    "normal"),
                default="hazard")
            private$..transition_specific <- jmvcore::OptionBool$new(
                "transition_specific",
                transition_specific,
                default=TRUE)
            private$..shared_effects <- jmvcore::OptionVariables$new(
                "shared_effects",
                shared_effects,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..time_varying_effects <- jmvcore::OptionVariables$new(
                "time_varying_effects",
                time_varying_effects,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..prediction_times <- jmvcore::OptionString$new(
                "prediction_times",
                prediction_times,
                default="12, 24, 36, 60")
            private$..transition_probabilities <- jmvcore::OptionBool$new(
                "transition_probabilities",
                transition_probabilities,
                default=TRUE)
            private$..state_probabilities <- jmvcore::OptionBool$new(
                "state_probabilities",
                state_probabilities,
                default=TRUE)
            private$..expected_sojourn <- jmvcore::OptionBool$new(
                "expected_sojourn",
                expected_sojourn,
                default=TRUE)
            private$..plot_hazards <- jmvcore::OptionBool$new(
                "plot_hazards",
                plot_hazards,
                default=TRUE)
            private$..plot_cumhaz <- jmvcore::OptionBool$new(
                "plot_cumhaz",
                plot_cumhaz,
                default=TRUE)
            private$..plot_survival <- jmvcore::OptionBool$new(
                "plot_survival",
                plot_survival,
                default=TRUE)
            private$..microsimulation <- jmvcore::OptionBool$new(
                "microsimulation",
                microsimulation,
                default=FALSE)
            private$..n_simulation <- jmvcore::OptionInteger$new(
                "n_simulation",
                n_simulation,
                default=10000,
                min=1000,
                max=100000)
            private$..confidence_intervals <- jmvcore::OptionBool$new(
                "confidence_intervals",
                confidence_intervals,
                default=TRUE)

            self$.addOption(private$..time)
            self$.addOption(private$..status)
            self$.addOption(private$..start_state)
            self$.addOption(private$..predictors)
            self$.addOption(private$..model_type)
            self$.addOption(private$..hazard_distribution)
            self$.addOption(private$..spline_knots)
            self$.addOption(private$..time_scale)
            self$.addOption(private$..transition_specific)
            self$.addOption(private$..shared_effects)
            self$.addOption(private$..time_varying_effects)
            self$.addOption(private$..prediction_times)
            self$.addOption(private$..transition_probabilities)
            self$.addOption(private$..state_probabilities)
            self$.addOption(private$..expected_sojourn)
            self$.addOption(private$..plot_hazards)
            self$.addOption(private$..plot_cumhaz)
            self$.addOption(private$..plot_survival)
            self$.addOption(private$..microsimulation)
            self$.addOption(private$..n_simulation)
            self$.addOption(private$..confidence_intervals)
        }),
    active = list(
        time = function() private$..time$value,
        status = function() private$..status$value,
        start_state = function() private$..start_state$value,
        predictors = function() private$..predictors$value,
        model_type = function() private$..model_type$value,
        hazard_distribution = function() private$..hazard_distribution$value,
        spline_knots = function() private$..spline_knots$value,
        time_scale = function() private$..time_scale$value,
        transition_specific = function() private$..transition_specific$value,
        shared_effects = function() private$..shared_effects$value,
        time_varying_effects = function() private$..time_varying_effects$value,
        prediction_times = function() private$..prediction_times$value,
        transition_probabilities = function() private$..transition_probabilities$value,
        state_probabilities = function() private$..state_probabilities$value,
        expected_sojourn = function() private$..expected_sojourn$value,
        plot_hazards = function() private$..plot_hazards$value,
        plot_cumhaz = function() private$..plot_cumhaz$value,
        plot_survival = function() private$..plot_survival$value,
        microsimulation = function() private$..microsimulation$value,
        n_simulation = function() private$..n_simulation$value,
        confidence_intervals = function() private$..confidence_intervals$value),
    private = list(
        ..time = NA,
        ..status = NA,
        ..start_state = NA,
        ..predictors = NA,
        ..model_type = NA,
        ..hazard_distribution = NA,
        ..spline_knots = NA,
        ..time_scale = NA,
        ..transition_specific = NA,
        ..shared_effects = NA,
        ..time_varying_effects = NA,
        ..prediction_times = NA,
        ..transition_probabilities = NA,
        ..state_probabilities = NA,
        ..expected_sojourn = NA,
        ..plot_hazards = NA,
        ..plot_cumhaz = NA,
        ..plot_survival = NA,
        ..microsimulation = NA,
        ..n_simulation = NA,
        ..confidence_intervals = NA)
)

flexmultistateResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "flexmultistateResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        summary = function() private$.items[["summary"]],
        transitionMatrix = function() private$.items[["transitionMatrix"]],
        transitionModels = function() private$.items[["transitionModels"]],
        modelComparison = function() private$.items[["modelComparison"]],
        transitionProbTable = function() private$.items[["transitionProbTable"]],
        stateProbTable = function() private$.items[["stateProbTable"]],
        sojournTable = function() private$.items[["sojournTable"]],
        hazardPlot = function() private$.items[["hazardPlot"]],
        cumhazPlot = function() private$.items[["cumhazPlot"]],
        survivalPlot = function() private$.items[["survivalPlot"]],
        transitionDiagram = function() private$.items[["transitionDiagram"]],
        microsimResults = function() private$.items[["microsimResults"]],
        goodnessOfFit = function() private$.items[["goodnessOfFit"]],
        clinicalInterpretation = function() private$.items[["clinicalInterpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Flexible Multi-State Survival Models")
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Instructions",
                clearWith=list(
                    "time",
                    "status",
                    "predictors")))
            self$add(jmvcore::Html$new(
                options=options,
                name="summary",
                title="Model Summary",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="transitionMatrix",
                title="Transition Matrix",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="from_state", 
                        `title`="From State", 
                        `type`="text"),
                    list(
                        `name`="to_state", 
                        `title`="To State", 
                        `type`="text"),
                    list(
                        `name`="transition_name", 
                        `title`="Transition", 
                        `type`="text"),
                    list(
                        `name`="n_transitions", 
                        `title`="Observed", 
                        `type`="integer"),
                    list(
                        `name`="person_years", 
                        `title`="Person-Years", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="transitionModels",
                title="Transition Model Results",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="transition", 
                        `title`="Transition", 
                        `type`="text"),
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="Std. Error", 
                        `type`="number"),
                    list(
                        `name`="z_value", 
                        `title`="z value", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="hr", 
                        `title`="Hazard Ratio", 
                        `type`="number"),
                    list(
                        `name`="hr_lower", 
                        `title`="HR Lower", 
                        `type`="number"),
                    list(
                        `name`="hr_upper", 
                        `title`="HR Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelComparison",
                title="Model Fit Statistics",
                visible=TRUE,
                rows=1,
                columns=list(
                    list(
                        `name`="transition", 
                        `title`="Transition", 
                        `type`="text"),
                    list(
                        `name`="loglik", 
                        `title`="Log-Likelihood", 
                        `type`="number"),
                    list(
                        `name`="aic", 
                        `title`="AIC", 
                        `type`="number"),
                    list(
                        `name`="bic", 
                        `title`="BIC", 
                        `type`="number"),
                    list(
                        `name`="n_parameters", 
                        `title`="Parameters", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="transitionProbTable",
                title="Transition Probabilities",
                visible="(transition_probabilities)",
                rows=1,
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="from_state", 
                        `title`="From State", 
                        `type`="text"),
                    list(
                        `name`="to_state", 
                        `title`="To State", 
                        `type`="text"),
                    list(
                        `name`="probability", 
                        `title`="Probability", 
                        `type`="number"),
                    list(
                        `name`="prob_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="prob_upper", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="stateProbTable",
                title="State Occupancy Probabilities",
                visible="(state_probabilities)",
                rows=1,
                columns=list(
                    list(
                        `name`="time_point", 
                        `title`="Time", 
                        `type`="number"),
                    list(
                        `name`="state", 
                        `title`="State", 
                        `type`="text"),
                    list(
                        `name`="probability", 
                        `title`="Probability", 
                        `type`="number"),
                    list(
                        `name`="prob_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="prob_upper", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="sojournTable",
                title="Expected Sojourn Times",
                visible="(expected_sojourn)",
                rows=1,
                columns=list(
                    list(
                        `name`="state", 
                        `title`="State", 
                        `type`="text"),
                    list(
                        `name`="expected_time", 
                        `title`="Expected Time", 
                        `type`="number"),
                    list(
                        `name`="sojourn_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="sojourn_upper", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="hazardPlot",
                title="Transition Hazard Functions",
                width=700,
                height=500,
                renderFun=".plotTransitionHazards",
                visible="(plot_hazards)",
                clearWith=list(
                    "time",
                    "status",
                    "predictors",
                    "hazard_distribution")))
            self$add(jmvcore::Image$new(
                options=options,
                name="cumhazPlot",
                title="Cumulative Hazard Functions",
                width=700,
                height=500,
                renderFun=".plotCumulativeHazards",
                visible="(plot_cumhaz)",
                clearWith=list(
                    "time",
                    "status",
                    "predictors",
                    "hazard_distribution")))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlot",
                title="State Occupancy Probabilities",
                width=700,
                height=500,
                renderFun=".plotStateProbabilities",
                visible="(plot_survival)",
                clearWith=list(
                    "time",
                    "status",
                    "predictors",
                    "prediction_times")))
            self$add(jmvcore::Image$new(
                options=options,
                name="transitionDiagram",
                title="State Transition Diagram",
                width=600,
                height=400,
                renderFun=".plotTransitionDiagram",
                visible=TRUE,
                clearWith=list(
                    "model_type")))
            self$add(jmvcore::Html$new(
                options=options,
                name="microsimResults",
                title="Microsimulation Results",
                visible="(microsimulation)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="goodnessOfFit",
                title="Model Diagnostics",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinicalInterpretation",
                title="Clinical Interpretation",
                visible=TRUE))}))

flexmultistateBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "flexmultistateBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "flexmultistate",
                version = c(0,0,3),
                options = options,
                results = flexmultistateResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Flexible Multi-State Survival Models
#'
#' Flexible parametric multi-state survival models for complex disease 
#' progression.
#' Models transition hazards using splines and handles competing risks and 
#' intermediate states.
#' 
#'
#' @examples
#' \donttest{
#' # Example usage
#' flexmultistate(
#'     data = disease_data,
#'     time = transition_time,
#'     status = state_variable,
#'     states = c("Healthy", "Disease", "Death"),
#'     transition_matrix = transition_def
#' )
#'}
#' @param data The data as a data frame.
#' @param time Time variable for transitions
#' @param status State or transition status variable
#' @param start_state Variable indicating starting state
#' @param predictors Variables to include in transition models
#' @param model_type Multi-state model configuration
#' @param hazard_distribution Hazard function specification
#' @param spline_knots Spline complexity parameter
#' @param time_scale Transformation scale for splines
#' @param transition_specific Fit separate models for each transition type
#' @param shared_effects Predictors with constrained effects
#' @param time_varying_effects Predictors with time-dependent coefficients
#' @param prediction_times Time points for state occupancy predictions
#' @param transition_probabilities Compute state transition probabilities
#' @param state_probabilities Compute state occupancy probabilities
#' @param expected_sojourn Compute expected sojourn times
#' @param plot_hazards Generate hazard function plots
#' @param plot_cumhaz Generate cumulative hazard plots
#' @param plot_survival Generate state probability plots
#' @param microsimulation Use simulation for state predictions
#' @param n_simulation Sample size for microsimulation
#' @param confidence_intervals Compute uncertainty estimates
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$transitionMatrix} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$transitionModels} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$transitionProbTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$stateProbTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$sojournTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$hazardPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$cumhazPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$survivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$transitionDiagram} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$microsimResults} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$goodnessOfFit} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$clinicalInterpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$transitionMatrix$asDF}
#'
#' \code{as.data.frame(results$transitionMatrix)}
#'
#' @export
flexmultistate <- function(
    data,
    time,
    status,
    start_state = NULL,
    predictors,
    model_type = "illness_death",
    hazard_distribution = "royston_parmar",
    spline_knots = 3,
    time_scale = "hazard",
    transition_specific = TRUE,
    shared_effects,
    time_varying_effects,
    prediction_times = "12, 24, 36, 60",
    transition_probabilities = TRUE,
    state_probabilities = TRUE,
    expected_sojourn = TRUE,
    plot_hazards = TRUE,
    plot_cumhaz = TRUE,
    plot_survival = TRUE,
    microsimulation = FALSE,
    n_simulation = 10000,
    confidence_intervals = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("flexmultistate requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(status)) status <- jmvcore::resolveQuo(jmvcore::enquo(status))
    if ( ! missing(start_state)) start_state <- jmvcore::resolveQuo(jmvcore::enquo(start_state))
    if ( ! missing(predictors)) predictors <- jmvcore::resolveQuo(jmvcore::enquo(predictors))
    if ( ! missing(shared_effects)) shared_effects <- jmvcore::resolveQuo(jmvcore::enquo(shared_effects))
    if ( ! missing(time_varying_effects)) time_varying_effects <- jmvcore::resolveQuo(jmvcore::enquo(time_varying_effects))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(status), status, NULL),
            `if`( ! missing(start_state), start_state, NULL),
            `if`( ! missing(predictors), predictors, NULL),
            `if`( ! missing(shared_effects), shared_effects, NULL),
            `if`( ! missing(time_varying_effects), time_varying_effects, NULL))


    options <- flexmultistateOptions$new(
        time = time,
        status = status,
        start_state = start_state,
        predictors = predictors,
        model_type = model_type,
        hazard_distribution = hazard_distribution,
        spline_knots = spline_knots,
        time_scale = time_scale,
        transition_specific = transition_specific,
        shared_effects = shared_effects,
        time_varying_effects = time_varying_effects,
        prediction_times = prediction_times,
        transition_probabilities = transition_probabilities,
        state_probabilities = state_probabilities,
        expected_sojourn = expected_sojourn,
        plot_hazards = plot_hazards,
        plot_cumhaz = plot_cumhaz,
        plot_survival = plot_survival,
        microsimulation = microsimulation,
        n_simulation = n_simulation,
        confidence_intervals = confidence_intervals)

    analysis <- flexmultistateClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

