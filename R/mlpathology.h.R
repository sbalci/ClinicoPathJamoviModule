
# This file is automatically generated, you probably don't want to edit this

mlpathologyOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "mlpathologyOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            analysis_type = "classification",
            actual_labels = NULL,
            predicted_labels = NULL,
            predicted_probabilities = NULL,
            reference_segmentation = NULL,
            predicted_segmentation = NULL,
            model1_predictions = NULL,
            model2_predictions = NULL,
            model1_probabilities = NULL,
            model2_probabilities = NULL,
            roc_analysis = TRUE,
            roc_comparison = FALSE,
            confidence_level = 0.95,
            confusion_matrix_plot = TRUE,
            roc_plot = TRUE,
            bootstrap_validation = FALSE,
            bootstrap_runs = 1000, ...) {

            super$initialize(
                package="ClinicoPath",
                name="mlpathology",
                requiresData=TRUE,
                ...)

            private$..analysis_type <- jmvcore::OptionList$new(
                "analysis_type",
                analysis_type,
                options=list(
                    "classification",
                    "segmentation",
                    "comparison"),
                default="classification")
            private$..actual_labels <- jmvcore::OptionVariable$new(
                "actual_labels",
                actual_labels,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..predicted_labels <- jmvcore::OptionVariable$new(
                "predicted_labels",
                predicted_labels,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..predicted_probabilities <- jmvcore::OptionVariable$new(
                "predicted_probabilities",
                predicted_probabilities,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..reference_segmentation <- jmvcore::OptionVariable$new(
                "reference_segmentation",
                reference_segmentation,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..predicted_segmentation <- jmvcore::OptionVariable$new(
                "predicted_segmentation",
                predicted_segmentation,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..model1_predictions <- jmvcore::OptionVariable$new(
                "model1_predictions",
                model1_predictions,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..model2_predictions <- jmvcore::OptionVariable$new(
                "model2_predictions",
                model2_predictions,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..model1_probabilities <- jmvcore::OptionVariable$new(
                "model1_probabilities",
                model1_probabilities,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..model2_probabilities <- jmvcore::OptionVariable$new(
                "model2_probabilities",
                model2_probabilities,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..roc_analysis <- jmvcore::OptionBool$new(
                "roc_analysis",
                roc_analysis,
                default=TRUE)
            private$..roc_comparison <- jmvcore::OptionBool$new(
                "roc_comparison",
                roc_comparison,
                default=FALSE)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.5,
                max=0.99,
                default=0.95)
            private$..confusion_matrix_plot <- jmvcore::OptionBool$new(
                "confusion_matrix_plot",
                confusion_matrix_plot,
                default=TRUE)
            private$..roc_plot <- jmvcore::OptionBool$new(
                "roc_plot",
                roc_plot,
                default=TRUE)
            private$..bootstrap_validation <- jmvcore::OptionBool$new(
                "bootstrap_validation",
                bootstrap_validation,
                default=FALSE)
            private$..bootstrap_runs <- jmvcore::OptionInteger$new(
                "bootstrap_runs",
                bootstrap_runs,
                min=100,
                max=5000,
                default=1000)

            self$.addOption(private$..analysis_type)
            self$.addOption(private$..actual_labels)
            self$.addOption(private$..predicted_labels)
            self$.addOption(private$..predicted_probabilities)
            self$.addOption(private$..reference_segmentation)
            self$.addOption(private$..predicted_segmentation)
            self$.addOption(private$..model1_predictions)
            self$.addOption(private$..model2_predictions)
            self$.addOption(private$..model1_probabilities)
            self$.addOption(private$..model2_probabilities)
            self$.addOption(private$..roc_analysis)
            self$.addOption(private$..roc_comparison)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..confusion_matrix_plot)
            self$.addOption(private$..roc_plot)
            self$.addOption(private$..bootstrap_validation)
            self$.addOption(private$..bootstrap_runs)
        }),
    active = list(
        analysis_type = function() private$..analysis_type$value,
        actual_labels = function() private$..actual_labels$value,
        predicted_labels = function() private$..predicted_labels$value,
        predicted_probabilities = function() private$..predicted_probabilities$value,
        reference_segmentation = function() private$..reference_segmentation$value,
        predicted_segmentation = function() private$..predicted_segmentation$value,
        model1_predictions = function() private$..model1_predictions$value,
        model2_predictions = function() private$..model2_predictions$value,
        model1_probabilities = function() private$..model1_probabilities$value,
        model2_probabilities = function() private$..model2_probabilities$value,
        roc_analysis = function() private$..roc_analysis$value,
        roc_comparison = function() private$..roc_comparison$value,
        confidence_level = function() private$..confidence_level$value,
        confusion_matrix_plot = function() private$..confusion_matrix_plot$value,
        roc_plot = function() private$..roc_plot$value,
        bootstrap_validation = function() private$..bootstrap_validation$value,
        bootstrap_runs = function() private$..bootstrap_runs$value),
    private = list(
        ..analysis_type = NA,
        ..actual_labels = NA,
        ..predicted_labels = NA,
        ..predicted_probabilities = NA,
        ..reference_segmentation = NA,
        ..predicted_segmentation = NA,
        ..model1_predictions = NA,
        ..model2_predictions = NA,
        ..model1_probabilities = NA,
        ..model2_probabilities = NA,
        ..roc_analysis = NA,
        ..roc_comparison = NA,
        ..confidence_level = NA,
        ..confusion_matrix_plot = NA,
        ..roc_plot = NA,
        ..bootstrap_validation = NA,
        ..bootstrap_runs = NA)
)

mlpathologyResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "mlpathologyResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        confusionmatrix = function() private$.items[["confusionmatrix"]],
        performancemetrics = function() private$.items[["performancemetrics"]],
        rocanalysis = function() private$.items[["rocanalysis"]],
        segmentationmetrics = function() private$.items[["segmentationmetrics"]],
        modelcomparison = function() private$.items[["modelcomparison"]],
        roccomparison = function() private$.items[["roccomparison"]],
        confusionmatrixplot = function() private$.items[["confusionmatrixplot"]],
        rocplot = function() private$.items[["rocplot"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Classification Performance Metrics for Digital Pathology",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Getting Started",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="confusionmatrix",
                title="Confusion Matrix",
                visible="(analysis_type:classification)",
                clearWith=list(
                    "actual_labels",
                    "predicted_labels",
                    "analysis_type"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="performancemetrics",
                title="Performance Metrics",
                visible="(analysis_type:classification)",
                clearWith=list(
                    "actual_labels",
                    "predicted_labels",
                    "confidence_level",
                    "bootstrap_validation"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="rocanalysis",
                title="ROC Analysis Results",
                visible="(analysis_type:classification && roc_analysis && predicted_probabilities)",
                clearWith=list(
                    "actual_labels",
                    "predicted_probabilities",
                    "confidence_level"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="segmentationmetrics",
                title="Segmentation Quality Metrics",
                visible="(analysis_type:segmentation)",
                clearWith=list(
                    "reference_segmentation",
                    "predicted_segmentation"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelcomparison",
                title="Model Comparison Results",
                visible="(analysis_type:comparison)",
                clearWith=list(
                    "actual_labels",
                    "model1_predictions",
                    "model2_predictions"),
                columns=list()))
            self$add(jmvcore::Table$new(
                options=options,
                name="roccomparison",
                title="ROC Curve Comparison",
                visible="(analysis_type:comparison && roc_comparison && model1_probabilities && model2_probabilities)",
                clearWith=list(
                    "actual_labels",
                    "model1_probabilities",
                    "model2_probabilities"),
                columns=list()))
            self$add(jmvcore::Image$new(
                options=options,
                name="confusionmatrixplot",
                title="Confusion Matrix Heatmap",
                width=600,
                height=500,
                visible="(analysis_type:classification && confusion_matrix_plot)",
                requiresData=TRUE,
                clearWith=list(
                    "actual_labels",
                    "predicted_labels")))
            self$add(jmvcore::Image$new(
                options=options,
                name="rocplot",
                title="ROC Curve",
                width=600,
                height=500,
                visible="(analysis_type:classification && roc_plot && predicted_probabilities)",
                requiresData=TRUE,
                clearWith=list(
                    "actual_labels",
                    "predicted_probabilities")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation and Guidelines",
                visible=TRUE))}))

mlpathologyBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "mlpathologyBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "mlpathology",
                version = c(1,0,0),
                options = options,
                results = mlpathologyResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Classification Performance Metrics for Digital Pathology
#'
#' Comprehensive evaluation of machine learning models and algorithms for 
#' digital pathology applications. Provides classification metrics, ROC 
#' analysis, 
#' segmentation quality assessment, and statistical model comparison for AI 
#' validation and algorithm comparison studies.
#' 
#'
#' @examples
#' data('classification_results')
#'
#' mlpathology(data = classification_results,
#'            analysis_type = 'classification',
#'            actual_labels = actual,
#'            predicted_labels = predicted,
#'            predicted_probabilities = prob)
#'
#' @param data the data as a data frame
#' @param analysis_type Type of performance analysis to conduct
#' @param actual_labels True/actual classification labels
#' @param predicted_labels Predicted classification labels from model
#' @param predicted_probabilities Predicted probabilities for ROC analysis
#'   (binary classification)
#' @param reference_segmentation Reference/ground truth segmentation masks
#'   (binary)
#' @param predicted_segmentation Predicted segmentation masks from model
#'   (binary)
#' @param model1_predictions Predictions from first model for comparison
#' @param model2_predictions Predictions from second model for comparison
#' @param model1_probabilities Probabilities from first model for ROC
#'   comparison
#' @param model2_probabilities Probabilities from second model for ROC
#'   comparison
#' @param roc_analysis Perform ROC curve analysis for binary classification
#' @param roc_comparison Compare ROC curves between two models using DeLong's
#'   test
#' @param confidence_level Confidence level for performance metrics
#' @param confusion_matrix_plot Generate confusion matrix heatmap
#' @param roc_plot Generate ROC curve plot
#' @param bootstrap_validation Use bootstrap sampling for confidence intervals
#' @param bootstrap_runs Number of bootstrap replicates for validation
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$confusionmatrix} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$performancemetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$rocanalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$segmentationmetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelcomparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$roccomparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$confusionmatrixplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$rocplot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$confusionmatrix$asDF}
#'
#' \code{as.data.frame(results$confusionmatrix)}
#'
#' @export
mlpathology <- function(
    data,
    analysis_type = "classification",
    actual_labels,
    predicted_labels,
    predicted_probabilities,
    reference_segmentation,
    predicted_segmentation,
    model1_predictions,
    model2_predictions,
    model1_probabilities,
    model2_probabilities,
    roc_analysis = TRUE,
    roc_comparison = FALSE,
    confidence_level = 0.95,
    confusion_matrix_plot = TRUE,
    roc_plot = TRUE,
    bootstrap_validation = FALSE,
    bootstrap_runs = 1000) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("mlpathology requires jmvcore to be installed (restart may be required)")

    if ( ! missing(actual_labels)) actual_labels <- jmvcore::resolveQuo(jmvcore::enquo(actual_labels))
    if ( ! missing(predicted_labels)) predicted_labels <- jmvcore::resolveQuo(jmvcore::enquo(predicted_labels))
    if ( ! missing(predicted_probabilities)) predicted_probabilities <- jmvcore::resolveQuo(jmvcore::enquo(predicted_probabilities))
    if ( ! missing(reference_segmentation)) reference_segmentation <- jmvcore::resolveQuo(jmvcore::enquo(reference_segmentation))
    if ( ! missing(predicted_segmentation)) predicted_segmentation <- jmvcore::resolveQuo(jmvcore::enquo(predicted_segmentation))
    if ( ! missing(model1_predictions)) model1_predictions <- jmvcore::resolveQuo(jmvcore::enquo(model1_predictions))
    if ( ! missing(model2_predictions)) model2_predictions <- jmvcore::resolveQuo(jmvcore::enquo(model2_predictions))
    if ( ! missing(model1_probabilities)) model1_probabilities <- jmvcore::resolveQuo(jmvcore::enquo(model1_probabilities))
    if ( ! missing(model2_probabilities)) model2_probabilities <- jmvcore::resolveQuo(jmvcore::enquo(model2_probabilities))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(actual_labels), actual_labels, NULL),
            `if`( ! missing(predicted_labels), predicted_labels, NULL),
            `if`( ! missing(predicted_probabilities), predicted_probabilities, NULL),
            `if`( ! missing(reference_segmentation), reference_segmentation, NULL),
            `if`( ! missing(predicted_segmentation), predicted_segmentation, NULL),
            `if`( ! missing(model1_predictions), model1_predictions, NULL),
            `if`( ! missing(model2_predictions), model2_predictions, NULL),
            `if`( ! missing(model1_probabilities), model1_probabilities, NULL),
            `if`( ! missing(model2_probabilities), model2_probabilities, NULL))

    for (v in actual_labels) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in predicted_labels) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in model1_predictions) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in model2_predictions) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- mlpathologyOptions$new(
        analysis_type = analysis_type,
        actual_labels = actual_labels,
        predicted_labels = predicted_labels,
        predicted_probabilities = predicted_probabilities,
        reference_segmentation = reference_segmentation,
        predicted_segmentation = predicted_segmentation,
        model1_predictions = model1_predictions,
        model2_predictions = model2_predictions,
        model1_probabilities = model1_probabilities,
        model2_probabilities = model2_probabilities,
        roc_analysis = roc_analysis,
        roc_comparison = roc_comparison,
        confidence_level = confidence_level,
        confusion_matrix_plot = confusion_matrix_plot,
        roc_plot = roc_plot,
        bootstrap_validation = bootstrap_validation,
        bootstrap_runs = bootstrap_runs)

    analysis <- mlpathologyClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

