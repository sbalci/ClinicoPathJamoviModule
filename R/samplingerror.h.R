
# This file is automatically generated, you probably don't want to edit this

samplingerrorOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "samplingerrorOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            detectionSensitivity = 95,
            biologicalVarianceCV = 15,
            sampleSize = 10,
            eventFrequency = 5,
            referenceVolume = 100,
            sampleVolume = 10,
            calculationMode = "theoretical",
            sampleData = NULL,
            targetError = 10,
            showErrorComponents = TRUE,
            showOptimization = TRUE,
            showVisualization = TRUE,
            showMethodology = TRUE,
            showReferences = FALSE,
            confidenceLevel = 0.95, ...) {

            super$initialize(
                package="ClinicoPath",
                name="samplingerror",
                requiresData=TRUE,
                ...)

            private$..detectionSensitivity <- jmvcore::OptionNumber$new(
                "detectionSensitivity",
                detectionSensitivity,
                min=0,
                max=100,
                default=95)
            private$..biologicalVarianceCV <- jmvcore::OptionNumber$new(
                "biologicalVarianceCV",
                biologicalVarianceCV,
                min=0,
                max=100,
                default=15)
            private$..sampleSize <- jmvcore::OptionInteger$new(
                "sampleSize",
                sampleSize,
                min=1,
                max=1000,
                default=10)
            private$..eventFrequency <- jmvcore::OptionNumber$new(
                "eventFrequency",
                eventFrequency,
                min=0,
                max=100,
                default=5)
            private$..referenceVolume <- jmvcore::OptionNumber$new(
                "referenceVolume",
                referenceVolume,
                min=0.01,
                default=100)
            private$..sampleVolume <- jmvcore::OptionNumber$new(
                "sampleVolume",
                sampleVolume,
                min=0.01,
                default=10)
            private$..calculationMode <- jmvcore::OptionList$new(
                "calculationMode",
                calculationMode,
                options=list(
                    "theoretical",
                    "empirical"),
                default="theoretical")
            private$..sampleData <- jmvcore::OptionVariable$new(
                "sampleData",
                sampleData,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..targetError <- jmvcore::OptionNumber$new(
                "targetError",
                targetError,
                min=1,
                max=50,
                default=10)
            private$..showErrorComponents <- jmvcore::OptionBool$new(
                "showErrorComponents",
                showErrorComponents,
                default=TRUE)
            private$..showOptimization <- jmvcore::OptionBool$new(
                "showOptimization",
                showOptimization,
                default=TRUE)
            private$..showVisualization <- jmvcore::OptionBool$new(
                "showVisualization",
                showVisualization,
                default=TRUE)
            private$..showMethodology <- jmvcore::OptionBool$new(
                "showMethodology",
                showMethodology,
                default=TRUE)
            private$..showReferences <- jmvcore::OptionBool$new(
                "showReferences",
                showReferences,
                default=FALSE)
            private$..confidenceLevel <- jmvcore::OptionNumber$new(
                "confidenceLevel",
                confidenceLevel,
                min=0.8,
                max=0.99,
                default=0.95)

            self$.addOption(private$..detectionSensitivity)
            self$.addOption(private$..biologicalVarianceCV)
            self$.addOption(private$..sampleSize)
            self$.addOption(private$..eventFrequency)
            self$.addOption(private$..referenceVolume)
            self$.addOption(private$..sampleVolume)
            self$.addOption(private$..calculationMode)
            self$.addOption(private$..sampleData)
            self$.addOption(private$..targetError)
            self$.addOption(private$..showErrorComponents)
            self$.addOption(private$..showOptimization)
            self$.addOption(private$..showVisualization)
            self$.addOption(private$..showMethodology)
            self$.addOption(private$..showReferences)
            self$.addOption(private$..confidenceLevel)
        }),
    active = list(
        detectionSensitivity = function() private$..detectionSensitivity$value,
        biologicalVarianceCV = function() private$..biologicalVarianceCV$value,
        sampleSize = function() private$..sampleSize$value,
        eventFrequency = function() private$..eventFrequency$value,
        referenceVolume = function() private$..referenceVolume$value,
        sampleVolume = function() private$..sampleVolume$value,
        calculationMode = function() private$..calculationMode$value,
        sampleData = function() private$..sampleData$value,
        targetError = function() private$..targetError$value,
        showErrorComponents = function() private$..showErrorComponents$value,
        showOptimization = function() private$..showOptimization$value,
        showVisualization = function() private$..showVisualization$value,
        showMethodology = function() private$..showMethodology$value,
        showReferences = function() private$..showReferences$value,
        confidenceLevel = function() private$..confidenceLevel$value),
    private = list(
        ..detectionSensitivity = NA,
        ..biologicalVarianceCV = NA,
        ..sampleSize = NA,
        ..eventFrequency = NA,
        ..referenceVolume = NA,
        ..sampleVolume = NA,
        ..calculationMode = NA,
        ..sampleData = NA,
        ..targetError = NA,
        ..showErrorComponents = NA,
        ..showOptimization = NA,
        ..showVisualization = NA,
        ..showMethodology = NA,
        ..showReferences = NA,
        ..confidenceLevel = NA)
)

samplingerrorResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "samplingerrorResults",
    inherit = jmvcore::Group,
    active = list(
        errorSummary = function() private$.items[["errorSummary"]],
        errorComponents = function() private$.items[["errorComponents"]],
        optimization = function() private$.items[["optimization"]],
        plot = function() private$.items[["plot"]],
        methodology = function() private$.items[["methodology"]],
        references = function() private$.items[["references"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Sampling Error & Efficiency Calculator")
            self$add(jmvcore::Table$new(
                options=options,
                name="errorSummary",
                title="Total Sampling Error",
                rows=1,
                columns=list(
                    list(
                        `name`="total_error", 
                        `title`="E(p) Total Error (%)", 
                        `type`="number"),
                    list(
                        `name`="n_samples", 
                        `title`="Sample Size (N)", 
                        `type`="integer"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="errorComponents",
                title="Error Components Breakdown",
                visible="(showErrorComponents)",
                rows=3,
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="formula", 
                        `title`="Formula", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Error (%)", 
                        `type`="number"),
                    list(
                        `name`="contribution", 
                        `title`="Contribution", 
                        `type`="number"),
                    list(
                        `name`="description", 
                        `title`="Description", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="optimization",
                title="Sample Size Optimization",
                visible="(showOptimization)",
                rows=0,
                columns=list(
                    list(
                        `name`="target_error", 
                        `title`="Target Error (%)", 
                        `type`="number"),
                    list(
                        `name`="required_n", 
                        `title`="Required N", 
                        `type`="integer"),
                    list(
                        `name`="improvement", 
                        `title`="Improvement vs Current", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot",
                title="Sampling Error Analysis",
                visible="(showVisualization)",
                renderFun=".plot",
                requiresData=FALSE))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodology",
                title="Methodology & Interpretation",
                visible="(showMethodology)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="references",
                title="References",
                visible="(showReferences)"))}))

samplingerrorBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "samplingerrorBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "samplingerror",
                version = c(1,0,0),
                options = options,
                results = samplingerrorResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Sampling Error & Efficiency Calculator
#'
#' Practical tool for evaluating sampling adequacy and statistical power 
#' in clinicopathological research.
#' 
#' @details
#' Calculates sampling efficiency and error rates according to Kayser (2009).
#' 
#' @param data .
#' @param detectionSensitivity Probability of correctly detecting/identifying
#'   an event (e.g., tumor cell). 100\% means perfect detection, 95\% means 5\%
#'   false negative rate.
#' @param biologicalVarianceCV Coefficient of variation representing tissue
#'   heterogeneity. Low (5-10\%) = homogeneous tissue, Medium (15-25\%) =
#'   moderate heterogeneity, High (>30\%) = highly heterogeneous tissue.
#' @param sampleSize Number of samples/sections/areas examined.
#' @param eventFrequency Proportion of sample containing the event of interest
#'   (e.g., \% of tissue with tumor, \% positive cells).
#' @param referenceVolume Total reference space being sampled (e.g., organ
#'   volume, total tissue area).
#' @param sampleVolume Volume/area of each sample examined (same units as
#'   reference volume).
#' @param calculationMode Theoretical: Calculate error from theoretical
#'   parameters. Empirical: Estimate error components from actual data.
#' @param sampleData Actual measurements from samples (for empirical
#'   calculation).
#' @param targetError Desired maximum total sampling error. Used for sample
#'   size recommendations.
#' @param showErrorComponents Display breakdown of the three error components:
#'   E(Ne), E(B(n)), E(Ne/sv).
#' @param showOptimization Calculate optimal sample sizes for different target
#'   error rates.
#' @param showVisualization .
#' @param showMethodology .
#' @param showReferences .
#' @param confidenceLevel .
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$errorSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$errorComponents} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$optimization} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$methodology} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$references} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$errorSummary$asDF}
#'
#' \code{as.data.frame(results$errorSummary)}
#'
#' @export
samplingerror <- function(
    data,
    detectionSensitivity = 95,
    biologicalVarianceCV = 15,
    sampleSize = 10,
    eventFrequency = 5,
    referenceVolume = 100,
    sampleVolume = 10,
    calculationMode = "theoretical",
    sampleData = NULL,
    targetError = 10,
    showErrorComponents = TRUE,
    showOptimization = TRUE,
    showVisualization = TRUE,
    showMethodology = TRUE,
    showReferences = FALSE,
    confidenceLevel = 0.95) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("samplingerror requires jmvcore to be installed (restart may be required)")

    if ( ! missing(sampleData)) sampleData <- jmvcore::resolveQuo(jmvcore::enquo(sampleData))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(sampleData), sampleData, NULL))


    options <- samplingerrorOptions$new(
        detectionSensitivity = detectionSensitivity,
        biologicalVarianceCV = biologicalVarianceCV,
        sampleSize = sampleSize,
        eventFrequency = eventFrequency,
        referenceVolume = referenceVolume,
        sampleVolume = sampleVolume,
        calculationMode = calculationMode,
        sampleData = sampleData,
        targetError = targetError,
        showErrorComponents = showErrorComponents,
        showOptimization = showOptimization,
        showVisualization = showVisualization,
        showMethodology = showMethodology,
        showReferences = showReferences,
        confidenceLevel = confidenceLevel)

    analysis <- samplingerrorClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

