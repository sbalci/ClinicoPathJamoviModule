
# This file is automatically generated, you probably don't want to edit this

diagnosticperformanceOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "diagnosticperformanceOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            outcome = NULL,
            outcomeLevel = NULL,
            predictors = NULL,
            validationMethod = "none",
            cvFolds = 10,
            cvRepeats = 1,
            bootstrapN = 1000,
            holdoutProp = 0.3,
            comparisonMethod = "delong",
            optimalCutoff = "youden",
            costRatio = 1,
            confidenceLevel = 0.95,
            plotROC = TRUE,
            plotPR = FALSE,
            plotCalibration = FALSE,
            showMetrics = TRUE,
            showCutoffAnalysis = TRUE,
            stratifyBy = NULL, ...) {

            super$initialize(
                package="ClinicoPath",
                name="diagnosticperformance",
                requiresData=TRUE,
                ...)

            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..outcomeLevel <- jmvcore::OptionLevel$new(
                "outcomeLevel",
                outcomeLevel,
                variable="(outcome)")
            private$..predictors <- jmvcore::OptionVariables$new(
                "predictors",
                predictors,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..validationMethod <- jmvcore::OptionList$new(
                "validationMethod",
                validationMethod,
                options=list(
                    "none",
                    "crossval",
                    "bootstrap",
                    "holdout"),
                default="none")
            private$..cvFolds <- jmvcore::OptionInteger$new(
                "cvFolds",
                cvFolds,
                default=10,
                min=2,
                max=20)
            private$..cvRepeats <- jmvcore::OptionInteger$new(
                "cvRepeats",
                cvRepeats,
                default=1,
                min=1,
                max=10)
            private$..bootstrapN <- jmvcore::OptionInteger$new(
                "bootstrapN",
                bootstrapN,
                default=1000,
                min=100,
                max=5000)
            private$..holdoutProp <- jmvcore::OptionNumber$new(
                "holdoutProp",
                holdoutProp,
                default=0.3,
                min=0.1,
                max=0.5)
            private$..comparisonMethod <- jmvcore::OptionList$new(
                "comparisonMethod",
                comparisonMethod,
                options=list(
                    "delong",
                    "bootstrap",
                    "venkatraman"),
                default="delong")
            private$..optimalCutoff <- jmvcore::OptionList$new(
                "optimalCutoff",
                optimalCutoff,
                options=list(
                    "youden",
                    "closest_topleft",
                    "equal_sens_spec",
                    "cost_weighted"),
                default="youden")
            private$..costRatio <- jmvcore::OptionNumber$new(
                "costRatio",
                costRatio,
                default=1,
                min=0.1,
                max=10)
            private$..confidenceLevel <- jmvcore::OptionNumber$new(
                "confidenceLevel",
                confidenceLevel,
                default=0.95,
                min=0.8,
                max=0.99)
            private$..plotROC <- jmvcore::OptionBool$new(
                "plotROC",
                plotROC,
                default=TRUE)
            private$..plotPR <- jmvcore::OptionBool$new(
                "plotPR",
                plotPR,
                default=FALSE)
            private$..plotCalibration <- jmvcore::OptionBool$new(
                "plotCalibration",
                plotCalibration,
                default=FALSE)
            private$..showMetrics <- jmvcore::OptionBool$new(
                "showMetrics",
                showMetrics,
                default=TRUE)
            private$..showCutoffAnalysis <- jmvcore::OptionBool$new(
                "showCutoffAnalysis",
                showCutoffAnalysis,
                default=TRUE)
            private$..stratifyBy <- jmvcore::OptionVariable$new(
                "stratifyBy",
                stratifyBy,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))

            self$.addOption(private$..outcome)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..predictors)
            self$.addOption(private$..validationMethod)
            self$.addOption(private$..cvFolds)
            self$.addOption(private$..cvRepeats)
            self$.addOption(private$..bootstrapN)
            self$.addOption(private$..holdoutProp)
            self$.addOption(private$..comparisonMethod)
            self$.addOption(private$..optimalCutoff)
            self$.addOption(private$..costRatio)
            self$.addOption(private$..confidenceLevel)
            self$.addOption(private$..plotROC)
            self$.addOption(private$..plotPR)
            self$.addOption(private$..plotCalibration)
            self$.addOption(private$..showMetrics)
            self$.addOption(private$..showCutoffAnalysis)
            self$.addOption(private$..stratifyBy)
        }),
    active = list(
        outcome = function() private$..outcome$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        predictors = function() private$..predictors$value,
        validationMethod = function() private$..validationMethod$value,
        cvFolds = function() private$..cvFolds$value,
        cvRepeats = function() private$..cvRepeats$value,
        bootstrapN = function() private$..bootstrapN$value,
        holdoutProp = function() private$..holdoutProp$value,
        comparisonMethod = function() private$..comparisonMethod$value,
        optimalCutoff = function() private$..optimalCutoff$value,
        costRatio = function() private$..costRatio$value,
        confidenceLevel = function() private$..confidenceLevel$value,
        plotROC = function() private$..plotROC$value,
        plotPR = function() private$..plotPR$value,
        plotCalibration = function() private$..plotCalibration$value,
        showMetrics = function() private$..showMetrics$value,
        showCutoffAnalysis = function() private$..showCutoffAnalysis$value,
        stratifyBy = function() private$..stratifyBy$value),
    private = list(
        ..outcome = NA,
        ..outcomeLevel = NA,
        ..predictors = NA,
        ..validationMethod = NA,
        ..cvFolds = NA,
        ..cvRepeats = NA,
        ..bootstrapN = NA,
        ..holdoutProp = NA,
        ..comparisonMethod = NA,
        ..optimalCutoff = NA,
        ..costRatio = NA,
        ..confidenceLevel = NA,
        ..plotROC = NA,
        ..plotPR = NA,
        ..plotCalibration = NA,
        ..showMetrics = NA,
        ..showCutoffAnalysis = NA,
        ..stratifyBy = NA)
)

diagnosticperformanceResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "diagnosticperformanceResults",
    inherit = jmvcore::Group,
    active = list(
        text = function() private$.items[["text"]],
        performanceTable = function() private$.items[["performanceTable"]],
        cutoffTable = function() private$.items[["cutoffTable"]],
        comparisonTable = function() private$.items[["comparisonTable"]],
        validationTable = function() private$.items[["validationTable"]],
        rocPlot = function() private$.items[["rocPlot"]],
        prPlot = function() private$.items[["prPlot"]],
        calibrationPlot = function() private$.items[["calibrationPlot"]],
        stratifiedResults = function() private$.items[["stratifiedResults"]],
        interpretation = function() private$.items[["interpretation"]],
        recommendations = function() private$.items[["recommendations"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Diagnostic Performance Analysis")
            self$add(jmvcore::Html$new(
                options=options,
                name="text",
                title="Diagnostic Performance Analysis Results"))
            self$add(jmvcore::Table$new(
                options=options,
                name="performanceTable",
                title="Diagnostic Performance Metrics",
                visible="(showMetrics)",
                rows=0,
                columns=list(
                    list(
                        `name`="predictor", 
                        `title`="Predictor", 
                        `type`="text"),
                    list(
                        `name`="auc", 
                        `title`="AUC", 
                        `type`="number"),
                    list(
                        `name`="auc_ci_lower", 
                        `title`="AUC 95% CI Lower", 
                        `type`="number"),
                    list(
                        `name`="auc_ci_upper", 
                        `title`="AUC 95% CI Upper", 
                        `type`="number"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity", 
                        `type`="number"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity", 
                        `type`="number"),
                    list(
                        `name`="ppv", 
                        `title`="PPV", 
                        `type`="number"),
                    list(
                        `name`="npv", 
                        `title`="NPV", 
                        `type`="number"),
                    list(
                        `name`="accuracy", 
                        `title`="Accuracy", 
                        `type`="number"),
                    list(
                        `name`="f1_score", 
                        `title`="F1 Score", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="cutoffTable",
                title="Optimal Cutoff Analysis",
                visible="(showCutoffAnalysis)",
                rows=0,
                columns=list(
                    list(
                        `name`="predictor", 
                        `title`="Predictor", 
                        `type`="text"),
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"),
                    list(
                        `name`="cutoff", 
                        `title`="Optimal Cutoff", 
                        `type`="number"),
                    list(
                        `name`="sensitivity", 
                        `title`="Sensitivity", 
                        `type`="number"),
                    list(
                        `name`="specificity", 
                        `title`="Specificity", 
                        `type`="number"),
                    list(
                        `name`="youden_index", 
                        `title`="Youden Index", 
                        `type`="number"),
                    list(
                        `name`="lr_positive", 
                        `title`="LR+", 
                        `type`="number"),
                    list(
                        `name`="lr_negative", 
                        `title`="LR-", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="comparisonTable",
                title="ROC Curve Comparison",
                rows=0,
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"),
                    list(
                        `name`="test_statistic", 
                        `title`="Test Statistic", 
                        `type`="number"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number"),
                    list(
                        `name`="significance", 
                        `title`="Significance", 
                        `type`="text"),
                    list(
                        `name`="auc_diff", 
                        `title`="AUC Difference", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="validationTable",
                title="Cross-Validation Results",
                visible="(validationMethod:crossval || validationMethod:bootstrap)",
                rows=0,
                columns=list(
                    list(
                        `name`="predictor", 
                        `title`="Predictor", 
                        `type`="text"),
                    list(
                        `name`="method", 
                        `title`="Validation Method", 
                        `type`="text"),
                    list(
                        `name`="mean_auc", 
                        `title`="Mean AUC", 
                        `type`="number"),
                    list(
                        `name`="sd_auc", 
                        `title`="SD AUC", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number"),
                    list(
                        `name`="optimism", 
                        `title`="Optimism", 
                        `type`="number"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="rocPlot",
                title="ROC Curves",
                width=600,
                height=450,
                renderFun=".plotROC",
                visible="(plotROC)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="prPlot",
                title="Precision-Recall Curves",
                width=600,
                height=450,
                renderFun=".plotPR",
                visible="(plotPR)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="calibrationPlot",
                title="Calibration Plot",
                width=600,
                height=450,
                renderFun=".plotCalibration",
                visible="(plotCalibration)"))
            self$add(jmvcore::Table$new(
                options=options,
                name="stratifiedResults",
                title="Stratified Analysis Results",
                visible="(stratifyBy)",
                rows=0,
                columns=list(
                    list(
                        `name`="stratum", 
                        `title`="Stratum", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="auc", 
                        `title`="AUC", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Clinical Interpretation"))
            self$add(jmvcore::Html$new(
                options=options,
                name="recommendations",
                title="Recommendations"))}))

diagnosticperformanceBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "diagnosticperformanceBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "diagnosticperformance",
                version = c(1,0,0),
                options = options,
                results = diagnosticperformanceResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Diagnostic Performance Analysis
#'
#' Comprehensive diagnostic performance analysis including ROC curves, 
#' cross-validation,
#' and statistical comparison of diagnostic tests. Supports both single and 
#' multiple
#' biomarker evaluation with robust validation methods.
#' 
#'
#' @examples
#' # Single biomarker diagnostic performance
#' diagnosticperformance(
#'     data = dataset,
#'     outcome = "disease_status",
#'     predictors = "biomarker_level",
#'     validation_method = "crossval",
#'     cv_folds = 10
#' )
#'
#' # Multiple biomarker comparison
#' diagnosticperformance(
#'     data = dataset,
#'     outcome = "disease_status",
#'     predictors = c("marker1", "marker2", "marker3"),
#'     comparison_method = "delong",
#'     validation_method = "bootstrap",
#'     bootstrap_n = 1000
#' )
#'
#' @param data .
#' @param outcome Binary outcome variable indicating disease/condition status
#'   (0/1 or factor).
#' @param outcomeLevel Level of outcome variable representing positive cases
#'   (events).
#' @param predictors Continuous predictor variables (biomarkers, risk scores)
#'   to evaluate.
#' @param validationMethod Method for validating diagnostic performance to
#'   avoid overfitting.
#' @param cvFolds Number of folds for cross-validation (typically 5 or 10).
#' @param cvRepeats Number of times to repeat cross-validation for more stable
#'   results.
#' @param bootstrapN Number of bootstrap samples for bootstrap validation and
#'   confidence intervals.
#' @param holdoutProp Proportion of data to hold out for validation (0.1 to
#'   0.5).
#' @param comparisonMethod Statistical method for comparing multiple ROC
#'   curves.
#' @param optimalCutoff Method for determining optimal diagnostic cutoff
#'   point.
#' @param costRatio Ratio of cost of false positive to false negative (for
#'   cost-weighted cutoff).
#' @param confidenceLevel Confidence level for confidence intervals (0.80 to
#'   0.99).
#' @param plotROC .
#' @param plotPR Generate precision-recall curves (useful for imbalanced
#'   datasets).
#' @param plotCalibration Generate calibration plots to assess prediction
#'   calibration.
#' @param showMetrics Show comprehensive diagnostic performance metrics table.
#' @param showCutoffAnalysis Show optimal cutoff analysis with
#'   sensitivity/specificity trade-offs.
#' @param stratifyBy Optional variable for stratified analysis (subgroup
#'   analysis).
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$text} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$performanceTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$cutoffTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$comparisonTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$validationTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$rocPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$prPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$calibrationPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$stratifiedResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$recommendations} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$performanceTable$asDF}
#'
#' \code{as.data.frame(results$performanceTable)}
#'
#' @export
diagnosticperformance <- function(
    data,
    outcome,
    outcomeLevel,
    predictors,
    validationMethod = "none",
    cvFolds = 10,
    cvRepeats = 1,
    bootstrapN = 1000,
    holdoutProp = 0.3,
    comparisonMethod = "delong",
    optimalCutoff = "youden",
    costRatio = 1,
    confidenceLevel = 0.95,
    plotROC = TRUE,
    plotPR = FALSE,
    plotCalibration = FALSE,
    showMetrics = TRUE,
    showCutoffAnalysis = TRUE,
    stratifyBy) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("diagnosticperformance requires jmvcore to be installed (restart may be required)")

    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(predictors)) predictors <- jmvcore::resolveQuo(jmvcore::enquo(predictors))
    if ( ! missing(stratifyBy)) stratifyBy <- jmvcore::resolveQuo(jmvcore::enquo(stratifyBy))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(predictors), predictors, NULL),
            `if`( ! missing(stratifyBy), stratifyBy, NULL))

    for (v in stratifyBy) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- diagnosticperformanceOptions$new(
        outcome = outcome,
        outcomeLevel = outcomeLevel,
        predictors = predictors,
        validationMethod = validationMethod,
        cvFolds = cvFolds,
        cvRepeats = cvRepeats,
        bootstrapN = bootstrapN,
        holdoutProp = holdoutProp,
        comparisonMethod = comparisonMethod,
        optimalCutoff = optimalCutoff,
        costRatio = costRatio,
        confidenceLevel = confidenceLevel,
        plotROC = plotROC,
        plotPR = plotPR,
        plotCalibration = plotCalibration,
        showMetrics = showMetrics,
        showCutoffAnalysis = showCutoffAnalysis,
        stratifyBy = stratifyBy)

    analysis <- diagnosticperformanceClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

