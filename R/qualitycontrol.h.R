
# This file is automatically generated, you probably don't want to edit this

qualitycontrolOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "qualitycontrolOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            measurement_var = NULL,
            time_var = NULL,
            control_level = NULL,
            batch_var = NULL,
            analysis_type = "control_charts",
            control_chart_type = "all_charts",
            target_value = NULL,
            target_sd = NULL,
            control_limits_method = "classical",
            custom_lower_limit = NULL,
            custom_upper_limit = NULL,
            cusum_target = NULL,
            cusum_k_value = 0.5,
            cusum_h_value = 5,
            ewma_lambda = 0.2,
            sigma_calculation = "total_error",
            allowable_error = 10,
            reference_method = "nonparametric",
            reference_percentile = "95",
            outlier_detection = "tukey",
            pt_target_value = NULL,
            pt_acceptable_range = NULL,
            validation_components = "comprehensive",
            precision_design = "ep5_a3",
            replicate_days = 20,
            replicates_per_day = 2,
            confidence_level = 0.95,
            westgard_rules = TRUE,
            trend_analysis = TRUE,
            capability_analysis = FALSE,
            generate_plots = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="qualitycontrol",
                requiresData=TRUE,
                ...)

            private$..measurement_var <- jmvcore::OptionVariable$new(
                "measurement_var",
                measurement_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..time_var <- jmvcore::OptionVariable$new(
                "time_var",
                time_var,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..control_level <- jmvcore::OptionVariable$new(
                "control_level",
                control_level,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..batch_var <- jmvcore::OptionVariable$new(
                "batch_var",
                batch_var,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..analysis_type <- jmvcore::OptionList$new(
                "analysis_type",
                analysis_type,
                options=list(
                    "control_charts",
                    "sigma_metrics",
                    "method_validation",
                    "reference_intervals",
                    "proficiency_testing"),
                default="control_charts")
            private$..control_chart_type <- jmvcore::OptionList$new(
                "control_chart_type",
                control_chart_type,
                options=list(
                    "shewhart",
                    "cusum",
                    "ewma",
                    "all_charts"),
                default="all_charts")
            private$..target_value <- jmvcore::OptionNumber$new(
                "target_value",
                target_value)
            private$..target_sd <- jmvcore::OptionNumber$new(
                "target_sd",
                target_sd,
                min=0)
            private$..control_limits_method <- jmvcore::OptionList$new(
                "control_limits_method",
                control_limits_method,
                options=list(
                    "classical",
                    "probability",
                    "robust",
                    "custom"),
                default="classical")
            private$..custom_lower_limit <- jmvcore::OptionNumber$new(
                "custom_lower_limit",
                custom_lower_limit)
            private$..custom_upper_limit <- jmvcore::OptionNumber$new(
                "custom_upper_limit",
                custom_upper_limit)
            private$..cusum_target <- jmvcore::OptionNumber$new(
                "cusum_target",
                cusum_target)
            private$..cusum_k_value <- jmvcore::OptionNumber$new(
                "cusum_k_value",
                cusum_k_value,
                min=0,
                default=0.5)
            private$..cusum_h_value <- jmvcore::OptionNumber$new(
                "cusum_h_value",
                cusum_h_value,
                min=0,
                default=5)
            private$..ewma_lambda <- jmvcore::OptionNumber$new(
                "ewma_lambda",
                ewma_lambda,
                min=0.01,
                max=1,
                default=0.2)
            private$..sigma_calculation <- jmvcore::OptionList$new(
                "sigma_calculation",
                sigma_calculation,
                options=list(
                    "total_error",
                    "bias_imprecision",
                    "westgard_rules"),
                default="total_error")
            private$..allowable_error <- jmvcore::OptionNumber$new(
                "allowable_error",
                allowable_error,
                min=0,
                default=10)
            private$..reference_method <- jmvcore::OptionList$new(
                "reference_method",
                reference_method,
                options=list(
                    "parametric",
                    "nonparametric",
                    "robust",
                    "horn_method"),
                default="nonparametric")
            private$..reference_percentile <- jmvcore::OptionList$new(
                "reference_percentile",
                reference_percentile,
                options=list(
                    "95",
                    "90",
                    "99"),
                default="95")
            private$..outlier_detection <- jmvcore::OptionList$new(
                "outlier_detection",
                outlier_detection,
                options=list(
                    "none",
                    "dixon",
                    "tukey",
                    "chauvenet"),
                default="tukey")
            private$..pt_target_value <- jmvcore::OptionNumber$new(
                "pt_target_value",
                pt_target_value)
            private$..pt_acceptable_range <- jmvcore::OptionNumber$new(
                "pt_acceptable_range",
                pt_acceptable_range,
                min=0)
            private$..validation_components <- jmvcore::OptionList$new(
                "validation_components",
                validation_components,
                options=list(
                    "precision",
                    "accuracy",
                    "linearity",
                    "comprehensive"),
                default="comprehensive")
            private$..precision_design <- jmvcore::OptionList$new(
                "precision_design",
                precision_design,
                options=list(
                    "ep5_a3",
                    "ep15_a3",
                    "nested_anova"),
                default="ep5_a3")
            private$..replicate_days <- jmvcore::OptionInteger$new(
                "replicate_days",
                replicate_days,
                min=5,
                max=30,
                default=20)
            private$..replicates_per_day <- jmvcore::OptionInteger$new(
                "replicates_per_day",
                replicates_per_day,
                min=2,
                max=10,
                default=2)
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                min=0.8,
                max=0.99,
                default=0.95)
            private$..westgard_rules <- jmvcore::OptionBool$new(
                "westgard_rules",
                westgard_rules,
                default=TRUE)
            private$..trend_analysis <- jmvcore::OptionBool$new(
                "trend_analysis",
                trend_analysis,
                default=TRUE)
            private$..capability_analysis <- jmvcore::OptionBool$new(
                "capability_analysis",
                capability_analysis,
                default=FALSE)
            private$..generate_plots <- jmvcore::OptionBool$new(
                "generate_plots",
                generate_plots,
                default=TRUE)

            self$.addOption(private$..measurement_var)
            self$.addOption(private$..time_var)
            self$.addOption(private$..control_level)
            self$.addOption(private$..batch_var)
            self$.addOption(private$..analysis_type)
            self$.addOption(private$..control_chart_type)
            self$.addOption(private$..target_value)
            self$.addOption(private$..target_sd)
            self$.addOption(private$..control_limits_method)
            self$.addOption(private$..custom_lower_limit)
            self$.addOption(private$..custom_upper_limit)
            self$.addOption(private$..cusum_target)
            self$.addOption(private$..cusum_k_value)
            self$.addOption(private$..cusum_h_value)
            self$.addOption(private$..ewma_lambda)
            self$.addOption(private$..sigma_calculation)
            self$.addOption(private$..allowable_error)
            self$.addOption(private$..reference_method)
            self$.addOption(private$..reference_percentile)
            self$.addOption(private$..outlier_detection)
            self$.addOption(private$..pt_target_value)
            self$.addOption(private$..pt_acceptable_range)
            self$.addOption(private$..validation_components)
            self$.addOption(private$..precision_design)
            self$.addOption(private$..replicate_days)
            self$.addOption(private$..replicates_per_day)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..westgard_rules)
            self$.addOption(private$..trend_analysis)
            self$.addOption(private$..capability_analysis)
            self$.addOption(private$..generate_plots)
        }),
    active = list(
        measurement_var = function() private$..measurement_var$value,
        time_var = function() private$..time_var$value,
        control_level = function() private$..control_level$value,
        batch_var = function() private$..batch_var$value,
        analysis_type = function() private$..analysis_type$value,
        control_chart_type = function() private$..control_chart_type$value,
        target_value = function() private$..target_value$value,
        target_sd = function() private$..target_sd$value,
        control_limits_method = function() private$..control_limits_method$value,
        custom_lower_limit = function() private$..custom_lower_limit$value,
        custom_upper_limit = function() private$..custom_upper_limit$value,
        cusum_target = function() private$..cusum_target$value,
        cusum_k_value = function() private$..cusum_k_value$value,
        cusum_h_value = function() private$..cusum_h_value$value,
        ewma_lambda = function() private$..ewma_lambda$value,
        sigma_calculation = function() private$..sigma_calculation$value,
        allowable_error = function() private$..allowable_error$value,
        reference_method = function() private$..reference_method$value,
        reference_percentile = function() private$..reference_percentile$value,
        outlier_detection = function() private$..outlier_detection$value,
        pt_target_value = function() private$..pt_target_value$value,
        pt_acceptable_range = function() private$..pt_acceptable_range$value,
        validation_components = function() private$..validation_components$value,
        precision_design = function() private$..precision_design$value,
        replicate_days = function() private$..replicate_days$value,
        replicates_per_day = function() private$..replicates_per_day$value,
        confidence_level = function() private$..confidence_level$value,
        westgard_rules = function() private$..westgard_rules$value,
        trend_analysis = function() private$..trend_analysis$value,
        capability_analysis = function() private$..capability_analysis$value,
        generate_plots = function() private$..generate_plots$value),
    private = list(
        ..measurement_var = NA,
        ..time_var = NA,
        ..control_level = NA,
        ..batch_var = NA,
        ..analysis_type = NA,
        ..control_chart_type = NA,
        ..target_value = NA,
        ..target_sd = NA,
        ..control_limits_method = NA,
        ..custom_lower_limit = NA,
        ..custom_upper_limit = NA,
        ..cusum_target = NA,
        ..cusum_k_value = NA,
        ..cusum_h_value = NA,
        ..ewma_lambda = NA,
        ..sigma_calculation = NA,
        ..allowable_error = NA,
        ..reference_method = NA,
        ..reference_percentile = NA,
        ..outlier_detection = NA,
        ..pt_target_value = NA,
        ..pt_acceptable_range = NA,
        ..validation_components = NA,
        ..precision_design = NA,
        ..replicate_days = NA,
        ..replicates_per_day = NA,
        ..confidence_level = NA,
        ..westgard_rules = NA,
        ..trend_analysis = NA,
        ..capability_analysis = NA,
        ..generate_plots = NA)
)

qualitycontrolResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "qualitycontrolResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        descriptiveStats = function() private$.items[["descriptiveStats"]],
        controlChartsResults = function() private$.items[["controlChartsResults"]],
        sigmaMetrics = function() private$.items[["sigmaMetrics"]],
        methodValidation = function() private$.items[["methodValidation"]],
        precisionComponents = function() private$.items[["precisionComponents"]],
        referenceIntervals = function() private$.items[["referenceIntervals"]],
        proficiencyTesting = function() private$.items[["proficiencyTesting"]],
        westgardRules = function() private$.items[["westgardRules"]],
        trendAnalysis = function() private$.items[["trendAnalysis"]],
        capabilityAnalysis = function() private$.items[["capabilityAnalysis"]],
        outlierAnalysis = function() private$.items[["outlierAnalysis"]],
        qualityGoals = function() private$.items[["qualityGoals"]],
        controlChart = function() private$.items[["controlChart"]],
        sigmaMetricsPlot = function() private$.items[["sigmaMetricsPlot"]],
        methodValidationPlot = function() private$.items[["methodValidationPlot"]],
        referenceIntervalsPlot = function() private$.items[["referenceIntervalsPlot"]],
        trendPlot = function() private$.items[["trendPlot"]],
        methodExplanation = function() private$.items[["methodExplanation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Laboratory Quality Control Statistics",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "Kendall"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Analysis Instructions",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="descriptiveStats",
                title="Descriptive Statistics",
                visible=TRUE,
                rows=1,
                clearWith=list(
                    "measurement_var",
                    "control_level"),
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="controlChartsResults",
                title="Control Chart Analysis",
                visible="(analysis_type:control_charts)",
                rows=1,
                clearWith=list(
                    "measurement_var",
                    "control_chart_type",
                    "control_limits_method"),
                columns=list(
                    list(
                        `name`="chart_type", 
                        `title`="Chart Type", 
                        `type`="text"),
                    list(
                        `name`="center_line", 
                        `title`="Center Line", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="lower_control_limit", 
                        `title`="LCL", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="upper_control_limit", 
                        `title`="UCL", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="out_of_control_points", 
                        `title`="Out of Control", 
                        `type`="integer"),
                    list(
                        `name`="performance", 
                        `title`="Performance", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="sigmaMetrics",
                title="Laboratory Sigma Metrics",
                visible="(analysis_type:sigma_metrics)",
                rows=1,
                clearWith=list(
                    "measurement_var",
                    "sigma_calculation",
                    "allowable_error"),
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Component", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="sigma_level", 
                        `title`="Sigma Level", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="quality_rating", 
                        `title`="Quality Rating", 
                        `type`="text"),
                    list(
                        `name`="recommendation", 
                        `title`="Recommendation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="methodValidation",
                title="Method Validation Results",
                visible="(analysis_type:method_validation)",
                rows=1,
                clearWith=list(
                    "measurement_var",
                    "validation_components",
                    "precision_design"),
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Validation Parameter", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="confidence_interval", 
                        `title`="Confidence Interval", 
                        `type`="text"),
                    list(
                        `name`="specification_limit", 
                        `title`="Specification", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="meets_criteria", 
                        `title`="Meets Criteria", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="precisionComponents",
                title="Precision Study Components",
                visible="(validation_components:precision || validation_components:comprehensive)",
                rows=1,
                clearWith=list(
                    "measurement_var",
                    "precision_design",
                    "replicate_days"),
                columns=list(
                    list(
                        `name`="component", 
                        `title`="Precision Component", 
                        `type`="text"),
                    list(
                        `name`="variance", 
                        `title`="Variance", 
                        `type`="number", 
                        `format`="zto:6"),
                    list(
                        `name`="standard_deviation", 
                        `title`="Standard Deviation", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="coefficient_variation", 
                        `title`="CV (%)", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="degrees_freedom", 
                        `title`="df", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="referenceIntervals",
                title="Reference Interval Establishment",
                visible="(analysis_type:reference_intervals)",
                rows=1,
                clearWith=list(
                    "measurement_var",
                    "reference_method",
                    "reference_percentile"),
                columns=list(
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"),
                    list(
                        `name`="sample_size", 
                        `title`="n", 
                        `type`="integer"),
                    list(
                        `name`="lower_limit", 
                        `title`="Lower Limit", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="upper_limit", 
                        `title`="Upper Limit", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="confidence_interval", 
                        `title`="CI for Limits", 
                        `type`="text"),
                    list(
                        `name`="validity", 
                        `title`="Validity Assessment", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="proficiencyTesting",
                title="Proficiency Testing Analysis",
                visible="(analysis_type:proficiency_testing)",
                rows=1,
                clearWith=list(
                    "measurement_var",
                    "pt_target_value",
                    "pt_acceptable_range"),
                columns=list(
                    list(
                        `name`="statistic", 
                        `title`="PT Statistic", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="z_score", 
                        `title`="Z-Score", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="performance_flag", 
                        `title`="Performance", 
                        `type`="text"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="westgardRules",
                title="Westgard Multi-Rule Analysis",
                visible="(westgard_rules)",
                rows=1,
                clearWith=list(
                    "westgard_rules",
                    "measurement_var"),
                columns=list(
                    list(
                        `name`="rule", 
                        `title`="Westgard Rule", 
                        `type`="text"),
                    list(
                        `name`="description", 
                        `title`="Description", 
                        `type`="text"),
                    list(
                        `name`="violations", 
                        `title`="Violations", 
                        `type`="integer"),
                    list(
                        `name`="action_required", 
                        `title`="Action Required", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="trendAnalysis",
                title="Statistical Trend Analysis",
                visible="(trend_analysis)",
                rows=1,
                clearWith=list(
                    "trend_analysis",
                    "measurement_var",
                    "time_var"),
                columns=list(
                    list(
                        `name`="test", 
                        `title`="Trend Test", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Test Statistic", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="trend_direction", 
                        `title`="Trend Direction", 
                        `type`="text"),
                    list(
                        `name`="significance", 
                        `title`="Significance", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="capabilityAnalysis",
                title="Process Capability Analysis",
                visible="(capability_analysis)",
                rows=1,
                clearWith=list(
                    "capability_analysis",
                    "measurement_var",
                    "target_value"),
                columns=list(
                    list(
                        `name`="index", 
                        `title`="Capability Index", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="confidence_interval", 
                        `title`="Confidence Interval", 
                        `type`="text"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="outlierAnalysis",
                title="Outlier Detection Results",
                visible="(outlier_detection != 'none')",
                rows=1,
                clearWith=list(
                    "outlier_detection",
                    "measurement_var"),
                columns=list(
                    list(
                        `name`="observation", 
                        `title`="Observation", 
                        `type`="integer"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="test_statistic", 
                        `title`="Test Statistic", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="p_value", 
                        `title`="p-value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="outlier_flag", 
                        `title`="Outlier", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="qualityGoals",
                title="Analytical Quality Goals Assessment",
                visible=TRUE,
                rows=1,
                clearWith=list(
                    "measurement_var",
                    "allowable_error"),
                columns=list(
                    list(
                        `name`="goal_type", 
                        `title`="Quality Goal", 
                        `type`="text"),
                    list(
                        `name`="specification", 
                        `title`="Specification", 
                        `type`="text"),
                    list(
                        `name`="current_performance", 
                        `title`="Current Performance", 
                        `type`="text"),
                    list(
                        `name`="meets_goal", 
                        `title`="Meets Goal", 
                        `type`="text"),
                    list(
                        `name`="improvement_needed", 
                        `title`="Improvement Needed", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="controlChart",
                title="Control Chart",
                visible="(generate_plots && analysis_type:control_charts)",
                requiresData=TRUE,
                width=800,
                height=600,
                renderFun=".plotControlChart",
                clearWith=list(
                    "measurement_var",
                    "control_chart_type",
                    "time_var")))
            self$add(jmvcore::Image$new(
                options=options,
                name="sigmaMetricsPlot",
                title="Sigma Metrics Visualization",
                visible="(generate_plots && analysis_type:sigma_metrics)",
                requiresData=TRUE,
                width=700,
                height=500,
                renderFun=".plotSigmaMetrics",
                clearWith=list(
                    "measurement_var",
                    "sigma_calculation")))
            self$add(jmvcore::Image$new(
                options=options,
                name="methodValidationPlot",
                title="Method Validation Plot",
                visible="(generate_plots && analysis_type:method_validation)",
                requiresData=TRUE,
                width=800,
                height=600,
                renderFun=".plotMethodValidation",
                clearWith=list(
                    "measurement_var",
                    "validation_components")))
            self$add(jmvcore::Image$new(
                options=options,
                name="referenceIntervalsPlot",
                title="Reference Interval Plot",
                visible="(generate_plots && analysis_type:reference_intervals)",
                requiresData=TRUE,
                width=700,
                height=500,
                renderFun=".plotReferenceIntervals",
                clearWith=list(
                    "measurement_var",
                    "reference_method")))
            self$add(jmvcore::Image$new(
                options=options,
                name="trendPlot",
                title="Trend Analysis Plot",
                visible="(generate_plots && trend_analysis)",
                requiresData=TRUE,
                width=800,
                height=500,
                renderFun=".plotTrendAnalysis",
                clearWith=list(
                    "measurement_var",
                    "time_var",
                    "trend_analysis")))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodExplanation",
                title="Method and Interpretation Guide",
                visible=TRUE))}))

qualitycontrolBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "qualitycontrolBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "qualitycontrol",
                version = c(1,0,0),
                options = options,
                results = qualitycontrolResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Laboratory Quality Control Statistics
#'
#' Comprehensive laboratory quality control statistics including control 
#' charts (Shewhart, CUSUM, EWMA),  sigma metrics, method validation 
#' protocols, and reference interval establishment for clinical laboratory 
#' management.
#' 
#'
#' @examples
#' data \%>\%
#' qualitycontrol(
#'     measurement_var = "measurement",
#'     analysis_type = "control_charts",
#'     control_chart_type = "all_charts"
#' )
#'
#' @param data the data as a data frame
#' @param measurement_var Continuous variable containing laboratory
#'   measurement values for quality control analysis
#' @param time_var Optional time variable for temporal control chart analysis
#'   (sequence number, date, time)
#' @param control_level Optional variable indicating control material level
#'   (e.g., Level 1, Level 2, Normal, Pathological)
#' @param batch_var Optional batch or lot identifier for batch-to-batch
#'   variation analysis
#' @param analysis_type Primary type of quality control analysis to perform
#' @param control_chart_type Type of control chart to generate for quality
#'   control monitoring
#' @param target_value Target value for control charts and sigma metrics (if
#'   known)
#' @param target_sd Target standard deviation for sigma metrics (if known)
#' @param control_limits_method Method for calculating control chart limits
#' @param custom_lower_limit Custom lower control limit (when using custom
#'   limits method)
#' @param custom_upper_limit Custom upper control limit (when using custom
#'   limits method)
#' @param cusum_target Target value for CUSUM chart (defaults to sample mean)
#' @param cusum_k_value CUSUM slack parameter k (typically 0.5 * sigma)
#' @param cusum_h_value CUSUM decision interval h (typically 4-5 * sigma)
#' @param ewma_lambda EWMA smoothing parameter lambda (0 < λ ≤ 1)
#' @param sigma_calculation Method for calculating laboratory sigma metrics
#' @param allowable_error Total allowable error percentage for sigma metrics
#'   calculation
#' @param reference_method Statistical method for establishing reference
#'   intervals
#' @param reference_percentile Percentile range for reference interval
#'   calculation
#' @param outlier_detection Method for detecting and handling outliers in
#'   reference interval estimation
#' @param pt_target_value Target value for proficiency testing analysis
#' @param pt_acceptable_range Acceptable range for proficiency testing (±\% or
#'   ± absolute units)
#' @param validation_components Components of analytical method validation to
#'   assess
#' @param precision_design Design for precision assessment following
#'   laboratory standards
#' @param replicate_days Number of days for precision study (CLSI EP5-A3
#'   recommends ≥20 days)
#' @param replicates_per_day Number of replicates per day for precision study
#' @param confidence_level Confidence level for statistical calculations and
#'   intervals
#' @param westgard_rules Apply Westgard multi-rule quality control decision
#'   criteria
#' @param trend_analysis Perform statistical trend analysis for systematic
#'   changes
#' @param capability_analysis Calculate process capability indices (Cp, Cpk,
#'   Pp, Ppk)
#' @param generate_plots Generate comprehensive quality control visualization
#'   plots
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$descriptiveStats} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$controlChartsResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$sigmaMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$methodValidation} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$precisionComponents} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$referenceIntervals} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$proficiencyTesting} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$westgardRules} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$trendAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$capabilityAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$outlierAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$qualityGoals} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$controlChart} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$sigmaMetricsPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$methodValidationPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$referenceIntervalsPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$trendPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$methodExplanation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$descriptiveStats$asDF}
#'
#' \code{as.data.frame(results$descriptiveStats)}
#'
#' @export
qualitycontrol <- function(
    data,
    measurement_var,
    time_var,
    control_level,
    batch_var,
    analysis_type = "control_charts",
    control_chart_type = "all_charts",
    target_value,
    target_sd,
    control_limits_method = "classical",
    custom_lower_limit,
    custom_upper_limit,
    cusum_target,
    cusum_k_value = 0.5,
    cusum_h_value = 5,
    ewma_lambda = 0.2,
    sigma_calculation = "total_error",
    allowable_error = 10,
    reference_method = "nonparametric",
    reference_percentile = "95",
    outlier_detection = "tukey",
    pt_target_value,
    pt_acceptable_range,
    validation_components = "comprehensive",
    precision_design = "ep5_a3",
    replicate_days = 20,
    replicates_per_day = 2,
    confidence_level = 0.95,
    westgard_rules = TRUE,
    trend_analysis = TRUE,
    capability_analysis = FALSE,
    generate_plots = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("qualitycontrol requires jmvcore to be installed (restart may be required)")

    if ( ! missing(measurement_var)) measurement_var <- jmvcore::resolveQuo(jmvcore::enquo(measurement_var))
    if ( ! missing(time_var)) time_var <- jmvcore::resolveQuo(jmvcore::enquo(time_var))
    if ( ! missing(control_level)) control_level <- jmvcore::resolveQuo(jmvcore::enquo(control_level))
    if ( ! missing(batch_var)) batch_var <- jmvcore::resolveQuo(jmvcore::enquo(batch_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(measurement_var), measurement_var, NULL),
            `if`( ! missing(time_var), time_var, NULL),
            `if`( ! missing(control_level), control_level, NULL),
            `if`( ! missing(batch_var), batch_var, NULL))

    for (v in control_level) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in batch_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- qualitycontrolOptions$new(
        measurement_var = measurement_var,
        time_var = time_var,
        control_level = control_level,
        batch_var = batch_var,
        analysis_type = analysis_type,
        control_chart_type = control_chart_type,
        target_value = target_value,
        target_sd = target_sd,
        control_limits_method = control_limits_method,
        custom_lower_limit = custom_lower_limit,
        custom_upper_limit = custom_upper_limit,
        cusum_target = cusum_target,
        cusum_k_value = cusum_k_value,
        cusum_h_value = cusum_h_value,
        ewma_lambda = ewma_lambda,
        sigma_calculation = sigma_calculation,
        allowable_error = allowable_error,
        reference_method = reference_method,
        reference_percentile = reference_percentile,
        outlier_detection = outlier_detection,
        pt_target_value = pt_target_value,
        pt_acceptable_range = pt_acceptable_range,
        validation_components = validation_components,
        precision_design = precision_design,
        replicate_days = replicate_days,
        replicates_per_day = replicates_per_day,
        confidence_level = confidence_level,
        westgard_rules = westgard_rules,
        trend_analysis = trend_analysis,
        capability_analysis = capability_analysis,
        generate_plots = generate_plots)

    analysis <- qualitycontrolClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

