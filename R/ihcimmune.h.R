
# This file is automatically generated, you probably don't want to edit this

ihcimmuneOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcimmuneOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            immune_markers = NULL,
            checkpoint_markers = NULL,
            id = NULL,
            tilAnalysis = TRUE,
            tilMethod = "comprehensive",
            immuneContexture = TRUE,
            spatialAnalysis = FALSE,
            x_coordinate = NULL,
            y_coordinate = NULL,
            tumorRegion = NULL,
            hotspotAnalysis = FALSE,
            diversityMetrics = TRUE,
            checkpointScore = FALSE,
            pd1Cutoff = 1,
            pdl1Cutoff = 1, ...) {

            super$initialize(
                package="ClinicoPath",
                name="ihcimmune",
                requiresData=TRUE,
                ...)

            private$..immune_markers <- jmvcore::OptionVariables$new(
                "immune_markers",
                immune_markers,
                suggested=list(
                    "ordinal",
                    "nominal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..checkpoint_markers <- jmvcore::OptionVariables$new(
                "checkpoint_markers",
                checkpoint_markers,
                suggested=list(
                    "ordinal",
                    "nominal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..id <- jmvcore::OptionVariable$new(
                "id",
                id,
                suggested=list(
                    "nominal",
                    "id"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..tilAnalysis <- jmvcore::OptionBool$new(
                "tilAnalysis",
                tilAnalysis,
                default=TRUE)
            private$..tilMethod <- jmvcore::OptionList$new(
                "tilMethod",
                tilMethod,
                options=list(
                    "sterlacci",
                    "cd4cd8_ratio",
                    "granzyme_focus",
                    "comprehensive"),
                default="comprehensive")
            private$..immuneContexture <- jmvcore::OptionBool$new(
                "immuneContexture",
                immuneContexture,
                default=TRUE)
            private$..spatialAnalysis <- jmvcore::OptionBool$new(
                "spatialAnalysis",
                spatialAnalysis,
                default=FALSE)
            private$..x_coordinate <- jmvcore::OptionVariable$new(
                "x_coordinate",
                x_coordinate,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..y_coordinate <- jmvcore::OptionVariable$new(
                "y_coordinate",
                y_coordinate,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..tumorRegion <- jmvcore::OptionVariable$new(
                "tumorRegion",
                tumorRegion,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..hotspotAnalysis <- jmvcore::OptionBool$new(
                "hotspotAnalysis",
                hotspotAnalysis,
                default=FALSE)
            private$..diversityMetrics <- jmvcore::OptionBool$new(
                "diversityMetrics",
                diversityMetrics,
                default=TRUE)
            private$..checkpointScore <- jmvcore::OptionBool$new(
                "checkpointScore",
                checkpointScore,
                default=FALSE)
            private$..pd1Cutoff <- jmvcore::OptionNumber$new(
                "pd1Cutoff",
                pd1Cutoff,
                min=0,
                max=100,
                default=1)
            private$..pdl1Cutoff <- jmvcore::OptionNumber$new(
                "pdl1Cutoff",
                pdl1Cutoff,
                min=0,
                max=100,
                default=1)

            self$.addOption(private$..immune_markers)
            self$.addOption(private$..checkpoint_markers)
            self$.addOption(private$..id)
            self$.addOption(private$..tilAnalysis)
            self$.addOption(private$..tilMethod)
            self$.addOption(private$..immuneContexture)
            self$.addOption(private$..spatialAnalysis)
            self$.addOption(private$..x_coordinate)
            self$.addOption(private$..y_coordinate)
            self$.addOption(private$..tumorRegion)
            self$.addOption(private$..hotspotAnalysis)
            self$.addOption(private$..diversityMetrics)
            self$.addOption(private$..checkpointScore)
            self$.addOption(private$..pd1Cutoff)
            self$.addOption(private$..pdl1Cutoff)
        }),
    active = list(
        immune_markers = function() private$..immune_markers$value,
        checkpoint_markers = function() private$..checkpoint_markers$value,
        id = function() private$..id$value,
        tilAnalysis = function() private$..tilAnalysis$value,
        tilMethod = function() private$..tilMethod$value,
        immuneContexture = function() private$..immuneContexture$value,
        spatialAnalysis = function() private$..spatialAnalysis$value,
        x_coordinate = function() private$..x_coordinate$value,
        y_coordinate = function() private$..y_coordinate$value,
        tumorRegion = function() private$..tumorRegion$value,
        hotspotAnalysis = function() private$..hotspotAnalysis$value,
        diversityMetrics = function() private$..diversityMetrics$value,
        checkpointScore = function() private$..checkpointScore$value,
        pd1Cutoff = function() private$..pd1Cutoff$value,
        pdl1Cutoff = function() private$..pdl1Cutoff$value),
    private = list(
        ..immune_markers = NA,
        ..checkpoint_markers = NA,
        ..id = NA,
        ..tilAnalysis = NA,
        ..tilMethod = NA,
        ..immuneContexture = NA,
        ..spatialAnalysis = NA,
        ..x_coordinate = NA,
        ..y_coordinate = NA,
        ..tumorRegion = NA,
        ..hotspotAnalysis = NA,
        ..diversityMetrics = NA,
        ..checkpointScore = NA,
        ..pd1Cutoff = NA,
        ..pdl1Cutoff = NA)
)

ihcimmuneResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcimmuneResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        tilSummary = function() private$.items[["tilSummary"]],
        immuneProfile = function() private$.items[["immuneProfile"]],
        checkpointAnalysis = function() private$.items[["checkpointAnalysis"]],
        immuneContexture = function() private$.items[["immuneContexture"]],
        spatialMetrics = function() private$.items[["spatialMetrics"]],
        hotspotAnalysis = function() private$.items[["hotspotAnalysis"]],
        diversityResults = function() private$.items[["diversityResults"]],
        tilMethodResults = function() private$.items[["tilMethodResults"]],
        immunePlot = function() private$.items[["immunePlot"]],
        tilPlot = function() private$.items[["tilPlot"]],
        contextureHeatmap = function() private$.items[["contextureHeatmap"]],
        spatialPlot = function() private$.items[["spatialPlot"]],
        checkpointPlot = function() private$.items[["checkpointPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="IHC Immune Analysis",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="TIL Analysis Overview",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="tilSummary",
                title="TIL Analysis Summary",
                visible="(tilAnalysis)",
                clearWith=list(
                    "immune_markers",
                    "tilMethod"),
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="category", 
                        `title`="Category", 
                        `type`="text"),
                    list(
                        `name`="interpretation", 
                        `title`="Clinical Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="immuneProfile",
                title="Immune Cell Profile",
                visible="(immune_markers)",
                clearWith=list(
                    "immune_markers"),
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Immune Marker", 
                        `type`="text"),
                    list(
                        `name`="mean_expression", 
                        `title`="Mean Expression", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="median_expression", 
                        `title`="Median Expression", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="positive_cases", 
                        `title`="Positive Cases (%)", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="density_category", 
                        `title`="Density Category", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="checkpointAnalysis",
                title="Checkpoint Inhibitor Analysis",
                visible="(checkpoint_markers && checkpointScore)",
                clearWith=list(
                    "checkpoint_markers",
                    "pd1Cutoff",
                    "pdl1Cutoff"),
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Checkpoint Marker", 
                        `type`="text"),
                    list(
                        `name`="positive_rate", 
                        `title`="Positivity Rate (%)", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="composite_score", 
                        `title`="Composite Score", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="predicted_response", 
                        `title`="Predicted Response", 
                        `type`="text"),
                    list(
                        `name`="confidence", 
                        `title`="Confidence Level", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="immuneContexture",
                title="Immune Contexture Classification",
                visible="(immuneContexture)",
                clearWith=list(
                    "immune_markers"),
                columns=list(
                    list(
                        `name`="case_id", 
                        `title`="Case ID", 
                        `type`="text"),
                    list(
                        `name`="contexture_score", 
                        `title`="Contexture Score", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="immune_classification", 
                        `title`="Immune Class", 
                        `type`="text"),
                    list(
                        `name`="cd8_score", 
                        `title`="CD8+ Score", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="cd45ro_score", 
                        `title`="CD45RO+ Score", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="prognosis_prediction", 
                        `title`="Prognostic Category", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="spatialMetrics",
                title="Spatial Distribution Analysis",
                visible="(spatialAnalysis)",
                clearWith=list(
                    "immune_markers",
                    "x_coordinate",
                    "y_coordinate"),
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="moran_i", 
                        `title`="Moran's I", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="clustering_index", 
                        `title`="Clustering Index", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="nearest_neighbor_distance", 
                        `title`="Mean NN Distance", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="spatial_pattern", 
                        `title`="Spatial Pattern", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="hotspotAnalysis",
                title="Immune Hotspot Analysis",
                visible="(hotspotAnalysis)",
                clearWith=list(
                    "immune_markers"),
                columns=list(
                    list(
                        `name`="region_id", 
                        `title`="Region ID", 
                        `type`="integer"),
                    list(
                        `name`="hotspot_type", 
                        `title`="Hotspot Type", 
                        `type`="text"),
                    list(
                        `name`="immune_density", 
                        `title`="Immune Density", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="dominant_population", 
                        `title`="Dominant Population", 
                        `type`="text"),
                    list(
                        `name`="diversity_index", 
                        `title`="Diversity Index", 
                        `type`="number", 
                        `format`="zto:3"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="diversityResults",
                title="Immune Diversity Metrics",
                visible="(diversityMetrics)",
                clearWith=list(
                    "immune_markers"),
                columns=list(
                    list(
                        `name`="case_id", 
                        `title`="Case ID", 
                        `type`="text"),
                    list(
                        `name`="shannon_diversity", 
                        `title`="Shannon Index", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="simpson_diversity", 
                        `title`="Simpson Index", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="evenness", 
                        `title`="Evenness", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="richness", 
                        `title`="Species Richness", 
                        `type`="integer"),
                    list(
                        `name`="diversity_category", 
                        `title`="Diversity Category", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="tilMethodResults",
                title="TIL Method-Specific Results",
                visible="(tilAnalysis)",
                clearWith=list(
                    "immune_markers",
                    "tilMethod"),
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto:2"),
                    list(
                        `name`="reference_range", 
                        `title`="Reference Range", 
                        `type`="text"),
                    list(
                        `name`="clinical_significance", 
                        `title`="Clinical Significance", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="immunePlot",
                title="Immune Cell Distribution",
                visible="(immune_markers)",
                renderFun=".plotImmuneDistribution",
                clearWith=list(
                    "immune_markers"),
                width=800,
                height=600))
            self$add(jmvcore::Image$new(
                options=options,
                name="tilPlot",
                title="TIL Analysis Visualization",
                visible="(tilAnalysis)",
                renderFun=".plotTILAnalysis",
                clearWith=list(
                    "immune_markers",
                    "tilMethod"),
                width=700,
                height=500))
            self$add(jmvcore::Image$new(
                options=options,
                name="contextureHeatmap",
                title="Immune Contexture Heatmap",
                visible="(immuneContexture)",
                renderFun=".plotContextureHeatmap",
                clearWith=list(
                    "immune_markers"),
                width=900,
                height=600))
            self$add(jmvcore::Image$new(
                options=options,
                name="spatialPlot",
                title="Spatial Distribution Map",
                visible="(spatialAnalysis)",
                renderFun=".plotSpatialDistribution",
                clearWith=list(
                    "immune_markers",
                    "x_coordinate",
                    "y_coordinate"),
                width=800,
                height=800))
            self$add(jmvcore::Image$new(
                options=options,
                name="checkpointPlot",
                title="Checkpoint Inhibitor Score Plot",
                visible="(checkpointScore)",
                renderFun=".plotCheckpointScore",
                clearWith=list(
                    "checkpoint_markers",
                    "pd1Cutoff",
                    "pdl1Cutoff"),
                width=700,
                height=500))}))

ihcimmuneBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcimmuneBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "ihcimmune",
                version = c(1,0,0),
                options = options,
                results = ihcimmuneResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' IHC Immune Analysis
#'
#' Tumor-infiltrating lymphocyte (TIL) analysis and immune microenvironment 
#' characterization using IHC markers. Specialized for immuno-oncology 
#' applications.
#' 
#'
#' @examples
#' data \%>\%
#' ihcimmune(
#'     immune_markers = c("CD3", "CD4", "CD8", "CD20"),
#'     tilAnalysis = TRUE,
#'     immuneContexture = TRUE
#' )
#'
#' @param data the data as a data frame
#' @param immune_markers Immune cell markers (CD3, CD4, CD8, CD20, etc.)
#' @param checkpoint_markers Immune checkpoint markers (PD-1, PD-L1, CTLA-4,
#'   etc.)
#' @param id Case identifier for tracking
#' @param tilAnalysis Perform specialized tumor-infiltrating lymphocyte
#'   analysis
#' @param tilMethod Method for TIL analysis and interpretation
#' @param immuneContexture Calculate immune contexture score and
#'   classification
#' @param spatialAnalysis Analyze spatial distribution of immune cells
#'   (requires coordinate data)
#' @param x_coordinate X spatial coordinates for proximity analysis
#' @param y_coordinate Y spatial coordinates for proximity analysis
#' @param tumorRegion Tumor region classification (center, invasive margin,
#'   stroma)
#' @param hotspotAnalysis Identify immune cell hotspots and cold regions
#' @param diversityMetrics Calculate Shannon and Simpson diversity indices for
#'   immune populations
#' @param checkpointScore Calculate composite score for checkpoint inhibitor
#'   therapy prediction
#' @param pd1Cutoff Threshold for PD-1 positivity assessment
#' @param pdl1Cutoff Threshold for PD-L1 positivity assessment
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$tilSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$immuneProfile} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$checkpointAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$immuneContexture} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$spatialMetrics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$hotspotAnalysis} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$diversityResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$tilMethodResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$immunePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$tilPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$contextureHeatmap} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$spatialPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$checkpointPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$tilSummary$asDF}
#'
#' \code{as.data.frame(results$tilSummary)}
#'
#' @export
ihcimmune <- function(
    data,
    immune_markers,
    checkpoint_markers,
    id = NULL,
    tilAnalysis = TRUE,
    tilMethod = "comprehensive",
    immuneContexture = TRUE,
    spatialAnalysis = FALSE,
    x_coordinate,
    y_coordinate,
    tumorRegion,
    hotspotAnalysis = FALSE,
    diversityMetrics = TRUE,
    checkpointScore = FALSE,
    pd1Cutoff = 1,
    pdl1Cutoff = 1) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("ihcimmune requires jmvcore to be installed (restart may be required)")

    if ( ! missing(immune_markers)) immune_markers <- jmvcore::resolveQuo(jmvcore::enquo(immune_markers))
    if ( ! missing(checkpoint_markers)) checkpoint_markers <- jmvcore::resolveQuo(jmvcore::enquo(checkpoint_markers))
    if ( ! missing(id)) id <- jmvcore::resolveQuo(jmvcore::enquo(id))
    if ( ! missing(x_coordinate)) x_coordinate <- jmvcore::resolveQuo(jmvcore::enquo(x_coordinate))
    if ( ! missing(y_coordinate)) y_coordinate <- jmvcore::resolveQuo(jmvcore::enquo(y_coordinate))
    if ( ! missing(tumorRegion)) tumorRegion <- jmvcore::resolveQuo(jmvcore::enquo(tumorRegion))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(immune_markers), immune_markers, NULL),
            `if`( ! missing(checkpoint_markers), checkpoint_markers, NULL),
            `if`( ! missing(id), id, NULL),
            `if`( ! missing(x_coordinate), x_coordinate, NULL),
            `if`( ! missing(y_coordinate), y_coordinate, NULL),
            `if`( ! missing(tumorRegion), tumorRegion, NULL))

    for (v in tumorRegion) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- ihcimmuneOptions$new(
        immune_markers = immune_markers,
        checkpoint_markers = checkpoint_markers,
        id = id,
        tilAnalysis = tilAnalysis,
        tilMethod = tilMethod,
        immuneContexture = immuneContexture,
        spatialAnalysis = spatialAnalysis,
        x_coordinate = x_coordinate,
        y_coordinate = y_coordinate,
        tumorRegion = tumorRegion,
        hotspotAnalysis = hotspotAnalysis,
        diversityMetrics = diversityMetrics,
        checkpointScore = checkpointScore,
        pd1Cutoff = pd1Cutoff,
        pdl1Cutoff = pdl1Cutoff)

    analysis <- ihcimmuneClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

