
# This file is automatically generated, you probably don't want to edit this

treemedicalOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "treemedicalOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            vars = NULL,
            facs = NULL,
            target = NULL,
            targetLevel = NULL,
            validation = "cv",
            cv_folds = 5,
            bootstrap_samples = 100,
            stratified_sampling = TRUE,
            holdout_split = 0.75,
            handle_missing = "remove",
            max_depth = 5,
            min_samples_split = 20,
            cost_complexity = 0.01,
            use_1se_rule = TRUE,
            clinical_context = "diagnosis",
            cost_sensitive = FALSE,
            fn_fp_ratio = 2,
            show_tree_plot = TRUE,
            show_performance_metrics = TRUE,
            show_confusion_matrix = TRUE,
            show_importance_plot = TRUE,
            show_clinical_interpretation = TRUE,
            set_seed = TRUE,
            seed_value = 42, ...) {

            super$initialize(
                package="ClinicoPath",
                name="treemedical",
                requiresData=TRUE,
                ...)

            private$..vars <- jmvcore::OptionVariables$new(
                "vars",
                vars,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"),
                default=NULL)
            private$..facs <- jmvcore::OptionVariables$new(
                "facs",
                facs,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"),
                default=NULL)
            private$..target <- jmvcore::OptionVariable$new(
                "target",
                target,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..targetLevel <- jmvcore::OptionLevel$new(
                "targetLevel",
                targetLevel,
                variable="(target)")
            private$..validation <- jmvcore::OptionList$new(
                "validation",
                validation,
                options=list(
                    "cv",
                    "holdout",
                    "bootstrap"),
                default="cv")
            private$..cv_folds <- jmvcore::OptionInteger$new(
                "cv_folds",
                cv_folds,
                default=5,
                min=3,
                max=10)
            private$..bootstrap_samples <- jmvcore::OptionInteger$new(
                "bootstrap_samples",
                bootstrap_samples,
                default=100,
                min=50,
                max=500)
            private$..stratified_sampling <- jmvcore::OptionBool$new(
                "stratified_sampling",
                stratified_sampling,
                default=TRUE)
            private$..holdout_split <- jmvcore::OptionNumber$new(
                "holdout_split",
                holdout_split,
                default=0.75,
                min=0.5,
                max=0.9)
            private$..handle_missing <- jmvcore::OptionList$new(
                "handle_missing",
                handle_missing,
                options=list(
                    "remove",
                    "impute"),
                default="remove")
            private$..max_depth <- jmvcore::OptionInteger$new(
                "max_depth",
                max_depth,
                default=5,
                min=2,
                max=10)
            private$..min_samples_split <- jmvcore::OptionInteger$new(
                "min_samples_split",
                min_samples_split,
                default=20,
                min=5,
                max=100)
            private$..cost_complexity <- jmvcore::OptionNumber$new(
                "cost_complexity",
                cost_complexity,
                default=0.01,
                min=0.001,
                max=0.1)
            private$..use_1se_rule <- jmvcore::OptionBool$new(
                "use_1se_rule",
                use_1se_rule,
                default=TRUE)
            private$..clinical_context <- jmvcore::OptionList$new(
                "clinical_context",
                clinical_context,
                options=list(
                    "diagnosis",
                    "screening",
                    "treatment",
                    "risk"),
                default="diagnosis")
            private$..cost_sensitive <- jmvcore::OptionBool$new(
                "cost_sensitive",
                cost_sensitive,
                default=FALSE)
            private$..fn_fp_ratio <- jmvcore::OptionNumber$new(
                "fn_fp_ratio",
                fn_fp_ratio,
                default=2,
                min=0.5,
                max=10)
            private$..show_tree_plot <- jmvcore::OptionBool$new(
                "show_tree_plot",
                show_tree_plot,
                default=TRUE)
            private$..show_performance_metrics <- jmvcore::OptionBool$new(
                "show_performance_metrics",
                show_performance_metrics,
                default=TRUE)
            private$..show_confusion_matrix <- jmvcore::OptionBool$new(
                "show_confusion_matrix",
                show_confusion_matrix,
                default=TRUE)
            private$..show_importance_plot <- jmvcore::OptionBool$new(
                "show_importance_plot",
                show_importance_plot,
                default=TRUE)
            private$..show_clinical_interpretation <- jmvcore::OptionBool$new(
                "show_clinical_interpretation",
                show_clinical_interpretation,
                default=TRUE)
            private$..set_seed <- jmvcore::OptionBool$new(
                "set_seed",
                set_seed,
                default=TRUE)
            private$..seed_value <- jmvcore::OptionInteger$new(
                "seed_value",
                seed_value,
                default=42,
                min=1,
                max=999999)

            self$.addOption(private$..vars)
            self$.addOption(private$..facs)
            self$.addOption(private$..target)
            self$.addOption(private$..targetLevel)
            self$.addOption(private$..validation)
            self$.addOption(private$..cv_folds)
            self$.addOption(private$..bootstrap_samples)
            self$.addOption(private$..stratified_sampling)
            self$.addOption(private$..holdout_split)
            self$.addOption(private$..handle_missing)
            self$.addOption(private$..max_depth)
            self$.addOption(private$..min_samples_split)
            self$.addOption(private$..cost_complexity)
            self$.addOption(private$..use_1se_rule)
            self$.addOption(private$..clinical_context)
            self$.addOption(private$..cost_sensitive)
            self$.addOption(private$..fn_fp_ratio)
            self$.addOption(private$..show_tree_plot)
            self$.addOption(private$..show_performance_metrics)
            self$.addOption(private$..show_confusion_matrix)
            self$.addOption(private$..show_importance_plot)
            self$.addOption(private$..show_clinical_interpretation)
            self$.addOption(private$..set_seed)
            self$.addOption(private$..seed_value)
        }),
    active = list(
        vars = function() private$..vars$value,
        facs = function() private$..facs$value,
        target = function() private$..target$value,
        targetLevel = function() private$..targetLevel$value,
        validation = function() private$..validation$value,
        cv_folds = function() private$..cv_folds$value,
        bootstrap_samples = function() private$..bootstrap_samples$value,
        stratified_sampling = function() private$..stratified_sampling$value,
        holdout_split = function() private$..holdout_split$value,
        handle_missing = function() private$..handle_missing$value,
        max_depth = function() private$..max_depth$value,
        min_samples_split = function() private$..min_samples_split$value,
        cost_complexity = function() private$..cost_complexity$value,
        use_1se_rule = function() private$..use_1se_rule$value,
        clinical_context = function() private$..clinical_context$value,
        cost_sensitive = function() private$..cost_sensitive$value,
        fn_fp_ratio = function() private$..fn_fp_ratio$value,
        show_tree_plot = function() private$..show_tree_plot$value,
        show_performance_metrics = function() private$..show_performance_metrics$value,
        show_confusion_matrix = function() private$..show_confusion_matrix$value,
        show_importance_plot = function() private$..show_importance_plot$value,
        show_clinical_interpretation = function() private$..show_clinical_interpretation$value,
        set_seed = function() private$..set_seed$value,
        seed_value = function() private$..seed_value$value),
    private = list(
        ..vars = NA,
        ..facs = NA,
        ..target = NA,
        ..targetLevel = NA,
        ..validation = NA,
        ..cv_folds = NA,
        ..bootstrap_samples = NA,
        ..stratified_sampling = NA,
        ..holdout_split = NA,
        ..handle_missing = NA,
        ..max_depth = NA,
        ..min_samples_split = NA,
        ..cost_complexity = NA,
        ..use_1se_rule = NA,
        ..clinical_context = NA,
        ..cost_sensitive = NA,
        ..fn_fp_ratio = NA,
        ..show_tree_plot = NA,
        ..show_performance_metrics = NA,
        ..show_confusion_matrix = NA,
        ..show_importance_plot = NA,
        ..show_clinical_interpretation = NA,
        ..set_seed = NA,
        ..seed_value = NA)
)

treemedicalResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "treemedicalResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        model_summary = function() private$.items[["model_summary"]],
        performance_table = function() private$.items[["performance_table"]],
        confusion_matrix = function() private$.items[["confusion_matrix"]],
        variable_importance = function() private$.items[["variable_importance"]],
        tree_plot = function() private$.items[["tree_plot"]],
        importance_plot = function() private$.items[["importance_plot"]],
        clinical_interpretation = function() private$.items[["clinical_interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Medical Decision Trees",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "rpart",
                    "rpart.plot",
                    "caret",
                    "pROC",
                    "ggplot2"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=FALSE))
            self$add(jmvcore::Html$new(
                options=options,
                name="model_summary",
                title="Model Summary",
                visible="(show_performance_metrics)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "validation",
                    "holdout_split",
                    "handle_missing",
                    "bootstrap_samples",
                    "max_depth",
                    "cost_complexity",
                    "cost_sensitive")))
            self$add(jmvcore::Table$new(
                options=options,
                name="performance_table",
                title="Performance Metrics",
                visible="(show_performance_metrics)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "validation",
                    "holdout_split",
                    "handle_missing",
                    "cost_sensitive",
                    "fn_fp_ratio",
                    "bootstrap_samples",
                    "cv_folds"),
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="95% CI Lower", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="95% CI Upper", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="confusion_matrix",
                title="Confusion Matrix",
                visible="(show_confusion_matrix)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "validation",
                    "holdout_split",
                    "handle_missing",
                    "cost_sensitive",
                    "bootstrap_samples",
                    "cv_folds"),
                columns=list(
                    list(
                        `name`="actual", 
                        `title`="Actual", 
                        `type`="text"),
                    list(
                        `name`="predicted_negative", 
                        `title`="Predicted Negative", 
                        `type`="integer"),
                    list(
                        `name`="predicted_positive", 
                        `title`="Predicted Positive", 
                        `type`="integer"),
                    list(
                        `name`="total", 
                        `title`="Total", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="variable_importance",
                title="Variable Importance",
                visible="(show_importance_plot)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "handle_missing",
                    "cost_sensitive"),
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="importance", 
                        `title`="Importance", 
                        `type`="number"),
                    list(
                        `name`="rank", 
                        `title`="Rank", 
                        `type`="integer"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="tree_plot",
                title="Decision Tree",
                width=800,
                height=600,
                renderFun=".tree_plot",
                visible="(show_tree_plot)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "max_depth",
                    "cost_complexity",
                    "handle_missing",
                    "cost_sensitive",
                    "use_1se_rule")))
            self$add(jmvcore::Image$new(
                options=options,
                name="importance_plot",
                title="Variable Importance Plot",
                width=600,
                height=400,
                renderFun=".importance_plot",
                visible="(show_importance_plot)",
                clearWith=list(
                    "vars",
                    "facs",
                    "target",
                    "targetLevel",
                    "handle_missing",
                    "cost_sensitive")))
            self$add(jmvcore::Html$new(
                options=options,
                name="clinical_interpretation",
                title="Clinical Interpretation",
                visible="(show_clinical_interpretation)",
                clearWith=list(
                    "clinical_context",
                    "target",
                    "targetLevel")))}))

treemedicalBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "treemedicalBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "treemedical",
                version = c(0,0,31),
                options = options,
                results = treemedicalResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Medical Decision Trees
#'
#' Simple decision tree analysis for medical research and clinical decision 
#' making.
#' Uses enhanced CART algorithm optimized for healthcare applications with
#' clinical validation, performance metrics, and medical interpretation 
#' guidelines.
#' 
#'
#' @examples
#' # Example for cancer diagnosis
#' data(cancer_data)
#' treemedical(
#'     data = cancer_data,
#'     vars = c("PSA", "age"),
#'     facs = c("grade", "stage"),
#'     target = "diagnosis",
#'     targetLevel = "cancer",
#'     validation = "cv",
#'     show_tree_plot = TRUE
#' )
#'
#' @param data The data as a data frame containing clinical variables and
#'   outcomes.
#' @param vars Continuous variables such as biomarker levels, age,  laboratory
#'   values, or quantitative measurements.
#' @param facs Categorical variables such as tumor grade, stage,  histological
#'   type, or patient demographics.
#' @param target Primary outcome variable: disease status, treatment response,
#'   or diagnostic category.
#' @param targetLevel Level representing disease presence or positive outcome.
#' @param validation Validation approach for assessing model performance.
#' @param cv_folds Number of folds for cross-validation.
#' @param bootstrap_samples Number of bootstrap samples for bootstrap
#'   validation.
#' @param stratified_sampling Maintain class proportions in train/test splits.
#' @param holdout_split Proportion of data for training in holdout validation
#'   (rest for testing).
#' @param handle_missing How to handle missing values in predictor variables.
#' @param max_depth Maximum depth of decision tree. Clinical trees typically
#'   3-6 levels.
#' @param min_samples_split Minimum number of samples required to split a
#'   node.
#' @param cost_complexity Controls tree pruning - lower values create more
#'   complex trees.
#' @param use_1se_rule Select simplest tree within 1 SE of optimal
#'   performance.
#' @param clinical_context Clinical application context affects interpretation
#'   guidelines.
#' @param cost_sensitive Consider different costs of false positives vs false
#'   negatives.
#' @param fn_fp_ratio Relative cost of missing positive case vs false alarm.
#' @param show_tree_plot Display visual representation of the decision tree.
#' @param show_performance_metrics Display accuracy, sensitivity, specificity,
#'   AUC, and clinical metrics.
#' @param show_confusion_matrix Display confusion matrix with clinical
#'   interpretations.
#' @param show_importance_plot Display ranking of most important clinical
#'   variables.
#' @param show_clinical_interpretation Display clinical interpretation and
#'   usage guidelines.
#' @param set_seed Set random seed for reproducible results.
#' @param seed_value Seed value for random number generation.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$model_summary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$performance_table} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$confusion_matrix} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$variable_importance} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$tree_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$importance_plot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$clinical_interpretation} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$performance_table$asDF}
#'
#' \code{as.data.frame(results$performance_table)}
#'
#' @export
treemedical <- function(
    data,
    vars = NULL,
    facs = NULL,
    target,
    targetLevel,
    validation = "cv",
    cv_folds = 5,
    bootstrap_samples = 100,
    stratified_sampling = TRUE,
    holdout_split = 0.75,
    handle_missing = "remove",
    max_depth = 5,
    min_samples_split = 20,
    cost_complexity = 0.01,
    use_1se_rule = TRUE,
    clinical_context = "diagnosis",
    cost_sensitive = FALSE,
    fn_fp_ratio = 2,
    show_tree_plot = TRUE,
    show_performance_metrics = TRUE,
    show_confusion_matrix = TRUE,
    show_importance_plot = TRUE,
    show_clinical_interpretation = TRUE,
    set_seed = TRUE,
    seed_value = 42) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("treemedical requires jmvcore to be installed (restart may be required)")

    if ( ! missing(vars)) vars <- jmvcore::resolveQuo(jmvcore::enquo(vars))
    if ( ! missing(facs)) facs <- jmvcore::resolveQuo(jmvcore::enquo(facs))
    if ( ! missing(target)) target <- jmvcore::resolveQuo(jmvcore::enquo(target))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(vars), vars, NULL),
            `if`( ! missing(facs), facs, NULL),
            `if`( ! missing(target), target, NULL))

    for (v in facs) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in target) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- treemedicalOptions$new(
        vars = vars,
        facs = facs,
        target = target,
        targetLevel = targetLevel,
        validation = validation,
        cv_folds = cv_folds,
        bootstrap_samples = bootstrap_samples,
        stratified_sampling = stratified_sampling,
        holdout_split = holdout_split,
        handle_missing = handle_missing,
        max_depth = max_depth,
        min_samples_split = min_samples_split,
        cost_complexity = cost_complexity,
        use_1se_rule = use_1se_rule,
        clinical_context = clinical_context,
        cost_sensitive = cost_sensitive,
        fn_fp_ratio = fn_fp_ratio,
        show_tree_plot = show_tree_plot,
        show_performance_metrics = show_performance_metrics,
        show_confusion_matrix = show_confusion_matrix,
        show_importance_plot = show_importance_plot,
        show_clinical_interpretation = show_clinical_interpretation,
        set_seed = set_seed,
        seed_value = seed_value)

    analysis <- treemedicalClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

