
# This file is automatically generated, you probably don't want to edit this

enhancedcrosstableOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "enhancedcrosstableOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            vars = NULL,
            by_var = NULL,
            percent_pattern = "col_percent",
            show_total = TRUE,
            show_total_row = TRUE,
            test_auto = TRUE,
            effect_size = FALSE,
            funs_arg = "mean_sd",
            digits = 2,
            use_labels = TRUE,
            exclude_missing = TRUE,
            show_n_col = TRUE,
            margin = "column",
            cor_method = "pearson",
            showNA = "no",
            compact = FALSE,
            export_format = "html",
            show_interpretation = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="enhancedcrosstable",
                requiresData=TRUE,
                ...)

            private$..vars <- jmvcore::OptionVariables$new(
                "vars",
                vars,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..by_var <- jmvcore::OptionVariable$new(
                "by_var",
                by_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..percent_pattern <- jmvcore::OptionList$new(
                "percent_pattern",
                percent_pattern,
                options=list(
                    "col_percent",
                    "row_percent",
                    "total_percent",
                    "count_only",
                    "percent_only"),
                default="col_percent")
            private$..show_total <- jmvcore::OptionBool$new(
                "show_total",
                show_total,
                default=TRUE)
            private$..show_total_row <- jmvcore::OptionBool$new(
                "show_total_row",
                show_total_row,
                default=TRUE)
            private$..test_auto <- jmvcore::OptionBool$new(
                "test_auto",
                test_auto,
                default=TRUE)
            private$..effect_size <- jmvcore::OptionBool$new(
                "effect_size",
                effect_size,
                default=FALSE)
            private$..funs_arg <- jmvcore::OptionList$new(
                "funs_arg",
                funs_arg,
                options=list(
                    "mean_sd",
                    "median_q1q3",
                    "mean_pm_sd",
                    "n_only"),
                default="mean_sd")
            private$..digits <- jmvcore::OptionNumber$new(
                "digits",
                digits,
                min=0,
                max=5,
                default=2)
            private$..use_labels <- jmvcore::OptionBool$new(
                "use_labels",
                use_labels,
                default=TRUE)
            private$..exclude_missing <- jmvcore::OptionBool$new(
                "exclude_missing",
                exclude_missing,
                default=TRUE)
            private$..show_n_col <- jmvcore::OptionBool$new(
                "show_n_col",
                show_n_col,
                default=TRUE)
            private$..margin <- jmvcore::OptionList$new(
                "margin",
                margin,
                options=list(
                    "column",
                    "row",
                    "table"),
                default="column")
            private$..cor_method <- jmvcore::OptionList$new(
                "cor_method",
                cor_method,
                options=list(
                    "pearson",
                    "spearman",
                    "kendall"),
                default="pearson")
            private$..showNA <- jmvcore::OptionList$new(
                "showNA",
                showNA,
                options=list(
                    "no",
                    "ifany",
                    "always"),
                default="no")
            private$..compact <- jmvcore::OptionBool$new(
                "compact",
                compact,
                default=FALSE)
            private$..export_format <- jmvcore::OptionList$new(
                "export_format",
                export_format,
                options=list(
                    "html",
                    "flextable",
                    "csv"),
                default="html")
            private$..show_interpretation <- jmvcore::OptionBool$new(
                "show_interpretation",
                show_interpretation,
                default=TRUE)

            self$.addOption(private$..vars)
            self$.addOption(private$..by_var)
            self$.addOption(private$..percent_pattern)
            self$.addOption(private$..show_total)
            self$.addOption(private$..show_total_row)
            self$.addOption(private$..test_auto)
            self$.addOption(private$..effect_size)
            self$.addOption(private$..funs_arg)
            self$.addOption(private$..digits)
            self$.addOption(private$..use_labels)
            self$.addOption(private$..exclude_missing)
            self$.addOption(private$..show_n_col)
            self$.addOption(private$..margin)
            self$.addOption(private$..cor_method)
            self$.addOption(private$..showNA)
            self$.addOption(private$..compact)
            self$.addOption(private$..export_format)
            self$.addOption(private$..show_interpretation)
        }),
    active = list(
        vars = function() private$..vars$value,
        by_var = function() private$..by_var$value,
        percent_pattern = function() private$..percent_pattern$value,
        show_total = function() private$..show_total$value,
        show_total_row = function() private$..show_total_row$value,
        test_auto = function() private$..test_auto$value,
        effect_size = function() private$..effect_size$value,
        funs_arg = function() private$..funs_arg$value,
        digits = function() private$..digits$value,
        use_labels = function() private$..use_labels$value,
        exclude_missing = function() private$..exclude_missing$value,
        show_n_col = function() private$..show_n_col$value,
        margin = function() private$..margin$value,
        cor_method = function() private$..cor_method$value,
        showNA = function() private$..showNA$value,
        compact = function() private$..compact$value,
        export_format = function() private$..export_format$value,
        show_interpretation = function() private$..show_interpretation$value),
    private = list(
        ..vars = NA,
        ..by_var = NA,
        ..percent_pattern = NA,
        ..show_total = NA,
        ..show_total_row = NA,
        ..test_auto = NA,
        ..effect_size = NA,
        ..funs_arg = NA,
        ..digits = NA,
        ..use_labels = NA,
        ..exclude_missing = NA,
        ..show_n_col = NA,
        ..margin = NA,
        ..cor_method = NA,
        ..showNA = NA,
        ..compact = NA,
        ..export_format = NA,
        ..show_interpretation = NA)
)

enhancedcrosstableResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "enhancedcrosstableResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        crosstable_main = function() private$.items[["crosstable_main"]],
        statistics_table = function() private$.items[["statistics_table"]],
        effect_sizes = function() private$.items[["effect_sizes"]],
        interpretation = function() private$.items[["interpretation"]],
        export_data = function() private$.items[["export_data"]],
        summary_stats = function() private$.items[["summary_stats"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Enhanced Cross Tables with danchaltiel/crosstable",
                refs=list(
                    "ClinicoPathJamoviModule",
                    "crosstable",
                    "officer",
                    "janitor",
                    "labelled",
                    "stringr"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Instructions",
                visible=TRUE))
            self$add(jmvcore::Html$new(
                options=options,
                name="crosstable_main",
                title="Enhanced Cross Table",
                clearWith=list(
                    "vars",
                    "by_var",
                    "percent_pattern",
                    "show_total",
                    "show_total_row",
                    "funs_arg",
                    "digits",
                    "margin",
                    "export_format")))
            self$add(jmvcore::Html$new(
                options=options,
                name="statistics_table",
                title="Statistical Tests",
                visible="(test_auto)",
                clearWith=list(
                    "vars",
                    "by_var",
                    "test_auto",
                    "effect_size",
                    "cor_method")))
            self$add(jmvcore::Html$new(
                options=options,
                name="effect_sizes",
                title="Effect Sizes",
                visible="(effect_size)",
                clearWith=list(
                    "vars",
                    "by_var",
                    "effect_size")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Statistical Interpretation",
                visible="(show_interpretation)",
                clearWith=list(
                    "vars",
                    "by_var",
                    "test_auto",
                    "effect_size",
                    "show_interpretation")))
            self$add(jmvcore::Html$new(
                options=options,
                name="export_data",
                title="Export Data",
                visible="(export_format:csv)",
                clearWith=list(
                    "vars",
                    "by_var",
                    "export_format")))
            self$add(jmvcore::Html$new(
                options=options,
                name="summary_stats",
                title="Summary Statistics",
                clearWith=list(
                    "vars",
                    "by_var",
                    "funs_arg",
                    "digits",
                    "exclude_missing")))}))

enhancedcrosstableBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "enhancedcrosstableBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "enhancedcrosstable",
                version = c(0,0,3),
                options = options,
                results = enhancedcrosstableResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Enhanced Cross Tables with danchaltiel/crosstable
#'
#' Enhanced cross-tabulation analysis using the danchaltiel/crosstable package 
#' for advanced clinical research functionality.
#'
#' @examples
#' \donttest{
#' # Example usage:
#' library(crosstable)
#' # Enhanced crosstable with tidyselect
#' crosstable(data, c(var1, var2), by = group_var)
#' # Formula interface
#' crosstable(data, c(age_group = age > 65), by = treatment)
#'}
#' @param data The data as a data frame.
#' @param vars Variables to include in the cross-tabulation (table rows).
#' @param by_var The grouping variable for cross-tabulation (table columns).
#' @param percent_pattern Pattern for displaying counts and percentages.
#' @param show_total Whether to include a total column.
#' @param show_total_row Whether to include a total row.
#' @param test_auto Whether to automatically select and perform statistical
#'   tests.
#' @param effect_size Whether to calculate effect sizes (Cramer's V, odds
#'   ratios, etc.).
#' @param funs_arg Function for summarizing continuous variables.
#' @param digits Number of decimal places for numeric results.
#' @param use_labels Whether to use variable labels if available.
#' @param exclude_missing Whether to exclude missing values from calculations.
#' @param show_n_col Whether to show sample sizes for each column.
#' @param margin Margin for calculating percentages.
#' @param cor_method Correlation method for continuous variables.
#' @param showNA Whether and when to show missing values in the table.
#' @param compact Whether to use compact table formatting.
#' @param export_format Format for table export and display.
#' @param show_interpretation Whether to include interpretation of statistical
#'   results.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$crosstable_main} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$statistics_table} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$effect_sizes} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$export_data} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$summary_stats} \tab \tab \tab \tab \tab a html \cr
#' }
#'
#' @export
enhancedcrosstable <- function(
    data,
    vars,
    by_var,
    percent_pattern = "col_percent",
    show_total = TRUE,
    show_total_row = TRUE,
    test_auto = TRUE,
    effect_size = FALSE,
    funs_arg = "mean_sd",
    digits = 2,
    use_labels = TRUE,
    exclude_missing = TRUE,
    show_n_col = TRUE,
    margin = "column",
    cor_method = "pearson",
    showNA = "no",
    compact = FALSE,
    export_format = "html",
    show_interpretation = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("enhancedcrosstable requires jmvcore to be installed (restart may be required)")

    if ( ! missing(vars)) vars <- jmvcore::resolveQuo(jmvcore::enquo(vars))
    if ( ! missing(by_var)) by_var <- jmvcore::resolveQuo(jmvcore::enquo(by_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(vars), vars, NULL),
            `if`( ! missing(by_var), by_var, NULL))

    for (v in by_var) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- enhancedcrosstableOptions$new(
        vars = vars,
        by_var = by_var,
        percent_pattern = percent_pattern,
        show_total = show_total,
        show_total_row = show_total_row,
        test_auto = test_auto,
        effect_size = effect_size,
        funs_arg = funs_arg,
        digits = digits,
        use_labels = use_labels,
        exclude_missing = exclude_missing,
        show_n_col = show_n_col,
        margin = margin,
        cor_method = cor_method,
        showNA = showNA,
        compact = compact,
        export_format = export_format,
        show_interpretation = show_interpretation)

    analysis <- enhancedcrosstableClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

