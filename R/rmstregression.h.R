
# This file is automatically generated, you probably don't want to edit this

rmstregressionOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "rmstregressionOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            elapsedtime = NULL,
            outcome = NULL,
            explanatory = NULL,
            group_var = NULL,
            outcomeLevel = "1",
            tau = 60,
            tau_method = "fixed",
            tau_percentile = 0.8,
            analysis_type = "regression",
            regression_method = "pseudo_observation",
            confidence_level = 0.95,
            bootstrap_se = FALSE,
            bootstrap_reps = 1000,
            adjustment_method = "none",
            show_rmst_table = TRUE,
            show_difference_table = TRUE,
            show_regression_table = TRUE,
            show_model_diagnostics = FALSE,
            rmst_plot = TRUE,
            difference_plot = FALSE,
            residual_plot = FALSE,
            showSummaries = TRUE,
            showExplanations = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="rmstregression",
                requiresData=TRUE,
                ...)

            private$..elapsedtime <- jmvcore::OptionVariable$new(
                "elapsedtime",
                elapsedtime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..outcome <- jmvcore::OptionVariable$new(
                "outcome",
                outcome,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..explanatory <- jmvcore::OptionVariables$new(
                "explanatory",
                explanatory,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..group_var <- jmvcore::OptionVariable$new(
                "group_var",
                group_var,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..outcomeLevel <- jmvcore::OptionString$new(
                "outcomeLevel",
                outcomeLevel,
                default="1")
            private$..tau <- jmvcore::OptionNumber$new(
                "tau",
                tau,
                default=60,
                min=1)
            private$..tau_method <- jmvcore::OptionList$new(
                "tau_method",
                tau_method,
                options=list(
                    "fixed",
                    "percentile",
                    "adaptive"),
                default="fixed")
            private$..tau_percentile <- jmvcore::OptionNumber$new(
                "tau_percentile",
                tau_percentile,
                default=0.8,
                min=0.1,
                max=0.95)
            private$..analysis_type <- jmvcore::OptionList$new(
                "analysis_type",
                analysis_type,
                options=list(
                    "regression",
                    "comparison",
                    "combined"),
                default="regression")
            private$..regression_method <- jmvcore::OptionList$new(
                "regression_method",
                regression_method,
                options=list(
                    "pseudo_observation",
                    "direct_modeling",
                    "wei_lin_ying"),
                default="pseudo_observation")
            private$..confidence_level <- jmvcore::OptionNumber$new(
                "confidence_level",
                confidence_level,
                default=0.95,
                min=0.5,
                max=0.99)
            private$..bootstrap_se <- jmvcore::OptionBool$new(
                "bootstrap_se",
                bootstrap_se,
                default=FALSE)
            private$..bootstrap_reps <- jmvcore::OptionNumber$new(
                "bootstrap_reps",
                bootstrap_reps,
                default=1000,
                min=100,
                max=5000)
            private$..adjustment_method <- jmvcore::OptionList$new(
                "adjustment_method",
                adjustment_method,
                options=list(
                    "none",
                    "bonferroni",
                    "holm",
                    "benjamini_hochberg"),
                default="none")
            private$..show_rmst_table <- jmvcore::OptionBool$new(
                "show_rmst_table",
                show_rmst_table,
                default=TRUE)
            private$..show_difference_table <- jmvcore::OptionBool$new(
                "show_difference_table",
                show_difference_table,
                default=TRUE)
            private$..show_regression_table <- jmvcore::OptionBool$new(
                "show_regression_table",
                show_regression_table,
                default=TRUE)
            private$..show_model_diagnostics <- jmvcore::OptionBool$new(
                "show_model_diagnostics",
                show_model_diagnostics,
                default=FALSE)
            private$..rmst_plot <- jmvcore::OptionBool$new(
                "rmst_plot",
                rmst_plot,
                default=TRUE)
            private$..difference_plot <- jmvcore::OptionBool$new(
                "difference_plot",
                difference_plot,
                default=FALSE)
            private$..residual_plot <- jmvcore::OptionBool$new(
                "residual_plot",
                residual_plot,
                default=FALSE)
            private$..showSummaries <- jmvcore::OptionBool$new(
                "showSummaries",
                showSummaries,
                default=TRUE)
            private$..showExplanations <- jmvcore::OptionBool$new(
                "showExplanations",
                showExplanations,
                default=TRUE)

            self$.addOption(private$..elapsedtime)
            self$.addOption(private$..outcome)
            self$.addOption(private$..explanatory)
            self$.addOption(private$..group_var)
            self$.addOption(private$..outcomeLevel)
            self$.addOption(private$..tau)
            self$.addOption(private$..tau_method)
            self$.addOption(private$..tau_percentile)
            self$.addOption(private$..analysis_type)
            self$.addOption(private$..regression_method)
            self$.addOption(private$..confidence_level)
            self$.addOption(private$..bootstrap_se)
            self$.addOption(private$..bootstrap_reps)
            self$.addOption(private$..adjustment_method)
            self$.addOption(private$..show_rmst_table)
            self$.addOption(private$..show_difference_table)
            self$.addOption(private$..show_regression_table)
            self$.addOption(private$..show_model_diagnostics)
            self$.addOption(private$..rmst_plot)
            self$.addOption(private$..difference_plot)
            self$.addOption(private$..residual_plot)
            self$.addOption(private$..showSummaries)
            self$.addOption(private$..showExplanations)
        }),
    active = list(
        elapsedtime = function() private$..elapsedtime$value,
        outcome = function() private$..outcome$value,
        explanatory = function() private$..explanatory$value,
        group_var = function() private$..group_var$value,
        outcomeLevel = function() private$..outcomeLevel$value,
        tau = function() private$..tau$value,
        tau_method = function() private$..tau_method$value,
        tau_percentile = function() private$..tau_percentile$value,
        analysis_type = function() private$..analysis_type$value,
        regression_method = function() private$..regression_method$value,
        confidence_level = function() private$..confidence_level$value,
        bootstrap_se = function() private$..bootstrap_se$value,
        bootstrap_reps = function() private$..bootstrap_reps$value,
        adjustment_method = function() private$..adjustment_method$value,
        show_rmst_table = function() private$..show_rmst_table$value,
        show_difference_table = function() private$..show_difference_table$value,
        show_regression_table = function() private$..show_regression_table$value,
        show_model_diagnostics = function() private$..show_model_diagnostics$value,
        rmst_plot = function() private$..rmst_plot$value,
        difference_plot = function() private$..difference_plot$value,
        residual_plot = function() private$..residual_plot$value,
        showSummaries = function() private$..showSummaries$value,
        showExplanations = function() private$..showExplanations$value),
    private = list(
        ..elapsedtime = NA,
        ..outcome = NA,
        ..explanatory = NA,
        ..group_var = NA,
        ..outcomeLevel = NA,
        ..tau = NA,
        ..tau_method = NA,
        ..tau_percentile = NA,
        ..analysis_type = NA,
        ..regression_method = NA,
        ..confidence_level = NA,
        ..bootstrap_se = NA,
        ..bootstrap_reps = NA,
        ..adjustment_method = NA,
        ..show_rmst_table = NA,
        ..show_difference_table = NA,
        ..show_regression_table = NA,
        ..show_model_diagnostics = NA,
        ..rmst_plot = NA,
        ..difference_plot = NA,
        ..residual_plot = NA,
        ..showSummaries = NA,
        ..showExplanations = NA)
)

rmstregressionResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "rmstregressionResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        rmstSummary = function() private$.items[["rmstSummary"]],
        rmstDifferences = function() private$.items[["rmstDifferences"]],
        regressionResults = function() private$.items[["regressionResults"]],
        modelDiagnostics = function() private$.items[["modelDiagnostics"]],
        tauSelection = function() private$.items[["tauSelection"]],
        bootstrapResults = function() private$.items[["bootstrapResults"]],
        methodologyExplanation = function() private$.items[["methodologyExplanation"]],
        analysisSummary = function() private$.items[["analysisSummary"]],
        rmstPlot = function() private$.items[["rmstPlot"]],
        differencePlot = function() private$.items[["differencePlot"]],
        residualPlot = function() private$.items[["residualPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Restricted Mean Survival Time Regression")
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Analysis Complete",
                visible=FALSE))
            self$add(jmvcore::Table$new(
                options=options,
                name="rmstSummary",
                title="RMST Summary by Group",
                visible="(show_rmst_table)",
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Group", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="rmst", 
                        `title`="RMST", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="tau_reached", 
                        `title`="\u03C4 Reached", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="rmstDifferences",
                title="RMST Differences Between Groups",
                visible="(show_difference_table)",
                columns=list(
                    list(
                        `name`="comparison", 
                        `title`="Comparison", 
                        `type`="text"),
                    list(
                        `name`="difference", 
                        `title`="Difference", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="statistic", 
                        `title`="z", 
                        `type`="number"),
                    list(
                        `name`="p", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper CI", 
                        `type`="number"),
                    list(
                        `name`="adj_p", 
                        `title`="Adj. p", 
                        `type`="number", 
                        `format`="zto,pvalue"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="regressionResults",
                title="RMST Regression Results",
                visible="(show_regression_table)",
                columns=list(
                    list(
                        `name`="term", 
                        `title`="Term", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number"),
                    list(
                        `name`="se", 
                        `title`="SE", 
                        `type`="number"),
                    list(
                        `name`="statistic", 
                        `title`="t/z", 
                        `type`="number"),
                    list(
                        `name`="p", 
                        `title`="p", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="ci_lower", 
                        `title`="Lower CI", 
                        `type`="number"),
                    list(
                        `name`="ci_upper", 
                        `title`="Upper CI", 
                        `type`="number"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelDiagnostics",
                title="Model Diagnostics",
                visible="(show_model_diagnostics)",
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="tauSelection",
                title="Tau Selection Information",
                columns=list(
                    list(
                        `name`="method", 
                        `title`="Method", 
                        `type`="text"),
                    list(
                        `name`="tau_selected", 
                        `title`="Selected \u03C4", 
                        `type`="number"),
                    list(
                        `name`="rationale", 
                        `title`="Rationale", 
                        `type`="text"),
                    list(
                        `name`="followup_pct", 
                        `title`="Follow-up %", 
                        `type`="number"),
                    list(
                        `name`="events_by_tau", 
                        `title`="Events by \u03C4", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="bootstrapResults",
                title="Bootstrap Results",
                visible="(bootstrap_se)",
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="original", 
                        `title`="Original", 
                        `type`="number"),
                    list(
                        `name`="bootstrap_mean", 
                        `title`="Bootstrap Mean", 
                        `type`="number"),
                    list(
                        `name`="bootstrap_se", 
                        `title`="Bootstrap SE", 
                        `type`="number"),
                    list(
                        `name`="bias", 
                        `title`="Bias", 
                        `type`="number"),
                    list(
                        `name`="ci_type", 
                        `title`="CI Type", 
                        `type`="text"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="methodologyExplanation",
                title="Methodology Explanation",
                visible="(showExplanations)"))
            self$add(jmvcore::Html$new(
                options=options,
                name="analysisSummary",
                title="Analysis Summary",
                visible="(showSummaries)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="rmstPlot",
                title="RMST Curves",
                width=700,
                height=500,
                requiresData=TRUE,
                visible="(rmst_plot)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="differencePlot",
                title="RMST Difference Over Time",
                width=700,
                height=400,
                requiresData=TRUE,
                visible="(difference_plot)"))
            self$add(jmvcore::Image$new(
                options=options,
                name="residualPlot",
                title="Residual Diagnostic Plots",
                width=700,
                height=400,
                requiresData=TRUE,
                visible="(residual_plot)"))}))

rmstregressionBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "rmstregressionBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "rmstregression",
                version = c(1,0,0),
                options = options,
                results = rmstregressionResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Restricted Mean Survival Time Regression
#'
#' Restricted Mean Survival Time (RMST) regression analysis provides an 
#' alternative to hazard-based models by directly modeling the mean survival 
#' time up to a specific time point (tau). This approach offers clinically 
#' interpretable results and does not require proportional hazards 
#' assumptions. RMST represents the area under the survival curve up to time 
#' tau and can be compared between groups or modeled with covariates using 
#' regression techniques.
#' 
#'
#' @examples
#' data \%>\%
#' rmstregression(
#'     elapsedtime = "time_to_event",
#'     outcome = "event_status",
#'     explanatory = c("age", "treatment", "stage"),
#'     tau = 60,
#'     analysis_type = "comparison"
#' )
#'
#' @param data the data as a data frame
#' @param elapsedtime Time to event or censoring
#' @param outcome Event indicator (1 = event, 0 = censored)
#' @param explanatory Explanatory variables for RMST regression modeling
#' @param group_var Primary grouping variable for RMST comparison (optional)
#' @param outcomeLevel Level indicating event occurrence
#' @param tau Time point for restriction in RMST calculation
#' @param tau_method Method for selecting restriction time tau
#' @param tau_percentile Percentile of follow-up time for tau selection (when
#'   using percentile method)
#' @param analysis_type Type of RMST analysis to perform
#' @param regression_method Method for RMST regression analysis
#' @param confidence_level Confidence level for confidence intervals
#' @param bootstrap_se Use bootstrap method for standard error estimation
#' @param bootstrap_reps Number of bootstrap replications for standard errors
#' @param adjustment_method Method for multiple comparison adjustment
#' @param show_rmst_table Display RMST summary statistics by group
#' @param show_difference_table Display pairwise RMST differences between
#'   groups
#' @param show_regression_table Display regression coefficient estimates
#' @param show_model_diagnostics Display model diagnostic information
#' @param rmst_plot Display RMST curves with confidence intervals
#' @param difference_plot Display plot of RMST differences over time
#' @param residual_plot Display residual diagnostic plots for regression
#'   models
#' @param showSummaries Show comprehensive analysis summaries
#' @param showExplanations Show detailed methodology explanations
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$rmstSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$rmstDifferences} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$regressionResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelDiagnostics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$tauSelection} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$bootstrapResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$methodologyExplanation} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$analysisSummary} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$rmstPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$differencePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$residualPlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$rmstSummary$asDF}
#'
#' \code{as.data.frame(results$rmstSummary)}
#'
#' @export
rmstregression <- function(
    data,
    elapsedtime,
    outcome,
    explanatory,
    group_var,
    outcomeLevel = "1",
    tau = 60,
    tau_method = "fixed",
    tau_percentile = 0.8,
    analysis_type = "regression",
    regression_method = "pseudo_observation",
    confidence_level = 0.95,
    bootstrap_se = FALSE,
    bootstrap_reps = 1000,
    adjustment_method = "none",
    show_rmst_table = TRUE,
    show_difference_table = TRUE,
    show_regression_table = TRUE,
    show_model_diagnostics = FALSE,
    rmst_plot = TRUE,
    difference_plot = FALSE,
    residual_plot = FALSE,
    showSummaries = TRUE,
    showExplanations = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("rmstregression requires jmvcore to be installed (restart may be required)")

    if ( ! missing(elapsedtime)) elapsedtime <- jmvcore::resolveQuo(jmvcore::enquo(elapsedtime))
    if ( ! missing(outcome)) outcome <- jmvcore::resolveQuo(jmvcore::enquo(outcome))
    if ( ! missing(explanatory)) explanatory <- jmvcore::resolveQuo(jmvcore::enquo(explanatory))
    if ( ! missing(group_var)) group_var <- jmvcore::resolveQuo(jmvcore::enquo(group_var))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(elapsedtime), elapsedtime, NULL),
            `if`( ! missing(outcome), outcome, NULL),
            `if`( ! missing(explanatory), explanatory, NULL),
            `if`( ! missing(group_var), group_var, NULL))


    options <- rmstregressionOptions$new(
        elapsedtime = elapsedtime,
        outcome = outcome,
        explanatory = explanatory,
        group_var = group_var,
        outcomeLevel = outcomeLevel,
        tau = tau,
        tau_method = tau_method,
        tau_percentile = tau_percentile,
        analysis_type = analysis_type,
        regression_method = regression_method,
        confidence_level = confidence_level,
        bootstrap_se = bootstrap_se,
        bootstrap_reps = bootstrap_reps,
        adjustment_method = adjustment_method,
        show_rmst_table = show_rmst_table,
        show_difference_table = show_difference_table,
        show_regression_table = show_regression_table,
        show_model_diagnostics = show_model_diagnostics,
        rmst_plot = rmst_plot,
        difference_plot = difference_plot,
        residual_plot = residual_plot,
        showSummaries = showSummaries,
        showExplanations = showExplanations)

    analysis <- rmstregressionClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

