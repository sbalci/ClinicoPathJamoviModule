
# This file is automatically generated, you probably don't want to edit this

studydiagramOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "studydiagramOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            data_format = "participant_step",
            diagram_type = "consort_standard",
            participant_id = NULL,
            step_excluded = NULL,
            exclusion_reason_participant = NULL,
            step_name = NULL,
            participant_count = NULL,
            exclusion_reason_summary = NULL,
            participant_id_mapping = NULL,
            exclusion_reason_mapping = NULL,
            treatment_group = NULL,
            step1_exclusions = NULL,
            step2_exclusions = NULL,
            step3_exclusions = NULL,
            step4_exclusions = NULL,
            step5_exclusions = NULL,
            step1_label = "Screening",
            step2_label = "Enrollment",
            step3_label = "Treatment",
            step4_label = "Follow-up",
            step5_label = "Analysis",
            show_percentages = TRUE,
            show_exclusion_boxes = TRUE,
            direction = "TB",
            color_scheme = "gray",
            show_interpretation = TRUE, ...) {

            super$initialize(
                package="ClinicoPath",
                name="studydiagram",
                requiresData=TRUE,
                ...)

            private$..data_format <- jmvcore::OptionList$new(
                "data_format",
                data_format,
                options=list(
                    "participant_step",
                    "step_summary",
                    "exclusion_mapping"),
                default="participant_step")
            private$..diagram_type <- jmvcore::OptionList$new(
                "diagram_type",
                diagram_type,
                options=list(
                    "consort_standard",
                    "consort_ggplot",
                    "flowchart_standard",
                    "flowchart_ggplot"),
                default="consort_standard")
            private$..participant_id <- jmvcore::OptionVariable$new(
                "participant_id",
                participant_id,
                suggested=list(
                    "id"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..step_excluded <- jmvcore::OptionVariable$new(
                "step_excluded",
                step_excluded,
                suggested=list(
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..exclusion_reason_participant <- jmvcore::OptionVariable$new(
                "exclusion_reason_participant",
                exclusion_reason_participant,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..step_name <- jmvcore::OptionVariable$new(
                "step_name",
                step_name,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..participant_count <- jmvcore::OptionVariable$new(
                "participant_count",
                participant_count,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..exclusion_reason_summary <- jmvcore::OptionVariable$new(
                "exclusion_reason_summary",
                exclusion_reason_summary,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..participant_id_mapping <- jmvcore::OptionVariable$new(
                "participant_id_mapping",
                participant_id_mapping,
                suggested=list(
                    "id"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..exclusion_reason_mapping <- jmvcore::OptionVariable$new(
                "exclusion_reason_mapping",
                exclusion_reason_mapping,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..treatment_group <- jmvcore::OptionVariable$new(
                "treatment_group",
                treatment_group,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..step1_exclusions <- jmvcore::OptionLevel$new(
                "step1_exclusions",
                step1_exclusions,
                variable="(exclusion_reason_mapping)")
            private$..step2_exclusions <- jmvcore::OptionLevel$new(
                "step2_exclusions",
                step2_exclusions,
                variable="(exclusion_reason_mapping)")
            private$..step3_exclusions <- jmvcore::OptionLevel$new(
                "step3_exclusions",
                step3_exclusions,
                variable="(exclusion_reason_mapping)")
            private$..step4_exclusions <- jmvcore::OptionLevel$new(
                "step4_exclusions",
                step4_exclusions,
                variable="(exclusion_reason_mapping)")
            private$..step5_exclusions <- jmvcore::OptionLevel$new(
                "step5_exclusions",
                step5_exclusions,
                variable="(exclusion_reason_mapping)")
            private$..step1_label <- jmvcore::OptionString$new(
                "step1_label",
                step1_label,
                default="Screening")
            private$..step2_label <- jmvcore::OptionString$new(
                "step2_label",
                step2_label,
                default="Enrollment")
            private$..step3_label <- jmvcore::OptionString$new(
                "step3_label",
                step3_label,
                default="Treatment")
            private$..step4_label <- jmvcore::OptionString$new(
                "step4_label",
                step4_label,
                default="Follow-up")
            private$..step5_label <- jmvcore::OptionString$new(
                "step5_label",
                step5_label,
                default="Analysis")
            private$..show_percentages <- jmvcore::OptionBool$new(
                "show_percentages",
                show_percentages,
                default=TRUE)
            private$..show_exclusion_boxes <- jmvcore::OptionBool$new(
                "show_exclusion_boxes",
                show_exclusion_boxes,
                default=TRUE)
            private$..direction <- jmvcore::OptionList$new(
                "direction",
                direction,
                options=list(
                    "TB",
                    "LR"),
                default="TB")
            private$..color_scheme <- jmvcore::OptionList$new(
                "color_scheme",
                color_scheme,
                options=list(
                    "gray",
                    "blue",
                    "minimal"),
                default="gray")
            private$..show_interpretation <- jmvcore::OptionBool$new(
                "show_interpretation",
                show_interpretation,
                default=TRUE)

            self$.addOption(private$..data_format)
            self$.addOption(private$..diagram_type)
            self$.addOption(private$..participant_id)
            self$.addOption(private$..step_excluded)
            self$.addOption(private$..exclusion_reason_participant)
            self$.addOption(private$..step_name)
            self$.addOption(private$..participant_count)
            self$.addOption(private$..exclusion_reason_summary)
            self$.addOption(private$..participant_id_mapping)
            self$.addOption(private$..exclusion_reason_mapping)
            self$.addOption(private$..treatment_group)
            self$.addOption(private$..step1_exclusions)
            self$.addOption(private$..step2_exclusions)
            self$.addOption(private$..step3_exclusions)
            self$.addOption(private$..step4_exclusions)
            self$.addOption(private$..step5_exclusions)
            self$.addOption(private$..step1_label)
            self$.addOption(private$..step2_label)
            self$.addOption(private$..step3_label)
            self$.addOption(private$..step4_label)
            self$.addOption(private$..step5_label)
            self$.addOption(private$..show_percentages)
            self$.addOption(private$..show_exclusion_boxes)
            self$.addOption(private$..direction)
            self$.addOption(private$..color_scheme)
            self$.addOption(private$..show_interpretation)
        }),
    active = list(
        data_format = function() private$..data_format$value,
        diagram_type = function() private$..diagram_type$value,
        participant_id = function() private$..participant_id$value,
        step_excluded = function() private$..step_excluded$value,
        exclusion_reason_participant = function() private$..exclusion_reason_participant$value,
        step_name = function() private$..step_name$value,
        participant_count = function() private$..participant_count$value,
        exclusion_reason_summary = function() private$..exclusion_reason_summary$value,
        participant_id_mapping = function() private$..participant_id_mapping$value,
        exclusion_reason_mapping = function() private$..exclusion_reason_mapping$value,
        treatment_group = function() private$..treatment_group$value,
        step1_exclusions = function() private$..step1_exclusions$value,
        step2_exclusions = function() private$..step2_exclusions$value,
        step3_exclusions = function() private$..step3_exclusions$value,
        step4_exclusions = function() private$..step4_exclusions$value,
        step5_exclusions = function() private$..step5_exclusions$value,
        step1_label = function() private$..step1_label$value,
        step2_label = function() private$..step2_label$value,
        step3_label = function() private$..step3_label$value,
        step4_label = function() private$..step4_label$value,
        step5_label = function() private$..step5_label$value,
        show_percentages = function() private$..show_percentages$value,
        show_exclusion_boxes = function() private$..show_exclusion_boxes$value,
        direction = function() private$..direction$value,
        color_scheme = function() private$..color_scheme$value,
        show_interpretation = function() private$..show_interpretation$value),
    private = list(
        ..data_format = NA,
        ..diagram_type = NA,
        ..participant_id = NA,
        ..step_excluded = NA,
        ..exclusion_reason_participant = NA,
        ..step_name = NA,
        ..participant_count = NA,
        ..exclusion_reason_summary = NA,
        ..participant_id_mapping = NA,
        ..exclusion_reason_mapping = NA,
        ..treatment_group = NA,
        ..step1_exclusions = NA,
        ..step2_exclusions = NA,
        ..step3_exclusions = NA,
        ..step4_exclusions = NA,
        ..step5_exclusions = NA,
        ..step1_label = NA,
        ..step2_label = NA,
        ..step3_label = NA,
        ..step4_label = NA,
        ..step5_label = NA,
        ..show_percentages = NA,
        ..show_exclusion_boxes = NA,
        ..direction = NA,
        ..color_scheme = NA,
        ..show_interpretation = NA)
)

studydiagramResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "studydiagramResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        summary = function() private$.items[["summary"]],
        diagram = function() private$.items[["diagram"]],
        plot = function() private$.items[["plot"]],
        interpretation = function() private$.items[["interpretation"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Study Diagram Results")
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="Getting Started",
                clearWith=list(
                    "data_format",
                    "participant_id",
                    "step_excluded",
                    "exclusion_reason_participant",
                    "step_name",
                    "participant_count",
                    "exclusion_reason_summary",
                    "participant_id_mapping",
                    "exclusion_reason_mapping")))
            self$add(jmvcore::Table$new(
                options=options,
                name="summary",
                title="Study Flow Summary",
                clearWith=list(
                    "data_format",
                    "participant_id",
                    "step_excluded",
                    "exclusion_reason_participant",
                    "step_name",
                    "participant_count",
                    "exclusion_reason_summary",
                    "participant_id_mapping",
                    "exclusion_reason_mapping",
                    "step1_exclusions",
                    "step2_exclusions",
                    "step3_exclusions",
                    "step4_exclusions",
                    "step5_exclusions"),
                columns=list(
                    list(
                        `name`="step", 
                        `title`="Study Step", 
                        `type`="text"),
                    list(
                        `name`="participants", 
                        `title`="Participants", 
                        `type`="integer"),
                    list(
                        `name`="excluded", 
                        `title`="Excluded", 
                        `type`="integer"),
                    list(
                        `name`="percent_retained", 
                        `title`="% Retained", 
                        `type`="number", 
                        `format`="zto,p"),
                    list(
                        `name`="exclusion_reasons", 
                        `title`="Exclusion Reasons", 
                        `type`="text"))))
            self$add(jmvcore::Html$new(
                options=options,
                name="diagram",
                title="Study Diagram",
                clearWith=list(
                    "data_format",
                    "diagram_type",
                    "participant_id",
                    "step_excluded",
                    "exclusion_reason_participant",
                    "step_name",
                    "participant_count",
                    "exclusion_reason_summary",
                    "participant_id_mapping",
                    "exclusion_reason_mapping",
                    "step1_exclusions",
                    "step2_exclusions",
                    "step3_exclusions",
                    "step4_exclusions",
                    "step5_exclusions",
                    "step1_label",
                    "step2_label",
                    "step3_label",
                    "step4_label",
                    "step5_label",
                    "show_percentages",
                    "show_exclusion_boxes",
                    "direction",
                    "color_scheme")))
            self$add(jmvcore::Image$new(
                options=options,
                name="plot",
                title="Diagram Plot",
                width=800,
                height=600,
                requiresData=TRUE,
                clearWith=list(
                    "data_format",
                    "diagram_type",
                    "participant_id",
                    "step_excluded",
                    "exclusion_reason_participant",
                    "step_name",
                    "participant_count",
                    "exclusion_reason_summary",
                    "participant_id_mapping",
                    "exclusion_reason_mapping",
                    "step1_exclusions",
                    "step2_exclusions",
                    "step3_exclusions",
                    "step4_exclusions",
                    "step5_exclusions",
                    "step1_label",
                    "step2_label",
                    "step3_label",
                    "step4_label",
                    "step5_label",
                    "show_percentages",
                    "show_exclusion_boxes",
                    "direction",
                    "color_scheme")))
            self$add(jmvcore::Html$new(
                options=options,
                name="interpretation",
                title="Interpretation & Guidance",
                clearWith=list(
                    "show_interpretation",
                    "data_format",
                    "diagram_type")))}))

studydiagramBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "studydiagramBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "studydiagram",
                version = c(1,0,0),
                options = options,
                results = studydiagramResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Study Diagram
#'
#' Creates professional study flow diagrams including CONSORT diagrams and 
#' flowcharts using multiple rendering engines
#' @param data The data as a data frame.
#' @param data_format How your data is structured. Participant tracking: each
#'   row is a participant with step excluded. Step summary: each row is a study
#'   step with counts. Exclusion mapping: map exclusion reasons to steps.
#' @param diagram_type Rendering engine and diagram style. CONSORT for
#'   clinical trials, Flowchart for general study flows. Standard uses
#'   DiagrammeR, ggplot2 uses modern styling.
#' @param participant_id Variable identifying individual participants (for
#'   participant tracking format)
#' @param step_excluded Variable indicating at which step number the
#'   participant was excluded (for participant tracking format)
#' @param exclusion_reason_participant Variable containing exclusion reason
#'   text (for participant tracking format)
#' @param step_name Variable containing step/stage names (for step summary
#'   format)
#' @param participant_count Variable containing participant counts at each
#'   step (for step summary format)
#' @param exclusion_reason_summary Variable containing exclusion reason
#'   descriptions (for step summary format)
#' @param participant_id_mapping Variable identifying individual participants
#'   (for exclusion mapping format)
#' @param exclusion_reason_mapping Variable containing all exclusion reasons
#'   (for exclusion mapping format)
#' @param treatment_group Variable indicating treatment arm or group
#'   assignment (optional)
#' @param step1_exclusions Select exclusion reason levels that occur at step 1
#' @param step2_exclusions Select exclusion reason levels that occur at step 2
#' @param step3_exclusions Select exclusion reason levels that occur at step 3
#' @param step4_exclusions Select exclusion reason levels that occur at step 4
#' @param step5_exclusions Select exclusion reason levels that occur at step 5
#' @param step1_label Label for step 1 in the diagram
#' @param step2_label Label for step 2 in the diagram
#' @param step3_label Label for step 3 in the diagram
#' @param step4_label Label for step 4 in the diagram
#' @param step5_label Label for step 5 in the diagram
#' @param show_percentages Show percentage of initial participants retained at
#'   each step
#' @param show_exclusion_boxes Show side boxes with exclusion counts and
#'   reasons
#' @param direction Direction of diagram flow
#' @param color_scheme Color scheme for diagram elements
#' @param show_interpretation Show explanatory text about the generated
#'   diagram
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab Instructions and data format guidance \cr
#'   \code{results$summary} \tab \tab \tab \tab \tab Summary of participant flow through study steps \cr
#'   \code{results$diagram} \tab \tab \tab \tab \tab Interactive study flow diagram \cr
#'   \code{results$plot} \tab \tab \tab \tab \tab Publication-ready diagram plot \cr
#'   \code{results$interpretation} \tab \tab \tab \tab \tab Explanatory text about the diagram and results \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$summary$asDF}
#'
#' \code{as.data.frame(results$summary)}
#'
#' @export
studydiagram <- function(
    data,
    data_format = "participant_step",
    diagram_type = "consort_standard",
    participant_id,
    step_excluded,
    exclusion_reason_participant,
    step_name,
    participant_count,
    exclusion_reason_summary,
    participant_id_mapping,
    exclusion_reason_mapping,
    treatment_group,
    step1_exclusions,
    step2_exclusions,
    step3_exclusions,
    step4_exclusions,
    step5_exclusions,
    step1_label = "Screening",
    step2_label = "Enrollment",
    step3_label = "Treatment",
    step4_label = "Follow-up",
    step5_label = "Analysis",
    show_percentages = TRUE,
    show_exclusion_boxes = TRUE,
    direction = "TB",
    color_scheme = "gray",
    show_interpretation = TRUE) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("studydiagram requires jmvcore to be installed (restart may be required)")

    if ( ! missing(participant_id)) participant_id <- jmvcore::resolveQuo(jmvcore::enquo(participant_id))
    if ( ! missing(step_excluded)) step_excluded <- jmvcore::resolveQuo(jmvcore::enquo(step_excluded))
    if ( ! missing(exclusion_reason_participant)) exclusion_reason_participant <- jmvcore::resolveQuo(jmvcore::enquo(exclusion_reason_participant))
    if ( ! missing(step_name)) step_name <- jmvcore::resolveQuo(jmvcore::enquo(step_name))
    if ( ! missing(participant_count)) participant_count <- jmvcore::resolveQuo(jmvcore::enquo(participant_count))
    if ( ! missing(exclusion_reason_summary)) exclusion_reason_summary <- jmvcore::resolveQuo(jmvcore::enquo(exclusion_reason_summary))
    if ( ! missing(participant_id_mapping)) participant_id_mapping <- jmvcore::resolveQuo(jmvcore::enquo(participant_id_mapping))
    if ( ! missing(exclusion_reason_mapping)) exclusion_reason_mapping <- jmvcore::resolveQuo(jmvcore::enquo(exclusion_reason_mapping))
    if ( ! missing(treatment_group)) treatment_group <- jmvcore::resolveQuo(jmvcore::enquo(treatment_group))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(participant_id), participant_id, NULL),
            `if`( ! missing(step_excluded), step_excluded, NULL),
            `if`( ! missing(exclusion_reason_participant), exclusion_reason_participant, NULL),
            `if`( ! missing(step_name), step_name, NULL),
            `if`( ! missing(participant_count), participant_count, NULL),
            `if`( ! missing(exclusion_reason_summary), exclusion_reason_summary, NULL),
            `if`( ! missing(participant_id_mapping), participant_id_mapping, NULL),
            `if`( ! missing(exclusion_reason_mapping), exclusion_reason_mapping, NULL),
            `if`( ! missing(treatment_group), treatment_group, NULL))

    for (v in exclusion_reason_participant) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in step_name) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in exclusion_reason_summary) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in exclusion_reason_mapping) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in treatment_group) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- studydiagramOptions$new(
        data_format = data_format,
        diagram_type = diagram_type,
        participant_id = participant_id,
        step_excluded = step_excluded,
        exclusion_reason_participant = exclusion_reason_participant,
        step_name = step_name,
        participant_count = participant_count,
        exclusion_reason_summary = exclusion_reason_summary,
        participant_id_mapping = participant_id_mapping,
        exclusion_reason_mapping = exclusion_reason_mapping,
        treatment_group = treatment_group,
        step1_exclusions = step1_exclusions,
        step2_exclusions = step2_exclusions,
        step3_exclusions = step3_exclusions,
        step4_exclusions = step4_exclusions,
        step5_exclusions = step5_exclusions,
        step1_label = step1_label,
        step2_label = step2_label,
        step3_label = step3_label,
        step4_label = step4_label,
        step5_label = step5_label,
        show_percentages = show_percentages,
        show_exclusion_boxes = show_exclusion_boxes,
        direction = direction,
        color_scheme = color_scheme,
        show_interpretation = show_interpretation)

    analysis <- studydiagramClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

