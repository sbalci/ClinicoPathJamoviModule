
# This file is automatically generated, you probably don't want to edit this

decisioncombineOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "decisioncombineOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            gold = NULL,
            goldPositive = NULL,
            test1 = NULL,
            test1Positive = NULL,
            test2 = NULL,
            test2Positive = NULL,
            test3 = NULL,
            test3Positive = NULL,
            od = FALSE,
            showIndividual = TRUE,
            exportCombinationPattern = FALSE,
            showVisualization = TRUE,
            plotType = "heatmap",
            plotHeight = 600,
            plotWidth = 800,
            colorScheme = "clinical", ...) {

            super$initialize(
                package="ClinicoPath",
                name="decisioncombine",
                requiresData=TRUE,
                ...)

            private$..gold <- jmvcore::OptionVariable$new(
                "gold",
                gold,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..goldPositive <- jmvcore::OptionLevel$new(
                "goldPositive",
                goldPositive,
                variable="(gold)")
            private$..test1 <- jmvcore::OptionVariable$new(
                "test1",
                test1,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..test1Positive <- jmvcore::OptionLevel$new(
                "test1Positive",
                test1Positive,
                variable="(test1)")
            private$..test2 <- jmvcore::OptionVariable$new(
                "test2",
                test2,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..test2Positive <- jmvcore::OptionLevel$new(
                "test2Positive",
                test2Positive,
                variable="(test2)")
            private$..test3 <- jmvcore::OptionVariable$new(
                "test3",
                test3,
                suggested=list(
                    "nominal"),
                permitted=list(
                    "factor"))
            private$..test3Positive <- jmvcore::OptionLevel$new(
                "test3Positive",
                test3Positive,
                variable="(test3)")
            private$..od <- jmvcore::OptionBool$new(
                "od",
                od,
                default=FALSE)
            private$..showIndividual <- jmvcore::OptionBool$new(
                "showIndividual",
                showIndividual,
                default=TRUE)
            private$..exportCombinationPattern <- jmvcore::OptionBool$new(
                "exportCombinationPattern",
                exportCombinationPattern,
                default=FALSE)
            private$..showVisualization <- jmvcore::OptionBool$new(
                "showVisualization",
                showVisualization,
                default=TRUE)
            private$..plotType <- jmvcore::OptionList$new(
                "plotType",
                plotType,
                options=list(
                    "heatmap",
                    "roc",
                    "tree",
                    "venn",
                    "forest",
                    "all"),
                default="heatmap")
            private$..plotHeight <- jmvcore::OptionInteger$new(
                "plotHeight",
                plotHeight,
                default=600,
                min=400,
                max=1200)
            private$..plotWidth <- jmvcore::OptionInteger$new(
                "plotWidth",
                plotWidth,
                default=800,
                min=600,
                max=1600)
            private$..colorScheme <- jmvcore::OptionList$new(
                "colorScheme",
                colorScheme,
                options=list(
                    "clinical",
                    "viridis",
                    "blueyellow",
                    "grayscale"),
                default="clinical")

            self$.addOption(private$..gold)
            self$.addOption(private$..goldPositive)
            self$.addOption(private$..test1)
            self$.addOption(private$..test1Positive)
            self$.addOption(private$..test2)
            self$.addOption(private$..test2Positive)
            self$.addOption(private$..test3)
            self$.addOption(private$..test3Positive)
            self$.addOption(private$..od)
            self$.addOption(private$..showIndividual)
            self$.addOption(private$..exportCombinationPattern)
            self$.addOption(private$..showVisualization)
            self$.addOption(private$..plotType)
            self$.addOption(private$..plotHeight)
            self$.addOption(private$..plotWidth)
            self$.addOption(private$..colorScheme)
        }),
    active = list(
        gold = function() private$..gold$value,
        goldPositive = function() private$..goldPositive$value,
        test1 = function() private$..test1$value,
        test1Positive = function() private$..test1Positive$value,
        test2 = function() private$..test2$value,
        test2Positive = function() private$..test2Positive$value,
        test3 = function() private$..test3$value,
        test3Positive = function() private$..test3Positive$value,
        od = function() private$..od$value,
        showIndividual = function() private$..showIndividual$value,
        exportCombinationPattern = function() private$..exportCombinationPattern$value,
        showVisualization = function() private$..showVisualization$value,
        plotType = function() private$..plotType$value,
        plotHeight = function() private$..plotHeight$value,
        plotWidth = function() private$..plotWidth$value,
        colorScheme = function() private$..colorScheme$value),
    private = list(
        ..gold = NA,
        ..goldPositive = NA,
        ..test1 = NA,
        ..test1Positive = NA,
        ..test2 = NA,
        ..test2Positive = NA,
        ..test3 = NA,
        ..test3Positive = NA,
        ..od = NA,
        ..showIndividual = NA,
        ..exportCombinationPattern = NA,
        ..showVisualization = NA,
        ..plotType = NA,
        ..plotHeight = NA,
        ..plotWidth = NA,
        ..colorScheme = NA)
)

decisioncombineResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "decisioncombineResults",
    inherit = jmvcore::Group,
    active = list(
        goldStandardFreqTable = function() private$.items[["goldStandardFreqTable"]],
        crossTabTable = function() private$.items[["crossTabTable"]],
        indTable1 = function() private$.items[["indTable1"]],
        indTable2 = function() private$.items[["indTable2"]],
        indTable3 = function() private$.items[["indTable3"]],
        combinationsAnalysis = function() private$.items[["combinationsAnalysis"]],
        combStatsTable = function() private$.items[["combStatsTable"]],
        combStatsTableCI = function() private$.items[["combStatsTableCI"]],
        addCombinationPattern = function() private$.items[["addCombinationPattern"]],
        performanceHeatmap = function() private$.items[["performanceHeatmap"]],
        rocCurves = function() private$.items[["rocCurves"]],
        decisionTree = function() private$.items[["decisionTree"]],
        vennDiagram = function() private$.items[["vennDiagram"]],
        forestPlot = function() private$.items[["forestPlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Combine Medical Decision Tests",
                refs=list(
                    "DiagnosticTests",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Table$new(
                options=options,
                name="goldStandardFreqTable",
                title="Gold Standard Frequencies",
                visible="(od)",
                rows=0,
                columns=list(
                    list(
                        `name`="level", 
                        `title`="Level", 
                        `type`="text"),
                    list(
                        `name`="frequency", 
                        `title`="Frequency", 
                        `type`="number"),
                    list(
                        `name`="percentage", 
                        `title`="Percentage", 
                        `type`="number", 
                        `format`="percent")),
                clearWith=list(
                    "test1",
                    "test2",
                    "test3",
                    "test1Positive",
                    "test2Positive",
                    "test3Positive")))
            self$add(jmvcore::Table$new(
                options=options,
                name="crossTabTable",
                title="Cross-tabulation Tables",
                visible="(od)",
                rows=0,
                columns=list(
                    list(
                        `name`="test_var", 
                        `title`="Test Variable", 
                        `type`="text"),
                    list(
                        `name`="test_level", 
                        `title`="Test Level", 
                        `type`="text"),
                    list(
                        `name`="gold_positive", 
                        `title`="Gold Standard Positive", 
                        `type`="number"),
                    list(
                        `name`="gold_negative", 
                        `title`="Gold Standard Negative", 
                        `type`="number"),
                    list(
                        `name`="total", 
                        `title`="Total", 
                        `type`="number")),
                clearWith=list(
                    "test1",
                    "test2",
                    "test3",
                    "test1Positive",
                    "test2Positive",
                    "test3Positive")))
            self$add(jmvcore::Table$new(
                options=options,
                name="indTable1",
                title="Test 1 Results",
                visible="(showIndividual && !is.null(test1))",
                rows=0,
                columns=list(
                    list(
                        `name`="newtest", 
                        `title`="", 
                        `type`="text"),
                    list(
                        `name`="GP", 
                        `title`="Gold Positive", 
                        `type`="number"),
                    list(
                        `name`="GN", 
                        `title`="Gold Negative", 
                        `type`="number"),
                    list(
                        `name`="Total", 
                        `title`="Total", 
                        `type`="number")),
                clearWith=list(
                    "test1",
                    "test2",
                    "test3",
                    "test1Positive",
                    "test2Positive",
                    "test3Positive")))
            self$add(jmvcore::Table$new(
                options=options,
                name="indTable2",
                title="Test 2 Results",
                visible="(showIndividual && !is.null(test2))",
                rows=0,
                columns=list(
                    list(
                        `name`="newtest", 
                        `title`="", 
                        `type`="text"),
                    list(
                        `name`="GP", 
                        `title`="Gold Positive", 
                        `type`="number"),
                    list(
                        `name`="GN", 
                        `title`="Gold Negative", 
                        `type`="number"),
                    list(
                        `name`="Total", 
                        `title`="Total", 
                        `type`="number")),
                clearWith=list(
                    "test1",
                    "test2",
                    "test3",
                    "test1Positive",
                    "test2Positive",
                    "test3Positive")))
            self$add(jmvcore::Table$new(
                options=options,
                name="indTable3",
                title="Test 3 Results",
                visible="(showIndividual && !is.null(test3))",
                rows=0,
                columns=list(
                    list(
                        `name`="newtest", 
                        `title`="", 
                        `type`="text"),
                    list(
                        `name`="GP", 
                        `title`="Gold Positive", 
                        `type`="number"),
                    list(
                        `name`="GN", 
                        `title`="Gold Negative", 
                        `type`="number"),
                    list(
                        `name`="Total", 
                        `title`="Total", 
                        `type`="number")),
                clearWith=list(
                    "test1",
                    "test2",
                    "test3",
                    "test1Positive",
                    "test2Positive",
                    "test3Positive")))
            self$add(jmvcore::Html$new(
                options=options,
                name="combinationsAnalysis",
                title="Test Combination Patterns Analysis",
                visible=TRUE,
                clearWith=list(
                    "test1",
                    "test2",
                    "test3",
                    "test1Positive",
                    "test2Positive",
                    "test3Positive")))
            self$add(jmvcore::Table$new(
                options=options,
                name="combStatsTable",
                title="Combination Diagnostic Statistics",
                visible=TRUE,
                rows=0,
                columns=list(
                    list(
                        `name`="combination", 
                        `title`="Pattern", 
                        `type`="text"),
                    list(
                        `name`="sens", 
                        `title`="Sensitivity", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="spec", 
                        `title`="Specificity", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="ppv", 
                        `title`="PPV", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="npv", 
                        `title`="NPV", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="acc", 
                        `title`="Accuracy", 
                        `type`="number", 
                        `format`="pc")),
                clearWith=list(
                    "test1",
                    "test2",
                    "test3",
                    "test1Positive",
                    "test2Positive",
                    "test3Positive")))
            self$add(jmvcore::Table$new(
                options=options,
                name="combStatsTableCI",
                title="Combination Diagnostic Statistics with 95% Confidence Intervals",
                visible=TRUE,
                rows=0,
                columns=list(
                    list(
                        `name`="combination", 
                        `title`="Pattern", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Statistic", 
                        `type`="text"),
                    list(
                        `name`="estimate", 
                        `title`="Estimate", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="lower", 
                        `title`="Lower", 
                        `superTitle`="95% Wilson CI", 
                        `type`="number", 
                        `format`="pc"),
                    list(
                        `name`="upper", 
                        `title`="Upper", 
                        `superTitle`="95% Wilson CI", 
                        `type`="number", 
                        `format`="pc")),
                clearWith=list(
                    "test1",
                    "test2",
                    "test3",
                    "test1Positive",
                    "test2Positive",
                    "test3Positive")))
            self$add(jmvcore::Output$new(
                options=options,
                name="addCombinationPattern",
                title="Test Combination Patterns",
                varTitle="TestCombination",
                varDescription="Test combination pattern exported to dataset (e.g., +/+ = both positive, +/- = test1 pos/test2 neg, -/+ = test1 neg/test2 pos, -/- = both negative). Enables further analysis of pattern-specific outcomes.",
                measureType="nominal",
                clearWith=list(
                    "test1",
                    "test2",
                    "test3",
                    "test1Positive",
                    "test2Positive",
                    "test3Positive")))
            self$add(jmvcore::Image$new(
                options=options,
                name="performanceHeatmap",
                title="Diagnostic Performance Heatmap",
                width=800,
                height=600,
                visible="(showVisualization && (plotType == 'heatmap' || plotType == 'all'))",
                renderFun=".plotPerformanceHeatmap",
                clearWith=list(
                    "test1",
                    "test2",
                    "test3",
                    "colorScheme",
                    "plotWidth",
                    "plotHeight")))
            self$add(jmvcore::Image$new(
                options=options,
                name="rocCurves",
                title="ROC Analysis with Optimal Cut-point",
                width=800,
                height=600,
                visible="(showVisualization && (plotType == 'roc' || plotType == 'all'))",
                renderFun=".plotROCCurves",
                clearWith=list(
                    "test1",
                    "test2",
                    "test3",
                    "plotWidth",
                    "plotHeight")))
            self$add(jmvcore::Image$new(
                options=options,
                name="decisionTree",
                title="Decision Tree Visualization",
                width=800,
                height=600,
                visible="(showVisualization && (plotType == 'tree' || plotType == 'all'))",
                renderFun=".plotDecisionTree",
                clearWith=list(
                    "test1",
                    "test2",
                    "test3",
                    "plotWidth",
                    "plotHeight")))
            self$add(jmvcore::Image$new(
                options=options,
                name="vennDiagram",
                title="Test Agreement Venn Diagram",
                width=800,
                height=600,
                visible="(showVisualization && (plotType == 'venn' || plotType == 'all'))",
                renderFun=".plotVennDiagram",
                clearWith=list(
                    "test1",
                    "test2",
                    "test3",
                    "plotWidth",
                    "plotHeight")))
            self$add(jmvcore::Image$new(
                options=options,
                name="forestPlot",
                title="Forest Plot with Wilson Confidence Intervals",
                width=800,
                height=600,
                visible="(showVisualization && (plotType == 'forest' || plotType == 'all'))",
                renderFun=".plotForest",
                clearWith=list(
                    "test1",
                    "test2",
                    "test3",
                    "plotWidth",
                    "plotHeight")))}))

decisioncombineBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "decisioncombineBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "decisioncombine",
                version = c(0,0,31),
                options = options,
                results = decisioncombineResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Combine Medical Decision Tests
#'
#' Advanced medical diagnostic test combination analysis with automated 
#' optimal cut-point identification and comprehensive clinical interpretation. 
#' This function systematically evaluates all possible test result 
#' combinations 
#' (2-test: 4 patterns, 3-test: 8 patterns) against a gold standard using 
#' state-of-the-art statistical methods. Features include Wilson score 
#' confidence intervals for enhanced accuracy, ROC-based optimal cut-point 
#' selection using Youden Index maximization, and publication-quality 
#' visualizations with clinical decision thresholds. Provides actionable 
#' recommendations for screening vs. confirmatory testing strategies with 
#' detailed clinical interpretation guidelines. Essential for evidence-based 
#' diagnostic protocol development and test validation studies.
#' 
#'
#' @examples
#' # Basic two-test combination analysis with optimal cut-point identification
#' result1 <- decisioncombine(
#'   data = histopathology,
#'   gold = "Golden Standart",
#'   goldPositive = "1",
#'   test1 = "New Test",
#'   test1Positive = "1",
#'   test2 = "Rater 1",
#'   test2Positive = "1",
#'   showVisualization = TRUE,
#'   plotType = "all"  # Shows all visualization types including ROC with optimal cut-point
#' )
#'
#' # Comprehensive three-test analysis with clinical recommendations
#' result2 <- decisioncombine(
#'   data = histopathology,
#'   gold = "Golden Standart",
#'   goldPositive = "1",
#'   test1 = "New Test",
#'   test1Positive = "1",
#'   test2 = "Rater 1",
#'   test2Positive = "1",
#'   test3 = "Rater 2",
#'   test3Positive = "1",
#'   showIndividual = TRUE,
#'   showVisualization = TRUE,
#'   plotType = "roc",  # Focus on ROC analysis with optimal cut-point
#'   exportCombinationPattern = TRUE  # Export patterns for further analysis
#' )
#'
#' # Access optimal cut-point recommendations from HTML output
#' # result2$combinationsAnalysis contains clinical recommendations
#'
#' @param data The data as a data frame.
#' @param gold .
#' @param goldPositive .
#' @param test1 .
#' @param test1Positive .
#' @param test2 .
#' @param test2Positive .
#' @param test3 .
#' @param test3Positive .
#' @param od Boolean selection whether to show frequency tables. Default is
#'   'false'.
#' @param showIndividual .
#' @param exportCombinationPattern Export a new variable to the data frame
#'   indicating the test combination pattern (e.g., +/+, +/-, -/+, -/-).
#' @param showVisualization Display comprehensive visualizations for test
#'   combination analysis with automated optimal cut-point identification.
#' @param plotType Visualization selection: heatmap (performance matrix), roc
#'   (ROC space with optimal cut-point),  tree (clinical decision hierarchy),
#'   venn (test agreement), forest (Wilson CIs), all (comprehensive output).
#' @param plotHeight Height of the plot in pixels.
#' @param plotWidth Width of the plot in pixels.
#' @param colorScheme Color scheme for visualizations. Clinical uses red for
#'   negative and green for positive.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$goldStandardFreqTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$crossTabTable} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$indTable1} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$indTable2} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$indTable3} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$combinationsAnalysis} \tab \tab \tab \tab \tab Comprehensive analysis of all possible test combinations \cr
#'   \code{results$combStatsTable} \tab \tab \tab \tab \tab Primary diagnostic performance metrics for each test combination pattern. Wilson score confidence intervals used for enhanced accuracy with small samples. \cr
#'   \code{results$combStatsTableCI} \tab \tab \tab \tab \tab Detailed confidence intervals using Wilson score method, which provides more accurate bounds for diagnostic proportions than normal approximation, especially for small samples or extreme values. \cr
#'   \code{results$addCombinationPattern} \tab \tab \tab \tab \tab an output \cr
#'   \code{results$performanceHeatmap} \tab \tab \tab \tab \tab Publication-quality heatmap showing comprehensive diagnostic performance metrics across all test combination patterns with clinical color coding. \cr
#'   \code{results$rocCurves} \tab \tab \tab \tab \tab ROC space analysis comparing all test combinations with automatic identification of optimal cut-point using Youden Index maximization for balanced sensitivity and specificity. \cr
#'   \code{results$decisionTree} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$vennDiagram} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$forestPlot} \tab \tab \tab \tab \tab Comprehensive forest plot displaying all diagnostic metrics with Wilson score confidence intervals, providing more accurate uncertainty estimates than normal approximation methods. \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$goldStandardFreqTable$asDF}
#'
#' \code{as.data.frame(results$goldStandardFreqTable)}
#'
#' @export
decisioncombine <- function(
    data,
    gold,
    goldPositive,
    test1,
    test1Positive,
    test2,
    test2Positive,
    test3,
    test3Positive,
    od = FALSE,
    showIndividual = TRUE,
    exportCombinationPattern = FALSE,
    showVisualization = TRUE,
    plotType = "heatmap",
    plotHeight = 600,
    plotWidth = 800,
    colorScheme = "clinical") {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("decisioncombine requires jmvcore to be installed (restart may be required)")

    if ( ! missing(gold)) gold <- jmvcore::resolveQuo(jmvcore::enquo(gold))
    if ( ! missing(test1)) test1 <- jmvcore::resolveQuo(jmvcore::enquo(test1))
    if ( ! missing(test2)) test2 <- jmvcore::resolveQuo(jmvcore::enquo(test2))
    if ( ! missing(test3)) test3 <- jmvcore::resolveQuo(jmvcore::enquo(test3))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(gold), gold, NULL),
            `if`( ! missing(test1), test1, NULL),
            `if`( ! missing(test2), test2, NULL),
            `if`( ! missing(test3), test3, NULL))

    for (v in gold) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in test1) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in test2) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])
    for (v in test3) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- decisioncombineOptions$new(
        gold = gold,
        goldPositive = goldPositive,
        test1 = test1,
        test1Positive = test1Positive,
        test2 = test2,
        test2Positive = test2Positive,
        test3 = test3,
        test3Positive = test3Positive,
        od = od,
        showIndividual = showIndividual,
        exportCombinationPattern = exportCombinationPattern,
        showVisualization = showVisualization,
        plotType = plotType,
        plotHeight = plotHeight,
        plotWidth = plotWidth,
        colorScheme = colorScheme)

    analysis <- decisioncombineClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

