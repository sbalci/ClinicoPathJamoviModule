
# This file is automatically generated, you probably don't want to edit this

ihcsurvivalOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcsurvivalOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            markers = NULL,
            survivalTime = NULL,
            survivalEvent = NULL,
            id = NULL,
            prognosticClustering = TRUE,
            multiRegionAnalysis = FALSE,
            centralRegion = NULL,
            invasiveRegion = NULL,
            riskStratification = "tertiles",
            coxRegression = TRUE,
            multivariateAdjustment = NULL,
            kaplanMeierPlots = TRUE,
            landmarkAnalysis = FALSE,
            landmarkTime = 60,
            confidenceLevel = 0.95, ...) {

            super$initialize(
                package="ClinicoPath",
                name="ihcsurvival",
                requiresData=TRUE,
                ...)

            private$..markers <- jmvcore::OptionVariables$new(
                "markers",
                markers,
                suggested=list(
                    "ordinal",
                    "nominal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..survivalTime <- jmvcore::OptionVariable$new(
                "survivalTime",
                survivalTime,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..survivalEvent <- jmvcore::OptionVariable$new(
                "survivalEvent",
                survivalEvent,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..id <- jmvcore::OptionVariable$new(
                "id",
                id,
                suggested=list(
                    "nominal",
                    "id"),
                permitted=list(
                    "factor",
                    "numeric"),
                default=NULL)
            private$..prognosticClustering <- jmvcore::OptionBool$new(
                "prognosticClustering",
                prognosticClustering,
                default=TRUE)
            private$..multiRegionAnalysis <- jmvcore::OptionBool$new(
                "multiRegionAnalysis",
                multiRegionAnalysis,
                default=FALSE)
            private$..centralRegion <- jmvcore::OptionVariables$new(
                "centralRegion",
                centralRegion,
                suggested=list(
                    "ordinal",
                    "nominal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..invasiveRegion <- jmvcore::OptionVariables$new(
                "invasiveRegion",
                invasiveRegion,
                suggested=list(
                    "ordinal",
                    "nominal",
                    "continuous"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..riskStratification <- jmvcore::OptionList$new(
                "riskStratification",
                riskStratification,
                options=list(
                    "binary",
                    "tertiles",
                    "quartiles",
                    "optimal"),
                default="tertiles")
            private$..coxRegression <- jmvcore::OptionBool$new(
                "coxRegression",
                coxRegression,
                default=TRUE)
            private$..multivariateAdjustment <- jmvcore::OptionVariables$new(
                "multivariateAdjustment",
                multivariateAdjustment,
                suggested=list(
                    "continuous",
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..kaplanMeierPlots <- jmvcore::OptionBool$new(
                "kaplanMeierPlots",
                kaplanMeierPlots,
                default=TRUE)
            private$..landmarkAnalysis <- jmvcore::OptionBool$new(
                "landmarkAnalysis",
                landmarkAnalysis,
                default=FALSE)
            private$..landmarkTime <- jmvcore::OptionNumber$new(
                "landmarkTime",
                landmarkTime,
                min=1,
                max=120,
                default=60)
            private$..confidenceLevel <- jmvcore::OptionNumber$new(
                "confidenceLevel",
                confidenceLevel,
                min=0.8,
                max=0.99,
                default=0.95)

            self$.addOption(private$..markers)
            self$.addOption(private$..survivalTime)
            self$.addOption(private$..survivalEvent)
            self$.addOption(private$..id)
            self$.addOption(private$..prognosticClustering)
            self$.addOption(private$..multiRegionAnalysis)
            self$.addOption(private$..centralRegion)
            self$.addOption(private$..invasiveRegion)
            self$.addOption(private$..riskStratification)
            self$.addOption(private$..coxRegression)
            self$.addOption(private$..multivariateAdjustment)
            self$.addOption(private$..kaplanMeierPlots)
            self$.addOption(private$..landmarkAnalysis)
            self$.addOption(private$..landmarkTime)
            self$.addOption(private$..confidenceLevel)
        }),
    active = list(
        markers = function() private$..markers$value,
        survivalTime = function() private$..survivalTime$value,
        survivalEvent = function() private$..survivalEvent$value,
        id = function() private$..id$value,
        prognosticClustering = function() private$..prognosticClustering$value,
        multiRegionAnalysis = function() private$..multiRegionAnalysis$value,
        centralRegion = function() private$..centralRegion$value,
        invasiveRegion = function() private$..invasiveRegion$value,
        riskStratification = function() private$..riskStratification$value,
        coxRegression = function() private$..coxRegression$value,
        multivariateAdjustment = function() private$..multivariateAdjustment$value,
        kaplanMeierPlots = function() private$..kaplanMeierPlots$value,
        landmarkAnalysis = function() private$..landmarkAnalysis$value,
        landmarkTime = function() private$..landmarkTime$value,
        confidenceLevel = function() private$..confidenceLevel$value),
    private = list(
        ..markers = NA,
        ..survivalTime = NA,
        ..survivalEvent = NA,
        ..id = NA,
        ..prognosticClustering = NA,
        ..multiRegionAnalysis = NA,
        ..centralRegion = NA,
        ..invasiveRegion = NA,
        ..riskStratification = NA,
        ..coxRegression = NA,
        ..multivariateAdjustment = NA,
        ..kaplanMeierPlots = NA,
        ..landmarkAnalysis = NA,
        ..landmarkTime = NA,
        ..confidenceLevel = NA)
)

ihcsurvivalResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcsurvivalResults",
    inherit = jmvcore::Group,
    active = list(
        instructions = function() private$.items[["instructions"]],
        prognosticGroups = function() private$.items[["prognosticGroups"]],
        coxResults = function() private$.items[["coxResults"]],
        multivariateResults = function() private$.items[["multivariateResults"]],
        regionalComparison = function() private$.items[["regionalComparison"]],
        landmarkResults = function() private$.items[["landmarkResults"]],
        modelFit = function() private$.items[["modelFit"]],
        kaplanMeierPlot = function() private$.items[["kaplanMeierPlot"]],
        hazardPlot = function() private$.items[["hazardPlot"]],
        riskScorePlot = function() private$.items[["riskScorePlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="IHC Survival Analysis",
                refs=list(
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="instructions",
                title="Survival Analysis Overview",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="prognosticGroups",
                title="Prognostic Group Summary",
                visible="(prognosticClustering)",
                clearWith=list(
                    "markers",
                    "survivalTime",
                    "survivalEvent",
                    "riskStratification"),
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Risk Group", 
                        `type`="text"),
                    list(
                        `name`="n", 
                        `title`="N", 
                        `type`="integer"),
                    list(
                        `name`="events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="median_survival", 
                        `title`="Median Survival", 
                        `type`="number", 
                        `format`="zto:1"),
                    list(
                        `name`="survival_95ci", 
                        `title`="95% CI", 
                        `type`="text"),
                    list(
                        `name`="pattern", 
                        `title`="IHC Pattern", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="coxResults",
                title="Cox Regression Results",
                visible="(coxRegression)",
                clearWith=list(
                    "markers",
                    "survivalTime",
                    "survivalEvent"),
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="hazard_ratio", 
                        `title`="Hazard Ratio", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="hr_95ci", 
                        `title`="95% CI", 
                        `type`="text"),
                    list(
                        `name`="p_value", 
                        `title`="P-value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="significance", 
                        `title`="Sig.", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="multivariateResults",
                title="Multivariate Cox Analysis",
                visible="(multivariateAdjustment)",
                clearWith=list(
                    "markers",
                    "survivalTime",
                    "survivalEvent",
                    "multivariateAdjustment"),
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="hazard_ratio", 
                        `title`="Adjusted HR", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="hr_95ci", 
                        `title`="95% CI", 
                        `type`="text"),
                    list(
                        `name`="p_value", 
                        `title`="P-value", 
                        `type`="number", 
                        `format`="zto:4"),
                    list(
                        `name`="significance", 
                        `title`="Sig.", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="regionalComparison",
                title="Central vs Invasive Region Analysis",
                visible="(multiRegionAnalysis)",
                clearWith=list(
                    "centralRegion",
                    "invasiveRegion",
                    "survivalTime",
                    "survivalEvent"),
                columns=list(
                    list(
                        `name`="marker", 
                        `title`="Marker", 
                        `type`="text"),
                    list(
                        `name`="central_hr", 
                        `title`="Central HR", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="invasive_hr", 
                        `title`="Invasive HR", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="concordance", 
                        `title`="Concordance", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="better_region", 
                        `title`="Better Predictor", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="landmarkResults",
                title="Landmark Analysis Results",
                visible="(landmarkAnalysis)",
                clearWith=list(
                    "markers",
                    "survivalTime",
                    "survivalEvent",
                    "landmarkTime"),
                columns=list(
                    list(
                        `name`="group", 
                        `title`="Risk Group", 
                        `type`="text"),
                    list(
                        `name`="at_risk", 
                        `title`="At Risk", 
                        `type`="integer"),
                    list(
                        `name`="survival_prob", 
                        `title`="Survival Probability", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="survival_95ci", 
                        `title`="95% CI", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelFit",
                title="Model Performance",
                visible="(coxRegression)",
                clearWith=list(
                    "markers",
                    "survivalTime",
                    "survivalEvent"),
                columns=list(
                    list(
                        `name`="metric", 
                        `title`="Metric", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="number", 
                        `format`="zto:3"),
                    list(
                        `name`="interpretation", 
                        `title`="Interpretation", 
                        `type`="text"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="kaplanMeierPlot",
                title="Kaplan-Meier Survival Curves",
                visible="(kaplanMeierPlots)",
                renderFun=".plotKaplanMeier",
                clearWith=list(
                    "markers",
                    "survivalTime",
                    "survivalEvent",
                    "riskStratification"),
                width=800,
                height=600))
            self$add(jmvcore::Image$new(
                options=options,
                name="hazardPlot",
                title="Hazard Ratio Forest Plot",
                visible="(coxRegression)",
                renderFun=".plotHazardRatios",
                clearWith=list(
                    "markers",
                    "survivalTime",
                    "survivalEvent"),
                width=800,
                height=500))
            self$add(jmvcore::Image$new(
                options=options,
                name="riskScorePlot",
                title="Risk Score Distribution",
                visible="(prognosticClustering)",
                renderFun=".plotRiskScores",
                clearWith=list(
                    "markers",
                    "survivalTime",
                    "survivalEvent"),
                width=700,
                height=500))}))

ihcsurvivalBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "ihcsurvivalBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "ihcsurvival",
                version = c(1,0,0),
                options = options,
                results = ihcsurvivalResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' IHC Survival Analysis
#'
#' Survival analysis and prognostic clustering using IHC markers. Designed for 
#' prognostic biomarker discovery and risk stratification.
#' 
#'
#' @examples
#' data \%>\%
#' ihcsurvival(
#'     markers = c("ER", "PR", "HER2", "Ki67"),
#'     survivalTime = "os_months",
#'     survivalEvent = "death",
#'     prognosticClustering = TRUE
#' )
#'
#' @param data the data as a data frame
#' @param markers IHC marker variables for prognostic analysis
#' @param survivalTime Time to event variable (months, years, days)
#' @param survivalEvent Event indicator (1=event, 0=censored)
#' @param id Case identifier for tracking
#' @param prognosticClustering Perform clustering optimized for survival
#'   outcomes
#' @param multiRegionAnalysis Compare central vs invasive tumor regions
#' @param centralRegion IHC markers from central tumor region
#' @param invasiveRegion IHC markers from invasive tumor region
#' @param riskStratification Method for creating prognostic risk groups
#' @param coxRegression Perform Cox proportional hazards regression
#' @param multivariateAdjustment Clinical variables for multivariate
#'   adjustment
#' @param kaplanMeierPlots Generate survival curves for risk groups
#' @param landmarkAnalysis Perform landmark survival analysis at specific time
#'   points
#' @param landmarkTime Time point for landmark analysis (same units as
#'   survival time)
#' @param confidenceLevel Confidence level for survival estimates and hazard
#'   ratios
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$instructions} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$prognosticGroups} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$coxResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$multivariateResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$regionalComparison} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$landmarkResults} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$modelFit} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$kaplanMeierPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$hazardPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$riskScorePlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$prognosticGroups$asDF}
#'
#' \code{as.data.frame(results$prognosticGroups)}
#'
#' @export
ihcsurvival <- function(
    data,
    markers,
    survivalTime,
    survivalEvent,
    id = NULL,
    prognosticClustering = TRUE,
    multiRegionAnalysis = FALSE,
    centralRegion,
    invasiveRegion,
    riskStratification = "tertiles",
    coxRegression = TRUE,
    multivariateAdjustment,
    kaplanMeierPlots = TRUE,
    landmarkAnalysis = FALSE,
    landmarkTime = 60,
    confidenceLevel = 0.95) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("ihcsurvival requires jmvcore to be installed (restart may be required)")

    if ( ! missing(markers)) markers <- jmvcore::resolveQuo(jmvcore::enquo(markers))
    if ( ! missing(survivalTime)) survivalTime <- jmvcore::resolveQuo(jmvcore::enquo(survivalTime))
    if ( ! missing(survivalEvent)) survivalEvent <- jmvcore::resolveQuo(jmvcore::enquo(survivalEvent))
    if ( ! missing(id)) id <- jmvcore::resolveQuo(jmvcore::enquo(id))
    if ( ! missing(centralRegion)) centralRegion <- jmvcore::resolveQuo(jmvcore::enquo(centralRegion))
    if ( ! missing(invasiveRegion)) invasiveRegion <- jmvcore::resolveQuo(jmvcore::enquo(invasiveRegion))
    if ( ! missing(multivariateAdjustment)) multivariateAdjustment <- jmvcore::resolveQuo(jmvcore::enquo(multivariateAdjustment))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(markers), markers, NULL),
            `if`( ! missing(survivalTime), survivalTime, NULL),
            `if`( ! missing(survivalEvent), survivalEvent, NULL),
            `if`( ! missing(id), id, NULL),
            `if`( ! missing(centralRegion), centralRegion, NULL),
            `if`( ! missing(invasiveRegion), invasiveRegion, NULL),
            `if`( ! missing(multivariateAdjustment), multivariateAdjustment, NULL))


    options <- ihcsurvivalOptions$new(
        markers = markers,
        survivalTime = survivalTime,
        survivalEvent = survivalEvent,
        id = id,
        prognosticClustering = prognosticClustering,
        multiRegionAnalysis = multiRegionAnalysis,
        centralRegion = centralRegion,
        invasiveRegion = invasiveRegion,
        riskStratification = riskStratification,
        coxRegression = coxRegression,
        multivariateAdjustment = multivariateAdjustment,
        kaplanMeierPlots = kaplanMeierPlots,
        landmarkAnalysis = landmarkAnalysis,
        landmarkTime = landmarkTime,
        confidenceLevel = confidenceLevel)

    analysis <- ihcsurvivalClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

