---
name: pathsampling
title: Pathology Sampling Adequacy Analysis
jrs: '1.1'

items:
    # === WELCOME & DATA SUMMARY (Always First) ===
    - name: welcome
      title: ''
      type: Html
      visible: (is.null(totalSamples) || is.null(firstDetection))

    # === DISPLAY OPTIONS: INSTRUCTIONS ===
    - name: guidedInstructions
      title: Quick Start Checklist
      type: Html
      visible: (showGuidedInstructions)

    - name: conciseInstructions
      title: Analysis Overview
      type: Html
      visible: (showConciseInstructions)



    - name: dataInfo
      title: Data Summary
      type: Table
      clearWith:
        - totalSamples
        - firstDetection
      columns:
        - name: measure
          title: Measure
          type: text
        - name: value
          title: Value
          type: text





    # === DISPLAY OPTIONS: SPECIFIC TEXT OUTPUTS ===
    - name: probabilityExplanation
      title: Understanding Detection Probabilities
      type: Html
      visible: (showProbabilityExplanation)

    - name: keyResults
      title: Key Results Summary
      type: Html
      visible: (showKeyResults)

    # === CORE ANALYSES: CLINICAL SUMMARY ===
    - name: clinicalSummary
      title: Clinical Summary
      type: Html
      visible: (showClinicalSummary)

    # === CORE ANALYSES: BINOMIAL MODEL ===
    - name: binomialText
      title: Binomial Probability Model
      type: Html
      visible: (showBinomialModel)

    - name: binomialTable
      title: Binomial Model Predictions
      type: Table
      visible: (showBinomialModel)
      clearWith:
        - totalSamples
        - firstDetection
        - maxSamples
      columns:
        - name: nSamples
          title: 'Number of Samples'
          type: integer
        - name: cumProb
          title: 'Cumulative Detection Probability'
          type: number
          format: 'pc'
        - name: marginalGain
          title: 'Marginal Gain'
          type: number
          format: 'pc'

    - name: recommendTable
      title: Minimum Samples for Target Confidence
      type: Table
      visible: (showBinomialModel)
      clearWith:
        - totalSamples
        - firstDetection
        - targetConfidence
      columns:
        - name: confidence
          title: 'Target Confidence'
          type: number
          format: 'pc'
        - name: minSamples
          title: 'Minimum Samples Required'
          type: integer

    # === CORE ANALYSES: BOOTSTRAP ===
    - name: bootstrapText
      title: Bootstrap Resampling Analysis
      type: Html
      visible: (showBootstrap)

    - name: bootstrapTable
      title: Bootstrap Sensitivity Estimates
      type: Table
      visible: (showBootstrap)
      clearWith:
        - totalSamples
        - firstDetection
        - maxSamples
        - bootstrapIterations
      columns:
        - name: nSamples
          title: 'Number of Samples'
          type: integer
        - name: meanSens
          title: 'Mean Sensitivity'
          type: number
          format: 'pc'
        - name: ciLower
          title: '95% CI Lower'
          type: number
          format: 'pc'
        - name: ciUpper
          title: '95% CI Upper'
          type: number
          format: 'pc'

    # === CORE ANALYSES: DETECTION CURVE ===
    - name: detectionCurve
      title: Diagnostic Yield Curve
      type: Image
      width: 600
      height: 450
      renderFun: .detectionCurve
      visible: (showDetectionCurve)

    # === CORE ANALYSES: SENSITIVITY CI ===
    - name: sensitivityPlot
      title: Sensitivity with Confidence Intervals
      type: Image
      width: 600
      height: 450
      renderFun: .sensitivityPlot
      visible: (showSensitivityCI && showBootstrap)

    # === ENHANCED DETECTION: EMPIRICAL CUMULATIVE ===
    - name: empiricalCumulativeText
      title: Empirical Cumulative Detection Analysis
      type: Html
      visible: (showEmpiricalCumulative)

    - name: empiricalCumulativeTable
      title: Empirical Detection Rates by Sample Threshold
      type: Table
      visible: (showEmpiricalCumulative)
      clearWith:
        - totalSamples
        - firstDetection
        - positiveCount
      columns:
        - name: nSamples
          title: 'Samples Examined'
          type: integer
        - name: cumDetection
          title: 'Cumulative Detection'
          type: number
          format: 'pc'
        - name: ciLower
          title: '95% CI Lower'
          type: number
          format: 'pc'
        - name: ciUpper
          title: '95% CI Upper'
          type: number
          format: 'pc'
        - name: incrementalYield
          title: 'Incremental Yield'
          type: number
          format: 'pc'

    - name: empiricalCumulativePlot
      title: Empirical Cumulative Detection Curve
      type: Image
      width: 600
      height: 450
      renderFun: .empiricalCumulativePlot
      visible: (showEmpiricalCumulative)

    # === ENHANCED DETECTION: INCREMENTAL YIELD ===
    - name: incrementalYieldText
      title: Incremental Diagnostic Yield Analysis
      type: Html
      visible: (showIncrementalYield)

    - name: incrementalYieldTable
      title: Marginal Benefit per Additional Sample
      type: Table
      visible: (showIncrementalYield)
      clearWith:
        - totalSamples
        - firstDetection
        - maxSamples
      columns:
        - name: fromSamples
          title: 'From N Samples'
          type: integer
        - name: toSamples
          title: 'To N+1 Samples'
          type: integer
        - name: incrementalDetection
          title: 'Additional Detection Rate'
          type: number
          format: 'pc'
        - name: casesDetected
          title: 'Additional Cases per 100'
          type: number
        - name: costBenefit
          title: 'Cost-Benefit Rating'
          type: text

    # === ENHANCED DETECTION: POPULATION DETECTION ===
    - name: populationDetectionText
      title: Population-Level Detection Rates
      type: Html
      visible: (showPopulationDetection)

    - name: populationDetectionTable
      title: Conditional vs Population Detection
      type: Table
      visible: (showPopulationDetection)
      clearWith:
        - totalSamples
        - firstDetection
        - maxSamples
      columns:
        - name: nSamples
          title: 'Samples'
          type: integer
        - name: prevalence
          title: 'Prevalence'
          type: number
          format: 'pc'
        - name: conditional
          title: 'Sensitivity (given present)'
          type: number
          format: 'pc'
        - name: population
          title: 'Detection Rate (overall)'
          type: number
          format: 'pc'

    # === SPATIAL & MULTIFOCAL: SPATIAL CLUSTERING ===
    - name: spatialClusteringText
      title: Spatial Clustering Analysis
      type: Html
      visible: (showSpatialClustering)

    - name: clusteringTable
      title: Spatial Distribution Patterns
      type: Table
      visible: (showSpatialClustering)
      clearWith:
        - totalSamples
        - positiveSamplesList
      columns:
        - name: pattern
          title: 'Pattern'
          type: text
        - name: count
          title: 'Cases'
          type: integer
        - name: percent
          title: 'Percentage'
          type: number
          format: 'pc'
        - name: meanClusterIndex
          title: 'Mean Clustering Index'
          type: number

    # === SPATIAL & MULTIFOCAL: MULTIFOCAL ANALYSIS ===
    - name: multifocalText
      title: Multifocal Detection Analysis
      type: Html
      visible: (showMultifocalAnalysis)

    - name: multifocalTable
      title: Number of Foci Distribution
      type: Table
      visible: (showMultifocalAnalysis)
      clearWith:
        - totalSamples
        - positiveSamplesList
      columns:
        - name: fociCount
          title: 'Number of Foci'
          type: text
        - name: cases
          title: 'Cases'
          type: integer
        - name: percent
          title: 'Percentage'
          type: number
          format: 'pc'
        - name: meanFirstDetection
          title: 'Mean First Detection'
          type: number

    # === STRATIFIED ANALYSES: BY SAMPLE TYPE ===
    - name: stratifiedText
      title: Stratified Analysis by Sample Type
      type: Html
      visible: (showStratifiedAnalysis)

    - name: prevalenceTable
      title: Prevalence by Sample Type
      type: Table
      visible: (showStratifiedAnalysis)
      clearWith:
        - sampleType
        - firstDetection
      columns:
        - name: sampleType
          title: 'Sample Type'
          type: text
        - name: totalCases
          title: 'Total Cases'
          type: integer
        - name: positiveCases
          title: 'Positive Cases'
          type: integer
        - name: prevalence
          title: 'Prevalence'
          type: number
          format: 'pc'
        - name: qEstimate
          title: 'q (per-sample prob)'
          type: number

    - name: stratifiedDetectionTable
      title: Detection Probability by Sample Type and Threshold
      type: Table
      visible: (showStratifiedAnalysis)
      clearWith:
        - sampleType
        - firstDetection
        - maxSamples
      columns:
        - name: sampleType
          title: 'Sample Type'
          type: text
        - name: nSamples
          title: 'Samples'
          type: integer
        - name: conditionalDetection
          title: 'P(detect | present)'
          type: number
          format: 'pc'
        - name: populationDetection
          title: 'P(detect overall)'
          type: number
          format: 'pc'

    # === TUMOR BURDEN & STAGE MIGRATION: TUMOR BURDEN ===
    - name: tumorBurdenText
      title: Tumor Burden Analysis
      type: Html
      visible: (showTumorBurden)

    - name: tumorBurdenInfo
      title: Cassette Positivity Statistics
      type: Table
      visible: (showTumorBurden)
      clearWith:
        - totalSamples
        - firstDetection
        - positiveCassettes
      columns:
        - name: measure
          title: Measure
          type: text
        - name: value
          title: Value
          type: text

    - name: cassetteDistribution
      title: Tumor Distribution Pattern
      type: Table
      visible: (showTumorBurden)
      clearWith:
        - totalSamples
        - firstDetection
        - positiveCassettes
      columns:
        - name: pattern
          title: Pattern
          type: text
        - name: count
          title: Cases
          type: integer
        - name: percent
          title: Percentage
          type: number
          format: 'pc'

    # === TUMOR BURDEN & STAGE MIGRATION: STAGE MIGRATION ===
    - name: stageMigrationText
      title: Stage Migration Analysis
      type: Html
      visible: (showStageMigration)

    - name: stageMigrationTable
      title: Detection Rates by Cassette Groups
      type: Table
      visible: (showStageMigration)
      clearWith:
        - totalSamples
        - firstDetection
        - positiveCassettes
      columns:
        - name: cassettes
          title: 'Cassettes Examined'
          type: text
        - name: nCases
          title: 'Cases'
          type: integer
        - name: nPositive
          title: 'Positive Cases'
          type: integer
        - name: positivityRate
          title: 'Positivity Rate'
          type: number
          format: 'pc'

    # === TUMOR BURDEN & STAGE MIGRATION: CORRELATION ===
    - name: correlationText
      title: Examined vs Positive Correlation
      type: Html
      visible: (showCorrelation)

    - name: correlationStats
      title: Correlation Statistics
      type: Table
      visible: (showCorrelation)
      clearWith:
        - totalSamples
        - firstDetection
        - positiveCassettes
      columns:
        - name: statistic
          title: Statistic
          type: text
        - name: value
          title: Value
          type: text

    - name: correlationPlot
      title: Examined vs Positive Cassettes
      type: Image
      width: 600
      height: 450
      renderFun: .correlationPlot
      visible: (showCorrelation)

    # === TUMOR BURDEN & STAGE MIGRATION: DISTRIBUTION PATTERN ===
    - name: distributionPatternText
      title: Distribution Pattern Analysis (Single vs Summed)
      type: Html
      visible: (showDistributionPattern)

    - name: distributionPatternTable
      title: Distribution Pattern Classification
      type: Table
      visible: (showDistributionPattern)
      clearWith:
        - totalSamples
        - firstDetection
        - positiveCassettes
        - maxPositiveSingle
        - distributionThreshold
      columns:
        - name: pattern
          title: Distribution Pattern
          type: text
        - name: count
          title: Cases
          type: integer
        - name: percent
          title: Percentage
          type: number
          format: 'pc'

    - name: distributionComparisonTable
      title: Single vs Summed Comparison
      type: Table
      visible: (showDistributionPattern)
      clearWith:
        - totalSamples
        - firstDetection
        - positiveCassettes
        - maxPositiveSingle
        - distributionThreshold
      columns:
        - name: measure
          title: Measure
          type: text
        - name: value
          title: Value
          type: text

    # === SPECIALIZED MODELS: HYPERGEOMETRIC ===
    - name: hypergeometricText
      title: Hypergeometric Probability Model
      type: Html
      visible: (showHypergeometric)

    - name: hypergeometricTable
      title: Hypergeometric Model Predictions
      type: Table
      visible: (showHypergeometric)
      clearWith:
        - totalPopulation
        - successStates
        - targetDetections
        - maxSamples
      columns:
        - name: nSamples
          title: 'Number of Samples'
          type: integer
        - name: cumProb
          title: 'P(detect ≥k)'
          type: number
          format: 'pc'
        - name: marginalGain
          title: 'Marginal Gain'
          type: number
          format: 'pc'

    - name: hyperRecommendTable
      title: Minimum Samples for Target Confidence (Hypergeometric)
      type: Table
      visible: (showHypergeometric)
      clearWith:
        - totalPopulation
        - successStates
        - targetDetections
        - targetConfidence
      columns:
        - name: confidence
          title: 'Target Confidence'
          type: number
          format: 'pc'
        - name: minSamples
          title: 'Minimum Samples Required'
          type: integer
        - name: expectedYield
          title: 'Expected Detections'
          type: number

    # === SPECIALIZED MODELS: BETA-BINOMIAL ===
    - name: betaBinomialText
      title: Beta-Binomial Probability Model
      type: Html
      visible: (showBetaBinomial)

    - name: betaBinomialTable
      title: Beta-Binomial Model Predictions
      type: Table
      visible: (showBetaBinomial)
      clearWith:
        - totalPopulation
        - successStates
        - maxSamples
      columns:
        - name: nSamples
          title: 'Number of Samples'
          type: integer
        - name: cumProb
          title: 'P(detect ≥k)'
          type: number
          format: 'pc'
        - name: marginalGain
          title: 'Marginal Gain'
          type: number
          format: 'pc'

    - name: betaBinomialRecommendTable
      title: Minimum Samples for Target Confidence (Beta-Binomial)
      type: Table
      visible: (showBetaBinomial)
      clearWith:
        - totalPopulation
        - successStates
        - targetConfidence
      columns:
        - name: confidence
          title: 'Target Confidence'
          type: number
          format: 'pc'
        - name: minSamples
          title: 'Minimum Samples Required'
          type: integer
        - name: expectedYield
          title: 'Expected Detections'
          type: number

    # === SPECIALIZED MODELS: LYMPH NODE ANALYSIS ===
    - name: lnAnalysisText
      title: Lymph Node Ratio and Staging Analysis
      type: Html
      visible: (showLNAnalysis)

    - name: lnrClassification
      title: Lymph Node Ratio Classification
      type: Table
      visible: (showLNAnalysis)
      clearWith:
        - totalPopulation
        - metastaticLN
        - lnrThreshold1
        - lnrThreshold2
      columns:
        - name: lnrStage
          title: 'LNR Stage'
          type: text
        - name: lnrRange
          title: 'LNR Range'
          type: text
        - name: cases
          title: 'Cases'
          type: integer
        - name: percent
          title: 'Percentage'
          type: number
          format: 'pc'
        - name: medianELN
          title: 'Median ELN'
          type: number

    - name: ajccNStage
      title: AJCC N Stage Distribution
      type: Table
      visible: (showLNAnalysis)
      clearWith:
        - metastaticLN
      columns:
        - name: nStage
          title: 'N Stage'
          type: text
        - name: criteria
          title: 'Criteria'
          type: text
        - name: cases
          title: 'Cases'
          type: integer
        - name: percent
          title: 'Percentage'
          type: number
          format: 'pc'
        - name: medianELN
          title: 'Median ELN'
          type: number

    - name: adequacyByELN
      title: Adequacy Assessment by ELN Thresholds
      type: Table
      visible: (showLNAnalysis)
      clearWith:
        - totalPopulation
        - metastaticLN
      columns:
        - name: elnGroup
          title: 'ELN Group'
          type: text
        - name: cases
          title: 'Cases'
          type: integer
        - name: percent
          title: 'Percentage'
          type: number
          format: 'pc'
        - name: nPositive
          title: 'N+ Cases'
          type: integer
        - name: comment
          title: 'Adequacy Comment'
          type: text

    # === SPECIALIZED MODELS: EFFECT SIZES ===
    - name: effectSizesText
      title: Effect Size Measures
      type: Html
      visible: (showEffectSizes)

    - name: effectSizesTable
      title: Effect Size Statistics
      type: Table
      visible: (showEffectSizes)
      clearWith:
        - totalPopulation
        - metastaticLN
      columns:
        - name: measure
          title: 'Measure'
          type: text
        - name: value
          title: 'Value'
          type: text
        - name: interpretation
          title: 'Interpretation'
          type: text

    # === SPECIALIZED MODELS: OMENTUM ANALYSIS ===
    - name: omentumText
      title: Omentum Sampling Literature
      type: Html
      visible: (showOmentumAnalysis)

    # === DISPLAY OPTIONS: INTERPRETATION & RECOMMENDATIONS ===
    - name: recommendText
      title: Clinical Recommendations
      type: Html
      visible: (showRecommendText)

    - name: interpretText
      title: Statistical Interpretation
      type: Html
      visible: (showInterpretText)

    - name: referencesText
      title: Statistical Methods & References
      type: Html
      visible: (showReferencesText)
