---
name: enhancedROC
title: Clinical ROC Analysis
menuGroup: meddecide
menuSubgroup: ROC
menuSubtitle: "Clinical ROC analysis with diagnostic metrics and optimal cutoffs"
version: '0.0.32'
jas: '1.2'

description:
    main: |
        Clinical ROC analysis toolkit for comprehensive diagnostic performance 
        evaluation. Includes ROC curve analysis, Youden Index optimization, 
        sensitivity/specificity analysis, optimal cutoff determination, and 
        comparative ROC analysis. Essential for biomarker validation, diagnostic
        test evaluation, and clinical decision support in medical research.

options:
    - name: data
      type: Data
      description:
          R: >
            The data as a data frame.

    - name: outcome
      title: 'Outcome Variable'
      type: Variable
      suggested:
          - nominal
          - ordinal
      permitted:
          - factor
          - numeric
      description: 'Binary outcome variable (disease status)'

    - name: positiveClass
      title: 'Positive Class'
      type: Level
      variable: (outcome)
      description: 'Select which level represents the positive class (disease/condition present)'

    - name: predictors
      title: 'Predictor Variables'
      type: Variables
      suggested:
          - continuous
      permitted:
          - numeric
      description: 'Numeric predictor variables for ROC analysis'

    - name: analysisType
      title: 'Analysis Type'
      type: List
      options:
          - title: 'Single ROC Analysis'
            name: single
          - title: 'Comparative ROC Analysis'
            name: comparative
          - title: 'Comprehensive Diagnostic Performance'
            name: comprehensive
      default: single
      description: 'Type of ROC analysis to perform'

    - name: direction
      title: 'Direction'
      type: List
      options:
          - title: 'Auto (determine automatically)'
            name: auto
          - title: 'Higher values indicate positive outcome'
            name: higher
          - title: 'Lower values indicate positive outcome'
            name: lower
      default: auto
      description: 'Direction of the predictor-outcome relationship'

    # Youden Index Options
    - name: youdenOptimization
      title: 'Youden Index Optimization'
      type: Bool
      default: false
      description: 'Find optimal cutoff using Youden Index (Sensitivity + Specificity - 1)'

    - name: customCutoffs
      title: 'Custom Cutoffs'
      type: String
      description: 'Comma-separated list of custom cutoffs to evaluate (e.g., 0.1, 0.5, 0.9)'

    - name: sensitivityThreshold
      title: 'Sensitivity Threshold'
      type: Number
      default: 0.8
      min: 0.1
      max: 1.0
      description: 'Minimum required sensitivity for screening applications'

    - name: specificityThreshold
      title: 'Specificity Threshold' 
      type: Number
      default: 0.8
      min: 0.1
      max: 1.0
      description: 'Minimum required specificity for confirmatory testing'

    # Statistical Options
    - name: confidenceLevel
      title: 'Confidence Level'
      type: Number
      default: 95
      min: 50
      max: 99.9
      description: 'Confidence level for AUC confidence intervals'

    - name: bootstrapSamples
      title: 'Bootstrap Samples'
      type: Integer
      default: 1000
      min: 100
      max: 10000
      description: 'Number of bootstrap samples for confidence intervals'

    - name: useBootstrap
      title: 'Use Bootstrap'
      type: Bool
      default: false
      description: 'Use bootstrap methods for confidence intervals'

    - name: bootstrapMethod
      title: 'Bootstrap Method'
      type: List
      options:
          - title: 'Percentile Method'
            name: percentile
          - title: 'BCa (Bias-Corrected and Accelerated)'
            name: bca
          - title: 'Basic Bootstrap'
            name: basic
      default: bca
      description: 'Method for calculating bootstrap confidence intervals. BCa provides better coverage but requires more computation.'

    - name: bootstrapCutoffCI
      title: 'Bootstrap CI for Optimal Cutoff'
      type: Bool
      default: false
      description: 'Calculate bootstrap confidence intervals for sensitivity and specificity at optimal cutoff'

    - name: bootstrapPartialAUC
      title: 'Bootstrap CI for Partial AUC'
      type: Bool
      default: false
      description: 'Calculate bootstrap confidence intervals for partial AUC estimates'

    - name: stratifiedBootstrap
      title: 'Stratified Bootstrap'
      type: Bool
      default: false
      description: 'Maintain outcome class proportions in bootstrap samples (recommended for imbalanced data)'

    # Comparison Options
    - name: pairwiseComparisons
      title: 'Pairwise Comparisons'
      type: Bool
      default: false
      description: 'Perform pairwise comparisons between ROC curves'

    - name: comparisonMethod
      title: 'Comparison Method'
      type: List
      options:
          - title: 'DeLong et al. (1988)'
            name: delong
          - title: 'Bootstrap'
            name: bootstrap
          - title: 'Venkatraman (2000)'
            name: venkatraman
      default: delong
      description: 'Method for comparing ROC curves'

    # Output Options
    - name: rocCurve
      title: 'ROC Curve Plot'
      type: Bool
      default: false
      description: 'Display ROC curve plot'

    - name: aucTable
      title: 'AUC Summary Table'
      type: Bool
      default: false
      description: 'Display AUC summary table'

    - name: cutoffTable
      title: 'Cutoff Analysis Table'
      type: Bool
      default: false
      description: 'Display detailed cutoff analysis'

    - name: optimalCutoffs
      title: 'Optimal Cutoffs Summary'
      type: Bool
      default: false
      description: 'Display optimal cutoff summary'

    - name: diagnosticMetrics
      title: 'Diagnostic Metrics'
      type: Bool
      default: false
      description: 'Display comprehensive diagnostic metrics'

    - name: clinicalMetrics
      title: 'Clinical Metrics'
      type: Bool
      default: false
      description: 'Display clinical application metrics (PPV, NPV, LR+, LR-)'

    # Advanced Options
    - name: smoothMethod
      title: 'ROC Curve Smoothing'
      type: List
      options:
          - title: 'None'
            name: none
          - title: 'Binormal'
            name: binormal
          - title: 'Kernel'
            name: kernel
      default: none
      description: 'Method for smoothing ROC curves'

    - name: partialAuc
      title: 'Partial AUC Analysis'
      type: Bool
      default: false
      description: 'Calculate partial AUC for specific sensitivity/specificity ranges'

    - name: partialAucType
      title: 'Partial AUC Type'
      type: List
      options:
          - title: 'Specificity Range (for high-specificity applications)'
            name: specificity
          - title: 'Sensitivity Range (for high-sensitivity applications)'
            name: sensitivity
      default: specificity
      description: 'Whether to calculate pAUC over a specificity or sensitivity range'

    - name: partialRange
      title: 'Partial AUC Range'
      type: String
      default: '0.8,1.0'
      description: 'Range for partial AUC (min,max) - e.g., 0.8,1.0 for high specificity or sensitivity'

    # CROC Options
    - name: crocAnalysis
      title: 'CROC Analysis'
      type: Bool
      default: false
      description: 'Calculate Concentrated ROC curves for early retrieval analysis'

    - name: crocAlpha
      title: 'CROC Alpha Parameter'
      type: Number
      default: 7.0
      min: 1.0
      max: 20.0
      description: 'Concentration parameter for CROC exponential magnifier function'

    - name: convexHull
      title: 'ROC Convex Hull'
      type: Bool
      default: false
      description: 'Calculate ROC convex hull (optimal achievable performance)'

    - name: tiedScoreHandling
      title: 'Tied Score Handling'
      type: List
      options:
          - title: 'Average'
            name: average
          - title: 'Upper Bound'
            name: upper
          - title: 'Lower Bound'
            name: lower
      default: average
      description: 'Method for handling tied predictor scores in ROC calculation'

    # Imbalance Detection Options
    - name: detectImbalance
      title: 'Detect Class Imbalance'
      type: Bool
      default: false
      description: 'Automatically detect class imbalance and recommend PRC when appropriate'

    - name: imbalanceThreshold
      title: 'Imbalance Threshold'
      type: Number
      default: 3.0
      min: 1.5
      max: 10.0
      description: 'Ratio threshold for imbalance detection (e.g., 3.0 means 3:1 or 1:3 ratio)'

    - name: showImbalanceWarning
      title: 'Show Imbalance Warning'
      type: Bool
      default: false
      description: 'Display warning message when class imbalance is detected'

    - name: recommendPRC
      title: 'Recommend PRC for Imbalanced Data'
      type: Bool
      default: false
      description: 'Recommend using Precision-Recall curves when imbalance is detected'

    # Clinical Context
    - name: prevalence
      title: 'Disease Prevalence'
      type: Number
      default: 0.1
      min: 0.001
      max: 0.999
      description: 'Disease prevalence for calculating predictive values'

    - name: useObservedPrevalence
      title: 'Use Observed Prevalence'
      type: Bool
      default: false
      description: 'Use the prevalence observed in the data for PPV/NPV and clinical impact calculations (recommended)'

    - name: clinicalContext
      title: 'Clinical Context'
      type: List
      options:
          - title: 'Screening'
            name: screening
          - title: 'Diagnosis'
            name: diagnosis
          - title: 'Prognosis'
            name: prognosis
          - title: 'Monitoring'
            name: monitoring
          - title: 'General'
            name: general
      default: general
      description: 'Clinical application context for interpretation'

    - name: clinicalPresets
      title: 'Clinical Presets'
      type: List
      options:
          - title: 'Custom Configuration'
            name: custom
          - title: 'Biomarker Screening (High Sensitivity)'
            name: biomarker_screening
          - title: 'Diagnostic Test Validation (Balanced)'
            name: diagnostic_validation
          - title: 'Confirmatory Testing (High Specificity)'
            name: confirmatory_testing
          - title: 'Research Analysis (Comprehensive)'
            name: research_comprehensive
      default: custom
      description: 'Pre-configured settings for common clinical scenarios'

    # Advanced Output Options
    - name: comprehensive_output
      title: 'Comprehensive Statistical Output'
      type: Bool
      default: false
      description: 'Include comprehensive statistical details'

    - name: clinical_interpretation
      title: 'Clinical Interpretation'
      type: Bool
      default: false
      description: 'Provide clinical context for ROC analysis results'

    # Plotting Options
    - name: plotTheme
      title: 'Plot Theme'
      type: List
      options:
          - title: 'Classic'
            name: classic
          - title: 'Modern'
            name: modern
          - title: 'Clinical'
            name: clinical
      default: clinical
      description: 'Visual theme for ROC plots'

    - name: plotWidth
      title: 'Plot Width'
      type: Integer
      default: 600
      min: 300
      max: 1200
      description: 'Width of ROC plots'

    - name: plotHeight
      title: 'Plot Height'
      type: Integer
      default: 600
      min: 300
      max: 1200
      description: 'Height of ROC plots'

    - name: showCutoffPoints
      title: 'Show Cutoff Points'
      type: Bool
      default: false
      description: 'Highlight optimal cutoff points on ROC curve'

    - name: showConfidenceBands
      title: 'Show Confidence Bands'
      type: Bool
      default: false
      description: 'Display confidence bands around ROC curve'

    # Model Comparison Enhancements
    - name: showMetricsDiff
      title: 'Show Metrics Differences'
      type: Bool
      default: false
      description: 'Display detailed differences between model metrics'

    - name: statisticalComparison
      title: 'Statistical Model Comparison'
      type: Bool
      default: false
      description: 'Perform comprehensive statistical comparison between models'

    # Calibration Analysis Options
    - name: calibrationAnalysis
      title: 'Calibration Analysis'
      type: Bool
      default: false
      description: 'Assess calibration (agreement between observed and predicted probabilities)'

    - name: calibrationPlot
      title: 'Calibration Plot'
      type: Bool
      default: false
      description: 'Display calibration plot with loess smoothing'

    - name: hosmerLemeshow
      title: 'Hosmer-Lemeshow Test'
      type: Bool
      default: false
      description: 'Perform Hosmer-Lemeshow goodness-of-fit test'

    - name: hlGroups
      title: 'Hosmer-Lemeshow Groups'
      type: Integer
      default: 10
      min: 5
      max: 20
      description: 'Number of groups for Hosmer-Lemeshow test'

    - name: brierScore
      title: 'Brier Score'
      type: Bool
      default: false
      description: 'Calculate Brier score and scaled Brier score'

    - name: calibrationMetrics
      title: 'Calibration Metrics'
      type: Bool
      default: false
      description: 'Calculate calibration slope, intercept, and calibration-in-the-large'

    # Advanced Calibration Methods
    - name: splineCalibration
      title: 'Spline Calibration Curves'
      type: Bool
      default: false
      description: 'Use restricted cubic splines for flexible calibration curves'

    - name: splineKnots
      title: 'Number of Knots'
      type: Integer
      default: 4
      min: 3
      max: 7
      description: 'Number of knots for restricted cubic splines (3-7 recommended)'

    - name: eoRatio
      title: 'E/O Ratio'
      type: Bool
      default: false
      description: 'Calculate Expected/Observed ratio for overall calibration assessment'

    - name: namDagostino
      title: "Nam-D'Agostino Test"
      type: Bool
      default: false
      description: "Perform Nam-D'Agostino calibration test (more powerful than H-L)"

    - name: greenwoodNam
      title: "Greenwood-Nam-D'Agostino Test"
      type: Bool
      default: false
      description: "Greenwood-Nam-D'Agostino test for survival model calibration"

    - name: calibrationBelt
      title: 'Calibration Belt'
      type: Bool
      default: false
      description: 'Display calibration belt showing uncertainty around calibration curve'

    - name: calibrationDensity
      title: 'Calibration Density Plot'
      type: Bool
      default: false
      description: 'Show distribution of predicted probabilities as density overlay'

    # Multi-Class ROC Options
    - name: multiClassROC
      title: 'Multi-Class ROC Analysis'
      type: Bool
      default: false
      description: 'Enable multi-class ROC analysis for outcomes with >2 levels'

    - name: multiClassStrategy
      title: 'Multi-Class Strategy'
      type: List
      options:
          - title: 'One-vs-Rest (OVR)'
            name: ovr
          - title: 'One-vs-One (OVO)'
            name: ovo
      default: ovr
      description: 'Strategy for multi-class ROC analysis'

    - name: multiClassAveraging
      title: 'Multi-Class AUC Averaging'
      type: List
      options:
          - title: 'Macro Average (unweighted)'
            name: macro
          - title: 'Weighted Average (by prevalence)'
            name: weighted
      default: macro
      description: 'Method for averaging AUC across classes'

    # Time-Dependent ROC Options (NOT IMPLEMENTED - COMMENTED OUT)
    # - name: timeDependentROC
    #   title: 'Time-Dependent ROC'
    #   type: Bool
    #   default: false
    #   description: 'Enable time-dependent ROC analysis for survival/time-to-event outcomes'
    #
    # - name: timePoints
    #   title: 'Time Points'
    #   type: String
    #   default: '12,24,36'
    #   description: 'Comma-separated time points for time-dependent ROC (e.g., 12,24,36 months)'
    #
    # - name: tdRocMethod
    #   title: 'Time-Dependent ROC Method'
    #   type: List
    #   options:
    #       - title: 'Kaplan-Meier (KM)'
    #         name: km
    #       - title: 'Nearest Neighbor Estimation (NNE)'
    #         name: nne
    #       - title: 'Cox Model'
    #         name: cox
    #   default: km
    #   description: 'Method for estimating time-dependent ROC curves'

    # Clinical Impact Options
    - name: clinicalImpact
      title: 'Clinical Impact Analysis'
      type: Bool
      default: false
      description: 'Calculate clinical impact metrics (NNT, NND, clinical utility)'

    - name: nntCalculation
      title: 'Number Needed to Test/Treat'
      type: Bool
      default: false
      description: 'Calculate number needed to test and number needed to diagnose'

    - name: clinicalUtilityCurve
      title: 'Clinical Utility Curve'
      type: Bool
      default: false
      description: 'Display clinical utility curve showing test consequences'

    - name: decisionImpactTable
      title: 'Decision Impact Table'
      type: Bool
      default: false
      description: 'Show decision impact at various thresholds'

    # Survival ROC Enhancements (NOT IMPLEMENTED - COMMENTED OUT)
    # - name: survivalROC
    #   title: 'Survival ROC Analysis'
    #   type: Bool
    #   default: false
    #   description: 'Enable survival-specific ROC methods (requires time-to-event data)'

    - name: harrellCIndex
      title: "Harrell's C-Index"
      type: Bool
      default: false
      description: "Calculate Harrell's concordance index for time-to-event outcomes"

    - name: unoCStatistic
      title: "Uno's C-Statistic"
      type: Bool
      default: false
      description: "Calculate Uno's C-statistic (more robust to censoring)"

    - name: incidentDynamic
      title: 'Incident/Dynamic AUC'
      type: Bool
      default: false
      description: 'Calculate incident/dynamic AUC (sensitivity for events at specific time)'

    - name: cumulativeDynamic
      title: 'Cumulative/Dynamic AUC'
      type: Bool
      default: false
      description: 'Calculate cumulative/dynamic AUC (sensitivity for events by specific time)'

    - name: competingRisksConcordance
      title: 'Competing Risks Concordance'
      type: Bool
      default: false
      description: 'Calculate cause-specific concordance for competing risks'

    # Clinical Prediction Model Validation
    - name: internalValidation
      title: 'Internal Validation'
      type: Bool
      default: false
      description: 'Perform internal validation using cross-validation or bootstrap'

    - name: validationMethod
      title: 'Validation Method'
      type: List
      options:
          - title: 'Bootstrap Validation'
            name: bootstrap
          - title: 'Cross-Validation'
            name: cv
          - title: 'Both Methods'
            name: both
      default: bootstrap
      description: 'Method for internal validation'

    - name: optimismCorrection
      title: 'Optimism Correction'
      type: Bool
      default: false
      description: 'Apply optimism correction to performance metrics'

    - name: externalValidation
      title: 'External Validation Framework'
      type: Bool
      default: false
      description: 'Enable external validation reporting framework'

    - name: decisionImpactCurves
      title: 'Decision Impact Curves'
      type: Bool
      default: false
      description: 'Plot decision impact curves showing clinical consequences'

    - name: netBenefitRegression
      title: 'Net Benefit Regression'
      type: Bool
      default: false
      description: 'Model net benefit as function of threshold probabilities'

    - name: modelUpdating
      title: 'Model Updating Analysis'
      type: Bool
      default: false
      description: 'Analyze need for model recalibration or updating'

    - name: transportability
      title: 'Transportability Analysis'
      type: Bool
      default: false
      description: 'Assess model transportability across populations'

# Advanced analyses removed - can be added in future versions if needed
    # - name: effectSizeAnalysis
    # - name: powerAnalysis
