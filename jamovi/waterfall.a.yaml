---
name: waterfall
title: Treatment Response Analysis
menuGroup: OncoPath
menuSubgroup: 'Patient Follow-Up Plots'
menuSubtitle: 'Waterfall Plot, Spider Plot'
version: '0.0.31'
jas: '1.2'

description:
    main: >
        Creates waterfall and spider plots to analyze tumor response data following RECIST criteria.
        Supports both raw tumor measurements and pre-calculated percentage changes.
        Provides comprehensive response analysis including ORR, DCR, and person-time metrics.
    R:
        dontrun: true
        usage: |
            # Example 1: Percentage data
            data_pct <- data.frame(
                PatientID = paste0("PT", 1:5),
                Response = c(-60, -35, -10, 15, 45)
            )
            waterfall(
                data = data_pct,
                patientID = "PatientID",
                responseVar = "Response",
                inputType = "percentage"
            )
            
            # Example 2: Raw measurements
            data_raw <- data.frame(
                PatientID = rep(paste0("PT", 1:3), each = 3),
                Time = rep(c(0, 2, 4), 3),
                Measurement = c(50, 30, 25, 60, 45, 40, 55, 50, 48)
            )
            waterfall(
                data = data_raw,
                patientID = "PatientID",
                responseVar = "Measurement",
                timeVar = "Time",
                inputType = "raw"
            )

options:
    - name: data
      type: Data
      description:
          R: >
            The data as a data frame.
          jamovi: >
            The data as a data frame.

    - name: patientID
      title: Patient ID
      type: Variable
      suggested: [nominal]
      permitted: [numeric, factor, id]
      description:
          R: >
            Variable containing patient identifiers (e.g., PT001, Patient_1, Study_ID).
            Each patient should have a unique identifier for proper analysis.
          jamovi: >
            Variable containing patient identifiers (e.g., PT001, Patient_1, Study_ID).
            Each patient should have a unique identifier for proper analysis.

    - name: responseVar
      title: Response Value (Raw or Percentage)
      type: Variable
      suggested: [continuous]
      permitted: [numeric]
      description:
          R: >
            Response variable: either raw tumor measurements (mm, cm, sum of diameters) or
            pre-calculated percentage changes from baseline.
            For raw measurements: requires time variable with baseline at time = 0.
            For percentages: negative values = tumor shrinkage (good response),
            positive values = tumor growth (poor response). Example: -30 means 30% decrease.
          jamovi: >
            Response variable: tumor measurements or percentage changes from baseline.
            • Raw measurements: actual tumor sizes (mm, cm, sum of diameters)
            • Percentage changes: pre-calculated changes (-30 = 30% shrinkage = good response)
            Tip: Use percentage format if changes already calculated, raw format for actual measurements.


    - name: timeVar
      title: Time Variable (Required for Spider Plot)
      type: Variable
      suggested: [continuous]
      permitted: [numeric]
      default: NULL
      description:
          R: >
            Time point of measurement (e.g., months from baseline, days from treatment start).
            Required for spider plot and raw measurement processing. Baseline should be time = 0.
          jamovi: >
            Time point of measurement for tracking response over time.
            • Examples: months from baseline, weeks from treatment start
            • Required for: Spider plot visualization and raw measurement processing
            • Format: Baseline = 0, follow-up = positive numbers (1, 2, 3, etc.)
            Tip: Spider plots show treatment response trajectories over time.

    - name: groupVar
      title: Group Variable
      type: Variable
      suggested: [nominal, ordinal]
      permitted: [factor, numeric]
      default: NULL
      description:
          R: >
            Optional grouping variable for coloring bars by patient groups (e.g., treatment arms, disease subtypes).
            When specified, overrides RECIST category coloring to show group-based colors.
          jamovi: >
            Optional grouping variable for coloring bars by patient groups (e.g., treatment arms, disease subtypes).
            When specified, overrides RECIST category coloring to show group-based colors.


    - name: inputType
      title: Data Input Type
      type: List
      options:
        - title: "Percentage Changes"
          name: percentage
        - title: "Raw Measurements"
          name: raw
      default: percentage
      description:
          R: >
            Specify data format: 'raw' for actual tumor measurements (requires time variable)
            or 'percentage' for pre-calculated percentage changes from baseline
          jamovi: >
            Choose your data format:
            • Percentage Changes: Pre-calculated changes from baseline (-30 = 30% shrinkage)
            • Raw Measurements: Actual tumor sizes (requires Time Variable for baseline calculation)
            Most oncology studies use percentage changes. Use raw measurements only if you have
            actual tumor measurements and want automatic percentage calculation.


    - name: sortBy
      title: Sort By
      type: List
      options:
        - title: Best Response
          name: response
        - title: Patient ID
          name: id
      default: response
      description:
          R: >
            Sort the waterfall plot by best response or patient ID.
          jamovi: >
            Sort the waterfall plot by best response or patient ID.

    # Clinical Preset Options
    # - name: clinicalPreset
    #   title: Clinical Study Preset
    #   type: List
    #   options:
    #     - title: "Custom (Manual Settings)"
    #       name: custom
    #     - title: "Phase II Efficacy Study"
    #       name: phase2
    #     - title: "Phase I/II Dose Escalation"
    #       name: phase1_2
    #     - title: "Biomarker Correlation Study"
    #       name: biomarker
    #     - title: "Publication Ready"
    #       name: publication
    #   default: custom
    #   description:
    #       R: >
    #         Choose a clinical study preset to automatically configure appropriate settings
    #       jamovi: >
    #         Choose a preset configuration for your study type:
    #         • Custom: Manual control over all settings
    #         • Phase II: Standard efficacy analysis with ORR/DCR focus
    #         • Phase I/II: Safety and efficacy with detailed annotations
    #         • Biomarker: Group-based analysis with statistical comparisons
    #         • Publication: Clean, professional plots for manuscripts

    - name: showThresholds
      title: Show RECIST Thresholds
      type: Bool
      default: true
      description:
          R: >
            Show +20% and -30% RECIST v1.1 thresholds as dashed lines.
            Helps identify Progressive Disease (PD) and Partial Response (PR) cutoffs.
          jamovi: >
            Show RECIST v1.1 threshold lines on plots:
            • -30% line: Partial Response (PR) cutoff - tumor shrinkage threshold
            • +20% line: Progressive Disease (PD) cutoff - tumor growth threshold
            Recommended: Keep enabled for clinical interpretation

    - name: labelOutliers
      title: Label Large Changes
      type: Bool
      default: false
      description:
          R: >
            Label responses exceeding the specified threshold.
          jamovi: >
            Label responses exceeding the specified threshold.

    - name: showMedian
      title: Show Median Response
      type: Bool
      default: false
      description:
          R: >
            Show median response as a horizontal line.
          jamovi: >
            Show median response as a horizontal line.

    - name: showCI
      title: Show Confidence Interval
      type: Bool
      default: false
      description:
          R: >
            Show confidence interval around median response.
          jamovi: >
            Show confidence interval around median response.

    - name: minResponseForLabel
      title: Minimum Response for Labels (%)
      type: Number
      default: 50
      min: 0
      max: 100
      description:
          R: >
            Minimum response value for labels to be displayed.
          jamovi: >
            Minimum response value for labels to be displayed.


    - name: colorBy
      title: Color By
      type: List
      options:
        - title: RECIST Categories (CR/PR/SD/PD)
          name: recist
        - title: Patient Groups
          name: group
      default: recist
      description:
          R: >
            Coloring method: RECIST categories or patient groups (requires Group Variable).
          jamovi: >
            Coloring method: RECIST categories or patient groups (requires Group Variable).

    - name: colorScheme
      title: Color Scheme
      type: List
      options:
        - title: jamovi
          name: jamovi
        - title: RECIST (Red/Blue/Green)
          name: recist
        - title: Simple (Red/Green)
          name: simple
        - title: Colorful (Group Colors)
          name: colorful
        - title: Colorblind-Safe (Okabe–Ito)
          name: colorblind
      default: jamovi
      description:
          R: >
            Color scheme for waterfall plot. 'Colorful' provides distinct colors for group-based coloring.
          jamovi: >
            Color scheme for waterfall plot. 'Colorful' provides distinct colors for group-based coloring.


    - name: barAlpha
      title: Bar Transparency
      type: Number
      default: 1
      min: 0
      max: 1
      description:
          R: >
            Transparency of bars in waterfall plot.
          jamovi: >
            Transparency of bars in waterfall plot.

    - name: barWidth
      title: Bar Width
      type: Number
      default: 0.7
      min: 0.1
      max: 1
      description:
          R: >
            Width of bars in waterfall plot.
          jamovi: >
            Width of bars in waterfall plot.

    - name: showWaterfallPlot
      title: Show Waterfall Plot
      type: Bool
      default: true
      description:
          R: >
            Display the waterfall plot showing best response for each patient.
          jamovi: >
            Display the waterfall plot showing best response for each patient.

    - name: showSpiderPlot
      title: Show Spider Plot
      type: Bool
      default: true
      description:
          R: >
            Display spider plot showing response trajectories over time (requires time variable).
          jamovi: >
            Display spider plot showing response trajectories over time (requires time variable).

    - name: spiderColorBy
      title: Spider Plot Color By
      type: List
      options:
        - title: Response Status (Responder/Non-responder)
          name: response
        - title: Patient Groups
          name: group
      default: response
      description:
          R: >
            Coloring method for spider plot: Response status or patient groups.
            For backward compatibility, defaults to response status coloring.
          jamovi: >
            Coloring method for spider plot: Response status or patient groups.
            For backward compatibility, defaults to response status coloring.

    - name: spiderColorScheme
      title: Spider Plot Color Scheme
      type: List
      options:
        - title: Classic (Blue/Red)
          name: classic
        - title: jamovi Theme
          name: jamovi
        - title: Colorful (for groups)
          name: colorful
        - title: Colorblind-Safe (Okabe–Ito)
          name: colorblind
      default: classic
      description:
          R: >
            Color scheme for spider plot lines and points.
          jamovi: >
            Color scheme for spider plot lines and points.

    - name: timeUnitLabel
      title: Spider Plot Time Unit Label
      type: List
      options:
        - title: Generic (Time)
          name: generic
        - title: Days
          name: days
        - title: Weeks
          name: weeks
        - title: Months
          name: months
        - title: Years
          name: years
      default: generic
      description:
          R: >
            Label to use for the spider plot time axis. Does not rescale data; only affects axis labeling.
          jamovi: >
            Choose the time unit label for the spider plot x-axis (for display only). Does not change your data values.

    # Clinical Reporting Options
    - name: generateCopyReadyReport
      title: Generate Copy-Ready Report
      type: Bool
      default: false
      description:
          R: >
            Generate publication-ready result sentences with statistical details
          jamovi: >
            Generate copy-ready sentences for manuscripts and reports:
            • Auto-filled with your results (ORR, DCR, confidence intervals)
            • Publication-ready language following oncology standards
            • Copy-paste directly into manuscripts or clinical reports
            Recommended for publication or clinical documentation

    - name: showClinicalSignificance
      title: Show Clinical Significance Thresholds
      type: Bool
      default: false
      description:
          R: >
            Display clinical significance interpretations for ORR and DCR
          jamovi: >
            Add clinical significance context to results:
            • ORR thresholds: <15% (low), 15-30% (moderate), >30% (promising)
            • DCR interpretations with clinical relevance
            • Sample size adequacy assessment
            Helps interpret results in clinical context

    - name: showConfidenceIntervals
      title: Show Confidence Intervals for Clinical Metrics
      type: Bool
      default: true
      description:
          R: >
            Calculate and display exact binomial confidence intervals for ORR and DCR
          jamovi: >
            Add statistical confidence intervals to clinical metrics:
            • Exact binomial CIs for ORR and DCR (more accurate than normal approximation)
            • Helps assess precision of response rate estimates
            • Essential for clinical trial reporting
            Recommended: Keep enabled for statistical rigor

    - name: enableGuidedMode
      title: Enable Guided Analysis Mode
      type: Bool
      default: false
      description:
          R: >
            Enable step-by-step guidance for new users
          jamovi: >
            Enable guided mode with step-by-step instructions:
            • Walks through variable selection and options
            • Provides contextual help and best practice recommendations
            • Includes misuse detection and warnings
            Recommended for new users or complex analyses

    - name: addResponseCategory
      title: Add Response Category to Data
      type: Output
      description:
          R: >
            Add a new variable to the data frame indicating response category (CR/PR/SD/PD).
          jamovi: >
            Add RECIST response categories (CR/PR/SD/PD) as a new variable to your dataset.



...
