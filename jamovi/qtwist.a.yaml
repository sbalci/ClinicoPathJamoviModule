---
name: qtwist
title: Q-TWiST Analysis
menuGroup: OncoPathT2
menuSubgroup: Quality-Adjusted Survival
menuSubtitle: Quality-adjusted Time Without Symptoms or Toxicity
version: '0.0.1'
jas: '1.2'

description:
    main: >-
        Performs Q-TWiST (Quality-adjusted Time Without Symptoms or Toxicity) analysis
        to compare treatments while accounting for both quantity and quality of survival time.
        Particularly valuable in oncology trials where treatments may extend survival but
        with significant toxicity or disease symptoms.

        **What Q-TWiST Does:**
        Partitions overall survival into three health states with different quality-of-life weights:
        - TOX: Time with treatment toxicity (typically μ = 0-0.5)
        - TWiST: Time without symptoms or toxicity (μ = 1.0, perfect health)
        - REL: Time after disease relapse/progression (typically μ = 0-0.5)

        **Key Features:**
        - State-based survival partitioning with clinical significance
        - Utility weight application for quality adjustment
        - Sensitivity analysis across utility values
        - Bootstrap confidence intervals for treatment differences
        - Visual comparison with partitioned survival plots

        **Clinical Applications:**
        - Adjuvant therapy evaluation (balancing toxicity vs. benefit)
        - Treatment comparison when survival similar but quality differs
        - Shared decision-making (patient-relevant quality metrics)
        - Regulatory submissions (FDA/EMA recognized endpoint)

    R:
        dontrun: false
        usage: |
            # Load example data
            data("qtwist_breast_cancer")

            # Example 1: Basic Q-TWiST Analysis
            qtwist(
                data = qtwist_breast_cancer,
                time_os = "overall_survival_months",
                event_os = "death_event",
                event_os_level = 1,
                time_pfs = "progression_free_months",
                event_pfs = "progression_event",
                event_pfs_level = 1,
                treatment = "treatment",
                toxicity_method = "fixed_window",
                toxicity_window = 3,
                tau = 24,
                utility_tox = 0.5,
                utility_twist = 1.0,
                utility_rel = 0.5
            )

            # Example 2: With Individual Toxicity Durations
            qtwist(
                data = qtwist_breast_cancer,
                time_os = "overall_survival_months",
                event_os = "death_event",
                time_pfs = "progression_free_months",
                event_pfs = "progression_event",
                treatment = "treatment",
                toxicity_method = "individual_duration",
                toxicity_duration_var = "toxicity_duration_months",
                tau = 24,
                sensitivity_analysis = TRUE,
                plot_partitioned_survival = TRUE,
                plot_sensitivity = TRUE
            )

options:
    - name: data
      type: Data
      description:
          R: >
            Dataset containing overall survival, progression-free survival,
            and toxicity information.

    # ========================================
    # Overall Survival (OS) Variables
    # ========================================
    - name: time_os
      title: 'Overall Survival Time'
      type: Variable
      suggested: [continuous]
      permitted: [numeric]
      description: >-
        Time to death or censoring in consistent units (months recommended).
        This represents the total follow-up time from randomization/enrollment.

    - name: event_os
      title: 'Overall Survival Event'
      type: Variable
      suggested: [ordinal, nominal, continuous]
      permitted: [factor, numeric]
      description: >-
        Event indicator for overall survival. Can be numeric (1=death, 0=censored)
        or factor (specify death level below).

    - name: event_os_level
      title: 'Death Event Level'
      type: Level
      variable: (event_os)
      description: >-
        The level indicating death when using factor variables (e.g., "Dead", "Deceased").
        If numeric, use level "1" for death.

    # ========================================
    # Progression-Free Survival (PFS) Variables
    # ========================================
    - name: time_pfs
      title: 'Progression-Free Survival Time'
      type: Variable
      suggested: [continuous]
      permitted: [numeric]
      description: >-
        Time to disease progression, relapse, or death (whichever comes first).
        Must be in the same units as overall survival time.
        PFS time should be ≤ OS time for each patient.

    - name: event_pfs
      title: 'PFS Event Indicator'
      type: Variable
      suggested: [ordinal, nominal, continuous]
      permitted: [factor, numeric]
      description: >-
        Event indicator for progression-free survival.
        1 = progression or death, 0 = censored (or specify factor level).

    - name: event_pfs_level
      title: 'Progression/Death Event Level'
      type: Level
      variable: (event_pfs)
      description: >-
        The level indicating progression or death when using factor variables.

    # ========================================
    # Treatment/Group Comparison
    # ========================================
    - name: treatment
      title: 'Treatment Variable'
      type: Variable
      suggested: [ordinal, nominal]
      permitted: [factor]
      description: >-
        Treatment or group variable for comparison. Q-TWiST analysis
        requires exactly 2 treatment groups for comparison. The analysis
        will use all available levels (must be exactly 2 groups).

    # ========================================
    # Toxicity Definition
    # ========================================
    - name: toxicity_method
      title: 'Toxicity Assessment Method'
      type: List
      options:
        - title: "Fixed Time Window (e.g., first 3 months)"
          name: fixed_window
        - title: "Individual Toxicity Durations"
          name: individual_duration
        - title: "Time Period with Toxicity Events"
          name: time_period
      default: fixed_window
      description: >-
        Method for defining the toxicity (TOX) period in Q-TWiST analysis.
        Fixed window uses same period for all patients; individual duration
        allows patient-specific toxicity times.

    # Fixed Window Method
    - name: toxicity_window
      title: 'Toxicity Assessment Window (months)'
      type: Number
      default: 3.0
      min: 0.5
      max: 24.0
      description: >-
        Duration of toxicity assessment window in months (default: 3 months).
        Commonly used values: 3 months (1 treatment cycle), 6 months (adjuvant therapy).
        This defines the TOX period for all patients when using fixed window method.

    - name: toxicity_probability
      title: 'Probability of Grade 3-4 Toxicity'
      type: Number
      default: 0.5
      min: 0.0
      max: 1.0
      description: >-
        Proportion of patients experiencing grade 3-4 toxicity during the window.
        Used when toxicity indicator variable not provided. Can be estimated
        from pilot data or literature.

    # Individual Duration Method
    - name: toxicity_duration_var
      title: 'Toxicity Duration Variable'
      type: Variable
      suggested: [continuous]
      permitted: [numeric]
      description: >-
        Variable containing individual patient toxicity durations (in months).
        For patients without toxicity, use 0. For those with toxicity,
        specify duration of grade 3-4 adverse events.

    - name: toxicity_indicator_var
      title: 'Toxicity Indicator Variable (Optional)'
      type: Variable
      suggested: [ordinal, nominal, continuous]
      permitted: [factor, numeric]
      description: >-
        Optional binary indicator of whether patient experienced grade 3-4 toxicity.
        If provided, used to weight toxicity time calculations.

    - name: toxicity_indicator_level
      title: 'Toxicity Present Level'
      type: Level
      variable: (toxicity_indicator_var)
      description: >-
        Level indicating presence of grade 3-4 toxicity (e.g., "Yes", "Grade 3-4", 1).

    # Time Period Method
    - name: toxicity_start_var
      title: 'Toxicity Start Time'
      type: Variable
      suggested: [continuous]
      permitted: [numeric]
      description: >-
        Time when toxicity begins (months from baseline).
        Use 0 for toxicity starting at treatment initiation.

    - name: toxicity_end_var
      title: 'Toxicity End Time'
      type: Variable
      suggested: [continuous]
      permitted: [numeric]
      description: >-
        Time when toxicity resolves (months from baseline).
        TOX duration = toxicity_end - toxicity_start.

    # ========================================
    # Analysis Parameters
    # ========================================
    - name: tau
      title: 'Time Horizon (τ) for Analysis'
      type: Number
      default: 24.0
      min: 6.0
      max: 120.0
      description: >-
        Restricted time horizon for Q-TWiST analysis in months.
        All survival estimates are restricted to this maximum follow-up time.
        Common values: 24 months (2 years), 36 months (3 years), 60 months (5 years).
        Choose based on median survival and clinical relevance.

    - name: tau_selection
      title: 'Tau Selection Method'
      type: List
      options:
        - title: "User-Specified Value"
          name: user_specified
        - title: "Automatic (75th percentile of OS)"
          name: auto_percentile
        - title: "Maximum Observed Follow-up"
          name: max_followup
      default: user_specified
      description: >-
        Method for selecting time horizon (tau). User-specified allows manual
        entry; automatic methods select based on data characteristics.

    # ========================================
    # Utility Weights
    # ========================================
    - name: utility_tox
      title: 'Utility Weight for TOX State (μ_TOX)'
      type: Number
      default: 0.5
      min: 0.0
      max: 1.0
      description: >-
        Quality-of-life utility weight for time with treatment toxicity.
        0 = worst possible health, 1 = perfect health.
        Typical range: 0.3-0.7 depending on toxicity severity.
        Literature values: chemotherapy toxicity ≈ 0.5, severe toxicity ≈ 0.3.

    - name: utility_twist
      title: 'Utility Weight for TWiST State (μ_TWiST)'
      type: Number
      default: 1.0
      min: 0.0
      max: 1.0
      description: >-
        Quality-of-life utility weight for time without symptoms or toxicity.
        Typically set to 1.0 (perfect health) as the reference state.
        Should generally be ≥ utility_tox and ≥ utility_rel.

    - name: utility_rel
      title: 'Utility Weight for REL State (μ_REL)'
      type: Number
      default: 0.5
      min: 0.0
      max: 1.0
      description: >-
        Quality-of-life utility weight for time after disease relapse/progression.
        Accounts for symptomatic disease burden.
        Typical range: 0.3-0.6 depending on disease severity and symptoms.
        Literature values: metastatic disease ≈ 0.5, symptomatic relapse ≈ 0.4.

    # ========================================
    # Sensitivity Analysis
    # ========================================
    - name: sensitivity_analysis
      title: 'Perform Sensitivity Analysis'
      type: Bool
      default: true
      description: >-
        Examine how Q-TWiST results vary across different utility weight assumptions.
        Essential for robust conclusions, as utility weights are subjective.
        Shows when treatment preference changes based on quality-of-life values.

    - name: utility_range_tox
      title: 'TOX Utility Range'
      type: String
      default: "0, 0.25, 0.5, 0.75, 1.0"
      description: >-
        Comma-separated list of utility values for TOX state sensitivity analysis.
        Example: "0, 0.3, 0.5, 0.7, 1.0"

    - name: utility_range_rel
      title: 'REL Utility Range'
      type: String
      default: "0, 0.25, 0.5, 0.75, 1.0"
      description: >-
        Comma-separated list of utility values for REL state sensitivity analysis.

    - name: threshold_analysis
      title: 'Threshold Utility Analysis'
      type: Bool
      default: false
      description: >-
        Find threshold utility values where treatment preference changes.
        Identifies "break-even" points for clinical decision-making.

    # ========================================
    # Statistical Inference
    # ========================================
    - name: confidence_level
      title: 'Confidence Level'
      type: Number
      default: 0.95
      min: 0.80
      max: 0.99
      description: >-
        Confidence level for interval estimation (default: 0.95 for 95% CI).

    - name: bootstrap_ci
      title: 'Bootstrap Confidence Intervals'
      type: Bool
      default: true
      description: >-
        Use bootstrap resampling to calculate confidence intervals for
        Q-TWiST treatment differences. Recommended for robust inference.

    - name: bootstrap_samples
      title: 'Number of Bootstrap Samples'
      type: Number
      default: 1000
      min: 100
      max: 10000
      description: >-
        Number of bootstrap resamples for confidence interval calculation.
        More samples = more precise estimates but longer computation time.
        1000 samples is usually sufficient; use 2000+ for publication.

    - name: bootstrap_seed
      title: 'Bootstrap Random Seed'
      type: Number
      default: 2025
      description: >-
        Random seed for bootstrap sampling (for reproducibility).

    # ========================================
    # Stratification & Adjustment
    # ========================================
    - name: stratify_by
      title: 'Stratification Variables'
      type: Variables
      suggested: [ordinal, nominal]
      permitted: [factor]
      description: >-
        Variables for stratified analysis (e.g., site, stage, biomarker status).
        Separate Q-TWiST analyses will be performed for each stratum.

    - name: pooled_analysis
      title: 'Show Pooled Analysis Across Strata'
      type: Bool
      default: true
      description: >-
        Display overall Q-TWiST results in addition to stratified results.

    # ========================================
    # Output Tables
    # ========================================
    - name: show_state_partition
      title: 'State Partition Table'
      type: Bool
      default: true
      description: >-
        Display table showing mean time spent in each health state (TOX, TWiST, REL)
        for each treatment arm.

    - name: show_qtwist_scores
      title: 'Q-TWiST Scores Table'
      type: Bool
      default: true
      description: >-
        Display quality-adjusted survival (Q-TWiST) scores for each treatment
        with applied utility weights.

    - name: show_treatment_difference
      title: 'Treatment Difference Table'
      type: Bool
      default: true
      description: >-
        Display Q-TWiST difference between treatment arms with confidence intervals
        and statistical significance.

    - name: show_sensitivity_table
      title: 'Sensitivity Analysis Table'
      type: Bool
      default: true
      description: >-
        Display results across varying utility weight combinations.

    - name: show_rmst_components
      title: 'RMST Component Details'
      type: Bool
      default: false
      description: >-
        Show underlying restricted mean survival time calculations for
        overall survival and progression-free survival.

    - name: show_descriptive_stats
      title: 'Descriptive Statistics'
      type: Bool
      default: true
      description: >-
        Display sample sizes, median survival times, and event rates
        for each treatment arm.

    # ========================================
    # Visualization Options
    # ========================================
    - name: plot_partitioned_survival
      title: 'Partitioned Survival Plot'
      type: Bool
      default: true
      description: >-
        Display stacked area plot showing TOX, TWiST, and REL components
        over time for each treatment arm.

    - name: plot_qtwist_comparison
      title: 'Q-TWiST Comparison Plot'
      type: Bool
      default: true
      description: >-
        Bar chart comparing Q-TWiST components (TOX, TWiST, REL) between
        treatment arms with utility weights applied.

    - name: plot_sensitivity
      title: 'Sensitivity Analysis Plot'
      type: Bool
      default: true
      description: >-
        Contour plot or heatmap showing Q-TWiST treatment difference across
        varying utility weight combinations.

    - name: plot_km_curves
      title: 'Kaplan-Meier Curves'
      type: Bool
      default: false
      description: >-
        Display standard Kaplan-Meier survival curves for OS and PFS
        for reference alongside Q-TWiST results.

    - name: plot_color_scheme
      title: 'Plot Color Scheme'
      type: List
      options:
        - title: "Clinical (Red/Green/Blue)"
          name: clinical
        - title: "Colorblind-Friendly"
          name: colorblind
        - title: "Grayscale"
          name: grayscale
        - title: "Viridis"
          name: viridis
      default: clinical
      description: >-
        Color scheme for partitioned survival plots.
        TOX (toxicity), TWiST (good quality), REL (relapse) states.

    # ========================================
    # Explanatory Output
    # ========================================
    - name: showExplanations
      title: 'Show Methodology Explanations'
      type: Bool
      default: true
      description: >-
        Include detailed explanations of Q-TWiST methodology, interpretation
        guidance, and clinical significance.

    - name: showClinicalGuidance
      title: 'Clinical Interpretation Guidance'
      type: Bool
      default: true
      description: >-
        Provide clinical interpretation assistance including treatment
        implications and decision-making considerations.

    - name: showFormulas
      title: 'Show Statistical Formulas'
      type: Bool
      default: false
      description: >-
        Display mathematical formulas for Q-TWiST calculations and
        statistical tests.

    - name: showReferences
      title: 'Show Key References'
      type: Bool
      default: true
      description: >-
        Display key references for Q-TWiST methodology and applications.

...
