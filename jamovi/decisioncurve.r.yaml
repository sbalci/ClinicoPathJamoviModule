---
name: decisioncurve
title: Decision Curve Analysis
jrs: '1.1'

items:
    # Instructions and procedure notes
    - name: instructions
      title: Instructions
      type: Html
      visible: true

    - name: procedureNotes
      title: Analysis Summary
      type: Html
      visible: true

    # Notice outputs converted to HTML to avoid serialization errors
    - name: notices
      title: Important Information
      type: Html
      clearWith:
        - outcome
        - outcomePositive
        - models
        - thresholdRange
        - thresholdMin
        - thresholdMax
        - thresholdStep
        - selectedThresholds
        - clinicalDecisionRule
        - decisionRuleVar

    # Main results table
    - name: resultsTable
      title: Net Benefit at Selected Thresholds
      type: Table
      visible: (showTable)
      rows: 0
      columns:
        - name: threshold
          title: 'Threshold Probability'
          type: number
          format: pc
        - name: treat_all
          title: 'Treat All'
          type: number
          format: zto
        - name: treat_none
          title: 'Treat None'
          type: number
          format: zto
      clearWith:
        - outcome
        - outcomePositive
        - models
        - thresholdRange
        - thresholdMin
        - thresholdMax
        - selectedThresholds

    # Optimal thresholds table
    - name: optimalTable
      title: Optimal Thresholds
      type: Table
      visible: (showOptimalThreshold)
      rows: 0
      columns:
        - name: model
          title: 'Model'
          type: text
        - name: optimal_threshold
          title: 'Optimal Threshold'
          type: number
          format: pc
        - name: max_net_benefit
          title: 'Maximum Net Benefit'
          type: number
          format: zto
        - name: threshold_range_start
          title: 'Beneficial Range Start'
          type: number
          format: pc
        - name: threshold_range_end
          title: 'Beneficial Range End'
          type: number
          format: pc
      clearWith:
        - outcome
        - outcomePositive
        - models
        - thresholdRange
        - thresholdMin
        - thresholdMax

    # Clinical impact table
    - name: clinicalImpactTable
      title: Clinical Impact Analysis
      type: Table
      visible: (calculateClinicalImpact)
      rows: 0
      columns:
        - name: model
          title: 'Model'
          type: text
        - name: threshold
          title: 'Threshold'
          type: number
          format: pc
        - name: interventions_per_100
          title: 'Interventions per 100'
          type: number
          format: zto
        - name: true_positives_per_100
          title: 'True Positives per 100'
          type: number
          format: zto
        - name: false_positives_per_100
          title: 'False Positives per 100'
          type: number
          format: zto
        - name: interventions_avoided
          title: 'Interventions Avoided vs Treat All'
          type: number
          format: zto
        - name: number_needed_to_screen
          title: 'Number Needed to Screen'
          type: number
          format: zto
      clearWith:
        - outcome
        - outcomePositive
        - models
        - populationSize
        - selectedThresholds

    # Model comparison table
    - name: comparisonTable
      title: Model Comparison
      type: Table
      visible: (compareModels)
      rows: 0
      columns:
        - name: comparison
          title: 'Comparison'
          type: text
        - name: weighted_auc_diff
          title: 'Weighted AUC Difference'
          type: number
          format: zto
        - name: ci_lower
          title: '95% CI Lower'
          type: number
          format: zto
        - name: ci_upper
          title: '95% CI Upper'
          type: number
          format: zto
        - name: p_value
          title: 'P-value'
          type: number
          format: zto,pvalue
      clearWith:
        - outcome
        - outcomePositive
        - models
        - compareModels

    # Weighted AUC table
    - name: weightedAUCTable
      title: Weighted Area Under Decision Curve
      type: Table
      visible: (weightedAUC)
      rows: 0
      columns:
        - name: model
          title: 'Model'
          type: text
        - name: weighted_auc
          title: 'Weighted AUC'
          type: number
          format: zto
        - name: auc_range
          title: 'Threshold Range'
          type: text
        - name: relative_benefit
          title: 'Relative Benefit vs Treat All'
          type: number
          format: pc
      clearWith:
        - outcome
        - outcomePositive
        - models
        - thresholdRange
        - thresholdMin
        - thresholdMax

    # Decision curve plot
    - name: dcaPlot
      title: Decision Curve Analysis
      type: Image
      width: 700
      height: 500
      renderFun: .plotDCA
      visible: (showPlot)
      clearWith:
        - outcome
        - outcomePositive
        - models
        - thresholdRange
        - thresholdMin
        - thresholdMax
        - thresholdStep
        - plotStyle
        - showReferenceLinesLabels
        - highlightRange
        - confidenceIntervals

    # Clinical impact plot
    - name: clinicalImpactPlot
      title: Clinical Impact Plot
      type: Image
      width: 700
      height: 500
      renderFun: .plotClinicalImpact
      visible: (calculateClinicalImpact || showClinicalImpactPlot)
      description: Number of true/false positives per population unit
      clearWith:
        - outcome
        - outcomePositive
        - models
        - populationSize
        - thresholdRange
        - thresholdMin
        - thresholdMax

    # Interventions avoided plot
    - name: interventionsAvoidedPlot
      title: Interventions Avoided
      type: Image
      width: 700
      height: 500
      renderFun: .plotInterventionsAvoided
      visible: (showInterventionAvoided && showPlot)
      clearWith:
        - outcome
        - outcomePositive
        - models
        - thresholdRange
        - thresholdMin
        - thresholdMax

    # Summary text
    - name: summaryText
      title: Clinical Interpretation
      type: Html
      visible: true
      clearWith:
        - outcome
        - outcomePositive
        - models
        - thresholdRange
        - thresholdMin
        - thresholdMax

    # Enhanced Decision Curve Analysis Results
    - name: costBenefitTable
      title: Cost-Benefit Analysis
      type: Table
      description: Cost-benefit analysis at selected thresholds
      visible: (costBenefitAnalysis)
      columns:
        - name: model
          title: 'Model'
          type: text
        - name: threshold
          title: 'Threshold'
          type: number
          format: zto
        - name: total_cost
          title: 'Total Cost'
          type: number
        - name: total_benefit
          title: 'Total Benefit'
          type: number
        - name: net_monetary_benefit
          title: 'Net Monetary Benefit'
          type: number
        - name: incremental_cost
          title: 'Incremental Cost'
          type: number
        - name: incremental_benefit
          title: 'Incremental Benefit'
          type: number
        - name: icer
          title: 'ICER'
          type: number

    - name: decisionConsequencesTable
      title: Decision Consequences
      type: Table
      description: Detailed consequences at selected thresholds
      visible: (showDecisionConsequences)
      columns:
        - name: model
          title: 'Model'
          type: text
        - name: threshold
          title: 'Threshold'
          type: number
          format: pc
        - name: true_positive
          title: 'True Positive'
          type: integer
        - name: false_positive
          title: 'False Positive'
          type: integer
        - name: true_negative
          title: 'True Negative'
          type: integer
        - name: false_negative
          title: 'False Negative'
          type: integer
        - name: sensitivity
          title: 'Sensitivity'
          type: number
          format: pc
        - name: specificity
          title: 'Specificity'
          type: number
          format: pc
        - name: ppv
          title: 'PPV'
          type: number
          format: pc
        - name: npv
          title: 'NPV'
          type: number
          format: pc

    - name: modelComparisonEnhanced
      title: Enhanced Model Comparison
      type: Table
      description: Pairwise statistical comparison of models
      visible: (multiModelComparison)
      columns:
        - name: model1
          title: 'Model 1'
          type: text
        - name: model2
          title: 'Model 2'
          type: text
        - name: nb_difference_mean
          title: 'Mean NB Difference'
          type: number
          format: zto
        - name: nb_difference_median
          title: 'Median NB Difference'
          type: number
          format: zto
        - name: test_statistic
          title: 'Test Statistic'
          type: number
          format: zto
        - name: p_value
          title: 'p-value'
          type: number
          format: zto;pvalue
        - name: conclusion
          title: 'Conclusion'
          type: text

    - name: resourceUtilizationTable
      title: Resource Utilization
      type: Table
      description: Resource utilization at selected thresholds
      visible: (resourceUtilization)
      columns:
        - name: model
          title: 'Model'
          type: text
        - name: threshold
          title: 'Threshold'
          type: number
          format: pc
        - name: tests_per_1000
          title: 'Tests per 1000'
          type: number
        - name: treatments_per_1000
          title: 'Treatments per 1000'
          type: number
        - name: unnecessary_treatments
          title: 'Unnecessary Tx per 1000'
          type: number
        - name: missed_cases
          title: 'Missed Cases per 1000'
          type: number
        - name: reduction_vs_treat_all
          title: '% Reduction vs Treat All'
          type: number
          format: pc

    - name: relativeUtilityPlot
      title: Relative Utility Curve
      type: Image
      description: Relative utility compared to default strategies
      visible: (showRelativeUtility)
      renderFun: .plotRelativeUtility
      width: 700
      height: 500

    - name: standardizedNetBenefitPlot
      title: Standardized Net Benefit
      type: Image
      description: Net benefit per 100 patients
      visible: (showStandardizedNetBenefit)
      renderFun: .plotStandardizedNetBenefit
      width: 700
      height: 500

refs:
    - DecisionCurve
    - rmda
    - ggplot2
    - dplyr
    - ClinicoPathJamoviModule


    - tidyr
...
