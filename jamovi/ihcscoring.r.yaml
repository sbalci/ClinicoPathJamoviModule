---
name: ihcscoring
title: IHC Scoring Standardization
jrs: '1.1'

items:
    - name: interpretation
      title: Clinical Interpretation and Guidelines
      type: Html
      visible: true

    - name: scorestable
      title: Individual Sample Scores
      type: Table
      description: Calculated H-scores, Allred scores, and binary classifications
      columns:
        - name: sample_id
          title: 'Sample ID'
          type: integer
        - name: intensity
          title: 'Intensity'
          type: number
          format: zto
        - name: proportion
          title: 'Proportion (%)'
          type: number
          format: zto
        - name: hscore
          title: 'H-score'
          type: number
          format: zto
        - name: allred_intensity
          title: 'Allred Intensity'
          type: integer
        - name: allred_proportion
          title: 'Allred Proportion'
          type: integer
        - name: allred_total
          title: 'Allred Total'
          type: integer
        - name: binary_classification
          title: 'Binary Result'
          type: text
      clearWith:
          - intensity_var
          - proportion_var
          - scoring_method
          - binary_cutpoint
          - allred_cutpoint

    - name: statisticstable
      title: Descriptive Statistics by Score Type
      type: Table
      description: Comprehensive statistical summary for each scoring method
      columns:
        - name: score_type
          title: 'Score Type'
          type: text
        - name: mean
          title: 'Mean'
          type: number
          format: zto
        - name: median
          title: 'Median'
          type: number
          format: zto
        - name: sd
          title: 'SD'
          type: number
          format: zto
        - name: min
          title: 'Min'
          type: number
          format: zto
        - name: max
          title: 'Max'
          type: number
          format: zto
        - name: q25
          title: 'Q1'
          type: number
          format: zto
        - name: q75
          title: 'Q3'
          type: number
          format: zto
      clearWith:
          - intensity_var
          - proportion_var
          - scoring_method
          - include_statistics

    - name: agreementtable
      title: Method Agreement Analysis
      type: Table
      description: Correlation and agreement statistics between scoring methods
      columns:
        - name: comparison
          title: 'Comparison'
          type: text
        - name: correlation
          title: 'Correlation (r)'
          type: number
          format: zto
        - name: p_value
          title: 'P-value'
          type: number
          format: zto,pvalue
        - name: icc
          title: 'ICC'
          type: number
          format: zto
        - name: icc_ci_lower
          title: 'ICC 95% CI Lower'
          type: number
          format: zto
        - name: icc_ci_upper
          title: 'ICC 95% CI Upper'
          type: number
          format: zto
        - name: interpretation
          title: 'Agreement Level'
          type: text
      visible: (agreement_analysis)
      clearWith:
          - intensity_var
          - proportion_var
          - agreement_analysis
          - confidence_level

    - name: qualitycontroltable
      title: Quality Control Metrics
      type: Table
      description: Outlier detection and data quality assessment
      columns:
        - name: metric
          title: 'QC Metric'
          type: text
        - name: value
          title: 'Value'
          type: number
          format: zto
        - name: threshold
          title: 'Threshold'
          type: number
          format: zto
        - name: status
          title: 'Status'
          type: text
        - name: recommendation
          title: 'Recommendation'
          type: text
      visible: (quality_control)
      clearWith:
          - intensity_var
          - proportion_var
          - quality_control

    - name: distributionplot
      title: Scoring Distribution Plot
      type: Image
      description: Visual distribution of H-scores and Allred scores
      width: 600
      height: 400
      visible: (show_plots)
      requiresData: true
      renderFun: .distributionplot
      clearWith:
          - intensity_var
          - proportion_var
          - show_plots
          - scoring_method

    - name: correlationplot
      title: Method Correlation Plot
      type: Image
      description: Correlation between H-score and Allred score methods
      width: 500
      height: 400
      visible: (show_plots)
      requiresData: true
      renderFun: .correlationplot
      clearWith:
          - intensity_var
          - proportion_var
          - show_plots
          - agreement_analysis

    - name: agreementplot
      title: Method Agreement Plot
      type: Image
      description: Bland-Altman style agreement analysis between methods
      width: 500
      height: 400
      visible: (show_agreement_plots)
      requiresData: true
      renderFun: .agreementplot
      clearWith:
          - intensity_var
          - proportion_var
          - show_agreement_plots
          - agreement_analysis

    - name: cutpointplot
      title: Cutpoint Optimization Plot
      type: Image
      description: ROC analysis for optimal cutpoint determination
      width: 500
      height: 400
      visible: false
      requiresData: true
      renderFun: .cutpointplot

    - name: biomarkerspecific
      title: Biomarker-Specific Analysis
      type: Group
      visible: (biomarker_type:er || biomarker_type:pr || biomarker_type:her2 || biomarker_type:ki67 || biomarker_type:pdl1)
      items:
          - name: biomarkerresults
            title: Biomarker-Specific Results
            type: Table
            description: Analysis tailored to specific biomarker characteristics
            columns:
              - name: parameter
                title: 'Parameter'
                type: text
              - name: value
                title: 'Value'
                type: number
                format: zto
              - name: clinical_significance
                title: 'Clinical Significance'
                type: text
              - name: reference_range
                title: 'Reference Range'
                type: text

          - name: clinicalcutpoints
            title: Clinical Cutpoint Analysis
            type: Table
            description: Established clinical thresholds and their performance
            columns:
              - name: cutpoint_type
                title: 'Cutpoint Type'
                type: text
              - name: threshold
                title: 'Threshold'
                type: number
                format: zto
              - name: sensitivity
                title: 'Sensitivity'
                type: number
                format: pc
              - name: specificity
                title: 'Specificity'
                type: number
                format: pc
              - name: clinical_context
                title: 'Clinical Context'
                type: text

    - name: digitalvalidation
      title: Digital Pathology Validation
      type: Group
      visible: (include_digital_validation)
      items:
          - name: algorithmcomparison
            title: Algorithm vs Manual Comparison
            type: Table
            description: Statistical comparison of digital vs manual scoring
            columns:
              - name: metric
                title: 'Metric'
                type: text
              - name: manual_mean
                title: 'Manual Mean'
                type: number
              - name: automated_mean
                title: 'Automated Mean'
                type: number
              - name: correlation
                title: 'Correlation'
                type: number
              - name: bias
                title: 'Bias'
                type: number

          - name: batcheffects
            title: Batch Effect Assessment
            type: Table
            description: Analysis of systematic differences across batches
            columns:
              - name: batch_id
                title: 'Batch ID'
                type: text
              - name: sample_count
                title: 'Sample Count'
                type: integer
              - name: mean_hscore
                title: 'Mean H-Score'
                type: number
              - name: batch_effect_size
                title: 'Effect Size'
                type: number
              - name: p_value
                title: 'P-value'
                type: number
                format: zto,pvalue

          - name: validationplot
            title: Digital Validation Plot
            type: Image
            width: 500
            height: 400
            renderFun: .validationplot

    - name: automatedanalysis
      title: Automated Image Analysis Results
      type: Group
      visible: (automated_analysis)
      items:
          - name: segmentationresults
            title: Nuclear Segmentation Results
            type: Table
            description: Summary of automated nuclear segmentation
            columns:
              - name: image_name
                title: Image Name
                type: text
              - name: total_nuclei
                title: Total Nuclei
                type: integer
              - name: positive_nuclei
                title: Positive Nuclei
                type: integer
              - name: percentage_positive
                title: Percentage Positive
                type: number
                format: pc
              - name: h_score
                title: Automated H-Score
                type: number

          - name: intensityanalysis
            title: DAB Intensity Analysis
            type: Table
            description: Distribution of DAB intensity levels
            columns:
              - name: intensity_level
                title: Intensity Level
                type: text
              - name: nucleus_count
                title: Nucleus Count
                type: integer
              - name: percentage
                title: Percentage
                type: number
                format: pc
              - name: mean_optical_density
                title: Mean Optical Density
                type: number

          - name: validationcomparison
            title: Manual vs Automated Validation
            visible: (validation_metrics)
            type: Table
            description: Comparison between manual and automated scores
            columns:
              - name: metric
                title: Metric
                type: text
              - name: manual_score
                title: Manual Score
                type: number
              - name: automated_score
                title: Automated Score
                type: number
              - name: difference
                title: Difference
                type: number
              - name: correlation
                title: Correlation
                type: number

          - name: segmentationplot
            title: Nuclear Segmentation Visualization
            type: Image
            description: Overlay of detected nuclei on original image
            width: 800
            height: 600
            renderFun: .segmentationplot

          - name: intensityplot
            title: DAB Intensity Distribution Plot
            type: Image
            description: Histogram of DAB optical density values
            width: 600
            height: 400
            renderFun: .intensityplot

          - name: validationplot
            title: Manual vs Automated Correlation Plot
            visible: (validation_metrics)
            type: Image
            description: Scatter plot of manual vs automated scores
            width: 500
            height: 400

    - name: advancedmetrics
      title: Advanced Statistical Metrics
      type: Group
      visible: true
      items:
          - name: reliabilitymetrics
            title: Reliability Assessment
            type: Table
            description: Comprehensive reliability and consistency metrics
            columns:
              - name: measure
                title: 'Reliability Measure'
                type: text
              - name: value
                title: 'Value'
                type: number
                format: zto
              - name: ci_lower
                title: '95% CI Lower'
                type: number
                format: zto
              - name: ci_upper
                title: '95% CI Upper'
                type: number
                format: zto
              - name: interpretation
                title: 'Interpretation'
                type: text

          - name: distributionanalysis
            title: Distribution Analysis
            type: Table
            description: Normality testing and distribution characteristics
            columns:
              - name: score_type
                title: 'Score Type'
                type: text
              - name: normality_test
                title: 'Normality Test'
                type: text
              - name: p_value
                title: 'P-value'
                type: number
                format: zto,pvalue
              - name: skewness
                title: 'Skewness'
                type: number
                format: zto
              - name: kurtosis
                title: 'Kurtosis'
                type: number
                format: zto
              - name: distribution
                title: 'Distribution'
                type: text

    - name: multiplecutoffs
      title: Multiple Cut-off Analysis
      type: Group
      visible: (multiple_cutoffs)
      items:
          - name: cutoffresults
            title: Cut-off Analysis Results
            type: Table
            description: Positivity rates across different cut-off thresholds
            columns:
              - name: cutoff_threshold
                title: 'Cut-off Threshold'
                type: text
              - name: group_name
                title: 'Group'
                type: text
              - name: positive_count
                title: 'Positive Cases'
                type: integer
              - name: total_count
                title: 'Total Cases'
                type: integer
              - name: positive_percentage
                title: 'Positive Rate (%)'
                type: number
                format: zto
              - name: confidence_interval
                title: '95% CI'
                type: text

          - name: comparisonstats
            title: Statistical Comparisons Across Cut-offs
            visible: (cutoff_comparison)
            type: Table
            description: Statistical tests comparing groups across different cut-off values
            columns:
              - name: cutoff
                title: 'Cut-off'
                type: text
              - name: test_statistic
                title: 'Test Statistic'
                type: text
              - name: statistic_value
                title: 'Statistic Value'
                type: number
                format: zto
              - name: p_value
                title: 'P-value'
                type: number
                format: zto,pvalue
              - name: interpretation
                title: 'Interpretation'
                type: text

    - name: cutoffplot
      title: Multiple Cut-off Analysis Plot
      type: Image
      description: Biomarker positivity rates across different thresholds
      width: 600
      height: 400
      visible: (multiple_cutoffs && show_plots)
      requiresData: true
      renderFun: .cutoffplot
      clearWith:
          - multiple_cutoffs
          - cutoff_values
          - show_plots
          - group_var

    - name: cpsanalysis
      title: Combined Positive Score (CPS) Analysis
      type: Group
      visible: (cps_analysis)
      items:
          - name: cpsresults
            title: CPS Analysis Results
            type: Table
            description: Combined Positive Score analysis for PD-L1 assessment
            columns:
              - name: cps_cutoff
                title: 'CPS Cut-off'
                type: text
              - name: positive_count
                title: 'Positive Cases'
                type: integer
              - name: total_count
                title: 'Total Cases'
                type: integer
              - name: positive_percentage
                title: 'Positive Rate (%)'
                type: number
                format: zto
              - name: confidence_interval
                title: '95% CI'
                type: text
              - name: clinical_significance
                title: 'Clinical Significance'
                type: text

          - name: cpsstatistics
            title: CPS Descriptive Statistics
            type: Table
            description: Summary statistics for Combined Positive Score
            columns:
              - name: statistic
                title: 'Statistic'
                type: text
              - name: value
                title: 'Value'
                type: text
              - name: interpretation
                title: 'Interpretation'
                type: text

          - name: cpscomparison
            title: CPS Group Comparison
            visible: (group_var && cutoff_comparison)
            type: Table
            description: Statistical comparison of CPS between groups
            columns:
              - name: comparison_type
                title: 'Comparison Type'
                type: text
              - name: test_statistic
                title: 'Test Statistic'
                type: text
              - name: statistic_value
                title: 'Statistic Value'
                type: number
                format: zto
              - name: p_value
                title: 'P-value'
                type: number
                format: zto,pvalue
              - name: interpretation
                title: 'Interpretation'
                type: text

    - name: cpsplot
      title: Combined Positive Score Distribution Plot
      type: Image
      description: Distribution of CPS scores with clinical thresholds
      width: 600
      height: 400
      visible: (cps_analysis && show_plots)
      requiresData: true
      renderFun: .cpsplot
      clearWith:
          - cps_analysis
          - tumor_cells_var
          - immune_cells_var
          - show_plots
          - group_var

    - name: molecularclassification
      title: Molecular Subtyping Analysis
      type: Group
      visible: (molecular_classification)
      items:
          - name: classificationtable
            title: Molecular Classification Results
            type: Table
            description: Molecular subtype classification based on marker combinations
            columns:
              - name: sample_id
                title: 'Sample ID'
                type: text
              - name: marker1_status
                title: 'Marker 1 Status'
                type: text
              - name: marker2_status
                title: 'Marker 2 Status'
                type: text
              - name: secondary_status
                title: 'Secondary Marker'
                type: text
              - name: molecular_subtype
                title: 'Molecular Subtype'
                type: text
              - name: confidence_score
                title: 'Confidence Score'
                type: number
                format: zto

          - name: subtypedistribution
            title: Molecular Subtype Distribution
            type: Table
            description: Frequency and percentage of each molecular subtype
            columns:
              - name: subtype
                title: 'Molecular Subtype'
                type: text
              - name: count
                title: 'Count'
                type: integer
              - name: percentage
                title: 'Percentage (%)'
                type: number
                format: zto
              - name: confidence_interval
                title: '95% CI'
                type: text

          - name: subtypestatistics
            title: Subtype Statistical Comparison
            visible: (subtype_statistics)
            type: Table
            description: Statistical comparisons between molecular subtypes
            columns:
              - name: comparison
                title: 'Comparison'
                type: text
              - name: test_statistic
                title: 'Test Statistic'
                type: text
              - name: statistic_value
                title: 'Statistic Value'
                type: number
                format: zto
              - name: p_value
                title: 'P-value'
                type: number
                format: zto,pvalue
              - name: effect_size
                title: 'Effect Size'
                type: number
                format: zto
              - name: interpretation
                title: 'Interpretation'
                type: text

          - name: checkpointanalysis
            title: Checkpoint Inhibitor Expression by Subtype
            visible: (pd1_marker || pdl1_marker)
            type: Table
            description: PD-1/PD-L1 expression patterns across molecular subtypes
            columns:
              - name: molecular_subtype
                title: 'Molecular Subtype'
                type: text
              - name: marker
                title: 'Marker'
                type: text
              - name: cutoff
                title: 'Cut-off (%)'
                type: text
              - name: positive_count
                title: 'Positive Cases'
                type: integer
              - name: total_count
                title: 'Total Cases'
                type: integer
              - name: positive_rate
                title: 'Positive Rate (%)'
                type: number
                format: zto
              - name: p_value
                title: 'P-value'
                type: number
                format: zto,pvalue

    - name: subtypeplot
      title: Molecular Subtype Distribution Plot
      type: Image
      description: Visual representation of molecular subtype frequencies
      width: 600
      height: 400
      visible: (molecular_classification && subtype_visualization)
      requiresData: true
      renderFun: .subtypeplot
      clearWith:
          - molecular_classification
          - classification_system
          - subtype_visualization

    - name: checkpointplot
      title: Checkpoint Inhibitor Expression Plot
      type: Image
      description: PD-1/PD-L1 expression patterns across molecular subtypes
      width: 700
      height: 500
      visible: (molecular_classification && (pd1_marker || pdl1_marker) && subtype_visualization)
      requiresData: true
      renderFun: .checkpointplot
      clearWith:
          - molecular_classification
          - pd1_marker
          - pdl1_marker
          - checkpoint_cutoffs
          - subtype_visualization

    - name: exportdata
      title: Export-Ready Data
      type: Table
      visible: (export_results)
      description: Formatted results for external analysis or reporting
      columns:
        - name: sample_id
          title: 'Sample ID'
          type: text
        - name: intensity
          title: 'Intensity'
          type: number
          format: zto
        - name: proportion
          title: 'Proportion (%)'
          type: number
          format: zto
        - name: hscore
          title: 'H-score'
          type: number
          format: zto
        - name: allred_total
          title: 'Allred Total'
          type: integer
        - name: binary_result
          title: 'Binary Result'
          type: text
        - name: molecular_subtype
          title: 'Molecular Subtype'
          type: text
        - name: group
          title: 'Group'
          type: text
      clearWith:
          - export_results
          - intensity_var
          - proportion_var
          - molecular_classification

...