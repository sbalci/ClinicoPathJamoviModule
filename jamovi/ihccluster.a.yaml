---
name: ihccluster
title: IHC Clustering Analysis
menuGroup: OncoPathologyT
menuSubgroup: IHC Analysis
menuSubtitle: 'Cluster cases by IHC expression patterns'
version: '2.0.0'
jas: '1.2'

description:
    main: |
        Clusters cases based on immunohistochemistry (IHC) staining patterns.
        
        **Variable Types:**
        - Categorical: pos/neg, intensity levels (0/1/2/3), ordinal scales
        - Continuous: H-scores (0-300), % positivity (0-100), expression levels
        - Mixed: Any combination of categorical and continuous markers
        
        Uses Gower distance to handle mixed data types appropriately.

options:
    - name: data
      type: Data
      description:
          R: >
            The data as a data frame.

    - name: catVars
      title: 'Categorical IHC Markers'
      type: Variables
      suggested:
          - nominal
          - ordinal
      permitted:
          - factor
      description: 'Binary (pos/neg) or ordinal (0/1/2/3) stain results'

    - name: contVars
      title: 'Continuous IHC Markers'
      type: Variables
      suggested:
          - continuous
      permitted:
          - numeric
      description: 'H-scores (0-300), % positivity (0-100), or other continuous measures'
      default: NULL


    - name: caseId
      title: 'Case ID (optional)'
      type: Variable
      suggested:
          - nominal
          - id
      permitted:
          - factor
          - id
      description: 'Case identifier for tracking'

    - name: method
      title: 'Clustering Method'
      type: List
      options:
          - title: 'PAM (k-medoids) on Gower'
            name: pam
          - title: 'Hierarchical (Ward) on Gower'
            name: hierarchical
          - title: 'MCA/PCA + k-means'
            name: dimreduce
      default: pam
      description: 'Clustering algorithm to use'


    - name: nClusters
      title: 'Number of Clusters'
      type: Integer
      min: 2
      max: 15
      default: 3
      description: 'Leave blank for automatic selection using silhouette'

    - name: autoSelectK
      title: 'Automatically Select Optimal k'
      type: Bool
      default: true
      description: 'Use silhouette width to find optimal number of clusters'

    - name: kRange
      title: 'Range for k Selection'
      type: List
      options:
          - title: '2-6 clusters'
            name: small
          - title: '2-8 clusters'
            name: medium
          - title: '2-12 clusters'
            name: large
      default: medium
      description: 'Range to test when auto-selecting k'

    - name: scaleContVars
      title: 'Scale Continuous Variables'
      type: Bool
      default: true
      description: 'Z-score continuous markers before clustering'

    - name: weights
      title: 'Variable Weights (optional)'
      type: String
      default: ''
      description: 'Comma-separated weights for markers (e.g., "1,1,2,1" for 4 markers)'

    - name: handleMissing
      title: 'Missing Data Method'
      type: List
      options:
          - title: 'Complete cases only'
            name: complete
          - title: 'Pairwise distances'
            name: pairwise
      default: pairwise
      description: 'How to handle missing values'

    - name: consensusClustering
      title: 'Consensus Clustering'
      type: Bool
      default: false
      description: 'Use bootstrap resampling for stable clusters'

    - name: nBootstrap
      title: 'Bootstrap Iterations'
      type: Integer
      min: 50
      max: 1000
      default: 100
      description: 'Number of bootstrap samples for consensus'

    - name: seed
      title: 'Random Seed'
      type: Integer
      default: 42
      description: 'For reproducibility'

    # Visualization options
    - name: showSilhouette
      title: 'Silhouette Plot'
      type: Bool
      default: true
      description: 'Show silhouette width plot for cluster quality'

    - name: showHeatmap
      title: 'Expression Heatmap'
      type: Bool
      default: true
      description: 'Show clustered heatmap of IHC expression'

    - name: heatmapScale
      title: 'Heatmap Scaling'
      type: List
      options:
          - title: 'Row (by marker)'
            name: row
          - title: 'Column (by case)'
            name: column
          - title: 'None'
            name: none
      default: row
      description: 'How to scale heatmap values'

    - name: showDendrogram
      title: 'Show Dendrogram'
      type: Bool
      default: true
      description: 'Show dendrogram for hierarchical clustering'

    - name: showPCAPlot
      title: 'PCA/MCA Plot'
      type: Bool
      default: true
      description: 'Show dimension reduction plot with clusters'

    - name: showBoxplots
      title: 'Marker Distributions'
      type: Bool
      default: true
      description: 'Show boxplots of continuous markers by cluster'


    # Output options
    - name: markerSummary
      title: 'Marker Summary Statistics'
      type: Bool
      default: true
      description: 'Summary statistics for each marker by cluster'

    - name: clusterProfiles
      title: 'Cluster Profiles'
      type: Bool
      default: true
      description: 'Characteristic features of each cluster'

    - name: associationTests
      title: 'Association Tests'
      type: Bool
      default: true
      description: 'Test marker-cluster associations'

    - name: exportClusters
      title: 'Export Cluster Assignments'
      type: Bool
      default: false
      description: 'Save cluster assignments to dataset'

    - name: clinicalVars
      title: 'Clinical Variables (optional)'
      type: Variables
      suggested:
          - nominal
          - ordinal
          - continuous
      permitted:
          - factor
          - numeric
      description: 'Clinical variables to compare across clusters'

    - name: survivalTime
      title: 'Survival Time (optional)'
      type: Variable
      suggested:
          - continuous
      permitted:
          - numeric
      description: 'Time variable for survival analysis'
      default: NULL

    - name: survivalEvent
      title: 'Survival Event (optional)'
      type: Variable
      suggested:
          - nominal
      permitted:
          - factor
          - numeric
      description: 'Event variable for survival analysis'
      default: NULL
