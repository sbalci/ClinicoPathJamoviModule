---
name: ihccluster
title: IHC Clustering Analysis
menuGroup: OncoPathD
menuSubgroup: IHC Analysis
menuSubtitle: 'Cluster cases by IHC expression patterns'
version: '2.0.0'
jas: '1.2'

description:
    main: |
        Clusters cases based on immunohistochemistry (IHC) staining patterns.
        
        **Variable Types:**
        - Categorical: pos/neg, intensity levels (0/1/2/3), ordinal scales
        - Continuous: H-scores (0-300), % positivity (0-100), expression levels
        - Mixed: Any combination of categorical and continuous markers
        
        Uses Gower distance to handle mixed data types appropriately.

options:
    - name: data
      type: Data
      description:
          R: >
            The data as a data frame.

    - name: catVars
      title: 'Categorical IHC Markers'
      type: Variables
      suggested:
          - nominal
          - ordinal
      permitted:
          - factor
      description: 'Binary (pos/neg) or ordinal (0/1/2/3) stain results'
      default: NULL

    - name: contVars
      title: 'Continuous IHC Markers'
      type: Variables
      suggested:
          - continuous
      permitted:
          - numeric
      description: 'H-scores (0-300), % positivity (0-100), or other continuous measures'
      default: NULL


    - name: caseId
      title: 'Case ID (optional)'
      type: Variable
      suggested:
          - nominal
          - id
      permitted:
          - factor
          - id
      description: 'Case identifier for tracking'
      default: NULL

    # Spatial/Compartment Analysis Options
    - name: spatialCompartment
      title: 'Spatial Compartment Variable (optional)'
      type: Variable
      suggested:
          - nominal
      permitted:
          - factor
      description: 'Groups cases by spatial location (e.g., Central/Invasive, Preinvasive/Invasive, Primary/Metastatic)'
      default: NULL

    - name: performSpatialAnalysis
      title: 'Perform Spatial Compartment Analysis'
      type: Bool
      default: false
      description: 'Compare clustering patterns across spatial compartments'

    - name: spatialComparisonMode
      title: 'Spatial Comparison Mode'
      type: List
      options:
          - title: 'Compare clusters between compartments'
            name: between
          - title: 'Cluster within each compartment separately'
            name: within
          - title: 'Both comparisons'
            name: both
      default: both
      description: 'How to analyze spatial compartments'

    - name: method
      title: 'Clustering Method'
      type: List
      options:
          - title: 'PAM (k-medoids) on Gower'
            name: pam
          - title: 'Hierarchical (Ward) on Gower'
            name: hierarchical
          - title: 'MCA/PCA + k-means'
            name: dimreduce
      default: pam
      description: 'Clustering algorithm to use'

    - name: distanceMethod
      title: 'Distance Metric'
      type: List
      options:
          - title: 'Gower (handles mixed data)'
            name: gower
          - title: 'Jaccard (binary data only)'
            name: jaccard
      default: gower
      description: 'Distance metric for clustering'

    - name: linkageMethod
      title: 'Linkage Method (hierarchical only)'
      type: List
      options:
          - title: 'Ward (minimize variance)'
            name: ward
          - title: 'Complete (furthest neighbor)'
            name: complete
          - title: 'Average (mean distance)'
            name: average
          - title: 'Single (nearest neighbor)'
            name: single
      default: ward
      description: 'Hierarchical clustering linkage method'

    - name: nClusters
      title: 'Number of Clusters'
      type: Integer
      min: 2
      max: 15
      default: 3
      description: 'Leave blank for automatic selection using silhouette'

    - name: autoSelectK
      title: 'Automatically Select Optimal k'
      type: Bool
      default: false
      description: 'Use silhouette width to find optimal number of clusters'

    - name: kRange
      title: 'Range for k Selection'
      type: List
      options:
          - title: '2-6 clusters'
            name: small
          - title: '2-8 clusters'
            name: medium
          - title: '2-12 clusters'
            name: large
      default: medium
      description: 'Range to test when auto-selecting k'

    - name: scaleContVars
      title: 'Scale Continuous Variables'
      type: Bool
      default: true
      description: 'Z-score continuous markers before clustering'

    - name: weights
      title: 'Variable Weights (optional)'
      type: String
      default: ''
      description: 'Comma-separated weights for markers (e.g., "1,1,2,1" for 4 markers)'

    - name: handleMissing
      title: 'Missing Data Method'
      type: List
      options:
          - title: 'Complete cases only'
            name: complete
          - title: 'Pairwise distances'
            name: pairwise
      default: pairwise
      description: 'How to handle missing values'

    - name: consensusClustering
      title: 'Consensus Clustering'
      type: Bool
      default: false
      description: 'Use bootstrap resampling for stable clusters'

    - name: nBootstrap
      title: 'Bootstrap Iterations'
      type: Integer
      min: 50
      max: 1000
      default: 100
      description: 'Number of bootstrap samples for consensus'

    - name: seed
      title: 'Random Seed'
      type: Integer
      default: 42
      description: 'For reproducibility'

    # Visualization options
    - name: showSilhouette
      title: 'Silhouette Plot'
      type: Bool
      default: true
      description: 'Show silhouette width plot for cluster quality'

    - name: showHeatmap
      title: 'Expression Heatmap'
      type: Bool
      default: true
      description: 'Show clustered heatmap of IHC expression'

    - name: heatmapScale
      title: 'Heatmap Scaling'
      type: List
      options:
          - title: 'Row (by marker)'
            name: row
          - title: 'Column (by case)'
            name: column
          - title: 'None'
            name: none
      default: row
      description: 'How to scale heatmap values'

    - name: showDendrogram
      title: 'Show Dendrogram'
      type: Bool
      default: false
      description: 'Show dendrogram for hierarchical clustering'

    - name: showPCAPlot
      title: 'PCA/MCA Plot'
      type: Bool
      default: false
      description: 'Show dimension reduction plot with clusters'

    - name: showBoxplots
      title: 'Marker Distributions'
      type: Bool
      default: false
      description: 'Show boxplots of continuous markers by cluster'


    # Output options
    - name: markerSummary
      title: 'Marker Summary Statistics'
      type: Bool
      default: true
      description: 'Summary statistics for each marker by cluster'

    - name: clusterProfiles
      title: 'Cluster Profiles'
      type: Bool
      default: true
      description: 'Characteristic features of each cluster'

    - name: associationTests
      title: 'Association Tests'
      type: Bool
      default: false
      description: 'Test marker-cluster associations'

    - name: multipleTestingCorrection
      title: 'Multiple Testing Correction'
      type: List
      options:
          - title: 'None'
            name: none
          - title: 'Bonferroni'
            name: bonferroni
          - title: 'Benjamini-Hochberg (FDR)'
            name: fdr
          - title: 'Holm'
            name: holm
      default: bonferroni
      description: 'Correction method for marker association tests'

    - name: markerOptimization
      title: 'Marker Optimization Analysis'
      type: Bool
      default: false
      description: 'Analyze marker importance and identify optimal panel'

    - name: showMarkerCorrelation
      title: 'Show Marker Correlation Matrix'
      type: Bool
      default: false
      description: 'Display correlation structure between markers'

    - name: performMarkerClustering
      title: 'Perform Marker-Level Clustering'
      type: Bool
      default: false
      description: 'Cluster IHC markers to identify co-expression patterns and redundancy'

    - name: markerClusteringMethod
      title: 'Marker Clustering Distance'
      type: List
      options:
          - title: 'Chi-squared (categorical markers)'
            name: chisquared
          - title: 'Jaccard (binary markers)'
            name: jaccard
          - title: 'Hamming (categorical mismatches)'
            name: hamming
          - title: 'Cramér V (normalized association)'
            name: cramer
          - title: 'Euclidean (continuous markers)'
            name: euclidean
          - title: 'Manhattan (continuous markers)'
            name: manhattan
          - title: 'Correlation (continuous markers)'
            name: correlation
          - title: 'Mutual Information (any type)'
            name: mutual_info
          - title: 'Mixed (automatic selection)'
            name: mixed
      default: chisquared
      description: 'Distance metric for marker clustering'

    - name: markerLinkage
      title: 'Marker Linkage Method'
      type: List
      options:
          - title: 'Ward (minimize variance)'
            name: ward
          - title: 'Complete (furthest neighbor)'
            name: complete
          - title: 'Average (mean distance)'
            name: average
      default: ward
      description: 'Linkage method for marker dendrogram'

    - name: markerSignificanceTest
      title: 'Test Marker Associations'
      type: Bool
      default: false
      description: 'Perform statistical tests for marker-marker associations'

    - name: markerCutHeight
      title: 'Auto-detect Marker Groups'
      type: Bool
      default: false
      description: 'Automatically identify statistically distinct marker groups'

    - name: clusterQualityMetrics
      title: 'Cluster Quality Metrics'
      type: Bool
      default: true
      description: 'Calculate PPV, purity, and cluster quality measures'

    - name: iterativeRefinement
      title: 'Iterative Marker Refinement'
      type: Bool
      default: false
      description: 'Perform iterative clustering with marker selection (advanced)'

    - name: refinementIterations
      title: 'Refinement Iterations'
      type: Integer
      min: 2
      max: 5
      default: 3
      description: 'Number of iterative refinement cycles'

    # Sterlacci 2019 Phase 2 Features
    - name: reproducibilityTest
      title: 'Test Cluster Reproducibility'
      type: Bool
      default: false
      description: 'Random split validation with Cohen kappa (Sterlacci 2019)'

    - name: nSplits
      title: 'Number of Random Splits'
      type: Integer
      min: 1
      max: 100
      default: 10
      description: 'Number of random splits for reproducibility testing'

    - name: supervisedClustering
      title: 'Supervised Clustering'
      type: Bool
      default: false
      description: 'Cluster within each known diagnosis group separately'

    - name: supervisedVariable
      title: 'Grouping Variable for Supervised Clustering'
      type: Variable
      suggested:
          - nominal
      permitted:
          - factor
      description: 'Variable defining groups (e.g., histotype, diagnosis)'
      default: NULL

    # Phase 3: Derived Markers (Sterlacci 2019)
    - name: calculateRatios
      title: 'Calculate Marker Ratios'
      type: Bool
      default: false
      description: 'Calculate ratios between continuous markers (e.g., CD4/CD8 ratio)'

    - name: ratioNumerator
      title: 'Ratio Numerator'
      type: Variable
      suggested:
          - continuous
      permitted:
          - numeric
      description: 'Numerator marker for ratio calculation'
      default: NULL

    - name: ratioDenominator
      title: 'Ratio Denominator'
      type: Variable
      suggested:
          - continuous
      permitted:
          - numeric
      description: 'Denominator marker for ratio calculation'
      default: NULL

    - name: ratioName
      title: 'Ratio Variable Name'
      type: String
      default: 'Marker_Ratio'
      description: 'Name for the computed ratio variable'

    - name: ratioClassification
      title: 'Classify Ratio Values'
      type: Bool
      default: false
      description: 'Classify ratio as Low/Intermediate/High using cutoffs'

    - name: ratioLowCutoff
      title: 'Low Cutoff'
      type: Number
      default: 1.0
      description: 'Values ≤ this are classified as Low'

    - name: ratioHighCutoff
      title: 'High Cutoff'
      type: Number
      default: 2.0
      description: 'Values ≥ this are classified as High'

    - name: exportClusters
      title: 'Export Cluster Assignments'
      type: Bool
      default: false
      description: 'Save cluster assignments to dataset'

    # Diagnostic Features (Olsen et al. 2006)
    - name: knownDiagnosis
      title: 'Known Diagnosis (optional)'
      type: Variable
      suggested:
          - nominal
      permitted:
          - factor
      description: 'Known diagnoses for calculating marker performance metrics (sensitivity, specificity, PPV, NPV)'
      default: NULL

    - name: calculateDiagnosticMetrics
      title: 'Calculate Marker Performance Metrics'
      type: Bool
      default: false
      description: 'Compute sensitivity, specificity, PPV, NPV for each marker when diagnosis is known'

    - name: identifyOptimalPanel
      title: 'Identify Optimal Antibody Panels'
      type: Bool
      default: false
      description: 'Find minimal marker combinations with maximum diagnostic discrimination'

    - name: panelSize
      title: 'Antibody Panel Size'
      type: List
      options:
          - name: pairs
            title: '2-marker panels'
          - name: triplets
            title: '3-marker panels'
          - name: both
            title: 'Both 2 and 3-marker panels'
      default: pairs
      description: 'Size of antibody panel combinations to evaluate'

    - name: flagOutliers
      title: 'Flag Atypical Cases'
      type: Bool
      default: true
      description: 'Identify cases with ambiguous/atypical immunoprofiles based on silhouette scores'

    - name: outlierThreshold
      title: 'Outlier Threshold'
      type: Number
      min: 0.0
      max: 0.5
      default: 0.25
      description: 'Silhouette score threshold below which cases are flagged as outliers'

    - name: clinicalVars
      title: 'Clinical Variables (optional)'
      type: Variables
      suggested:
          - nominal
          - ordinal
          - continuous
      permitted:
          - factor
          - numeric
      description: 'Clinical variables to compare across clusters'
      default: NULL

    - name: survivalTime
      title: 'Survival Time (optional)'
      type: Variable
      suggested:
          - continuous
      permitted:
          - numeric
      description: 'Time variable for survival analysis'
      default: NULL

    - name: survivalEvent
      title: 'Survival Event (optional)'
      type: Variable
      suggested:
          - nominal
      permitted:
          - factor
          - numeric
      description: 'Event variable for survival analysis'
      default: NULL

    # Accessibility Options
    - name: colorPalette
      title: 'Color Palette'
      type: List
      options:
          - name: default
            title: 'Default'
          - name: colorblind
            title: 'Colorblind Safe'
          - name: viridis
            title: 'Viridis'
          - name: high_contrast
            title: 'High Contrast'
      default: default
      description: 'Color palette for plots (colorblind-safe options available)'

    - name: fontSize
      title: 'Font Size'
      type: List
      options:
          - name: small
            title: 'Small (10pt)'
          - name: medium
            title: 'Medium (12pt)'
          - name: large
            title: 'Large (14pt)'
          - name: extra_large
            title: 'Extra Large (16pt)'
      default: medium
      description: 'Base font size for all text elements'

    - name: plotContrast
      title: 'High Contrast Mode'
      type: Bool
      default: false
      description: 'Enable high contrast mode for better visibility'

    # Explanatory Output Options
    - name: showInterpretation
      title: 'Show Clinical Interpretation'
      type: Bool
      default: false
      description: 'Display clinical interpretation guide'

    - name: showTechnicalNotes
      title: 'Show Technical Notes'
      type: Bool
      default: false
      description: 'Display technical notes about the analysis'

    - name: showDiagnosticGlossary
      title: 'Show Diagnostic Glossary'
      type: Bool
      default: true
      description: 'Display explanations of sensitivity, specificity, PPV, NPV'


