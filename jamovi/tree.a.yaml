---
name: tree
title: Medical Decision Tree Analysis
menuGroup: meddecideT
menuSubgroup: Clinical Decision Support
menuSubtitle: Advanced Clinical Decision Trees
version: '0.0.3'
jas: '1.2'

description:
    main: |
        Comprehensive decision tree analysis for medical research, pathology and oncology.
        Combines FFTrees (Fast-and-Frugal Trees) and enhanced CART algorithms for robust
        clinical decision support. Provides extensive validation, performance metrics,
        interpretability analysis, and clinical interpretation guidelines.
    R:
        dontrun: false
        usage: |
            # Example for cancer diagnosis with comprehensive analysis
            data(cancer_biomarkers)
            tree(
                data = cancer_biomarkers,
                vars = c("PSA", "age", "tumor_size"),
                facs = c("grade", "stage"),
                target = "diagnosis",
                targetLevel = "cancer",
                algorithm = "fftrees",
                validation = "cv",
                show_performance_metrics = TRUE,
                show_tree_plot = TRUE,
                interpretability = TRUE
            )

options:
    - name: data
      type: Data
      description:
          R: >
            The data as a data frame containing clinical variables, biomarkers, 
            and patient outcomes for decision tree analysis.

    # Core variables
    - name: vars
      title: Continuous Clinical Variables
      type: Variables
      suggested: [continuous]
      permitted: [numeric]
      default: null
      description: >
                  Continuous variables such as biomarker levels, age, 
                  laboratory values, or quantitative pathological measurements.

    - name: facs
      title: Categorical Clinical Variables  
      type: Variables
      suggested: [ordinal, nominal]
      permitted: [factor]
      default: null
      description: >
                  Categorical variables such as tumor grade, stage, 
                  histological type, or patient demographics.

    - name: target
      title: Target Outcome
      type: Variable
      suggested: [ordinal, nominal]
      permitted: [factor]
      description: >
                  Primary outcome variable: disease status, treatment response, 
                  survival status, or diagnostic category.

    - name: targetLevel
      title: Disease/Positive Level
      type: Level
      variable: (target)
      description: >
                  Level representing disease presence, positive outcome, 
                  or event of interest for binary classification.

    # Algorithm selection
    - name: algorithm
      title: Decision Tree Algorithm
      type: List
      options:
        - title: "Enhanced CART (rpart)"
          name: rpart
        - title: "FFTrees (Fast-and-Frugal Trees)"
          name: fftrees
        - title: "C5.0 Classification Trees"
          name: c50
        - title: "Conditional Inference Trees (ctree)"
          name: ctree
        - title: "Model-based Trees (mob)"
          name: mob
        - title: "Random Forest"
          name: randomforest
        - title: "XGBoost"
          name: xgboost
      default: rpart
      description: >
                  Algorithm to use: rpart provides traditional CART with pruning;
                  FFTrees creates simple, interpretable trees for medical decisions;
                  C5.0 offers advanced classification with boosting;
                  ctree uses statistical tests for splits; mob combines trees with parametric models;
                  Random Forest uses ensemble of trees for high accuracy;
                  XGBoost provides gradient boosting for complex patterns.

    - name: tree_mode
      title: Analysis Mode
      type: List
      options:
        - title: "Classification (predict categories)"
          name: classification
        - title: "Regression (predict continuous)"
          name: regression
        - title: "Survival Analysis (censored regression)"
          name: survival
      default: classification
      description: >
                  Type of prediction problem: classification for disease presence/absence,
                  regression for continuous biomarkers, survival for time-to-event analysis.

    # Training/Validation setup
    - name: train
      title: Training/Validation Cohort
      type: Variable
      suggested: [ordinal, nominal]
      permitted: [factor]
      default: null
      description: >
                  Variable indicating training vs validation cohorts. 
                  If not provided, data will be split automatically.

    - name: trainLevel
      title: Training Cohort Level
      type: Level
      variable: (train)
      description: >
                  Level indicating the training/discovery cohort.

    - name: validation
      title: Validation Method
      type: List
      options:
        - title: "Use Training/Validation Variable"
          name: cohort
        - title: "K-Fold Cross-Validation"
          name: cv
        - title: "Bootstrap Validation"
          name: bootstrap
        - title: "Hold-Out Validation"
          name: holdout
        - title: "Time-Based Split"
          name: temporal
        - title: "Stratified K-Fold CV"
          name: stratified_cv
        - title: "Repeated CV"
          name: repeated_cv
      default: cohort
      description: >
                  Validation approach: cohort uses train variable if provided,
                  otherwise performs automatic splitting with selected method.
                  Stratified CV maintains class proportions, Repeated CV averages multiple runs.

    - name: cv_folds
      title: Number of CV Folds
      type: Integer
      default: 5
      min: 3
      max: 10
      description: >
                  Number of folds for cross-validation. 5-fold provides good
                  balance between bias and variance for clinical datasets.

    - name: cv_repeats
      title: CV Repeats
      type: Integer
      default: 3
      min: 1
      max: 10
      description: >
                  Number of times to repeat cross-validation (for repeated CV).
                  More repeats provide more stable estimates but increase computation time.

    - name: stratified_sampling
      title: Stratified Sampling
      type: Bool
      default: true
      description: >
                  Maintain class proportions in train/test splits.
                  Recommended for imbalanced medical datasets.

    - name: data_split_method
      title: Data Splitting Strategy
      type: List
      options:
        - title: "Random Split"
          name: random
        - title: "Stratified Split (maintain class balance)"
          name: stratified
        - title: "Time-based Split (chronological)"
          name: temporal
        - title: "Balanced Split (equal class sizes)"
          name: balanced
      default: stratified
      description: >
                  Method for splitting data into train/test sets.
                  Stratified maintains original class proportions for clinical validity.

    - name: test_split
      title: Test Set Proportion
      type: Number
      default: 0.25
      min: 0.1
      max: 0.5
      description: >
                  Proportion of data reserved for testing (holdout validation).
                  Optimal ratio is 25% test / 75% train as recommended for decision trees.

    # Tree parameters
    - name: max_depth
      title: Maximum Tree Depth
      type: Integer
      default: 6
      min: 2
      max: 15
      description: >
                  Maximum depth of decision tree. Deeper trees capture
                  more interactions but may overfit. Clinical trees typically 2-8 levels.

    - name: min_samples_split
      title: Minimum Samples to Split
      type: Integer
      default: 20
      min: 2
      max: 100
      description: >
                  Minimum number of samples required to split a node.
                  Higher values prevent overfitting in clinical data.

    - name: min_samples_leaf
      title: Minimum Samples per Leaf
      type: Integer
      default: 10
      min: 1
      max: 50
      description: >
                  Minimum number of samples in leaf nodes. Important for
                  clinical validity - too few samples reduce reliability.

    - name: cost_complexity
      title: Cost Complexity (CP)
      type: Number
      default: 0.01
      min: 0.0001
      max: 0.5
      description: >
                  Cost complexity parameter (tidymodels: cost_complexity). Controls pruning - 
                  lower values create more complex trees. Corresponds to CP in rpart.

    - name: min_n
      title: Minimum Node Size (min_n)
      type: Integer
      default: 20
      min: 1
      max: 100
      description: >
                  Minimum number of data points in a node (tidymodels: min_n). 
                  Higher values prevent overfitting in clinical data.

    - name: tree_depth
      title: Tree Depth (tree_depth)
      type: Integer
      default: 6
      min: 1
      max: 20
      description: >
                  Maximum tree depth (tidymodels: tree_depth). Deeper trees capture 
                  more interactions but may overfit. Clinical trees typically 2-8 levels.

    - name: hyperparameter_tuning
      title: Hyperparameter Tuning
      type: Bool
      default: false
      description: >
                  Automatically optimize tree parameters using cross-validation.
                  Finds optimal complexity parameter and tree structure for best performance.

    - name: tuning_metric
      title: Tuning Optimization Metric
      type: List
      options:
        - title: "Balanced Accuracy"
          name: bacc
        - title: "Area Under Curve (AUC)"
          name: auc
        - title: "Sensitivity (Recall)"
          name: sens
        - title: "Specificity"
          name: spec
        - title: "F1 Score"
          name: f1
        - title: "Precision"
          name: prec
      default: bacc
      description: >
                  Metric to optimize during hyperparameter tuning.
                  Choose based on clinical priorities (e.g., sensitivity for screening).

    - name: use_1se_rule
      title: Use 1-SE Rule for Tree Selection
      type: Bool
      default: true
      description: >
                  Apply 1-standard-error rule for selecting simpler models.
                  Chooses most parsimonious tree within 1 SE of optimal performance.

    - name: xerror_pruning
      title: Cross-validation Error Pruning
      type: Bool
      default: false
      description: >
                  Use cross-validation error (xerror) from CP table for optimal pruning.
                  Automatically selects CP value that minimizes xerror.

    - name: auto_prune
      title: Automatic Tree Pruning
      type: Bool
      default: false
      description: >
                  Automatically prune tree to optimal size based on cross-validation.
                  Prevents overfitting while maintaining predictive performance.

    - name: prune_method
      title: Pruning Selection Method
      type: List
      options:
        - title: "Minimum xerror"
          name: min_xerror
        - title: "1-SE rule"
          name: one_se
        - title: "Custom CP threshold"
          name: custom_cp
      default: one_se
      description: >
                  Method for selecting optimal tree size after cross-validation.
                  1-SE rule provides good balance between accuracy and simplicity.

    # Engine-specific options
    - name: c50_trials
      title: C5.0 Boosting Trials
      type: Integer
      default: 1
      min: 1
      max: 100
      description: >
                  Number of boosting iterations for C5.0 algorithm.
                  More trials improve accuracy but reduce interpretability.

    - name: c50_winnow
      title: C5.0 Winnowing
      type: Bool
      default: false
      description: >
                  Enable winnowing in C5.0 to remove irrelevant attributes.
                  Useful for high-dimensional clinical data.

    - name: ctree_mincriterion
      title: ctree Statistical Criterion
      type: Number
      default: 0.95
      min: 0.5
      max: 0.999
      description: >
                  Statistical criterion for ctree splits (1 - p-value threshold).
                  Higher values create simpler, more conservative trees.

    - name: rf_ntree
      title: Random Forest Trees
      type: Integer
      default: 500
      min: 50
      max: 2000
      description: >
                  Number of trees in random forest. More trees generally improve
                  performance but increase computation time.

    - name: rf_mtry
      title: Random Forest Variables per Split
      type: Integer
      default: 0
      min: 0
      max: 50
      description: >
                  Number of variables randomly sampled at each split.
                  0 = automatic selection (sqrt for classification, p/3 for regression).

    - name: xgb_nrounds
      title: XGBoost Rounds
      type: Integer
      default: 100
      min: 10
      max: 1000
      description: >
                  Number of boosting rounds for XGBoost.
                  More rounds can improve performance but risk overfitting.

    - name: xgb_eta
      title: XGBoost Learning Rate
      type: Number
      default: 0.3
      min: 0.01
      max: 1.0
      description: >
                  Learning rate for XGBoost. Lower values require more rounds
                  but can lead to better performance.

    # Reproducibility and Advanced Analysis
    - name: set_seed
      title: Set Random Seed
      type: Bool
      default: true
      description: >
                  Set random seed for reproducible results across runs.
                  Essential for clinical research reproducibility.

    - name: seed_value
      title: Random Seed Value
      type: Integer
      default: 42
      min: 1
      max: 999999
      description: >
                  Specific seed value for random number generation.
                  Use same value to reproduce exact results.

    - name: show_cp_table
      title: Show Complexity Parameter Table
      type: Bool
      default: false
      description: >
                  Display CP table showing tree complexity vs performance.
                  Helps understand pruning decisions and model selection.

    - name: show_variable_importance_detailed
      title: Show Detailed Variable Importance
      type: Bool
      default: false
      description: >
                  Display comprehensive variable importance analysis including
                  surrogate splits and interaction effects.

    # Medical-specific preprocessing
    - name: missing_data_method
      title: Missing Data Handling Method
      type: List
      options:
        - title: "Use rpart native handling (recommended)"
          name: native
        - title: "Median/Mode imputation by disease group"
          name: clinical_impute
        - title: "Multiple imputation (advanced)"
          name: multiple_impute
        - title: "Exclude cases with missing data"
          name: exclude
      default: native
      description: >
                  Method for handling missing clinical data. Native rpart handling 
                  uses surrogate splits, which is often optimal for clinical data.

    - name: balanceClasses
      title: Balance Disease Classes
      type: Bool
      default: false
      description: >
                  Balance classes to handle rare diseases or imbalanced outcomes. 
                  Recommended for disease prevalence <20%.

    - name: ensemble_method
      title: Ensemble Enhancement
      type: List
      options:
        - title: "Single Tree (no ensemble)"
          name: none
        - title: "Bootstrap Aggregating (Bagging)"
          name: bagging
        - title: "Random Forest"
          name: random_forest
      default: none
      description: >
                  Ensemble method to improve prediction accuracy and robustness.
                  Single trees are most interpretable; ensembles offer better performance.

    - name: n_trees
      title: Number of Trees (for ensemble)
      type: Integer
      default: 100
      min: 10
      max: 1000
      description: >
                  Number of trees in ensemble methods. More trees generally improve 
                  performance but increase computation time.

    # Feature analysis
    - name: feature_selection
      title: Automated Feature Selection
      type: Bool
      default: false
      description: >
                  Perform automated feature selection using advanced algorithms.
                  Helps identify most relevant clinical variables and biomarkers.

    - name: feature_selection_method
      title: Feature Selection Method
      type: List
      options:
        - title: "Tree-based Importance (rpart)"
          name: tree_importance
        - title: "Boruta Algorithm (all-relevant)"
          name: boruta
        - title: "Variable Importance (caret)"
          name: var_imp
      default: tree_importance
      description: >
                  Method for feature selection: Tree-based uses rpart importance;
                  Boruta identifies all-relevant features using permutation tests;
                  Variable Importance uses advanced metrics from caret package.

    - name: importance_method
      title: Feature Importance Method
      type: List
      options:
        - title: "Gini Importance"
          name: gini
        - title: "Permutation Importance"
          name: permutation
        - title: "SHAP Values"
          name: shap
      default: gini
      description: >
                  Method for calculating feature importance. Permutation and SHAP
                  provide more reliable importance for clinical interpretation.

    # Output options - Basic
    - name: show_tree_plot
      title: Show Decision Tree Visualization
      type: Bool
      default: true
      description: >
                  Display visual representation of the decision tree.
                  Shows decision paths and node information.

    - name: show_importance_plot
      title: Show Feature Importance Plot
      type: Bool
      default: true
      description: >
                  Display feature importance rankings. Critical for understanding
                  which clinical variables drive predictions.

    - name: show_performance_metrics
      title: Show Performance Metrics
      type: Bool
      default: true
      description: >
                  Display comprehensive performance evaluation including
                  accuracy, sensitivity, specificity, AUC, and clinical metrics.

    - name: show_confusion_matrix
      title: Show Confusion Matrix
      type: Bool
      default: true
      description: >
                  Display detailed confusion matrix with clinical interpretations.
                  Shows actual vs predicted classifications.

    # Output options - Advanced
    - name: show_roc_curve
      title: Show ROC Curve
      type: Bool
      default: true
      description: >
                  Display ROC curve analysis for binary classification.
                  Essential for clinical decision making and threshold selection.

    - name: show_validation_curves
      title: Show Validation Curves
      type: Bool
      default: false
      description: >
                  Display learning curves and validation performance.
                  Helps assess overfitting and training adequacy.

    - name: show_calibration_plot
      title: Show Calibration Plot
      type: Bool
      default: false
      description: >
                  Display probability calibration plot. Important for
                  clinical applications requiring reliable probability estimates.

    - name: showPartitionPlot
      title: Show Partition Plot (2D Variables Only)
      type: Bool
      default: false
      description: >
                  Display 2D decision boundary visualization using parttree. 
                  Requires exactly 2 continuous variables for optimal visualization.

    - name: show_cp_plot
      title: Show Complexity Parameter Plot
      type: Bool
      default: false
      description: >
                  Display CP plot showing cross-validation error vs tree complexity.
                  Essential for understanding optimal pruning levels.

    - name: tree_plot_style
      title: Tree Plot Style
      type: List
      options:
        - title: "Standard rpart.plot"
          name: standard
        - title: "Compact medical style"
          name: medical
        - title: "Detailed clinical style"
          name: clinical
      default: standard
      description: >
                  Visualization style optimized for different clinical audiences.
                  Medical: simplified for clinical staff; Clinical: detailed for researchers.

    - name: show_node_statistics
      title: Show Node Statistics
      type: Bool
      default: false
      description: >
                  Display detailed statistics for each node including sample sizes,
                  purity measures, and class distributions.

    # Interpretability options
    - name: interpretability
      title: Enhanced Interpretability Analysis
      type: Bool
      default: false
      description: >
                  Perform advanced interpretability analysis including
                  SHAP values, partial dependence plots, and interaction effects.

    - name: shap_analysis
      title: SHAP Value Analysis
      type: Bool
      default: false
      description: >
                  Calculate SHAP (SHapley Additive exPlanations) values for
                  individual prediction explanations. Powerful for clinical decision support.

    - name: partial_dependence
      title: Partial Dependence Plots
      type: Bool
      default: false
      description: >
                  Show how individual features affect predictions across
                  their value ranges. Helps understand clinical relationships.

    - name: interaction_analysis
      title: Feature Interaction Analysis
      type: Bool
      default: false
      description: >
                  Analyze interactions between clinical variables.
                  Important for understanding combined effects of biomarkers.

    # Clinical context and interpretation
    - name: clinical_context
      title: Clinical Context
      type: List
      options:
        - title: "General Diagnosis"
          name: diagnosis
        - title: "Cancer Screening"
          name: screening
        - title: "Cancer Staging"
          name: staging
        - title: "Prognosis Prediction"
          name: prognosis
        - title: "Treatment Response"
          name: treatment
        - title: "Biomarker Discovery"
          name: biomarker
        - title: "Risk Stratification"
          name: risk
      default: diagnosis
      description: >
                  Clinical application context. Affects performance thresholds,
                  interpretation guidelines, and visualization emphasis.

    - name: cost_sensitive_thresholds
      title: Cost-Sensitive Threshold Optimization
      type: Bool
      default: false
      description: >
                  Optimize decision thresholds considering clinical costs
                  of false positives vs false negatives.

    - name: fn_fp_ratio
      title: False Negative to False Positive Cost Ratio
      type: Number
      default: 1
      min: 0.1
      max: 10
      description: >
                  Relative cost of missing a positive case vs false alarm.
                  Screening (high ratio), confirmation tests (low ratio).

    - name: prevalenceAdjustment
      title: Adjust for Population Prevalence
      type: Bool
      default: false
      description: >
                  Adjust predictive values for expected disease prevalence 
                  in target population (different from study sample).

    - name: expectedPrevalence
      title: Expected Population Prevalence (%)
      type: Number
      default: 10
      min: 0.1
      max: 50
      description: >
                  Expected disease prevalence in target population for 
                  adjusted predictive value calculations.

    # Advanced validation and confidence
    - name: bootstrap_confidence
      title: Bootstrap Confidence Intervals
      type: Bool
      default: false
      description: >
                  Calculate bootstrap confidence intervals for performance
                  metrics. Provides uncertainty quantification for clinical reporting.

    - name: n_bootstrap
      title: Number of Bootstrap Samples
      type: Integer
      default: 1000
      min: 100
      max: 5000
      description: >
                  Number of bootstrap samples for confidence interval calculation.
                  More samples provide better estimates but increase computation time.

    - name: model_comparison
      title: Compare Multiple Algorithms
      type: Bool
      default: false
      description: >
                  Compare performance of multiple algorithms (FFTrees, CART, Logistic Regression).
                  Useful for selecting the best approach for your data.

    - name: modelComparisonMetric
      title: Comparison Metric
      type: List
      options:
        - title: "Balanced Accuracy"
          name: bacc
        - title: "AUC"
          name: auc
        - title: "Sensitivity"
          name: sens
        - title: "Specificity"
          name: spec
        - title: "F1 Score"
          name: f1
      default: bacc
      description: >
                  Primary metric for comparing algorithms. Choose based on
                  clinical priorities (sensitivity for screening, specificity for confirmation).

    # Export and reporting
    - name: export_model
      title: Export Trained Model
      type: Bool
      default: false
      description: >
                  Export the trained model for external use or deployment.
                  Useful for clinical decision support system integration.

    - name: exportPredictions
      title: Export Predictions
      type: Bool
      default: false
      description: >
                  Add predicted classifications and probabilities to the dataset
                  for further analysis or reporting.

    - name: show_clinical_interpretation
      title: Show Clinical Interpretation Guide
      type: Bool
      default: true
      description: >
                  Display comprehensive clinical interpretation guidelines
                  specific to the selected clinical context and results.

    # Model stability and robustness analysis
    - name: model_stability_analysis
      title: Model Stability Analysis
      type: Bool
      default: false
      description: >
                  Analyze model stability across bootstrap samples by examining
                  consistency of splits, variable selection, and predictions.

    - name: learning_curves
      title: Learning Curves Analysis
      type: Bool
      default: false
      description: >
                  Display learning curves showing performance vs training size.
                  Helps determine optimal sample size and detect overfitting.

    - name: outlier_analysis
      title: Outlier Detection and Analysis
      type: Bool
      default: false
      description: >
                  Identify influential observations and outliers that may
                  disproportionately affect tree structure and predictions.

    - name: prediction_intervals
      title: Prediction Confidence Intervals
      type: Bool
      default: false
      description: >
                  Calculate confidence intervals for individual predictions
                  using bootstrap or cross-validation methods.

    - name: advanced_pruning
      title: Advanced Pruning Method
      type: List
      options:
        - title: "Standard Cost-Complexity (CP) Pruning"
          name: cp
        - title: "Reduced Error Pruning (REP)"
          name: rep
        - title: "Minimum Error Pruning (MEP)"
          name: mep
      default: cp
      description: >
                  Pruning method: CP uses cross-validation error, REP uses holdout validation,
                  MEP considers both error and tree size for optimal clinical interpretability.

    - name: pruning_validation_split
      title: Pruning Validation Split
      type: Number
      default: 0.2
      min: 0.1
      max: 0.4
      description: >
                  Proportion of data reserved for pruning validation (REP/MEP methods).
                  This is separate from the main test set.

...
