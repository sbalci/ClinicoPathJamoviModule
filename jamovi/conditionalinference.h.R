
# This file is automatically generated, you probably don't want to edit this

conditionalinferenceOptions <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "conditionalinferenceOptions",
    inherit = jmvcore::Options,
    public = list(
        initialize = function(
            time = NULL,
            event = NULL,
            predictors = NULL,
            strata = NULL,
            teststat = "quad",
            testtype = "Bonferroni",
            mincriterion = 0.95,
            minsplit = 20,
            minbucket = 7,
            maxdepth = 5,
            nresample = 9999,
            logrank_scores = TRUE,
            show_splits = TRUE,
            show_nodes = TRUE,
            show_importance = TRUE,
            plot_tree = TRUE,
            plot_survival = TRUE,
            plot_importance = FALSE,
            mtry = NULL,
            replace = FALSE,
            subset = NULL, ...) {

            super$initialize(
                package="ClinicoPath",
                name="conditionalinference",
                requiresData=TRUE,
                ...)

            private$..time <- jmvcore::OptionVariable$new(
                "time",
                time,
                suggested=list(
                    "continuous"),
                permitted=list(
                    "numeric"))
            private$..event <- jmvcore::OptionVariable$new(
                "event",
                event,
                suggested=list(
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "factor",
                    "numeric"))
            private$..predictors <- jmvcore::OptionVariables$new(
                "predictors",
                predictors,
                suggested=list(
                    "continuous",
                    "ordinal",
                    "nominal"),
                permitted=list(
                    "numeric",
                    "factor"))
            private$..strata <- jmvcore::OptionVariable$new(
                "strata",
                strata,
                suggested=list(
                    "nominal",
                    "ordinal"),
                permitted=list(
                    "factor"))
            private$..teststat <- jmvcore::OptionList$new(
                "teststat",
                teststat,
                options=list(
                    "quad",
                    "max"),
                default="quad")
            private$..testtype <- jmvcore::OptionList$new(
                "testtype",
                testtype,
                options=list(
                    "Bonferroni",
                    "MonteCarlo",
                    "Univariate",
                    "Teststatistic"),
                default="Bonferroni")
            private$..mincriterion <- jmvcore::OptionNumber$new(
                "mincriterion",
                mincriterion,
                default=0.95,
                min=0.5,
                max=0.999)
            private$..minsplit <- jmvcore::OptionInteger$new(
                "minsplit",
                minsplit,
                default=20,
                min=2,
                max=1000)
            private$..minbucket <- jmvcore::OptionInteger$new(
                "minbucket",
                minbucket,
                default=7,
                min=1,
                max=500)
            private$..maxdepth <- jmvcore::OptionInteger$new(
                "maxdepth",
                maxdepth,
                default=5,
                min=1,
                max=15)
            private$..nresample <- jmvcore::OptionInteger$new(
                "nresample",
                nresample,
                default=9999,
                min=1000,
                max=50000)
            private$..logrank_scores <- jmvcore::OptionBool$new(
                "logrank_scores",
                logrank_scores,
                default=TRUE)
            private$..show_splits <- jmvcore::OptionBool$new(
                "show_splits",
                show_splits,
                default=TRUE)
            private$..show_nodes <- jmvcore::OptionBool$new(
                "show_nodes",
                show_nodes,
                default=TRUE)
            private$..show_importance <- jmvcore::OptionBool$new(
                "show_importance",
                show_importance,
                default=TRUE)
            private$..plot_tree <- jmvcore::OptionBool$new(
                "plot_tree",
                plot_tree,
                default=TRUE)
            private$..plot_survival <- jmvcore::OptionBool$new(
                "plot_survival",
                plot_survival,
                default=TRUE)
            private$..plot_importance <- jmvcore::OptionBool$new(
                "plot_importance",
                plot_importance,
                default=FALSE)
            private$..mtry <- jmvcore::OptionInteger$new(
                "mtry",
                mtry,
                min=1)
            private$..replace <- jmvcore::OptionBool$new(
                "replace",
                replace,
                default=FALSE)
            private$..subset <- jmvcore::OptionNumber$new(
                "subset",
                subset,
                min=0.1,
                max=1)

            self$.addOption(private$..time)
            self$.addOption(private$..event)
            self$.addOption(private$..predictors)
            self$.addOption(private$..strata)
            self$.addOption(private$..teststat)
            self$.addOption(private$..testtype)
            self$.addOption(private$..mincriterion)
            self$.addOption(private$..minsplit)
            self$.addOption(private$..minbucket)
            self$.addOption(private$..maxdepth)
            self$.addOption(private$..nresample)
            self$.addOption(private$..logrank_scores)
            self$.addOption(private$..show_splits)
            self$.addOption(private$..show_nodes)
            self$.addOption(private$..show_importance)
            self$.addOption(private$..plot_tree)
            self$.addOption(private$..plot_survival)
            self$.addOption(private$..plot_importance)
            self$.addOption(private$..mtry)
            self$.addOption(private$..replace)
            self$.addOption(private$..subset)
        }),
    active = list(
        time = function() private$..time$value,
        event = function() private$..event$value,
        predictors = function() private$..predictors$value,
        strata = function() private$..strata$value,
        teststat = function() private$..teststat$value,
        testtype = function() private$..testtype$value,
        mincriterion = function() private$..mincriterion$value,
        minsplit = function() private$..minsplit$value,
        minbucket = function() private$..minbucket$value,
        maxdepth = function() private$..maxdepth$value,
        nresample = function() private$..nresample$value,
        logrank_scores = function() private$..logrank_scores$value,
        show_splits = function() private$..show_splits$value,
        show_nodes = function() private$..show_nodes$value,
        show_importance = function() private$..show_importance$value,
        plot_tree = function() private$..plot_tree$value,
        plot_survival = function() private$..plot_survival$value,
        plot_importance = function() private$..plot_importance$value,
        mtry = function() private$..mtry$value,
        replace = function() private$..replace$value,
        subset = function() private$..subset$value),
    private = list(
        ..time = NA,
        ..event = NA,
        ..predictors = NA,
        ..strata = NA,
        ..teststat = NA,
        ..testtype = NA,
        ..mincriterion = NA,
        ..minsplit = NA,
        ..minbucket = NA,
        ..maxdepth = NA,
        ..nresample = NA,
        ..logrank_scores = NA,
        ..show_splits = NA,
        ..show_nodes = NA,
        ..show_importance = NA,
        ..plot_tree = NA,
        ..plot_survival = NA,
        ..plot_importance = NA,
        ..mtry = NA,
        ..replace = NA,
        ..subset = NA)
)

conditionalinferenceResults <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "conditionalinferenceResults",
    inherit = jmvcore::Group,
    active = list(
        todo = function() private$.items[["todo"]],
        modelSummary = function() private$.items[["modelSummary"]],
        splitStatistics = function() private$.items[["splitStatistics"]],
        nodeDetails = function() private$.items[["nodeDetails"]],
        variableImportance = function() private$.items[["variableImportance"]],
        treePlot = function() private$.items[["treePlot"]],
        survivalPlot = function() private$.items[["survivalPlot"]],
        importancePlot = function() private$.items[["importancePlot"]]),
    private = list(),
    public=list(
        initialize=function(options) {
            super$initialize(
                options=options,
                name="",
                title="Conditional Inference Trees for Survival",
                refs=list(
                    "Hothorn2006",
                    "Strobl2007",
                    "Survival",
                    "ClinicoPathJamoviModule"))
            self$add(jmvcore::Html$new(
                options=options,
                name="todo",
                title="TODO",
                visible=TRUE))
            self$add(jmvcore::Table$new(
                options=options,
                name="modelSummary",
                title="Model Summary",
                visible="(show_splits)",
                rows=0,
                columns=list(
                    list(
                        `name`="parameter", 
                        `title`="Parameter", 
                        `type`="text"),
                    list(
                        `name`="value", 
                        `title`="Value", 
                        `type`="text"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="splitStatistics",
                title="Split Statistics",
                visible="(show_splits)",
                rows=0,
                columns=list(
                    list(
                        `name`="node", 
                        `title`="Node", 
                        `type`="integer"),
                    list(
                        `name`="variable", 
                        `title`="Split Variable", 
                        `type`="text"),
                    list(
                        `name`="cutpoint", 
                        `title`="Split Point", 
                        `type`="text"),
                    list(
                        `name`="statistic", 
                        `title`="Test Statistic", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="pvalue", 
                        `title`="P-value", 
                        `type`="number", 
                        `format`="zto,pvalue"),
                    list(
                        `name`="n_left", 
                        `title`="Left n", 
                        `type`="integer"),
                    list(
                        `name`="n_right", 
                        `title`="Right n", 
                        `type`="integer"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="nodeDetails",
                title="Terminal Node Details",
                visible="(show_nodes)",
                rows=0,
                columns=list(
                    list(
                        `name`="node", 
                        `title`="Node", 
                        `type`="integer"),
                    list(
                        `name`="n", 
                        `title`="Sample Size", 
                        `type`="integer"),
                    list(
                        `name`="events", 
                        `title`="Events", 
                        `type`="integer"),
                    list(
                        `name`="median_survival", 
                        `title`="Median Survival", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="survival_se", 
                        `title`="SE", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="survival_lower", 
                        `title`="Lower 95% CI", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="survival_upper", 
                        `title`="Upper 95% CI", 
                        `type`="number", 
                        `format`="zto"))))
            self$add(jmvcore::Table$new(
                options=options,
                name="variableImportance",
                title="Variable Importance",
                visible="(show_importance)",
                rows=0,
                columns=list(
                    list(
                        `name`="variable", 
                        `title`="Variable", 
                        `type`="text"),
                    list(
                        `name`="importance", 
                        `title`="Importance", 
                        `type`="number", 
                        `format`="zto"),
                    list(
                        `name`="rank", 
                        `title`="Rank", 
                        `type`="integer"))))
            self$add(jmvcore::Image$new(
                options=options,
                name="treePlot",
                title="Conditional Inference Tree",
                width=800,
                height=600,
                visible="(plot_tree)",
                renderFun=".plotTree",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="survivalPlot",
                title="Node Survival Curves",
                width=800,
                height=600,
                visible="(plot_survival)",
                renderFun=".plotSurvival",
                requiresData=TRUE))
            self$add(jmvcore::Image$new(
                options=options,
                name="importancePlot",
                title="Variable Importance Plot",
                width=600,
                height=400,
                visible="(plot_importance)",
                renderFun=".plotImportance",
                requiresData=TRUE))}))

conditionalinferenceBase <- if (requireNamespace("jmvcore", quietly=TRUE)) R6::R6Class(
    "conditionalinferenceBase",
    inherit = jmvcore::Analysis,
    public = list(
        initialize = function(options, data=NULL, datasetId="", analysisId="", revision=0) {
            super$initialize(
                package = "ClinicoPath",
                name = "conditionalinference",
                version = c(0,0,31),
                options = options,
                results = conditionalinferenceResults$new(options=options),
                data = data,
                datasetId = datasetId,
                analysisId = analysisId,
                revision = revision,
                pause = NULL,
                completeWhenFilled = FALSE,
                requiresMissings = FALSE,
                weightsSupport = 'auto')
        }))

#' Conditional Inference Trees for Survival
#'
#' Conditional Inference Trees for survival analysis using unbiased recursive 
#' partitioning. This method addresses the variable selection bias inherent in 
#' traditional CART by employing conditional inference procedures. The 
#' algorithm separates variable selection from splitting point selection, 
#' providing unbiased tree structures particularly valuable for survival data 
#' with mixed-type predictors and complex censoring patterns. Features include 
#' statistical significance-based stopping criteria, handling of  missing 
#' values without surrogate splits, and robust performance with correlated 
#' predictors. The method is particularly suitable for exploratory survival 
#' analysis and biomarker discovery in clinical research.
#' 
#'
#' @examples
#' result <- conditionalinference(
#'     data = mydata,
#'     time = "time_to_event",
#'     event = "event_indicator",
#'     predictors = c("age", "stage", "biomarker"),
#'     mincriterion = 0.95,
#'     minsplit = 20,
#'     minbucket = 7,
#'     maxdepth = 5
#' )
#'
#' @param data The data as a data frame.
#' @param time Time to event variable (numeric). For right-censored data, this
#'   is the  time from study entry to event or censoring.
#' @param event Event indicator variable. For survival analysis: 0 = censored,
#'   1 = event. For competing risks: 0 = censored, 1+ = different event types.
#' @param predictors Variables to use for tree construction. Can include
#'   continuous,  ordinal, and nominal variables. The algorithm handles
#'   mixed-type predictors optimally.
#' @param strata Optional stratification variable for stratified survival
#'   analysis. Creates separate baseline hazards for each stratum.
#' @param teststat Test statistic to use. 'quad' uses quadratic form for
#'   multivariate tests, 'max' uses maximum-type statistic. Quadratic form is
#'   more powerful for small effects, maximum-type for large effects.
#' @param testtype Multiple testing correction method. Bonferroni provides
#'   conservative but reliable correction. Monte Carlo uses permutation-based
#'   p-values.
#' @param mincriterion Minimum criterion (1 - p-value) for variable selection.
#'   Higher values create more conservative trees with fewer splits. Default
#'   0.95 corresponds to significance level of 0.05.
#' @param minsplit Minimum number of observations required in a node before
#'   splitting. Higher values create simpler trees and reduce overfitting.
#' @param minbucket Minimum number of observations in terminal nodes. Should
#'   be smaller than minsplit. Higher values increase tree stability.
#' @param maxdepth Maximum depth of the tree. Controls tree complexity and
#'   prevents overfitting. Deeper trees may overfit, shallower trees may
#'   underfit.
#' @param nresample Number of Monte Carlo resamples for p-value computation
#'   when using Monte Carlo test type. More resamples provide more accurate
#'   p-values but increase computation time.
#' @param logrank_scores Use log-rank scores for survival splitting. When
#'   TRUE, uses log-rank statistics optimized for survival data. When FALSE,
#'   uses standard conditional inference.
#' @param show_splits Display detailed split statistics including test
#'   statistics, p-values, and variable importance measures.
#' @param show_nodes Display detailed information for each terminal node
#'   including Kaplan-Meier estimates, risk tables, and survival summaries.
#' @param show_importance Calculate and display variable importance measures
#'   based on the improvement in prediction accuracy.
#' @param plot_tree Generate tree structure plot with nodes, splits, and
#'   survival curves.
#' @param plot_survival Plot Kaplan-Meier survival curves for each terminal
#'   node with confidence intervals and risk tables.
#' @param plot_importance Generate variable importance plot showing relative
#'   importance of predictors in tree construction.
#' @param mtry Number of variables randomly selected at each split. Leave
#'   empty to use all variables. Setting this creates a random forest-like
#'   approach.
#' @param replace Use bootstrap sampling with replacement for tree
#'   construction. Creates more robust trees but may reduce interpretability.
#' @param subset Fraction of observations to use for tree construction. Leave
#'   empty to use all observations. Useful for large datasets.
#' @return A results object containing:
#' \tabular{llllll}{
#'   \code{results$todo} \tab \tab \tab \tab \tab a html \cr
#'   \code{results$modelSummary} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$splitStatistics} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$nodeDetails} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$variableImportance} \tab \tab \tab \tab \tab a table \cr
#'   \code{results$treePlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$survivalPlot} \tab \tab \tab \tab \tab an image \cr
#'   \code{results$importancePlot} \tab \tab \tab \tab \tab an image \cr
#' }
#'
#' Tables can be converted to data frames with \code{asDF} or \code{\link{as.data.frame}}. For example:
#'
#' \code{results$modelSummary$asDF}
#'
#' \code{as.data.frame(results$modelSummary)}
#'
#' @export
conditionalinference <- function(
    data,
    time,
    event,
    predictors,
    strata,
    teststat = "quad",
    testtype = "Bonferroni",
    mincriterion = 0.95,
    minsplit = 20,
    minbucket = 7,
    maxdepth = 5,
    nresample = 9999,
    logrank_scores = TRUE,
    show_splits = TRUE,
    show_nodes = TRUE,
    show_importance = TRUE,
    plot_tree = TRUE,
    plot_survival = TRUE,
    plot_importance = FALSE,
    mtry,
    replace = FALSE,
    subset) {

    if ( ! requireNamespace("jmvcore", quietly=TRUE))
        stop("conditionalinference requires jmvcore to be installed (restart may be required)")

    if ( ! missing(time)) time <- jmvcore::resolveQuo(jmvcore::enquo(time))
    if ( ! missing(event)) event <- jmvcore::resolveQuo(jmvcore::enquo(event))
    if ( ! missing(predictors)) predictors <- jmvcore::resolveQuo(jmvcore::enquo(predictors))
    if ( ! missing(strata)) strata <- jmvcore::resolveQuo(jmvcore::enquo(strata))
    if (missing(data))
        data <- jmvcore::marshalData(
            parent.frame(),
            `if`( ! missing(time), time, NULL),
            `if`( ! missing(event), event, NULL),
            `if`( ! missing(predictors), predictors, NULL),
            `if`( ! missing(strata), strata, NULL))

    for (v in strata) if (v %in% names(data)) data[[v]] <- as.factor(data[[v]])

    options <- conditionalinferenceOptions$new(
        time = time,
        event = event,
        predictors = predictors,
        strata = strata,
        teststat = teststat,
        testtype = testtype,
        mincriterion = mincriterion,
        minsplit = minsplit,
        minbucket = minbucket,
        maxdepth = maxdepth,
        nresample = nresample,
        logrank_scores = logrank_scores,
        show_splits = show_splits,
        show_nodes = show_nodes,
        show_importance = show_importance,
        plot_tree = plot_tree,
        plot_survival = plot_survival,
        plot_importance = plot_importance,
        mtry = mtry,
        replace = replace,
        subset = subset)

    analysis <- conditionalinferenceClass$new(
        options = options,
        data = data)

    analysis$run()

    analysis$results
}

