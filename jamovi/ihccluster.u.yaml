title: IHC Clustering Analysis
name: ihccluster
jus: '3.0'
stage: 0
compilerMode: tame
children:
  # ============================================================================
  # Variable Selection
  # ============================================================================
  - type: VariableSupplier
    persistentItems: false
    stretchFactor: 1
    children:
      - type: TargetLayoutBox
        label: Categorical IHC Markers (pos/neg, 0/1/2/3)
        children:
          - type: VariablesListBox
            name: catVars
            isTarget: true
      - type: TargetLayoutBox
        label: Continuous IHC Markers (H-scores, % positivity)
        children:
          - type: VariablesListBox
            name: contVars
            isTarget: true
      - type: TargetLayoutBox
        label: Case Identifier (optional)
        children:
          - type: VariablesListBox
            name: caseId
            maxItemCount: 1
            isTarget: true
      - type: TargetLayoutBox
        label: Spatial Compartment Variable (optional)
        children:
          - type: VariablesListBox
            name: spatialCompartment
            maxItemCount: 1
            isTarget: true

  # ============================================================================
  # Clustering Settings
  # ============================================================================
  - type: CollapseBox
    label: Clustering Settings
    collapsed: false
    children:
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Clustering Method
          - type: ComboBox
            name: method
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Distance Metric
          - type: ComboBox
            name: distanceMethod
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Linkage Method (hierarchical only)
          - type: ComboBox
            name: linkageMethod
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Number of Clusters
          - type: TextBox
            name: nClusters
            format: number
      - type: CheckBox
        name: autoSelectK
        label: Automatically select optimal k
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Range for automatic k selection
          - type: ComboBox
            name: kRange
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Random seed (for reproducibility)
          - type: TextBox
            name: seed
            format: number

  # ============================================================================
  # Data Preprocessing
  # ============================================================================
  - type: CollapseBox
    label: Data Preprocessing
    collapsed: true
    children:
      - type: CheckBox
        name: scaleContVars
        label: Scale continuous variables (z-score)
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Missing Data Handling
          - type: ComboBox
            name: handleMissing
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Variable Weights (comma-separated, optional)
          - type: TextBox
            name: weights
            format: string

  # ============================================================================
  # Phase 3: Derived Markers (Sterlacci 2019)
  # ============================================================================
  - type: CollapseBox
    label: Derived Markers (CD4/CD8 Ratio)
    collapsed: true
    children:
      - type: CheckBox
        name: calculateRatios
        label: Calculate marker ratios (e.g., CD4/CD8)
      - type: VariableSupplier
        persistentItems: false
        stretchFactor: 1
        children:
          - type: TargetLayoutBox
            label: Ratio Numerator
            children:
              - type: VariablesListBox
                name: ratioNumerator
                maxItemCount: 1
                isTarget: true
          - type: TargetLayoutBox
            label: Ratio Denominator
            children:
              - type: VariablesListBox
                name: ratioDenominator
                maxItemCount: 1
                isTarget: true
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Ratio Variable Name
          - type: TextBox
            name: ratioName
            format: string
      - type: CheckBox
        name: ratioClassification
        label: Classify ratio as Low/Intermediate/High
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Low Cutoff (≤)
          - type: TextBox
            name: ratioLowCutoff
            format: number
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: High Cutoff (≥)
          - type: TextBox
            name: ratioHighCutoff
            format: number

  # ============================================================================
  # Spatial Analysis
  # ============================================================================
  - type: CollapseBox
    label: Spatial Compartment Analysis
    collapsed: true
    children:
      - type: CheckBox
        name: performSpatialAnalysis
        label: Perform spatial compartment analysis
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Spatial Comparison Mode
          - type: ComboBox
            name: spatialComparisonMode

  # ============================================================================
  # Phase 2: Validation & Supervised Clustering (Sterlacci 2019)
  # ============================================================================
  - type: CollapseBox
    label: Cluster Validation (Sterlacci 2019)
    collapsed: true
    children:
      - type: CheckBox
        name: reproducibilityTest
        label: Test cluster reproducibility (random split + Cohen's kappa)
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Number of Random Splits
          - type: TextBox
            name: nSplits
            format: number
      - type: CheckBox
        name: supervisedClustering
        label: Supervised clustering (cluster within diagnosis groups)
      - type: VariableSupplier
        persistentItems: false
        stretchFactor: 1
        children:
          - type: TargetLayoutBox
            label: Grouping Variable (e.g., diagnosis, histotype)
            children:
              - type: VariablesListBox
                name: supervisedVariable
                maxItemCount: 1
                isTarget: true

  # ============================================================================
  # Advanced Options
  # ============================================================================
  - type: CollapseBox
    label: Advanced Clustering Options
    collapsed: true
    children:
      - type: CheckBox
        name: consensusClustering
        label: Perform consensus clustering (bootstrap resampling)
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Bootstrap Iterations
          - type: TextBox
            name: nBootstrap
            format: number
      - type: CheckBox
        name: markerOptimization
        label: Marker optimization analysis
      - type: CheckBox
        name: iterativeRefinement
        label: Iterative marker refinement
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Refinement Iterations
          - type: TextBox
            name: refinementIterations
            format: number

  # ============================================================================
  # Diagnostic Features (Olsen 2006)
  # ============================================================================
  - type: CollapseBox
    label: Diagnostic Features (Olsen 2006)
    collapsed: true
    children:
      - type: VariableSupplier
        persistentItems: false
        stretchFactor: 1
        children:
          - type: TargetLayoutBox
            label: Known Diagnosis (for marker performance)
            children:
              - type: VariablesListBox
                name: knownDiagnosis
                maxItemCount: 1
                isTarget: true
      - type: CheckBox
        name: calculateDiagnosticMetrics
        label: Calculate marker performance (sensitivity, specificity, PPV, NPV)
      - type: CheckBox
        name: identifyOptimalPanel
        label: Identify optimal antibody panels
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Antibody Panel Size
          - type: ComboBox
            name: panelSize
      - type: CheckBox
        name: flagOutliers
        label: Flag atypical cases (low silhouette scores)
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Outlier Threshold (silhouette score)
          - type: TextBox
            name: outlierThreshold
            format: number

  # ============================================================================
  # Visualizations
  # ============================================================================
  - type: CollapseBox
    label: Visualizations
    collapsed: false
    children:
      - type: CheckBox
        name: showSilhouette
        label: Silhouette plot (cluster quality)
      - type: CheckBox
        name: showHeatmap
        label: Expression heatmap
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Heatmap Scaling
          - type: ComboBox
            name: heatmapScale
      - type: CheckBox
        name: showDendrogram
        label: Dendrogram (hierarchical clustering only)
      - type: CheckBox
        name: showPCAPlot
        label: PCA/MCA dimension reduction plot
      - type: CheckBox
        name: showBoxplots
        label: Marker distribution boxplots

  # ============================================================================
  # Output Tables
  # ============================================================================
  - type: CollapseBox
    label: Output Tables & Statistics
    collapsed: false
    children:
      - type: CheckBox
        name: markerSummary
        label: Marker summary statistics by cluster
      - type: CheckBox
        name: clusterProfiles
        label: Cluster characteristic profiles
      - type: CheckBox
        name: associationTests
        label: Marker-cluster association tests
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Multiple Testing Correction
          - type: ComboBox
            name: multipleTestingCorrection
      - type: CheckBox
        name: clusterQualityMetrics
        label: Cluster quality metrics (PPV, purity)
      - type: CheckBox
        name: showMarkerCorrelation
        label: Marker correlation matrix
      - type: CheckBox
        name: exportClusters
        label: Export cluster assignments to dataset

  # ============================================================================
  # Clinical Correlations
  # ============================================================================
  - type: CollapseBox
    label: Clinical Correlations (optional)
    collapsed: true
    children:
      - type: VariableSupplier
        persistentItems: false
        stretchFactor: 1
        children:
          - type: TargetLayoutBox
            label: Clinical Variables
            children:
              - type: VariablesListBox
                name: clinicalVars
                isTarget: true
          - type: TargetLayoutBox
            label: Survival Time
            children:
              - type: VariablesListBox
                name: survivalTime
                maxItemCount: 1
                isTarget: true
          - type: TargetLayoutBox
            label: Survival Event (0/1)
            children:
              - type: VariablesListBox
                name: survivalEvent
                maxItemCount: 1
                isTarget: true

  # ============================================================================
  # Accessibility & Display
  # ============================================================================
  - type: CollapseBox
    label: Accessibility & Display
    collapsed: true
    children:
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Color Palette
          - type: ComboBox
            name: colorPalette
      - type: LayoutBox
        margin: large
        children:
          - type: Label
            label: Font Size
          - type: ComboBox
            name: fontSize
      - type: CheckBox
        name: plotContrast
        label: High Contrast Mode
      - type: CheckBox
        name: showInterpretation
        label: Show clinical interpretation guide
      - type: CheckBox
        name: showTechnicalNotes
        label: Show technical notes
