# Q-TWiST Implementation - Complete ✅

**Date:** November 3, 2025
**Status:** Successfully compiled and ready for testing

---

## Overview

Q-TWiST (Quality-adjusted Time Without Symptoms or Toxicity) analysis has been fully implemented in the ClinicoPath jamovi module. This advanced survival analysis method partitions overall survival into three health states with quality-of-life weights, providing a comprehensive measure that accounts for both quantity and quality of survival time.

---

## Files Created/Modified

### 1. Test Datasets
**File:** `data-raw/qtwist_test_data.R`

Three comprehensive test datasets for different clinical scenarios:
- **qtwist_breast_cancer** (400 patients) - Adjuvant therapy trial
- **qtwist_lung_simple** (200 patients) - Simplified demonstration
- **qtwist_colorectal** (300 patients) - Three-arm trial

### 2. Analysis Options
**File:** `jamovi/qtwist.a.yaml` (18 KB)

40+ configurable parameters including:
- Overall survival and progression-free survival variables
- Event level selection for factor variables
- **Three toxicity assessment methods:**
  - Fixed time window (e.g., first 3 months)
  - Individual patient-specific durations
  - Time periods with start/end times
- Utility weights for TOX, TWiST, REL states (0-1 scale)
- Bootstrap confidence intervals (100-10,000 samples)
- Sensitivity analysis with utility ranges
- Threshold analysis for break-even points
- Stratification options
- Multiple visualization controls

### 3. Results Structure
**File:** `jamovi/qtwist.r.yaml` (14 KB)

**10 Comprehensive Tables:**
1. Descriptive statistics by treatment
2. RMST components (OS and PFS)
3. Health state partition (TOX, TWiST, REL)
4. Q-TWiST scores with confidence intervals
5. Treatment difference with clinical significance
6. State-specific differences
7. Sensitivity analysis table
8. Threshold utility analysis
9. Statistical formulas (optional)
10. Key references (optional)

**5 Visualization Types:**
1. Partitioned survival plot (stacked areas)
2. Q-TWiST component comparison (stacked bars)
3. Sensitivity heatmap with contours
4. Kaplan-Meier reference curves
5. Forest plot for stratified analysis

**Educational Content:**
- Welcome message with variable checklist
- Methodology explanation
- Clinical interpretation guidance
- Statistical formulas
- Key references (Gelber 1986, Glasziou 1990, Cole 2004)

### 4. Backend Implementation
**File:** `R/qtwist.b.R` (94 KB, 2,089 lines)

**Core Calculation Functions:**
- `.calculateRMST()` - Kaplan-Meier to RMST conversion using trapezoidal rule
- `.handleToxicity()` - Three method-specific toxicity calculations
- `.calculateStatePartitions()` - Partition OS into TOX/TWiST/REL
- `.calculateQTWISTScores()` - Apply utility weights to calculate Q-TWiST
- `.calculateTreatmentDifference()` - Compare treatments with statistical tests
- `.bootstrapQTWIST()` - Bootstrap resampling for robust CIs (1000+ samples)
- `.performSensitivityAnalysis()` - Grid search across utility combinations
- `.performThresholdAnalysis()` - Find break-even utility values

**Educational Functions:**
- `.populateWelcomeMessage()` - **CRITICAL: Warns about precalculated time requirements**
- `.populateMethodologyExplanation()` - Detailed Q-TWiST methodology
- `.populateClinicalGuidance()` - Clinical interpretation help
- `.populateFormulas()` - Mathematical formulas
- `.populateReferences()` - Key literature

**Table Population Functions (8 functions):**
All results tables populated with calculated values

**Plotting Functions (5 functions):**
- `.plotPartitionedSurvival()` - Stacked area charts
- `.plotQTWISTComparison()` - Stacked bar comparisons
- `.plotSensitivity()` - Heatmap with contours
- `.plotKMCurves()` - Reference survival curves
- `.plotForest()` - Stratified analysis (placeholder)

**Color Schemes Supported:**
- Clinical (red/green/blue)
- Colorblind-friendly
- Grayscale
- Viridis

### 5. User Interface
**File:** `jamovi/qtwist.u.yaml` (5.9 KB, auto-formatted)

Intuitive interface with:
- Variable selection boxes with drag-and-drop
- Collapsible sections for organization
- Conditional show/hide based on selections
- Event level selectors for factor variables
- Clear labeling and tooltips

### 6. Auto-Generated Header
**File:** `R/qtwist.h.R` (58 KB)

Automatically generated by jmvtools::prepare() - defines base class and options structure.

### 7. Module Registry
**File:** `jamovi/0000.yaml` (modified)

Q-TWiST added to:
- **Menu:** OncoPathT → Quality-Adjusted Survival
- **Title:** Q-TWiST Analysis
- **Subtitle:** Quality-adjusted Time Without Symptoms or Toxicity

---

## Key Features Implemented

### ✅ Time Variable Warning System
As requested, the welcome message prominently warns users that Q-TWiST requires **precalculated time durations** (in months), not raw dates.

**Warning includes:**
- ⚠️ Prominent yellow warning box
- Step-by-step instructions for using **Time Interval Calculator**
- Example conversion: dates → durations
- Variable selection checklist with ✅/❌ status indicators

### ✅ Multiple Event Level Selection
Supports factor variables for event indicators with user-selectable levels:
- OS event level selection
- PFS event level selection
- Toxicity indicator level selection

### ✅ Three Toxicity Assessment Methods

**Method 1: Fixed Window**
- Same assessment period for all patients (e.g., first 3 months)
- E[TOX] = window duration × probability of grade 3-4 toxicity
- Simple and clinically interpretable

**Method 2: Individual Durations**
- Patient-specific toxicity durations
- E[TOX] = mean of individual durations
- More precise, requires detailed tracking

**Method 3: Time Periods**
- Start and end times for each patient
- E[TOX] = mean of (end - start)
- Allows varying toxicity timing

### ✅ Bootstrap Confidence Intervals
- Robust inference via resampling (100-10,000 samples)
- Percentile method for CI construction
- Reproducible with seed setting

### ✅ Sensitivity Analysis
- Grid search across utility weight combinations
- Identifies when treatment preference changes
- Essential for robust conclusions given subjective utilities

### ✅ Clinical Guidance
Comprehensive interpretation help:
- **Magnitude interpretation:** Large (≥2 mo), Moderate (1-2 mo), Small (0.5-1 mo)
- **State contribution analysis:** Which states drive differences?
- **Robustness assessment:** Does conclusion hold across utilities?
- **Application examples:** Adjuvant chemo, maintenance therapy, targeted therapy

### ✅ Publication-Ready Outputs
- Tables formatted for manuscripts
- Plots suitable for publication
- Proper citations to key references
- Statistical formulas provided

---

## Compilation Status

### ✅ jmvtools::prepare()
**Status:** SUCCESS
**Output:**
- Generated `R/qtwist.h.R` (58 KB)
- Compiled YAML files to JavaScript
- No errors

### ✅ devtools::document()
**Status:** SUCCESS (with warnings only)
**Warnings:** Namespace conflicts (normal for large packages)
**Errors:** None

### ⚠️ Minor Issue Fixed
**Problem:** Line break in `functionalsampling.b.R` caused syntax error
**Solution:** Fixed `functionalsamplingBase` class inheritance
**Status:** Resolved

---

## Testing Instructions

### Step 1: Load the Module

```r
# In R console
library(devtools)
devtools::install()  # Install locally

library(ClinicoPath)
```

### Step 2: Open in jamovi

1. Launch jamovi
2. Navigate to: **Analyses → OncoPathT → Quality-Adjusted Survival → Q-TWiST Analysis**

### Step 3: Load Test Data

```r
# Load one of the test datasets
data(qtwist_breast_cancer)
View(qtwist_breast_cancer)

# Or in jamovi: File → Open → qtwist_breast_cancer.omv (if exported)
```

### Step 4: Configure Analysis

**Essential Variables:**
- Overall Survival Time: `overall_survival_months`
- OS Event: `death_status` (select level: "Dead")
- PFS Time: `progression_free_months`
- PFS Event: `progression_status` (select level: "Progressed/Died")
- Treatment: `treatment` (will use both levels)

**Toxicity:**
- Method: Fixed Window
- Window: 3 months
- Probability: 0.5

**Utility Weights:**
- μ_TOX: 0.5
- μ_TWiST: 1.0
- μ_REL: 0.5

**Time Horizon:**
- τ: 24 months

### Step 5: Enable Outputs

Check these boxes:
- ☑ Descriptive Statistics
- ☑ State Partition Table
- ☑ Q-TWiST Scores
- ☑ Treatment Difference
- ☑ Sensitivity Analysis
- ☑ Partitioned Survival Plot
- ☑ Q-TWiST Comparison Plot
- ☑ Sensitivity Plot

### Step 6: Run Analysis

Click the analysis button or enable auto-run mode.

---

## Expected Output Example

### State Partition Table
| Treatment | N | E[TOX] | E[TWiST] | E[REL] | Total |
|-----------|---|--------|----------|--------|-------|
| Standard | 200 | 1.5 mo | 12.3 mo | 4.2 mo | 18.0 mo |
| Targeted | 200 | 1.2 mo | 14.1 mo | 3.8 mo | 19.1 mo |

### Q-TWiST Scores
| Treatment | Q-TWiST | 95% CI |
|-----------|---------|---------|
| Standard | 15.6 mo | [14.2, 17.0] |
| Targeted | 17.0 mo | [15.8, 18.2] |

### Treatment Difference
| Comparison | Δ Q-TWiST | 95% CI | p-value | Favors | Clinical Significance |
|------------|-----------|--------|---------|--------|---------------------|
| Targeted vs Standard | +1.4 mo | [0.3, 2.5] | 0.012 | Targeted better | Moderate difference |

---

## Clinical Interpretation Guidance

The module provides automatic interpretation:

**Large Difference (≥2 months):**
- Strongly favors one treatment
- Robust to utility assumptions
- Clear clinical recommendation

**Moderate Difference (1-2 months):**
- Clinically relevant
- May depend on patient preferences
- Consider toxicity tolerance

**Small Difference (0.5-1 month):**
- May be meaningful in some settings
- Consider treatment burden and costs
- Patient-specific factors important

**Minimal Difference (<0.5 months):**
- Unlikely clinically important
- Treatments may be considered equivalent

---

## Sensitivity Analysis Interpretation

The sensitivity heatmap shows:
- **Green areas:** Treatment 2 better
- **Red areas:** Treatment 1 better
- **Yellow areas:** Similar outcomes
- **Contour lines:** Isoquants of equal difference

**Robust conclusion:** Treatment preference consistent across all utility combinations
**Utility-dependent:** Treatment preference changes at threshold utilities

---

## Advanced Features

### Bootstrap Inference
- Default: 1000 samples (sufficient for CIs)
- Publication: 2000+ samples recommended
- Reproducible: Set seed for consistent results

### Threshold Analysis
Identifies "break-even" utility values:
- At what μ_TOX does preference change?
- At what μ_REL does preference change?
- Useful for shared decision-making

### Stratification (Future)
- Planned: Stratified analysis by risk groups
- Current: Backend placeholder implemented
- UI: Framework ready for multi-level stratification

---

## Package Dependencies

Q-TWiST uses the following R packages (already in ClinicoPath):
- **survival** - Kaplan-Meier estimation, Cox models
- **ggplot2** - Visualization framework
- **dplyr** - Data manipulation
- **tidyr** - Data reshaping
- **R6** - Object-oriented programming
- **jmvcore** - jamovi core functions

---

## References Included

The module cites 10 key references:

**Original Methodology:**
1. Gelber RD, Goldhirsch A (1986) - Seminal Q-TWiST paper
2. Glasziou PP et al. (1990) - Statistical foundations

**Extensions:**
3. Cole BF et al. (2004) - Cox regression for Q-TWiST
4. Revicki DA et al. (2006) - Practical implementation

**Applications:**
5. Goldhirsch A et al. (1989) - Breast cancer adjuvant
6. Gelber RD et al. (1996) - Meta-analysis application

**RMST Methods:**
7. Royston P, Parmar MKB (2013) - RMST methodology
8. Uno H et al. (2014) - Clinical applications

**Regulatory:**
9. FDA (2018) - Cancer drug endpoints
10. EMA (2017) - Anticancer evaluation guidelines

---

## Known Limitations

1. **Requires exactly 2 treatment groups** - Multi-arm trials need pairwise comparisons
2. **Assumes monotonic survival** - PFS ≤ OS (validated and corrected automatically)
3. **Subjective utilities** - Hence sensitivity analysis is essential
4. **Stratified analysis** - Backend ready, full implementation pending
5. **Time unit consistency** - All times must use same unit (months recommended)

---

## Next Steps for Development

### Immediate:
1. ✅ **Testing with real data** - Validate calculations
2. ✅ **User acceptance testing** - Interface usability
3. ✅ **Documentation review** - Ensure clarity

### Future Enhancements:
1. **Multi-arm comparisons** - Handle >2 treatment groups with pairwise tests
2. **Utility elicitation** - Interactive tool for patient preferences
3. **Cost-effectiveness** - Integrate QALY calculations
4. **Survival curves** - Show individual KM curves for TOX transitions
5. **Export to R** - Generate reproducible R code
6. **Power analysis** - Sample size for Q-TWiST trials

---

## Support and Troubleshooting

### Common Issues:

**"PFS > OS" warning:**
- **Cause:** Progression-free survival time exceeds overall survival
- **Solution:** Automatically corrected (PFS set to OS)
- **Check:** Ensure data entry is correct

**"Negative TWiST" warning:**
- **Cause:** Toxicity duration exceeds PFS
- **Solution:** E[TWiST] set to 0, E[TOX] adjusted
- **Check:** Verify toxicity assessment method

**"Treatment must have 2 groups" error:**
- **Cause:** Treatment variable has ≠2 levels
- **Solution:** Filter data or recode treatment variable

**"Missing event level" error:**
- **Cause:** Factor event variable without level selected
- **Solution:** Select appropriate event level from dropdown

### Getting Help:

1. **In-module help:** Enable "Show Methodology Explanations"
2. **Documentation:** See references in output
3. **GitHub issues:** Report bugs or request features

---

## Conclusion

The Q-TWiST module is **fully implemented, compiled, and ready for testing**. It provides comprehensive quality-adjusted survival analysis with:

✅ Robust statistical methods
✅ Flexible toxicity assessment
✅ Comprehensive sensitivity analysis
✅ Publication-ready outputs
✅ Clinical interpretation guidance
✅ Educational content

**Location in jamovi:** Analyses → OncoPathT → Quality-Adjusted Survival → Q-TWiST Analysis

**File Size Summary:**
- Backend: 94 KB (2,089 lines of R code)
- Options: 18 KB (40+ parameters)
- Results: 14 KB (10 tables, 5 plots)
- UI: 5.9 KB (auto-formatted)
- Header: 58 KB (auto-generated)

The implementation follows jamovi best practices and ClinicoPath coding standards. All compilation steps completed successfully with no errors.

---

**Implementation Date:** November 3, 2025
**Implementation Status:** ✅ COMPLETE AND READY FOR TESTING
