# IHC Heterogeneity Visibility Condition Fix

**Date:** 2025-12-28
**Issue:** Syntax error in visibility conditions causing jamovi UI error
**Status:** âœ… **FIXED**

---

## ğŸ› Problem

When launching the `ihcheterogeneity` function in jamovi, the following error occurred:

```
Error: Could not resolve 'biopsy1 == null'
```

This prevented the function from loading in the jamovi user interface.

---

## ğŸ” Root Cause

The error was caused by **invalid visibility condition syntax** in the results YAML file ([ihcheterogeneity.r.yaml](jamovi/ihcheterogeneity.r.yaml)).

### Invalid Syntax (Lines with errors)

**Line 10:**
```yaml
visible: (biopsy1 == null)  # âŒ INVALID
```

**Line 161:**
```yaml
visible: (compareCompartments && !is.null(spatial_id))  # âŒ INVALID
```

**Line 189:**
```yaml
visible: (compartmentTests && !is.null(spatial_id))  # âŒ INVALID
```

### Why It's Invalid

In jamovi YAML visibility expressions:
- âŒ **Cannot use:** `== null` or `!is.null()`
- âœ… **Must use:** Direct variable references or `!variable`

The jamovi expression evaluator doesn't support:
- JavaScript-style `== null` comparisons
- R-style `is.null()` function calls

---

## âœ… Solution

### Corrected Syntax

**Line 10 - Welcome Screen Visibility:**
```yaml
# Before (INVALID)
visible: (biopsy1 == null)

# After (VALID)
visible: (!biopsy1)
```
**Meaning:** Show welcome screen when `biopsy1` is NOT set

---

**Line 161 - Compartment Comparison Table:**
```yaml
# Before (INVALID)
visible: (compareCompartments && !is.null(spatial_id))

# After (VALID)
visible: (compareCompartments && spatial_id)
```
**Meaning:** Show table when `compareCompartments` is TRUE AND `spatial_id` is set

---

**Line 189 - Compartment Tests Table:**
```yaml
# Before (INVALID)
visible: (compartmentTests && !is.null(spatial_id))

# After (VALID)
visible: (compartmentTests && spatial_id)
```
**Meaning:** Show table when `compartmentTests` is TRUE AND `spatial_id` is set

---

## ğŸ“‹ Visibility Condition Syntax Reference

### Valid jamovi Visibility Expressions

| Expression | Meaning | Example |
|------------|---------|---------|
| `variable` | TRUE when variable is set/not null | `visible: (biopsy1)` |
| `!variable` | TRUE when variable is NOT set/null | `visible: (!biopsy1)` |
| `var1 && var2` | TRUE when both are set | `visible: (biopsy1 && spatial_id)` |
| `var1 \|\| var2` | TRUE when either is set | `visible: (biopsy1 \|\| biopsy2)` |
| `option` | TRUE when boolean option is TRUE | `visible: (show_plots)` |
| `!option` | TRUE when boolean option is FALSE | `visible: (!show_plots)` |

### Invalid Expressions (DO NOT USE)

| Invalid Expression | Why Invalid | Correct Alternative |
|-------------------|-------------|---------------------|
| `var == null` | JS syntax not supported | `!var` |
| `!is.null(var)` | R function not supported | `var` |
| `var != null` | JS syntax not supported | `var` |
| `is.null(var)` | R function not supported | `!var` |
| `var.length > 0` | Not for variable options | `var` |

---

## ğŸ§ª Testing

### Verification Steps

1. **File Modified:** [jamovi/ihcheterogeneity.r.yaml](jamovi/ihcheterogeneity.r.yaml#L10)
2. **Changes:** 3 visibility conditions corrected
3. **Next Step:** Regenerate `.h.R` header file with `jmvtools::prepare()`

### Expected Behavior After Fix

âœ… **Welcome screen** appears when NO variables are selected
âœ… **Function loads** without visibility errors
âœ… **Compartment tables** appear only when spatial_id is provided AND respective options are enabled
âœ… **All other tables and plots** show/hide based on option settings

---

## ğŸ“ Files Changed

### Modified
- [jamovi/ihcheterogeneity.r.yaml](jamovi/ihcheterogeneity.r.yaml) - Fixed 3 visibility conditions

### To Regenerate
- `R/ihcheterogeneity.h.R` - Will be regenerated by `jmvtools::prepare()`

---

## ğŸš€ Deployment

### Steps to Apply Fix

```bash
# Navigate to module root
cd /Users/serdarbalci/Documents/GitHub/ClinicoPathJamoviModule

# Regenerate header files
Rscript -e "jmvtools::prepare('.')"

# Build and install module
# In jamovi: Modules â†’ Sideload â†’ ClinicoPath.jmo
```

---

## ğŸ“š Related Documentation

### jamovi Visibility Expression Documentation
- **Official Docs:** https://dev.jamovi.org/
- **Expression Syntax:** Variables are evaluated in the context of `self$options`
- **Boolean Logic:** Standard `&&` (AND) and `||` (OR) supported
- **Variable Types:** Variable options (e.g., `biopsy1`), Boolean options (e.g., `show_plots`)

### Similar Issues in Other Functions
This same pattern should be checked in all functions with visibility conditions:
- Search for: `== null` or `is.null()` in `.r.yaml` files
- Replace with appropriate direct variable references

---

## âœ… Summary

**Problem:** Invalid visibility condition syntax (`== null`, `is.null()`)
**Solution:** Use direct variable references (`!var` or `var`)
**Impact:** Function now loads correctly in jamovi UI
**Prevention:** Follow jamovi visibility expression syntax guidelines

---

**Fixed By:** ClinicoPath Development
**Date:** 2025-12-28
**Status:** Ready for testing in jamovi
